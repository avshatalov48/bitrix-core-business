this.BX=this.BX||{};(function(e,t,i,a){"use strict";function l(e,t){r(e,t);t.add(e)}function s(e,t,i){r(e,t);t.set(e,i)}function r(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function n(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var u=5e3;var c=30;var o=new WeakMap;var v=new WeakMap;var b=new WeakMap;var d=new WeakMap;var h=new WeakMap;var f=new WeakMap;var p=new WeakMap;var P=new WeakSet;var F=new WeakSet;var y=new WeakSet;var H=function(){function e(t){babelHelpers.classCallCheck(this,e);l(this,y);l(this,F);l(this,P);s(this,o,{writable:true,value:new Map});s(this,v,{writable:true,value:false});s(this,b,{writable:true,value:false});s(this,d,{writable:true,value:null});s(this,h,{writable:true,value:void 0});s(this,f,{writable:true,value:u});s(this,p,{writable:true,value:c});if(a.Type.isPlainObject(t.callbacks)){babelHelpers.classPrivateFieldSet(this,h,t.callbacks)}if(a.Type.isNumber(t.loadItemsDelay)){babelHelpers.classPrivateFieldSet(this,f,t.loadItemsDelay)}if(a.Type.isNumber(t.maxPendingItems)){babelHelpers.classPrivateFieldSet(this,p,t.maxPendingItems)}}babelHelpers.createClass(e,[{key:"loadItem",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;var a=arguments.length>1&&arguments[1]!==undefined?arguments[1]:false;if(babelHelpers.classPrivateFieldGet(this,d)&&!a){return}babelHelpers.classPrivateFieldSet(this,d,setTimeout((function(){return t.loadItemHandler(i)}),a?0:babelHelpers.classPrivateFieldGet(this,f)))}},{key:"loadItemHandler",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(n(this,P,m).call(this,i)||n(this,F,k).call(this)){babelHelpers.classPrivateFieldSet(this,d,null);return}var l=this.getAllAsArray();babelHelpers.classPrivateFieldGet(this,o).clear();if(!a.Type.isArrayFilled(l)){return}var s=null;var r=babelHelpers.classPrivateFieldGet(this,h),u=r.onBeforeExecute;if(a.Type.isFunction(u)){s=new Promise((function(e){return u(l).then(e)}))}else{s=Promise.resolve()}s.then((function(){return t.process(l)}))}},{key:"process",value:function e(t){babelHelpers.classPrivateFieldSet(this,v,true);var i=babelHelpers.classPrivateFieldGet(this,h),l=i.onExecute;if(a.Type.isFunction(l)){l(t).then(this.loadNextOnSuccess.bind(this),this.doNothingOnError.bind(this))["catch"]((function(){return console.error("error")}))}else{this.loadNextOnSuccess()}}},{key:"loadNextOnSuccess",value:function e(){babelHelpers.classPrivateFieldSet(this,d,null);if(!this.isEmpty()){this.loadItem(true)}babelHelpers.classPrivateFieldSet(this,v,false)}},{key:"doNothingOnError",value:function e(){babelHelpers.classPrivateFieldSet(this,d,null)}},{key:"push",value:function e(t,i){if(this.has(t)){this["delete"](t)}babelHelpers.classPrivateFieldGet(this,o).set(t,i);return this}},{key:"getAllAsArray",value:function e(){return Array.from(babelHelpers.classPrivateFieldGet(this,o),(function(e){var t=babelHelpers.slicedToArray(e,2),i=t[0],a=t[1];return{id:i,data:a}}))}},{key:"delete",value:function e(t){babelHelpers.classPrivateFieldGet(this,o)["delete"](t)}},{key:"has",value:function e(t){return babelHelpers.classPrivateFieldGet(this,o).has(t)}},{key:"clear",value:function e(){babelHelpers.classPrivateFieldGet(this,o).clear()}},{key:"isOverflow",value:function e(){return babelHelpers.classPrivateFieldGet(this,o).size>babelHelpers.classPrivateFieldGet(this,p)}},{key:"isEmpty",value:function e(){return babelHelpers.classPrivateFieldGet(this,o).size===0}},{key:"freeze",value:function e(){babelHelpers.classPrivateFieldSet(this,b,true)}},{key:"unfreeze",value:function e(){babelHelpers.classPrivateFieldSet(this,b,false)}},{key:"getLoadItemsDelay",value:function e(){return babelHelpers.classPrivateFieldGet(this,f)}}]);return e}();function m(e){return babelHelpers.classPrivateFieldGet(this,v)&&!e}function k(){return document.hidden||this.isOverflow()||n(this,y,E).call(this)}function E(){return babelHelpers.classPrivateFieldGet(this,b)}function w(e,t){g(e,t);t.add(e)}function S(e,t,i){g(e,t);t.set(e,i)}function g(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function G(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var I=new WeakMap;var T=new WeakMap;var B=new WeakMap;var A=new WeakMap;var D=new WeakSet;var O=new WeakSet;var X=new WeakSet;var N=function(){babelHelpers.createClass(e,null,[{key:"registerRandomEventId",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=a.Text.getRandom(12);if(a.Type.isStringFilled(t)){i="".concat(t,"-").concat(i)}this.registerEventId(i);return i}},{key:"registerEventId",value:function e(t){this.eventIds.add(t)}}]);function e(t){var i=this;babelHelpers.classCallCheck(this,e);w(this,X);w(this,O);w(this,D);S(this,I,{writable:true,value:void 0});S(this,T,{writable:true,value:void 0});S(this,B,{writable:true,value:void 0});S(this,A,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,I,t);var l=t.config,s=t.callbacks;babelHelpers.classPrivateFieldSet(this,T,new H({loadItemsDelay:l===null||l===void 0?void 0:l.loadItemsDelay,maxPendingItems:l===null||l===void 0?void 0:l.maxPendingItems,callbacks:{onBeforeExecute:s.onBeforeQueueExecute,onExecute:s.onQueueExecute}}));babelHelpers.classPrivateFieldSet(this,A,0);this.initEventEmitter();var r=t.moduleId,n=t.userId;if(a.Type.isStringFilled(r)&&n>0){a.Event.ready((function(){return i.init()}))}}babelHelpers.createClass(e,[{key:"initEventEmitter",value:function e(){this.eventEmitter=new t.EventEmitter;this.eventEmitter.setEventNamespace("BX.Pull.QueueManager")}},{key:"init",value:function e(){if(!BX.PULL){console.error("BX.PULL is not initialized");return}this.subscribe();this.bindEvents()}},{key:"subscribe",value:function e(){var t=this;var i=babelHelpers.classPrivateFieldGet(this,I),l=i.moduleId,s=i.pullTag;BX.PULL.subscribe({moduleId:l,callback:function e(i){return t.onPullSubscribeCallback(i)}});if(a.Type.isStringFilled(s)){BX.PULL.extendWatch(s)}}},{key:"bindEvents",value:function e(){var i=this;if(a.Type.isPlainObject(babelHelpers.classPrivateFieldGet(this,I).events)){var l=function e(){var t=babelHelpers.slicedToArray(r[s],2),l=t[0],n=t[1];if(a.Type.isFunction(n)){i.eventEmitter.subscribe(l,(function(e){return n(e)}))}};for(var s=0,r=Object.entries(babelHelpers.classPrivateFieldGet(this,I).events);s<r.length;s++){l()}}a.Event.bind(document,"visibilitychange",(function(){return i.onDocumentVisibilityChange()}));t.EventEmitter.subscribe("SidePanel.Slider:onOpen",(function(){var e,t;babelHelpers.classPrivateFieldSet(i,A,(e=babelHelpers.classPrivateFieldGet(i,A),t=e++,e)),t;babelHelpers.classPrivateFieldGet(i,T).freeze()}));t.EventEmitter.subscribe("SidePanel.Slider:onClose",(function(){var e,t;babelHelpers.classPrivateFieldSet(i,A,(e=babelHelpers.classPrivateFieldGet(i,A),t=e--,e)),t;if(babelHelpers.classPrivateFieldGet(i,A)<=0){babelHelpers.classPrivateFieldSet(i,A,0);babelHelpers.classPrivateFieldGet(i,T).unfreeze();i.onTabActivated()}}))}},{key:"onDocumentVisibilityChange",value:function e(){if(!document.hidden){this.onTabActivated()}}},{key:"onPullSubscribeCallback",value:function i(l){var s=this;var r=babelHelpers.classPrivateFieldGet(this,I),n=r.pullTag;if(a.Type.isStringFilled(n)&&l.command!==n){return}var u=new t.BaseEvent({data:{pullData:l,queueItems:babelHelpers.classPrivateFieldGet(this,T).getAllAsArray(),options:babelHelpers.classPrivateFieldGet(this,I),promises:[]}});this.eventEmitter.emit("onBeforePull",u);if(u.isDefaultPrevented()){return}var c=l.params;if(!a.Type.isStringFilled(c.eventName)){return}if(e.eventIds.has(c.eventId)){return}if(babelHelpers.classPrivateFieldGet(this,T).isOverflow()){return}this.eventEmitter.emit("onPull",u);if(u.isDefaultPrevented()){return}void Promise.all(u.data.promises).then((function(e){if(!a.Type.isArrayFilled(e)){return}e.forEach((function(e){var t=e.data;babelHelpers.classPrivateFieldGet(s,T).push("".concat(t.id,"_").concat(c.eventName),t)}));babelHelpers.classPrivateFieldGet(s,T).loadItem(false,c.ignoreDelay||false)}))}},{key:"showOutdatedDataDialog",value:function e(){if(G(this,D,L).call(this)){return}var i=G(this,O,M).call(this);if(i){t.EventEmitter.subscribe(i,"SidePanel.Slider:onClose",G(this,X,W).bind(this))}else{G(this,X,W).call(this)}}},{key:"onTabActivated",value:function e(){if(babelHelpers.classPrivateFieldGet(this,T).isOverflow()){this.showOutdatedDataDialog();return}if(!babelHelpers.classPrivateFieldGet(this,T).isEmpty()){babelHelpers.classPrivateFieldGet(this,T).loadItem()}}},{key:"hasInQueue",value:function e(t){return babelHelpers.classPrivateFieldGet(this,T).has(t)}},{key:"deleteFromQueue",value:function e(t){babelHelpers.classPrivateFieldGet(this,T)["delete"](t)}},{key:"getLoadItemsDelay",value:function e(){return babelHelpers.classPrivateFieldGet(this,T).getLoadItemsDelay()}}]);return e}();function L(){return top.BX&&top.BX.SidePanel&&top.BX.SidePanel.Instance.getOpenSlidersCount()>1}function M(){if(top.BX&&top.BX.SidePanel){var e=top.BX.SidePanel.Instance.getTopSlider();if(e&&e.isOpen()){return e}}return null}function W(){var e,t=this;var l=(e=babelHelpers.classPrivateFieldGet(this,I).config)===null||e===void 0?void 0:e.showOutdatedDataDialog;var s=babelHelpers.classPrivateFieldGet(this,I).callbacks.onReload;if(a.Type.isBoolean(l)&&l===false||!a.Type.isFunction(s)){return}if(babelHelpers.classPrivateFieldGet(this,B)){if(babelHelpers.classPrivateFieldGet(this,B).getState()===BX.UI.Notification.State.OPENING||babelHelpers.classPrivateFieldGet(this,B).getState()===BX.UI.Notification.State.OPEN){return}babelHelpers.classPrivateFieldGet(this,B).show();return}babelHelpers.classPrivateFieldSet(this,B,i.UI.Notification.Center.notify({content:a.Loc.getMessage("PULL_QUEUEMANAGER_NOTIFY_OUTDATED_DATA"),closeButton:false,autoHide:false,actions:[{title:a.Loc.getMessage("PULL_QUEUEMANAGER_RELOAD"),events:{click:function e(i,a){a.close();s();babelHelpers.classPrivateFieldGet(t,T).clear()}}}]}))}babelHelpers.defineProperty(N,"eventIds",new Set);e.QueueManager=N})(this.BX.Pull=this.BX.Pull||{},BX.Event,BX,BX);
//# sourceMappingURL=queuemanager.map.js