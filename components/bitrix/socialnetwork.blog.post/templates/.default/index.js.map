{"version":3,"file":"index.js","sources":["src/blog-copilot-readonly.js"],"sourcesContent":["import { Dom, Event, Loc, Runtime, Tag, Uri } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\ntype Params = {\n\tcontainer: HTMLElement,\n\tblogText: string,\n\tenabledBySettings: boolean,\n\tcopilotParams: {\n\t\tmoduleId: string,\n\t\tcontextId: string,\n\t\tcategory: string,\n\t},\n\tblogId: string,\n\tpathToPostCreate: string,\n};\n\nexport class BlogCopilotReadonly\n{\n\t#params: Params;\n\n\t#layout: {\n\t\tbutton: HTMLElement,\n\t};\n\n\t#copilotLoaded: boolean;\n\t#copilotContextMenu: any;\n\t#copilotShown: boolean;\n\t#adjustAnimation: any;\n\n\tconstructor(params: Params)\n\t{\n\t\tthis.#params = params;\n\t\tthis.#layout = {};\n\n\t\tif (this.#params.enabledBySettings)\n\t\t{\n\t\t\tvoid this.#createCopilot();\n\t\t}\n\n\t\tDom.append(this.#render(), this.#params.container);\n\t}\n\n\t#render(): HTMLElement\n\t{\n\t\tthis.#layout.button = Tag.render`\n\t\t\t<span class=\"feed-inform-item feed-inform-comments feed-copilot-readonly\">\n\t\t\t\t<a>${Loc.getMessage('BLOG_POST_BUTTON_COPILOT')}</a>\n\t\t\t</span>\n\t\t`;\n\n\t\tEvent.bind(this.#layout.button, 'mousedown', this.#onButtonMouseDown.bind(this));\n\t\tEvent.bind(this.#layout.button, 'click', this.#onButtonClick.bind(this));\n\n\t\treturn this.#layout.button;\n\t}\n\n\tasync #createCopilot(): Promise\n\t{\n\t\tconst { CopilotContextMenu } = await Runtime.loadExtension('ai.copilot');\n\n\t\tconst options = {\n\t\t\tmoduleId: this.#params.copilotParams.moduleId,\n\t\t\tcontextId: this.#params.copilotParams.contextId,\n\t\t\tcategory: this.#params.copilotParams.category,\n\t\t\tbindElement: this.#getBindElement(),\n\t\t\tangle: true,\n\t\t\textraResultMenuItems: [\n\t\t\t\t{\n\t\t\t\t\tcode: 'insert-into-comment',\n\t\t\t\t\ttext: Loc.getMessage('BLOG_POST_BUTTON_COPILOT_COPY_INTO_COMMENT'),\n\t\t\t\t\tcommand: () => {\n\t\t\t\t\t\tconst resultText = this.#copilotContextMenu.getResultText();\n\t\t\t\t\t\tthis.#copilotContextMenu.hide();\n\n\t\t\t\t\t\tthis.#copyIntoComment(resultText);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\t{\n\t\t\t\t\tcode: 'insert-into-new-post',\n\t\t\t\t\ttext: Loc.getMessage('BLOG_POST_BUTTON_COPILOT_COPY_INTO_NEW_POST'),\n\t\t\t\t\tcommand: () => {\n\t\t\t\t\t\tconst resultText = this.#copilotContextMenu.getResultText();\n\t\t\t\t\t\tthis.#copilotContextMenu.hide();\n\n\t\t\t\t\t\tthis.#copyIntoNewPost(resultText);\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t],\n\t\t};\n\n\t\tthis.#copilotContextMenu = new CopilotContextMenu(options);\n\n\t\tthis.#bindEvents();\n\t\ttry\n\t\t{\n\t\t\tawait this.#copilotContextMenu.init();\n\t\t\tthis.#copilotLoaded = true;\n\t\t}\n\t\tcatch (e)\n\t\t{\n\t\t\tconsole.error('Failed to init copilot', e);\n\t\t}\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tEventEmitter.subscribe('onPullEvent-unicomments', this.#startAdjustAnimation.bind(this));\n\t}\n\n\t#startAdjustAnimation(): void\n\t{\n\t\tthis.#adjustAnimation?.stop();\n\t\t// eslint-disable-next-line new-cap\n\t\tthis.#adjustAnimation = new BX.easing({\n\t\t\tduration: 1000,\n\t\t\tstart: {},\n\t\t\tfinish: {},\n\t\t\ttransition: BX.easing.makeEaseOut(BX.easing.transitions.linear),\n\t\t\tstep: () => {\n\t\t\t\tif (this.#copilotContextMenu.isShown())\n\t\t\t\t{\n\t\t\t\t\tthis.#copilotContextMenu.adjustPosition();\n\t\t\t\t}\n\t\t\t},\n\t\t\tcomplete: () => {\n\t\t\t\tthis.#adjustAnimation = null;\n\t\t\t},\n\t\t});\n\t\tthis.#adjustAnimation.animate();\n\t}\n\n\t#onButtonMouseDown(): void\n\t{\n\t\tif (!this.#params.enabledBySettings)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#copilotShown = this.#copilotContextMenu?.isShown();\n\t}\n\n\t#onButtonClick(): void\n\t{\n\t\tif (!this.#params.enabledBySettings)\n\t\t{\n\t\t\tBX.UI.InfoHelper.show('limit_copilot_off');\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#copilotShown)\n\t\t{\n\t\t\tthis.#hide();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#show();\n\t\t}\n\t}\n\n\t#show(): void\n\t{\n\t\tif (this.#copilotLoaded)\n\t\t{\n\t\t\tthis.#copilotContextMenu.setContext(this.#params.blogText);\n\t\t\tthis.#copilotContextMenu.show({ bindElement: this.#getBindElement() });\n\t\t}\n\t}\n\n\t#getBindElement(): HTMLElement\n\t{\n\t\treturn this.#layout.button;\n\t}\n\n\t#hide(): void\n\t{\n\t\tthis.#copilotContextMenu.hide();\n\t}\n\n\t#copyIntoComment(text: string): void\n\t{\n\t\tconst list = FCList.getInstance({ ENTITY_XML_ID: this.#params.blogId });\n\t\tconst form = list.form;\n\t\tconst lhe = LHEPostForm.getHandlerByFormId(list.form.formId);\n\n\t\tif (lhe.oEditor?.IsShown())\n\t\t{\n\t\t\tlhe.oEditor.action.Exec('insertHTML', text);\n\t\t}\n\n\t\tconst iframeInitHandler = () => {\n\t\t\tlhe.oEditor.action.Exec('insertHTML', text);\n\t\t\tBX.removeCustomEvent(lhe.oEditor, 'OnAfterIframeInit', iframeInitHandler);\n\t\t};\n\t\tlhe.exec(() => {\n\t\t\tBX.addCustomEvent(lhe.oEditor, 'OnAfterIframeInit', iframeInitHandler);\n\t\t});\n\n\t\tform.show(list);\n\t}\n\n\t#copyIntoNewPost(text: string): void\n\t{\n\t\tconst pathToPostCreate = Uri.addParam(this.#params.pathToPostCreate, {\n\t\t\tgetTextFromHash: 'Y',\n\t\t});\n\n\t\tlocation.href = `${pathToPostCreate}#${encodeURIComponent(text)}`;\n\t}\n}\n"],"names":["BlogCopilotReadonly","constructor","params","enabledBySettings","Dom","append","container","button","Tag","render","Loc","getMessage","Event","bind","CopilotContextMenu","Runtime","loadExtension","options","moduleId","copilotParams","contextId","category","bindElement","angle","extraResultMenuItems","code","text","command","resultText","getResultText","hide","init","e","console","error","EventEmitter","subscribe","stop","BX","easing","duration","start","finish","transition","makeEaseOut","transitions","linear","step","isShown","adjustPosition","complete","animate","UI","InfoHelper","show","setContext","blogText","list","FCList","getInstance","ENTITY_XML_ID","blogId","form","lhe","LHEPostForm","getHandlerByFormId","formId","oEditor","IsShown","action","Exec","iframeInitHandler","removeCustomEvent","exec","addCustomEvent","pathToPostCreate","Uri","addParam","getTextFromHash","location","href","encodeURIComponent"],"mappings":"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"}