(function(t){"use strict";BX.namespace("BX.Vote");var e=function(){function t(e,i){babelHelpers.classCallCheck(this,t);this.id=null;this.params={isNew:true,isSaved:false};if(e>0){this.params.isNew=false;this.id=e}else if(e!==0){this.id=e}this.data={MESSAGE:"",MESSAGE_TYPE:"text",FIELD_TYPE:0};this.adjust(i);this.__apply=BX.delegate(this.apply,this);this.__delete=BX.delegate(this.delete,this);BX.addCustomEvent(this,"onApply",this.__apply);BX.addCustomEvent(this,"onDelete",this.__delete)}babelHelpers.createClass(t,[{key:"adjust",value:function t(e){var i,a=BX.type.isPlainObject(e)?e:{};for(i in this.data){if(this.data.hasOwnProperty(i)){if(a[i])this.data[i]=a[i]}}}},{key:"getId",value:function t(){return this.id}},{key:"getData",value:function t(){return this.data}},{key:"apply",value:function t(e){this.adjust(e);return this}},{key:"delete",value:function t(){return this}}]);return t}();e.repo={};e.getItem=function(t,i){var a=new e(t,BX.type.isPlainObject(i)?i:{});if(t!==0&&e.repo[t]){e.repo[t]=null;delete e.repo[t];e.repo[t]=a}return a};var i=function(){function t(e){babelHelpers.classCallCheck(this,t);this.values=[];this.valuesById={};this.valuesByCode={};e.forEach(BX.proxy(function(t){this.values.push(t);this.valuesById[t["ID"].toLowerCase()]=t;this.valuesByCode[t["CODE"].toLowerCase()]=t},this))}babelHelpers.createClass(t,[{key:"getByCode",value:function t(e){return this.valuesByCode[e]}},{key:"getById",value:function t(e){return this.valuesById[e]}},{key:"getIdByCode",value:function t(e){if(this.valuesByCode.hasOwnProperty(e)){return this.valuesByCode[e]["ID"]}return null}}]);return t}();var a={setTypes:function t(e){a.obj=new i(e)},getValues:function t(){return a.obj.values},isTextType:function t(e){var i=a.obj.getById(e);if(BX.type.isPlainObject(i)){return i["CODE"].toUpperCase().substr(0,4)==="TEXT"}return false}};var s={setTypes:function t(e){s.obj=new i(e)},isCompatibilityMode:function t(){var e=BX("FIELD_TYPE").value;return String(e).toLowerCase()===s.obj.getIdByCode("compatibility")},getActive:function t(){return String(BX("FIELD_TYPE").value).toUpperCase()}};var n=function(){function t(){babelHelpers.classCallCheck(this,t);this.id="Editor";this.popup=null;this.reset();this.debug=true;return this}babelHelpers.createClass(t,[{key:"onApply",value:function t(e){BX.onCustomEvent(this.answer,"onApply",[e]);BX.onCustomEvent(this,"onApply",[this.answer.getId(),this.answer.getData(),this.gridData]);this.reset()}},{key:"onCancel",value:function t(){BX.onCustomEvent(this.answer,"onCancel",[]);this.reset()}},{key:"onDelete",value:function t(){BX.onCustomEvent(this.answer,"onDelete",[]);this.reset()}},{key:"setGridData",value:function t(e){this.gridData={gridInstanceId:e["gridInstanceId"],gridId:e["gridId"],maxSort:e["maxSort"]};return this}},{key:"getGridId",value:function t(){return this.gridData.gridId}},{key:"setAnswer",value:function t(i,a){var s=e.getItem(i,a);if(this.answer!==null&&this.answer!==s)this.onCancel();this.answer=s;return this}},{key:"reset",value:function t(){delete this.answer;this.answer=null;delete this.gridData;this.gridData={id:null,gridId:null,maxSort:null}}},{key:"show",value:function t(){this.showEditor(this.answer.getData())}},{key:"showEditor",value:function t(e){if(this.popup!==null)this.popup.close();var i=false;var n=String(e["FIELD_TYPE"]);var l="";a.getValues().forEach(function(t){l+=['<option value="'+t["ID"]+'"'+(n===t["ID"]?" selected":"")+">",t["TITLE"],"</option>"].join("")});l=['<div class="ui-form-block ui-form-block-html-text">\t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"":"checked")+' class="ui-ctl-element" value="text"> \t\t\t\t\t\t<div class="ui-ctl-label-text">text</div> \t\t\t\t\t</label>\t\t\t\t\t<label className="ui-ctl ui-ctl-wa ui-ctl-xs"><div class="ui-ctl-label-text">&nbsp;/&nbsp;</div></label> \t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"checked":"")+' class="ui-ctl-element" value="html"> \t\t\t\t\t\t<div class="ui-ctl-label-text">html</div> \t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div class="ui-form-block">\t\t\t\t\t<div class="ui-ctl ui-ctl-textarea" id="answer_MESSAGE_block">\t\t\t\t\t\t<textarea name="answer[MESSAGE]" class="ui-ctl-element" id="ANSWER_MESSAGE" placeholder="'+BX.message("VOTE_ANSWER_PLACEHOLDER")+'">'+BX.util.htmlspecialchars(e["MESSAGE"])+'</textarea>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<input id="answer_FIELD_TYPE" name="answer[FIELD_TYPE]" type="hidden" value="" class="ui-ctl-element"> '+(s.isCompatibilityMode()===true?'<div class="ui-form-block">\t\t\t\t\t<label for="id1" class="ui-ctl-label-text">'+BX.message("VOTE_ANSWER_FIELD_TYPE")+'</label>\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\t\t\t\t\t\t<select name="answer[FIELD_TYPE]" class="ui-ctl-element">'+l+"</select>\t\t\t\t\t</div>\t\t\t\t</div> ":'<input  name="answer[FIELD_TYPE]" type="hidden" value="'+s.getActive()+'">')].join();var r="";a.getValues().forEach(function(t){if(t["CODE"].substring(0,4).toUpperCase()==="TEXT"){i=i||n===t["ID"];r+=['<option value="'+t["ID"]+'"'+(n===t["ID"]?" selected":"")+">",t["TITLE"],"</option>"].join("")}});r=['<div class="ui-form-block ui-form-block-html-text">\t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"":"checked")+' class="ui-ctl-element" value="text"> \t\t\t\t\t\t<div class="ui-ctl-label-text">text</div> \t\t\t\t\t</label>\t\t\t\t\t<label className="ui-ctl ui-ctl-wa ui-ctl-xs"><div class="ui-ctl-label-text">&nbsp;/&nbsp;</div></label> \t\t\t\t\t<label class="ui-ctl ui-ctl-radio ui-ctl-wa ui-ctl-xs"> \t\t\t\t\t\t<input type="radio" name="answer[MESSAGE_TYPE]" '+(e["MESSAGE_TYPE"]==="html"?"checked":"")+' class="ui-ctl-element" value="html"> \t\t\t\t\t\t<div class="ui-ctl-label-text">html</div> \t\t\t\t\t</label>\t\t\t\t</div>\t\t\t\t<div class="ui-form-block"> \t\t\t\t\t<div class="ui-ctl ui-ctl-textarea" id="answer_MESSAGE_block">\t\t\t\t\t\t<textarea name="answer[MESSAGE]" class="ui-ctl-element" id="ANSWER_MESSAGE" placeholder="'+BX.message("VOTE_ANSWER_PLACEHOLDER1")+'">'+BX.util.htmlspecialchars(e["MESSAGE"]||BX.message("VOTE_ANSWER_TEXT_OTHER"))+'</textarea>\t\t\t\t\t</div>\t\t\t\t</div>\t\t\t\t<div class="ui-form-block">\t\t\t\t\t<label for="id1" class="ui-ctl-label-text">'+BX.message("VOTE_ANSWER_FIELD_TYPE")+'</label>\t\t\t\t\t<div class="ui-ctl ui-ctl-after-icon ui-ctl-dropdown">\t\t\t\t\t\t<div class="ui-ctl-after ui-ctl-icon-angle"></div>\t\t\t\t\t\t<select name="answer[FIELD_TYPE]" class="ui-ctl-element">',r,"</select>\t\t\t\t\t</div>\t\t\t\t</div> "].join();var o=BX.create("DIV",{attrs:{id:this.id+"Proper",className:"vote-edit-popup"},html:['<div class="vote-edit-inp-wrap">\t\t\t\t\t<form onsubmit="return false;" id="',this.id,'_form">\t\t\t\t\t\t',i?r:l,"</form>\t\t\t\t</div>"].join("")});var u=BX.delegate(function(){var t=BX.ajax.prepareForm(BX(this.id+"_form"));if(BX.type.isNotEmptyString(t.data.answer.MESSAGE)){this.onApply(t.data.answer);this.popup.fired=true;this.popup.close()}else{BX.addClass(BX("answer_MESSAGE_block"),"ui-ctl-danger")}},this);this.popup=BX.PopupWindowManager.create("popup"+this.id,null,{titleBar:BX.message("VOTE_ANSWER_MESSAGE"),className:"vote-answer",autoHide:false,lightShadow:true,closeIcon:true,closeByEsc:true,zIndex:1,content:o,overlay:{},events:{onPopupShow:BX.delegate(function(){},this),onPopupClose:BX.delegate(function(){if(this.popup.fired!==true)BX.onCustomEvent(this,"onCancel",[this]);this.popup.destroy();this.popup=null},this),onAfterPopupShow:BX.defer(function(){if(BX(this.id+"_form")){BX.focus(BX(this.id+"_form").elements["ANSWER_MESSAGE"]);BX.bind(BX(this.id+"_form").elements["ANSWER_MESSAGE"],"keydown",BX.proxy(function(t){if((t.ctrlKey===true||t.altKey===true)&&t.keyCode===13){u()}},this))}},this)},buttons:[new BX.PopupWindowButton({text:BX.message("VOTE_SAVE"),className:"",events:{click:u}}),new BX.PopupWindowButton({text:BX.message("VOTE_CANCEL"),className:"",events:{click:BX.delegate(function(){this.onCancel();this.popup.fired=true;this.popup.close()},this)}})]});this.popup.show();this.popup.adjustPosition()}}]);return t}();BX.Vote.addTextAnswer=function(t){o(t,0,{FIELD_TYPE:4})};BX.Vote.addAnswer=function(t,e){o(t,0,e)};BX.Vote.editAnswer=function(t,e){var i=BX.Main.gridManager.getInstanceById(r[t]["gridId"]);var a=i!==null?i.getRows().getById(e).getEditData():{};o(t,e,a)};BX.Vote.setTypes=function(t){s.setTypes(t.questionTypes);a.setTypes(t.answerTypes)};BX.Vote.setParams=function(t,e){BX.defer(function(){u(e["formId"],e.gridId,t);BX.bind(document,"keydown",function(e){if(e.keyCode===45&&e.ctrlKey===false&&e.metaKey===false&&e.altKey===false&&(!BX(e.target)||BX(e.target).tagName==="BODY")){BX.Vote.addAnswer(t,{})}})})();r[t]={gridInstanceId:t,gridId:e.gridId,maxSort:e["maxSort"]||100}};var l=null;var r={};var o=function t(e,i,a){if(l===null){l=new n;BX.addCustomEvent(l,"onApply",function(t,e,i){var a=i["gridId"];var s=BX.Main.gridManager.getInstanceById(a);if(s instanceof BX.Main.grid){var n=BX.clone(e);if(t!==null){s.updateRow(t,n,null,function(){})}else{r[i["gridInstanceId"]]["maxSort"]+=100;n["C_SORT"]=r[i["gridInstanceId"]]["maxSort"];s.addRow(n,null,function(){})}}})}l.setGridData(r[e]).setAnswer(i,a).show()};BX.addCustomEvent(window,"Grid::beforeRequest",function(t,e){var i;for(i in r){if(r.hasOwnProperty(i)){if(r[i]["gridId"]===e.gridId){e.data.gridId=e.gridId;e.data.gridInstanceId=r[i]["gridInstanceId"]}}}});var u=function t(e,i,n){var l=BX(e,true);var r="save";var o=function t(e){BX.unbind(l,"submit",t);var a=BX.Main.gridManager.getInstanceById(i);if(!a.getRows().hasEditable()){d(l,i,n);return true}var s=function t(e){if(e===a){BX.removeCustomEvent(window,"Grid::updated",t);l.appendChild(BX.create("INPUT",{props:{type:"hidden",name:r,value:"Y"}}));d(l,i,n);l.submit()}};BX.addCustomEvent(window,"Grid::updated",s);a.editSelectedSave();return BX.PreventDefault(e)};BX.bind(l,"submit",o);if(l.elements["apply"]){BX.bind(l.elements["apply"],"mousedown",function(){r="apply"})}var u=function t(e){var n=e.target;var l=BX.Main.gridManager.getInstanceById(i).getRows();if(!s.isCompatibilityMode()&&l){var r=[];l.getRows().forEach(function(t){var e=BX.parseJSON(BX.data(t.getNode(),"item"),t);if(e&&BX.type.isPlainObject(e)&&e.hasOwnProperty("field_type")&&String(e["field_type"])!==String(n.value)&&!a.isTextType(e["field_type"])){t.select();r.push(t.getId())}});if(r.length>0){BX.Main.gridManager.getInstanceById(i).reloadTable("POST",{ID:r,action_button_grid_vote_answer:"change_answer_type",FIELD_TYPE:this.value})}}};BX.findChildren(BX(e,true),{props:{name:"FIELD_TYPE"}},true).forEach(function(t){BX.bind(t,"change",u)})};var d=function t(e,i){var a=BX.Main.gridManager.getInstanceById(i);if(a){var s=a.getRows().getRows();var n,l;s.forEach(function(t){if(t.getIndex()<1)return;l=t.getId();e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:"ANSWER["+l.toLowerCase()+"][ID]",value:l}}));n=BX.parseJSON(BX.data(t.getNode(),"item"),t);var i=function t(i,a,s){var n;for(var l in a){if(a.hasOwnProperty(l)){n="["+(s>0?l:String(l).toUpperCase())+"]";if(BX.type.isPlainObject(a[l])){t(i+n,a[l],s+1)}else{e.appendChild(BX.create("INPUT",{props:{type:"hidden",name:i+n,value:a[l]}}))}}}};if(BX.type.isPlainObject(n)){i("ANSWER["+l+"]",n,0)}})}};var c=null;BX.Vote.showColorPicker=function(t){if(c===null){c=new BX.ColorPicker({bindElement:null,popupOptions:{angle:true}})}c.open({selectedColor:BX.type.isNotEmptyString(t.value)?t.value:null,bindElement:t,onColorSelected:function e(i){t.value=i}})}})(this.window=this.window||{});
//# sourceMappingURL=script.map.js