{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Loc, Reflection } from 'main.core';\nimport { EntityCard } from 'catalog.entity-card';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { MenuManager } from 'main.popup';\nimport { MessageBox, MessageBoxButtons } from 'ui.dialogs.messagebox';\n\nclass ProductCard extends EntityCard\n{\n\t#isQuantityTraceNoticeShown = false;\n\n\tconstructor(id, settings = {})\n\t{\n\t\tsuper(id, settings);\n\n\t\tthis.initDocumentTypeSelector();\n\n\t\tif (settings.isCopilotEnabled)\n\t\t{\n\t\t\tthis.initCopilot();\n\t\t}\n\t}\n\n\tinitCopilot()\n\t{\n\t\tthis.extraMarkers = {};\n\n\t\tEventEmitter.subscribe('onHtmlEditorCopilotInit', (event) => {\n\t\t\tthis.copilot = event.data.copilot;\n\t\t});\n\n\t\tEventEmitter.subscribe('onHtmlEditorCopilotShow', (event) => {\n\t\t\tthis.collectExtraMarkers(event);\n\t\t\tthis.copilot.setExtraMarkers(this.extraMarkers);\n\t\t});\n\t}\n\n\tcollectExtraMarkers(event)\n\t{\n\t\tconst productNameEditNode = document.querySelector('#name_text');\n\n\t\tif (productNameEditNode)\n\t\t{\n\t\t\tthis.extraMarkers.product_name = productNameEditNode.value;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tconst productNameNode = document.querySelector('div[data-cid=\"NAME-CODE\"]').querySelector('p');\n\n\t\t\tif (productNameNode)\n\t\t\t{\n\t\t\t\tthis.extraMarkers.product_name = productNameNode.innerHTML;\n\t\t\t}\n\t\t}\n\t}\n\n\tgetEntityType()\n\t{\n\t\treturn 'Product';\n\t}\n\n\tonSectionLayout(event: BaseEvent)\n\t{\n\t\tconst [section, eventData] = event.getCompatData();\n\n\t\tif (eventData.id === 'catalog_parameters')\n\t\t{\n\t\t\teventData.visible = this.isSimpleProduct && this.isCardSettingEnabled('CATALOG_PARAMETERS');\n\t\t}\n\n\t\tEventEmitter.subscribe('BX.UI.EntityEditorList:onItemSelect', (event) => {\n\t\t\tconst isQuantityTraceRestricted = !(this.isWithOrdersMode && !this.isInventoryManagementUsed);\n\t\t\tif (this.#isQuantityTraceNoticeShown || !isQuantityTraceRestricted)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst field = event.getData()[1]?.field;\n\t\t\tif (!field)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (field.getId() !== 'QUANTITY_TRACE' || field._selectedValue !== 'N')\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tMessageBox.show(\n\t\t\t\t{\n\t\t\t\t\ttitle: Loc.getMessage('CPD_QUANTITY_TRACE_NOTICE_TITLE'),\n\t\t\t\t\tmessage: Loc.getMessage('CPD_QUANTITY_TRACE_NOTICE'),\n\t\t\t\t\tbuttons: MessageBoxButtons.OK,\n\t\t\t\t\tokCaption: Loc.getMessage('CPD_QUANTITY_TRACE_ACCEPT'),\n\t\t\t\t\tonOk: (messageBox) => {\n\t\t\t\t\t\tthis.#isQuantityTraceNoticeShown = false;\n\t\t\t\t\t\tmessageBox.close();\n\t\t\t\t\t},\n\t\t\t\t\tpopupOptions: {\n\t\t\t\t\t\tcloseIcon: true,\n\t\t\t\t\t\tevents: {\n\t\t\t\t\t\t\tonAfterClose: () => this.#isQuantityTraceNoticeShown = false,\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\n\t\t\tthis.#isQuantityTraceNoticeShown = true;\n\t\t});\n\n\t\tsection?.getChildren().forEach((field) => {\n\t\t\tif (this.hiddenFields.includes(field?.getId()))\n\t\t\t{\n\t\t\t\tfield.setVisible(false);\n\t\t\t}\n\t\t});\n\n\t\tEventEmitter.subscribe('onEntityUpdate', (event) => {\n\t\t\tconst editor = event.getData()[0]?.sender;\n\t\t\tif (!editor)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst quantityTraceValue = editor._model.getField('QUANTITY_TRACE', 'D');\n\t\t\tconst isQuantityTraceRestricted = !(this.isWithOrdersMode && !this.isInventoryManagementUsed);\n\t\t\tif (quantityTraceValue !== 'N' && isQuantityTraceRestricted)\n\t\t\t{\n\t\t\t\teditor.getControlById('QUANTITY_TRACE')?.setVisible(false);\n\t\t\t}\n\t\t});\n\t}\n\n\tonGridUpdatedHandler(event: BaseEvent)\n\t{\n\t\tsuper.onGridUpdatedHandler(event);\n\n\t\tconst [grid] = event.getCompatData();\n\t\tif ((grid && grid.getId() === this.getVariationGridId()) && (grid.getRows().getCountDisplayed() <= 0))\n\t\t{\n\t\t\tdocument.location.reload();\n\t\t}\n\t}\n\n\tonEditorAjaxSubmit(event: BaseEvent)\n\t{\n\t\tsuper.onEditorAjaxSubmit(event);\n\n\t\tconst [, response] = event.getCompatData();\n\n\t\tif (response.data)\n\t\t{\n\t\t\tif (response.data.NOTIFY_ABOUT_NEW_VARIATION)\n\t\t\t{\n\t\t\t\tthis.showNotification(Loc.getMessage('CPD_NEW_VARIATION_ADDED_MSGVER_1'));\n\t\t\t}\n\t\t}\n\t}\n\n\tinitDocumentTypeSelector()\n\t{\n\t\tlet productTypeSelector = document.getElementById(this.settings.productTypeSelector);\n\t\tlet productTypeSelectorTypes = this.settings.productTypeSelectorTypes;\n\n\t\tif (!productTypeSelector || !productTypeSelectorTypes)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tlet menuItems = [];\n\n\t\tObject.keys(productTypeSelectorTypes).forEach((type) => {\n\t\t\tmenuItems.push({\n\t\t\t\ttext: productTypeSelectorTypes[type],\n\t\t\t\tonclick: (e) => {\n\t\t\t\t\tlet slider = BX.SidePanel.Instance.getTopSlider();\n\t\t\t\t\tif (slider)\n\t\t\t\t\t{\n\t\t\t\t\t\tslider.url = BX.Uri.addParam(slider.getUrl(), { productTypeId: type });\n\t\t\t\t\t\tslider.requestMethod = 'post';\n\n\t\t\t\t\t\tslider.setFrameSrc();\n\t\t\t\t\t}\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\n\t\tlet popupMenu = MenuManager.create({\n\t\t\tid: 'productcard-product-type-selector',\n\t\t\tbindElement: productTypeSelector,\n\t\t\titems: menuItems,\n\t\t\tminWidth: productTypeSelector.offsetWidth,\n\t\t});\n\n\t\tproductTypeSelector.addEventListener('click', e => {\n\t\t\te.preventDefault();\n\t\t\tpopupMenu.show();\n\t\t});\n\t}\n}\n\nReflection.namespace('BX.Catalog').ProductCard = ProductCard;\n"],"names":["ProductCard","id","settings","initDocumentTypeSelector","isCopilotEnabled","initCopilot","extraMarkers","EventEmitter","subscribe","event","copilot","data","collectExtraMarkers","setExtraMarkers","productNameEditNode","document","querySelector","product_name","value","productNameNode","innerHTML","getCompatData","section","eventData","visible","isSimpleProduct","isCardSettingEnabled","isQuantityTraceRestricted","isWithOrdersMode","isInventoryManagementUsed","field","getData","getId","_selectedValue","MessageBox","show","title","Loc","getMessage","message","buttons","MessageBoxButtons","OK","okCaption","onOk","messageBox","close","popupOptions","closeIcon","events","onAfterClose","getChildren","forEach","hiddenFields","includes","setVisible","editor","sender","quantityTraceValue","_model","getField","getControlById","grid","getVariationGridId","getRows","getCountDisplayed","location","reload","response","NOTIFY_ABOUT_NEW_VARIATION","showNotification","productTypeSelector","getElementById","productTypeSelectorTypes","menuItems","Object","keys","type","push","text","onclick","e","slider","BX","SidePanel","Instance","getTopSlider","url","Uri","addParam","getUrl","productTypeId","requestMethod","setFrameSrc","popupMenu","MenuManager","create","bindElement","items","minWidth","offsetWidth","addEventListener","preventDefault","EntityCard","Reflection","namespace"],"mappings":";;;;;;AAAA,CAIsE;CAAA,IAEhEA,WAAW;GAAA;GAIhB,qBAAYC,EAAE,EACd;KAAA;KAAA,IADgBC,QAAQ,uEAAG,EAAE;KAAA;KAE5B,yGAAMD,EAAE,EAAEC,QAAQ;KAAE;OAAA;OAAA,OAJS;;KAM7B,MAAKC,wBAAwB,EAAE;KAE/B,IAAID,QAAQ,CAACE,gBAAgB,EAC7B;OACC,MAAKC,WAAW,EAAE;;KAClB;;GACD;KAAA;KAAA,8BAGD;OAAA;OACC,IAAI,CAACC,YAAY,GAAG,EAAE;OAEtBC,6BAAY,CAACC,SAAS,CAAC,yBAAyB,EAAE,UAACC,KAAK,EAAK;SAC5D,MAAI,CAACC,OAAO,GAAGD,KAAK,CAACE,IAAI,CAACD,OAAO;QACjC,CAAC;OAEFH,6BAAY,CAACC,SAAS,CAAC,yBAAyB,EAAE,UAACC,KAAK,EAAK;SAC5D,MAAI,CAACG,mBAAmB,CAACH,KAAK,CAAC;SAC/B,MAAI,CAACC,OAAO,CAACG,eAAe,CAAC,MAAI,CAACP,YAAY,CAAC;QAC/C,CAAC;;;KACF;KAAA,oCAEmBG,KAAK,EACzB;OACC,IAAMK,mBAAmB,GAAGC,QAAQ,CAACC,aAAa,CAAC,YAAY,CAAC;OAEhE,IAAIF,mBAAmB,EACvB;SACC,IAAI,CAACR,YAAY,CAACW,YAAY,GAAGH,mBAAmB,CAACI,KAAK;QAC1D,MAED;SACC,IAAMC,eAAe,GAAGJ,QAAQ,CAACC,aAAa,CAAC,2BAA2B,CAAC,CAACA,aAAa,CAAC,GAAG,CAAC;SAE9F,IAAIG,eAAe,EACnB;WACC,IAAI,CAACb,YAAY,CAACW,YAAY,GAAGE,eAAe,CAACC,SAAS;;;;;KAG5D;KAAA,gCAGD;OACC,OAAO,SAAS;;;KAChB;KAAA,gCAEeX,KAAgB,EAChC;OAAA;OACC,2BAA6BA,KAAK,CAACY,aAAa,EAAE;SAAA;SAA3CC,OAAO;SAAEC,SAAS;OAEzB,IAAIA,SAAS,CAACtB,EAAE,KAAK,oBAAoB,EACzC;SACCsB,SAAS,CAACC,OAAO,GAAG,IAAI,CAACC,eAAe,IAAI,IAAI,CAACC,oBAAoB,CAAC,oBAAoB,CAAC;;OAG5FnB,6BAAY,CAACC,SAAS,CAAC,qCAAqC,EAAE,UAACC,KAAK,EAAK;SAAA;SACxE,IAAMkB,yBAAyB,GAAG,EAAE,MAAI,CAACC,gBAAgB,IAAI,CAAC,MAAI,CAACC,yBAAyB,CAAC;SAC7F,IAAI,wCAAI,kCAAgC,CAACF,yBAAyB,EAClE;WACC;;SAGD,IAAMG,KAAK,sBAAGrB,KAAK,CAACsB,OAAO,EAAE,CAAC,CAAC,CAAC,oDAAlB,gBAAoBD,KAAK;SACvC,IAAI,CAACA,KAAK,EACV;WACC;;SAGD,IAAIA,KAAK,CAACE,KAAK,EAAE,KAAK,gBAAgB,IAAIF,KAAK,CAACG,cAAc,KAAK,GAAG,EACtE;WACC;;SAGDC,gCAAU,CAACC,IAAI,CACd;WACCC,KAAK,EAAEC,aAAG,CAACC,UAAU,CAAC,iCAAiC,CAAC;WACxDC,OAAO,EAAEF,aAAG,CAACC,UAAU,CAAC,2BAA2B,CAAC;WACpDE,OAAO,EAAEC,uCAAiB,CAACC,EAAE;WAC7BC,SAAS,EAAEN,aAAG,CAACC,UAAU,CAAC,2BAA2B,CAAC;WACtDM,IAAI,EAAE,cAACC,UAAU,EAAK;aACrB,wCAAI,+BAA+B,KAAK;aACxCA,UAAU,CAACC,KAAK,EAAE;YAClB;WACDC,YAAY,EAAE;aACbC,SAAS,EAAE,IAAI;aACfC,MAAM,EAAE;eACPC,YAAY,EAAE;iBAAA,yCAAM,MAAI,+BAA+B,KAAK;;;;UAG9D,CACD;SAED,wCAAI,+BAA+B,IAAI;QACvC,CAAC;OAEF5B,OAAO,aAAPA,OAAO,uBAAPA,OAAO,CAAE6B,WAAW,EAAE,CAACC,OAAO,CAAC,UAACtB,KAAK,EAAK;SACzC,IAAI,MAAI,CAACuB,YAAY,CAACC,QAAQ,CAACxB,KAAK,aAALA,KAAK,uBAALA,KAAK,CAAEE,KAAK,EAAE,CAAC,EAC9C;WACCF,KAAK,CAACyB,UAAU,CAAC,KAAK,CAAC;;QAExB,CAAC;OAEFhD,6BAAY,CAACC,SAAS,CAAC,gBAAgB,EAAE,UAACC,KAAK,EAAK;SAAA;SACnD,IAAM+C,MAAM,uBAAG/C,KAAK,CAACsB,OAAO,EAAE,CAAC,CAAC,CAAC,qDAAlB,iBAAoB0B,MAAM;SACzC,IAAI,CAACD,MAAM,EACX;WACC;;SAGD,IAAME,kBAAkB,GAAGF,MAAM,CAACG,MAAM,CAACC,QAAQ,CAAC,gBAAgB,EAAE,GAAG,CAAC;SACxE,IAAMjC,yBAAyB,GAAG,EAAE,MAAI,CAACC,gBAAgB,IAAI,CAAC,MAAI,CAACC,yBAAyB,CAAC;SAC7F,IAAI6B,kBAAkB,KAAK,GAAG,IAAI/B,yBAAyB,EAC3D;WAAA;WACC,yBAAA6B,MAAM,CAACK,cAAc,CAAC,gBAAgB,CAAC,0DAAvC,sBAAyCN,UAAU,CAAC,KAAK,CAAC;;QAE3D,CAAC;;;KACF;KAAA,qCAEoB9C,KAAgB,EACrC;OACC,8GAA2BA,KAAK;OAEhC,4BAAeA,KAAK,CAACY,aAAa,EAAE;SAAA;SAA7ByC,IAAI;OACX,IAAKA,IAAI,IAAIA,IAAI,CAAC9B,KAAK,EAAE,KAAK,IAAI,CAAC+B,kBAAkB,EAAE,IAAMD,IAAI,CAACE,OAAO,EAAE,CAACC,iBAAiB,EAAE,IAAI,CAAE,EACrG;SACClD,QAAQ,CAACmD,QAAQ,CAACC,MAAM,EAAE;;;;KAE3B;KAAA,mCAEkB1D,KAAgB,EACnC;OACC,4GAAyBA,KAAK;OAE9B,4BAAqBA,KAAK,CAACY,aAAa,EAAE;SAAA;SAAjC+C,QAAQ;OAEjB,IAAIA,QAAQ,CAACzD,IAAI,EACjB;SACC,IAAIyD,QAAQ,CAACzD,IAAI,CAAC0D,0BAA0B,EAC5C;WACC,IAAI,CAACC,gBAAgB,CAACjC,aAAG,CAACC,UAAU,CAAC,kCAAkC,CAAC,CAAC;;;;;KAG3E;KAAA,2CAGD;OACC,IAAIiC,mBAAmB,GAAGxD,QAAQ,CAACyD,cAAc,CAAC,IAAI,CAACtE,QAAQ,CAACqE,mBAAmB,CAAC;OACpF,IAAIE,wBAAwB,GAAG,IAAI,CAACvE,QAAQ,CAACuE,wBAAwB;OAErE,IAAI,CAACF,mBAAmB,IAAI,CAACE,wBAAwB,EACrD;SACC;;OAGD,IAAIC,SAAS,GAAG,EAAE;OAElBC,MAAM,CAACC,IAAI,CAACH,wBAAwB,CAAC,CAACrB,OAAO,CAAC,UAACyB,IAAI,EAAK;SACvDH,SAAS,CAACI,IAAI,CAAC;WACdC,IAAI,EAAEN,wBAAwB,CAACI,IAAI,CAAC;WACpCG,OAAO,EAAE,iBAACC,CAAC,EAAK;aACf,IAAIC,MAAM,GAAGC,EAAE,CAACC,SAAS,CAACC,QAAQ,CAACC,YAAY,EAAE;aACjD,IAAIJ,MAAM,EACV;eACCA,MAAM,CAACK,GAAG,GAAGJ,EAAE,CAACK,GAAG,CAACC,QAAQ,CAACP,MAAM,CAACQ,MAAM,EAAE,EAAE;iBAAEC,aAAa,EAAEd;gBAAM,CAAC;eACtEK,MAAM,CAACU,aAAa,GAAG,MAAM;eAE7BV,MAAM,CAACW,WAAW,EAAE;;;UAGtB,CAAC;QACF,CAAC;OAEF,IAAIC,SAAS,GAAGC,sBAAW,CAACC,MAAM,CAAC;SAClC/F,EAAE,EAAE,mCAAmC;SACvCgG,WAAW,EAAE1B,mBAAmB;SAChC2B,KAAK,EAAExB,SAAS;SAChByB,QAAQ,EAAE5B,mBAAmB,CAAC6B;QAC9B,CAAC;OAEF7B,mBAAmB,CAAC8B,gBAAgB,CAAC,OAAO,EAAE,UAAApB,CAAC,EAAI;SAClDA,CAAC,CAACqB,cAAc,EAAE;SAClBR,SAAS,CAAC3D,IAAI,EAAE;QAChB,CAAC;;;GACF;CAAA,EA/LwBoE,6BAAU;AAkMpCC,qBAAU,CAACC,SAAS,CAAC,YAAY,CAAC,CAACzG,WAAW,GAAGA,WAAW;;;;"}