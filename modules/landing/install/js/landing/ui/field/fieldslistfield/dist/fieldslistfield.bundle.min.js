this.BX=this.BX||{};this.BX.Landing=this.BX.Landing||{};this.BX.Landing.UI=this.BX.Landing.UI||{};(function(e,t,i,n,a,r,l,s,o,u,c,d,p,g,L,m,f,I,h,_,T){"use strict";function v(){var e=babelHelpers.taggedTemplateLiteral(['<div class="landing-ui-field-fields-list-container"></div>']);v=function t(){return e};return e}function E(){var e=babelHelpers.taggedTemplateLiteral(['<div><div class="crm-webform-resourcebooking-wrap"></div></div>']);E=function t(){return e};return e}var b=function(e){babelHelpers.inherits(u,e);function u(e){var t;babelHelpers.classCallCheck(this,u);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(u).call(this,e));t.setEventNamespace("BX.Landing.UI.Field.FieldsListField");t.setLayoutClass("landing-ui-field-fields-list");t.onSelectFieldButtonClick=t.onSelectFieldButtonClick.bind(babelHelpers.assertThisInitialized(t));t.onSelectProductsButtonClick=t.onSelectProductsButtonClick.bind(babelHelpers.assertThisInitialized(t));t.onSelectSeparatorButtonClick=t.onSelectSeparatorButtonClick.bind(babelHelpers.assertThisInitialized(t));t.onItemRemove=t.onItemRemove.bind(babelHelpers.assertThisInitialized(t));t.onItemEdit=t.onItemEdit.bind(babelHelpers.assertThisInitialized(t));t.onDragEnd=t.onDragEnd.bind(babelHelpers.assertThisInitialized(t));t.onFormChange=t.onFormChange.bind(babelHelpers.assertThisInitialized(t));t.items=[];t.options.items.forEach((function(e){t.addItem(e)}));t.actionPanel=new s.ActionPanel({renderTo:t.layout,left:[{id:"selectField",text:i.Loc.getMessage("LANDING_FIELDS_ADD_FIELD_BUTTON_TITLE"),onClick:t.onSelectFieldButtonClick}],right:[{id:"addProducts",text:i.Loc.getMessage("LANDING_FIELDS_SELECT_PRODUCTS_BUTTON_TITLE"),onClick:t.onSelectProductsButtonClick},{id:"selectSeparator",text:i.Loc.getMessage("LANDING_FIELDS_SELECT_SEPARATOR_BUTTON_TITLE"),onClick:t.onSelectSeparatorButtonClick}]});t.draggable=new a.Draggable({context:window.parent,container:t.getListContainer(),draggable:".landing-ui-component-list-item",dragElement:".landing-ui-button-icon-drag",type:a.Draggable.MOVE,offset:{y:-62}});t.draggable.subscribe("end",t.onDragEnd);return t}babelHelpers.createClass(u,[{key:"createInput",value:function e(){return this.getListContainer()}},{key:"getCrmFieldById",value:function e(t){return Object.values(this.options.crmFields).reduce((function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.FIELDS))}),[]).find((function(e){return e.name===t}))}},{key:"getCrmFieldCategoryById",value:function e(t){return this.options.crmFields[t]}},{key:"addItem",value:function e(t){var i=this;return this.createItem(t).then((function(e){i.items.push(e);n.Dom.append(e.getLayout(),i.getListContainer())}))}},{key:"prependItem",value:function e(t){var i=this;return this.createItem(t).then((function(e){i.items.unshift(e);n.Dom.prepend(e.getLayout(),i.getListContainer())}))}},{key:"insertItemAfterIndex",value:function e(t,i){var a=this;return this.createItem(t).then((function(e){a.items.splice(i+1,0,e);n.Dom.insertAfter(e.getLayout(),a.getListContainer().childNodes[i])}))}},{key:"isFieldAvailable",value:function e(t){if(n.Type.isStringFilled(t)){if(t.startsWith("product_")){return true}return n.Type.isPlainObject(this.getCrmFieldById(t))}return false}},{key:"getFieldItemTitle",value:function e(t){if(this.isFieldAvailable(t)){if(t.startsWith("product_")){return i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_TITLE")}var n=this.getCrmFieldById(t);var a=this.getCrmFieldCategoryById(n.entity_name);return"".concat(n.caption," \xb7 ").concat(a.CAPTION)}return""}},{key:"createResourceBookingFieldController",value:function e(t){if(t.type==="resourcebooking"){var i=L.PageObject.getRootWindow();var a=this.getCrmFieldById(t.id);return i.BX.Calendar.ResourcebookingUserfield.initCrmFormFieldController({field:babelHelpers.objectSpread({},t,{dict:a,node:n.Tag.render(E())})})}return null}},{key:"createItem",value:function e(t){var a={id:t.id,type:t.type?t.type:"",content:t.content,sourceOptions:babelHelpers.objectSpread({},t),draggable:true,removable:true,onRemove:this.onItemRemove,onEdit:this.onItemEdit,onFormChange:this.onFormChange,form:this.createFieldSettingsForm(t)};if(!u.isSeparator(t.id)){if(this.isFieldAvailable(t.id)){a.title=this.getFieldItemTitle(t.id);var r=this.getCrmFieldById(t.id);a.description=t.label||(r?r.caption:"");a.editable=true;a.isSeparator=false;a.fieldController=this.createResourceBookingFieldController(t);if(t.editing.supportAutocomplete){var s=new T.IconButton({id:"autocomplete",type:function(){if(t.autocomplete){return T.IconButton.Types.user1Active}return T.IconButton.Types.user1}(),style:{opacity:1,cursor:"default"},title:function(){if(t.autocomplete){return i.Loc.getMessage("LANDING_FIELDS_ITEM_AUTOCOMPLETE_ENABLED")}return i.Loc.getMessage("LANDING_FIELDS_ITEM_AUTOCOMPLETE_DISABLED")}()});a.form.subscribe("onChange",(function(e){if(e.getTarget().serialize().autocomplete){s.setType(T.IconButton.Types.user1Active)}else{s.setType(T.IconButton.Types.user1)}}));a.actions=[s]}var o=new l.ListItem(a);if(a.fieldController){return new Promise((function(e){if(n.Type.isFunction(a.fieldController.subscribe)){a.fieldController.subscribe("afterInit",(function(i){t.booking.settings_data=i.getData().settings.data;e(o)}))}else{e(o)}}))}return Promise.resolve(o)}a.editable=false;a.isSeparator=false;a.title="";a.description=i.Loc.getMessage("LANDING_FIELDS_ITEM_FIELD_UNAVAILABLE");a.error=true;var c=new l.ListItem(a);return Promise.resolve(c)}a.isSeparator=true;a.editable=!String(t.id).startsWith("hr_");a.title=u.getSeparatorTitle(t.id);if(n.Type.isString(t.label)){a.description=t.label}else if(String(t.id).startsWith("hr_")){a.description=u.getSeparatorTitle(t.id)}else{var d=this.getCrmFieldById(t.id);if(n.Type.isPlainObject(d)&&n.Type.isString(d.caption)){a.description=d.caption}else{a.description=""}}var p=new l.ListItem(a);return Promise.resolve(p)}},{key:"createCustomPriceDropdown",value:function e(t){return new BX.Landing.UI.Field.Dropdown({id:"customPrice",selector:"customPrice",items:[{name:i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_ALLOW_CUSTOM_PRICE_NOT_SELECTED"),value:null}].concat(babelHelpers.toConsumableArray(t.items.map((function(e){return{name:e.label,value:e.value}})))),content:t.items.reduce((function(e,t){if(t.changeablePrice&&e===null){return t.value}return e}),null)})}},{key:"createProductDefaultValueDropdown",value:function e(t){var n=new BX.Landing.UI.Field.Dropdown({id:"productDefaultValue",selector:"value",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_LIST_DEFAULT_VALUE_TITLE"),content:t.value,items:[{label:i.Loc.getMessage("LANDING_FORM_DEFAULT_VALUE_NOT_SELECTED"),value:null}].concat(babelHelpers.toConsumableArray(t.items)).map((function(e){return{name:e.label,value:e.value}}))});if(t.items.length>0){n.enable()}else{n.disable()}return n}},{key:"createDefaultValueField",value:function e(t){return new BX.Landing.UI.Field.Dropdown({selector:"value",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_LIST_DEFAULT_VALUE_TITLE"),content:t.value,items:[{label:i.Loc.getMessage("LANDING_FORM_DEFAULT_VALUE_NOT_SELECTED"),value:null}].concat(babelHelpers.toConsumableArray(t.items)).map((function(e){return{name:e.label,value:e.value}}))})}},{key:"createFieldSettingsForm",value:function e(a){var r=this;var l=[];var s=new c.FormSettingsForm({serializeModifier:function e(t){var i=babelHelpers.objectSpread({},t);if(Reflect.has(t,"label")){i.label=n.Text.decode(t.label)}if(Reflect.has(t,"required")){i.required=t.required.includes("required")}if(Reflect.has(t,"multiple")){i.multiple=t.multiple.includes("multiple")}if(Reflect.has(t,"bigPic")){i.bigPic=t.bigPic.includes("bigPic")}if(Reflect.has(t,"value")&&n.Type.isArrayFilled(t.items)){i.items=i.items.map((function(e){e.selected=t.value===e.value;return e}))}if(Reflect.has(t,"products")){i.items=n.Runtime.clone(t.products);if(!n.Type.isPlainObject(i.editing)){i.editing={}}if(Reflect.has(t,"value")&&n.Type.isArrayFilled(i.items)){i.items.forEach((function(e){e.selected=String(t.value)===String(e.value)}))}i.editing.catalog=n.Runtime.clone(t.products)}if(Reflect.has(t,"valueType")){if(!n.Type.isPlainObject(i.editing)){i.editing={}}if(!n.Type.isPlainObject(i.editing.editable)){i.editing.editable={}}i.editing.editable.valueType=t.valueType}if(n.Type.isArray(t.useCustomPrice)){i.items.forEach((function(e){e.changeablePrice=t.useCustomPrice.includes("useCustomPrice")&&String(e.value)===String(t.customPrice)}));delete i.customPrice;delete i.useCustomPrice}if(n.Type.isArray(t.autocomplete)){i.autocomplete=t.autocomplete.length>0}if(n.Type.isArrayFilled(t.contentTypes)){if(t.contentTypes.includes("any")){i.contentTypes=[]}}return i}});if(a.type==="product"){l.push(new f.ProductField({title:i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_TITLE2"),selector:"products",items:a.editing.catalog||[],iblockId:this.options.dictionary.catalog.id,onChange:function e(){var t=s.fields.get("customPrice");var i=r.createCustomPriceDropdown(babelHelpers.objectSpread({},a,{items:s.serialize().items}));var l=a.items.some((function(e){return e.changeablePrice}));var o=s.fields.get("useCustomPrice");if(l||o.getValue().includes("useCustomPrice")){n.Dom.style(i.getLayout(),"display",null)}else{n.Dom.style(i.getLayout(),"display","none")}i.setValue(t.getValue());s.replaceField(t,i);var u=s.fields.get("productDefaultValue");var c=r.createProductDefaultValueDropdown(babelHelpers.objectSpread({},a,{items:s.serialize().items}));s.replaceField(u,c)}}))}if(a.editing.hasLabel){l.push(new o.TextField({selector:"label",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_LABEL_FIELD_TITLE"),content:a.label,textOnly:true}))}if(a.editing.canBeRequired){l.push(new BX.Landing.UI.Field.Checkbox({selector:"required",compact:true,items:[{name:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_REQUIRED_FIELD_TITLE"),value:"required"}],value:a.required?["required"]:[]}))}if(a.editing.canBeMultiple){l.push(new BX.Landing.UI.Field.Checkbox({selector:"multiple",compact:true,items:[{name:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_MULTIPLE_FIELD_TITLE"),value:"multiple"}],value:a.multiple?["multiple"]:[]}))}if(a.editing.hasStringDefaultValue){l.push(new o.TextField({selector:"value",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_DEFAULT_VALUE_FIELD_TITLE"),content:a.value,textOnly:true}))}if(a.type==="product"){l.push(new BX.Landing.UI.Field.Checkbox({selector:"bigPic",compact:true,items:[{name:i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_SHOW_BIG_PICTURE"),value:"bigPic"}],value:a.bigPic?["bigPic"]:[]}));var u=a.items.some((function(e){return e.changeablePrice}));var d=this.createCustomPriceDropdown(a);if(u){n.Dom.style(d.getLayout(),"display",null)}else{n.Dom.style(d.getLayout(),"display","none")}l.push(new BX.Landing.UI.Field.Checkbox({id:"useCustomPrice",selector:"useCustomPrice",compact:true,items:[{name:i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_PRODUCTS_ALLOW_CUSTOM_PRICE"),value:"useCustomPrice"}],value:u?["useCustomPrice"]:[],onChange:function e(i){if(i instanceof t.BaseField){var a=s.fields.get("customPrice");if(i.getValue().includes("useCustomPrice")){n.Dom.style(a.getLayout(),"display",null)}else{n.Dom.style(a.getLayout(),"display","none")}}}}));l.push(d);l.push(this.createProductDefaultValueDropdown(a))}if(["list","radio"].includes(a.type)&&a.editing.items.length>0){var g=this.createDefaultValueField(a);var L=new p.ListSettingsField({selector:"items",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_LIST_SETTINGS_TITLE"),items:function(){return a.editing.items.map((function(e){var t=a.items.find((function(t){return String(t.value)===String(e.id)}));var i=!!t;return{name:i?t.label:e.value,value:e.id,checked:i}}))}()});L.subscribe("onChange",(function(){var e=s.fields.find((function(e){return e.selector==="value"}));s.replaceField(e,r.createDefaultValueField(babelHelpers.objectSpread({},a,{items:s.serialize().items,value:e.getValue()})))}));l.push(L);l.push(g)}if(n.Type.isPlainObject(a.editing)&&n.Type.isArrayFilled(a.editing.valueTypes)){l.push(new BX.Landing.UI.Field.Dropdown({selector:"valueType",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_VALUE_TYPE"),content:a.editing.editable.valueType,items:a.editing.valueTypes.map((function(e){return{name:e.name,value:e.id}}))}))}if(a.type==="file"&&n.Type.isArrayFilled(this.options.dictionary.contentTypes)){var m=n.Type.isArrayFilled(a.contentTypes)?a.contentTypes:["any"];var I=m;var h=new BX.Landing.UI.Field.Checkbox({selector:"contentTypes",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_ALLOWED_FILE_TYPE"),value:m,items:[function(){if(i.Loc.hasMessage("LANDING_FIELDS_ITEM_FORM_ALLOWED_ANY_FILE_TYPE")){return{name:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_ALLOWED_ANY_FILE_TYPE"),value:"any"}}return undefined}()].concat(babelHelpers.toConsumableArray(this.options.dictionary.contentTypes.map((function(e){var t=e.hint?'<span class="ui-hint" data-hint="'.concat(n.Text.encode(e.hint),'"></span>'):"";return{html:'<span style="display: flex; align-items: center;">'.concat(n.Text.encode(e.name)," ").concat(t,"</span>"),name:"",value:e.id}})))),onValueChange:function e(){var t=h.getValue();if(t.includes("any")){if(I.includes("any")){h.setValue(t.filter((function(e){return e!=="any"})))}else{h.setValue(["any"])}}I=h.getValue()}});BX.UI.Hint.init(h.getLayout());l.push(h)}if(n.Text.toBoolean(a.editing.supportAutocomplete)===true){l.push(new BX.Landing.UI.Field.Checkbox({selector:"autocomplete",compact:true,multiple:false,items:[{name:i.Loc.getMessage("LANDING_FIELDS_ITEM_ENABLE_AUTOCOMPLETE"),html:n.Text.encode(i.Loc.getMessage("LANDING_FIELDS_ITEM_ENABLE_AUTOCOMPLETE"))+'<span \n\t\t\t\t\t\t\t\t\tclass="landing-ui-form-help" \n\t\t\t\t\t\t\t\t\tstyle="margin: 0 0 0 5px;"\n\t\t\t\t\t\t\t\t\tonclick="top.BX.Helper.show(\'redirect=detail&code=14611764\'); return false;"\n\t\t\t\t\t\t\t\t><a href="javascript: void();"></a></span>',value:"autocomplete"}],value:a.autocomplete?["autocomplete"]:false}))}if(n.Text.toBoolean(a.editing.hasHint)===true){l.push(new o.TextField({selector:"hint",title:i.Loc.getMessage("LANDING_FIELDS_ITEM_FORM_FIELD_HINT_TITLE"),content:a.hint,textOnly:true}))}if(n.Text.toBoolean(a.editing.supportHintOnFocus)===true){l.push(new BX.Landing.UI.Field.Checkbox({selector:"hintOnFocus",compact:true,multiple:false,items:[{name:i.Loc.getMessage("LANDING_FIELDS_ITEM_ENABLE_HINT_ON_FOCUS"),value:"hintOnFocus"}],value:a.hintOnFocus?["hintOnFocus"]:false}))}l.forEach((function(e){s.addField(e)}));return s}},{key:"getListContainer",value:function e(){return this.cache.remember("listContainer",(function(){return n.Tag.render(v())}))}},{key:"onSelectFieldButtonClick",value:function e(t){var i=this;t.preventDefault();r.FieldsPanel.getInstance({isLeadEnabled:this.options.isLeadEnabled}).show({disabledFields:this.items.map((function(e){return e.options.id}))}).then((function(e){if(n.Type.isArrayFilled(e)){i.options.crmFields=r.FieldsPanel.getInstance().getOriginalCrmFields();i.onFieldsSelect(e)}}))}},{key:"onFieldsSelect",value:function e(t){var i=this;var n={fields:t.map((function(e){return{name:e}}))};void this.showLoader();d.FormClient.getInstance().prepareOptions(this.options.formOptions,n).then((function(e){void i.hideLoader();return Promise.all(e.data.fields.map((function(e){return i.addItem(e)})))})).then((function(){i.emit("onChange",{skipPrepare:true})}))}},{key:"getValue",value:function e(){return this.items.map((function(e){return e.getValue()}))}},{key:"onSelectProductsButtonClick",value:function e(t){var i=this;t.preventDefault();var n={fields:[{type:"product"}]};void this.showLoader();d.FormClient.getInstance().prepareOptions(this.options.formOptions,n).then((function(e){void i.hideLoader();var t=e.data.fields.map((function(e){return i.addItem(e)}));Promise.all(t).then((function(){i.emit("onChange",{skipPrepare:true})}))}))}},{key:"onSelectSeparatorButtonClick",value:function e(t){var n=this;t.preventDefault();g.SeparatorPanel.getInstance().show().then((function(e){var t=[e];if(e.type==="page"&&!n.items.find((function(e){return e.options.type==="page"}))){t.push(babelHelpers.objectSpread({},t[0]))}void n.showLoader();d.FormClient.getInstance().prepareOptions(n.options.formOptions,{fields:t}).then((function(t){void n.hideLoader();var a=Promise.resolve();if(e.type==="page"&&!n.items.find((function(e){return e.options.type==="page"}))){t.data.fields[0].label=i.Loc.getMessage("LANDING_FIELDS_ITEM_PAGE_TITLE").replace("#number#",1);t.data.fields[1].label=i.Loc.getMessage("LANDING_FIELDS_ITEM_PAGE_TITLE").replace("#number#",2);a=Promise.all([n.prependItem(t.data.fields[0]),n.insertItemAfterIndex(t.data.fields[1],1)])}else{t.data.fields.forEach((function(e){var t=e.id.split("_"),r=babelHelpers.slicedToArray(t,1),l=r[0];var s=n.items.filter((function(e){return e.options.id.startsWith(l)})).length;if(l==="page"){e.label=i.Loc.getMessage("LANDING_FIELDS_ITEM_PAGE_TITLE").replace("#number#",s+1)}if(l==="section"){e.label=i.Loc.getMessage("LANDING_FIELDS_ITEM_SECTION_TITLE").replace("#number#",s+1)}if(l==="hr"){e.label=i.Loc.getMessage("LANDING_FIELDS_ITEM_LINE_TITLE").replace("#number#",s+1)}a=n.addItem(e)}))}a.then((function(){n.emit("onChange",{skipPrepare:true})}))}))}))}},{key:"onItemRemove",value:function e(t){this.items=this.items.filter((function(e){return e!==t.getTarget()}));this.emit("onChange",{skipPrepare:true})}},{key:"onItemEdit",value:function e(t){var i=this;var a=t.getTarget(),r=a.options;if(r.fieldController){t.preventDefault();r.fieldController.showSettingsPopup();setTimeout((function(){r.fieldController.settingsPopup.subscribeOnce("onClose",(function(){r.sourceOptions.booking.settings_data=r.fieldController.getSettings().data;var e=r.sourceOptions.booking.settings_data;Object.keys(e).forEach((function(t){if(n.Type.isArray(e[t].value)){e[t].value=e[t].value.join("|")}}));i.emit("onChange",{skipPrepare:true})}))}),1e3)}}},{key:"onFormChange",value:function e(t){this.emit("onChange",{skipPrepare:true});var i=t.getTarget();var n=i.getValue();i.setDescription(n.label)}},{key:"onDragEnd",value:function e(){var t=this;setTimeout((function(){t.items=babelHelpers.toConsumableArray(t.getListContainer().children).map((function(e){var i=n.Dom.attr(e,"data-id");return t.items.find((function(e){return e.options.id===i}))}));t.emit("onChange",{skipPrepare:true})}))}},{key:"getLoader",value:function e(){return this.cache.remember("loader",(function(){return new m.Loader({size:50,mode:"inline",offset:{top:"5px",left:"225px"}})}))}},{key:"showLoader",value:function e(){var t=this.getLoader();var i=this.getListContainer();n.Dom.append(t.layout,i);return t.show(i)}},{key:"hideLoader",value:function e(){var t=this.getLoader();n.Dom.remove(t.layout);return t.hide()}}],[{key:"isSeparator",value:function e(t){if(n.Type.isStringFilled(t)){return t.startsWith("hr")||t.startsWith("section")||t.startsWith("page")}return false}},{key:"getSeparatorTitle",value:function e(t){if(n.Type.isStringFilled(t)){if(t.startsWith("hr")){return i.Loc.getMessage("LANDING_SEPARATOR_SOLID_LINE")}if(t.startsWith("section")){return i.Loc.getMessage("LANDING_SEPARATOR_HEADER")}if(t.startsWith("page")){return i.Loc.getMessage("LANDING_SEPARATOR_PAGE")}}return i.Loc.getMessage("LANDING_FIELDS_LIST_FIELD_SEPARATOR_TITLE")}}]);return u}(t.BaseField);e.FieldsListField=b})(this.BX.Landing.UI.Field=this.BX.Landing.UI.Field||{},BX.Landing.UI.Field,BX.Landing,BX,BX.UI.DragAndDrop,BX.Landing.UI.Panel,BX.Landing.UI.Component,BX.Landing.UI.Component,BX.Landing.UI.Field,BX.Event,BX.Landing.UI.Form,BX.Crm.Form,BX.Landing.UI.Field,BX.Landing.UI.Panel,BX.Landing,BX,BX.Landing.Ui.Field,BX.Calendar,BX,BX,BX.Landing.UI.Component);
//# sourceMappingURL=fieldslistfield.bundle.map.js