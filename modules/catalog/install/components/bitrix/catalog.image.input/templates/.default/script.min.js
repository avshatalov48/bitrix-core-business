(function(e,t,i){"use strict";var a=function(){babelHelpers.createClass(e,null,[{key:"getById",value:function t(i){return e.imageInputInstances.get(i)||null}}]);function e(a){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"onUploaderIsInitedHandler",this.handleOnUploaderIsInited.bind(this));babelHelpers.defineProperty(this,"values",new Map);babelHelpers.defineProperty(this,"newValues",new Map);this.id=a;this.wrapper=BX(a);this.productId=s.productId;this.skuId=s.skuId;this.iblockId=s.iblockId;this.saveable=s.saveable;this.inputId=s.inputId;this.ajaxStatus=e.WAIT_STATUS;if(s.hideAddButton===true){var n=this.wrapper.querySelector('[data-role="image-add-button"]');if(t.Type.isDomNode(n)){n.style.display="none"}}if(t.Type.isObject(s.values)){for(var l in s.values){if(!s.values.hasOwnProperty(l)){continue}this.values.set(l,s.values[l])}}if(this.isSaveable()){i.EventEmitter.subscribe("onUploaderIsInited",this.onUploaderIsInitedHandler)}e.imageInputInstances.set(this.id,this)}babelHelpers.createClass(e,[{key:"isSaveable",value:function e(){return this.saveable===true}},{key:"handleOnUploaderIsInited",value:function e(a){var s=a.getCompatData(),n=babelHelpers.slicedToArray(s,2),l=n[0],r=n[1];if(t.Type.isStringFilled(this.inputId)&&this.inputId===l){this.uploaderFieldMap=new Map;i.EventEmitter.subscribe(r,"onFileIsDeleted",this.onFileDelete.bind(this));i.EventEmitter.subscribe(r,"onFileIsUploaded",this.onFileUpload.bind(this));i.EventEmitter.subscribe(r,"onDone",this.onDone.bind(this));i.EventEmitter.subscribe(r,"onQueueIsChanged",this.onQueueIsChanged.bind(this))}}},{key:"unsubscribeEvents",value:function e(){if(this.isSaveable()){i.EventEmitter.unsubscribe("onUploaderIsInited",this.onUploaderIsInitedHandler)}}},{key:"unsubscribeImageInputEvents",value:function e(){if(t.Reflection.getClass("BX.UI.ImageInput")){var i=BX.UI.ImageInput.getById(this.inputId);if(i){i.unsubscribeEvents()}}}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"onFileDelete",value:function e(i){var a=i.getCompatData(),s=babelHelpers.slicedToArray(a,4),n=s[3];var l=n.input_name;if(t.Type.isNil(l)){return null}this.values.delete(l);if(this.isSaveable()){this.save()}}},{key:"onQueueIsChanged",value:function e(i){var a=i.getCompatData(),s=babelHelpers.slicedToArray(a,4),n=s[1],l=s[2],r=s[3];var u=r.file;if(n==="add"&&"input_name"in u&&t.Type.isNil(this.uploaderFieldMap.get(l))){this.uploaderFieldMap.set(l,u["input_name"])}}},{key:"onDone",value:function e(){if(this.newValues.size>0&&this.isSaveable()){this.save()}this.newValues.clear()}},{key:"onFileUpload",value:function e(i){var a=i.getCompatData(),s=babelHelpers.slicedToArray(a,3),n=s[0],l=s[2];if(!this.isSaveable()||!t.Type.isObject(l)||!("file"in l)||!("files"in l.file)||!("default"in l.file.files)){return}var r=l["file"]["files"]["default"];var u={fileId:n,data:{name:r.name,type:r.type,tmp_name:r.path,size:r.size,error:null}};var d=this.uploaderFieldMap.get(n)||n;this.values.set(d,u);this.newValues.set(d,u)}},{key:"save",value:function e(){var a=this;if(this.submitFileTimeOut){clearTimeout(this.submitFileTimeOut)}var s=t.Text.getRandom(20);this.refreshImageSelectorId=s;this.submitFileTimeOut=setTimeout(function(){var e={};a.values.forEach(function(t,i){e[i]=t});t.ajax.runAction("catalog.productSelector.saveMorePhoto",{json:{productId:a.productId,variationId:a.skuId,iblockId:a.iblockId,imageValues:e}}).then(function(e){var n;if(!a.refreshImageSelectorId===s){return}a.values.clear();if(t.Type.isObject((n=e.data)===null||n===void 0?void 0:n.values)){for(var l in e.data.values){if(!e.data.values.hasOwnProperty(l)){continue}a.values.set(l,e.data.values[l])}}t.Runtime.html(a.wrapper,e.data.input);i.EventEmitter.emit("Catalog.ImageInput::save",[a.id,a.inputId,e])})},500)}}]);return e}();babelHelpers.defineProperty(a,"imageInputInstances",new Map);babelHelpers.defineProperty(a,"PROCESS_STATUS","PROCESS");babelHelpers.defineProperty(a,"WAIT_STATUS","WAIT");t.Reflection.namespace("BX.Catalog").ImageInput=a})(this.window=this.window||{},BX,BX.Event);
//# sourceMappingURL=script.map.js