{"version":3,"file":"metrika.bundle.js","sources":["../src/metrika.js"],"sourcesContent":["import { Dom, Event } from 'main.core';\n\n/**\n * @memberOf BX.Landing\n */\nexport class Metrika\n{\n\tformSelector: string;\n\twidgetBlockItemSelector: string;\n\tsiteType: ?string;\n\tformBlocks: Array<string>;\n\tformsLoaded: Array;\n\tsendedLabel: Array;\n\twidgetOpened: boolean;\n\twidgetBlockHover: boolean;\n\n\tconstructor(light: boolean)\n\t{\n\t\tthis.sendedLabel = [];\n\n\t\tif (light === true)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.formSelector= '.bitrix24forms';\n\t\tthis.widgetBlockItemSelector = '.landing-b24-widget-button-social-item';\n\t\tthis.formBlocks = [...document.querySelectorAll(this.formSelector)];\n\t\tthis.siteType = this.getSiteType();\n\t\tthis.formsLoaded = [];\n\t\tthis.widgetOpened = false;\n\t\tthis.widgetBlockHover = false;\n\n\t\tif (this.isFormsExists())\n\t\t{\n\t\t\tthis.waitForForms();\n\t\t}\n\t\tthis.waitForWidget();\n\t\tthis.detectAnchor();\n\t}\n\n\t/**\n\t * Returns site type.\n\t * @return {string|null}\n\t */\n\tgetSiteType()\n\t{\n\t\tconst metaSiteType = document.querySelector('meta[property=\"Bitrix24SiteType\"]');\n\t\tif (metaSiteType)\n\t\t{\n\t\t\treturn metaSiteType.getAttribute('content');\n\t\t}\n\t\treturn null;\n\t}\n\n\t/**\n\t * Is any form exists into the page.\n\t * @return {boolean}\n\t */\n\tisFormsExists(): boolean\n\t{\n\t\treturn this.formBlocks.length > 0;\n\t}\n\n\t/**\n\t * Listener for address links on the page.\n\t */\n\tdetectAnchor(): void\n\t{\n\t\t[...document.querySelectorAll('a')].map(node => {\n\t\t\tlet href = Dom.attr(node, 'href');\n\t\t\tif (href)\n\t\t\t{\n\t\t\t\thref = href.toString();\n\t\t\t}\n\t\t\tif (href && href.indexOf(':'))\n\t\t\t{\n\t\t\t\tconst hrefPref = href.split(':')[0];\n\t\t\t\tif (['callto', 'tel', 'mailto'].includes(hrefPref))\n\t\t\t\t{\n\t\t\t\t\tEvent.bind(node, 'click', () => {\n\t\t\t\t\t\tthis.sendLabel('', 'addressClick', hrefPref);\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\t/**\n\t * Listener for widget commands.\n\t */\n\twaitForWidget(): void\n\t{\n\t\t[...document.querySelectorAll(this.widgetBlockItemSelector)].map(node => {\n\t\t\tEvent.bind(node, 'mouseover', () => {\n\t\t\t\tthis.widgetBlockHover = true;\n\t\t\t});\n\t\t\tEvent.bind(node, 'mouseout', () => {\n\t\t\t\tthis.widgetBlockHover = false;\n\t\t\t});\n\t\t\tEvent.bind(node, 'click', () => {\n\t\t\t\t[...node.classList].map(className => {\n\t\t\t\t\tif (className.indexOf('ui-icon-service-') === 0)\n\t\t\t\t\t{\n\t\t\t\t\t\tconst ol = className.substr('ui-icon-service-'.length);\n\t\t\t\t\t\tthis.sendLabel('', 'olOpenedFromWidget', ol);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\n\t\twindow.addEventListener('onBitrixLiveChat', event => {\n\t\t\tconst {widget, widgetHost} = event.detail;\n\t\t\twidget.subscribe({\n\t\t\t\ttype: BX.LiveChatWidget.SubscriptionType.every,\n\t\t\t\tcallback: event => {\n\t\t\t\t\tif (event.type === BX.LiveChatWidget.SubscriptionType.widgetOpen)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (this.widgetBlockHover)\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.sendLabel(widgetHost, 'chatOpenedFromWidget');\n\t\t\t\t\t\t}\n\t\t\t\t\t\telse\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tthis.sendLabel(widgetHost, 'chatOpened');\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t});\n\t\t});\n\t}\n\n\t/**\n\t * Sends analytic label when form is loaded, otherwise sends fail label.\n\t */\n\twaitForForms(): void\n\t{\n\t\twindow.addEventListener('b24:form:show:first', event => {\n\t\t\tconst {id, sec, address} = event.detail.object.identification;\n\t\t\tconst disabled = event.detail.object.disabled;\n\n\t\t\tthis.formsLoaded.push(id + '|' + sec);\n\n\t\t\tif (disabled)\n\t\t\t{\n\t\t\t\tthis.sendLabel(address, 'formDisabledLoad', id+ '|' + sec);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.sendLabel(address, 'formSuccessLoad', id+ '|' + sec);\n\t\t\t}\n\t\t});\n\n\t\tsetTimeout(() => {\n\t\t\tthis.formBlocks.map(node => {\n\t\t\t\tconst dataAttr = Dom.attr(node, 'data-b24form');\n\t\t\t\tif (dataAttr && dataAttr.indexOf('|'))\n\t\t\t\t{\n\t\t\t\t\tconst formData = dataAttr.split('|');\n\t\t\t\t\tif (!this.formsLoaded.includes(formData[0] + '|' + formData[1]))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.sendLabel(\n\t\t\t\t\t\t\tnull,\n\t\t\t\t\t\t\t'formFailLoad',\n\t\t\t\t\t\t\tformData[1] ? formData[0] + '|' + formData[1] : formData[0]\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\t\t}, 5000);\n\t}\n\n\t/**\n\t * Clears already sent labels.\n\t */\n\tclearSendedLabel()\n\t{\n\t\tthis.sendedLabel = [];\n\t}\n\n\t/**\n\t * Send label to the portal.\n\t * @param {string|null} portalUrl\n\t * @param {string} label\n\t * @param {string|null} value\n\t */\n\tsendLabel(portalUrl: ?string, label: string, value: ?string): void\n\t{\n\t\tif (this.sendedLabel.includes(label + value))\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tif (value && value.substr(0, 1) === '#')\n\t\t{\n\t\t\tvalue = value.substr(1);\n\t\t}\n\t\tthis.sendedLabel.push(label + value);\n\t\tBX.ajax({url:\n\t\t\t(portalUrl ? portalUrl : '') + '/bitrix/images/landing/analytics/pixel.gif?action=' + label +\n\t\t\t(value ? '&value=' + value : '') +\n\t\t\t(this.siteType ? '&siteType=' + this.siteType : '') +\n\t\t\t'&time=' + (new Date().getTime())\n\t\t});\n\t}\n}"],"names":["Metrika","light","sendedLabel","formSelector","widgetBlockItemSelector","formBlocks","document","querySelectorAll","siteType","getSiteType","formsLoaded","widgetOpened","widgetBlockHover","isFormsExists","waitForForms","waitForWidget","detectAnchor","metaSiteType","querySelector","getAttribute","length","map","node","href","Dom","attr","toString","indexOf","hrefPref","split","includes","Event","bind","sendLabel","classList","className","ol","substr","window","addEventListener","event","detail","widget","widgetHost","subscribe","type","BX","LiveChatWidget","SubscriptionType","every","callback","widgetOpen","object","identification","id","sec","address","disabled","push","setTimeout","dataAttr","formData","portalUrl","label","value","ajax","url","Date","getTime"],"mappings":"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"}