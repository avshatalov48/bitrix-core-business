this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,r,s,i){"use strict";const a={decode(e){if(e.startsWith("/me")){return`[i]${e.substr(4)}[/i]`}if(e.startsWith("/loud")){return`[size=20]${e.substr(6)}[/size]`}return e},purify(e){if(e.startsWith("/me")){return e.substr(4)}if(e.startsWith("/loud")){return e.substr(6)}return e}};const n={_tagsReplacement:[],_putReplacement:[],_sendReplacement:[],_codeReplacement:[],clean(){this._tagsReplacement=[];this._putReplacement=[];this._sendReplacement=[];this._codeReplacement=[]},cutTags(e){e=e.replaceAll(/\[(.+?)](.*?)\[\/(.+?)]/gi,(e=>{const t=this._tagsReplacement.length;this._tagsReplacement.push(e);return"####REPLACEMENT_TAG_"+t+"####"}));return e},recoverTags(e){this._tagsReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_TAG_"+r+"####",t)}));return e},cutPutTag(e){e=e.replace(/\[PUT(?:=(.+?))?](.+?)?\[\/PUT]/gi,(e=>{const t=this._putReplacement.length;this._putReplacement.push(e);return"####REPLACEMENT_PUT_"+t+"####"}));return e},recoverPutTag(e){this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}));return e},cutSendTag(e){e=e.replace(/\[SEND(?:=(.+?))?](.+?)?\[\/SEND]/gi,(e=>{const t=this._sendReplacement.length;this._sendReplacement.push(e);return"####REPLACEMENT_SEND_"+t+"####"}));return e},recoverSendTag(e){this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}));return e},cutCodeTag(e){e=e.replace(/\[CODE](<br \/>)?(.*?)\[\/CODE]/gis,(e=>{const t=this._codeReplacement.length;this._codeReplacement.push(e);return"####REPLACEMENT_CODE_"+t+"####"}));return e},recoverCodeTag(e){this._codeReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_CODE_"+r+"####",t)}));if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}return e},recoverRecursionTag(e){if(this._sendReplacement.length>0){do{this._sendReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_SEND_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_SEND_"))}e=e.split("####REPLACEMENT_SP_").join("####REPLACEMENT_PUT_");if(this._putReplacement.length>0){do{this._putReplacement.forEach(((t,r)=>{e=e.replace("####REPLACEMENT_PUT_"+r+"####",t)}))}while(e.includes("####REPLACEMENT_PUT_"))}return e}};const c=i.Extension.getSettings("im.v2.lib.parser");const o=c.get("v2");const l=()=>o?BX.Messenger.v2.Application.Core:BX.Messenger.Embedding.Application.Core;const g=()=>o?BX.Messenger.v2.Lib.Utils:BX.Messenger.Embedding.Lib.Utils;const d=()=>o?BX.Messenger.v2.Lib.Logger:BX.Messenger.Embedding.Lib.Logger;const p=()=>o?BX.Messenger.v2.Const:BX.Messenger.Embedding.Const;const u=()=>o?BX.Messenger.v2.Lib.SmileManager:BX.Messenger.Embedding.Lib.SmileManager;const m=()=>{if(o){const e=BX.Messenger.v2.Const.Settings.message.bigSmiles;return l().getStore().getters["application/settings/get"](e)}return l().getStore().getters["application/getOption"]("bigSmileEnable")};const h=10;const f={recursiveReplace(e,t,r){if(!i.Type.isStringFilled(e)){return e}let s=0;let a=true;do{a=false;s++;e=e.replace(t,((...e)=>{a=true;return r(...e)}))}while(a&&s<=h);return e},getFinalContextTag(e){const t=e.match(/(chat\d+|(\d+):(\d+))\/(\d+)/i);if(!t){return""}let[,r,s,i,a]=t;if(r.toString().startsWith("chat")){if(r==="chat0"){return""}return e}s=Number.parseInt(s,10);i=Number.parseInt(i,10);if(l().getUserId()===s){return`${i}/${a}}`}if(l().getUserId()===i){return`${s}/${a}}`}return""}};const{FileType:T,FileIconType:E,AttachDescription:x}=p();const b={getIcon(e,t=""){return t},addIconToShortText(e){let{text:t}=e;const{attach:r,files:s}=e;if(i.Type.isArrayFilled(s)||s===true){t=this.getTextForFile(t,s)}else if(r===true||i.Type.isArrayFilled(r)||i.Type.isStringFilled(r)){t=this.getTextForAttach(t,r)}return t.trim()},getQuoteBlock(){const e=this.getIcon(E.quote);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_QUOTE")}]`},getCodeBlock(){const e=this.getIcon(E.code);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_CODE")}]`},getImageBlock(){const e=this.getIcon(E.image);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_IMAGE")}]`},getFileBlock(){const e=this.getIcon(E.file);if(e){return e}return`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`},getTextForFile(e,t){let r=e;if(i.Type.isArray(t)&&t.length>0){const[s]=t;r=this.getIconTextForFile(e,s)}else if(t===true){r=this.getIconTextForFileType(e,E.file)}return r},getTextForAttach(e,t){let r="";if(i.Type.isArray(t)&&t.length>0){const[e]=t;if(i.Type.isStringFilled(e.description)){r=e.description}}else if(i.Type.isStringFilled(t)){r=t}if(i.Type.isStringFilled(r)){if(r===x.skipMessage){r=""}else{r=V.purifyText(r,{showPhraseMessageWasDeleted:false})}}else{const e=this.getIcon(E.attach);if(e){r=`${e} ${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}`}else{r=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_ATTACH")}]`}}return`${e} ${r}`.trim()},getIconTextForFileType(e,t=E.file){let r=e;const s=this.getIcon(t);const a=i.Loc.getMessage(`IM_PARSER_ICON_TYPE_${t.toUpperCase()}`);if(s){const t=e.replace(/(\s|\n)/gi,"").length>0;const i=t?e:a;r=`${s} ${i}`}else{r=`[${a}] ${e}`}return r.trim()},getIconTextForFile(e,t){const r=e.replace(/(\s|\n)/gi,"").length>0;if(!t||!t.type){return e}if(t.type===T.image){return this.getIconTextForFileType(e,E.image)}else if(t.type===T.audio){return this.getIconTextForFileType(e,E.audio)}else if(t.type===T.video){return this.getIconTextForFileType(e,E.video)}else{const s=this.getIcon(E.file);if(s){const i=r?e:"";e=`${s} ${t.name} ${i}`}else{e=`${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}: ${t.name} ${e}`}return e.trim()}}};let _=e=>e,y,M;const{EventType:R}=p();const I="&gt;&gt;";const S={decodeArrowQuote(e){if(!e.includes(I)){return e}let t=false;const r=e.split("<br />");for(let e=0;e<r.length;e++){if(!r[e].startsWith(I)){continue}const s=e;const i='<div class="bx-im-message-quote --inline">';const a='<div class="bx-im-message-quote__wrap">';const n="</div>";r[s]=r[s].replace(I,`${i}${a}`);while(++e<r.length&&r[e].startsWith(I)){r[e]=r[e].replace(I,"")}const c=e-1;r[c]+=`${n}${n}`;t=true}if(!t){return e}return r.join("<br />")},purifyArrowQuote(e,t=" "){e=e.replace(new RegExp(`^(${I}(.*))`,"gim"),b.getQuoteBlock()+t);return e},decodeQuote(e){e=n.cutTags(e);e=e.replace(/-{54}(<br \/>(.*?)\[(.*?)]( #(?:chat\d+|\d+:\d+)\/\d+)?)?<br \/>(.*?)-{54}(<br \/>)?/gs,((e,t,r,s,a,n)=>{const c=!r||!s;if(c&&!n){n=`${s}`}let o="";if(!c){o=i.Tag.render(y||(y=_`
						<div class='bx-im-message-quote__name'>
							<div class="bx-im-message-quote__name-text">${0}</div>
							<div class="bx-im-message-quote__name-time">${0}</div>
						</div>
					`),r,s)}let l="bx-im-message-quote";if(a){a=a.trim().slice(1);a=f.getFinalContextTag(a)}if(a){l+=" --with-context"}else{a="none"}const g=i.Tag.render(M||(M=_`
					<div class='${0}' data-context='${0}'>
						<div class='bx-im-message-quote__wrap'>
							${0}
							<div class='bx-im-message-quote__text'>${0}</div>
						</div>
					</div>
				`),l,a,o,n);return g.outerHTML}));e=n.recoverTags(e);return e},purifyQuote(e,t=" "){return e.replace(/-{54}(.*?)-{54}/gims,b.getQuoteBlock()+t)},decodeCode(e){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code](<br \/>)?/gis,((e,t,r)=>i.Dom.create({tag:"div",attrs:{className:"bx-im-message-content-code"},html:r}).outerHTML))},purifyCode(e,t=" "){return e.replace(/\[code](<br \/>)?([\0-\uFFFF]*?)\[\/code]/gis,b.getCodeBlock()+t)},executeClickEvent(e){if(!e.target.className.startsWith("bx-im-message-quote")&&!(e.target.parentNode&&e.target.parentNode.className.startsWith("bx-im-message-quote"))){return}const t=g().dom.recursiveBackwardNodeSearch(e.target,"--with-context");if(!t||t.dataset.context==="none"){return}const[s,i]=t.dataset.context.split("/");r.EventEmitter.emit(R.dialog.goToMessageContext,{messageId:Number.parseInt(i,10),dialogId:s.toString()})}};const L={decodeLink(e){return e.replaceAll(/>((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+[^<])?)<\/a>/gi,((e,t)=>{const r=i.Text.decode(t);if(!/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i.test(r)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}if(!g().text.checkUrl(r)){return e}const s=i.Dom.create({tag:"span",attrs:{className:"bx-im-message-image"},children:[i.Dom.create({tag:"img",attrs:{className:"bx-im-message-image-source",src:r},events:{error(){L.hideErrorImage(this)}}})]}).outerHTML;return`>${s}</a>`}))},purifyLink(e){e=e.replace(/(.)?((https|http):\/\/(\S+)\.(jpg|jpeg|png|gif|webp)(\?\S+)?)/gi,(function(e,t,r){if(t&&![">","]"," "].includes(t)||!r.match(/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}else{return(t?t:"")+b.getImageBlock()}}));return e},decodeIcon(e){let t=0;const r=m();if(r){t=e.replaceAll(/\[icon=([^\]]*)]/gi,"").trim().length}return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let s=e.match(/icon=(\S+[^\s!"'),.;>?\]])/i);if(s&&s[1]){s=s[1]}else{return""}if(!g().text.checkUrl(s)){return e}const a={src:s,border:0};const n=e.match(/size=(\d+)/i);if(n&&n[1]){a.width=n[1];a.height=n[1]}else{const t=e.match(/width=(\d+)/i);if(t&&t[1]){a.width=t[1]}const r=e.match(/height=(\d+)/i);if(r&&r[1]){a.height=r[1]}if(a.width&&!a.height){a.height=a.width}else if(a.height&&!a.width){a.width=a.height}else if(a.height&&a.width);else{a.width=20;a.height=20}}a.width=a.width>100?100:a.width;a.height=a.height>100?100:a.height;if(r&&t===0&&a.width===a.height&&a.width===20){a.width=40;a.height=40}let c=e.match(/title=(.*[^\s\]])/i);if(c&&c[1]){c=c[1];if(c.includes("width=")){c=c.slice(0,Math.max(0,c.indexOf("width=")))}if(c.includes("height=")){c=c.slice(0,Math.max(0,c.indexOf("height=")))}if(c.includes("size=")){c=c.slice(0,Math.max(0,c.indexOf("size=")))}if(c){a.title=i.Text.decode(c).trim();a.alt=a.title}}return i.Dom.create({tag:"img",attrs:{className:"bx-smile bx-icon",...a}}).outerHTML}))},purifyIcon(e){return e.replaceAll(/\[icon=([^\]]*)]/gi,(e=>{let t=e.match(/title=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.includes("width=")){t=t.slice(0,Math.max(0,t.indexOf("width=")))}if(t.includes("height=")){t=t.slice(0,Math.max(0,t.indexOf("height=")))}if(t.includes("size=")){t=t.slice(0,Math.max(0,t.indexOf("size=")))}if(t){t=`(${t.trim()})`}}else{t=`(${i.Loc.getMessage("IM_PARSER_IMAGE_ICON")})`}return t}))},hideErrorImage(e){const t=e;if(t&&t.parentNode){t.parentNode.innerHTML=`<a href="${encodeURI(e.src)}" target="_blank">${e.src}</a>`}}};let N=e=>e,v;const A=Object.freeze({Default:1,Big:1.6});const C=(e,t,r=A)=>{const s=e.replaceAll(new RegExp(t,"g"),"");const i=s.trim().length===0;const a=new RegExp(`(?:(?:${t})\\s*){4,}`);if(i&&!a.test(e)){return r.Big}return r.Default};const P=e=>{const t=e.reduce(((e,t)=>{const{image:r,typing:s,definition:a,name:n,width:c,height:o}=t;const l=i.Tag.render(v||(v=N`
			<img
				src="${0}"
				data-code="${0}"
				data-definition="${0}"
				title="${0}"
				alt="${0}"
				class="bx-smile bx-im-message-base__text_smile"
				style="width: ${0}px; height: ${0}px;"
				draggable="false"
			/>
		`),r,s,a,n!=null?n:s,s,c,o);return{...e,[s]:l}}),{});return t};const $=function(e,t,r){const s=e.slice(0,r+t.length);const i=g().text.escapeRegex(t);const a=new RegExp(`(?:^|&quot;|>|(?:${this.pattern})|\\s|<)(?:${i})$`);return s.match(a)};const w={typings:null,pattern:"",loadSmilePatterns(){var e,t;if(!u()){return}const r=u().getInstance();const s=(e=(t=r.smileList)==null?void 0:t.smiles)!=null?e:[];if(s.length===0){return}const i=[...s].sort(((e,t)=>t.typing.localeCompare(e.typing)));this.pattern=i.map((e=>g().text.escapeRegex(e.typing))).join("|");this.typings=P(i)},decodeSmile(e,t={}){if(!this.typings){this.loadSmilePatterns()}if(!this.pattern){return e}let r;if(i.Type.isBoolean(t.enableBigSmile)){r=t.enableBigSmile}else{r=m()}const s=i.Type.isObjectLike(t.ratioConfig)?t.ratioConfig:A;const a=r?C(e,this.pattern,s):s.Default;const n=`(?:(?:${this.pattern})(?=(?:(?:${this.pattern})|\\s|&quot;|<|$)))`;const c=new RegExp(n,"g");const o=e.replaceAll(c,((t,r)=>{const s=$.call(this,e,t,r);if(!s){return t}const n=this.typings[t].cloneNode();const{width:c,height:o}=n.style;i.Dom.style(n,"width",`${Number.parseInt(c,10)*a}px`);i.Dom.style(n,"height",`${Number.parseInt(o,10)*a}px`);return n.outerHTML}));return o}};const F={decode(e,t={}){const{urlTarget:r="_blank",removeLinks:s=false}=t;e=e.replace(/\[url(?:=([^[\]]+))?](.*?)\[\/url]/gis,((e,t,s)=>{const a=i.Text.decode(t||s);if(!g().text.checkUrl(a)){return s}return i.Dom.create({tag:"a",attrs:{href:a,target:r},html:s}).outerHTML}));e=e.replace(/\[url(?:=(.+?[^[\]]))?](.*?)\[\/url]/gis,((e,t,s)=>{let a=i.Text.decode(t||s);if(!g().text.checkUrl(a)){return s}if(!a.slice(a.lastIndexOf("[")).includes("]")){if(s.startsWith("]")){a=`${a}]`;s=s.slice(1)}else if(s.startsWith("=")){const e=i.Text.decode(s.slice(1,s.lastIndexOf("]")));a=`${a}]=${e}`;s=s.slice(s.lastIndexOf("]")+1)}}return i.Dom.create({tag:"a",attrs:{href:a,target:r},html:s}).outerHTML}));if(s){e=e.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}return e},purify(e){e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));e=e.replace(/\[url(?:=(.+))?](.*?)\[\/url]/gis,((e,t,r)=>r?r:t));return e},removeSimpleUrlTag(e){e=e.replace(/\[url](.*?)\[\/url]/gis,((e,t)=>t));return e}};const D={decode(e){e=f.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>"<b>"+t+"</b>"));e=f.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>"<u>"+t+"</u>"));e=f.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>"<i>"+t+"</i>"));e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>"<s>"+t+"</s>"));e=f.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>{t=Number.parseInt(t,10);if(t<=8){t=8}else if(t>=30){t=30}return i.Dom.create({tag:"span",style:{fontSize:`${t}px`},html:r}).outerHTML}));e=f.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>i.Dom.create({tag:"span",style:{color:"#"+t},html:r}).outerHTML));return e},purify(e,t=true){if(t){e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,(()=>" "))}e=f.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,t)=>t));e=f.recursiveReplace(e,/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>r));e=f.recursiveReplace(e,/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>r));return e}};let B=e=>e,k;const O={decode(e){let t=e;t=t.replaceAll(/\[like]/gi,`<span class="bx-im-lines-vote-like" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE")}"></span>`);t=t.replaceAll(/\[dislike]/gi,`<span class="bx-im-lines-vote-dislike" title="${i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE")}"></span>`);t=t.replaceAll(/\[rating=([1-5])]/gi,((e,t)=>{const r=i.Tag.render(k||(k=B`
				<span class="bx-im-lines-rating" title="${0} - ${0}">
					<span class="bx-im-lines-rating-selected" style="width: ${0}%"></span>
				</span>
			`),i.Loc.getMessage("IM_PARSER_LINES_RATING"),t,t*20);return r.outerHTML}));return t},purify(e){let t=e;t=t.replaceAll(/\[like]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_LIKE"));t=t.replaceAll(/\[dislike]/gi,i.Loc.getMessage("IM_PARSER_LINES_RATING_DISLIKE"));t=t.replaceAll(/\[rating=([1-5])]/gi,(()=>`[${i.Loc.getMessage("IM_PARSER_LINES_RATING")}] `));return t}};const{EventType:U}=p();const j="\\d{4}-\\d{2}-\\d{2}T[0-2]\\d:[0-5]\\d:[0-5]\\d[+-][0-2]\\d:[0-5]\\d";const H={put:"put",send:"send"};const X={decodePut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\/\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("put",r,t)}))));return e},purifyPut(e){e=e.replace(/\[PUT(?:=(?:.+?))?](?:.+?)?\[\/PUT]/gi,(e=>e.replace(/\[PUT(?:=(.+))?](.+?)?\[\/PUT]/gi,((e,t,r)=>r?r:t))));return e},decodeSend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>{r=r?r:t;t=t?t:r;r=i.Text.decode(r);t=i.Text.decode(t).replace("<br />","\n");if(!r.trim()){return""}r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);t=t.split("####REPLACEMENT_PUT_").join("####REPLACEMENT_SP_");return this._getHtmlForAction("send",r,t)}))));return e},purifySend(e){e=e.replace(/\[SEND(?:=(?:.+?))?](?:.+?)?\[\/SEND]/gi,(e=>e.replace(/\[SEND(?:=(.+))?](.+?)?\[\/SEND]/gi,((e,t,r)=>r?r:t))));return e},decodeDate(e){e=e.replace(RegExp("\\[DATE=("+j+")](.+?)\\[\\/DATE]","ig"),((e,t,r)=>{r=r.replace(/<(\w+)[^>]*>(.*?)<\\1>/i,"$2",r);r=r.replace(/\[(\w+)[^\]]*](.*?)\[\/\1]/i,"$2",r);return this._getHtmlForAction("date",r,t)}));return e},purifyDate(e){const t=g().date.atomRegexpString;e=e.replace(RegExp("[DATE=("+t+")](.+?)[/DATE]","ig"),((e,t,r)=>r));return e},_getHtmlForAction(e,t,r){return i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-wrap"},children:[i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command","data-entity":e},text:t}),i.Dom.create({tag:"span",attrs:{className:"bx-im-message-command-data"},text:r})]}).outerHTML},executeClickEvent(e){if(!i.Dom.hasClass(e.target,"bx-im-message-command")){return}const t=e.target;if(t.dataset.entity===H.put){const{innerText:e=""}=t.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}r.EventEmitter.emit(U.textarea.insertText,{text:e})}else if(t.dataset.entity===H.send){const{innerText:e=""}=t.parentElement.querySelector(".bx-im-message-command-data");if(!e){return}r.EventEmitter.emit(U.textarea.sendMessage,{text:e})}}};const{MessageMentionType:q}=p();const Q={decode(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>{if(!r){return e}let s="";if(t){s=t}else if(g.call.isNumber(r)){s=r}else{return e}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":q.call,"data-destination":s},text:i.Text.decode(r)}).outerHTML}));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>""));return t},purify(e){let t=e;t=t.replaceAll(/\[call(?:=([\d #()+./-]+))?](.+?)\[\/call]/gi,((e,t,r)=>r||t));t=t.replaceAll(/\[pch=(\d+)](.*?)\[\/pch]/gi,((e,t,r)=>r));return t}};const{EventType:W,MessageMentionType:z}=p();const G={decode(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}if(r||!s){const e=l().getStore().getters["users/get"](t);if(e){s=e.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}let a="bx-im-mention";if(l().getUserId()===t){a+=" --highlight"}return i.Dom.create({tag:"span",attrs:{className:a,"data-type":z.user,"data-value":t},text:s}).outerHTML}));e=e.replace(/\[chat=(imol\|)?(\d+)](.*?)\[\/chat]/gi,((e,t,r,s)=>{if(r===0){return s}let a=s;if(a){a=i.Text.decode(a)}else{const e=l().store.getters["chats/get"](`chat${r}`);a=e?e.name:`Chat ${r}`}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":t?z.lines:z.chat,"data-value":t?`imol|${r}`:`chat${r}`},text:a}).outerHTML}));e=e.replace(/\[context=((?:chat\d+|\d+:\d+)\/(\d+))](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){return""}s=i.Text.decode(s);t=f.getFinalContextTag(t);if(!t){return s}const a=t.split("/")[0];let n="";r=Number.parseInt(r,10);if(i.Type.isNumber(r)&&r>0){const e=l().store.getters["messages/getById"](r);if(e){n=V.purifyMessage(e);const t=l().store.getters["users/get"](e.authorId);if(t){n=`${t.name}: ${n}`}}}if(!i.Type.isStringFilled(n)){n=i.Loc.getMessage("IM_PARSER_MENTION_DIALOG")}return i.Dom.create({tag:"span",attrs:{className:"bx-im-mention","data-type":z.context,"data-dialog-id":a,"data-message-id":r,title:n},text:s}).outerHTML}));return e},purify(e){e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER]/gi,((e,t,r,s)=>{t=Number.parseInt(t,10);if(!i.Type.isNumber(t)||t===0){return s}if(r||!s){const e=l().getStore().getters["users/get"](t);if(e){s=e.name}}else{s=i.Text.decode(s)}if(!s){s=`User ${t}`}return s}));e=e.replace(/\[CHAT=(imol\|)?(\d+)](.*?)\[\/CHAT]/gi,((e,t,r,s)=>{r=Number.parseInt(r,10);if(!s){const e=l().store.getters["chats/get"]("chat"+r);s=e?e.name:"Chat "+r}return s}));e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,t,r,s)=>{if(!s){const e=l().store.getters["chats/get"](t);s=e?e.name:"Dialog "+t}return s}));return e},executeClickEvent(e){if(!i.Dom.hasClass(e.target,"bx-im-mention")){return}if(e.target.dataset.type===z.user||e.target.dataset.type===z.chat){void s.Messenger.openChat(e.target.dataset.value)}else if(e.target.dataset.type===z.lines){const t=e.target.dataset.value;if(g().dialog.isLinesHistoryId(t)){void s.Messenger.openLinesHistory(t)}else if(g().dialog.isLinesExternalId(t)){void s.Messenger.openLines(t)}}else if(e.target.dataset.type===z.context){r.EventEmitter.emit(W.dialog.goToMessageContext,{messageId:Number.parseInt(e.target.dataset.messageId,10),dialogId:e.target.dataset.dialogId.toString()})}else if(e.target.dataset.type===z.call){if(g().call.isNumber(e.target.dataset.destination)){void s.Messenger.startPhoneCall(e.target.dataset.destination)}}}};const Y={decodeNewLine(e){e=e.replace(/\n/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");return e},purifyNewLine(e,t=" "){if(t!=="\n"){e=e.replace(/\n/gi,t)}e=e.replace(/\[BR]/gi,t);return e},purifyBreakLine(e,t=" "){e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[BR]/gi,"<br />");e=e.replace(/<br \/>/gi,t);return e},decodeTabulation(e){e=e.replace(/( ){4}/gi,"\t");e=e.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");return e},purifyTabulation(e){e=e.replace(/&nbsp;&nbsp;&nbsp;&nbsp;/gi," ");return e},purifyNbsp(e){e=e.replace(/&nbsp;/gi," ");return e},removeDuplicateTags(e){if(e.substr(-6)==="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");return e}};const{FileIconType:K}=p();const J={decode(e){const t=b.getIcon(K.file);let r;if(t){r=`${t} ${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}`}else{r=`[${i.Loc.getMessage("IM_PARSER_ICON_TYPE_FILE")}]`}e=e.replace(/\[disk=\d+]/gi,r);return e},purify(e){return this.decode(e)}};const V={decodeMessage(e){const t=l().store.getters["messages/getMessageFiles"](e.id);return this.decode({text:e.text,attach:e.attach,files:t,replaces:e.replaces,showIconIfEmptyText:false})},decodeNotification(e){var r;return this.decode({text:e.text,attach:(r=e.params.attach)!=null?r:false,replaces:e.replaces,showIconIfEmptyText:false,showImageFromLink:false,urlTarget:t.DesktopApi.isDesktop()?"_blank":"_self"})},decodeText(e){return this.decode({text:e})},decodeHtml(e){return this.decode({text:e})},decodeSmile(e,t){return w.decodeSmile(e,t)},decodeSmileForLegacyCore(e,t){const r={...t};r.ratioConfig=Object.freeze({Default:1,Big:1.6});return w.decodeSmile(e,r)},decode(e){if(!i.Type.isPlainObject(e)){d().error("Parser.decode: the first parameter must be object",e);return'<b style="color:red">Parser.decode: the first parameter must be a parameter object</b'}let{text:t}=e;const{attach:r=false,files:s=false,removeLinks:c=false,showIconIfEmptyText:o=true,showImageFromLink:l=true,urlTarget:g="_blank"}=e;if(!i.Type.isString(t)){if(i.Type.isNumber(t)){return t.toString()}return""}if(!t){if(o){t=b.addIconToShortText({text:t,attach:r,files:s})}return t.trim()}t=i.Text.encode(t.trim());t=Y.decodeNewLine(t);t=Y.decodeTabulation(t);t=n.cutPutTag(t);t=n.cutSendTag(t);t=n.cutCodeTag(t);t=w.decodeSmile(t);t=a.decode(t);t=F.decode(t,{urlTarget:g,removeLinks:c});t=D.decode(t);t=O.decode(t);t=G.decode(t);t=Q.decode(t);t=L.decodeIcon(t);if(l){t=L.decodeLink(t)}t=J.decode(t);t=X.decodeDate(t);t=S.decodeArrowQuote(t);t=S.decodeQuote(t);t=n.recoverSendTag(t);t=X.decodeSend(t);t=n.recoverPutTag(t);t=X.decodePut(t);t=n.recoverCodeTag(t);t=S.decodeCode(t);t=n.recoverRecursionTag(t);t=Y.removeDuplicateTags(t);n.clean();return t},purifyMessage(e){const t=l().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:e.attach,files:t})},purifyNotification(e){var t;const r=l().store.getters["messages/getMessageFiles"](e.id);return this.purify({text:e.text,attach:(t=e.params.attach)!=null?t:false,files:r})},purifyRecent(e){const t=i.Extension.getSettings("im.v2.lib.parser");const r=t.get("v2");if(!r){const{files:t,attach:r,text:s}=this.prepareLegacyConfigForRecent(e);return this.purify({text:s,attach:r,files:t,showPhraseMessageWasDeleted:e.message.id!==0})}const{files:s,attach:a,text:n}=this.prepareConfigForRecent(e);return this.purify({text:n,attach:a,files:s,showPhraseMessageWasDeleted:e.messageId!==0})},purifyText(e){return this.purify({text:e})},purify(e){if(!i.Type.isPlainObject(e)){d().error("Parser.purify: the first parameter must be a object",e);return"Parser.purify: the first parameter must be a parameter object"}let{text:t}=e;const{attach:r=false,files:s=false,showPhraseMessageWasDeleted:n=true}=e;if(!i.Type.isString(t)){t=i.Type.isNumber(t)?t.toString():""}if(!t){t=b.addIconToShortText({text:t,attach:r,files:s});return t.trim()}t=i.Text.encode(t.trim());t=Y.purifyNewLine(t,"\n");t=a.purify(t);t=S.purifyArrowQuote(t);t=S.purifyQuote(t);t=S.purifyCode(t);t=X.purifyPut(t);t=X.purifySend(t);t=G.purify(t);t=D.purify(t);t=O.purify(t);t=Q.purify(t);t=F.purify(t);t=L.purifyLink(t);t=L.purifyIcon(t);t=J.purify(t);t=Y.purifyNewLine(t);t=b.addIconToShortText({text:t,attach:r,files:s});if(t.length>0){t=i.Text.decode(t)}else if(n){t=i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED")}return t.trim()},prepareQuote(e,t=""){const{id:r,attach:s}=e;let a=t===""?e.text:t;const n=l().store.getters["messages/getMessageFiles"](r);a=i.Text.encode(a.trim());a=G.purify(a);a=Q.purify(a);a=O.purify(a);a=Y.purifyBreakLine(a,"\n");a=Y.purifyNbsp(a);a=F.removeSimpleUrlTag(a);a=S.purifyCode(a," ");a=S.purifyQuote(a," ");a=S.purifyArrowQuote(a," ");if(t===""){a=b.addIconToShortText({text:a,attach:s,files:n})}a=a.length>0?i.Text.decode(a):i.Loc.getMessage("IM_PARSER_MESSAGE_DELETED");return a.trim()},prepareEdit(e){let{text:t}=e;t=F.removeSimpleUrlTag(t);t=G.purify(t);return t.trim()},prepareCopy(e){let{text:t}=e;t=F.removeSimpleUrlTag(t);return t.trim()},prepareCopyFile(e){const{id:t}=e;const r=l().store.getters["messages/getMessageFiles"](t).map((e=>`[DISK=${e.id}]\n`));return r.join("\n").trim()},prepareConfigForRecent(e){let t=l().store.getters["messages/getMessageFiles"](e.messageId);if(t.length===0){t=false}const r=l().store.getters["recent/getMessage"](e.dialogId);let s=false;if(i.Type.isBoolean(r==null?void 0:r.attach)||i.Type.isStringFilled(r==null?void 0:r.attach)||i.Type.isArray(r==null?void 0:r.attach)){s=r.attach}else if(i.Type.isPlainObject(r==null?void 0:r.attach)){s=[r.attach]}return{files:t,attach:s,text:r.text}},prepareLegacyConfigForRecent(e){let t=false;const r=e.message.params.withFile;if(i.Type.isBoolean(r)){t=r}else if(i.Type.isPlainObject(r)){t=[r]}let s=false;const a=e.message.params.withAttach;if(i.Type.isBoolean(a)||i.Type.isStringFilled(a)||i.Type.isArray(a)){s=a}else if(i.Type.isPlainObject(a)){s=[a]}return{files:t,attach:s,text:e.message.text}},executeClickEvent(e){G.executeClickEvent(e);S.executeClickEvent(e);X.executeClickEvent(e)},getContextCodeFromForwardId(e){return f.getFinalContextTag(e)}};e.Parser=V})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX.Event,BX.Messenger.v2.Lib,BX);
//# sourceMappingURL=parser.bundle.map.js