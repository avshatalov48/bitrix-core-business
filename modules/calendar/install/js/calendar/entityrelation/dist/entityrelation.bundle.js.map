{"version":3,"file":"entityrelation.bundle.js","sources":["../src/interface/bar.js","../src/api/client.js","../src/collection/relation-collection.js","../src/interface/relation-interface.js"],"sourcesContent":["import type { RelationData } from '../type/data';\nimport type { BarOptions } from '../type/constructor-options';\nimport { Tag, Dom, Loc, Event, Text } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { Loader } from 'main.loader';\nimport { Messenger } from 'im.public';\n\nexport default class Bar\n{\n\tconstructor(options: BarOptions)\n\t{\n\t\tthis.parentNode = options.parentNode;\n\t\tthis.init();\n\t}\n\n\tinit(): void\n\t{\n\t\tthis.bar = Tag.render`\n\t\t\t<div class=\"calendar-relation-bar\">\n\t\t\t</div>\n\t\t`;\n\t\tEvent.bind(this.bar, 'mouseenter', () => {\n\t\t\tEventEmitter.emit('BX.Calendar.EntityRelation.onMouseEnter');\n\t\t});\n\t}\n\n\trenderLoader(): HTMLElement\n\t{\n\t\tDom.clean(this.bar);\n\t\tif (!this.loaderWrap)\n\t\t{\n\t\t\tthis.loaderWrap = Tag.render`<div class=\"calendar-relation-bar-loader\"></div>`;\n\t\t}\n\t\tDom.append(this.loaderWrap, this.bar);\n\t\tthis.showLoader();\n\n\t\treturn this.bar;\n\t}\n\n\tshowLoader(): void\n\t{\n\t\tif (this.loader)\n\t\t{\n\t\t\tthis.loader.destroy();\n\t\t}\n\n\t\tthis.loader = new Loader({\n\t\t\ttarget: this.loaderWrap,\n\t\t\tsize: 22,\n\t\t\tcolor: '#2066B0',\n\t\t\toffset: {\n\t\t\t\tleft: '0px',\n\t\t\t\ttop: '0px',\n\t\t\t},\n\t\t\tmode: 'inline',\n\t\t});\n\t\tthis.loader.show();\n\t}\n\n\trender(relationData: RelationData): HTMLElement\n\t{\n\t\tDom.clean(this.bar);\n\t\tDom.append(this.getEntityLink(relationData), this.bar);\n\t\tDom.append(this.getOwnerData(relationData), this.bar);\n\n\t\treturn this.bar;\n\t}\n\n\tgetEntityLink(relationData: RelationData): HTMLElement\n\t{\n\t\treturn Tag.render`\n\t\t\t<a\n\t\t\t\tclass=\"calendar-relation-entity-link\"\n\t\t\t\thref=\"${relationData.entity.link}\"\n\t\t\t\ttitle=\"${Loc.getMessage('CALENDAR_RELATION_OPEN_ENTITY_HINT_DEAL')}\"\n\t\t\t>\n\t\t\t\t<div class=\"calendar-relation-entity-link-text\">\n\t\t\t\t\t${Loc.getMessage('CALENDAR_RELATION_ENTITY_LINK_DEAL')}\n\t\t\t\t</div>\n\t\t\t\t<div class=\"calendar-relation-entity-link-arrow\"></div>\n\t\t\t</a>\n\t\t`;\n\t}\n\n\tgetOwnerData(relationData: RelationData): HTMLElement\n\t{\n\t\tconst { root, chatButton } = Tag.render`\n\t\t\t<div class=\"calendar-relation-owner\">\n\t\t\t\t<div class=\"calendar-relation-owner-role\">${Loc.getMessage('CALENDAR_RELATION_OWNER_ROLE_DEAL')}</div>\n\t\t\t\t<div class=\"calendar-relation-owner-info\">\n\t\t\t\t\t${this.getOwnerAvatarNode(relationData)}\n\t\t\t\t\t${this.getOwnerNameNode(relationData)}\n\t\t\t\t\t<div\n\t\t\t\t\t\tref=\"chatButton\"\n\t\t\t\t\t\tclass=\"calendar-relation-owner-chat\"\n\t\t\t\t\t\ttitle=\"${Loc.getMessage('CALENDAR_RELATION_CHAT_BUTTON_HINT')}\"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t`;\n\n\t\tEvent.bind(chatButton, 'click', () => this.openChat(relationData.owner.id));\n\n\t\treturn root;\n\t}\n\n\tgetOwnerAvatarNode(relationData: RelationData): HTMLElement\n\t{\n\t\tconst avatarWrap = Tag.render`\n\t\t\t<a\n\t\t\t\thref=\"${relationData.owner.link}\"\n\t\t\t\tclass=\"calendar-relation-owner-avatar ui-icon ui-icon-common-user\"\n\t\t\t\ttitle=\"${Loc.getMessage('CALENDAR_RELATION_OWNER_PROFILE_HINT')}\"\n\t\t\t>\n\t\t\t</a>\n\t\t`;\n\n\t\tlet avatar = null;\n\n\t\tif (relationData.owner.avatar)\n\t\t{\n\t\t\tavatar = Tag.render`\n\t\t\t\t<img\n\t\t\t\t\tsrc=\"${encodeURI(relationData.owner.avatar)}\"\n\t\t\t\t\talt=\"\"\n\t\t\t\t/>\n\t\t\t`;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tavatar = Tag.render`\n\t\t\t\t<i></i>\n\t\t\t`;\n\t\t}\n\n\t\tDom.append(avatar, avatarWrap);\n\n\t\treturn avatarWrap;\n\t}\n\n\tgetOwnerNameNode(relationData: RelationData): HTMLElement\n\t{\n\t\treturn Tag.render`\n\t\t\t<a\n\t\t\t\tclass=\"calendar-relation-owner-name\"\n\t\t\t\thref=\"${relationData.owner.link}\"\n\t\t\t\ttitle=\"${Loc.getMessage('CALENDAR_RELATION_OWNER_PROFILE_HINT')}\"\n\t\t\t>\n\t\t\t\t${relationData.owner.name}\n\t\t\t</a>\n\t\t`;\n\t}\n\n\topenChat(chatId: number)\n\t{\n\t\tMessenger.openChat(chatId);\n\t}\n}\n","import { ajax, Type } from 'main.core';\n\nexport default class Client\n{\n\tstatic async getRelationData(eventId: number | null): Promise\n\t{\n\t\tif (Type.isNil(eventId))\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst action = 'calendar.api.calendarentryajax.getEventEntityRelation';\n\t\tconst data = { eventId };\n\t\tconst response = await ajax.runAction(action, { data }).then(\n\t\t\t(ajaxResponse) => {\n\t\t\t\treturn ajaxResponse;\n\t\t\t},\n\t\t\t() => {\n\t\t\t\treturn null;\n\t\t\t},\n\t\t);\n\n\t\treturn response?.data || false;\n\t}\n}\n","import type { RelationData } from '../type/data';\n\nexport default class RelationCollection\n{\n\tstatic map = new Map();\n\n\tstatic getRelation(eventId: number): RelationData | false\n\t{\n\t\treturn RelationCollection.map.get(eventId) ?? false;\n\t}\n\n\tstatic setRelation(relationData: RelationData): void\n\t{\n\t\tRelationCollection.map.set(relationData.eventId, relationData);\n\t}\n}\n","import Bar from './bar';\nimport { Dom, Type } from 'main.core';\nimport Client from '../api/client';\nimport RelationCollection from '../collection/relation-collection';\n\nimport type { InterfaceOptions } from '../type/constructor-options';\n\nexport default class RelationInterface\n{\n\tconstructor(options: InterfaceOptions)\n\t{\n\t\tthis.bar = new Bar({ parentNode: options.parentNode });\n\n\t\tthis.eventId = options.eventId ?? null;\n\t\tthis.relationData = RelationCollection.getRelation(this.eventId) || null;\n\t\tthis.layout = null;\n\t}\n\n\trender(): HTMLElement | null\n\t{\n\t\tif (Type.isNil(this.relationData))\n\t\t{\n\t\t\tthis.layout = this.bar.renderLoader();\n\t\t\tthis.showLazy();\n\t\t}\n\t\telse if (this.relationData)\n\t\t{\n\t\t\tthis.layout = this.bar.render(this.relationData);\n\t\t}\n\n\t\treturn this.layout;\n\t}\n\n\tasync showLazy()\n\t{\n\t\tthis.relationData = await Client.getRelationData(this.eventId);\n\n\t\tif (this.relationData)\n\t\t{\n\t\t\tRelationCollection.setRelation(this.relationData);\n\n\t\t\tconst barLayout = this.bar.render(this.relationData);\n\t\t\tDom.replace(this.layout, barLayout);\n\t\t\tthis.layout = barLayout;\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.destroy();\n\t\t}\n\t}\n\n\tdestroy(): void\n\t{\n\t\tDom.remove(this.layout);\n\t\tthis.layout = null;\n\t}\n}\n"],"names":["Bar","constructor","options","parentNode","init","bar","Tag","render","Event","bind","EventEmitter","emit","renderLoader","Dom","clean","loaderWrap","append","showLoader","loader","destroy","Loader","target","size","color","offset","left","top","mode","show","relationData","getEntityLink","getOwnerData","entity","link","Loc","getMessage","root","chatButton","getOwnerAvatarNode","getOwnerNameNode","openChat","owner","id","avatarWrap","avatar","encodeURI","name","chatId","Messenger","Client","getRelationData","eventId","Type","isNil","action","data","response","ajax","runAction","then","ajaxResponse","RelationCollection","getRelation","map","get","setRelation","set","Map","RelationInterface","layout","showLazy","barLayout","replace","remove"],"mappings":"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"}