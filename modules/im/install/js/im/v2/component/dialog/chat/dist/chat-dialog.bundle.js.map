{"version":3,"file":"chat-dialog.bundle.js","sources":["../src/classes/scroll-manager.js","../src/classes/pull-watch-manager.js","../src/classes/visible-messages-manager.js","../src/components/pinned/pinned-message.js","../src/components/pinned/pinned-messages.js","../src/components/quote-button.js","../src/components/scroll-button.js","../src/chat-dialog.js"],"sourcesContent":["import { EventEmitter } from 'main.core.events';\n\nimport { Logger } from 'im.v2.lib.logger';\nimport { Animation } from 'im.v2.lib.animation';\n\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.Dialog.ScrollManager';\n\nexport class ScrollManager extends EventEmitter\n{\n\tcontainer: HTMLElement;\n\tisScrolling: boolean = false;\n\tcurrentScroll: number = 0;\n\tlastScroll: number = 0;\n\tchatIsScrolledUp: boolean = false;\n\tscrollButtonClicked: boolean = false;\n\tstartScrollNeeded: boolean = true;\n\n\tstatic events = {\n\t\tonScrollTriggerUp: 'onScrollTriggerUp',\n\t\tonScrollTriggerDown: 'onScrollTriggerDown',\n\t\tonScrollThresholdPass: 'onScrollThresholdPass',\n\t};\n\n\tstatic scrollPosition = {\n\t\tmessageTop: 'messageTop',\n\t\tmessageBottom: 'messageBottom',\n\t};\n\n\tconstructor(): ScrollManager\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\t}\n\n\tsetContainer(container: HTMLElement)\n\t{\n\t\tthis.container = container;\n\t}\n\n\tonScroll(event: Event)\n\t{\n\t\tif (this.isScrolling || !event.target)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.currentScroll = event.target.scrollTop;\n\t\tconst isScrollingDown = this.lastScroll < this.currentScroll;\n\t\tconst isScrollingUp = !isScrollingDown;\n\t\tif (isScrollingUp)\n\t\t{\n\t\t\tthis.scrollButtonClicked = false;\n\t\t}\n\n\t\tconst SCROLLING_THRESHOLD = 1500;\n\t\tconst leftSpaceBottom = event.target.scrollHeight - event.target.scrollTop - event.target.clientHeight;\n\t\tif (isScrollingDown && this.isStartScrollCompleted() && leftSpaceBottom < SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerDown);\n\t\t}\n\t\telse if (isScrollingUp && this.currentScroll <= SCROLLING_THRESHOLD)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollTriggerUp);\n\t\t}\n\n\t\tthis.lastScroll = this.currentScroll;\n\n\t\tthis.checkIfChatIsScrolledUp();\n\t}\n\n\tcheckIfChatIsScrolledUp()\n\t{\n\t\tconst SCROLLED_UP_THRESHOLD = 400;\n\n\t\tconst availableScrollHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newFlag = this.currentScroll + SCROLLED_UP_THRESHOLD < availableScrollHeight;\n\t\tif (newFlag !== this.chatIsScrolledUp)\n\t\t{\n\t\t\tthis.emit(ScrollManager.events.onScrollThresholdPass, newFlag);\n\t\t}\n\t\tthis.chatIsScrolledUp = newFlag;\n\t}\n\n\tscrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to bottom');\n\t\tthis.forceScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tanimatedScrollToBottom()\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to bottom');\n\t\tthis.animatedScrollTo(this.container.scrollHeight - this.container.clientHeight);\n\t}\n\n\tscrollToMessage(messageId: number, params: { withDateOffset: boolean, position: string } = {})\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\n\t\t\treturn;\n\t\t}\n\n\t\tconst scrollPosition = this.#getScrollPosition(element, params);\n\t\tthis.forceScrollTo(scrollPosition);\n\t}\n\n\tsetStartScrollNeeded(flag: boolean): void\n\t{\n\t\tthis.startScrollNeeded = flag;\n\t}\n\n\tisStartScrollCompleted(): boolean\n\t{\n\t\tif (!this.startScrollNeeded)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn this.lastScroll > 0;\n\t}\n\n\tanimatedScrollToMessage(messageId: number, params: { withDateOffset: boolean, position: string } = {}): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: animated scroll to message - ', messageId);\n\t\tconst element = this.getDomElementById(messageId);\n\t\tif (!element)\n\t\t{\n\t\t\tLogger.warn('Dialog: ScrollManager: message not found - ', messageId);\n\n\t\t\treturn Promise.resolve();\n\t\t}\n\n\t\tconst scrollPosition = this.#getScrollPosition(element, params);\n\n\t\treturn this.animatedScrollTo(scrollPosition);\n\t}\n\n\tforceScrollTo(position: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Force scroll to - ', position);\n\t\tthis.cancelAnimatedScroll();\n\t\tthis.container.scroll({ top: position, behavior: 'instant' });\n\t}\n\n\tadjustScrollOnHistoryAddition(oldContainerHeight: number)\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Adjusting scroll after history addition');\n\t\tconst newContainerHeight = this.container.scrollHeight - this.container.clientHeight;\n\t\tconst newScrollPosition = this.container.scrollTop + newContainerHeight - oldContainerHeight;\n\t\tthis.forceScrollTo(newScrollPosition);\n\t}\n\n\tanimatedScrollTo(position: number): Promise\n\t{\n\t\tLogger.warn('Dialog: ScrollManager: Animated scroll to - ', position);\n\n\t\treturn new Promise((resolve) => {\n\t\t\tAnimation.start({\n\t\t\t\tstart: this.container.scrollTop,\n\t\t\t\tend: position,\n\t\t\t\telement: this.container,\n\t\t\t\telementProperty: 'scrollTop',\n\t\t\t\tcallback: () => {\n\t\t\t\t\tthis.checkIfChatIsScrolledUp();\n\t\t\t\t\tresolve();\n\t\t\t\t},\n\t\t\t});\n\t\t});\n\t}\n\n\tcancelAnimatedScroll()\n\t{\n\t\tif (!this.isScrolling)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tAnimation.cancel();\n\t\tthis.isScrolling = false;\n\t}\n\n\tisAtTheTop(): boolean\n\t{\n\t\treturn this.container.scrollTop === 0;\n\t}\n\n\tisAtTheBottom(): boolean\n\t{\n\t\treturn this.container.scrollTop + this.container.clientHeight >= this.container.scrollHeight;\n\t}\n\n\tisAroundBottom(): boolean\n\t{\n\t\tconst POSITION_THRESHOLD = 40;\n\n\t\treturn this.container.scrollHeight - this.container.scrollTop - this.container.clientHeight < POSITION_THRESHOLD;\n\t}\n\n\tgetDomElementById(id: number | string): ?HTMLElement\n\t{\n\t\treturn this.container.querySelector(`[data-id=\"${id}\"]`);\n\t}\n\n\t#getScrollPosition(element: HTMLElement, params: { withDateOffset: boolean, position: string } = {}): number\n\t{\n\t\tconst FLOATING_DATE_OFFSET = 52;\n\t\tconst MESSAGE_BOTTOM_OFFSET = 100;\n\n\t\tconst { withDateOffset = true, position = ScrollManager.scrollPosition.messageTop } = params;\n\t\tconst offset = withDateOffset ? -FLOATING_DATE_OFFSET : -10;\n\n\t\tlet scrollPosition = element.offsetTop + offset;\n\t\tif (position === ScrollManager.scrollPosition.messageBottom)\n\t\t{\n\t\t\tscrollPosition += element.clientHeight - MESSAGE_BOTTOM_OFFSET;\n\t\t}\n\n\t\treturn scrollPosition;\n\t}\n}\n","import { Core } from 'im.v2.application.core';\nimport { UserRole, RestMethod, ChatType } from 'im.v2.const';\nimport { runAction } from 'im.v2.lib.rest';\nimport { ChannelManager } from 'im.v2.lib.channel';\n\nimport type { ImModelChat } from 'im.v2.model';\nimport type { PULL as Pull } from 'pull.client';\n\nconst MESSAGES_TAG_PREFIX = 'IM_PUBLIC_';\nconst COMMENTS_TAG_PREFIX = 'IM_PUBLIC_COMMENT_';\n\nexport class PullWatchManager\n{\n\t#dialog: ImModelChat;\n\t#pullClient: Pull;\n\n\tconstructor(dialogId: string)\n\t{\n\t\tthis.#dialog = Core.getStore().getters['chats/get'](dialogId, true);\n\t\tthis.#pullClient = Core.getPullClient();\n\t}\n\n\tsubscribe()\n\t{\n\t\tif (this.#isChannel())\n\t\t{\n\t\t\tthis.#subscribeChannel();\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#isCommentsChat() || !this.#isGuest())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#subscribeOpenChat();\n\t}\n\n\tunsubscribe()\n\t{\n\t\tthis.#pullClient.clearWatch(`${MESSAGES_TAG_PREFIX}${this.#dialog.chatId}`);\n\t\tthis.#pullClient.clearWatch(`${COMMENTS_TAG_PREFIX}${this.#dialog.chatId}`);\n\t}\n\n\t#subscribeChannel()\n\t{\n\t\tthis.#requestWatchStart();\n\t\tthis.#pullClient.extendWatch(`${MESSAGES_TAG_PREFIX}${this.#dialog.chatId}`);\n\t\tthis.#pullClient.extendWatch(`${COMMENTS_TAG_PREFIX}${this.#dialog.chatId}`);\n\t}\n\n\t#subscribeOpenChat()\n\t{\n\t\tthis.#requestWatchStart();\n\t\tthis.#pullClient.extendWatch(`${MESSAGES_TAG_PREFIX}${this.#dialog.chatId}`);\n\t}\n\n\t#requestWatchStart()\n\t{\n\t\trunAction(RestMethod.imV2ChatExtendPullWatch, {\n\t\t\tdata: {\n\t\t\t\tdialogId: this.#dialog.dialogId,\n\t\t\t},\n\t\t});\n\t}\n\n\t#isGuest(): boolean\n\t{\n\t\treturn this.#dialog?.role === UserRole.guest && this.#dialog?.dialogId !== 'settings';\n\t}\n\n\t#isChannel(): boolean\n\t{\n\t\treturn ChannelManager.isChannel(this.#dialog?.dialogId);\n\t}\n\n\t#isCommentsChat(): boolean\n\t{\n\t\treturn this.#dialog?.type === ChatType.comment;\n\t}\n}\n","export class VisibleMessagesManager\n{\n\t#visibleMessages: Set = new Set();\n\n\tsetMessageAsVisible(messageId: number): void\n\t{\n\t\tthis.#visibleMessages.add(messageId);\n\t}\n\n\tsetMessageAsNotVisible(messageId: number): void\n\t{\n\t\tthis.#visibleMessages.delete(messageId);\n\t}\n\n\tgetVisibleMessages(): number[]\n\t{\n\t\treturn [...this.#visibleMessages];\n\t}\n\n\tgetFirstMessageId(): number\n\t{\n\t\tif (this.#visibleMessages.size === 0)\n\t\t{\n\t\t\treturn 0;\n\t\t}\n\n\t\tconst [firstVisibleMessage] = [...this.#visibleMessages].sort((a, b) => a - b);\n\n\t\treturn firstVisibleMessage;\n\t}\n}\n","import {Parser} from 'im.v2.lib.parser';\n\nimport type {ImModelUser, ImModelMessage} from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessage = {\n\tprops:\n\t{\n\t\tmessage: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tinternalMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.message;\n\t\t},\n\t\ttext(): string\n\t\t{\n\t\t\treturn Parser.purifyMessage(this.internalMessage);\n\t\t},\n\t\tauthorId(): number\n\t\t{\n\t\t\treturn this.internalMessage.authorId;\n\t\t},\n\t\tauthor(): ImModelUser\n\t\t{\n\t\t\treturn this.$store.getters['users/get'](this.authorId);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__pinned_item\">\n\t\t\t<span v-if=\"author\" class=\"bx-im-dialog-chat__pinned_item_user\">{{ author.name }}:</span> {{ text }}\n\t\t</div>\n\t`\n};","import { ChatType, ActionByRole } from 'im.v2.const';\nimport { PermissionManager } from 'im.v2.lib.permission';\n\nimport { PinnedMessage } from './pinned-message';\n\nimport '../../css/pinned-messages.css';\n\nimport type { JsonObject } from 'main.core';\nimport type { ImModelChat, ImModelMessage } from 'im.v2.model';\n\n// @vue/component\nexport const PinnedMessages = {\n\tname: 'PinnedMessages',\n\tcomponents: { PinnedMessage },\n\tprops:\n\t{\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t\tmessages: {\n\t\t\ttype: Array,\n\t\t\trequired: true,\n\t\t},\n\t},\n\temits: ['messageClick', 'messageUnpin'],\n\tdata(): JsonObject\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tdialog(): ImModelChat\n\t\t{\n\t\t\treturn this.$store.getters['chats/get'](this.dialogId, true);\n\t\t},\n\t\tfirstMessage(): ImModelMessage\n\t\t{\n\t\t\treturn this.messagesToShow[0];\n\t\t},\n\t\tmessagesToShow(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.messages.slice(-1);\n\t\t},\n\t\tcanUnpin(): boolean\n\t\t{\n\t\t\treturn PermissionManager.getInstance().canPerformActionByRole(ActionByRole.pinMessage, this.dialogId);\n\t\t},\n\t\tshowUnpin(): boolean\n\t\t{\n\t\t\treturn !this.isCommentChat && this.canUnpin;\n\t\t},\n\t\tisCommentChat(): boolean\n\t\t{\n\t\t\treturn this.dialog.type === ChatType.comment;\n\t\t},\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div @click=\"$emit('messageClick', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_container\">\n\t\t\t<div class=\"bx-im-dialog-chat__pinned_title\">{{ loc('IM_DIALOG_CHAT_PINNED_TITLE') }}</div>\n\t\t\t<PinnedMessage\n\t\t\t\tv-for=\"message in messagesToShow\"\n\t\t\t\t:message=\"message\"\n\t\t\t\t:key=\"message.id\"\n\t\t\t/>\n\t\t\t<div v-if=\"showUnpin\" @click.stop=\"$emit('messageUnpin', firstMessage.id)\" class=\"bx-im-dialog-chat__pinned_unpin\"></div>\n\t\t</div>\n\t`,\n};\n","import { Event } from 'main.core';\n\nimport { Quote } from 'im.v2.lib.quote';\nimport { Utils } from 'im.v2.lib.utils';\nimport { MessengerSlider } from 'im.v2.lib.slider';\n\nimport '../css/quote-button.css';\n\nimport type { JsonObject } from 'main.core';\nimport type { ImModelMessage } from 'im.v2.model';\n\nconst CONTAINER_HEIGHT = 44;\nconst CONTAINER_WIDTH = 60;\nconst CONTAINER_OFFSET = 10;\nconst slider = MessengerSlider.getInstance().getCurrent();\nconst sliderRect = slider?.layout.container.getBoundingClientRect();\nconst offsetY = sliderRect?.top ?? 0;\n\nconst MESSAGE_TEXT_NODE_CLASS = '.bx-im-message-default-content__text';\n\n// @vue/component\nexport const QuoteButton = {\n\tname: 'QuoteButton',\n\tprops: {\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t},\n\tdata(): JsonObject\n\t{\n\t\treturn {\n\t\t\ttext: '',\n\t\t\tmessage: null,\n\t\t\tmouseX: 0,\n\t\t\tmouseY: 0,\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tcontainerStyle(): {top: string, left: string, width: string, height: string}\n\t\t{\n\t\t\treturn {\n\t\t\t\ttop: `${this.mouseY - CONTAINER_HEIGHT - CONTAINER_OFFSET - offsetY}px`,\n\t\t\t\tleft: `${this.mouseX - CONTAINER_WIDTH / 2}px`,\n\t\t\t\twidth: `${CONTAINER_WIDTH}px`,\n\t\t\t\theight: `${CONTAINER_HEIGHT}px`,\n\t\t\t};\n\t\t},\n\t},\n\tmounted()\n\t{\n\t\tEvent.bind(window, 'mousedown', this.onMouseDown);\n\t},\n\tmethods:\n\t{\n\t\tonMessageMouseUp(message: ImModelMessage, event: MouseEvent)\n\t\t{\n\t\t\tif (event.button === 2)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.prepareSelectedText();\n\t\t\tthis.message = message;\n\t\t\tthis.mouseX = event.clientX;\n\t\t\tthis.mouseY = event.clientY;\n\t\t},\n\t\tonMouseDown(event: MouseEvent)\n\t\t{\n\t\t\tconst container = this.$refs.container;\n\t\t\tif (!container || container.contains(event.target))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.$emit('close');\n\t\t},\n\t\tprepareSelectedText(): string\n\t\t{\n\t\t\tif (Utils.browser.isFirefox())\n\t\t\t{\n\t\t\t\tthis.text = window.getSelection().toString();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst range = window.getSelection().getRangeAt(0);\n\t\t\tconst rangeContents = range.cloneContents();\n\t\t\tlet nodesToIterate = rangeContents.childNodes;\n\n\t\t\tconst messageNode = rangeContents.querySelector(MESSAGE_TEXT_NODE_CLASS);\n\t\t\tif (messageNode)\n\t\t\t{\n\t\t\t\tnodesToIterate = messageNode.childNodes;\n\t\t\t}\n\n\t\t\tfor (const node of nodesToIterate)\n\t\t\t{\n\t\t\t\tif (this.isImage(node))\n\t\t\t\t{\n\t\t\t\t\tthis.text += node.getAttribute('data-code') ?? node.getAttribute('alt');\n\t\t\t\t}\n\t\t\t\telse if (this.isLineBreak(node))\n\t\t\t\t{\n\t\t\t\t\tthis.text += '\\n';\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.text += node.textContent;\n\t\t\t\t}\n\t\t\t}\n\t\t},\n\t\tisImage(node: HTMLElement): boolean\n\t\t{\n\t\t\tif (!(node instanceof HTMLElement))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\treturn node.tagName.toLowerCase() === 'img';\n\t\t},\n\t\tisLineBreak(node: HTMLElement): boolean\n\t\t{\n\t\t\treturn node.nodeName.toLowerCase() === 'br';\n\t\t},\n\t\tisText(node: HTMLElement): boolean\n\t\t{\n\t\t\treturn node.nodeName === '#text';\n\t\t},\n\t\tisMessageTextNode(node: HTMLElement): boolean\n\t\t{\n\t\t\tif (!(node instanceof HTMLElement))\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\t\t\tconst textNode = node.matches(MESSAGE_TEXT_NODE_CLASS);\n\n\t\t\treturn Boolean(textNode);\n\t\t},\n\t\textractTextFromMessageNode(node: HTMLElement): string\n\t\t{\n\t\t\tconst textNode = node.querySelector(MESSAGE_TEXT_NODE_CLASS);\n\t\t\tif (!textNode)\n\t\t\t{\n\t\t\t\treturn node.textContent;\n\t\t\t}\n\n\t\t\treturn textNode.textContent;\n\t\t},\n\t\tonQuoteClick()\n\t\t{\n\t\t\tQuote.sendQuoteEvent(this.message, this.text, this.dialogId);\n\t\t\tthis.$emit('close');\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div ref=\"container\" @click=\"onQuoteClick\" :style=\"containerStyle\" class=\"bx-im-dialog-chat__quote-button\">\n\t\t\t<div class=\"bx-im-dialog-chat__quote-icon\"></div>\n\t\t\t<div class=\"bx-im-dialog-chat__quote-icon --hover\"></div>\n\t\t</div>\n\t`,\n};\n","import type { ImModelChat } from 'im.v2.model';\nimport type { JsonObject } from 'main.core';\n\n// @vue/component\nexport const ScrollButton = {\n\tname: 'ScrollButton',\n\tprops:\n\t{\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t},\n\tdata(): JsonObject\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tdialog(): ImModelChat\n\t\t{\n\t\t\treturn this.$store.getters['chats/get'](this.dialogId, true);\n\t\t},\n\t\tformattedCounter(): string\n\t\t{\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\treturn '';\n\t\t\t}\n\n\t\t\tif (this.dialog.counter > 99)\n\t\t\t{\n\t\t\t\treturn '99+';\n\t\t\t}\n\n\t\t\treturn String(this.dialog.counter);\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__scroll-button\">\n\t\t\t<div v-if=\"dialog.counter\" class=\"bx-im-dialog-chat__scroll-button_counter\">\n\t\t\t\t{{ formattedCounter }}\n\t\t\t</div>\n\t\t</div>\n\t`,\n};\n","import { Runtime, Event, Dom } from 'main.core';\nimport { BaseEvent, EventEmitter } from 'main.core.events';\nimport { PopupManager } from 'main.popup';\nimport { PullStatus } from 'pull.vue3.status';\n\nimport { Analytics } from 'im.v2.lib.analytics';\nimport { MessageList } from 'im.v2.component.message-list';\nimport { ForwardPopup } from 'im.v2.component.entity-selector';\nimport { Logger } from 'im.v2.lib.logger';\nimport { CallManager } from 'im.v2.lib.call';\nimport { LayoutManager } from 'im.v2.lib.layout';\nimport { PermissionManager } from 'im.v2.lib.permission';\nimport { AccessManager, AccessErrorCode } from 'im.v2.lib.access';\nimport { FeatureManager } from 'im.v2.lib.feature';\nimport { MessageService, ChatService } from 'im.v2.provider.service';\nimport {\n\tDialogBlockType as BlockType,\n\tEventType,\n\tPopupType,\n\tDialogScrollThreshold,\n\tUserRole,\n\tActionByRole,\n} from 'im.v2.const';\n\nimport { ScrollManager } from './classes/scroll-manager';\nimport { PullWatchManager } from './classes/pull-watch-manager';\nimport { VisibleMessagesManager } from './classes/visible-messages-manager';\nimport { PinnedMessages } from './components/pinned/pinned-messages';\nimport { QuoteButton } from './components/quote-button';\nimport { ScrollButton } from './components/scroll-button';\n\nimport './css/chat-dialog.css';\n\nimport type { BitrixVueComponentProps } from 'ui.vue3';\nimport type { ImModelMessage, ImModelChat, ImModelLayout } from 'im.v2.model';\nimport type { ScrollToBottomEvent } from 'im.v2.const';\n\nexport { ScrollManager } from './classes/scroll-manager';\nexport { PinnedMessages } from './components/pinned/pinned-messages';\n\n// @vue/component\nexport const ChatDialog = {\n\tname: 'ChatDialog',\n\tcomponents: {\n\t\tMessageList,\n\t\tPinnedMessages,\n\t\tQuoteButton,\n\t\tScrollButton,\n\t\tPullStatus,\n\t\tForwardPopup,\n\t},\n\tprops: {\n\t\tdialogId: {\n\t\t\ttype: String,\n\t\t\tdefault: '',\n\t\t},\n\t\tsaveScrollOnExit: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: true,\n\t\t},\n\t\tresetOnExit: {\n\t\t\ttype: Boolean,\n\t\t\tdefault: false,\n\t\t},\n\t},\n\tdata(): Object\n\t{\n\t\treturn {\n\t\t\tforwardPopup: {\n\t\t\t\tshow: false,\n\t\t\t\tmessagesIds: [],\n\t\t\t},\n\t\t\tcontextMode: {\n\t\t\t\tactive: false,\n\t\t\t\tmessageIsLoaded: false,\n\t\t\t},\n\t\t\tisScrolledUp: false,\n\t\t\twindowFocused: false,\n\t\t\tshowQuoteButton: false,\n\t\t\tmessagesToRead: new Set(),\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tlayout(): ImModelLayout\n\t\t{\n\t\t\treturn this.$store.getters['application/getLayout'];\n\t\t},\n\t\tdialog(): ImModelChat\n\t\t{\n\t\t\treturn this.$store.getters['chats/get'](this.dialogId, true);\n\t\t},\n\t\tdialogInited(): boolean\n\t\t{\n\t\t\treturn this.dialog.inited;\n\t\t},\n\t\tmessageCollection(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/getByChatId'](this.dialog.chatId);\n\t\t},\n\t\tpinnedMessages(): ImModelMessage[]\n\t\t{\n\t\t\treturn this.$store.getters['messages/pin/getPinned'](this.dialog.chatId);\n\t\t},\n\t\tisOpened(): boolean\n\t\t{\n\t\t\tconst openedDialogId = this.$store.getters['application/getLayout'].entityId;\n\n\t\t\treturn this.dialogId === openedDialogId;\n\t\t},\n\t\tisGuest(): boolean\n\t\t{\n\t\t\treturn this.dialog.role === UserRole.guest;\n\t\t},\n\t\tdebouncedScrollHandler(): Function\n\t\t{\n\t\t\tconst SCROLLING_DEBOUNCE_DELAY = 100;\n\n\t\t\treturn Runtime.debounce(this.getScrollManager().onScroll, SCROLLING_DEBOUNCE_DELAY, this.getScrollManager());\n\t\t},\n\t\tdebouncedReadHandler(): Function\n\t\t{\n\t\t\tconst READING_DEBOUNCE_DELAY = 50;\n\n\t\t\treturn Runtime.debounce(this.readQueuedMessages, READING_DEBOUNCE_DELAY, this);\n\t\t},\n\t\tmessageListComponent(): BitrixVueComponentProps\n\t\t{\n\t\t\treturn MessageList;\n\t\t},\n\t\tshowScrollButton(): boolean\n\t\t{\n\t\t\treturn this.isScrolledUp || this.dialog.hasNextPage;\n\t\t},\n\t\thasCommentsOnTop(): boolean\n\t\t{\n\t\t\treturn this.$store.getters['messages/comments/areOpenedForChannel'](this.dialogId);\n\t\t},\n\t},\n\twatch:\n\t{\n\t\tdialogInited(newValue: boolean, oldValue: boolean)\n\t\t{\n\t\t\tif (!newValue || oldValue)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// first opening\n\t\t\tthis.getPullWatchManager().subscribe();\n\t\t\tthis.onChatInited();\n\t\t},\n\t\thasCommentsOnTop: {\n\t\t\thandler(newValue: boolean)\n\t\t\t{\n\t\t\t\tconst commentsWereClosed = newValue === false;\n\t\t\t\tif (!commentsWereClosed)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.readVisibleMessages();\n\t\t\t},\n\t\t\tflush: 'post',\n\t\t},\n\t},\n\tcreated()\n\t{\n\t\tLogger.warn('Dialog: Chat created', this.dialogId);\n\t\tthis.initContextMode();\n\t},\n\tmounted()\n\t{\n\t\tthis.getScrollManager().setContainer(this.getContainer());\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\t// second+ opening\n\t\t\tthis.getPullWatchManager().subscribe();\n\t\t\tthis.onChatInited();\n\t\t}\n\t\t// there are P&P messages\n\t\telse if (!this.dialogInited && this.messageCollection.length > 0)\n\t\t{\n\t\t\tthis.scrollOnStart();\n\t\t}\n\n\t\tthis.windowFocused = document.hasFocus();\n\n\t\tthis.subscribeToEvents();\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.unsubscribeFromEvents();\n\t\tif (this.dialogInited)\n\t\t{\n\t\t\tthis.saveScrollPosition();\n\t\t\tthis.handleMessagesOnExit();\n\t\t}\n\t\tthis.getPullWatchManager().unsubscribe();\n\t\tthis.closeDialogPopups();\n\t\tthis.forwardPopup.show = false;\n\t},\n\tmethods:\n\t{\n\t\tasync scrollOnStart()\n\t\t{\n\t\t\tawait this.$nextTick();\n\n\t\t\t// we loaded chat with context\n\t\t\tif (this.contextMode.active && this.contextMode.messageIsLoaded)\n\t\t\t{\n\t\t\t\tthis.getScrollManager().scrollToMessage(this.layout.contextId);\n\t\t\t\tvoid this.$nextTick(() => {\n\t\t\t\t\tthis.highlightMessage(this.layout.contextId);\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// chat was loaded before\n\t\t\tif (this.contextMode.active && !this.contextMode.messageIsLoaded)\n\t\t\t{\n\t\t\t\tthis.goToMessageContext(this.layout.contextId);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// marked message\n\t\t\tif (this.dialog.markedId)\n\t\t\t{\n\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// saved position\n\t\t\tif (this.dialog.savedPositionMessageId && !this.isGuest)\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: saved scroll position, scrolling to', this.dialog.savedPositionMessageId);\n\t\t\t\tthis.getScrollManager().scrollToMessage(this.dialog.savedPositionMessageId, { withDateOffset: false });\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst lastReadId = this.$store.getters['chats/getLastReadId'](this.dialogId);\n\t\t\tconst isLastMessageId = lastReadId === this.dialog.lastMessageId;\n\t\t\t// unread messages and read messages before them\n\t\t\tif (lastReadId > 0 && !isLastMessageId)\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: scroll to \"New messages\" mark, lastReadId -', lastReadId, 'lastMessageId', this.dialog.lastMessageId);\n\t\t\t\tthis.getScrollManager().scrollToMessage(BlockType.newMessages);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// new chat, unread messages without read messages before them\n\t\t\tconst hasUnread = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\tif (lastReadId === 0 || hasUnread)\n\t\t\t{\n\t\t\t\tthis.getScrollManager().setStartScrollNeeded(false);\n\t\t\t\tLogger.warn('Dialog: dont scroll, hasUnread -', hasUnread, 'lastReadId', lastReadId);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// no unread messages\n\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t},\n\t\tshowLoadingBar(): void\n\t\t{\n\t\t\tEventEmitter.emit(EventType.dialog.showLoadingBar, { dialogId: this.dialogId });\n\t\t},\n\t\thideLoadingBar(): void\n\t\t{\n\t\t\tEventEmitter.emit(EventType.dialog.hideLoadingBar, { dialogId: this.dialogId });\n\t\t},\n\t\tasync goToMessageContext(messageId: number, params: { position: string } = {}): void\n\t\t{\n\t\t\tconst { position = ScrollManager.scrollPosition.messageTop } = params;\n\t\t\tconst hasMessage = this.$store.getters['messages/hasMessage']({\n\t\t\t\tchatId: this.dialog.chatId,\n\t\t\t\tmessageId,\n\t\t\t});\n\t\t\tif (hasMessage)\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we have this message, scrolling to it', messageId);\n\n\t\t\t\tawait this.getScrollManager().animatedScrollToMessage(messageId, { position });\n\t\t\t\tthis.highlightMessage(messageId);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst { hasAccess, errorCode } = await AccessManager.checkMessageAccess(messageId);\n\t\t\tif (!hasAccess && errorCode === AccessErrorCode.messageAccessDeniedByTariff)\n\t\t\t{\n\t\t\t\tAnalytics.getInstance().historyLimit.onGoToContextLimitExceeded({ dialogId: this.dialogId });\n\t\t\t\tFeatureManager.chatHistory.openFeatureSlider();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.showLoadingBar();\n\t\t\tawait this.getMessageService().loadContext(messageId)\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tLogger.error('goToMessageContext error', error);\n\t\t\t\t});\n\t\t\tawait this.$nextTick();\n\t\t\tthis.hideLoadingBar();\n\t\t\tthis.getScrollManager().scrollToMessage(messageId, { position });\n\t\t\tawait this.$nextTick();\n\t\t\tthis.highlightMessage(messageId);\n\t\t},\n\t\thighlightMessage(messageId: number)\n\t\t{\n\t\t\tconst HIGHLIGHT_CLASS = 'bx-im-dialog-chat__highlighted-message';\n\t\t\tconst HIGHLIGHT_DURATION = 2000;\n\n\t\t\tconst message = this.getScrollManager().getDomElementById(messageId);\n\t\t\tif (!message)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tDom.addClass(message, HIGHLIGHT_CLASS);\n\t\t\tsetTimeout(() => {\n\t\t\t\tDom.removeClass(message, HIGHLIGHT_CLASS);\n\t\t\t}, HIGHLIGHT_DURATION);\n\t\t},\n\t\tsaveScrollPosition()\n\t\t{\n\t\t\tif (!this.saveScrollOnExit)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tlet savedPositionMessageId = this.getVisibleMessagesManager().getFirstMessageId();\n\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\tsavedPositionMessageId = 0;\n\t\t\t}\n\t\t\tthis.$store.dispatch('chats/update', {\n\t\t\t\tdialogId: this.dialogId,\n\t\t\t\tfields: { savedPositionMessageId },\n\t\t\t});\n\t\t},\n\t\tasync handleMessagesOnExit()\n\t\t{\n\t\t\tif (this.resetOnExit)\n\t\t\t{\n\t\t\t\tvoid this.getChatService().resetChat(this.dialogId);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait this.getChatService().readChatQueuedMessages(this.dialog.chatId);\n\n\t\t\tconst LOAD_MESSAGES_ON_EXIT_DELAY = 200;\n\t\t\tsetTimeout(async () => {\n\t\t\t\tvoid this.getMessageService().reloadMessageList();\n\t\t\t}, LOAD_MESSAGES_ON_EXIT_DELAY);\n\t\t},\n\t\t/* region Reading */\n\t\treadQueuedMessages(): void\n\t\t{\n\t\t\tif (!this.messagesCanBeRead())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t[...this.messagesToRead].forEach((messageId) => {\n\t\t\t\tthis.getChatService().readMessage(this.dialog.chatId, messageId);\n\t\t\t\tthis.messagesToRead.delete(messageId);\n\t\t\t});\n\t\t},\n\t\treadVisibleMessages(): void\n\t\t{\n\t\t\tif (!this.messagesCanBeRead())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst visibleMessages = this.getVisibleMessagesManager().getVisibleMessages();\n\t\t\tvisibleMessages.forEach((messageId) => {\n\t\t\t\tconst message: ImModelMessage = this.$store.getters['messages/getById'](messageId);\n\t\t\t\tif (!message || message.viewed)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.getChatService().readMessage(this.dialog.chatId, messageId);\n\t\t\t});\n\t\t},\n\t\tmessagesCanBeRead(): boolean\n\t\t{\n\t\t\tif (!this.dialogInited || !this.isChatVisible())\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tconst permissionManager = PermissionManager.getInstance();\n\n\t\t\treturn permissionManager.canPerformActionByRole(ActionByRole.readMessage, this.dialogId);\n\t\t},\n\t\t/* endregion Reading */\n\t\t/* region Event handlers */\n\t\tonChatInited()\n\t\t{\n\t\t\tthis.scrollOnStart();\n\t\t\tthis.readVisibleMessages();\n\n\t\t\tvoid this.$nextTick(() => {\n\t\t\t\tthis.getChatService().clearDialogMark(this.dialogId);\n\t\t\t});\n\n\t\t\tEventEmitter.emit(EventType.dialog.onDialogInited, { dialogId: this.dialogId });\n\t\t},\n\t\tasync onScrollTriggerUp()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered UP');\n\t\t\tconst container = this.getContainer();\n\t\t\tconst oldHeight = container.scrollHeight - container.clientHeight;\n\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedHistoryMessages())\n\t\t\t{\n\t\t\t\tawait this.getMessageService().drawPreparedHistoryMessages();\n\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasPrevPage)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tthis.showLoadingBar();\n\t\t\tawait this.getMessageService().loadHistory();\n\t\t\tthis.hideLoadingBar();\n\t\t\t// Messages loaded and we are at the top\n\t\t\tif (this.getScrollManager().isAtTheTop())\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we are at the top after history request, inserting messages');\n\t\t\t\tawait this.getMessageService().drawPreparedHistoryMessages();\n\t\t\t\tthis.getScrollManager().adjustScrollOnHistoryAddition(oldHeight);\n\t\t\t}\n\t\t},\n\t\tasync onScrollTriggerDown()\n\t\t{\n\t\t\tif (!this.dialogInited || !this.getContainer())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll triggered DOWN');\n\t\t\t// Insert messages if there are some\n\t\t\tif (this.getMessageService().hasPreparedUnreadMessages())\n\t\t\t{\n\t\t\t\tawait this.getMessageService().drawPreparedUnreadMessages();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// check if already loading or no more history\n\t\t\tif (this.getMessageService().isLoading() || !this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Load messages and save them\n\t\t\tthis.showLoadingBar();\n\t\t\tawait this.getMessageService().loadUnread();\n\t\t\tthis.hideLoadingBar();\n\t\t\t// Messages loaded and we are at the bottom\n\t\t\tif (this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\tLogger.warn('Dialog: we are at the bottom after unread request, inserting messages');\n\t\t\t\tawait this.getMessageService().drawPreparedUnreadMessages();\n\t\t\t\tthis.getScrollManager().checkIfChatIsScrolledUp();\n\t\t\t}\n\t\t},\n\t\tasync onScrollToBottom(event: BaseEvent<ScrollToBottomEvent>)\n\t\t{\n\t\t\tconst { chatId, threshold = DialogScrollThreshold.halfScreenUp, animation = true } = event.getData();\n\t\t\tif (this.dialog.chatId !== chatId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.windowFocused || this.hasVisibleCall())\n\t\t\t{\n\t\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\t\tif (firstUnreadId)\n\t\t\t\t{\n\t\t\t\t\tawait this.$nextTick();\n\t\t\t\t\tthis.getScrollManager().scrollToMessage(firstUnreadId);\n\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tLogger.warn('Dialog: scroll to bottom', chatId, threshold);\n\t\t\tif (threshold === DialogScrollThreshold.halfScreenUp && this.isScrolledUp)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (threshold === DialogScrollThreshold.nearTheBottom && !this.getScrollManager().isAroundBottom())\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tawait this.$nextTick();\n\t\t\tif (animation)\n\t\t\t{\n\t\t\t\tthis.getScrollManager().animatedScrollToBottom();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getScrollManager().scrollToBottom();\n\t\t},\n\t\tonGoToMessageContext(event: BaseEvent)\n\t\t{\n\t\t\tconst { dialogId, messageId } = event.getData();\n\t\t\tif (this.dialog.dialogId !== dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.goToMessageContext(messageId);\n\t\t},\n\t\tonPinnedMessageClick(messageId: number)\n\t\t{\n\t\t\tthis.goToMessageContext(messageId);\n\t\t},\n\t\tonPinnedMessageUnpin(messageId: number)\n\t\t{\n\t\t\tthis.getMessageService().unpinMessage(this.dialog.chatId, messageId);\n\t\t},\n\t\tonScroll(event: Event)\n\t\t{\n\t\t\tthis.closeDialogPopups();\n\t\t\tthis.debouncedScrollHandler(event);\n\t\t},\n\t\tasync onScrollButtonClick()\n\t\t{\n\t\t\tif (this.getScrollManager().scrollButtonClicked)\n\t\t\t{\n\t\t\t\tvoid this.handleSecondScrollButtonClick();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.getScrollManager().scrollButtonClicked = true;\n\t\t\tif (this.dialog.counter === 0)\n\t\t\t{\n\t\t\t\tthis.showLoadingBar();\n\t\t\t\tawait this.getMessageService().loadInitialMessages();\n\t\t\t\tthis.hideLoadingBar();\n\t\t\t\tthis.getScrollManager().scrollToBottom();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst firstUnreadId = this.$store.getters['messages/getFirstUnread'](this.dialog.chatId);\n\t\t\tif (!firstUnreadId)\n\t\t\t{\n\t\t\t\tthis.showLoadingBar();\n\t\t\t\tawait this.getMessageService().loadInitialMessages();\n\t\t\t\tthis.hideLoadingBar();\n\t\t\t\tawait this.getScrollManager().animatedScrollToMessage(firstUnreadId);\n\t\t\t}\n\n\t\t\tawait this.getScrollManager().animatedScrollToMessage(firstUnreadId);\n\t\t},\n\t\tonWindowFocus()\n\t\t{\n\t\t\tthis.windowFocused = true;\n\t\t\tthis.readVisibleMessages();\n\t\t},\n\t\tonWindowBlur()\n\t\t{\n\t\t\tthis.windowFocused = false;\n\t\t},\n\t\tonCallFold()\n\t\t{\n\t\t\tconst callDialogId = CallManager.getInstance().getCurrentCallDialogId();\n\t\t\tif (callDialogId !== this.dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.readVisibleMessages();\n\t\t},\n\t\tasync onShowQuoteButton(event: BaseEvent<{ message: ImModelMessage, event: MouseEvent }>)\n\t\t{\n\t\t\tconst { message, event: $event } = event.getData();\n\t\t\tconst permissionManager = PermissionManager.getInstance();\n\t\t\tif (!permissionManager.canPerformActionByRole(ActionByRole.send, this.dialogId))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.showQuoteButton = true;\n\t\t\tawait this.$nextTick();\n\t\t\tthis.$refs.quoteButton.onMessageMouseUp(message, $event);\n\t\t},\n\t\tasync handleSecondScrollButtonClick()\n\t\t{\n\t\t\tthis.getScrollManager().scrollButtonClicked = false;\n\t\t\tif (this.dialog.hasNextPage)\n\t\t\t{\n\t\t\t\tthis.showLoadingBar();\n\t\t\t\tawait this.getMessageService().loadContext(this.dialog.lastMessageId)\n\t\t\t\t\t.catch((error) => {\n\t\t\t\t\t\tLogger.error('ChatDialog: scroll to chat end loadContext error', error);\n\t\t\t\t\t});\n\t\t\t\tthis.hideLoadingBar();\n\n\t\t\t\tEventEmitter.emit(EventType.dialog.scrollToBottom, {\n\t\t\t\t\tchatId: this.dialog.chatId,\n\t\t\t\t});\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tvoid this.getScrollManager().animatedScrollToMessage(this.dialog.lastMessageId, { withDateOffset: false });\n\t\t},\n\t\tonShowForwardPopup(event: BaseEvent)\n\t\t{\n\t\t\tconst { messagesIds } = event.getData();\n\t\t\tthis.forwardPopup.messagesIds = messagesIds;\n\t\t\tthis.forwardPopup.show = true;\n\t\t},\n\t\tonCloseForwardPopup()\n\t\t{\n\t\t\tthis.forwardPopup.messagesIds = [];\n\t\t\tthis.forwardPopup.show = false;\n\t\t},\n\t\tonMessageIsVisible(event: BaseEvent<{ messageId: number, dialogId: string }>)\n\t\t{\n\t\t\tconst { messageId, dialogId } = event.getData();\n\t\t\tif (dialogId !== this.dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.getVisibleMessagesManager().setMessageAsVisible(messageId);\n\n\t\t\tconst message: ImModelMessage = this.$store.getters['messages/getById'](messageId);\n\t\t\tif (!message.viewed && this.isChatVisible())\n\t\t\t{\n\t\t\t\tthis.messagesToRead.add(messageId);\n\t\t\t\tthis.debouncedReadHandler();\n\t\t\t}\n\t\t},\n\t\tonMessageIsNotVisible(event: BaseEvent<{ messageId: number, dialogId: string }>)\n\t\t{\n\t\t\tconst { messageId, dialogId } = event.getData();\n\t\t\tif (dialogId !== this.dialogId)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.getVisibleMessagesManager().setMessageAsNotVisible(messageId);\n\t\t},\n\t\t/* endregion Event handlers */\n\t\t/* region Init methods */\n\t\tinitContextMode()\n\t\t{\n\t\t\tconst layoutManager = LayoutManager.getInstance();\n\t\t\tif (!layoutManager.isChatContextAvailable(this.dialogId))\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.contextMode.active = true;\n\t\t\t// chat was loaded before, we didn't load context specifically\n\t\t\t// if chat wasn't loaded before - we load it with context\n\t\t\tthis.contextMode.messageIsLoaded = !this.dialogInited;\n\t\t},\n\t\tgetMessageService(): MessageService\n\t\t{\n\t\t\tif (!this.messageService)\n\t\t\t{\n\t\t\t\tthis.messageService = new MessageService({ chatId: this.dialog.chatId });\n\t\t\t}\n\n\t\t\treturn this.messageService;\n\t\t},\n\t\tgetChatService(): ChatService\n\t\t{\n\t\t\tif (!this.chatService)\n\t\t\t{\n\t\t\t\tthis.chatService = new ChatService();\n\t\t\t}\n\n\t\t\treturn this.chatService;\n\t\t},\n\t\tgetScrollManager(): ScrollManager\n\t\t{\n\t\t\tif (!this.scrollManager)\n\t\t\t{\n\t\t\t\tthis.scrollManager = new ScrollManager();\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerUp, this.onScrollTriggerUp);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollTriggerDown, this.onScrollTriggerDown);\n\t\t\t\tthis.scrollManager.subscribe(ScrollManager.events.onScrollThresholdPass, (event: BaseEvent<boolean>) => {\n\t\t\t\t\tthis.isScrolledUp = event.getData();\n\t\t\t\t});\n\t\t\t}\n\n\t\t\treturn this.scrollManager;\n\t\t},\n\t\tgetPullWatchManager(): PullWatchManager\n\t\t{\n\t\t\tif (!this.pullWatchManager)\n\t\t\t{\n\t\t\t\tthis.pullWatchManager = new PullWatchManager(this.dialogId);\n\t\t\t}\n\n\t\t\treturn this.pullWatchManager;\n\t\t},\n\t\tgetVisibleMessagesManager(): VisibleMessagesManager\n\t\t{\n\t\t\tif (!this.visibleMessagesManager)\n\t\t\t{\n\t\t\t\tthis.visibleMessagesManager = new VisibleMessagesManager();\n\t\t\t}\n\n\t\t\treturn this.visibleMessagesManager;\n\t\t},\n\t\t/* endregion Init methods */\n\t\tisChatVisible(): boolean\n\t\t{\n\t\t\treturn this.windowFocused && !this.hasVisibleCall() && !this.hasCommentsOnTop;\n\t\t},\n\t\thasVisibleCall(): boolean\n\t\t{\n\t\t\treturn CallManager.getInstance().hasVisibleCall();\n\t\t},\n\t\tcloseDialogPopups()\n\t\t{\n\t\t\tthis.showQuoteButton = false;\n\t\t\tPopupManager.getPopupById(PopupType.dialogAvatarMenu)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogMessageMenu)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReactionUsers)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.dialogReadUsers)?.close();\n\t\t\tPopupManager.getPopupById(PopupType.messageBaseFileMenu)?.close();\n\t\t},\n\t\tsubscribeToEvents()\n\t\t{\n\t\t\tEventEmitter.subscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.subscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.subscribe(EventType.call.onFold, this.onCallFold);\n\t\t\tEventEmitter.subscribe(EventType.dialog.showForwardPopup, this.onShowForwardPopup);\n\t\t\tEventEmitter.subscribe(EventType.dialog.showQuoteButton, this.onShowQuoteButton);\n\t\t\tEventEmitter.subscribe(EventType.dialog.onMessageIsVisible, this.onMessageIsVisible);\n\t\t\tEventEmitter.subscribe(EventType.dialog.onMessageIsNotVisible, this.onMessageIsNotVisible);\n\n\t\t\tEvent.bind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.bind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tunsubscribeFromEvents()\n\t\t{\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.scrollToBottom, this.onScrollToBottom);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.goToMessageContext, this.onGoToMessageContext);\n\t\t\tEventEmitter.unsubscribe(EventType.call.onFold, this.onCallFold);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.showForwardPopup, this.onShowForwardPopup);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.showQuoteButton, this.onShowQuoteButton);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.onMessageIsVisible, this.onMessageIsVisible);\n\t\t\tEventEmitter.unsubscribe(EventType.dialog.onMessageIsNotVisible, this.onMessageIsNotVisible);\n\n\t\t\tEvent.unbind(window, 'focus', this.onWindowFocus);\n\t\t\tEvent.unbind(window, 'blur', this.onWindowBlur);\n\t\t},\n\t\tgetContainer(): ?HTMLElement\n\t\t{\n\t\t\treturn this.$refs.container;\n\t\t},\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-dialog-chat__block bx-im-dialog-chat__scope\">\n\t\t\t<!-- Top -->\n\t\t\t<slot name=\"pinned-panel\">\n\t\t\t\t<PinnedMessages\n\t\t\t\t\tv-if=\"pinnedMessages.length > 0\"\n\t\t\t\t\t:dialogId=\"dialogId\"\n\t\t\t\t\t:messages=\"pinnedMessages\"\n\t\t\t\t\t@messageClick=\"onPinnedMessageClick\"\n\t\t\t\t\t@messageUnpin=\"onPinnedMessageUnpin\"\n\t\t\t\t/>\n\t\t\t</slot>\n\t\t\t<PullStatus/>\n\t\t\t<!-- Message list -->\n\t\t\t<div @scroll=\"onScroll\" class=\"bx-im-dialog-chat__scroll-container\" ref=\"container\">\n\t\t\t\t<slot name=\"message-list\">\n\t\t\t\t\t<component :is=\"messageListComponent\" :dialogId=\"dialogId\"/>\n\t\t\t\t</slot>\n\t\t\t</div>\n\t\t\t<!-- Float buttons -->\n\t\t\t<slot name=\"additional-float-button\"></slot>\n\t\t\t<Transition name=\"float-button-transition\">\n\t\t\t\t<ScrollButton v-if=\"showScrollButton\" :dialogId=\"dialogId\" @click=\"onScrollButtonClick\" />\n\t\t\t</Transition>\n\t\t\t<!-- Absolute elements -->\n\t\t\t<ForwardPopup\n\t\t\t\tv-if=\"forwardPopup.show\"\n\t\t\t\t:messagesIds=\"forwardPopup.messagesIds\"\n\t\t\t\t@close=\"onCloseForwardPopup\"\n\t\t\t/>\n\t\t\t<Transition name=\"fade-up\">\n\t\t\t\t<QuoteButton\n\t\t\t\t\tv-if=\"showQuoteButton\"\n\t\t\t\t\t:dialogId=\"dialogId\"\n\t\t\t\t\t@close=\"showQuoteButton = false\" \n\t\t\t\t\tclass=\"bx-im-message-base__quote-button\"\n\t\t\t\t\tref=\"quoteButton\"\n\t\t\t\t/>\n\t\t\t</Transition>\n\t\t</div>\n\t`,\n};\n"],"names":["EVENT_NAMESPACE","ScrollManager","EventEmitter","constructor","isScrolling","currentScroll","lastScroll","chatIsScrolledUp","scrollButtonClicked","startScrollNeeded","setEventNamespace","setContainer","container","onScroll","event","target","scrollTop","isScrollingDown","isScrollingUp","SCROLLING_THRESHOLD","leftSpaceBottom","scrollHeight","clientHeight","isStartScrollCompleted","emit","events","onScrollTriggerDown","onScrollTriggerUp","checkIfChatIsScrolledUp","SCROLLED_UP_THRESHOLD","availableScrollHeight","newFlag","onScrollThresholdPass","scrollToBottom","Logger","warn","forceScrollTo","animatedScrollToBottom","animatedScrollTo","scrollToMessage","messageId","params","element","getDomElementById","scrollPosition","setStartScrollNeeded","flag","animatedScrollToMessage","Promise","resolve","position","cancelAnimatedScroll","scroll","top","behavior","adjustScrollOnHistoryAddition","oldContainerHeight","newContainerHeight","newScrollPosition","Animation","start","end","elementProperty","callback","cancel","isAtTheTop","isAtTheBottom","isAroundBottom","POSITION_THRESHOLD","id","querySelector","FLOATING_DATE_OFFSET","MESSAGE_BOTTOM_OFFSET","withDateOffset","messageTop","offset","offsetTop","messageBottom","MESSAGES_TAG_PREFIX","COMMENTS_TAG_PREFIX","PullWatchManager","dialogId","Core","getStore","getters","getPullClient","subscribe","unsubscribe","clearWatch","chatId","extendWatch","runAction","RestMethod","imV2ChatExtendPullWatch","data","role","UserRole","guest","ChannelManager","isChannel","type","ChatType","comment","VisibleMessagesManager","Set","setMessageAsVisible","add","setMessageAsNotVisible","delete","getVisibleMessages","getFirstMessageId","size","firstVisibleMessage","sort","a","b","PinnedMessage","props","message","Object","required","computed","internalMessage","text","Parser","purifyMessage","authorId","author","$store","template","PinnedMessages","name","components","String","default","messages","Array","emits","dialog","firstMessage","messagesToShow","slice","canUnpin","PermissionManager","getInstance","canPerformActionByRole","ActionByRole","pinMessage","showUnpin","isCommentChat","methods","loc","phraseCode","$Bitrix","Loc","getMessage","CONTAINER_HEIGHT","CONTAINER_WIDTH","CONTAINER_OFFSET","slider","MessengerSlider","getCurrent","sliderRect","layout","getBoundingClientRect","offsetY","MESSAGE_TEXT_NODE_CLASS","QuoteButton","mouseX","mouseY","containerStyle","left","width","height","mounted","Event","bind","window","onMouseDown","onMessageMouseUp","button","prepareSelectedText","clientX","clientY","$refs","contains","$emit","Utils","browser","isFirefox","getSelection","toString","range","getRangeAt","rangeContents","cloneContents","nodesToIterate","childNodes","messageNode","node","isImage","getAttribute","isLineBreak","textContent","HTMLElement","tagName","toLowerCase","nodeName","isText","isMessageTextNode","textNode","matches","Boolean","extractTextFromMessageNode","onQuoteClick","Quote","sendQuoteEvent","ScrollButton","formattedCounter","counter","ChatDialog","MessageList","PullStatus","ForwardPopup","saveScrollOnExit","resetOnExit","forwardPopup","show","messagesIds","contextMode","active","messageIsLoaded","isScrolledUp","windowFocused","showQuoteButton","messagesToRead","dialogInited","inited","messageCollection","pinnedMessages","isOpened","openedDialogId","entityId","isGuest","debouncedScrollHandler","SCROLLING_DEBOUNCE_DELAY","Runtime","debounce","getScrollManager","debouncedReadHandler","READING_DEBOUNCE_DELAY","readQueuedMessages","messageListComponent","showScrollButton","hasNextPage","hasCommentsOnTop","watch","newValue","oldValue","getPullWatchManager","onChatInited","handler","commentsWereClosed","readVisibleMessages","flush","created","initContextMode","getContainer","length","scrollOnStart","document","hasFocus","subscribeToEvents","beforeUnmount","unsubscribeFromEvents","saveScrollPosition","handleMessagesOnExit","closeDialogPopups","$nextTick","contextId","highlightMessage","goToMessageContext","markedId","BlockType","newMessages","savedPositionMessageId","lastReadId","isLastMessageId","lastMessageId","hasUnread","showLoadingBar","EventType","hideLoadingBar","hasMessage","hasAccess","errorCode","AccessManager","checkMessageAccess","AccessErrorCode","messageAccessDeniedByTariff","Analytics","historyLimit","onGoToContextLimitExceeded","FeatureManager","chatHistory","openFeatureSlider","getMessageService","loadContext","catch","error","HIGHLIGHT_CLASS","HIGHLIGHT_DURATION","Dom","addClass","setTimeout","removeClass","getVisibleMessagesManager","dispatch","fields","getChatService","resetChat","readChatQueuedMessages","LOAD_MESSAGES_ON_EXIT_DELAY","reloadMessageList","messagesCanBeRead","forEach","readMessage","visibleMessages","viewed","isChatVisible","permissionManager","clearDialogMark","onDialogInited","oldHeight","hasPreparedHistoryMessages","drawPreparedHistoryMessages","isLoading","hasPrevPage","loadHistory","hasPreparedUnreadMessages","drawPreparedUnreadMessages","loadUnread","onScrollToBottom","threshold","DialogScrollThreshold","halfScreenUp","animation","getData","hasVisibleCall","firstUnreadId","nearTheBottom","onGoToMessageContext","onPinnedMessageClick","onPinnedMessageUnpin","unpinMessage","onScrollButtonClick","handleSecondScrollButtonClick","loadInitialMessages","onWindowFocus","onWindowBlur","onCallFold","callDialogId","CallManager","getCurrentCallDialogId","onShowQuoteButton","$event","send","quoteButton","onShowForwardPopup","onCloseForwardPopup","onMessageIsVisible","onMessageIsNotVisible","layoutManager","LayoutManager","isChatContextAvailable","messageService","MessageService","chatService","ChatService","scrollManager","pullWatchManager","visibleMessagesManager","PopupManager","getPopupById","PopupType","dialogAvatarMenu","close","dialogMessageMenu","dialogReactionUsers","dialogReadUsers","messageBaseFileMenu","call","onFold","showForwardPopup","unbind"],"mappings":"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"}