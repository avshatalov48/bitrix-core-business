this.BX=this.BX||{};this.BX.Bizproc=this.BX.Bizproc||{};(function(e,t,s,o,a,i){"use strict";let r=e=>e,l;var n=babelHelpers.classPrivateFieldLooseKey("isChanged");var d=babelHelpers.classPrivateFieldLooseKey("messageBox");var c=babelHelpers.classPrivateFieldLooseKey("canClose");var b=babelHelpers.classPrivateFieldLooseKey("renderButtons");var h=babelHelpers.classPrivateFieldLooseKey("handleTaskButtonClick");var u=babelHelpers.classPrivateFieldLooseKey("handleDelegateButtonClick");var f=babelHelpers.classPrivateFieldLooseKey("delegateTask");var p=babelHelpers.classPrivateFieldLooseKey("sendMarkAsRead");var m=babelHelpers.classPrivateFieldLooseKey("clearError");var v=babelHelpers.classPrivateFieldLooseKey("showError");var B=babelHelpers.classPrivateFieldLooseKey("renderNextTask");var P=babelHelpers.classPrivateFieldLooseKey("renderTaskFields");var k=babelHelpers.classPrivateFieldLooseKey("showConfirmDialog");class g{constructor(e){Object.defineProperty(this,k,{value:S});Object.defineProperty(this,P,{value:H});Object.defineProperty(this,B,{value:D});Object.defineProperty(this,v,{value:E});Object.defineProperty(this,m,{value:y});Object.defineProperty(this,p,{value:L});Object.defineProperty(this,f,{value:C});Object.defineProperty(this,u,{value:F});Object.defineProperty(this,h,{value:I});Object.defineProperty(this,b,{value:w});Object.defineProperty(this,n,{writable:true,value:false});Object.defineProperty(this,d,{writable:true,value:void 0});Object.defineProperty(this,c,{writable:true,value:false});this.currentUserId=e.currentUserId;this.workflowId=e.workflowId;this.taskId=e.taskId;this.taskUserId=e.taskUserId;this.taskButtons=e.taskButtons;this.taskForm=e.taskForm;this.buttonsPanel=e.buttonsPanel;this.workflowContent=e.workflowContent;this.canDelegateTask=e.canDelegateTask;this.handleMarkAsRead=t.Runtime.debounce(babelHelpers.classPrivateFieldLooseBase(this,p)[p],100,this)}init(){if(this.buttonsPanel){babelHelpers.classPrivateFieldLooseBase(this,b)[b]()}this.handleMarkAsRead();s.EventEmitter.subscribe("OnUCCommentWasRead",(e=>{const[t]=e.getData();if(t===`WF_${this.workflowId}`){this.handleMarkAsRead()}}));if(this.taskForm){t.Event.bind(this.taskForm,"change",(()=>{babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}));t.Event.bind(this.taskForm,"input",(e=>{const t=e.target;if(t.matches("input, textarea, select")){const e=t.closest(".ui-form-content");if(e){babelHelpers.classPrivateFieldLooseBase(this,m)[m](e)}}babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}));this.taskForm.querySelectorAll(".ui-form-content").forEach((e=>{t.Event.bind(e,"click",(e=>{const t=e.currentTarget;babelHelpers.classPrivateFieldLooseBase(this,m)[m](t)}))}));s.EventEmitter.subscribe("BX.UI.Selector:onChange",(e=>{const t=BX(`crm-${e.data[0].selectorId}-box`);const s=t.closest(".ui-form-content");if(s){babelHelpers.classPrivateFieldLooseBase(this,m)[m](s);babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}}));s.EventEmitter.subscribe("BX.UI.EntitySelector.Dialog:Item:onSelect",(e=>{if(e.target.context==="BIZPROC"){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}}));s.EventEmitter.subscribe("BX.UI.EntitySelector.Dialog:Item:onDeselect",(e=>{if(e.target.context==="BIZPROC"){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}}));s.EventEmitter.subscribe("OnIframeKeyup",(e=>{const t=e.target.dom.cont;const s=t.closest(".ui-form-content");if(s){babelHelpers.classPrivateFieldLooseBase(this,m)[m](s)}}));s.EventEmitter.subscribe("OnContentChanged",(e=>{if(e.target.dom.cont.closest(".ui-form-content")){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}}));s.EventEmitter.subscribe("BX.Disk.Uploader.Integration:Item:onAdd",(e=>{if(e.target.getUploader().getHiddenFieldsContainer().closest(".ui-form-content")){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}}));s.EventEmitter.subscribe("BX.Disk.Uploader.Integration:Item:onRemove",(e=>{if(e.target.getUploader().getHiddenFieldsContainer().closest(".ui-form-content")){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=true}}));s.EventEmitter.subscribe("SidePanel.Slider:onClose",(e=>{if(e.getTarget().getWindow()===window&&babelHelpers.classPrivateFieldLooseBase(this,n)[n]&&!babelHelpers.classPrivateFieldLooseBase(this,c)[c]){var t;e.getCompatData()[0].denyAction();if(!((t=babelHelpers.classPrivateFieldLooseBase(this,d)[d])!=null&&t.getPopupWindow().isShown())){babelHelpers.classPrivateFieldLooseBase(this,k)[k]()}}}))}const e=this.workflowContent.querySelector(".bp-workflow-info__desc-inner");if(e){BX.UI.Hint.init(e)}}}function w(){if(this.taskButtons){t.Dom.clean(this.buttonsPanel);this.taskButtons.forEach((e=>{const s=new a.UserStatus(e.TARGET_USER_STATUS);const i=s.isNo()||s.isCancel();const r=new o.Button({color:i?o.ButtonColor.LIGHT_BORDER:o.ButtonColor.SUCCESS,round:true,size:o.ButtonSize.MEDIUM,text:e.TEXT,onclick:t=>babelHelpers.classPrivateFieldLooseBase(this,h)[h](e,t)});t.Dom.style(r.getContainer(),"minWidth","160px");t.Dom.style(r.getContainer(),"maxWidth","200px");t.Dom.attr(r.getContainer(),"title",e.TEXT);t.Dom.append(r.getContainer(),this.buttonsPanel)}))}if(this.canDelegateTask){const e=new o.Button({color:o.ButtonColor.LINK,size:o.ButtonSize.MEDIUM,text:t.Loc.getMessage("BPWFI_SLIDER_BUTTON_DELEGATE"),onclick:e=>babelHelpers.classPrivateFieldLooseBase(this,u)[u](e)});t.Dom.style(e.getContainer(),"minWidth","160px");t.Dom.style(e.getContainer(),"maxWidth","200px");t.Dom.append(e.getContainer(),this.buttonsPanel)}}function I(e,s){const o=new FormData(this.taskForm);o.append("taskId",this.taskId);o.append("workflowId",this.workflowId);o.append(e.NAME,e.VALUE);s.setDisabled(true);t.ajax.runAction("bizproc.task.do",{data:o}).then((()=>{s.setDisabled(false);t.Dom.addClass(this.workflowContent,"fade-out");t.ajax.runAction("bizproc.task.getUserTaskByWorkflowId",{data:o}).then((e=>{if(BX.type.isArray(e.data.additionalParams)&&e.data.additionalParams.length===0){var t;babelHelpers.classPrivateFieldLooseBase(this,c)[c]=true;(t=BX.SidePanel.Instance.getSliderByWindow(window))==null?void 0:t.close()}else{babelHelpers.classPrivateFieldLooseBase(this,B)[B](e.data)}})).catch((e=>{t.Dom.toggleClass(this.workflowContent,"fade-out fade-in");i.MessageBox.alert(e.errors.pop().message)}))})).catch((e=>{if(BX.type.isArray(e.errors)){const t=[];e.errors.forEach((e=>{const s=e.customData;if(this.taskForm&&s){const t=this.taskForm.querySelector(`[data-cid="${s}"]`);if(t){babelHelpers.classPrivateFieldLooseBase(this,v)[v](e,t)}}else{t.push(e.message)}}));if(t.length>0){i.MessageBox.alert(t.join(", "))}}s.setDisabled(false)}))}function F(e){e.setDisabled(true);t.Runtime.loadExtension("ui.entity-selector").then((t=>{const{Dialog:s}=t;e.setDisabled(false);const o=new s({targetNode:e.getContainer(),context:"bp-task-delegation",entities:[{id:"user",options:{intranetUsersOnly:true,emailUsers:false,inviteEmployeeLink:false,inviteGuestLink:false}},{id:"department",options:{selectMode:"usersOnly"}}],popupOptions:{bindOptions:{forceBindPosition:true}},enableSearch:true,events:{"Item:onSelect":e=>{const t=e.getData().item;babelHelpers.classPrivateFieldLooseBase(this,f)[f](t.getId())},onHide:e=>{e.getTarget().destroy()}},hideOnSelect:true,offsetTop:3,clearUnavailableItems:true,multiple:false});o.show()})).catch((t=>{console.error(t);e.setDisabled(false)}))}function C(e){const s={taskIds:[this.taskId],fromUserId:this.taskUserId||this.currentUserId,toUserId:e};t.ajax.runAction("bizproc.task.delegate",{data:s}).then((e=>{var t;babelHelpers.classPrivateFieldLooseBase(this,c)[c]=true;(t=BX.SidePanel.Instance.getSliderByWindow(window))==null?void 0:t.close()})).catch((e=>{i.MessageBox.alert(e.errors.pop().message)}))}function L(){t.ajax.runAction("bizproc.workflow.comment.markAsRead",{data:{workflowId:this.workflowId,userId:this.currentUserId}})}function y(e){const t=e.querySelector(".ui-form-notice");if(t){BX.Dom.remove(t)}}function E(e,t){const s=t.querySelector(".ui-form-content");let o=t.querySelector(".ui-form-notice");if(!o){o=BX.Dom.create("div",{attrs:{className:"ui-form-notice"}});o.innerText=e.message;if(s){BX.Dom.append(o,s)}}}function D(e){babelHelpers.classPrivateFieldLooseBase(this,n)[n]=false;babelHelpers.classPrivateFieldLooseBase(this,P)[P](e);if(e.additionalParams){this.taskId=e.additionalParams.ID;const s=this.workflowContent.querySelector(".bp-workflow-info__subject");if(s){s.innerText=e.additionalParams.NAME}const o=this.workflowContent.querySelector(".bp-workflow-info__desc-inner");if(o){const s=o.closest(".bp-workflow-info__tabs-block");if(e.additionalParams.DESCRIPTION.length>0){t.Dom.removeClass(s,"block-hidden")}else{t.Dom.addClass(s,"block-hidden")}o.innerHTML=e.additionalParams.DESCRIPTION;BX.UI.Hint.init(o)}const a=BX.SidePanel.Instance.getSliderByWindow(window);if(a){const e=a.getUrl();const t=e.replace(/\/bizproc\/\d+\//,`/bizproc/${this.taskId}/`);a.setUrl(t);top.history.replaceState({},"",t)}}if(e.additionalParams&&e.additionalParams.BUTTONS){this.taskButtons=e.additionalParams.BUTTONS}this.init();t.Dom.removeClass(this.workflowContent,"fade-out");t.Dom.addClass(this.workflowContent,"fade-in");t.Event.bindOnce(this.workflowContent,"animationend",(()=>{t.Dom.removeClass(this.workflowContent,"fade-in")}))}function H(e){const s=this.workflowContent.querySelector(".bp-workflow-info__editor");if(BX.type.isArray(e.html)&&e.html.length>0){t.Dom.removeClass(s,"block-hidden");t.Dom.clean(this.taskForm);e.html.forEach(((s,o)=>{var a,i;const n=(a=e.additionalParams)==null?void 0:(i=a.FIELDS)==null?void 0:i[o];if(n){const e=n.Required?"ui-form-label --required":"ui-form-label";const o=t.Tag.render(l||(l=r`
						<div class="ui-form-row" data-cid="${0}">
							<div class="${0}">
								<div class="ui-ctl-label-text">${0}</div>
							</div>
							<div class="ui-form-content"></div>
						</div>
					`),t.Text.encode(n.Id),e,t.Text.encode(n.Name));BX.Runtime.html(o.querySelector(".ui-form-content"),s);this.taskForm.append(o)}}))}else{t.Dom.addClass(s,"block-hidden")}}function S(){babelHelpers.classPrivateFieldLooseBase(this,d)[d]=i.MessageBox.confirm(t.Loc.getMessage("BPWFI_SLIDER_CONFIRM_DESCRIPTION"),t.Loc.getMessage("BPWFI_SLIDER_CONFIRM_TITLE"),(()=>{var e;babelHelpers.classPrivateFieldLooseBase(this,c)[c]=true;(e=BX.SidePanel.Instance.getSliderByWindow(window))==null?void 0:e.close()}),t.Loc.getMessage("BPWFI_SLIDER_CONFIRM_ACCEPT"),(()=>{babelHelpers.classPrivateFieldLooseBase(this,d)[d].close();babelHelpers.classPrivateFieldLooseBase(this,d)[d]=null}),t.Loc.getMessage("BPWFI_SLIDER_CONFIRM_CANCEL"))}e.WorkflowInfo=g})(this.BX.Bizproc.Component=this.BX.Bizproc.Component||{},BX,BX.Event,BX.UI,BX.Bizproc,BX.UI.Dialogs);
//# sourceMappingURL=script.map.js