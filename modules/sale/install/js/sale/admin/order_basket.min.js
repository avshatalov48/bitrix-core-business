BX.namespace("BX.Sale.Admin.OrderBasket");BX.Sale.Admin.OrderBasket=function(e){var t,i;this.tableId=e.tableId;this.objName=e.objName;this.idPrefix=e.idPrefix;this.productMenu=e.productMenu;this.columnsCount=e.columnsCount;this.visibleColumns=e.visibleColumns;this.isShowXmlId=e.isShowXmlId;this.weightUnit=e.weightUnit;this.productsCount=0;this.customPrices={};this.createBasketBottom=e.createBasketBottom||false;this.createProductBasement=e.createProductBasement||false;this.discounts=e.discounts||false;this.iblocksSkuParams=e.iblocksSkuParams||{};this.iblocksSkuParamsOrder=e.iblocksSkuParamsOrder||{};this.mode=e.mode||"edit";this.unRemovableFields=e.unRemovableFields||[];this.formatQuantity=e.formatQuantity;this.qantityUpdaterTimeout=0;this.qantityUpdaterDelay=750;this.canSendUpdateQuantityRequest=true;this.lastChangedQuantity=false;if(e.iblocksSkuParams){for(t in e.iblocksSkuParams){if(e.iblocksSkuParams.hasOwnProperty(t))this.setIblocksSkuParams(t,e.iblocksSkuParams[t])}}this.fieldsUpdaters={};if(!this.products)this.products={};if(e.productsOrder&&e.productsOrder.length)for(t=0,i=e.productsOrder.length-1;t<=i;t++)if(!!e.products[e.productsOrder[t]])this.productSet(e.products[e.productsOrder[t]],true);if(this.createBasketBottom)this.createBottomRow();if(this.discounts)this.setDiscounts(this.discounts);if(e.totalBlockFields){this.totalBlock=new BX.Sale.Admin.OrderBasketEditTotal({fields:e.totalBlockFields,weightUnit:this.weightUnit})}};BX.Sale.Admin.OrderBasket.prototype.getFieldsUpdaters=function(){return{SUM_PAID:{context:this,callback:this.setSumPaid},PAYABLE:{context:this,callback:this.setSumUnPaid},TOTAL_PRICES:{context:this,callback:this.setTotalPrices},DELIVERY_PRICE:{context:this,callback:this.setDeliveryPrice},DELIVERY_PRICE_DISCOUNT:{context:this,callback:this.setDeliveryPriceDiscount},BASKET:{context:this,callback:this.setBasket},DISCOUNTS_LIST:{context:this,callback:this.setDiscounts}}};BX.Sale.Admin.OrderBasket.prototype.setBasket=function(e){if(!e)return;var t,i;if(e.IBLOCKS_SKU_PARAMS)for(t in e.IBLOCKS_SKU_PARAMS)if(e.IBLOCKS_SKU_PARAMS.hasOwnProperty(t))this.setIblocksSkuParams(t,e.IBLOCKS_SKU_PARAMS[t]);if(e.IBLOCKS_SKU_PARAMS_ORDER)for(t in e.IBLOCKS_SKU_PARAMS_ORDER)if(e.IBLOCKS_SKU_PARAMS_ORDER.hasOwnProperty(t))this.setIblocksSkuParamsOrder(t,e.IBLOCKS_SKU_PARAMS_ORDER[t]);if(e.ITEMS&&e.ITEMS_ORDER&&e.ITEMS_ORDER.length){for(t=0,i=e.ITEMS_ORDER.length-1;t<=i;t++)if(!!e.ITEMS[e.ITEMS_ORDER[t]])this.productSet(e.ITEMS[e.ITEMS_ORDER[t]],true)}else{this.showEmptyRow()}this.hideLoadingRow()};BX.Sale.Admin.OrderBasket.prototype.setTotalPrices=function(e){this.totalBlock.setFieldValue("SUM_PAID",e.SUM_PAID);this.totalBlock.setFieldValue("SUM_UNPAID",e.SUM_UNPAID)};BX.Sale.Admin.OrderBasket.prototype.setDeliveryPrice=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY",e)};BX.Sale.Admin.OrderBasket.prototype.setDeliveryPriceDiscount=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",e)};BX.Sale.Admin.OrderBasket.prototype.setSumPaid=function(e){this.totalBlock.setFieldValue("SUM_PAID",e)};BX.Sale.Admin.OrderBasket.prototype.setSumUnPaid=function(e){this.totalBlock.setFieldValue("SUM_UNPAID",e)};BX.Sale.Admin.OrderBasket.prototype.showEmptyRow=function(){var e=BX(this.idPrefix+"sale-adm-order-edit-basket-empty-row");if(e)e.style.display=""};BX.Sale.Admin.OrderBasket.prototype.hideEmptyRow=function(){var e=BX(this.idPrefix+"sale-adm-order-edit-basket-empty-row");if(e)e.style.display="none"};BX.Sale.Admin.OrderBasket.prototype.hideLoadingRow=function(){var e=BX(this.idPrefix+"sale-adm-order-basket-loading-row");if(e)e.style.display="none"};BX.Sale.Admin.OrderBasket.prototype.createBottomRow=function(e){if(!this.createBasketBottom)return;var t=BX(this.tableId),i=BX.create("td",{html:'<strong style="margin-left: 10px;">'+BX.message("SALE_ORDER_BASKET_PROD_COUNT")+":&nbsp;"+'<span id="'+this.idPrefix+'sale-order-basket-products-count">'+this.productsCount+"</span>"+"</strong>"}),r=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-bottom-discounts"}}),a=BX.create("tbody",{props:{id:this.idPrefix+"sale-order-basket-bottom"},style:{textAlign:"left",borderBottom:"1px solid #DDD"},children:[BX.create("tr",{children:[i,r]})]});i.colSpan=this.mode=="view"?1:2;r.colSpan=this.columnsCount-1;t.appendChild(a)};BX.Sale.Admin.OrderBasket.prototype.setDiscounts=function(e){this.discounts=e;var t=BX(this.idPrefix+"sale-order-basket-bottom-discounts"),i=[];if(!e||!e.ORDER||!e.ORDER.DISCOUNT_LIST)return;for(var r=0,a=e.ORDER.DISCOUNT_LIST.length;r<a;r++){var s=e.ORDER.DISCOUNT_LIST[r];if(e.DISCOUNT_LIST&&e.DISCOUNT_LIST[s]&&e.DISCOUNT_LIST[s].ACTIONS_DESCR&&e.DISCOUNT_LIST[s].ACTIONS_DESCR.BASKET){i[r]=e.DISCOUNT_LIST[s];i[r].DESCR=e.DISCOUNT_LIST[s].ACTIONS_DESCR.BASKET}}if(t&&i){t=BX.cleanNode(t,false);t.appendChild(this.createDiscountsNodeBasket(i))}};BX.Sale.Admin.OrderBasket.prototype.createDiscountsNodeBasket=function(e){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DISCOUNT_LIST",e,this.discounts,"VIEW")};BX.Sale.Admin.OrderBasket.prototype.getProductBasketCode=function(e){if(!e.BASKET_CODE){if(e.IS_SET_ITEM=="Y"){var t=new Date;e.BASKET_CODE="set_"+t.getTime()+Math.floor(Math.random()*1e3)}else{BX.debug("product.BASKET_CODE is undefined!")}}return e.BASKET_CODE};BX.Sale.Admin.OrderBasket.prototype.setProductsCount=function(e){if(!this.createBasketBottom)return;var t=BX(this.idPrefix+"sale-order-basket-products-count");if(t)t.innerHTML=e};BX.Sale.Admin.OrderBasket.prototype.productAdd=function(e){var t=this.getProductBasketCode(e),i=BX(this.createProductRowId(t,e));if(i)return;if(parseFloat(e.PRICE)!=parseFloat(e.BASE_PRICE)&&e.CUSTOM_PRICE&&e.CUSTOM_PRICE=="Y")this.customPrices[t]=e.PRICE;i=this.createProductRow(t,e);var r=BX(this.tableId);if(this.createBasketBottom&&(bottom=BX(this.idPrefix+"sale-order-basket-bottom")))r.insertBefore(i,bottom);else r.appendChild(i)};BX.Sale.Admin.OrderBasket.prototype.productSet=function(e,t){var i=this.getProductBasketCode(e);if(this.productsCount<=0)this.hideEmptyRow();if(BX(this.createProductRowId(i,e))){if(t){this.productReplace(e,i)}else{this.setProductQuantity(i,this.roundQuantity(parseFloat(this.getProductQuantity(i))+parseFloat(e.QUANTITY)))}}else{this.productAdd(e);if(e.IS_SET_ITEM!="Y")this.setProductsCount(++this.productsCount)}if(e.SET_ITEMS&&e.SET_ITEMS.length){for(var r=0,a=e.SET_ITEMS.length-1;r<=a;r++){e.SET_ITEMS[r].BASKET_CODE="set_"+e.BASKET_CODE+"_"+e.SET_ITEMS[r].OFFER_ID;this.productSet(e.SET_ITEMS[r],true)}}this.setRowNumbers()};BX.Sale.Admin.OrderBasket.prototype.productReplace=function(e,t){var i=BX(this.createProductRowId(t,e));if(!i)return;this.onProductDelete(t);var r=this.getProductBasketCode(e),a=this.createProductRow(r,e);if(!a)return;if(!BX.hasClass(i,"basket-bundle-child-hidden"))BX.removeClass(a,"basket-bundle-child-hidden");i.parentNode.replaceChild(a,i);this.setRowNumbers()};BX.Sale.Admin.OrderBasket.prototype.onProductDelete=function(e){BX.Sale.Admin.OrderEditPage.unRegisterProductFieldsUpdaters(e)};BX.Sale.Admin.OrderBasket.prototype.roundQuantity=function(e){if(this.formatQuantity=="AUTO"||parseInt(this.formatQuantity)<=0)e=Math.round(e*1e4)/1e4;else e=Math.round(e*Math.pow(10,this.formatQuantity))/Math.pow(10,this.formatQuantity);return e};BX.Sale.Admin.OrderBasket.prototype.getDiscountCellId=function(e){return this.idPrefix+"sale-order-basket-product-"+e+"-discount-cell"};BX.Sale.Admin.OrderBasket.prototype.createDiscountCell=function(e,t){var i=BX.create("text",{html:"&nbsp"}),r=false,a=t.SKU_PROPS&&Object.keys(t.SKU_PROPS).length>0;if(this.discounts&&this.discounts.RESULT&&this.discounts.RESULT.BASKET){i=BX.Sale.Admin.OrderEditPage.createDiscountsNode(e,"BASKET",this.discounts.RESULT.BASKET[e]?this.discounts.RESULT.BASKET[e]:{},this.discounts,"VIEW");r=this.discounts.RESULT.BASKET[e]?true:false}var s=BX.create("td",{props:{id:this.getDiscountCellId()},children:[BX.create("div",{children:[i]})]});s.colSpan=this.columnsCount-1;if(a||r)s.style.borderTop="1px solid #ddd";return s};BX.Sale.Admin.OrderBasket.prototype.setIblocksSkuParamsOrder=function(e,t){if(!this.iblocksSkuParamsOrder)this.iblocksSkuParamsOrder={};if(!this.iblocksSkuParamsOrder[e])this.iblocksSkuParamsOrder[e]=[];if(t){for(var i in t){if(!t.hasOwnProperty(i))continue;var r=false;for(var a in this.iblocksSkuParamsOrder[e]){if(!this.iblocksSkuParamsOrder[e].hasOwnProperty(a))continue;if(this.iblocksSkuParamsOrder[e][a]==t[i]){r=true;break}}if(!r)this.iblocksSkuParamsOrder[e][i]=t[i]}}};BX.Sale.Admin.OrderBasket.prototype.setIblocksSkuParams=function(e,t){if(!this.iblocksSkuParams)this.iblocksSkuParams={};if(!this.iblocksSkuParams[e])this.iblocksSkuParams[e]={};if(t){for(var i in t){if(!t.hasOwnProperty(i))continue;if(this.iblocksSkuParams[e][i]!==undefined&&this.iblocksSkuParams[e][i]["VALUES"]!==undefined&&t[i]["VALUES"]!==undefined){for(var r in t[i]["VALUES"])if(t[i]["VALUES"].hasOwnProperty(r))this.iblocksSkuParams[e][i]["VALUES"][r]=t[i]["VALUES"][r]}else{this.iblocksSkuParams[e][i]=t[i]}}}};BX.Sale.Admin.OrderBasket.prototype.createProductRowBasement=function(e,t){if(!this.createProductBasement)return;var i=null,r=BX.create("tr",{props:{id:this.idPrefix+"sale-order-basket-product-"+e+"-basement",className:"bdb-line"}}),a=this.createProductBasementSkuCell(e,t),s=this.createDiscountCell(e,t);if(a&&s){r.appendChild(a);r.appendChild(s);i=r}return i};BX.Sale.Admin.OrderBasket.prototype.createProductBasementSkuCell=function(e,t){var i=this.createSkuPropsTable(e,t),r=null;if(i){r=BX.create("td",{children:[i]})}return r};BX.Sale.Admin.OrderBasket.prototype.createProductRowId=function(e,t){var i=this.idPrefix+"sale-order-basket-product-"+e;if(t){if(t.IS_SET_ITEM=="Y"&&t.PARENT_OFFER_ID)i+="-"+t.PARENT_OFFER_ID}return i};BX.Sale.Admin.OrderBasket.prototype.createProductRow=function(e,t){var i,r=BX.create("tbody",{props:{id:this.createProductRowId(e,t)},style:{textAlign:"left",borderBottom:"1px solid #DDD"}}),a=this.createMenuCell(e,t),s=BX.create("tr");if(a){if(this.createProductBasement)a.rowSpan=2;s.appendChild(a)}var d,o=[];if(t.IS_SET_ITEM!="Y"){o=this.createHiddenFields(e,t);this.products[e]=t;r.setAttribute("data-basket-code",e);if(t.IS_SET_PARENT&&t.OLD_PARENT_ID)r.setAttribute("data-old-parent-id-parent",t.OLD_PARENT_ID)}else{BX.addClass(r,"bundle-child-"+t.OLD_PARENT_ID);BX.addClass(r,"basket-bundle-child-hidden");BX.addClass(r,"bundle-child")}for(var n in this.visibleColumns){if(!this.visibleColumns.hasOwnProperty(n))continue;i=this.createProductCell(e,t,n);if(i){if(o)while(d=o.pop())i.appendChild(d);s.appendChild(i)}}s.setAttribute("onmouseover",this.objName+".onProductRowMouseOver(this);");s.setAttribute("onmouseout",this.objName+".onProductRowMouseOut(this);");r.appendChild(s);if(this.createProductBasement&&((t.SKU_PROPS||t.PROPS&&t.PROPS.length>0&&this.mode=="view")&&t.IS_SET_ITEM!="Y")||t.DISCOUNTS){var l=this.createProductRowBasement(e,t);if(l)r.appendChild(l)}return r};BX.Sale.Admin.OrderBasket.prototype.createHiddenFields=function(e,t){return[]};BX.Sale.Admin.OrderBasket.prototype.createMenuCell=function(e,t){var i,r=this.createProductMenuContent(e,t);if(r.length<=0)return false;if(t.IS_SET_ITEM!="Y"){i=BX.create("span",{props:{className:"adm-s-order-item-title-icon"}});BX.bind(i,"click",BX.proxy(function(e){i.blur();BX.adminList.ShowMenu(i,r)},this))}else{i=BX.create("span",{html:"&nbsp;"})}return BX.create("td",{props:{className:"tac bdb-line",id:this.idPrefix+"sale-order-basket-product-"+e+"-menu"},children:[i]})};BX.Sale.Admin.OrderBasket.prototype.onHeadMenu=function(e){BX.adminList.ShowMenu(e,[{ICON:"view",TEXT:BX.message("SALE_ORDER_BASKET_ROW_SETTINGS"),ACTION:this.objName+".onSettings()",DEFAULT:true}])};BX.Sale.Admin.OrderBasket.prototype.setRowNumbers=function(){if(!this.visibleColumns["NUMBER"])return;var e=BX(this.tableId),t="",i=null,r=1;for(var a=0,s=e.tBodies.length;a<s;a++){if(BX.hasClass(e.tBodies[a],"bundle-child"))continue;t=e.tBodies[a].getAttribute("data-basket-code");if(!t)continue;i=BX(this.idPrefix+"sale_order_product_"+t+"_number");if(i)i.innerHTML=r++;else BX.debug("BX.Sale.Admin.OrderBasket.prototype.setRowNumbers can't find: "+t)}};BX.Sale.Admin.OrderBasket.prototype.getPriceCellId=function(e){return this.idPrefix+"sale-order-basket-product-"+e+"-price-cell"};BX.Sale.Admin.OrderBasket.prototype.getProductSummCellId=function(e){return this.idPrefix+"sale_order_edit_product_"+e+"_summ"};BX.Sale.Admin.OrderBasket.prototype.getQuantityCellId=function(e){return this.idPrefix+"sale-order-basket-product-"+e+"-quantity-cell"};BX.Sale.Admin.OrderBasket.prototype.createProductCell=function(e,t,i){var r=null,a=[],s=t[i],d="",o=this,n=BX.type.isNotEmptyString(t.IS_SET_ITEM)&&t.IS_SET_ITEM==="Y",l=BX.type.isNotEmptyString(t.CAN_BUY)&&t.CAN_BUY==="Y";switch(i){case"NUMBER":a.push(BX.create("span",{props:{id:!n?this.idPrefix+"sale_order_product_"+e+"_number":"&nbsp;"},html:"&nbsp;"}));break;case"NAME":if(t.IS_SET_PARENT=="Y"&&t.SET_ITEMS){var u=BX.create("a",{props:{href:"javascript:void(0);",className:"dashed-link show-set-link"+(!l?" product-unavailable":""),title:!l?BX.message("SALE_ORDER_BASKET_PRODUCT_UNAVAILABLE"):""},html:BX.message("SALE_ORDER_BASKET_EXPAND")});BX.bind(u,"click",function(e){var i=e.target||e.srcElement;o.onToggleBundleChildren(t.OLD_PARENT_ID,i)});a.push(BX.create("div",{children:[u]}))}if(t.EDIT_PAGE_URL){if(!s)s=BX.message("SALE_ORDER_BASKET_NO_NAME");h=BX.create("a",{props:{href:t.EDIT_PAGE_URL,target:"_blank",className:!l?"product-unavailable":"",title:!l?BX.message("SALE_ORDER_BASKET_PRODUCT_UNAVAILABLE"):""},html:BX.util.htmlspecialchars(s)})}else{var c=t[i]?t[i]:BX.message("SALE_ORDER_BASKET_NO_NAME");h=BX.create("span",{style:{fontWeight:"bold"},html:BX.util.htmlspecialchars(c)})}a.push(h);if(t.RECOMMENDATION&&t.RECOMMENDATION.length>0)a.push(BX.create("div",{props:{className:"bx-adm-bigdata-icon-medium-inner"}}));break;case"QUANTITY":if(typeof t.MEASURE_TEXT!="undefined")a.push(document.createTextNode(" "+t.MEASURE_TEXT+" "));t["QUANTITY"]=this.roundQuantity(parseFloat(t["QUANTITY"]));if(n){h=BX.Sale.Admin.OrderBasket.prototype.createFieldQuantity(e,t,i);h.id=this.getQuantityCellId(e);a.push(h)}else{a.push(this.createFieldQuantity(e,t,i))}break;case"AVAILABLE":a.push(this.createTextField(e,t,i));break;case"PRICE":if(n){a.push(BX.Sale.Admin.OrderBasket.prototype.createFieldPrice(e,t,i))}else{var p=this.createFieldPrice(e,t,i);p.id=this.getPriceCellId(e);a.push(p)}break;case"SUM":var S;if(typeof this.customPrices[e]=="undefined")S=t.PRICE;else S=this.customPrices[e];var E=S*t.QUANTITY;a.push(BX.create("strong",{props:{id:this.getProductSummCellId(e)},html:BX.Sale.Admin.OrderEditPage.currencyFormat(E),style:{whiteSpace:"nowrap"}}));break;case"IMAGE":a.push(this.createFieldImage(e,t,i));d="adm-s-order-table-ddi-table-img";break;case"PROPS":var h=this.createFieldSkuProps(e,t,i);if(h)a.push(h);break}if(i.indexOf("PROPERTY_")===0){var B="",f=i.substr("PROPERTY_".length);if(t.PRODUCT_PROPS_VALUES&&t.PRODUCT_PROPS_VALUES[i+"_VALUE"]){var O=[t.OFFERS_IBLOCK_ID,t.IBLOCK_ID];for(var P in O){if(!O.hasOwnProperty(P))continue;var m=O[P];if(!m)continue;if(this.iblocksSkuParams[m]){for(var _ in this.iblocksSkuParams[m]){if(!this.iblocksSkuParams[m].hasOwnProperty(_))continue;if(this.iblocksSkuParams[m][_].CODE!=f)continue;if(!this.iblocksSkuParams[m][_].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]])continue;if(this.iblocksSkuParams[m][_].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]]["NAME"]&&this.iblocksSkuParams[m][_].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]]["NAME"].length>0){B=this.iblocksSkuParams[m][_].VALUES[t.PRODUCT_PROPS_VALUES[i+"_VALUE"]]["NAME"]}else{B=t.PRODUCT_PROPS_VALUES[i+"_VALUE"]}if(B)B=BX.util.htmlspecialchars(B);break}if(B.length>0)break}}if(B.length<=0)B=t.PRODUCT_PROPS_VALUES[i+"_VALUE"]}else{B=""}a.push(BX.create("span",{html:B}))}if(a.length>0){r=BX.create("td");if(d)BX.addClass(r,d);while(a.length>0)r.appendChild(a.pop());if(i=="NAME"){r.style.minWidth="250px";if(n){r.style.fontStyle="italic";r.style.paddingLeft="40px"}}}return r};BX.Sale.Admin.OrderBasket.prototype.onToggleBundleChildren=function(e,t){if(t.innerHTML==BX.message("SALE_ORDER_BASKET_TURN"))t.innerHTML=BX.message("SALE_ORDER_BASKET_EXPAND");else t.innerHTML=BX.message("SALE_ORDER_BASKET_TURN");var i=BX.findChildren(BX(this.tableId),{className:"bundle-child-"+e},true);for(var r in i)if(i.hasOwnProperty(r))BX.toggleClass(i[r],"basket-bundle-child-hidden")};BX.Sale.Admin.OrderBasket.prototype.createFieldSkuProps=function(e,t,i){return this.createSkuPropsTable(e,t)};BX.Sale.Admin.OrderBasket.prototype.createSkuPropsTable=function(e,t){var i=BX.create("table"),r,a=0,s=[];if(t.SKU_PROPS){for(var d in t.SKU_PROPS){if(!t.SKU_PROPS.hasOwnProperty(d))continue;if(!t.SKU_PROPS[d]["VALUE"])continue;if(t.SKU_PROPS[d]["VALUE"]["ID"]=="-")continue;if(t.SKU_PROPS[d]["VALUE"]&&t.SKU_PROPS[d]["VALUE"]["PICT"]){r='<div style="width: 17px; height: 17px; text-align: center; border: 1px solid gray;">'+'<img  width="17" height="17" src="'+t.SKU_PROPS[d]["VALUE"]["PICT"]+'">'+"</div>"}else{if(!t.SKU_PROPS[d]["VALUE"]["NAME"])t.SKU_PROPS[d]["VALUE"]["NAME"]=d;r='<div style="font-size: 9px; padding: 2px 5px; text-align: center; border: 1px solid gray;">'+BX.util.htmlspecialchars(t.SKU_PROPS[d]["VALUE"]["NAME"])+"</div>"}if(!t.SKU_PROPS[d]["NAME"])t.SKU_PROPS[d]["NAME"]=d;i.appendChild(BX.create("tr",{children:[BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+BX.util.htmlspecialchars(t.SKU_PROPS[d]["NAME"])+": </span>"}),BX.create("td",{html:r})]}));s.push(t.SKU_PROPS[d]["CODE"]);a++}}if(t.PROPS){for(var o in t.PROPS){if(!t.PROPS.hasOwnProperty(o))continue;if(!t.PROPS[o]||s.indexOf(t.PROPS[o]["CODE"])!=-1)continue;if(!t.PROPS[o]["NAME"])t.PROPS[o]["NAME"]="";if(!t.PROPS[o]["VALUE"])t.PROPS[o]["VALUE"]="";var n=BX.create("tr",{children:[BX.create("td",{html:'<span style="color: gray; font-size: 11px">'+BX.util.htmlspecialchars(t.PROPS[o]["NAME"])+": </span>"}),BX.create("td",{html:'<div style="font-size: 9px; padding: 2px 5px; text-align: center;">'+BX.util.htmlspecialchars(t.PROPS[o]["VALUE"])+"</div>"})]});if(!this.isShowXmlId&&(t.PROPS[o]["CODE"]=="PRODUCT.XML_ID"||t.PROPS[o]["CODE"]=="CATALOG.XML_ID"))n.style.display="none";i.appendChild(n);a++}}return i};BX.Sale.Admin.OrderBasket.prototype.createFieldQuantity=function(e,t,i){return this.createTextField(e,t,i)};BX.Sale.Admin.OrderBasket.prototype.createFieldImage=function(e,t,i){var r,a;if(t.PICTURE_URL){r=BX.create("img",{props:{src:t.PICTURE_URL}})}else{r=BX.create("div",{props:{className:"no_foto"},text:BX.message("SALE_ORDER_BASKET_NO_PICTURE")})}if(typeof t.EDIT_PAGE_URL!="undefined"){a=BX.create("a",{props:{href:t.EDIT_PAGE_URL?t.EDIT_PAGE_URL:"",target:"_blank"},children:[r]});a.style.textAlign=this.mode=="edit"?"left":"center"}else{a=BX.create("div",{style:{width:"150px",textAlign:this.mode=="edit"?"left":"center"},children:[r]})}return a};BX.Sale.Admin.OrderBasket.prototype.createFieldPrice=function(e,t,i){var r=BX.create("span",{props:{className:"view_price"}}),a="";if(typeof t.PRICE!="undefined"){a=BX.Sale.Admin.OrderEditPage.currencyFormat(t.PRICE)}r.appendChild(BX.create("div",{html:a,style:{whiteSpace:"nowrap"}}));if(a!=""){var s="none";if(parseFloat(t.BASE_PRICE)>0&&parseFloat(t.PRICE)!=parseFloat(t.BASE_PRICE))s="";var d=BX.create("div",{props:{className:"base_price"},style:{display:s},children:[BX.create("span",{html:BX.Sale.Admin.OrderEditPage.currencyFormat(t.BASE_PRICE)})]}),o=BX.create("div",{props:{className:"base_price_title"},style:{display:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"||t.NOTES?"":"none"},text:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"?BX.message("SALE_ORDER_BASKET_BASE_CATALOG_PRICE"):t.NOTES});r.appendChild(d);r.appendChild(o)}return r};BX.Sale.Admin.OrderBasket.prototype.createTextField=function(e,t,i){var r=typeof t[i]!="undefined"?t[i]:"";return BX.create("span",{text:r+" "})};BX.Sale.Admin.OrderBasket.prototype.onSettings=function(){this.settingsDialog.show()};BX.Sale.Admin.OrderBasket.prototype.createProductMenuContent=function(e,t){return[]};BX.Sale.Admin.OrderBasket.prototype.onProductRowMouseOver=function(e){BX.addClass(e,"tr_hover")};BX.Sale.Admin.OrderBasket.prototype.onProductRowMouseOut=function(e){BX.removeClass(e,"tr_hover")};BX.Sale.Admin.OrderBasketEdit=function(e){this.productEditDialog=new BX.Sale.Admin.OrderBasketProductEditDialog(this);BX.Sale.Admin.OrderBasket.call(this,e);this.settingsDialog=new BX.Sale.Admin.OrderBasket.SettingsDialog({basket:this})};BX.Sale.Admin.OrderBasketEdit.prototype=Object.create(BX.Sale.Admin.OrderBasket.prototype);BX.Sale.Admin.OrderBasketEdit.prototype.getProductIdBySkuProps=function(e){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.getProductIdBySkuProps(e))};BX.Sale.Admin.OrderBasketEdit.prototype.setBasket=function(e){if(!e)return;var t,i;if(e.IBLOCKS_SKU_PARAMS)for(t in e.IBLOCKS_SKU_PARAMS)if(e.IBLOCKS_SKU_PARAMS.hasOwnProperty(t))this.setIblocksSkuParams(t,e.IBLOCKS_SKU_PARAMS[t]);if(e.IBLOCKS_SKU_PARAMS_ORDER)for(t in e.IBLOCKS_SKU_PARAMS_ORDER)if(e.IBLOCKS_SKU_PARAMS_ORDER.hasOwnProperty(t))this.setIblocksSkuParamsOrder(t,e.IBLOCKS_SKU_PARAMS_ORDER[t]);if(typeof e.WEIGHT_FOR_HUMAN!=="undefined")this.totalBlock.setFieldValue("WEIGHT",e.WEIGHT_FOR_HUMAN);if(e.PRICES_UPDATED&&e.PRICES_UPDATED.length>0){for(t in e.PRICES_UPDATED)if(e.PRICES_UPDATED.hasOwnProperty(t))this.updateProductPriceCell(e.ITEMS[t]);for(t in e.ITEMS)if(e.ITEMS.hasOwnProperty(t))this.updateProductDiscountsCell(e.ITEMS[t]);if(e.NEW_ITEM_BASKET_CODE&&e.ITEMS[e.NEW_ITEM_BASKET_CODE])this.productSet(e.ITEMS[e.NEW_ITEM_BASKET_CODE],true)}else if(e.LIGHT&&e.LIGHT=="Y"){for(t in this.products){if(!this.products.hasOwnProperty(t))continue;if(typeof e.ITEMS[t]=="undefined")this.productDelete(t)}if(e.ADDED_PRODUCTS){for(t in e.ADDED_PRODUCTS){if(e.ADDED_PRODUCTS.hasOwnProperty(t)){this.productSet(e.ITEMS[e.ADDED_PRODUCTS[t]],true);delete e.ITEMS[e.ADDED_PRODUCTS[t]]}}}if(e.ITEMS){for(t in e.ITEMS)if(e.ITEMS.hasOwnProperty(t))this.productUpdateLight(e.ITEMS[t])}}else if(e.ITEMS_ORDER&&e.ITEMS_ORDER.length){for(t in this.products)if(this.products.hasOwnProperty(t))this.productDelete(t);for(t=0,i=e.ITEMS_ORDER.length-1;t<=i;t++)this.productSet(e.ITEMS[e.ITEMS_ORDER[t]],true)}if(!e.ITEMS||!e.ITEMS_ORDER||!e.ITEMS_ORDER.length){this.showEmptyRow()}this.hideLoadingRow()};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductPriceCell=function(e){var t=this.getProductBasketCode(e),i=this.getPriceCellId(t),r=BX(i);if(!r)return;var a=this.createFieldPrice(t,e),s=r.parentNode;s.removeChild(r);s.appendChild(a);a.id=i;this.updateBasePrice(t,e);this.updateProviderData(t,e);this.updateProductSumm(t)};BX.Sale.Admin.OrderBasketEdit.prototype.updateBasePrice=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm();var r=i.elements[this.getFieldName(e,"BASE_PRICE")];if(r)r.value=t.BASE_PRICE;var a=i.elements[this.getFieldName(e,"PRICE_BASE")];if(a)a.value=t.PRICE_BASE};BX.Sale.Admin.OrderBasketEdit.prototype.updateProviderData=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm(),r=i.elements[this.getFieldName(e,"PROVIDER_DATA")];if(r)r.value=t.PROVIDER_DATA};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductDiscountsCell=function(e){var t=this.getProductBasketCode(e),i=this.getDiscountCellId(t),r=BX(i);if(!r)return;var a=this.createDiscountCell(t,e),s=r.parentNode;s.removeChild(r);s.appendChild(a);a.id=i};BX.Sale.Admin.OrderBasketEdit.prototype.productUpdateLight=function(e){var t=this.getProductBasketCode(e),i;e["NOTES"]=this.products[t]["NOTES"];this.updateProductPriceCell(e);this.updateProductDiscountsCell(e);this.canSendUpdateQuantityRequest=false;if(this.getProductQuantity(t)!=e["QUANTITY"])this.setProductQuantity(t,e["QUANTITY"]);if(this.getCustomPrice(t)!=e["CUSTOM_PRICE"])this.setCustomPrice(t,e["CUSTOM_PRICE"]);for(i in e)if(e.hasOwnProperty(i))this.products[t][i]=e[i];if(e.SET_ITEMS)for(i in e.SET_ITEMS)if(e.SET_ITEMS.hasOwnProperty(i))this.updateSetQuantity(e.SET_ITEMS[i],t);this.canSendUpdateQuantityRequest=true};BX.Sale.Admin.OrderBasketEdit.prototype.updateSetQuantity=function(e,t){var i="set_"+t+"_"+e.OFFER_ID,r=BX(this.getQuantityCellId(i)),a=BX(this.getProductSummCellId(i));if(r)r.innerHTML=e.QUANTITY;if(a)a.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(e.QUANTITY*e.PRICE)};BX.Sale.Admin.OrderBasketEdit.prototype.setCustomPrice=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm();i.elements[this.getFieldName(e,"CUSTOM_PRICE")].value=t};BX.Sale.Admin.OrderBasketEdit.prototype.getCustomPrice=function(e){var t=BX.Sale.Admin.OrderEditPage.getForm();return t.elements[this.getFieldName(e,"CUSTOM_PRICE")].value};BX.Sale.Admin.OrderBasketEdit.prototype.getParamsBySkuProps=function(e){var t=false;if(this.customPrices[e.replaceBasketCode]!==undefined)t=this.customPrices[e.replaceBasketCode];BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.addProductToBasketBySkuProps({oldProductId:e.oldProductId,oldProductIblock:e.oldProductIblock,quantity:e.quantity,replaceBasketCode:e.replaceBasketCode,skuPropsVal:e.skuPropsVal,columns:this.visibleColumns,customPrice:t}))};BX.Sale.Admin.OrderBasketEdit.prototype.getParamsByProductId=function(e,t,i){var r=false;if(this.customPrices[e.replaceBasketCode]!==undefined)r=this.customPrices[e.replaceBasketCode];BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.addProductToBasket(e.id,e.quantity,e.replaceBasketCode,this.visibleColumns,r))};BX.Sale.Admin.OrderBasketEdit.prototype.createProductBasementSkuCell=function(e,t){var i=BX.create("td",{props:{id:this.idPrefix+"sale-order-basket-product-"+e+"-basement-sku"}}),r=BX.create("div",{props:{className:"adm-s-order-table-ddi-table-sku"}}),a=t.SKU_PROPS_POSSIBLE_VALUES,s,d;for(var o in this.iblocksSkuParamsOrder[t.OFFERS_IBLOCK_ID]){if(!this.iblocksSkuParamsOrder[t.OFFERS_IBLOCK_ID].hasOwnProperty(o))continue;var n=this.iblocksSkuParamsOrder[t.OFFERS_IBLOCK_ID][o];if(!a[n])continue;s=this.iblocksSkuParams[t.OFFERS_IBLOCK_ID][n]["NAME"];d=t.SKU_PROPS[n]["VALUE"]["ID"];r.appendChild(this.createSkuSelector(e,n,s,d,a[n],t))}i.appendChild(r);return i};BX.Sale.Admin.OrderBasketEdit.prototype.createSkuSelector=function(e,t,i,r,a,s){var d=BX.create("ul",{attrs:{"data-sku-id":t}}),o="sku",n=0,l=0;for(var u in this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["ORDER"]){if(!this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["ORDER"].hasOwnProperty(u))continue;var c=this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["ORDER"][u],p=false;for(var S in a){if(!a.hasOwnProperty(S))continue;if(a[S]==this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["VALUES"][c]["ID"]){p=true;break}}if(!p)continue;var E,h=this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["VALUES"][c]["ID"],B=BX.util.htmlspecialchars(this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["VALUES"][c]["NAME"]);if(this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["VALUES"][c]["PICT"]){E='<img  src="'+this.iblocksSkuParams[s.OFFERS_IBLOCK_ID][t]["VALUES"][c]["PICT"]+'">'}else{o="size";E=B}var f=BX.create("span",{props:{className:"cnt",title:B},html:E}),O=BX.create("li",{attrs:{"data-value":BX.util.htmlspecialchars(c),"data-id":h},children:[f]});if(h==r){BX.addClass(O,"bx-active");l=n}d.appendChild(O);BX.bind(f,"click",BX.delegate(function(i){var a=i.target||i.srcElement,o=a.parentNode.getAttribute("data-value")||a.parentNode.parentNode.getAttribute("data-value"),n=a.parentNode.getAttribute("data-id")||a.parentNode.parentNode.getAttribute("data-id"),l=this.getSkuProps(e,s.SKU_PROPS);o=BX.util.htmlspecialcharsback(o);if(n==r)return;l[t]=n;this.getProductIdBySkuProps({productId:s.PRODUCT_ID,iBlockId:s.OFFERS_IBLOCK_ID,skuProps:l,skuOrder:this.iblocksSkuParamsOrder[s.OFFERS_IBLOCK_ID],changedSkuId:t,callback:BX.delegate(function(i){if(!i.OFFER_ID){BX.debug("can't find product id for set of sku props");return}var r=i.OFFER_ID;for(var a in this.products){if(!this.products.hasOwnProperty(a))continue;if(a==e)continue;if(this.products[a].OFFER_ID==r)if(!confirm(BX.message("SALE_ORDER_BASKET_POSITION_EXISTS").replace("#NAME#",this.products[a].NAME)))return}this.onSkuSelectorClick(e,d,t,o,n);this.onSkuPropSelect(e,r)},this)})},this));n++}var P=BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box-arrow left"},events:{click:BX.delegate(function(){this.skuSelectorScrollLeft(d,n)},this)}}),m=BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box-arrow right"},events:{click:BX.delegate(function(){this.skuSelectorScrollRight(d,n)},this)}});var _=BX.create("div",{props:{className:"adm-s-item-detail-sku"},children:[BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-title"},text:i}),P,m,BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box"},children:[BX.create("div",{props:{className:"adm-s-item-detail-"+o+"-box-container"},children:[d,BX.create("input",{props:{type:"hidden",name:this.getFieldName(e,"SKU")+"["+t+"]",value:r}})]})]})]});var A=-1*this.skuSelectorCountScrollOffset(l,n);this.skuSelectorSetScroll(d,A);this.skuSelectorSetArrowsVisibility(d,A,n);return _};BX.Sale.Admin.OrderBasketEdit.prototype.getFieldsUpdaters=function(){return{TOTAL_PRICES:{context:this,callback:this.setTotalPrices},BASKET:{context:this,callback:this.setBasket},SUM_PAID:{context:this,callback:this.setSumPaid},PAYABLE:{context:this,callback:this.setSumUnPaid},TAX_VALUE:{context:this,callback:this.setTaxValue},DELIVERY_PRICE:{context:this,callback:this.setDeliveryPrice},DELIVERY_PRICE_DISCOUNT:{context:this,callback:this.setDeliveryPriceDiscount},"SHIPMENT[1][PRICE_DELIVERY]":{context:this,callback:this.setDeliveryPrice},COUPONS_LIST:{context:this,callback:this.setCoupons},DISCOUNTS_LIST:{context:this,callback:this.setDiscounts}}};BX.Sale.Admin.OrderBasketEdit.prototype.getProductPrice=function(e){var t=BX.Sale.Admin.OrderEditPage.getForm();return t.elements[this.getFieldName(e,"PRICE")].value};BX.Sale.Admin.OrderBasketEdit.prototype.setCoupons=function(e){return BX.Sale.Admin.OrderBasketCoupons.setCoupons(e)};BX.Sale.Admin.OrderBasketEdit.prototype.getProductQuantity=function(e){var t=BX.Sale.Admin.OrderEditPage.getForm();return t.elements[this.getFieldName(e,"QUANTITY")].value};BX.Sale.Admin.OrderBasketEdit.prototype.setProductQuantity=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm(),r=i.elements[this.getFieldName(e,"QUANTITY")];if(!t||t<0)t=0;else t=this.roundQuantity(t);if(r)r.value=t;this.onProductQuantityChange({productId:e});return t};BX.Sale.Admin.OrderBasketEdit.prototype.setProductPrice=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm(),r=i.elements[this.getFieldName(e,"PRICE")],a=i.elements[this.getFieldName(e,"BASE_PRICE")],s=BX(this.idPrefix+"sale-order-basket-product-"+e+"-base_price"),d=BX(this.idPrefix+"sale-order-basket-product-"+e+"-formatted_price");t=parseFloat(t);if(!t||t<0)t=0;else t=parseFloat(t);if(r)r.value=t;if(d)d.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(t);if(this.products[e].CUSTOM_PRICE=="Y")this.customPrices[e]=t;else delete this.customPrices[e];if(a&&s){var o=parseFloat(a.value);if(o>0&&o!=t){s.style.display=""}else{s.style.display="none"}}this.onProductPriceChange({productId:e});return t};BX.Sale.Admin.OrderBasketEdit.prototype.onProductQuantityChange=function(e){var t=this.getFieldName(e.productId,"QUANTITY"),i=this,r=this.canSendUpdateQuantityRequest;clearTimeout(this.qantityUpdaterTimeout);this.qantityUpdaterTimeout=setTimeout(function(){var a=i.canSendUpdateQuantityRequest;i.canSendUpdateQuantityRequest=r;BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater(t,e.productId);i.canSendUpdateQuantityRequest=a},this.qantityUpdaterDelay)};BX.Sale.Admin.OrderBasketEdit.prototype.onProductPriceChange=function(e){BX.Sale.Admin.OrderEditPage.callConcreteFieldUpdater(this.getFieldName(e.productId,"PRICE"),e.productId)};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductQuantity=function(e){this.updateProductSumm(e);if(this.canSendUpdateQuantityRequest){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"FIELD_UPDATE",updatedFieldId:"QUANTITY",productId:e}))}};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductPrice=function(e){this.updateProductSumm(e);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"FIELD_UPDATE",updatedFieldId:"PRICE",productId:e}))};BX.Sale.Admin.OrderBasketEdit.prototype.updateProductSumm=function(e){var t=BX(this.getProductSummCellId(e));if(!t)return;t.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(this.getProductPrice(e)*this.getProductQuantity(e))};BX.Sale.Admin.OrderBasketEdit.prototype.setTotalPrices=function(e){this.totalBlock.setFieldValue("PRICE_BASKET",e.PRICE_BASKET);this.totalBlock.setFieldValue("PRICE_BASKET_DISCOUNTED",e.PRICE_BASKET_DISCOUNTED);this.totalBlock.setFieldValue("PRICE_DELIVERY",e.PRICE_DELIVERY);this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",e.PRICE_DELIVERY_DISCOUNTED);this.totalBlock.setFieldValue("TAX_VALUE",e.TAX_VALUE);this.totalBlock.setFieldValue("SUM_PAID",e.SUM_PAID);this.totalBlock.setFieldValue("SUM_UNPAID",e.SUM_UNPAID)};BX.Sale.Admin.OrderBasketEdit.prototype.setDeliveryPrice=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY",e)};BX.Sale.Admin.OrderBasketEdit.prototype.setDeliveryPriceDiscount=function(e){this.totalBlock.setFieldValue("PRICE_DELIVERY_DISCOUNTED",e)};BX.Sale.Admin.OrderBasketEdit.prototype.setTaxValue=function(e){this.totalBlock.setFieldValue("TAX_VALUE",e)};BX.Sale.Admin.OrderBasketEdit.prototype.addProductSearch=function(e){var t=this.objName+".getParamsByProductId";window[t]=BX.proxy(function(e,t){this.getParamsByProductId(e,t)},this);var i=new BX.CDialog({content_url:"/bitrix/tools/sale/product_search_dialog.php?"+"lang="+BX.Sale.Admin.OrderEditPage.languageId+"&LID="+BX.Sale.Admin.OrderEditPage.siteId+"&caller=order_edit"+"&func_name="+t+"&STORE_FROM_ID=0",height:Math.max(500,window.innerHeight-400),width:Math.max(800,window.innerWidth-400),draggable:true,resizable:true,min_height:500,min_width:800});BX.addCustomEvent(i,"onWindowRegister",BX.defer(function(){i.Get().style.position="fixed";i.Get().style.top=parseInt(i.Get().style.top)-BX.GetWindowScrollPos().scrollTop+"px"}));i.Show()};BX.Sale.Admin.OrderBasketEdit.prototype.getCoupons=function(){var e=BX.Sale.Admin.OrderEditPage.getForm();return e.elements["COUPONS"].value};BX.Sale.Admin.OrderBasketEdit.prototype.onSkuPropSelect=function(e,t){this.getParamsByProductId({id:t,quantity:this.getProductQuantity(e),replaceBasketCode:e},0)};BX.Sale.Admin.OrderBasketEdit.prototype.getSkuProps=function(e,t){var i={},r=BX.Sale.Admin.OrderEditPage.getForm();for(var a in t){if(!t.hasOwnProperty(a))continue;var s=this.getFieldName(e,"SKU")+"["+a+"]";if(typeof r.elements[s]!="undefined")i[a]=r.elements[s].value}return i};BX.Sale.Admin.OrderBasketEdit.prototype.getFieldName=function(e,t){return"PRODUCT["+e+"]["+t+"]"};BX.Sale.Admin.OrderBasketEdit.prototype.productDeleteClick=function(e){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"PRODUCT_DELETE",basketCode:e}))};BX.Sale.Admin.OrderBasketEdit.prototype.productDelete=function(e){var t=BX(this.createProductRowId(e));if(!t)return;var i=t.getAttribute("data-old-parent-id-parent");if(i){var r=BX.findChildren(t.parentNode,{className:"bundle-child-"+i},false);for(var a in r)if(r.hasOwnProperty(a))r[a].parentNode.removeChild(r[a])}this.onProductDelete(e);t.parentNode.removeChild(t);this.setRowNumbers();this.setProductsCount(--this.productsCount);if(this.productsCount<=0)this.showEmptyRow();if(this.customPrices[e])delete this.customPrices[e];delete this.products[e]};BX.Sale.Admin.OrderBasketEdit.prototype.onSkuSelectorClick=function(e,t,i,r,a){for(var s=0,d=t.children.length;s<d;s++){var o=t.children[s];if(o.getAttribute("data-value")!=BX.util.htmlspecialchars(r))BX.removeClass(o,"bx-active");else BX.addClass(o,"bx-active")}this.setSkuInput(e,i,a)};BX.Sale.Admin.OrderBasketEdit.prototype.setSkuInput=function(e,t,i){var r=this.getFieldName(e,"SKU")+"["+t+"]",a=BX.Sale.Admin.OrderEditPage.getForm();a.elements[r].value=i};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorSetArrowsVisibility=function(e,t,i){var r=e.parentNode.parentNode.parentNode.childNodes[1];if(i<=5||t>=0)r.style.display="none";else r.style.display="";var a=e.parentNode.parentNode.parentNode.childNodes[2];if(i<=5||t<=5-i)a.style.display="none";else a.style.display=""};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorScrollLeft=function(e,t){var i=this.skuSelectorGetScrollOffset(e);if(i>=0)return false;this.skuSelectorSetScroll(e,++i);this.skuSelectorSetArrowsVisibility(e,i);return true};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorScrollRight=function(e,t){var i=this.skuSelectorGetScrollOffset(e);if(i<=5-t)return false;this.skuSelectorSetScroll(e,--i);this.skuSelectorSetArrowsVisibility(e,i,t);return true};BX.Sale.Admin.OrderBasketEdit.prototype.createDiscountCell=function(e,t){var i=BX.create("text",{html:"&nbsp"}),r=false,a=t.SKU_PROPS&&Object.keys(t.SKU_PROPS).length>0;if(this.discounts&&this.discounts.RESULT&&this.discounts.RESULT.BASKET){i=BX.Sale.Admin.OrderEditPage.createDiscountsNode(e,"BASKET",this.discounts.RESULT.BASKET[e]?this.discounts.RESULT.BASKET[e]:{},this.discounts,"EDIT");r=this.discounts.RESULT.BASKET[e]?true:false}var s=BX.create("td",{props:{id:this.getDiscountCellId(e)},children:[BX.create("div",{children:[i]})]});s.colSpan=this.columnsCount-1;if(a||r)s.style.borderTop="1px solid #ddd";return s};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorCountScrollOffset=function(e,t){var i=0;e=e+1;if(t>5&&e>2){var r=t-e;i=e-3;if(r<2)i=i-(2-r)}return i};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorGetStepSize=function(){return 30};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorGetScrollOffset=function(e){if(!e)return false;var t=parseInt(e.style.marginLeft,10);if(!t)t=0;else t=parseInt(t/this.skuSelectorGetStepSize(),10);return t};BX.Sale.Admin.OrderBasketEdit.prototype.skuSelectorSetScroll=function(e,t){e.style.marginLeft=t*this.skuSelectorGetStepSize()+"px"};BX.Sale.Admin.OrderBasketEdit.prototype.onCouponsRecount=function(){BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"COUPONS_RECOUNT"}))};BX.Sale.Admin.OrderBasketEdit.prototype.createProductMenuContent=function(e){return[{ICON:"view",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_EDIT"),ACTION:this.objName+'.productEdit("'+e+'")',DEFAULT:true},{ICON:"delete",TEXT:BX.message("SALE_ORDER_BASKET_PROD_MENU_DELETE"),ACTION:this.objName+'.productDeleteClick("'+e+'")'}]};BX.Sale.Admin.OrderBasketEdit.prototype.productEdit=function(e){this.productEditDialog.show(e)};BX.Sale.Admin.OrderBasketEdit.prototype.createMeasureRatioNode=function(e,t,i){if(!BX.type.isElementNode(t))return null;if(!i||i==1)return null;var r=BX.create("a",{props:{href:"javascript:void(0);",title:BX.message("SALE_ORDER_BASKET_UP_RATIO").replace("#RATIO#",i),className:"plus"}}),a=BX.create("a",{props:{href:"javascript:void(0);",title:BX.message("SALE_ORDER_BASKET_DOWN_RATIO").replace("#RATIO#",i),className:"minus"}}),s=this;BX.bind(r,"click",function(r){t.value=s.roundQuantity(parseFloat(t.value)+parseFloat(i));s.onProductQuantityChange({productId:e})});BX.bind(a,"click",function(r){t.value=s.roundQuantity(parseFloat(t.value)-parseFloat(i));s.onProductQuantityChange({productId:e})});return BX.create("div",{props:{className:"quantity_control"},children:[r,a],style:{position:"inherit",marginLeft:"3px"}})};BX.Sale.Admin.OrderBasketEdit.prototype.createFieldQuantity=function(e,t,i){var r=typeof t.MEASURE_RATIO!="undefined"?t.MEASURE_RATIO:1,a={},s,d=this,o=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"QUANTITY"),value:this.roundQuantity(t.QUANTITY),className:"tac"},style:{width:"60px"}}),n=this.createMeasureRatioNode(e,o,r);BX.bind(o,"focus",function(t){var i=o.value;BX.Sale.Admin.OrderEditPage.addRollbackMethod(function(){var t=d.canSendUpdateQuantityRequest;d.canSendUpdateQuantityRequest=false;d.setProductQuantity(e,i);setTimeout(function(){d.canSendUpdateQuantityRequest=t},1)})});BX.bind(o,"change",function(t){d.setProductQuantity(e,o.value)});BX.bind(o,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)o.blur()});a[this.getFieldName(e,"QUANTITY")]={callback:d.updateProductQuantity,context:d};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(a);if(n){s=BX.create("span",{children:[o,n],style:{display:"inline-flex"}})}else{s=o}return s};BX.Sale.Admin.OrderBasketEdit.prototype.createFieldPrice=function(e,t,i){var r;if(typeof this.customPrices[e]=="undefined")r=t.PRICE;else r=this.customPrices[e];var a={},s=this,d=BX.create("input",{props:{type:"text",name:this.getFieldName(e,"PRICE"),value:r,maxlength:"9",size:5}}),o=BX.create("span",{props:{className:"edit_price_product"},children:[d]}),n=BX.create("span",{props:{className:"formated_price",id:this.idPrefix+"sale-order-basket-product-"+e+"-formatted_price"},html:BX.Sale.Admin.OrderEditPage.currencyFormat(r),style:{whiteSpace:"nowrap"}}),l=BX.create("span",{props:{className:"default_price_product"},children:[n]}),u=BX.create("span",{text:""}),c=BX.create("a",{props:{href:"javascript:void(0);"},children:[BX.create("span",{props:{className:"pencil"}})]}),p=BX.create("div",{props:{className:"base_price",id:this.idPrefix+"sale-order-basket-product-"+e+"-base_price"},style:{display:parseFloat(t.BASE_PRICE)>0&&parseFloat(t.PRICE)!=parseFloat(t.BASE_PRICE)?"":"none"},children:[BX.create("span",{html:BX.Sale.Admin.OrderEditPage.currencyFormat(t.BASE_PRICE)})]}),S=BX.create("div",{props:{className:"base_price_title"},style:{display:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"||t.NOTES?"":"none"},text:t.CUSTOM_PRICE&&t.CUSTOM_PRICE=="Y"?BX.message("SALE_ORDER_BASKET_BASE_CATALOG_PRICE"):t.NOTES}),E=BX.create("span",{props:{className:"edit_price"},children:[l,o,u,c,p,S]});d.style.width="60px";BX.bind(c,"click",function(e){s.onPriceEditEnable(E,d)});BX.bind(n,"click",function(e){s.onPriceEditEnable(E,d)});BX.bind(d,"change",function(t){var i=BX.Sale.Admin.OrderEditPage.getForm();i.elements[s.getFieldName(e,"CUSTOM_PRICE")].value="Y";var r=s.setProductPrice(e,d.value);n.innerHTML=BX.Sale.Admin.OrderEditPage.currencyFormat(r)});BX.bind(d,"keydown",function(e){if(!e)e=window.event;if(!e)return;if(e.keyCode==13)d.blur()});BX.bind(d,"blur",function(e){s.onPriceEditDisable(E)});a[this.getFieldName(e,"PRICE")]={callback:s.updateProductPrice,context:s};BX.Sale.Admin.OrderEditPage.registerFieldsUpdaters(a);return E};BX.Sale.Admin.OrderBasketEdit.prototype.createDiscountsNodeBasket=function(e){return BX.Sale.Admin.OrderEditPage.createDiscountsNode("","DISCOUNT_LIST",e,this.discounts,"EDIT")};BX.Sale.Admin.OrderBasketEdit.prototype.getHiddenFieldsNames=function(){return["CURRENCY","PRODUCT_PROVIDER_CLASS","NAME","DETAIL_PAGE_URL","WEIGHT","CATALOG_XML_ID","NOTES","PRODUCT_XML_ID","OFFER_ID","MODULE","CUSTOM_PRICE","IS_SET_ITEM","IS_SET_PARENT","MEASURE_CODE"]};BX.Sale.Admin.OrderBasketEdit.prototype.createHiddenFields=function(e,t){var i=[];if(typeof t["CUSTOM_PRICE"]=="undefined")t["CUSTOM_PRICE"]="N";for(var r in t){if(!t.hasOwnProperty(r))continue;if(!t[r]&&r!="CATALOG_XML_ID")continue;if(r=="PROPS"){i.push(BX.create("span",{html:this.createSkuPropsHiddenHtml(e,t["PROPS"],t.IS_SET_ITEM,"PROPS")}));continue}if(r=="SKU_PROPS"){i.push(BX.create("span",{html:this.createSkuPropsHiddenHtml(e,t["SKU_PROPS"],t.IS_SET_ITEM,"SKU_PROPS")}));continue}if(typeof t[r]=="object")continue;if(r=="PRICE"||r=="QUANTITY")continue;i.push(BX.create("input",{props:{type:"hidden",name:this.getFieldName(e,r),value:t[r]}}))}return i};BX.Sale.Admin.OrderBasketEdit.prototype.createSkuPropsHiddenHtml=function(e,t,i,r){if(!t)return"";var a=0,s=this.getFieldName(e,r),d=[],o="";if(t){for(var n in t){if(!t.hasOwnProperty(n))continue;if(!t[n]||d.indexOf(t[n]["CODE"])!=-1)continue;if(i!="Y"){var l=t[n]["NAME"]?BX.util.htmlspecialchars(t[n]["NAME"]):"",u=t[n]["VALUE"]?BX.util.htmlspecialchars(t[n]["VALUE"]):"",c=t[n]["CODE"]?BX.util.htmlspecialchars(t[n]["CODE"]):"",p=t[n]["SORT"]?BX.util.htmlspecialchars(t[n]["SORT"]):100,S=t[n]["ID"]?BX.util.htmlspecialchars(t[n]["ID"]):0;o+='<input type="hidden" name="'+s+"["+a+'][NAME]" value="'+l+'">'+'<input type="hidden" name="'+s+"["+a+'][VALUE]" value="'+u+'">'+'<input type="hidden" name="'+s+"["+a+'][CODE]" value="'+c+'">'+'<input type="hidden" name="'+s+"["+a+'][ID]" value="'+S+'">'+'<input type="hidden" name="'+s+"["+a+'][SORT]" value="'+p+'">'}a++}}return o};BX.Sale.Admin.OrderBasketEdit.prototype.onPriceEditEnable=function(e,t){BX.addClass(e,"edit_enable");t.focus()};BX.Sale.Admin.OrderBasketEdit.prototype.onPriceEditDisable=function(e){BX.removeClass(e,"edit_enable")};BX.Sale.Admin.OrderBasketEdit.prototype.addFieldUpdater=function(e,t,i){if(!this.fieldsUpdaters[e])this.fieldsUpdaters[e]={};if(!this.fieldsUpdaters[e][t])this.fieldsUpdaters[e][t]=[];if(typeof i=="function")this.fieldsUpdaters[e][t].push(i);else BX.debug("BX.Sale.Admin.OrderBasketEdit.prototype.addFieldUpdater() callback is not a function!")};BX.Sale.Admin.OrderBasketEdit.prototype.callFieldUpdaters=function(e,t,i){if(!this.fieldsUpdaters[e])return false;if(!this.fieldsUpdaters[e][t])return false;var r=this.fieldsUpdaters[e][t];for(var a in r){if(!r.hasOwnProperty(a))continue;if(typeof r[a]!="function")continue;r[a].call(this,i)}};BX.Sale.Admin.OrderBasketEdit.prototype.setProductFieldValue=function(e,t,i){var r=BX.Sale.Admin.OrderEditPage.getForm(),a=r.elements[this.getFieldName(e,t)];if(a&&a.value)a.value=i;if(this.fieldsUpdaters[e]&&this.fieldsUpdaters[e][t]&&typeof this.fieldsUpdaters[e][t]=="function"){this.fieldsUpdaters[e][t].call(this,i)}};BX.Sale.Admin.OrderBasketEdit.prototype.getProductFieldValue=function(e,t){var i=BX.Sale.Admin.OrderEditPage.getForm();if(!i)return"";var r="",a=i.elements[this.getFieldName(e,t)];if(a&&a.value)r=a.value;return r};BX.Sale.Admin.OrderBasketEditTotal=function(params){if(!params.fields){BX.debug("OrderBasketEditTotal:constructor() params.fields not defined!");return}this.fields={};this.formulas={};var _this=this;var getUnitOfMesure=function(e){var t=_this.fields[e]["type"],i="";if(t=="currency")i=BX.Sale.Admin.OrderEditPage.currencyLang;else if(t=="weight")i=params.weightUnit;return i};var getFormattedValue=function(e){var t=_this.fields[e]["value"],i=_this.fields[e]["type"],r=t;if(i=="currency")r=BX.Sale.Admin.OrderEditPage.currencyFormat(t,false);else if(i=="weight")r=t;return r};var setFieldView=function(e){var t=BX(_this.fields[e].id);if(!t){BX.debug("OrderBasketEditTotal:setFieldView() can't find field with id: \""+_this.fields[e].id+'"');return false}if(_this.fields[e]["edit"]){var i=BX.findChild(t,{className:"formated_field_view"},true,false);if(i)i.innerHTML=getFormattedValue(e)}else{t.innerHTML=getFormattedValue(e);if(_this.fields[e]["type"]!="currency")t.innerHTML=t.innerHTML+" "+getUnitOfMesure(e)}return true};var setFieldEditable=function(e){var t=BX(_this.fields[e].id);if(!t){BX.debug("OrderBasketEditTotal:setFieldView() can't find field with id: \""+_this.fields[e].id+'"');return false}var i=BX.create("input",{props:{type:"text",name:e,value:_this.fields[e].value,maxlength:"9",size:5}}),r=BX.create("span",{props:{className:"edit_field"},children:[i]}),a=BX.create("span",{props:{className:"formated_field_view"},html:getFormattedValue(e)}),s=BX.create("span",{props:{className:"view_field"},children:[a]}),d=BX.create("span",{text:" "+getUnitOfMesure(e)+" "}),o=BX.create("a",{props:{href:"javascript:void(0);"},children:[BX.create("span",{props:{className:"pencil"}})]}),n=BX.create("span",{props:{className:"edit_field_container"},children:[s,r,d,o]});i.style.width="40px";BX.bind(i,"change",function(t){_this.setFieldValue(e,this.value)});BX.bind(t,"mouseover",function(e){BX.addClass(t,"edit_field_hover")});BX.bind(t,"mouseout",function(e){BX.removeClass(t,"edit_field_hover")});BX.bind(t,"click",function(e){BX.addClass(t,"edit_enabled");i.focus()});BX.bind(i,"blur",function(e){BX.removeClass(t,"edit_enabled")});t=BX.cleanNode(t,false);t.appendChild(n)};var setFormulas=function(e){_this.formulas[e]=_this.fields[e]["formula"]};var getFormulas=function(e){var t=[];for(var i in _this.formulas){if(!_this.formulas.hasOwnProperty(i))continue;var r=new RegExp("\\W*"+e+"\\W*","i");if(_this.formulas[i].search(r)!=-1)t.push(i)}return t};var recountFormulasFieldsValues=function(fieldsIds){for(var i in fieldsIds){if(!fieldsIds.hasOwnProperty(i))continue;var formula=_this.formulas[fieldsIds[i]],re=new RegExp("[\\w_]+","ig"),newFormula=formula.replace(re,function(e){var t=_this.getFieldValue(e);return t});_this.setFieldValue(fieldsIds[i],eval(newFormula))}};var setField=function(e,t){var i=new RegExp("[^\\w_]+","ig");if(e.search(i)!=-1)BX.debug("OrderBasketEditTotal:setField() wrong field id!");_this.fields[e]=t;if(t.edit)setFieldEditable(e);if(t.formula)setFormulas(e)};for(var fieldId in params.fields)if(params.fields.hasOwnProperty(fieldId))setField(fieldId,params.fields[fieldId]);this.setFieldValue=function(e,t){if(typeof _this.fields[e]!="undefined"){_this.fields[e].value=t;if(typeof _this.fields[e]["type"]["formula"]!="undefined"){var i=getFormulas(e);if(i)recountFormulasFieldsValues(i)}if(_this.fields[e]["type"]!="hidden")setFieldView(e,t)}else{BX.debug('OrderBasketEditTotal:setFieldValue() unknown field id: "'+e+'"')}};this.getFieldValue=function(e){var t=false;if(typeof this.fields[e]!="undefined")t=this.fields[e].value;else BX.debug('OrderBasketEditTotal: unknown field id: "'+e+'"');return t}};BX.Sale.Admin.OrderBasketProductEditDialog=function(e){var t=null,i=0,r=0,a=true,s=e,d=["CURRENCY","PRODUCT_PROVIDER_CLASS","NAME","DETAIL_PAGE_URL","WEIGHT","CATALOG_XML_ID","NOTES","PRODUCT_XML_ID","OFFER_ID","PRICE","QUANTITY","PROPS","MEASURE_CODE","MEASURE_TEXT","CUSTOM_PRICE","BASKET_CODE"],o=this;var n=function(e){if(!e)e=S();i=e};var l=function(){return i};var u=function(){var e=BX("BASKET_PROP_TABLE");if(!e)BX.debug("BX.Sale.Admin.OrderBasketProductEditDialog:addPropRow() can't find props table!");return e};var c=function(e,t){return"FORM_PROD_PROP_"+l()+"_"+e+"_"+t};var p=function(e){return BX("FORM_PROD_BASKET_"+e)};var S=function(){var e=0;do{e++}while(typeof s.products["n"+e]!="undefined");return"n"+e};var E=function(){var e=[],t=["NAME","VALUE","CODE","SORT"];for(var i=0;i<r;i++){var a={};for(var s=0;s<t.length;s++){var d=c(t[s],i),o=BX(d);if(o&&typeof o.value!="undefined")a[t[s]]=o.value}e.unshift(a)}return e};var h=function(e){var t=E();e.PROPS=[];for(var i in t)if(t.hasOwnProperty(i))if(t[i].NAME)e.PROPS.push(t[i]);return e};var B=function(){var e=l(),t,i=s.products[e]?s.products[e]:{MODULE:"",OFFER_ID:Math.random()*(1e6-1)+1,BASKET_CODE:e},r=false;for(var o in d){if(!d.hasOwnProperty(o))continue;if(t=p(d[o])){if(d[o]=="PRICE"){var n=Math.round(parseFloat(i[d[o]])*1e4),u=Math.round(parseFloat(t.value)*1e4);if(n!=u){i["CUSTOM_PRICE"]="Y";r=true;s.customPrices[e]=t.value;if(!i.MODULE)i["BASE_PRICE"]=i["PRICE_BASE"]=t.value}}else if(d[o]=="CUSTOM_PRICE"){if(r)continue}if(t.value||d[o]!="OFFER_ID"&&d[o]!="BASKET_CODE")i[d[o]]=t.value}}i["MANUALLY_EDITED"]="Y";if(i.BASKET_CODE!=e)BX.debug('setProductParams: product.BASKET_CODE != basketCode "'+i.BASKET_CODE+'" != "'+e+'"');if(!i.BASKET_CODE||i.BASKET_CODE!=e)i.BASKET_CODE=e;if(a){i.OFFER_ID=parseInt(i.OFFER_ID)+e;i.PRODUCT_ID=parseInt(i.OFFER_ID)+e}i=h(i);s.productSet(i,!a);BX.Sale.Admin.OrderAjaxer.sendRequest(BX.Sale.Admin.OrderEditPage.ajaxRequests.refreshOrderData({operation:"PRODUCT_ADD",productId:i.OFFER_ID}))};var f=function(){var e=s.products[l()];if(!e){BX.debug("BX.Sale.Admin.OrderBasketProductEditDialog.getProps() can't find product with basket code: \""+l()+'"');return[]}return s.products[l()]["PROPS"]};var O=function(){var e;for(var t in d){if(!d.hasOwnProperty(t))continue;if(d[t]=="PROPS"){var i=f();for(var r in i)if(i.hasOwnProperty(r))o.addPropRow(r,i[r])}else if(e=p(d[t])){e.value=s.getProductFieldValue(l(),d[t])}}BX("FORM_PROD_BASKET_MEASURE_CODE").disabled=s.getProductFieldValue(l(),"PRODUCT_PROVIDER_CLASS")!=""};var P=function(){var e;for(var t in d)if(d.hasOwnProperty(t))if(e=p(d[t]))e.value="";var i=u();for(t=i.rows.length-1;t>1;t--)i.deleteRow(t);BX("FORM_PROD_BASKET_EMPTY_PROP_ROW").style.display=""};var m=function(){var e={action:"getProductEditDialogHtml",currency:BX.Sale.Admin.OrderEditPage.currencyLang,objName:s.objName,callback:function(e){if(e&&e.DIALOG_CONTENT&&!e.ERROR)_(e.DIALOG_CONTENT);else if(e&&e.ERROR)BX.debug("Error receiving dialog content: "+e.ERROR);else BX.debug("Error receiving dialog content!")}};BX.Sale.Admin.OrderAjaxer.sendRequest(e)};var _=function(e){t=new BX.CDialog({content:e,title:!a?BX.message("SALE_ORDER_BASKET_PROD_EDIT"):BX.message("SALE_ORDER_BASKET_PROD_CREATE"),width:820,height:470});t.ClearButtons();t.SetButtons([{title:BX.message("SALE_ORDER_BASKET_PROD_EDIT_ITEM_SAVE"),id:"save_custom_product",action:function(){B();this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);if(!a)O();s.productEditDialog.disableButton();t.Show();BX.Sale.Admin.OrderEditPage.unBlockForm()};this.show=function(e){r=0;if(e)a=false;else a=true;n(e);if(t==null){t=m()}else{var i;if(!a){P();O();i=BX.message("SALE_ORDER_BASKET_PROD_EDIT")}else{P();i=BX.message("SALE_ORDER_BASKET_PROD_CREATE")}t.SetTitle(i);this.disableButton();t.Show();t.adjustSize()}};this.setMeasureText=function(){var e=BX("FORM_PROD_BASKET_MEASURE_CODE"),t=BX("FORM_PROD_BASKET_MEASURE_TEXT");for(var i=0;i<e.options.length;i++){if(e.options[i].selected!=true)continue;t.value=e.options[i].innerHTML;break}};this.disableButton=function(){var e=BX("save_custom_product");if(!e)return;if(this.checkRequiredFields())e.disabled=false;else e.disabled=true};this.checkRequiredFields=function(){var e=BX("FORM_PROD_BASKET_NAME"),t=BX("FORM_PROD_BASKET_PRICE"),i=BX("FORM_PROD_BASKET_QUANTITY");if(i.value.length>0&&/\D\./.test(i.value))i.value=parseFloat(i.value)||"0";if(t.value.length>0&&/\D\./.test(t.value))t.value=parseFloat(t.value)||"0";if(e.value.length<=0)return false;if(t.value.length<=0)return false;if(i.value.length<=0)return false;return true};this.addPropRow=function(e,t){var i=u();if(!e)e=r;if(r<=0)BX("FORM_PROD_BASKET_EMPTY_PROP_ROW").style.display="none";var a={NAME:20,VALUE:20,CODE:3,SORT:2};if(!t)t={NAME:"",VALUE:"",CODE:"",SORT:""};var s=i.insertRow(-1),d=s.insertCell(-1),o=t["NAME"]?BX.util.htmlspecialchars(t["NAME"]):"",n=t["VALUE"]?BX.util.htmlspecialchars(t["VALUE"]):"",l=t["CODE"]?BX.util.htmlspecialchars(t["CODE"]):"",p=t["SORT"]?BX.util.htmlspecialchars(t["SORT"]):100;d.innerHTML='<input type="text" maxlength="250" size="'+a["NAME"]+'" name="'+c("NAME",e)+'" id="'+c("NAME",e)+'" value="'+o+'" />';d=s.insertCell(-1);d.innerHTML='<input type="text" maxlength="250" size="'+a["VALUE"]+'" name="'+c("VALUE",e)+'" id="'+c("VALUE",e)+'" value="'+n+'" />';d=s.insertCell(-1);d.innerHTML='<input type="text" maxlength="250" size="'+a["CODE"]+'" name="'+c("CODE",e)+'" id="'+c("CODE",e)+'" value="'+l+'" />';d=s.insertCell(-1);d.innerHTML='<input type="text" maxlength="250" size="'+a["SORT"]+'" name="'+c("SORT",e)+'" id="'+c("SORT",e)+'" value="'+p+'" />';r++}};BX.Sale.Admin.OrderBasketCoupons={MODES_LIST:{CREATE:0,EDIT:1,VIEW:2},statusCouponApplyed:null,mode:null,getCouponsContainerNode:function(){return BX("sale-admin-order-coupons-container")},onSetCoupon:function(e){BX.Sale.Admin.OrderEditPage.setDiscountCheckbox(e);BX.Sale.Admin.OrderEditPage.refreshDiscounts()},onDeleteCoupon:function(e){BX.Sale.Admin.OrderAjaxer.sendRequest({action:"deleteCoupon",coupon:e,orderId:BX.Sale.Admin.OrderEditPage.orderId,userId:BX.Sale.Admin.OrderBuyer.getBuyerId(),callback:function(e){if(e&&e.ERROR)BX.Sale.Admin.OrderEditPage.showDialog("Error: can't delete coupon")}},false,true)},onAddCoupons:function(){var e=BX("sale-admin-order-coupons");if(!e||!e.value)return;BX.Sale.Admin.OrderAjaxer.sendRequest({action:"addCoupons",coupon:e.value,orderId:BX.Sale.Admin.OrderEditPage.orderId,userId:BX.Sale.Admin.OrderBuyer.getBuyerId(),callback:function(e){if(e&&e.ERROR)BX.Sale.Admin.OrderEditPage.showDialog(BX.message("SALE_ORDER_BASKET_ADD_COUPON_ERROR"))}},false,true);e.value=""},addCouponRow:function(e){if(!e)return;var t=this.getCouponsContainerNode(),i;if(!t)return;i={toUse:e.JS_STATUS==="APPLYED",coupon:e.COUPON,title:e.JS_CHECK_CODE?e.JS_CHECK_CODE:"",discountId:e.ORDER_DISCOUNT_ID,description:"["+e.COUPON+"]"};if(e.DISCOUNT_NAME!="")i.description+=" "+e.DISCOUNT_NAME;if(e.JS_STATUS==="BAD")i.color="red";else if(e.JS_STATUS==="APPLYED")i.color="green";else i.color="gray";if(e.DISCOUNT_SIZE)i.discountSize=e.DISCOUNT_SIZE;else i.discountSize="0 %";if(e.APPLY)i.APPLY=e.APPLY;else i.APPLY="N";i.NEW_COUPON=e.SAVED=="N";t.appendChild(this.createCouponRowNode(i))},clearCoupons:function(){var e=this.getCouponsContainerNode();if(!e)return;BX.cleanNode(e,false)},createCouponRowNode:function(e){var t="bx-bg-"+e.color,i=this.mode===this.MODES_LIST.EDIT,r=this.mode===this.MODES_LIST.CREATE||this.mode===this.MODES_LIST.EDIT&&e.NEW_COUPON,a=e.discountSize?e.discountSize:"",s=e.description?BX.util.htmlspecialchars(e.description):"",d=e.coupon?BX.util.htmlspecialchars(e.coupon):"",o=e.toUse,n=e.APPLY,l=e.discountId,u="";if(e.title)u=BX.message("SALE_ORDER_BASKET_COUPON_STATUS")+": "+BX.util.htmlspecialchars(e.title);return BX.create("li",{props:{className:"bx-adm-pc-sale-item "+t},html:(i?'<input type="hidden" value="N" name="DISCOUNTS[COUPON_LIST]['+d+']">'+'<input type="checkbox" data-discount-id="'+l+'" data-coupon="Y" data-discount-coupon="'+d+'" class="bx-adm-pc-input-checkbox" name="DISCOUNTS[COUPON_LIST]['+d+']" value="Y" onclick="BX.Sale.Admin.OrderBasketCoupons.onSetCoupon(event);"'+(n=="Y"?" checked":"")+' title="'+BX.message("SALE_ORDER_BASKET_COUPON_APPLY")+'">':"")+'<div class="bx-adm-pc-sale-item-block'+(i?"":" bx-amd-l0")+(r?"":" bx-adm-r0")+'" title="'+u+'">'+'<div class="bx-adm-pc-sale-overname"><div class="bx-adm-pc-sale-cost">'+(a.length>0?a:"0")+"</div>"+s+"</div>"+"</div>"+(r?'<div class="bx-adm-pc-sale-item-remover" onclick="BX.Sale.Admin.OrderBasketCoupons.onDeleteCoupon(\''+d+'\');"  title="'+BX.message("SALE_ORDER_BASKET_COUPON_DELETE")+'"></div>':"")})},setCoupons:function(e){this.clearCoupons();if(!e)return;for(var t in e)if(e.hasOwnProperty(t))this.addCouponRow(e[t])}};
//# sourceMappingURL=order_basket.map.js