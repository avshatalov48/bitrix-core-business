if(!BX.getClass("BX.Bizproc.UserSelector"))(function(e){"use strict";e.namespace("BX.Bizproc");var t=new WeakMap;var i=function(t,i){var a=this;if(!i){var n=t.getAttribute("data-config");i=n?e.parseJSON(n):null;t.removeAttribute("data-config")}if(!e.type.isPlainObject(i)){i={}}this.config=i;this.container=t||e.create("div");this.isOnlyDialogMode=i.isOnlyDialogMode||false;this.data=null;this.dialogId="bp-user-selector-"+e.util.getRandomString(7);this.selected=i.selected?e.clone(i.selected):[];this.selectOne=!i.multiple;this.required=i.required||false;this.additionalFields=e.type.isArray(i.additionalFields)?i.additionalFields:[];this.prepareRoles();e.bind(this.container,"click",function(e){e.preventDefault();a.openDialog()});if(!this.isOnlyDialogMode){this.prepareNodes()}if(i.value){this.selected=this.parseValue(i.value)}this.addItems(this.selected)};i.canUse=function(){return!!e.SocNetLogDestination};i.decorateNode=function(e,a){var n=t.get(e);if(!n){n=new i(e,a);t.set(e,n)}return n};i.getByNode=function(e){return t.get(e)};i.prototype={prepareNodes:function(){this.itemsNode=e.create("span");this.inputBoxNode=e.create("span",{attrs:{className:"bizproc-type-control-user-input-box"}});this.inputNode=e.create("input",{props:{type:"text"},attrs:{className:"bizproc-type-control-user-input"}});this.inputBoxNode.appendChild(this.inputNode);this.tagNode=e.create("a",{attrs:{className:"bizproc-type-control-user-link"}});this.container.appendChild(this.itemsNode);this.container.appendChild(this.inputBoxNode);this.container.appendChild(this.tagNode);this.createValueNode(this.config.valueInputName||"");e.bind(this.tagNode,"focus",function(e){e.preventDefault();me.openDialog({bByFocusEvent:true})});this.tagNode.innerHTML=this.selected.length<=0?e.message("BIZPROC_JS_USER_SELECTOR_CHOOSE"):e.message("BIZPROC_JS_USER_SELECTOR_EDIT")},getData:function(t){if(i.ajaxSent){return}i.ajaxSent=true;e.ajax({method:"POST",dataType:"json",url:"/bitrix/tools/bizproc/user_selector.php",data:{ajax_action:"get_destination_data",sessid:e.bitrix_sessid(),site:e.message("SITE_ID")},onsuccess:function(e){i.data=e.data||{};i.ajaxSent=false;this.initDialog(t)}.bind(this)})},initDialog:function(t){var a,n=this,s=i.data;if(!s){n.getData(t);return}var o={};for(a=0;a<n.selected.length;++a){o[n.selected[a].id]=n.selected[a].entityType}var l={users:s.users||{},department:s.department||{},departmentRelation:s.departmentRelation||{},bpuserroles:this.roles||{}};var r={users:s.last.USERS||{}};if(!l["departmentRelation"]){l["departmentRelation"]=e.SocNetLogDestination.buildDepartmentRelation(l["department"])}if(!n.inited){n.inited=true;if(this.isOnlyDialogMode){this.initOnlyDialog(l,r,o,s)}else{this.initDialogWithInputs(l,r,o,s)}}t()},initDialogWithInputs:function(t,i,a,n){var s=this;var o=s.inputNode;o.id=s.dialogId+"input";var l=s.inputBoxNode;l.id=s.dialogId+"input-box";var r=this.tagNode;r.id=this.dialogId+"tag";var d=s.itemsNode;e.SocNetLogDestination.init({name:s.dialogId,searchInput:o,extranetUser:false,bindMainPopup:{node:s.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:s.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:false,sendAjaxSearch:true,callback:{select:function(t,i){s.addItem(t,i);if(s.selectOne){e.SocNetLogDestination.closeDialog()}},unSelect:function(t,i){if(s.selectOne){return}s.unsetValue(t,i);e.SocNetLogDestination.BXfpUnSelectCallback.call({formName:s.dialogId,inputContainerName:d,inputName:o.id,tagInputName:r.id,tagLink1:e.message("BIZPROC_JS_USER_SELECTOR_CHOOSE"),tagLink2:e.message("BIZPROC_JS_USER_SELECTOR_EDIT")},t)},openDialog:e.delegate(e.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:l.id,inputName:o.id,tagInputName:r.id}),closeDialog:e.delegate(e.SocNetLogDestination.BXfpCloseDialogCallback,{inputBoxName:l.id,inputName:o.id,tagInputName:r.id}),openSearch:e.delegate(e.SocNetLogDestination.BXfpOpenDialogCallback,{inputBoxName:l.id,inputName:o.id,tagInputName:r.id}),closeSearch:e.delegate(e.SocNetLogDestination.BXfpCloseSearchCallback,{inputBoxName:l.id,inputName:o.id,tagInputName:r.id})},items:t,itemsLast:i,itemsSelected:a,useClientDatabase:false,destSort:n.DEST_SORT||{},allowAddUser:false});if(Object.keys(this.roles).length>0){e.onCustomEvent(e.SocNetLogDestination,"onTabsAdd",[s.dialogId,{id:"bpuserrole",name:e.message("BIZPROC_JS_USER_SELECTOR_ROLE_TAB"),itemType:"bpuserroles",dialogGroup:{groupCode:"bpuserroles",title:e.message("BIZPROC_JS_USER_SELECTOR_ROLE_TAB")}}])}e.bind(o,"keyup",e.delegate(e.SocNetLogDestination.BXfpSearch,{formName:s.dialogId,inputName:o.id,tagInputName:r.id}));e.bind(o,"keydown",e.delegate(e.SocNetLogDestination.BXfpSearchBefore,{formName:s.dialogId,inputName:o.id}));e.SocNetLogDestination.BXfpSetLinkName({formName:s.dialogId,tagInputName:r.id,tagLink1:e.message("BIZPROC_JS_USER_SELECTOR_CHOOSE"),tagLink2:e.message("BIZPROC_JS_USER_SELECTOR_EDIT")})},initOnlyDialog:function(t,i,a,n){var s=this;e.SocNetLogDestination.init({name:s.dialogId,showSearchInput:true,extranetUser:false,bindMainPopup:{node:s.container,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:s.container,offsetTop:"5px",offsetLeft:"15px"},departmentSelectDisable:false,sendAjaxSearch:true,callback:{select:function(t,i){s.selectInDialog(t,i);e.SocNetLogDestination.closeDialog()}},items:t,itemsLast:i,itemsSelected:a,useClientDatabase:false,destSort:n.DEST_SORT||{},allowAddUser:false});if(Object.keys(this.roles).length>0){e.onCustomEvent(e.SocNetLogDestination,"onTabsAdd",[s.dialogId,{id:"bpuserrole",name:e.message("BIZPROC_JS_USER_SELECTOR_ROLE_TAB"),itemType:"bpuserroles",dialogGroup:{groupCode:"bpuserroles",title:e.message("BIZPROC_JS_USER_SELECTOR_ROLE_TAB")}}])}},selectInDialog:function(t,i){var a=this.convertItemToValue(t,i);if(this.config.callbacks&&e.type.isFunction(this.config.callbacks.select)){this.config.callbacks.select(a,this)}},addItem:function(t,i){var a=this;var n=this.inputNode;var s=this.tagNode;var o=this.itemsNode;if(!i&&t.entityType){i=t.entityType}var l=false;if(!e.findChild(o,{attr:{"data-id":t.id}},false,false)){if(a.selectOne){var r=[];for(var d=0;d<o.childNodes.length;++d){r.push({itemId:o.childNodes[d].getAttribute("data-id"),itemType:o.childNodes[d].getAttribute("data-type")})}a.initDialog(function(){for(var t=0;t<r.length;++t){e.SocNetLogDestination.deleteItem(r[t].itemId,r[t].itemType,a.dialogId)}});e.cleanNode(o);a.cleanValue()}var u=this.createItemNode({text:t.name,className:i==="bpuserroles"?"bizproc-type-control-user-item-head":"",deleteEvents:{click:function(n){if(a.selectOne&&a.required){a.openDialog()}else{a.initDialog(function(){e.SocNetLogDestination.deleteItem(t.id,i,a.dialogId);e.remove(u);a.unsetValue(t,i)})}n.preventDefault()}}});this.setValue(t,i);u.setAttribute("data-id",t.id);u.setAttribute("data-type",i);o.appendChild(u);if(!t.entityType){t.entityType=i}l=true}n.value="";s.innerHTML=e.message("BIZPROC_JS_USER_SELECTOR_EDIT");return l},toggleItem:function(t,i){if(!this.addItem(t,i)){this.unsetValue(t,i);var a=e.findChild(this.itemsNode,{attr:{"data-id":t.id}},false,false);if(a){e.remove(a)}}},addItems:function(e){for(var t=0;t<e.length;++t){this.addItem(e[t],e[t].entityType)}},openDialog:function(t){var i=this;if(i.handleOpenDialog&&e.Type.isFunction(i.handleOpenDialog)&&i.handleOpenDialog(i)===false){return}this.initDialog(function(){e.SocNetLogDestination.openDialog(i.dialogId,t)})},destroy:function(){if(this.inited){if(e.SocNetLogDestination.isOpenDialog()){e.SocNetLogDestination.closeDialog()}e.SocNetLogDestination.closeSearch()}},createItemNode:function(t){return e.create("span",{attrs:{className:"bizproc-type-control-user-item "+t.className},children:[e.create("span",{attrs:{className:"bizproc-type-control-user-name"},text:e.util.htmlspecialcharsback(t.text||"")}),e.create("span",{attrs:{className:"bizproc-type-control-user-delete"},events:t.deleteEvents})]})},createValueNode:function(t){this.valueNode=e.create("input",{props:{type:"hidden",name:t}});this.container.appendChild(this.valueNode)},setValue:function(e,t){var i=this.getValueId(e,t);var a=this.convertItemToValue(e,t);if(this.selectOne){this.valueNode.value=a}else{var n,s=[],o=this.valueNode.value.split(",");for(n=0;n<o.length;++n){if(!o[n]||o[n].indexOf(i)>=0){continue}s.push(o[n])}s.push(a);this.valueNode.value=s.join(",")}},convertItemToValue:function(t,i){var a=this.getValueId(t,i);var n=a;var s=e.util.htmlspecialcharsback(t["name"]);s=s.replace(/[,\.\-\_\>\<\"\']/g,"");if(i==="users"){n=[s,a].join(" ")}else if(i==="department"){n=[s,a].join(" ")}return n},unsetValue:function(e,t){var i=this.getValueId(e,t);if(this.selectOne){this.valueNode.value=""}else{var a,n=[],s=this.valueNode.value.split(",");for(a=0;a<s.length;++a){if(!s[a]||s[a].indexOf(i)>=0){continue}n.push(s[a])}this.valueNode.value=n.join(",")}if(this.selected&&this.selected.length){this.selected=this.selected.filter(function(e){return e.id!==i})}},getValueId:function(e,t){var i=e["id"].toString();if(t==="users"){i="["+e.entityId+"]"}else if(t==="department"||t==="bpuserroles"&&i.indexOf("G")===0){i="["+i+"]"}return i},cleanValue:function(){this.valueNode.value=""},getValue:function(){return this.valueNode.value},parseValue:function(t){t=this.prepareValueString(t);var i,a,n,s,o,l=[],r,d=t.split(","),u,c;for(i=0;i<d.length;++i){r=e.util.trim(d[i]);if(u=r.match(/(.*)\[([A-Z]{0,2})(\d+)\]/)){a=e.util.trim(u[1]);s=u[3];n=u[2]+s;o=u[2]===""?"users":"bpuserroles";if(o==="users"&&n[0]!=="U"){n="U"+n}if(u[2]==="DR"){o="department"}l.push({id:n,entityId:parseInt(s),name:a,entityType:o})}else{c=false;if(this.roles[r]){c=true;l.push(this.roles[r])}if(!c&&this.getGroups().length){this.getGroups().forEach(function(e){if(r===e["name"]){c=true;l.push({id:e["id"],entityId:e["id"],name:e["name"],entityType:"bpuserroles"})}})}if(!c){l.push({id:r,entityId:r,name:r,entityType:"bpuserroles"})}}}return l},prepareValueString:function(t){t=t.toString();if(t.indexOf("{{")>=0){var i=e.Bizproc.FieldType.getDocumentFields();i.forEach(function(e){if(e["Type"]==="user"){t=t.replace(e["Expression"],e["SystemExpression"])}})}return t},prepareRoles:function(){var t=e.Bizproc.FieldType.getDocumentFields();var i={};if(this.getGroups().length){this.getGroups().forEach(function(e){i[e["id"]]={id:e["id"],entityId:e["id"],name:e["name"],entityType:"bpuserroles"}})}t.forEach(function(t){if(t["Type"]==="user"){i[t["SystemExpression"]]={id:t["SystemExpression"],entityId:t["SystemExpression"],name:e.Text.encode(t["Name"]),entityType:"bpuserroles"}}});this.additionalFields.forEach(function(e){e.entityType="bpuserroles";i[e["id"]]=e});this.roles=i},getGroups:function(){return this.config.groups||e.Bizproc.FieldType.getDocumentUserGroups()}};e.Bizproc.UserSelector=i})(window.BX||window.top.BX);
//# sourceMappingURL=user_selector.map.js