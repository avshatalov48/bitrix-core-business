this.BX=this.BX||{};(function(e,t,s,i,n,a,o,c,r,l){"use strict";let d=e=>e,h,p,u,g;class C extends n.EventEmitter{constructor(e={}){super();this.DOM={};this.isCreated=false;this.setEventNamespace("BX.Calendar.SectionInterface.EditForm");this.DOM.outerWrap=e.wrap;this.sectionAccessTasks=e.sectionAccessTasks;this.sectionManager=e.sectionManager;this.closeCallback=e.closeCallback;this.BX=c.Util.getBX();this.keyHandlerBinded=this.keyHandler.bind(this)}show(e={}){this.section=e.section;this.create();this.showAccess=e.showAccess!==false;this.allowChangeName=e.allowChangeName!==false;if(this.showAccess){this.DOM.accessLink.style.display="";this.DOM.accessWrap.style.display=""}else{this.DOM.accessLink.style.display="none";this.DOM.accessWrap.style.display="none"}o.Event.bind(document,"keydown",this.keyHandlerBinded);o.Dom.addClass(this.DOM.outerWrap,"show");if(e.section){if(e.section.color){this.setColor(e.section.color)}this.setAccess(e.section.access||e.section.data.ACCESS||{});if(e.section.name){this.DOM.sectionTitleInput.value=e.section.name}}if(this.allowChangeName){BX.focus(this.DOM.sectionTitleInput);if(this.DOM.sectionTitleInput.value!==""){this.DOM.sectionTitleInput.select()}}else{o.Dom.addClass(this.DOM.sectionTitleInput,"--disabled");this.DOM.sectionTitleInput.disabled=true}this.isOpenedState=true}close(){this.isOpenedState=false;o.Event.unbind(document,"keydown",this.keyHandlerBinded);o.Dom.removeClass(this.DOM.outerWrap,"show");if(o.Type.isFunction(this.closeCallback)){this.closeCallback()}}isOpened(){return this.isOpenedState}create(){this.wrap=this.DOM.outerWrap.querySelector(".calendar-form-content");if(this.wrap){o.Dom.clean(this.wrap)}else{this.wrap=this.DOM.outerWrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-form-content"}}))}this.DOM.formFieldsWrap=this.wrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-list-slider-widget-content"}})).appendChild(o.Dom.create("DIV",{props:{className:"calendar-list-slider-widget-content-block"}}));this.DOM.sectionTitleInput=this.DOM.formFieldsWrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-field-container calendar-field-container-string"}})).appendChild(o.Dom.create("DIV",{props:{className:"calendar-field-block"}})).appendChild(o.Dom.create("INPUT",{attrs:{type:"text",placeholder:o.Loc.getMessage("EC_SEC_SLIDER_SECTION_TITLE")},props:{className:"calendar-field calendar-field-string"}}));this.DOM.optionsWrap=this.DOM.formFieldsWrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-list-slider-new-calendar-options-container"}}));this.initSectionColorSelector();this.initAccessController();this.buttonsWrap=this.DOM.formFieldsWrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-list-slider-btn-container"}}));this.saveBtn=new BX.UI.Button({text:o.Loc.getMessage("EC_SEC_SLIDER_SAVE"),className:"ui-btn ui-btn-success",events:{click:this.save.bind(this)}});this.saveBtn.renderTo(this.buttonsWrap);new BX.UI.Button({text:o.Loc.getMessage("EC_SEC_SLIDER_CANCEL"),className:"ui-btn ui-btn-link",events:{click:this.checkClose.bind(this)}}).renderTo(this.buttonsWrap);this.isCreated=true}keyHandler(e){if(e.keyCode===c.Util.getKeyCode("escape")){this.checkClose()}else if(e.keyCode===c.Util.getKeyCode("enter")){this.save()}}checkClose(){this.close()}save(){this.saveBtn.setWaiting(true);this.sectionManager.saveSection(this.DOM.sectionTitleInput.value,this.color,this.access,{section:this.section}).then((()=>{this.saveBtn.setWaiting(false);this.close()}))}initSectionColorSelector(){this.DOM.colorContWrap=this.DOM.optionsWrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-list-slider-new-calendar-option-color"},html:o.Loc.getMessage("EC_SEC_SLIDER_COLOR")}));this.colorIcon=this.DOM.colorContWrap.appendChild(o.Dom.create("SPAN",{props:{className:"calendar-list-slider-new-calendar-option-color-selected"}}));this.colorChangeLink=this.DOM.colorContWrap.appendChild(o.Dom.create("SPAN",{props:{className:"calendar-list-slider-new-calendar-option-color-change"},html:o.Loc.getMessage("EC_SEC_SLIDER_CHANGE")}));o.Event.bind(this.colorIcon,"click",this.showSimplePicker.bind(this));o.Event.bind(this.colorChangeLink,"click",this.showSimplePicker.bind(this))}showSimplePicker(e){const t=o.Runtime.clone(c.Util.getDefaultColorList(),true);const s=o.Dom.create("DIV",{props:{className:"calendar-simple-color-wrap calendar-field-container-colorpicker-square"}});const i=s.appendChild(o.Dom.create("DIV",{events:{click:BX.delegate(this.simplePickerClick,this)}}));const n=s.appendChild(o.Dom.create("DIV",{props:{className:"calendar-simple-color-more-link-wrap"}}));const a=n.appendChild(o.Dom.create("SPAN",{props:{className:"calendar-simple-color-more-link"},html:o.Loc.getMessage("EC_COLOR"),events:{click:BX.delegate(this.showFullPicker,this)}}));this.simplePickerColorWrap=i;this.colors=[];if(!t.includes(this.color)){t.push(this.color)}for(let e=0;e<t.length;e++){this.colors.push({color:t[e],node:i.appendChild(o.Dom.create("SPAN",{props:{className:"calendar-field-colorpicker-color-item"},style:{backgroundColor:t[e]},attrs:{"data-bx-calendar-color":t[e]},html:'<span class="calendar-field-colorpicker-color"></span>'}))})}this.lastActiveNode=this.colors[BX.util.array_search(this.color,t)||0].node;o.Dom.addClass(this.lastActiveNode,"active");this.simpleColorPopup=BX.PopupWindowManager.create("simple-color-popup-"+c.Util.getRandomInt(),this.colorIcon,{autoHide:true,closeByEsc:true,offsetTop:0,offsetLeft:9,lightShadow:true,content:s,cacheable:false});this.simpleColorPopup.setAngle({offset:10});this.simpleColorPopup.show(true)}simplePickerClick(e){const t=c.Util.findTargetNode(e.target||e.srcElement,this.DOM.outerWrap);if(o.Type.isElementNode(t)){const e=t.getAttribute("data-bx-calendar-color");if(e!==null){if(this.lastActiveNode){o.Dom.removeClass(this.lastActiveNode,"active")}o.Dom.addClass(t,"active");this.lastActiveNode=t;this.setColor(e)}}}showFullPicker(){var e;if(this.simpleColorPopup){this.simpleColorPopup.close()}if(!this.fullColorPicker||(e=this.fullColorPicker.getPopupWindow())!=null&&e.isDestroyed()){this.fullColorPicker=new BX.ColorPicker({bindElement:this.DOM.colorContWrap,onColorSelected:BX.delegate((function(e){this.setColor(e)}),this),popupOptions:{cacheable:false,zIndex:this.zIndex,events:{onPopupClose:BX.delegate((function(){}),this)}}})}this.fullColorPicker.open()}setColor(e){this.colorIcon.style.backgroundColor=e;this.color=e}setAccess(e){let t=0;for(let s in e){if(e.hasOwnProperty(s)){t++}}this.accessRowsCount=t;this.access=e;for(let t in e){if(e.hasOwnProperty(t)){this.insertAccessRow(c.Util.getAccessName(t),t,e[t])}}this.checkAccessTableHeight()}initAccessController(){this.buildAccessController();if(this.sectionManager&&this.sectionManager.calendarType==="group"){this.initDialogGroup()}else{this.initDialogStandard()}this.initAccessSelectorPopup()}initAccessSelectorPopup(){o.Event.bind(this.DOM.accessWrap,"click",(e=>{const t=c.Util.findTargetNode(e.target||e.srcElement,this.DOM.outerWrap);if(o.Type.isElementNode(t)){if(t.getAttribute("data-bx-calendar-access-selector")!==null){const e=t.getAttribute("data-bx-calendar-access-selector");if(this.accessControls[e]){this.showAccessSelectorPopup({node:this.accessControls[e].removeIcon,setValueCallback:t=>{if(this.accessTasks[t]&&this.accessControls[e]){this.accessControls[e].valueNode.innerHTML=o.Text.encode(this.accessTasks[t].title);this.access[e]=t}}})}}else if(t.getAttribute("data-bx-calendar-access-remove")!==null){const e=t.getAttribute("data-bx-calendar-access-remove");if(this.accessControls[e]){o.Dom.remove(this.accessControls[e].rowNode);this.accessControls[e]=null;delete this.access[e]}}}}))}buildAccessController(){this.DOM.accessLink=this.DOM.optionsWrap.appendChild(o.Tag.render(h||(h=d`<div class="calendar-list-slider-new-calendar-option-more">${0}</div>`),o.Loc.getMessage("EC_SEC_SLIDER_ACCESS")));this.DOM.accessWrap=this.DOM.formFieldsWrap.appendChild(o.Tag.render(p||(p=d`
				<div class="calendar-list-slider-access-container">
					<div class="calendar-list-slider-access-inner-wrap">
						${0}
					</div>
					<div class="calendar-list-slider-new-calendar-options-container">
						${0}
					</div>
				</div>`),this.DOM.accessTable=o.Tag.render(u||(u=d`
							<table class="calendar-section-slider-access-table"></table>
						`)),this.DOM.accessButton=o.Tag.render(g||(g=d`
							<span class="calendar-list-slider-new-calendar-option-add">
								${0}
							</span>`),o.Loc.getMessage("EC_SEC_SLIDER_ACCESS_ADD"))));this.accessControls={};this.accessTasks=this.sectionAccessTasks;o.Event.bind(this.DOM.accessLink,"click",(()=>{if(o.Dom.hasClass(this.DOM.accessWrap,"shown")){o.Dom.removeClass(this.DOM.accessWrap,"shown")}else{o.Dom.addClass(this.DOM.accessWrap,"shown")}this.checkAccessTableHeight()}))}initDialogStandard(){o.Event.bind(this.DOM.accessButton,"click",(()=>{const e=[{id:"user",options:{analyticsSource:"calendar"}},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}];if(c.Util.isProjectFeatureEnabled()){e.push({id:"project"})}this.entitySelectorDialog=new a.Dialog({targetNode:this.DOM.accessButton,context:"CALENDAR",preselectedItems:[],enableSearch:true,events:{"Item:onSelect":this.handleEntitySelectorChanges.bind(this),"Item:onDeselect":this.handleEntitySelectorChanges.bind(this)},popupOptions:{targetContainer:document.body},entities:e});this.entitySelectorDialog.show()}))}initDialogGroup(){o.Event.bind(this.DOM.accessButton,"click",(()=>{this.entitySelectorDialog=new a.Dialog({targetNode:this.DOM.accessButton,context:"CALENDAR",preselectedItems:[],enableSearch:true,events:{"Item:onSelect":this.handleEntitySelectorChanges.bind(this),"Item:onDeselect":this.handleEntitySelectorChanges.bind(this)},popupOptions:{targetContainer:document.body},entities:[{id:"user",options:{analyticsSource:"calendar"}},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}],tabs:[{id:"groupAccess",title:this.sectionManager.ownerName}],items:[{id:"SG"+this.sectionManager.ownerId+"_"+"A",entityId:"group",tabs:"groupAccess",title:o.Loc.getMessage("EC_ACCESS_GROUP_ADMIN")},{id:"SG"+this.sectionManager.ownerId+"_"+"E",entityId:"group",tabs:"groupAccess",title:o.Loc.getMessage("EC_ACCESS_GROUP_MODERATORS")},{id:"SG"+this.sectionManager.ownerId+"_"+"K",entityId:"group",tabs:"groupAccess",title:o.Loc.getMessage("EC_ACCESS_GROUP_MEMBERS")}]});this.entitySelectorDialog.show()}))}handleEntitySelectorChanges(){const e=this.entitySelectorDialog.getSelectedItems();this.entitySelectorDialog.hide();if(o.Type.isArray(e)){e.forEach((e=>{let t;if(e.entityId==="group"){t=this.sectionManager.ownerName+": "+e.title.text}else{t=e.title.text}const s=c.Util.convertEntityToAccessCode(e);c.Util.setAccessName(s,t);this.insertAccessRow(t,s)}))}o.Runtime.debounce((()=>{this.entitySelectorDialog.destroy()}),400)()}insertAccessRow(e,t,s){if(!this.accessControls[t]){if(s===undefined){for(let e in this.sectionAccessTasks){if(this.sectionAccessTasks.hasOwnProperty(e)&&this.sectionAccessTasks[e].name==="calendar_view"){s=e;break}}}const i=o.Dom.adjust(this.DOM.accessTable.insertRow(-1),{props:{className:"calendar-section-slider-access-table-row"}}),n=o.Dom.adjust(i.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},html:'<span class="calendar-section-slider-access-title">'+o.Text.encode(e)+":</span>"}),a=o.Dom.adjust(i.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},attrs:{"data-bx-calendar-access-selector":t}}),c=a.appendChild(o.Dom.create("SPAN",{props:{className:"calendar-section-slider-access-container"}})),r=c.appendChild(o.Dom.create("SPAN",{text:this.accessTasks[s]?this.accessTasks[s].title:"",props:{className:"calendar-section-slider-access-value"}})),l=c.appendChild(o.Dom.create("SPAN",{props:{className:"calendar-section-slider-access-remove"},attrs:{"data-bx-calendar-access-remove":t}}));this.access[t]=s;this.accessControls[t]={rowNode:i,titleNode:n,valueNode:r,removeIcon:l}}}checkAccessTableHeight(){if(this.checkTableTimeout){this.checkTableTimeout=clearTimeout(this.checkTableTimeout)}this.checkTableTimeout=setTimeout((()=>{if(o.Dom.hasClass(this.DOM.accessWrap,"shown")){if(this.DOM.accessWrap.offsetHeight-this.DOM.accessTable.offsetHeight<36){this.DOM.accessWrap.style.maxHeight=parseInt(this.DOM.accessTable.offsetHeight)+100+"px"}}else{this.DOM.accessWrap.style.maxHeight=""}}),300)}showAccessSelectorPopup(e){if(this.accessPopupMenu&&this.accessPopupMenu.popupWindow&&this.accessPopupMenu.popupWindow.isShown()){return this.accessPopupMenu.close()}const t=this;const s=[];for(let i in this.accessTasks){if(this.accessTasks.hasOwnProperty(i)){s.push({text:this.accessTasks[i].title,onclick:function(s){return function(){e.setValueCallback(s);t.accessPopupMenu.close()}}(i)})}}this.accessPopupMenu=this.BX.PopupMenu.create("section-access-popup"+c.Util.randomInt(),e.node,s,{closeByEsc:true,autoHide:true,offsetTop:-5,offsetLeft:0,angle:true,cacheable:false});this.accessPopupMenu.show()}}let S=e=>e,E,m,D,f,M,L,_,T,k;class I{constructor(e={}){this.DOM={};this.isCreated=false;this.interfaceType="users";this.DOM.outerWrap=e.wrap;this.trackingUsers=e.trackingUsers||[];this.trackingUserIdList=this.trackingUsers.map((e=>parseInt(e.ID,10)));this.trackingIdList=[];this.CHECKED_CLASS="calendar-list-slider-item-checkbox-checked";this.selectorId=`add-tracking${c.Util.getRandomInt()}`;this.closeCallback=e.closeCallback;this.superposedSections=o.Type.isArray(e.superposedSections)?e.superposedSections:[];this.selected={};this.superposedSections.forEach((e=>{this.selected[e.id]=true}));this.isCreated=false;this.keyHandlerBinded=this.keyHandler.bind(this)}show(){if(!this.isCreated){this.create()}o.Dom.addClass(this.DOM.outerWrap,"show");this.checkInnerWrapHeight();o.Event.bind(document,"keydown",this.keyHandlerBinded);this.updateSectionList();this.firstTrackingUserIdList=o.Runtime.clone(this.trackingUserIdList);this.isOpenedState=true}close(){o.Event.unbind(document,"keydown",this.keyHandlerBinded);this.isOpenedState=false;o.Dom.removeClass(this.DOM.outerWrap,"show");this.DOM.outerWrap.style.cssText="";if(o.Type.isFunction(this.closeCallback)){this.closeCallback()}}isOpened(){return this.isOpenedState}create(){if(!this.DOM.innerWrap){this.DOM.innerWrap=this.DOM.outerWrap.appendChild(o.Tag.render(E||(E=S`<div></div>`)))}this.selectorWrap=this.DOM.innerWrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-list-slider-selector-wrap"}}));this.userTagSelector=new a.TagSelector({dialogOptions:{width:320,context:"CALENDAR",preselectedItems:this.trackingUsers.map((e=>["user",parseInt(e.ID,10)])),events:{"Item:onSelect":this.handleUserSelectorChanges.bind(this),"Item:onDeselect":this.handleUserSelectorChanges.bind(this)},entities:[{id:"user"}]}});this.userTagSelector.renderTo(this.selectorWrap);this.sectionsWrap=this.DOM.innerWrap.appendChild(o.Tag.render(m||(m=S`<div class="calendar-list-slider-sections-wrap"></div>`)));this.createButtons();this.isCreated=true}createButtons(){this.DOM.innerWrap.appendChild(o.Tag.render(D||(D=S`
				<div class="calendar-list-slider-btn-container">
					<button 
						class="ui-btn ui-btn-sm ui-btn-primary"
						onclick="${0}"
					>${0}</button>
					<button 
						class="ui-btn ui-btn-link"
						onclick="${0}"
					>${0}</button>
				</div>
			`),this.save.bind(this),o.Loc.getMessage("EC_SEC_SLIDER_SAVE"),this.close.bind(this),o.Loc.getMessage("EC_SEC_SLIDER_CANCEL")))}handleUserSelectorChanges(){const e=this.userTagSelector.getDialog().getSelectedItems();this.trackingUserIdList=[];e.forEach((e=>{if(e.entityId==="user"){this.trackingUserIdList.push(e.id)}}));this.updateSectionList()}save(){BX.ajax.runAction("calendar.api.calendarajax.setTrackingSections",{data:{userIdList:this.trackingUserIdList,groupIdList:this.trackingIdList,collabIdList:this.trackingIdList,sections:this.prepareTrackingSections(),type:this.interfaceType}}).then((()=>{location.reload()}),(e=>{c.Util.displayError(e.errors)}));this.close()}prepareTrackingSections(){let e=this.getSelectedSections();for(const t in this.sectionIndex){if(this.sectionIndex.hasOwnProperty(t)&&this.sectionIndex[t].checkbox){if(o.Dom.hasClass(this.sectionIndex[t].checkbox,this.CHECKED_CLASS)){if(!e.includes(parseInt(t,10))){e.push(parseInt(t,10))}}else if(e.includes(parseInt(t,10))){e=e.filter((e=>parseInt(e,10)!==parseInt(t,10)))}}}return e}getSelectedSections(){const e=[];this.superposedSections.forEach((t=>{if(this.interfaceType==="users"&&t.type==="user"&&this.trackingUserIdList&&!this.trackingUserIdList.includes(t.ownerId)){return}e.push(parseInt(t.id,10))}));return e}updateSectionList(e){if(this.updateSectionLoader){o.Dom.remove(this.updateSectionLoader)}this.updateSectionLoader=this.sectionsWrap.appendChild(o.Dom.adjust(c.Util.getLoader(),{style:{height:"140px"}}));if(this.updateSectionTimeout){clearTimeout(this.updateSectionTimeout);this.updateSectionTimeout=null}if(e!==false){this.updateSectionTimeout=setTimeout((()=>{this.updateSectionList(false)}),300);return}this.checkInnerWrapHeight();BX.ajax.runAction("calendar.api.calendarajax.getTrackingSections",{data:{userIdList:this.trackingUserIdList,type:"users"}}).then((e=>{o.Dom.clean(this.sectionsWrap);this.sectionIndex={};this.checkInnerWrapHeight();e.data.users.forEach((t=>{const s=e.data.sections.filter((e=>parseInt(e.OWNER_ID,10)===parseInt(t.ID,10)));this.sectionsWrap.appendChild(o.Tag.render(f||(f=S`
						<div>
							<span class="calendar-list-slider-card-section-title-text">
								${0}
							</span>
						</div>
					`),o.Text.encode(t.FORMATTED_NAME)));if(s.length>0){this.createSectionBlock({sectionList:s,wrap:this.sectionsWrap})}else{this.sectionsWrap.appendChild(o.Tag.render(M||(M=S`
							<div>
								<span class="calendar-list-slider-card-section-title-text">
									${0}
								</span>
							</div>
						`),o.Loc.getMessage("EC_SEC_SLIDER_NO_SECTIONS")))}}))}),(e=>{c.Util.displayError(e.errors)}))}createSectionBlock(e={}){let t=false;if(o.Type.isArray(e.sectionList)&&e.sectionList.length&&o.Type.isElementNode(e.wrap)){let t;e.wrap.appendChild(o.Tag.render(L||(L=S`
				<div class="calendar-list-slider-widget-content">
					<div class="calendar-list-slider-widget-content-block">
						${0}
					</div>
				</div>
			`),t=o.Tag.render(_||(_=S`<ul class="calendar-list-slider-container"></ul>`))));o.Event.bind(t,"click",this.sectionClick.bind(this));e.sectionList.forEach((e=>{const s=e.ID.toString();let i;const n=t.appendChild(o.Tag.render(T||(T=S`
					<li class="calendar-list-slider-item" data-bx-calendar-section="${0}">
						${0}
						<div class="calendar-list-slider-item-name">${0}</div>
					</li>
				`),s,i=o.Tag.render(k||(k=S`
							<div class="calendar-list-slider-item-checkbox" style="background: ${0}"></div>
						`),e.COLOR),o.Text.encode(e.NAME)));this.sectionIndex[s]={item:n,checkbox:i};if(this.selected[s]||!o.Type.isArray(this.firstTrackingUserIdList)||!this.firstTrackingUserIdList.includes(parseInt(e.OWNER_ID,10))){o.Dom.addClass(i,this.CHECKED_CLASS)}}))}return t}sectionClick(e){var t;const s=c.Util.findTargetNode(e.target||e.srcElement,this.DOM.outerWrap);if(!o.Type.isElementNode(s)){return}const i=s.getAttribute("data-bx-calendar-section");if(i===null){return}if(!((t=this.sectionIndex[i])!=null&&t.checkbox)){return}if(o.Dom.hasClass(this.sectionIndex[i].checkbox,this.CHECKED_CLASS)){o.Dom.removeClass(this.sectionIndex[i].checkbox,this.CHECKED_CLASS)}else{o.Dom.addClass(this.sectionIndex[i].checkbox,this.CHECKED_CLASS)}}keyHandler(e){if(e.keyCode===c.Util.getKeyCode("escape")){this.close()}else if(e.keyCode===c.Util.getKeyCode("enter")){this.save()}}checkInnerWrapHeight(){if(this.checkHeightTimeout){clearTimeout(this.checkHeightTimeout);this.checkHeightTimeout=null}this.checkHeightTimeout=setTimeout((()=>{if(o.Dom.hasClass(this.DOM.outerWrap,"show")){if(this.DOM.outerWrap.offsetHeight-this.DOM.innerWrap.offsetHeight<36){const e=parseInt(this.DOM.innerWrap.offsetHeight,10)+200;this.DOM.outerWrap.style.maxHeight=`${e}px`}}else{this.DOM.outerWrap.style.maxHeight=""}}),300)}}let O=e=>e,b,w;class v extends I{constructor(e={}){super(e);this.interfaceType="groups";this.trackingIdList=e.trackingGroups||[];this.collabs=e.collabs||[]}create(){if(!this.DOM.innerWrap){this.DOM.innerWrap=this.DOM.outerWrap.appendChild(o.Tag.render(b||(b=O`<div></div>`)))}this.selectorWrap=this.DOM.innerWrap.appendChild(o.Dom.create("DIV",{props:{className:"calendar-list-slider-selector-wrap"}}));this.groupTagSelector=new a.TagSelector({dialogOptions:{width:320,context:"CALENDAR",preselectedItems:this.trackingIdList.map((e=>["project",e])),events:{"Item:onSelect":this.handleGroupSelectorChanges.bind(this),"Item:onDeselect":this.handleGroupSelectorChanges.bind(this)},entities:this.getSelectorEntities()}});this.groupTagSelector.renderTo(this.selectorWrap);this.sectionsWrap=this.DOM.innerWrap.appendChild(o.Tag.render(w||(w=O`<div class="calendar-list-slider-sections-wrap"></div>`)));this.createButtons();this.isCreated=true}handleGroupSelectorChanges(){const e=this.groupTagSelector.getDialog().getSelectedItems();this.trackingIdList=[];e.forEach((e=>{if(e.entityType==="project"){this.trackingIdList.push(e.id)}}));this.updateSectionList()}updateSectionList(){if(this.updateSectionLoader){o.Dom.remove(this.updateSectionLoader)}this.updateSectionLoader=this.sectionsWrap.appendChild(o.Dom.adjust(c.Util.getLoader(),{style:{height:"140px"}}));if(this.updateSectionTimeout){clearTimeout(this.updateSectionTimeout);this.updateSectionTimeout=null}this.checkInnerWrapHeight();BX.ajax.runAction("calendar.api.calendarajax.getTrackingSections",{data:{groupIdList:this.trackingIdList,type:this.interfaceType}}).then((e=>{o.Dom.clean(this.sectionsWrap);this.sectionIndex={};this.checkInnerWrapHeight();this.createSectionBlock({sectionList:e.data.sections,wrap:this.sectionsWrap})}),(e=>{c.Util.displayError(e.errors)}))}getSelectedSections(){const e=[];this.superposedSections.forEach((t=>{var s,i;if(this.interfaceType==="groups"&&t.type==="group"&&!((s=this.trackingIdList)!=null&&s.includes(t.ownerId))&&!((i=this.collabs)!=null&&i.includes(t.ownerId))){return}e.push(parseInt(t.id,10))}));return e}getSelectorEntities(){return[{id:"project",options:{lockProjectLink:!c.Util.isProjectFeatureEnabled(),lockProjectLinkFeatureId:"socialnetwork_projects_groups","!type":["collab"]}}]}}class y extends v{constructor(e={}){super(e);this.interfaceType="collabs";this.trackingIdList=e.trackingCollabs||[];this.groups=e.groups||[]}getSelectedSections(){const e=[];this.superposedSections.forEach((t=>{var s,i;if(this.interfaceType==="collabs"&&t.type==="group"&&!((s=this.trackingIdList)!=null&&s.includes(t.ownerId))&&!((i=this.groups)!=null&&i.includes(t.ownerId))){return}e.push(parseInt(t.id,10))}));return e}handleGroupSelectorChanges(){const e=this.groupTagSelector.getDialog().getSelectedItems();this.trackingIdList=[];e.forEach((e=>{if(e.entityType!=="collab"){return}this.trackingIdList.push(e.id)}));this.updateSectionList()}getSelectorEntities(){return[{id:"project",options:{type:["collab"],createProjectLink:false}}]}}let A=e=>e,x,N,B;class W extends I{constructor(e={}){super(e);this.trackingGroups=e.trackingGroups||[];this.interfaceType="company";this.selectGroups=true;this.selectUsers=false;this.addLinkMessage=o.Loc.getMessage("EC_SEC_SLIDER_SELECT_GROUPS")}show(){if(!this.isCreated){this.create()}this.updateSectionList();this.isOpenedState=true;o.Dom.addClass(this.DOM.outerWrap,"show")}create(){if(!this.DOM.innerWrap){this.DOM.innerWrap=this.DOM.outerWrap.appendChild(o.Tag.render(x||(x=A`<div></div>`)))}this.sectionsWrap=this.DOM.innerWrap.appendChild(o.Tag.render(N||(N=A`<div class="calendar-list-slider-sections-wrap"></div>`)));this.createButtons();this.isCreated=true}updateSectionList(){if(this.updateSectionLoader){o.Dom.remove(this.updateSectionLoader)}this.updateSectionLoader=this.sectionsWrap.appendChild(o.Dom.adjust(c.Util.getLoader(),{style:{height:"140px"}}));if(this.updateSectionTimeout){clearTimeout(this.updateSectionTimeout);this.updateSectionTimeout=null}BX.ajax.runAction("calendar.api.calendarajax.getTrackingSections",{data:{type:"company"}}).then((e=>{o.Dom.clean(this.sectionsWrap);this.sectionIndex={};this.checkInnerWrapHeight();if(o.Type.isArray(e.data.sections)&&e.data.sections.length){this.createSectionBlock({sectionList:e.data.sections,wrap:this.sectionsWrap})}else{this.sectionsWrap.appendChild(o.Tag.render(B||(B=A`
						<div>
							<span class="calendar-list-slider-card-section-title-text">
								${0}
							</span>
						</div>
					`),o.Loc.getMessage("EC_SEC_SLIDER_NO_SECTIONS")))}}),(e=>{c.Util.displayError(e.errors)}));this.checkInnerWrapHeight()}save(){BX.ajax.runAction("calendar.api.calendarajax.setTrackingSections",{data:{sections:this.prepareTrackingSections()}}).then((()=>location.reload()),(e=>c.Util.displayError(e.errors)));this.close()}getSelectedSections(){const e=[];this.superposedSections.forEach((t=>e.push(parseInt(t.id,10))));return e}}let P=e=>e,U,R,F,H,X,G,$,V,j,Y,K,q,z,J,Q,Z,ee,te,se,ie,ne,ae,oe,ce,re,le,de,he,pe;class ue extends n.EventEmitter{constructor({calendarContext:e,readonly:t,sectionManager:s,isCollabFeatureEnabled:i=false}){var n,a;super();this.name="sectioninterface";this.uid=null;this.DOM={};this.SLIDER_WIDTH=400;this.SLIDER_DURATION=80;this.sliderId="calendar:section-slider";this.denyClose=false;this.deletedSectionsIds=[];this.isCollabFeatureEnabled=false;this.setEventNamespace("BX.Calendar.SectionInterface");this.sectionManager=s;this.calendarContext=e;this.readonly=t;this.BX=c.Util.getBX();this.deleteSectionHandlerBinded=this.deleteSectionHandler.bind(this);this.refreshSectionListBinded=this.refreshSectionList.bind(this);this.keyHandlerBinded=this.keyHandler.bind(this);this.currentUserId=(n=this.calendarContext)==null?void 0:(a=n.currentUser)==null?void 0:a.id;this.isCollabFeatureEnabled=i;if(this.calendarContext!==null&&this.calendarContext.util.config.accessNames){var o,r,l;c.Util.setAccessNames((o=this.calendarContext)==null?void 0:(r=o.util)==null?void 0:(l=r.config)==null?void 0:l.accessNames)}}show(){this.BX.SidePanel.Instance.open(this.sliderId,{contentCallback:this.createContent.bind(this),width:this.SLIDER_WIDTH,animationDuration:this.SLIDER_DURATION,events:{onCloseByEsc:this.escHide.bind(this),onClose:this.hide.bind(this),onCloseComplete:this.destroy.bind(this),onLoad:this.onLoadSlider.bind(this)}});this.addEventEmitterSubscriptions();o.Event.bind(document,"keydown",this.keyHandlerBinded)}addEventEmitterSubscriptions(){this.BX.Event.EventEmitter.subscribe("BX.Calendar.Section:delete",this.deleteSectionHandlerBinded);this.BX.Event.EventEmitter.subscribe("BX.Calendar.Section:pull-delete",this.deleteSectionHandlerBinded);this.BX.Event.EventEmitter.subscribe("BX.Calendar.Section:edit",this.refreshSectionListBinded);this.BX.Event.EventEmitter.subscribe("BX.Calendar.Section:pull-reload-data",this.refreshSectionListBinded)}destroyEventEmitterSubscriptions(){this.BX.Event.EventEmitter.unsubscribe("BX.Calendar.Section:delete",this.deleteSectionHandlerBinded);this.BX.Event.EventEmitter.unsubscribe("BX.Calendar.Section:pull-delete",this.deleteSectionHandlerBinded);this.BX.Event.EventEmitter.unsubscribe("BX.Calendar.Section:edit",this.refreshSectionListBinded);this.BX.Event.EventEmitter.unsubscribe("BX.Calendar.Section:pull-reload-data",this.refreshSectionListBinded)}escHide(e){if(e&&e.getSlider&&e.getSlider().getUrl()===this.sliderId&&this.denyClose){e.denyAction()}}hide(e){if(e&&e.getSlider&&e.getSlider().getUrl()===this.sliderId){this.closeForms();this.destroyEventEmitterSubscriptions();o.Event.unbind(document,"keydown",this.keyHandlerBinded)}}close(){BX.SidePanel.Instance.close()}destroy(e){if(e&&e.getSlider&&e.getSlider().getUrl()===this.sliderId){this.destroyEventEmitterSubscriptions();o.Event.unbind(document,"keydown",this.keyHandlerBinded);c.Util.getBX().Event.EventEmitter.unsubscribe("BX.Calendar.Section:delete",this.deleteSectionHandlerBinded);c.Util.getBX().Event.EventEmitter.unsubscribe("BX.Calendar.Section:pull-delete",this.deleteSectionHandlerBinded);BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.SidePanel.Instance.destroy(this.sliderId);delete this.DOM.localSectionListWrap;this.deletedSectionsIds=[];if(this.sectionActionMenu){this.sectionActionMenu.close()}if(this.trackingTypesForm){delete this.trackingTypesForm}if(this.trackingUsersForm){delete this.trackingUsersForm}if(this.trackingGroupsForm){delete this.trackingGroupsForm}if(this.trackingCollabsForm){delete this.trackingCollabsForm}if(this.addBtnMenu){this.addBtnMenu.destroy();delete this.addBtnMenu}}}createContent(){this.DOM.outerWrap=o.Tag.render(U||(U=P`
			<div class="calendar-list-slider-wrap"></div>
		`));this.DOM.titleWrap=this.DOM.outerWrap.appendChild(o.Tag.render(R||(R=P`
				<div class="calendar-list-slider-title-container">
					<div class="calendar-list-slider-title"> 
						${0}
					</div>
				</div>
			`),o.Loc.getMessage("EC_SECTION_BUTTON")));const e=this.calendarContext||c.Util.getCalendarContext();if(e&&!this.readonly){this.DOM.sectionFormWrap=this.DOM.outerWrap.appendChild(o.Tag.render(F||(F=P`
					<div class="calendar-list-slider-card-widget calendar-list-slider-form-wrap">
						<div class="calendar-list-slider-card-widget-title">
							<span class="calendar-list-slider-card-widget-title-text">
								${0}
							</span>
						</div>
					</div>
				`),o.Loc.getMessage("EC_SEC_SLIDER_NEW_SECTION")))}if(e&&!this.readonly&&(!e.util.isUserCalendar()||e.util.userIsOwner())){this.createAddButton();this.DOM.trackingGroupsFormWrap=this.DOM.outerWrap.appendChild(o.Tag.render(H||(H=P`
					<div class="calendar-list-slider-card-widget calendar-list-slider-form-wrap">
						<div class="calendar-list-slider-card-widget-title">
							<span class="calendar-list-slider-card-widget-title-text">
								${0}
							</span>
						</div>
					</div>
				`),o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_GROUP")));this.DOM.trackingCollabsFormWrap=this.DOM.outerWrap.appendChild(o.Tag.render(X||(X=P`
					<div class="calendar-list-slider-card-widget calendar-list-slider-form-wrap">
						<div class="calendar-list-slider-card-widget-title">
							<span class="calendar-list-slider-card-widget-title-text">
								${0}
							</span>
						</div>
					</div>
				`),o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_COLLAB")));this.DOM.trackingUsersFormWrap=this.DOM.outerWrap.appendChild(o.Tag.render(G||(G=P`
					<div class="calendar-list-slider-card-widget calendar-list-slider-form-wrap">
						<div class="calendar-list-slider-card-widget-title">
							<span class="calendar-list-slider-card-widget-title-text">
								${0}
							</span>
						</div>
					</div>
				`),o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_USER")));this.DOM.trackingTypesFormWrap=this.DOM.outerWrap.appendChild(o.Tag.render($||($=P`
					<div class="calendar-list-slider-card-widget calendar-list-slider-form-wrap">
						<div class="calendar-list-slider-card-widget-title">
							<span class="calendar-list-slider-card-widget-title-text">
								${0}
							</span>
						</div>
					</div>
				`),o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_COMP")))}this.createSectionList();return this.DOM.outerWrap}onLoadSlider(e){this.slider=e.getSlider();this.sliderId=this.slider.getUrl();this.DOM.content=this.slider.layout.content}createSectionList(){this.sliderSections=this.sectionManager.getSections().filter((e=>!this.deletedSectionsIds.find((t=>t===e.id))));if(o.Type.isElementNode(this.DOM.sectonListOuterWrap)){o.Dom.remove(this.DOM.sectonListOuterWrap)}this.DOM.sectonListOuterWrap=this.DOM.outerWrap.appendChild(o.Tag.render(V||(V=P`<div></div>`)));o.Event.bind(this.DOM.sectonListOuterWrap,"click",this.sectionClickHandler.bind(this));this.createLocalSectionsList();this.createExternalSectionsList()}createLocalSectionsList(){this.DOM.localSectionListWrap=this.DOM.sectonListOuterWrap.appendChild(this.getSectionListWrap(this.getLocalSectionListTitle()));this.createSectionsBlock({wrap:this.DOM.localSectionListWrap,sectionList:this.sliderSections.filter((e=>e.externalTypeIsLocal()&&e.belongsToView()||e.isPseudo()))});this.createCompanySectionList();this.createUsersSectionList();this.createGroupsSectionList();this.createCollabSectionList()}createExternalSectionsList(){const e=this.sliderSections.filter((e=>!e.externalTypeIsLocal()&&e.belongsToView()));this.DOM.extSectionListWrap=[];e.forEach((e=>{const t=this.getSectionListWrapForSection(e);this.createSectionUnit({section:e,wrap:t})}))}getSectionListWrapForSection(e){var t;let s=e.getExternalType();if(e.isGoogle()){s="google"}if(e.data.IS_EXCHANGE){s="exchange"}const i=r.SectionManager.getSectionExternalConnection(e,s);const n=this.calendarContext||c.Util.getCalendarContext();e.data.CAL_DAV_CON=(i==null?void 0:(t=i.addParams)==null?void 0:t.id)||null;const a=s+(i?i.getId():"-disconnected");if(!o.Type.isElementNode(this.DOM.extSectionListWrap[a])){const t=this.DOM.sectonListOuterWrap.appendChild(this.getSectionListWrap(this.getExternalConnectionBlockTitle({type:s,connection:i})));t.appendChild(o.Tag.render(j||(j=P`
				<div class="calendar-list-slider-widget-content">
					<div class="calendar-list-slider-widget-content-block">
						${0}
					</div>
				</div>
			`),this.DOM.extSectionListWrap[a]=o.Tag.render(Y||(Y=P`<ul class="calendar-list-slider-container"/>`))));if(!i&&n&&n.util.userIsOwner()&&!e.isArchive()&&(!e.isExchange()||!n.util.config.bExchange&&e.isExchange())){t.querySelector(".calendar-list-slider-widget-content-block").appendChild(o.Tag.render(K||(K=P`
							<div data-bx-calendar-open-sync="Y" class="calendar-list-slider-card-widget-bottom-button">
								<span class="calendar-list-slider-link">
									${0}
								</span>
							</div>
						`),o.Loc.getMessage("EC_SEC_SLIDER_ADJUST_SYNC")));t.querySelector(".calendar-list-slider-card-widget-title").appendChild(o.Tag.render(q||(q=P`
							<span class="calendar-list-slider-card-widget-title-text calendar-list-title-disabled" >
								${0}
							</span>
						`),o.Loc.getMessage("EC_SEC_SLIDER_SYNC_DISABLED")))}else if(e.isArchive()){const e=t.querySelector(".calendar-list-slider-card-widget-title").appendChild(o.Tag.render(z||(z=P`
						<div class="ui-icon ui-icon-common-question calendar-list-slider-archive-hint"
						data-hint="${0}">
							<i></i>	
						</div>
					`),o.Loc.getMessage("EC_SEC_SLIDER_TYPE_ARCHIVE_HELPER")));if(o.Type.isDomNode(e)){c.Util.initHintNode(e)}}}return this.DOM.extSectionListWrap[a]}getExternalConnectionBlockTitle({type:e,connection:t}){let s="";const i=t?t.getConnectionAccountName()||t.getConnectionName():null;switch(e){case"google":if(i){s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_GOOGLE",{"#CONNECTION_NAME#":i})}else{s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_GOOGLE_DIS")}break;case"office365":if(i){s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_OFFICE365",{"#CONNECTION_NAME#":i})}else{s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_OFFICE365_DIS")}break;case"icloud":if(i){s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_ICLOUD",{"#CONNECTION_NAME#":i})}else{s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_ICLOUD_DIS")}break;case"caldav":if(i){if(t.getType()==="yandex"){s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_YANDEX",{"#CONNECTION_NAME#":i})}else{s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_CALDAV",{"#CONNECTION_NAME#":i})}}else{s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_DEFAULT")}break;case"exchange":s=o.Loc.getMessage("EC_CAL_SYNC_EXCHANGE");break;case"archive":s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_ARCHIVE");break;default:s=o.Loc.getMessage("EC_SEC_SLIDER_TYPE_DEFAULT")}return s}createCompanySectionList(){const e=this.sliderSections.filter((e=>e.isCompanyCalendar()&&!e.belongsToView()));if(e.length>0){this.DOM.localSectionListWrap.appendChild(o.Tag.render(J||(J=P`
				<div class="calendar-list-slider-card-section-title">
					<span class="calendar-list-slider-card-section-title-text">
						${0}
					</span>
				</div>
			`),o.Loc.getMessage("EC_SEC_SLIDER_TITLE_COMP_CALENDAR")));this.createSectionsBlock({wrap:this.DOM.localSectionListWrap,sectionList:this.sliderSections.filter((e=>e.isCompanyCalendar()))})}}createUsersSectionList(){this.calendarContext.util.getSuperposedTrackedUsers().forEach((e=>{const t=this.sliderSections.filter((t=>!t.belongsToView()&&t.type==="user"&&t.data.OWNER_ID===e.ID));if(t.length>0){const s=this.currentUserId===parseInt(e.ID,10)?o.Loc.getMessage("EC_SEC_SLIDER_MY_CALENDARS_LIST"):o.Text.encode(e.FORMATTED_NAME);this.DOM.localSectionListWrap.appendChild(o.Tag.render(Q||(Q=P`
					<div class="calendar-list-slider-card-section-title">
						<span class="calendar-list-slider-card-section-title-text">
							${0}
						</span>
					</div>
				`),s));this.createSectionsBlock({wrap:this.DOM.localSectionListWrap,sectionList:t})}}))}createGroupsSectionList(){const e=this.sliderSections.filter((e=>!e.belongsToView()&&e.type==="group"&&!e.isCollab()));if(e.length>0){this.DOM.localSectionListWrap.appendChild(o.Tag.render(Z||(Z=P`
				<div class="calendar-list-slider-card-section-title">
					<span class="calendar-list-slider-card-section-title-text">
						${0}
					</span>
				</div>
			`),o.Loc.getMessage("EC_SEC_SLIDER_TITLE_GROUP_CALENDAR")));this.createSectionsBlock({wrap:this.DOM.localSectionListWrap,sectionList:e})}}createCollabSectionList(){const e=this.sliderSections.filter((e=>!e.belongsToView()&&e.type==="group"&&e.isCollab()));if(e.length>0){this.DOM.localSectionListWrap.appendChild(o.Tag.render(ee||(ee=P`
				<div class="calendar-list-slider-card-section-title">
					<span class="calendar-list-slider-card-section-title-text">
						${0}
					</span>
				</div>
			`),o.Loc.getMessage("EC_SEC_SLIDER_TITLE_COLLAB_CALENDAR")));this.createSectionsBlock({wrap:this.DOM.localSectionListWrap,sectionList:e})}}getSectionListWrap(e){return o.Tag.render(te||(te=P`
			<div class="calendar-list-slider-card-widget">
				<div class="calendar-list-slider-card-widget-title">
					<span class="calendar-list-slider-card-widget-title-text">
						${0}
					</span>
				</div>
			</div>
		`),o.Text.encode(e))}getLocalSectionListTitle(){if(this.sectionManager.calendarType==="user"){return o.Loc.getMessage("EC_SEC_SLIDER_MY_CALENDARS_LIST")}const e=this.calendarContext||c.Util.getCalendarContext();if(this.sectionManager.calendarType==="group"&&e!=null&&e.isCollabCalendar){return o.Loc.getMessage("EC_SEC_SLIDER_THIS_COLLAB_CALENDARS_LIST")}if(this.sectionManager.calendarType==="group"&&!(e!=null&&e.isCollabCalendar)){return o.Loc.getMessage("EC_SEC_SLIDER_GROUP_CALENDARS_LIST")}return o.Loc.getMessage("EC_SEC_SLIDER_TYPE_CALENDARS_LIST")}createAddButton(){var e;const t=this.calendarContext||c.Util.getCalendarContext();if((e=t.util.config.perm)!=null&&e.edit_section&&!t.isCollabUser){const e=this.DOM.titleWrap.appendChild(o.Tag.render(se||(se=P`
				<span class="ui-btn-split ui-btn-light-border" style="margin-right: 0"></span>
			`)));this.DOM.addButton=e.appendChild(o.Tag.render(ie||(ie=P`
				<span class="ui-btn-main">${0}</span>
			`),o.Loc.getMessage("EC_ADD")));this.DOM.addButtonMore=e.appendChild(o.Tag.render(ne||(ne=P`
				<span class="ui-btn-extra"></span>
			`)));o.Event.bind(this.DOM.addButtonMore,"click",this.showAddButtonPopup.bind(this));o.Event.bind(this.DOM.addButton,"click",this.showEditSectionForm.bind(this))}}showAddButtonPopup(){if(this.addBtnMenu&&this.addBtnMenu.popupWindow&&this.addBtnMenu.popupWindow.isShown()){this.addBtnMenu.close();return}const e=[new s.MenuItem({text:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_NEW_TITLE"),delimiter:true}),{html:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_NEW_MENU"),onclick:()=>{this.addBtnMenu.close();this.showEditSectionForm()}},new s.MenuItem({text:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_EXIST_TITLE"),delimiter:true}),this.getAddCompanyMenuItem(),this.getAddUserMenuItem(),this.getAddGroupMenuItem()];if(this.isCollabFeatureEnabled){e.push(this.getAddCollabMenuItem())}this.addBtnMenu=s.MenuManager.create(`add-btn-${c.Util.getRandomInt()}`,this.DOM.addButtonMore,e,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:15,angle:true,cacheable:false});this.addBtnMenu.show()}getAddCompanyMenuItem(){return{text:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_COMP"),onclick:()=>{this.addBtnMenu.close();this.showTrackingTypesForm()}}}getAddUserMenuItem(){return{text:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_USER"),onclick:()=>{this.addBtnMenu.close();this.showTrackingUsersForm()}}}getAddGroupMenuItem(){const e=this.calendarContext||c.Util.getCalendarContext();if(e.util.config.projectFeatureEnabled){return{text:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_GROUP"),onclick:()=>{this.addBtnMenu.close();this.showTrackingGroupsForm()}}}return{className:"menu-popup-item-lock",text:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_GROUP"),onclick:()=>{this.addBtnMenu.close();i.FeaturePromotersRegistry.getPromoter({featureId:"socialnetwork_projects_groups"}).show()}}}getAddCollabMenuItem(){return{text:o.Loc.getMessage("EC_SEC_SLIDER_POPUP_MENU_ADD_COLLAB"),onclick:()=>{this.addBtnMenu.close();this.showTrackingCollabsForm()}}}createSectionsBlock({sectionList:e,wrap:t}){if(o.Type.isArray(e)){const s=t.appendChild(o.Tag.render(ae||(ae=P`<div class="calendar-list-slider-widget-content"></div>`))).appendChild(o.Tag.render(oe||(oe=P`<div class="calendar-list-slider-widget-content-block"></div>`))).appendChild(o.Tag.render(ce||(ce=P`<ul class="calendar-list-slider-container"></ul>`)));e.forEach((e=>{this.createSectionUnit({section:e,wrap:s})}))}}createSectionUnit({section:e,wrap:t}){if(!e.DOM){e.DOM={}}const s=e.id.toString();const i=t.appendChild(o.Tag.render(re||(re=P`
			<li class="calendar-list-slider-item" data-bx-calendar-section="${0}"></li>
		`),s));const n=i.appendChild(o.Tag.render(le||(le=P`
			<div class="calendar-list-slider-item-checkbox ${0}" style="background-color: ${0}"></div>
		`),e.isShown()?"calendar-list-slider-item-checkbox-checked":"",e.color));const a=i.appendChild(o.Tag.render(de||(de=P`
			<div class="calendar-list-slider-item-name" title="${0}">${0}</div>
		`),o.Text.encode(e.name),o.Text.encode(e.name)));e.DOM.item=i;e.DOM.checkbox=n;e.DOM.title=a;e.DOM.actionCont=i.appendChild(o.Tag.render(he||(he=P`
			<div class="calendar-list-slider-item-actions-container" data-bx-calendar-section-menu="${0}">
				<span class="calendar-list-slider-item-context-menu"></span>
			</div>
		`),s))}sectionClickHandler(e){const t=c.Util.findTargetNode(e.target||e.srcElement,this.DOM.outerWrap);if(t&&t.getAttribute){if(t.getAttribute("data-bx-calendar-section-menu")!==null){let e=t.getAttribute("data-bx-calendar-section-menu");e=e==="tasks"?e:parseInt(e,10);this.showSectionMenu(this.sectionManager.getSection(e),t)}else if(t.getAttribute("data-bx-calendar-section")!==null){this.switchSection(this.sectionManager.getSection(t.getAttribute("data-bx-calendar-section")))}else if(t.getAttribute("data-bx-calendar-open-sync")!==null){this.calendarContext.syncInterface.openSyncPanel()}}}findCheckBoxNodes(e){return this.DOM.sectonListOuterWrap.querySelectorAll(`.calendar-list-slider-item[data-bx-calendar-section='${e}'] .calendar-list-slider-item-checkbox`)}switchSection(e){const t=this.findCheckBoxNodes(e.id);for(const s of t){if(e.isShown()){o.Dom.removeClass(s,"calendar-list-slider-item-checkbox-checked")}else{o.Dom.addClass(s,"calendar-list-slider-item-checkbox-checked")}}if(e.isShown()){e.hide()}else{e.show()}this.calendarContext.reload()}switchOnSection(e){const t=this.findCheckBoxNodes(e.id);for(const s of t){if(!e.isShown()){o.Dom.addClass(s,"calendar-list-slider-item-checkbox-checked")}}if(!e.isShown()){e.show()}}switchOffSection(e){const t=this.findCheckBoxNodes(e.id);for(const s of t){if(e.isShown()){o.Dom.removeClass(s,"calendar-list-slider-item-checkbox-checked")}}if(e.isShown()){e.hide()}}showSectionMenu(e,i){var n,a;const r=[];const l=i.closest("[data-bx-calendar-section]");if(o.Type.isElementNode(l)){o.Dom.addClass(l,"active")}if(e.canDo("view_time")){r.push({text:o.Loc.getMessage("EC_SEC_LEAVE_ONE"),onclick:()=>{this.sectionActionMenu.close();this.showOnlyOneSection(e,this.sectionManager.sections)}})}if(!e.isPseudo()&&e.getLink()&&!e.belongsToView()){r.push({text:o.Loc.getMessage("EC_SEC_OPEN_LINK"),href:e.getLink()})}if(!this.readonly&&e.canDo("edit_section")&&!e.isPseudo()){r.push({text:o.Loc.getMessage("EC_SEC_EDIT"),onclick:()=>{this.sectionActionMenu.close();this.showEditSectionForm({section:e})}})}if(e.isSuperposed()&&!e.belongsToView()){r.push({text:o.Loc.getMessage("EC_SEC_HIDE"),onclick:()=>{this.hideSuperposedHandler(e);this.sectionActionMenu.close()}})}if(e.canBeConnectedToOutlook()&&e.data.EXTERNAL_TYPE==="local"){r.push({text:o.Loc.getMessage("EC_SEC_CONNECT_TO_OUTLOOK"),onclick:()=>{this.sectionActionMenu.close();e.connectToOutlook();this.close()}})}if(!e.isPseudo()&&e.data.EXPORT&&e.data.EXPORT.LINK&&e.data.EXTERNAL_TYPE==="local"&&!((n=this.calendarContext)!=null&&(a=n.util)!=null&&a.isExtranetUser())){r.push({text:o.Loc.getMessage("EC_ACTION_EXPORT"),onclick:()=>{this.sectionActionMenu.close();const s={sectionLink:e.data.EXPORT.LINK,calendarPath:this.calendarContext.util.config.path};if(t.IcalSyncPopup.checkPathes(s)){t.IcalSyncPopup.createInstance(s).show()}else{t.IcalSyncPopup.showPopupWithPathesError()}}})}let d;let h;if(e.data.CAL_DAV_CON&&e.belongsToView()&&this.calendarContext.syncInterface){[d,h]=this.calendarContext.syncInterface.getProviderById(e.data.CAL_DAV_CON)}if(e.canDo("edit_section")&&e.belongsToView()&&!e.isPseudo()&&(!e.isGoogle()&&!h||e.data.EXTERNAL_TYPE==="local"||!h)){r.push({text:o.Loc.getMessage("EC_SEC_DELETE"),onclick:()=>{this.sectionActionMenu.close();this.showSectionConfirm("delete",e)}})}if(e.canDo("edit_section")&&h){if(e.isGoogle()||e.isIcloud()||e.isOffice365()||e.isCalDav()){r.push({text:o.Loc.getMessage("EC_ACTION_EXTERNAL_ADJUST"),onclick:()=>{this.sectionActionMenu.close();if(d){d.openActiveConnectionSlider(h)}}})}if(e.isGoogle()||e.isIcloud()||e.isOffice365()){r.push({text:o.Loc.getMessage("EC_ACTION_HIDE"),onclick:()=>{this.sectionActionMenu.close();this.showSectionConfirm("hideSync",e)}})}else if(e.isCalDav()){r.push({text:o.Loc.getMessage("EC_ACTION_HIDE"),onclick:()=>{this.sectionActionMenu.close();this.showSectionConfirm("hideExternal",e)}})}}if(e.isPseudo()&&e.taskSectionBelongToUser()){r.push({text:o.Loc.getMessage("EC_SEC_EDIT"),onclick:()=>{this.sectionActionMenu.close();this.showEditSectionForm({section:e})}},{text:o.Loc.getMessage("EC_SEC_TASK_HIDE"),onclick:()=>{this.sectionActionMenu.close();BX.userOptions.save("calendar","user_settings","showTasks","N");o.Dom.addClass(e.DOM.item,"calendar-list-slider-item-disappearing");setTimeout((()=>{o.Dom.clean(e.DOM.item,true);BX.reload()}),300)}})}if(r&&r.length>0){this.sectionActionMenu=s.MenuManager.create(`section-menu-${c.Util.getRandomInt()}`,i,r,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:9,angle:true,cacheable:false});this.sectionActionMenu.show();this.sectionActionMenu.popupWindow.subscribe("onClose",(()=>{if(o.Type.isElementNode(l)){o.Dom.removeClass(l,"active")}this.allowSliderClose()}));this.denySliderClose()}}denySliderClose(){this.denyClose=true}allowSliderClose(){this.denyClose=false}closeForms(){if(this.addBtnMenu){this.addBtnMenu.close()}if(this.editSectionForm){this.editSectionForm.close()}if(this.trackingUsersForm){this.trackingUsersForm.close()}if(this.trackingGroupsForm){this.trackingGroupsForm.close()}if(this.trackingCollabsForm){this.trackingCollabsForm.close()}if(this.trackingTypesForm){this.trackingTypesForm.close()}}showEditSectionForm(e={}){if(!this.DOM.sectionFormWrap){return}this.closeForms();const t=this.DOM.sectionFormWrap.querySelector(".calendar-list-slider-card-widget-title-text");this.editSectionForm=new C({wrap:this.DOM.sectionFormWrap,sectionAccessTasks:this.sectionManager.getSectionAccessTasks(),sectionManager:this.sectionManager,closeCallback:()=>{this.allowSliderClose()}});let s=true;if(e.section&&(!e.section.belongsToView()||e.section.isPseudo())){t.innerHTML=o.Loc.getMessage("EC_SEC_SLIDER_EDIT_SECTION_PERSONAL");s=false}else if(e.section&&e.section.id){t.innerHTML=o.Loc.getMessage("EC_SEC_SLIDER_EDIT_SECTION");s=e.section.hasPermission("access")}else{t.innerHTML=o.Loc.getMessage("EC_SEC_SLIDER_NEW_SECTION")}this.editSectionForm.show({showAccess:s,allowChangeName:e.section?!e.section.isPrimaryForConnection():true,section:e.section||{color:c.Util.getRandomColor(),access:this.sectionManager.getDefaultSectionAccess()}});this.denySliderClose()}showTrackingTypesForm(){this.closeForms();if(!this.trackingTypesForm){this.trackingTypesForm=new W({wrap:this.DOM.trackingTypesFormWrap,superposedSections:this.sectionManager.getSuperposedSectionList(),closeCallback:()=>{this.allowSliderClose()}})}this.trackingTypesForm.show();this.denySliderClose()}showTrackingUsersForm(){this.closeForms();if(!this.trackingUsersForm){this.trackingUsersForm=new I({wrap:this.DOM.trackingUsersFormWrap,trackingUsers:this.calendarContext.util.getSuperposedTrackedUsers(),superposedSections:this.sectionManager.getSuperposedSectionList(),closeCallback:()=>{this.allowSliderClose()}})}this.trackingUsersForm.show();this.denySliderClose()}showTrackingGroupsForm(){this.closeForms();if(!this.trackingGroupsForm){const e=this.sectionManager.getSuperposedSectionList();const t=[];const s=[];e.forEach((e=>{if(e.getType()!=="group"){return}const i=e.getOwnerId();if(!e.isCollab()&&!t.includes(i)){t.push(i)}else if(e.isCollab()&&!s.includes(i)){s.push(i)}}));this.trackingGroupsForm=new v({wrap:this.DOM.trackingGroupsFormWrap,trackingGroups:t,collabs:s,superposedSections:e,closeCallback:()=>this.allowSliderClose()})}this.trackingGroupsForm.show();this.denySliderClose()}showTrackingCollabsForm(){this.closeForms();if(!this.trackingCollabsForm){this.trackingCollabsForm=this.createTrackingCollabsForm()}this.trackingCollabsForm.show();this.denySliderClose()}createTrackingCollabsForm(){const e=this.sectionManager.getSuperposedSectionList();const t=[];const s=[];e.forEach((e=>{if(e.getType()!=="group"){return}const i=e.getOwnerId();if(e.isCollab()&&!t.includes(i)){t.push(i)}else if(!e.isCollab()&&!s.includes(i)){s.push(i)}}));return new y({wrap:this.DOM.trackingCollabsFormWrap,trackingCollabs:t,groups:s,superposedSections:e,closeCallback:()=>this.allowSliderClose()})}deleteSectionHandler(e){if(e&&e instanceof this.BX.Event.BaseEvent){const t=e.getData();const s=parseInt(t.sectionId,10);this.sliderSections.forEach(((e,t)=>{if(parseInt(e.id,10)===s){this.sectionManager.deleteSectionHandler(s);this.deletedSectionsIds.push(s);const i=this.DOM.sectonListOuterWrap.querySelectorAll(`.calendar-list-slider-item[data-bx-calendar-section='${s}']`);i.forEach((e=>{o.Dom.addClass(e,"calendar-list-slider-item-disappearing")}));if(!e.externalTypeIsLocal()){const s=this.getSectionListWrapForSection(e);this.sliderSections=BX.util.deleteFromArray(this.sliderSections,t);setTimeout((()=>{i.forEach((e=>{o.Dom.remove(e)}));if(!s.querySelector("li.calendar-list-slider-item")){o.Dom.remove(s.closest(".calendar-list-slider-card-widget"))}}),300)}}}));this.closeForms()}}hideSuperposedHandler(e){const t=this.sectionManager.getSuperposedSectionList();const s=[];let i;for(i=0;i<t.length;i++){if(parseInt(e.id,10)!==parseInt(t[i].id,10)){s.push(parseInt(t[i].id,10))}}BX.ajax.runAction("calendar.api.calendarajax.setTrackingSections",{data:{sections:s}}).then((()=>BX.reload()),(e=>c.Util.displayError(e.errors)))}refreshSectionList(){this.createSectionList()}showOnlyOneSection(e,t){for(const s of t){if(s.id===e.id){this.switchOnSection(s)}else{this.switchOffSection(s)}}this.calendarContext.reload()}keyHandler(e){if(e.keyCode===c.Util.getKeyCode("enter")&&this.DOM.confirmSectionPopup&&this.currentConfirmMode&&this.currentSection){switch(this.currentConfirmMode){case"delete":{this.removeSection(this.currentSection);break}case"hideSync":{this.hideSyncSection(this.currentSection);break}case"hideExternal":{this.hideExternalSection(this.currentSection);break}}}}showSectionConfirm(e,t){this.currentSection=t;this.currentConfirmMode=e;const s=this.getConfirmCallback();const i=this.getOkCaption();this.DOM.confirmSectionPopup=new l.MessageBox({message:this.getSectionConfirmContent(),minHeight:120,minWidth:280,maxWidth:300,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:s,onCancel:()=>{this.DOM.confirmSectionPopup.close()},okCaption:i,popupOptions:{events:{onPopupClose:()=>{delete this.DOM.confirmSectionPopup;delete this.currentSection;delete this.currentConfirmMode}},closeByEsc:true,padding:0,contentPadding:0,animation:"fading-slide"}});this.DOM.confirmSectionPopup.show()}getConfirmCallback(){if(this.currentConfirmMode==="delete"){return()=>{this.removeSection(this.currentSection)}}if(this.currentConfirmMode==="hideSync"){return()=>{this.hideSyncSection(this.currentSection)}}if(this.currentConfirmMode==="hideExternal"){return()=>{this.hideExternalSection(this.currentSection)}}return null}getOkCaption(){if(this.currentConfirmMode==="delete"){return o.Loc.getMessage("EC_SEC_DELETE")}if(this.currentConfirmMode==="hideSync"||this.currentConfirmMode==="hideExternal"){return o.Loc.getMessage("EC_CAL_SYNC_DISCONNECT")}return null}getSectionConfirmContent(){let e="";if(this.currentConfirmMode==="delete"){e=o.Loc.getMessage("EC_SEC_DELETE_CONFIRM")}else if(this.currentConfirmMode==="hideSync"||this.currentConfirmMode==="hideExternal"){e=o.Loc.getMessage("EC_CAL_GOOGLE_HIDE_CONFIRM")}return o.Tag.render(pe||(pe=P`
			<div class="calendar-list-slider-messagebox-text">${0}</div>
		`),e)}removeSection(e){e.remove();this.DOM.confirmSectionPopup.close()}hideSyncSection(e){e.hideSyncSection();this.DOM.confirmSectionPopup.close()}hideExternalSection(e){e.hideExternalCalendarSection();this.DOM.confirmSectionPopup.close()}}e.SectionInterface=ue})(this.BX.Calendar=this.BX.Calendar||{},BX.Calendar.Sync.Interface,BX.Main,BX.UI,BX.Event,BX.UI.EntitySelector,BX,BX.Calendar,BX.Calendar,BX.UI.Dialogs);
//# sourceMappingURL=sectioninterface.bundle.map.js