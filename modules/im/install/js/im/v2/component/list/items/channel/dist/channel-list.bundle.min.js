this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(e,t,s,a,i,r,n,l,o,c,h,d,g,m){"use strict";const u={name:"MessageText",components:{ChatTitle:s.ChatTitle},props:{item:{type:Object,required:true}},data(){return{}},computed:{recentItem(){return this.item},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},formattedDate(){return this.formatDate(this.message.date)},isLastMessageAuthor(){return this.message.authorId===o.Core.getUserId()},lastMessageAuthorAvatar(){const e=this.$store.getters["users/get"](this.message.authorId);if(!e){return""}return e.avatar},lastMessageAuthorAvatarStyle(){return{backgroundImage:`url('${this.lastMessageAuthorAvatar}')`}},messageText(){if(this.message.isDeleted){return this.loc("IM_LIST_RECENT_DELETED_MESSAGE")}const e=i.Parser.purifyRecent(this.recentItem);if(!e){return this.loc("IM_LIST_RECENT_CHAT_TYPE_GROUP_V2")}return e},formattedMessageText(){const e=27;return a.Utils.text.insertUnseenWhitespace(this.messageText,e)}},methods:{formatDate(e){return r.DateFormatter.formatByTemplate(e,r.DateTemplate.recent)},loc(e,t={}){return this.$Bitrix.Loc.getMessage(e,t)}},template:`\n\t\t<div class="bx-im-list-channel-item__message_container">\n\t\t\t<span class="bx-im-list-channel-item__message_text">\n\t\t\t\t<span v-if="isLastMessageAuthor" class="bx-im-list-channel-item__message_author-icon --self"></span>\n\t\t\t\t<template v-else-if="message.authorId">\n\t\t\t\t\t<span v-if="lastMessageAuthorAvatar" :style="lastMessageAuthorAvatarStyle" class="bx-im-list-channel-item__message_author-icon --user"></span>\n\t\t\t\t\t<span v-else class="bx-im-list-channel-item__message_author-icon --user --default"></span>\n\t\t\t\t</template>\n\t\t\t\t<span class="bx-im-list-channel-item__message_text_content">{{ formattedMessageText }}</span>\n\t\t\t</span>\n\t\t</div>\n\t`};const v={name:"ChannelItem",components:{ChatAvatar:s.ChatAvatar,ChatTitle:s.ChatTitle,MessageText:u},props:{item:{type:Object,required:true}},data(){return{}},computed:{AvatarSize:()=>s.AvatarSize,recentItem(){return this.item},formattedDate(){if(this.needsBirthdayPlaceholder){return this.loc("IM_LIST_RECENT_BIRTHDAY_DATE")}return this.formatDate(this.message.date)},formattedCounter(){return this.dialog.counter>99?"99+":this.dialog.counter.toString()},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},layout(){return this.$store.getters["application/getLayout"]},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},isUser(){return this.dialog.type===d.ChatType.user},isChat(){return!this.isUser},isChatSelected(){if(this.layout.name!==d.Layout.channel.name){return false}return this.layout.entityId===this.recentItem.dialogId},isChatMuted(){if(this.isUser){return false}const e=this.dialog.muteList.find((e=>e===o.Core.getUserId()));return Boolean(e)},isSomeoneTyping(){return this.dialog.writingList.length>0},needsBirthdayPlaceholder(){return this.$store.getters["recent/needsBirthdayPlaceholder"](this.recentItem.dialogId)},showLastMessage(){return this.$store.getters["application/settings/get"](d.Settings.recent.showLastMessage)},invitation(){return this.recentItem.invitation},wrapClasses(){return{"--selected":this.isChatSelected}}},methods:{formatDate(e){return r.DateFormatter.formatByTemplate(e,r.DateTemplate.recent)},loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div :data-id="recentItem.dialogId" :class="wrapClasses" class="bx-im-list-channel-item__wrap">\n\t\t\t<div class="bx-im-list-channel-item__container">\n\t\t\t\t<div class="bx-im-list-channel-item__avatar_container">\n\t\t\t\t\t<div class="bx-im-list-channel-item__avatar_content">\n\t\t\t\t\t\t<ChatAvatar \n\t\t\t\t\t\t\t:avatarDialogId="recentItem.dialogId" \n\t\t\t\t\t\t\t:contextDialogId="recentItem.dialogId"\n\t\t\t\t\t\t\t:size="AvatarSize.XL" \n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-list-channel-item__content_container">\n\t\t\t\t\t<div class="bx-im-list-channel-item__content_header">\n\t\t\t\t\t\t<ChatTitle :dialogId="recentItem.dialogId" />\n\t\t\t\t\t\t<div class="bx-im-list-channel-item__date">\n\t\t\t\t\t\t\t<span>{{ formattedDate }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-list-channel-item__content_bottom">\n\t\t\t\t\t\t<MessageText :item="recentItem" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const p={name:"EmptyState",data(){return{}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-list-channel__empty">\n\t\t\t<div class="bx-im-list-channel__empty_icon"></div>\n\t\t\t<div class="bx-im-list-channel__empty_text">{{ loc('IM_LIST_CHANNEL_EMPTY') }}</div>\n\t\t</div>\n\t`};var b=babelHelpers.classPrivateFieldLooseKey("itemsPerPage");var L=babelHelpers.classPrivateFieldLooseKey("isLoading");var M=babelHelpers.classPrivateFieldLooseKey("pagesLoaded");var I=babelHelpers.classPrivateFieldLooseKey("hasMoreItemsToLoad");var _=babelHelpers.classPrivateFieldLooseKey("lastMessageId");var f=babelHelpers.classPrivateFieldLooseKey("requestItems");var P=babelHelpers.classPrivateFieldLooseKey("updateModels");var C=babelHelpers.classPrivateFieldLooseKey("getMinMessageId");class y{constructor(){Object.defineProperty(this,C,{value:S});Object.defineProperty(this,P,{value:x});Object.defineProperty(this,f,{value:B});this.firstPageIsLoaded=false;Object.defineProperty(this,b,{writable:true,value:50});Object.defineProperty(this,L,{writable:true,value:false});Object.defineProperty(this,M,{writable:true,value:0});Object.defineProperty(this,I,{writable:true,value:true});Object.defineProperty(this,_,{writable:true,value:0})}async loadFirstPage(){babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true;const e=await babelHelpers.classPrivateFieldLooseBase(this,f)[f]({firstPage:true});this.firstPageIsLoaded=true;return e}loadNextPage(){if(babelHelpers.classPrivateFieldLooseBase(this,L)[L]||!babelHelpers.classPrivateFieldLooseBase(this,I)[I]){return Promise.resolve()}babelHelpers.classPrivateFieldLooseBase(this,L)[L]=true;return babelHelpers.classPrivateFieldLooseBase(this,f)[f]()}hasMoreItemsToLoad(){return babelHelpers.classPrivateFieldLooseBase(this,I)[I]}}async function B({firstPage:e=false}={}){const t={data:{limit:babelHelpers.classPrivateFieldLooseBase(this,b)[b],filter:{lastMessageId:e?null:babelHelpers.classPrivateFieldLooseBase(this,_)[_]}}};const s=await c.runAction(d.RestMethod.imV2RecentChannelTail,t).catch((e=>{console.error("Im.ChannelList: page request error",e)}));babelHelpers.classPrivateFieldLooseBase(this,M)[M]++;n.Logger.warn(`Im.ChannelList: ${e?"First":babelHelpers.classPrivateFieldLooseBase(this,M)[M]} page request result`,s);const{messages:a,hasNextPage:i}=s;babelHelpers.classPrivateFieldLooseBase(this,_)[_]=babelHelpers.classPrivateFieldLooseBase(this,C)[C](a);if(!i){babelHelpers.classPrivateFieldLooseBase(this,I)[I]=false}babelHelpers.classPrivateFieldLooseBase(this,L)[L]=false;if(e){void o.Core.getStore().dispatch("recent/clearChannelCollection")}return babelHelpers.classPrivateFieldLooseBase(this,P)[P](s)}function x(e){const{users:t,chats:s,messages:a,files:i,recentItems:r}=e;const n=o.Core.getStore().dispatch("users/set",t);const l=o.Core.getStore().dispatch("chats/set",s);const c=o.Core.getStore().dispatch("messages/store",a);const h=o.Core.getStore().dispatch("files/set",i);const d=o.Core.getStore().dispatch("recent/setChannel",r);return Promise.all([n,l,c,h,d])}function S(e){if(e.length===0){return 0}const t=e[0].id;return e.reduce(((e,t)=>Math.min(e,t.id)),t)}const T="IM_SHARED_CHANNEL_LIST";var F=babelHelpers.classPrivateFieldLooseKey("pullClient");var H=babelHelpers.classPrivateFieldLooseKey("requestWatchStart");class A{constructor(){Object.defineProperty(this,H,{value:E});Object.defineProperty(this,F,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,F)[F]=o.Core.getPullClient()}subscribe(){babelHelpers.classPrivateFieldLooseBase(this,F)[F].extendWatch(T);babelHelpers.classPrivateFieldLooseBase(this,H)[H]()}unsubscribe(){babelHelpers.classPrivateFieldLooseBase(this,F)[F].clearWatch(T)}}function E(){void c.runAction(d.RestMethod.imV2RecentChannelExtendPullWatch)}class X extends m.RecentMenu{getMenuItems(){return[this.getOpenItem()]}getOpenItem(){return{text:h.Loc.getMessage("IM_LIB_MENU_OPEN"),onclick:()=>{g.LayoutManager.getInstance().setLayout({name:d.Layout.channel.name,entityId:this.context.dialogId});this.menuInstance.close()}}}}const w={name:"ChannelList",components:{EmptyState:p,LoadingState:s.ListLoadingState,ChannelItem:v},emits:["chatClick"],data(){return{isLoading:false,isLoadingNextPage:false,firstPageLoaded:false}},computed:{collection(){return this.$store.getters["recent/getChannelCollection"]},preparedItems(){return[...this.collection].sort(((e,t)=>{const s=this.$store.getters["messages/getById"](e.messageId);const a=this.$store.getters["messages/getById"](t.messageId);return a.date-s.date}))},isEmptyCollection(){return this.collection.length===0}},created(){this.contextMenuManager=new X},beforeUnmount(){this.contextMenuManager.destroy()},async activated(){this.isLoading=true;await this.getRecentService().loadFirstPage();this.firstPageLoaded=true;this.isLoading=false;this.getPullWatchManager().subscribe()},deactivated(){this.getPullWatchManager().unsubscribe()},methods:{async onScroll(e){this.contextMenuManager.close();if(!a.Utils.dom.isOneScreenRemaining(e.target)||!this.getRecentService().hasMoreItemsToLoad){return}this.isLoadingNextPage=true;await this.getRecentService().loadNextPage();this.isLoadingNextPage=false},onClick(e){this.$emit("chatClick",e.dialogId)},onRightClick(e,t){t.preventDefault();this.contextMenuManager.openMenu(e,t.currentTarget)},getRecentService(){if(!this.service){this.service=new y}return this.service},getPullWatchManager(){if(!this.pullWatchManager){this.pullWatchManager=new A}return this.pullWatchManager},loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div class="bx-im-list-channel__container">\n\t\t\t<LoadingState v-if="isLoading && !firstPageLoaded" />\n\t\t\t<div v-else @scroll="onScroll" class="bx-im-list-channel__scroll-container">\n\t\t\t\t<EmptyState v-if="isEmptyCollection" />\n\t\t\t\t<div class="bx-im-list-channel__general_container">\n\t\t\t\t\t<ChannelItem\n\t\t\t\t\t\tv-for="item in preparedItems"\n\t\t\t\t\t\t:key="item.dialogId"\n\t\t\t\t\t\t:item="item"\n\t\t\t\t\t\t@click="onClick(item)"\n\t\t\t\t\t\t@click.right="onRightClick(item, $event)"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<LoadingState v-if="isLoadingNextPage" />\n\t\t\t</div>\n\t\t</div>\n\t`};e.ChannelList=w})(this.BX.Messenger.v2.Component.List=this.BX.Messenger.v2.Component.List||{},BX.Main,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=channel-list.bundle.map.js