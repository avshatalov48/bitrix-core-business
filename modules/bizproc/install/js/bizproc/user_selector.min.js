if(!BX.getClass("BX.Bizproc.UserSelector"))(function(e){"use strict";e.namespace("BX.Bizproc");const t=new WeakMap;const i=function(t,i){if(!e.type.isPlainObject(i)){i={}}const s=t.getAttribute("data-config")?e.parseJSON(t.getAttribute("data-config")):null;t.removeAttribute("data-config");if(e.type.isPlainObject(s)){Object.assign(i,s)}this.config=i;this.container=t||e.create("div");this.isOnlyDialogMode=i.isOnlyDialogMode||false;this.multiple=i.multiple||false;this.required=i.required||false;this.additionalFields=e.type.isArray(i.additionalFields)?i.additionalFields:[];this.preloadedItems=e.Type.isArray(i.items)?i.items:[];this.prepareRoles();if(!this.isOnlyDialogMode){this.prepareNodes()}else{this.prepareDialogOnly()}};i.decorateNode=function(e,s){let n=t.get(e);if(!n){n=new i(e,s);t.set(e,n)}return n};i.getByNode=function(e){return t.get(e)};i.prototype={prepareNodes:function(){const t=this.config.value?this.parseValue(this.config.value):[];this.tagSelector=new e.UI.EntitySelector.TagSelector({multiple:this.multiple,addButtonCaption:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_CHOOSE"),addButtonCaptionMore:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_EDIT"),items:t,tagMaxWidth:184,events:{onTagAdd:e=>this.addItem(e.getData().tag),onTagRemove:e=>this.removeItem(e.getData().tag)},dialogOptions:this.getDialogOptions()});this.container.classList.remove(...this.container.classList);this.container.className="bizproc-type-control-user--width";this.tagSelector.renderTo(this.container);this.createValueNode(this.config.valueInputName||"");this.tagSelector.getTags().forEach((e=>this.addItem(e)))},getDialogOptions:function(){return{context:"BIZPROC",showCreateButton:false,width:400,tabs:[{id:"bpuserroles",title:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_ROLE_TAB")}],entities:[{id:"user",options:{inviteEmployeeLink:false,inviteGuestLink:false,emailUsers:this.config.allowEmailUsers===true,myEmailUsers:this.config.allowEmailUsers===true}},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"bpuserroles",name:e.Loc.getMessage("BIZPROC_JS_USER_SELECTOR_ROLE_TAB"),tagOptions:{default:{textColor:"#207976",bgColor:"#ade7e4"},inactive:{textColor:"grey"}}}],items:Object.values(this.roles)}},prepareDialogOnly:function(){const t={events:{"Item:onBeforeSelect":t=>{t.preventDefault();t.getTarget().hide();const i=t.getData().item;const s=this.convertItemToValue(i,i.getEntityId());if(this.config.callbacks&&e.type.isFunction(this.config.callbacks.select)){this.config.callbacks.select(s,this)}}}};this.dialog=new e.UI.EntitySelector.Dialog(Object.assign(this.getDialogOptions(),t));e.bind(this.container,"click",(e=>{e.preventDefault();this.dialog.show()}))},createValueNode:function(t){this.valueNode=e.create("input",{props:{type:"hidden",name:t}});this.container.appendChild(this.valueNode)},addItem:function(e){this.setValue(e)},toggleItem:function(e){if(!this.tagSelector){return}const t=this.tagSelector.getTag(e);if(t){this.tagSelector.removeTag(t)}else{this.tagSelector.addTag(e)}},removeItem:function(e){this.unsetValue(e)},destroy:function(){this.tagSelector=null;this.dialog=null;this.container=null;this.valueNode=null},setValue:function(e){const t=this.getValueId(e,e.getEntityId());const i=this.convertItemToValue(e,e.getEntityId());if(!this.multiple){this.valueNode.value=i}else{var s,n=[],o=this.valueNode.value.split(",");for(s=0;s<o.length;++s){if(!o[s]||o[s].indexOf(t)>=0){continue}n.push(o[s])}n.push(i);this.valueNode.value=n.join(",")}},convertItemToValue:function(e,t){const i=this.getValueId(e,t);let s=i;const n=this.getItemName(e);if(t==="user"){s=[n,i].join(" ")}else if(t==="department"){s=[n,i].join(" ")}else if(t==="bpuserroles"&&s.indexOf("G")===1){s=[n,i].join(" ")}else if(t==="bpuserroles"&&s.indexOf("{")===-1){s=n}return s},unsetValue:function(e){const t=this.getValueId(e,e.getEntityId());if(!this.multiple){this.valueNode.value=""}else{const e=[];const i=this.valueNode.value.split(",");for(let s=0;s<i.length;++s){if(!i[s]||i[s].indexOf(t)>=0){continue}e.push(i[s])}this.valueNode.value=e.join(",")}},getValueId:function(e,t){const i=e.getId().toString();if(t==="user"){return"["+i+"]"}else if(t==="department"){return"[DR"+i+"]"}else if(t==="bpuserroles"&&i.indexOf("G")===0){return"["+i+"]"}else if(t==="bpuserroles"&&i.indexOf("{")===-1){return this.getItemName(e)}return i},getItemName(e){return e.getTitle().replace(/[,\.\_\>\<\"]/g,"")},getValue:function(){return this.valueNode.value},parseValue:function(t){t=this.prepareValueString(t);var i,s,n,o,r,a=[],l,u=t.split(","),c,d;for(i=0;i<u.length;++i){l=e.util.trim(u[i]);if(c=l.match(/(.*)\[([A-Z]{0,2})(\d+)\]/)){let t=true;s=e.util.trim(c[1]);o=c[3];n=c[2]+o;r=c[2]===""?"user":"bpuserroles";if(r==="user"&&n[0]==="U"){n=n.replace("U","")}if(c[2]==="DR"){r="department";n=n.replace("DR","")}if(c[2]==="G"){t=false}if(t){n=e.Text.toInteger(n)}const i=this.preloadedItems.find((e=>e.id===n&&e.entityId===r));a.push(i||{id:n,entityId:r,title:s})}else{d=false;if(this.roles[l]){d=true;a.push(this.roles[l])}if(!d&&this.getGroups().length){this.getGroups().forEach((function(e){if(l===e["name"]){d=true;a.push({id:e["id"],entityId:"bpuserroles",title:e["name"]})}}))}if(!d){a.push({id:l,entityId:"bpuserroles",title:l})}}}return a},prepareValueString:function(t){t=t.toString();if(t.indexOf("{{")>=0){var i=e.Bizproc.FieldType.getDocumentFields();i.forEach((function(e){if(e["Type"]==="user"){t=t.replace(e["Expression"],e["SystemExpression"])}}))}return t},prepareRoles:function(){var t=e.Bizproc.FieldType.getDocumentFields();var i={};if(this.getGroups().length){this.getGroups().forEach((function(e){i[e["id"]]={id:e["id"],entityId:"bpuserroles",title:e["name"],tabs:"bpuserroles",name:e.name}}))}t.forEach((function(e){if(e["Type"]==="user"){i[e["SystemExpression"]]={id:e["SystemExpression"],entityId:"bpuserroles",title:e["Name"],tabs:"bpuserroles"}}}));this.additionalFields.forEach((function(e){i[e["id"]]={id:e["id"],entityId:e.entityId?String(e.entityId).toLowerCase():"bpuserroles",title:e.title||e.name,tabs:e.tabs||"bpuserroles",sort:e.sort}}));this.roles=i},getGroups:function(){return this.config.groups||e.Bizproc.FieldType.getDocumentUserGroups()}};e.Bizproc.UserSelector=i})(window.BX||window.top.BX);
//# sourceMappingURL=user_selector.map.js