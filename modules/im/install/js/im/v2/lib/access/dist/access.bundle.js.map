{"version":3,"file":"access.bundle.js","sources":["../src/classes/access-service.js","../src/classes/history-limit-popup.js","../src/access.js"],"sourcesContent":["import { RestMethod } from 'im.v2.const';\nimport { runAction, type RunActionError } from 'im.v2.lib.rest';\n\nexport const AccessErrorCode = {\n\taccessDenied: 'ACCESS_DENIED',\n\tchatNotFound: 'CHAT_NOT_FOUND',\n\tmessageNotFound: 'MESSAGE_NOT_FOUND',\n\tmessageAccessDenied: 'MESSAGE_ACCESS_DENIED',\n\tmessageAccessDeniedByTariff: 'MESSAGE_ACCESS_DENIED_BY_TARIFF',\n};\n\nexport type AccessCheckResult = { hasAccess: boolean, errorCode?: string };\n\nexport const AccessService = {\n\tasync checkMessageAccess(messageId: number): Promise<AccessCheckResult>\n\t{\n\t\tconst payload = { data: { messageId } };\n\n\t\ttry\n\t\t{\n\t\t\tawait runAction(RestMethod.imV2AccessCheck, payload);\n\t\t}\n\t\tcatch (errors)\n\t\t{\n\t\t\treturn handleAccessError(errors);\n\t\t}\n\n\t\treturn Promise.resolve({ hasAccess: true });\n\t},\n};\n\nconst handleAccessError = (errors: RunActionError[]): AccessCheckResult => {\n\tconst [error] = errors;\n\tconst availableCodes = Object.values(AccessErrorCode);\n\tif (!availableCodes.includes(error.code))\n\t{\n\t\tconsole.error('AccessService: error checking access', error.code);\n\n\t\t// we need to handle all types of errors on this stage\n\t\t// but for now we let user through in case of unknown error\n\t\treturn { hasAccess: true };\n\t}\n\n\treturn { hasAccess: false, errorCode: error.code };\n};\n","import { Tag, Event, Dom, Cache } from 'main.core';\nimport { Popup, type PopupOptions } from 'main.popup';\n\nimport { PopupType } from 'im.v2.const';\nimport { FeatureManager } from 'im.v2.lib.feature';\n\nimport '../css/limit-popup.css';\n\ntype MemoryCache<T> = {\n\tremember: (key: string, defaultValue: () => T) => T\n};\n\nexport class HistoryLimitPopup\n{\n\t#popupInstance: Popup;\n\t#cache: MemoryCache = new Cache.MemoryCache();\n\n\tconstructor(): Popup\n\t{\n\t\tthis.#popupInstance = new Popup(this.#getPopupConfig());\n\t\tthis.#bindEvents();\n\t}\n\n\tshow(): void\n\t{\n\t\tthis.#popupInstance.show();\n\t}\n\n\tclose(): void\n\t{\n\t\tthis.#popupInstance.destroy();\n\t}\n\n\t#getPopupConfig(): PopupOptions\n\t{\n\t\treturn {\n\t\t\tid: PopupType.messageHistoryLimit,\n\t\t\tclassName: 'bx-im-messenger__scope',\n\t\t\tcloseIcon: false,\n\t\t\tautoHide: false,\n\t\t\tcloseByEsc: false,\n\t\t\tanimation: 'fading',\n\t\t\toverlay: true,\n\t\t\tpadding: 0,\n\t\t\tcontent: this.#getContainer(),\n\t\t\tevents: {\n\t\t\t\tonPopupDestroy: () => {\n\t\t\t\t\tthis.#unbindEvents();\n\t\t\t\t},\n\t\t\t},\n\t\t};\n\t}\n\n\t#getContainer(): Element\n\t{\n\t\treturn this.#cache.remember('', () => {\n\t\t\tconst container: Element = Tag.render`\n\t\t\t\t<div class=\"bx-im-history-limit-popup__container\">\n\t\t\t\t\t<div class=\"bx-im-history-limit-popup__image\"></div>\n\t\t\t\t\t<div class=\"bx-im-history-limit-popup__title\">\n\t\t\t\t\t\t${FeatureManager.chatHistory.getLimitTitle()}\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class=\"bx-im-history-limit-popup__subtitle\">\n\t\t\t\t\t\t${FeatureManager.chatHistory.getLimitSubtitle()}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t`;\n\n\t\t\tDom.append(this.#getButtonContainer(), container);\n\n\t\t\treturn container;\n\t\t});\n\t}\n\n\t#getButtonContainer(): Element\n\t{\n\t\treturn this.#cache.remember('', () => {\n\t\t\treturn Tag.render`\n\t\t\t\t<div class=\"bx-im-history-limit-popup__button\">\n\t\t\t\t\t${FeatureManager.chatHistory.getLearnMoreText()}\n\t\t\t\t</div>\n\t\t\t`;\n\t\t});\n\t}\n\n\t#bindEvents(): void\n\t{\n\t\tEvent.bind(this.#getButtonContainer(), 'click', () => {\n\t\t\tFeatureManager.chatHistory.openFeatureSlider();\n\t\t\tthis.close();\n\t\t});\n\t}\n\n\t#unbindEvents(): void\n\t{\n\t\tEvent.unbindAll(this.#getButtonContainer(), 'click');\n\t}\n}\n","import { AccessService, type AccessCheckResult } from './classes/access-service';\nimport { HistoryLimitPopup } from './classes/history-limit-popup';\n\nexport { AccessErrorCode } from './classes/access-service';\n\nexport const AccessManager = {\n\tcheckMessageAccess(messageId: number): Promise<AccessCheckResult>\n\t{\n\t\treturn AccessService.checkMessageAccess(messageId);\n\t},\n\n\t// save it for later\n\tshowHistoryLimitPopup(): void\n\t{\n\t\tconst limitPopup = new HistoryLimitPopup();\n\t\tlimitPopup.show();\n\t},\n};\n"],"names":["AccessErrorCode","accessDenied","chatNotFound","messageNotFound","messageAccessDenied","messageAccessDeniedByTariff","AccessService","checkMessageAccess","messageId","payload","data","runAction","RestMethod","imV2AccessCheck","errors","handleAccessError","Promise","resolve","hasAccess","error","availableCodes","Object","values","includes","code","console","errorCode","HistoryLimitPopup","constructor","Cache","MemoryCache","Popup","show","close","destroy","id","PopupType","messageHistoryLimit","className","closeIcon","autoHide","closeByEsc","animation","overlay","padding","content","events","onPopupDestroy","remember","container","Tag","render","FeatureManager","chatHistory","getLimitTitle","getLimitSubtitle","Dom","append","getLearnMoreText","Event","bind","openFeatureSlider","unbindAll","AccessManager","showHistoryLimitPopup","limitPopup"],"mappings":"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"}