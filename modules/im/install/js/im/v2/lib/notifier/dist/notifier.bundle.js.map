{"version":3,"file":"notifier.bundle.js","sources":["../src/notifier.js"],"sourcesContent":["import {Notifier, NotificationOptions} from 'ui.notification-manager';\nimport {Store} from 'ui.vue3.vuex';\nimport {Loc} from 'main.core';\nimport {BaseEvent} from 'main.core.events';\n\nimport {Core} from 'im.v2.application.core';\nimport {Parser} from 'im.v2.lib.parser';\nimport {Messenger} from 'im.public';\nimport {NotificationTypesCodes} from 'im.v2.const';\nimport {NotificationService} from 'im.v2.provider.service';\n\nimport type {\n\tImModelUser,\n\tImModelDialog,\n\tImModelMessage,\n\tImModelNotification,\n\tImModelNotificationButton\n} from 'im.v2.model';\n\ntype NotifierClickParams = {\n\tid: string // 'im-notify-2558' | 'im-chat-1-2565'\n};\n\ntype NotifierActionParams = {\n\taction: string, // 'button_1'\n\tid: string, // 'im-notify-2561'\n\tuserInput?: string\n};\n\nconst CHAT_MESSAGE_PREFIX = 'im-chat';\nconst NOTIFICATION_PREFIX = 'im-notify';\nconst ACTION_BUTTON_PREFIX = 'button_';\nconst ButtonNumber = {\n\tfirst: '1',\n\tsecond: '2'\n};\n\nexport class NotifierManager\n{\n\tstatic #instance: NotifierManager;\n\n\t#store: Store;\n\t#notificationService: NotificationService;\n\n\tstatic getInstance(): NotifierManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tNotifierManager.getInstance();\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tthis.#notificationService = new NotificationService();\n\n\t\tthis.#subscribeToNotifierEvents();\n\t}\n\n\tshowMessage(message: ImModelMessage, dialog: ImModelDialog, user?: ImModelUser)\n\t{\n\t\tlet text = '';\n\t\tif (user)\n\t\t{\n\t\t\ttext += `${user.name}: `;\n\t\t}\n\n\t\ttext += Parser.purifyMessage(message);\n\n\t\tconst notificationOptions = {\n\t\t\tid: `im-chat-${dialog.dialogId}-${message.id}`,\n\t\t\ttitle: dialog.name,\n\t\t\ticon: dialog.avatar || user?.avatar,\n\t\t\ttext\n\t\t};\n\n\t\tNotifier.notify(notificationOptions);\n\t}\n\n\tshowNotification(notification: ImModelNotification, user?: ImModelUser)\n\t{\n\t\tlet title;\n\t\tif (notification.title)\n\t\t{\n\t\t\ttitle = notification.title;\n\t\t}\n\t\telse if (user)\n\t\t{\n\t\t\ttitle = user.name;\n\t\t}\n\t\telse\n\t\t{\n\t\t\ttitle = Loc.getMessage('IM_LIB_NOTIFIER_NOTIFY_SYSTEM_TITLE');\n\t\t}\n\n\t\tconst notificationOptions = this.#prepareNotificationOptions(title, notification, user);\n\n\t\tNotifier.notify(notificationOptions);\n\t}\n\n\t#prepareNotificationOptions(\n\t\ttitle: string,\n\t\tnotification: ImModelNotification,\n\t\tuser?: ImModelUser\n\t): NotificationOptions\n\t{\n\t\tconst notificationOptions = {\n\t\t\tid: `im-notify-${notification.id}`,\n\t\t\ttitle,\n\t\t\ticon: user? user.avatar: '',\n\t\t\ttext: Parser.purifyNotification(notification),\n\t\t};\n\n\t\tif (notification.sectionCode === NotificationTypesCodes.confirm)\n\t\t{\n\t\t\tconst [firstButton, secondButton] = notification.notifyButtons;\n\t\t\tnotificationOptions.button1Text = firstButton.TEXT;\n\t\t\tnotificationOptions.button2Text = secondButton.TEXT;\n\t\t}\n\t\telse if (notification.params?.CAN_ANSWER === 'Y')\n\t\t{\n\t\t\tnotificationOptions.inputPlaceholderText = Loc.getMessage('IM_LIB_NOTIFIER_NOTIFY_REPLY_PLACEHOLDER');\n\t\t}\n\n\t\treturn notificationOptions;\n\t}\n\n\t#subscribeToNotifierEvents()\n\t{\n\t\tNotifier.subscribe('click', (event: BaseEvent<NotifierClickParams>) => {\n\t\t\tthis.#onNotifierClick(event.getData());\n\t\t});\n\n\t\tNotifier.subscribe('action', (event: BaseEvent<NotifierActionParams>) => {\n\t\t\tthis.#onNotifierAction(event.getData());\n\t\t});\n\t}\n\n\t#onNotifierClick(params: NotifierClickParams)\n\t{\n\t\tconst {id} = params;\n\t\tif (this.#isChatMessage(id))\n\t\t{\n\t\t\tconst dialogId = this.#extractDialogId(id);\n\t\t\tMessenger.openChat(dialogId);\n\t\t}\n\t\telse if (this.#isNotification(id))\n\t\t{\n\t\t\tMessenger.openNotifications();\n\t\t}\n\t}\n\n\t#onNotifierAction(params: NotifierActionParams)\n\t{\n\t\tconst {id, action, userInput} = params;\n\t\tif (!this.#isNotification(id))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst notificationId = this.#extractNotificationId(id);\n\t\tconst notification = this.#store.getters['notifications/getById'](notificationId);\n\t\tif (userInput)\n\t\t{\n\t\t\tthis.#onNotifierQuickAnswer(notification, userInput);\n\t\t}\n\t\telse if (this.#isConfirmButtonAction(action, notification))\n\t\t{\n\t\t\tthis.#onNotifierButtonClick(action, notification);\n\t\t}\n\t}\n\n\t#onNotifierQuickAnswer(notification: ImModelNotification, text: string)\n\t{\n\t\tthis.#notificationService.sendQuickAnswer({\n\t\t\tid: notification.id,\n\t\t\ttext: text,\n\t\t});\n\t}\n\n\t#onNotifierButtonClick(action: string, notification: ImModelNotification)\n\t{\n\t\tconst [firstButton, secondButton] = notification.notifyButtons;\n\t\tconst actionButtonNumber = this.#extractButtonNumber(action);\n\t\tif (actionButtonNumber === ButtonNumber.first)\n\t\t{\n\t\t\tthis.#sendButtonAction(notification, firstButton);\n\t\t}\n\t\telse if (actionButtonNumber === ButtonNumber.second)\n\t\t{\n\t\t\tthis.#sendButtonAction(notification, secondButton);\n\t\t}\n\t}\n\n\t#sendButtonAction(notification: ImModelNotification, button: ImModelNotificationButton)\n\t{\n\t\tconst [notificationId, value] = this.#extractButtonParams(button);\n\n\t\tthis.#notificationService.sendConfirmAction(notificationId, value);\n\t}\n\n\t#isChatMessage(id: string): boolean\n\t{\n\t\treturn id.startsWith(CHAT_MESSAGE_PREFIX);\n\t}\n\n\t#isNotification(id: string): boolean\n\t{\n\t\treturn id.startsWith(NOTIFICATION_PREFIX);\n\t}\n\n\t#isConfirmButtonAction(action: string, notification: ImModelNotification): boolean\n\t{\n\t\tconst notificationType = notification.sectionCode;\n\n\t\treturn action.startsWith(ACTION_BUTTON_PREFIX) && notificationType === NotificationTypesCodes.confirm;\n\t}\n\n\t#extractDialogId(id: string): string\n\t{\n\t\t// 'im-chat-1-2565'\n\t\treturn id.split('-')[2];\n\t}\n\n\t#extractNotificationId(id: string): string\n\t{\n\t\t// 'im-notify-2558'\n\t\treturn id.split('-')[2];\n\t}\n\n\t#extractButtonNumber(action: string): string\n\t{\n\t\t// 'button_1'\n\t\treturn action.split('_')[1];\n\t}\n\n\t#extractButtonParams(button: ImModelNotificationButton): string[]\n\t{\n\t\t// '2568|Y'\n\t\treturn button.COMMAND_PARAMS.split('|');\n\t}\n}\n"],"names":["CHAT_MESSAGE_PREFIX","NOTIFICATION_PREFIX","ACTION_BUTTON_PREFIX","ButtonNumber","first","second","NotifierManager","getInstance","init","constructor","Core","getStore","NotificationService","showMessage","message","dialog","user","text","name","Parser","purifyMessage","notificationOptions","id","dialogId","title","icon","avatar","Notifier","notify","showNotification","notification","Loc","getMessage","purifyNotification","sectionCode","NotificationTypesCodes","confirm","firstButton","secondButton","notifyButtons","button1Text","TEXT","button2Text","params","CAN_ANSWER","inputPlaceholderText","subscribe","event","getData","Messenger","openChat","openNotifications","action","userInput","notificationId","getters","sendQuickAnswer","actionButtonNumber","button","value","sendConfirmAction","startsWith","notificationType","split","COMMAND_PARAMS"],"mappings":"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"}