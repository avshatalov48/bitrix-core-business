this.BX=this.BX||{};(function(e,t,i,n,s,o,r){"use strict";var a;var l=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"processAJAXError",value:function e(t){if(t.indexOf("SESSION_ERROR",0)===0){this.showError(s.Loc.getMessage("SGMErrorSessionWrong"))}else if(t.indexOf("CURRENT_USER_NOT_AUTH",0)===0){this.showError(s.Loc.getMessage("SGMErrorCurrentUserNotAuthorized"))}else if(t.indexOf("SONET_MODULE_NOT_INSTALLED",0)===0){this.showError(s.Loc.getMessage("SGMErrorModuleNotInstalled"))}else{this.showError(t)}return false}},{key:"showError",value:function e(t){new n.Popup("sgm-error".concat(Math.random()),null,{autoHide:true,lightShadow:false,zIndex:2,content:s.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['<div class="sonet-sgm-error-text-block">',"</div>"])),t),closeByEsc:true,closeIcon:true}).show()}}]);return e}();var u=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.value=!!t.value;this.containerNode=t.containerNode;this.groupId=parseInt(t.groupId);if(this.containerNode){o.EventEmitter.subscribe("BX.Socialnetwork.WorkgroupMenu:onSetFavorites",(function(e){var t=e.getCompatData(),n=babelHelpers.slicedToArray(t,1),s=n[0];i.setValue(s.value)}))}}babelHelpers.createClass(e,[{key:"setValue",value:function e(t){this.value=t}},{key:"getValue",value:function e(){return this.value}},{key:"set",value:function e(t){var n=this;var r=this.getValue();var a=!r;var u=i.SonetGroupMenu.getInstance();this.setValue(a);u.favoritesValue=a;u.setItemTitle(a);i.Common.setFavoritesAjax({groupId:this.groupId,favoritesValue:r,callback:{success:function e(t){var i={code:"afterSetFavorites",data:{groupId:t.ID,value:t.RESULT=="Y"}};window.top.BX.SidePanel.Instance.postMessageAll(window,"sonetGroupEvent",i);if(s.Type.isStringFilled(t.NAME)&&s.Type.isStringFilled(t.URL)){o.EventEmitter.emit("BX.Socialnetwork.WorkgroupFavorites:onSet",new o.BaseEvent({compatData:[{id:n.groupId,name:t.NAME,url:t.URL,extranet:s.Type.isStringFilled(t.EXTRANET)?t.EXTRANET:"N"},a]}))}},failure:function e(t){n.setValue(r);u.favoritesValue=r;u.setItemTitle(r);if(s.Type.isStringFilled(t.ERROR)){l.processAJAXError(t.ERROR)}}}});t.preventDefault()}}]);return e}();var c;var d=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);this.groupId=parseInt(t.groupId);this.buttonNode=t.buttonNode;this.notifyHintTimeout=null;this.notifyHintPopup=null;this.notifyHintTime=3e3;if(this.buttonNode){this.buttonNode.addEventListener("click",(function(){i.set()}),true)}}babelHelpers.createClass(e,[{key:"set",value:function e(){var t=this;var i=!this.buttonNode.classList.contains("ui-btn-active")?"set":"unset";this["switch"](this.buttonNode,i==="set");s.ajax.runAction("socialnetwork.api.workgroup.setSubscription",{data:{params:{groupId:this.groupId,value:i==="set"?"Y":"N"}}}).then((function(e){var i={code:"afterSetSubscribe",data:{groupId:t.groupId,value:e.RESULT=="Y"}};window.top.BX.SidePanel.Instance.postMessageAll(window,"sonetGroupEvent",i)}))["catch"]((function(e){t["switch"](t.buttonNode,!(i==="set"));l.processAJAXError(e.errors[0].message)}))}},{key:"switch",value:function e(t,i){if(!s.Type.isDomNode(t)){return}if(!!i){t.classList.add("ui-btn-active");t.classList.remove("ui-btn-icon-unfollow");t.classList.add("ui-btn-icon-follow");this.showNotifyHint(t,s.Loc.getMessage("SGCSSubscribeButtonHintOn"))}else{t.classList.remove("ui-btn-active");t.classList.add("ui-btn-icon-unfollow");t.classList.remove("ui-btn-icon-follow");this.showNotifyHint(t,s.Loc.getMessage("SGCSSubscribeButtonHintOff"))}}},{key:"showNotifyHint",value:function e(t,i){var o=this;if(this.notifyHintTimeout){clearTimeout(this.notifyHintTimeout);this.notifyHintTimeout=null}if(s.Type.isNull(this.notifyHintPopup)){this.notifyHintPopup=new n.Popup("sgm_notify_hint",t,{autoHide:true,lightShadow:true,zIndex:2,content:s.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['<div class="sonet-sgm-notify-hint-content" style="display: none;"><span id="sgm_notify_hint_text">',"</span></div>"])),i),closeByEsc:true,closeIcon:false,offsetLeft:21,offsetTop:2});this.notifyHintPopup.TEXT=document.getElementById("sgm_notify_hint_text");this.notifyHintPopup.setBindElement(t)}else{this.notifyHintPopup.TEXT.innerHTML=i;this.notifyHintPopup.setBindElement(t)}this.notifyHintPopup.setAngle({});this.notifyHintPopup.show();this.notifyHintTimeout=setTimeout((function(){o.notifyHintPopup.close()}),this.notifyHintTime)}}]);return e}();var p=function(){function e(t){babelHelpers.classCallCheck(this,e);this.containerNode=t.containerNode;this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;if(!this.containerNode){return}var i=BX.Intranet.Bitrix24.ThemePicker.Singleton;var n=this.containerNode.querySelector(".socialnetwork-group-slider-theme-btn");if(n){n.addEventListener("click",(function(){i.showDialog(true)}))}o.EventEmitter.subscribe("Intranet.ThemePicker:onSave",(function(e){var n=e.getData(),o=babelHelpers.slicedToArray(n,1),r=o[0];if(!s.Type.isPlainObject(r.theme)||window===top.window){return}i.applyTheme(r.theme.id);i.saveTheme(r.theme.id);t.draw(r.theme)}))}},{key:"draw",value:function e(t){var i=this.containerNode.querySelector(".socialnetwork-group-slider-theme-box");if(!i){return}i.style.backgroundImage=s.Type.isStringFilled(t.previewImage)?"url('".concat(t.previewImage,"')"):"none";i.style.backgroundColor=s.Type.isStringFilled(t.previewColor)?t.previewColor:"transparent"}}]);return e}();var h=function(){function e(t){var i,n;babelHelpers.classCallCheck(this,e);this.componentName=(i=t.componentName)!==null&&i!==void 0?i:"";this.signedParameters=(n=t.signedParameters)!==null&&n!==void 0?n:"";this.containerNode=t.containerNode;this.groupId=parseInt(t.groupId);this.init()}babelHelpers.createClass(e,[{key:"init",value:function e(){var t=this;if(!this.containerNode){return}var i=new BX.AvatarEditor({enableCamera:false});var n=this.containerNode.querySelector(".socialnetwork-group-slider-group-logo-btn");if(!n){return}n.addEventListener("click",(function(){i.show("file")}));o.EventEmitter.subscribe(i,"onApply",(function(e){var i=e.getCompatData(),n=babelHelpers.slicedToArray(i,1),s=n[0];var o=new FormData;if(!s.name){s.name="tmp.png"}o.append("newPhoto",s,s.name);t.changePhoto(o)}))}},{key:"changePhoto",value:function e(t){var i=this;if(this.componentName===""){return}var n=null;var o=this.containerNode.querySelector(".socialnetwork-group-slider-group-logo-box");if(o){n=this.showLoader({node:o,loader:null,size:50})}s.ajax.runComponentAction(this.componentName,"loadPhoto",{signedParameters:this.signedParameters,mode:"ajax",data:t}).then((function(e){if(s.Type.isPlainObject(e.data)){if(!o){return}var t=o.querySelector("i");if(!t){return}o.className="sonet-common-workgroup-avatar socialnetwork-group-slider-group-logo-box";if(s.Type.isStringFilled(e.data.imageSrc)){o.className+=" ui-icon ui-icon-common-user-group";t.style="background: url('".concat(encodeURI(e.data.imageSrc),"') no-repeat center center; background-size: cover;")}else{t.style="background: none;"}}i.hideLoader({loader:n})}),(function(e){i.hideLoader({loader:n})}))}},{key:"showLoader",value:function e(t){var i=null;if(s.Type.isDomNode(t.node)){if(t.loader===null){i=new r.Loader({target:t.node,size:!s.Type.isUndefined(t.size)?Number(t.size):40})}else{i=t.loader}i.show()}return i}},{key:"hideLoader",value:function e(t){if(t.loader!==null){t.loader.hide()}if(t.loader!==null){t.loader=null}}}]);return e}();var f=function(){function e(){babelHelpers.classCallCheck(this,e);this.componentName="";this.signedParameters="";this.instance=null;this.currentUserId=null;this.userRole=null;this.initiatedByType=null;this.initiatedByUserId=null;this.userIsMember=null;this.userIsAutoMember=null;this.userIsScrumMaster=null;this.canInitiate=null;this.canModify=null;this.canLeave=null;this.canCreate=null;this.groupId=null;this.isProject=null;this.isScrumProject=null;this.styles=null;this.urls=null;this.containerNode=null;this.menuButtonNode=null;this.editFeaturesAllowed=true;this.copyFeatureAllowed=true;this.favoritesInstance=null}babelHelpers.createClass(e,[{key:"init",value:function e(i){var n,r,a=this;if(s.Type.isUndefined(i)||s.Type.isUndefined(i.groupId)||parseInt(i.groupId)<=0){return}this.componentName=(n=i.componentName)!==null&&n!==void 0?n:"";this.signedParameters=(r=i.signedParameters)!==null&&r!==void 0?r:"";this.currentUserId=parseInt(i.currentUserId);this.groupId=parseInt(i.groupId);this.groupType=i.groupType;this.isProject=!!i.isProject;this.isScrumProject=!!i.isScrumProject;this.isOpened=!!i.isOpened;this.userRole=i.userRole;this.initiatedByType=i.initiatedByType;this.initiatedByUserId=parseInt(i.initiatedByUserId);this.userIsMember=!!i.userIsMember;this.userIsAutoMember=!!i.userIsAutoMember;this.userIsScrumMaster=this.isScrumProject&&(s.Type.isBoolean(i.userIsScrumMaster)?i.userIsScrumMaster:false);this.canInitiate=!!i.canInitiate;this.canProcessRequestsIn=!!i.canProcessRequestsIn;this.canModify=!!i.canModify;this.canCreate=!!i.canCreate;this.canLeave=s.Type.isBoolean(i.canLeave)?i.canLeave:this.userIsMember&&this.userRole!=="A"&&!this.userIsAutoMember&&!this.userIsScrumMaster;this.containerNode=s.Type.isStringFilled(i.containerNodeId)?document.getElementById(i.containerNodeId):null;this.menuButtonNode=s.Type.isStringFilled(i.menuButtonNodeId)?document.getElementById(i.menuButtonNodeId):null;this.editFeaturesAllowed=!s.Type.isUndefined(i.editFeaturesAllowed)?!!i.editFeaturesAllowed:true;this.copyFeatureAllowed=!s.Type.isUndefined(i.copyFeatureAllowed)?!!i.copyFeatureAllowed:true;this.favoritesInstance=new u({groupId:this.groupId,value:!!i.favoritesValue,containerNode:this.containerNode});this.subscriptionInstance=new d({groupId:this.groupId,buttonNode:s.Type.isStringFilled(i.subscribeButtonNodeId)?document.getElementById(i.subscribeButtonNodeId):null});new p({containerNode:this.containerNode});new h({componentName:this.componentName,signedParameters:this.signedParameters,containerNode:this.containerNode,groupId:this.groupId});if(this.containerNode&&s.Type.isPlainObject(i.styles)){this.styles=i.styles;if(s.Type.isPlainObject(i.styles.tags)&&s.Type.isStringFilled(i.styles.tags.box)){this.containerNode.querySelectorAll("[bx-tag-value]").forEach((function(e){e.addEventListener("click",(function(e){var t=e.target.getAttribute("bx-tag-value");if(s.Type.isStringFilled(t)){a.clickTag(t)}e.preventDefault()}),true)}))}if(s.Type.isPlainObject(i.tasksEfficiency)&&i.tasksEfficiency.available===true){var l=this.containerNode.querySelector(".socialnetwork-group-slider-efficency");if(l){var c=new t.Circle(l,131,Number(i.tasksEfficiency.value),null,null);c.show()}}var f=this.containerNode.querySelector('[data-role="efficiency-helper"]');if(f){f.addEventListener("click",(function(){top.BX.Helper.show("redirect=detail&code=6576263")}))}}if(s.Type.isPlainObject(i.urls)){this.urls=i.urls}if(s.Type.isDomNode(this.menuButtonNode)){var g=BX.SocialnetworkUICommon.SonetGroupMenu.getInstance();g.favoritesValue=this.favoritesInstance.getValue();this.menuButtonNode.addEventListener("click",(function(){BX.SocialnetworkUICommon.showGroupMenuPopup({bindElement:a.menuButtonNode,groupId:a.groupId,groupType:a.groupType,userIsMember:a.userIsMember,userIsAutoMember:a.userIsAutoMember,userIsScrumMaster:a.userIsScrumMaster,userRole:a.userRole,initiatedByType:a.initiatedByType,initiatedByUserId:a.initiatedByUserId,editFeaturesAllowed:a.editFeaturesAllowed,copyFeatureAllowed:a.copyFeatureAllowed,isProject:a.isProject,isScrumProject:a.isScrumProject,isOpened:a.isOpened,perms:{canInitiate:a.canInitiate,canProcessRequestsIn:a.canProcessRequestsIn,canModify:a.canModify,canLeave:a.canLeave,canCreate:a.canCreate},urls:{requestUser:s.Loc.getMessage("SGCSPathToRequestUser"),edit:s.Loc.getMessage("SGCSPathToEdit"),delete:s.Loc.getMessage("SGCSPathToDelete"),features:s.Loc.getMessage("SGCSPathToFeatures"),members:s.Loc.getMessage("SGCSPathToMembers"),requests:s.Loc.getMessage("SGCSPathToRequests"),requestsOut:s.Loc.getMessage("SGCSPathToRequestsOut"),userRequestGroup:s.Loc.getMessage("SGCSPathToUserRequestGroup"),userLeaveGroup:s.Loc.getMessage("SGCSPathToUserLeaveGroup"),copy:s.Loc.getMessage("SGCSPathToCopy")}})}),true)}o.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onSliderMessage.bind(this))}},{key:"clickTag",value:function e(t){if(!s.Type.isStringFilled(t)){return}top.location.href=s.Loc.getMessage("SGCSPathToGroupTag").replace("#tag#",t)}},{key:"onSliderMessage",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),o=n[0];if(o.getEventId()!=="sonetGroupEvent"){return}var r=o.getData();if(!s.Type.isStringFilled(r.code)||!s.Type.isPlainObject(r.data)){return}if(r.code==="afterJoinRequestSend"&&parseInt(r.data.groupId)===this.groupId){BX.SocialnetworkUICommon.reload()}else if(r.code==="afterEdit"&&s.Type.isPlainObject(r.data.group)&&parseInt(r.data.group.ID)===this.groupId){BX.SocialnetworkUICommon.reload()}else if(["afterDelete","afterLeave","afterIncomingRequestCancel"].includes(r.code)&&!s.Type.isUndefined(r.data.groupId)&&parseInt(r.data.groupId)===this.groupId){if(window!==top.window){top.BX.SidePanel.Instance.getSliderByWindow(window).close()}top.location.href=this.urls.groupsList}}},{key:"showLimit",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;return new Promise((function(e,n){s.Runtime.loadExtension("socialnetwork.limit").then((function(e){var n=e.Limit;n.showInstance({featureId:t,bindElement:i})}))}))}}]);return e}();e.WorkgroupCard=f})(this.BX.Socialnetwork=this.BX.Socialnetwork||{},BX.UI.Graph,BX.Socialnetwork.UI,BX.Main,BX,BX.Event,BX);
//# sourceMappingURL=script.map.js