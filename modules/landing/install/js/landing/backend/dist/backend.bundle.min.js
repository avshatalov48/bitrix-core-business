this.BX=this.BX||{};(function(e,t,n){"use strict";var r=true;var i=function(){function e(){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new t.Cache.MemoryCache)}babelHelpers.createClass(e,[{key:"getControllerUrl",value:function e(){var n=this;return this.cache.remember("controllerUrl",function(){var e=new t.Uri("/bitrix/tools/landing/ajax.php");e.setQueryParams({site:t.Loc.getMessage("SITE_ID")||undefined,type:n.getSitesType()});return e.toString()})}},{key:"getSiteId",value:function e(){return this.cache.remember("siteId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){var n=e.getInstance();if("options"in n&&"site_id"in n.options&&!t.Type.isUndefined(n.options.site_id)){return n.options.site_id}}return-1})}},{key:"getLandingId",value:function e(){return this.cache.remember("landingId",function(){var e=t.Reflection.getClass("BX.Landing.Main");if(e){return e.getInstance().id}return-1})}},{key:"getSitesType",value:function e(){return this.cache.remember("siteType",function(){return n.Env.getInstance().getType()})}},{key:"action",value:function n(r){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var c=arguments.length>3&&arguments[3]!==undefined?arguments[3]:{};a.site_id=this.getSiteId();var s={sessid:t.Loc.getMessage("bitrix_sessid"),action:c.action||r.replace("Landing\\Block","Block"),data:babelHelpers.objectSpread({},i,{uploadParams:c,lid:i.lid||this.getLandingId()})};var o=new t.Uri(this.getControllerUrl());o.setQueryParams(babelHelpers.objectSpread({action:s.action},a));return e.request({url:o.toString(),data:s}).then(function(e){if(s.action==="Block::updateNodes"||s.action==="Block::removeCard"||s.action==="Block::cloneCard"||s.action==="Block::addCard"||s.action==="Block::updateStyles"){BX.Landing.UI.Panel.StatusPanel.getInstance().update()}return e.result}).catch(function(e){if(s.action!=="Landing::downBlock"&&s.action!=="Landing::upBlock"){if(s.action!=="Block::getById"){var n=t.Type.isString(e)?{type:"error"}:e;e.action=s.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)}})}},{key:"batch",value:function n(r){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};a.site_id=this.getSiteId();var c={sessid:t.Loc.getMessage("bitrix_sessid"),action:r.replace("Landing\\Block","Block"),data:{lid:i.lid||this.getLandingId()},batch:i};var s=new t.Uri(this.getControllerUrl());s.setQueryParams(babelHelpers.objectSpread({action:c.action},a));return e.request({url:s.toString(),data:c}).then(function(e){BX.Landing.UI.Panel.StatusPanel.getInstance().update();return e}).catch(function(e){if(c.action!=="Landing::downBlock"&&c.action!=="Landing::upBlock"){if(c.action!=="Block::getById"){var n=t.Type.isString(e)?{type:"error"}:e;n.action=c.action;BX.Landing.ErrorManager.getInstance().add(n)}return Promise.reject(e)}})}},{key:"upload",value:function n(r){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var a=new FormData;a.append("sessid",t.Loc.getMessage("bitrix_sessid"));a.append("picture",r,r.name);if("block"in i){a.append("action","Block::uploadFile");a.append("data[block]",i.block)}if("lid"in i){a.set("action","Landing::uploadFile");a.append("data[lid]",i.lid)}if("id"in i){a.set("action","Site::uploadFile");a.append("data[id]",i.id)}var c=new t.Uri(this.getControllerUrl());c.setQueryParams({action:a.get("action"),site_id:this.getSiteId()});if(i.context){c.setQueryParam("context",i.context)}return e.request({url:c.toString(),data:a}).then(function(e){return e.result}).catch(function(e){var n=t.Type.isString(e)?{type:"error"}:e;n.action="Block::uploadFile";BX.Landing.ErrorManager.getInstance().add(n);return Promise.reject(e)})}},{key:"getSites",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=n.filter,i=r===void 0?{}:r;return this.cache.remember("sites+".concat(JSON.stringify(i)),function(){return t.action("Site::getList",{params:{order:{ID:"DESC"}}}).then(function(e){return e})})}},{key:"getLandings",value:function e(){var n=this;var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},i=r.siteId,a=i===void 0?[]:i;var c=t.Type.isArray(a)?a:[a];var s=function e(t){return{action:"Landing::getList",data:{params:{filter:{SITE_ID:t},order:{ID:"DESC"},get_preview:true,check_area:1}}}};var o=function e(t){return t.reduce(function(e,t){return[].concat(babelHelpers.toConsumableArray(e),babelHelpers.toConsumableArray(t.result))},[])};return this.cache.remember("landings+".concat(JSON.stringify(c)),function(){if(c.filter(function(e){return!t.Type.isNil(e)}).length===0){return n.getSites().then(function(e){var t=e.map(function(e){return s(e.ID)});return n.batch("Landing::getList",t)}).then(function(e){return o(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))})})}var e=c.map(function(e){return s(e)});return n.batch("Landing::getList",e).then(function(e){return o(e)}).then(function(e){e.forEach(function(e){n.cache.set("landing+".concat(e.ID),Promise.resolve(e))});return e})})}},{key:"getLanding",value:function e(n){var r=this;var i=n.landingId;return this.cache.remember("landing+".concat(i),function(){return r.action("Landing::getList",{params:{filter:{ID:i},get_preview:true}}).then(function(e){if(t.Type.isArray(e)&&e.length>0){return e[0]}return null})})}},{key:"getBlocks",value:function e(t){var n=this;var r=t.landingId;return this.cache.remember("blocks+".concat(r),function(){return n.action("Block::getList",{lid:r,params:{get_content:true,edit_mode:true}}).then(function(e){e.forEach(function(e){n.cache.set("block+".concat(e.id),Promise.resolve(e))});return e})})}},{key:"getBlock",value:function e(t){var n=this;var r=t.blockId;return this.cache.remember("blockId+".concat(r),function(){return n.action("Block::getById",{block:r,params:{edit_mode:true}})})}},{key:"getTemplates",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{},r=n.type,i=r===void 0?"page":r,a=n.filter,c=a===void 0?{}:a;return this.cache.remember("templates+".concat(JSON.stringify(c)),function(){return t.action("Demos::getPageList",{type:i,filter:c}).then(function(e){return Object.values(e)})})}},{key:"getDynamicTemplates",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";return this.cache.remember("dynamicTemplates:".concat(n),function(){return t.getTemplates({filter:{section:"dynamic".concat(n?":".concat(n):"")}})})}},{key:"createPage",value:function e(){var r=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i=n.Env.getInstance().getOptions();var a=r.title,c=r.siteId,s=c===void 0?i.site_id:c,o=r.siteType,u=o===void 0?i.params.type:o,l=r.code,d=l===void 0?t.Text.getRandom(16):l,g=r.blockId,f=r.menuCode,p=r.folderId;var h=function(){var e=i.theme;if(t.Type.isPlainObject(e)&&t.Type.isArray(e.newPageTemplate)&&t.Type.isStringFilled(e.newPageTemplate[0])){return e.newPageTemplate[0]}return"empty"}();var v={siteId:s,code:h,fields:{TITLE:a,CODE:d,ADD_IN_MENU:u==="KNOWLEDGE"||u==="GROUP"?"Y":"N"}};if(t.Type.isNumber(g)&&t.Type.isString(f)){v.fields.BLOCK_ID=g;v.fields.MENU_CODE=f}if(t.Type.isNumber(p)){v.fields.FOLDER_ID=p}return this.action("Landing::addByTemplate",v)}}],[{key:"getInstance",value:function t(){if(!e.instance){e.instance=new e}return e.instance}},{key:"makeResponse",value:function e(n){var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var i=function(){if(t.Type.isStringFilled(r.type)){return r.type}if(t.Type.isPlainObject(r)&&Object.values(r).length>0){var e=Object.values(r).every(function(e){return e.type==="success"});if(e){return"success"}}if(t.Type.isArray(r)){return"other"}return"error"}();if(i==="other"){return r}return babelHelpers.objectSpread({result:null,type:i},r,{status:n.status,authorized:n.getResponseHeader("X-Bitrix-Ajax-Status")!=="Authorize"})}},{key:"request",value:function n(i){var a=i.url,c=i.data;return new Promise(function(n,i){var s=c instanceof FormData?c:t.Http.Data.convertObjectToFormData(c);var o=t.ajax({method:"POST",dataType:"json",url:a,data:s,start:false,preparePost:false,onsuccess:function s(u){var l=e.makeResponse(o,u);if(t.Type.isStringFilled(l.sessid)&&r){t.Loc.setMessage("bitrix_sessid",l.sessid);r=false;var d=babelHelpers.objectSpread({},c,{sessid:t.Loc.getMessage("bitrix_sessid")});e.request({url:a,data:d}).then(function(e){r=true;n(e)}).catch(function(e){r=true;i(e)});return}if(!t.Type.isPlainObject(l)){n(l);return}if(l.type==="error"||l.authorized===false){i(l);return}n(l)},onfailure:function t(n){if(n==="auth"){i(e.makeResponse(o))}else{i(e.makeResponse(o,n))}}});o.send(s)})}}]);return e}();e.Backend=i})(this.BX.Landing=this.BX.Landing||{},BX,BX.Landing);
//# sourceMappingURL=backend.bundle.map.js