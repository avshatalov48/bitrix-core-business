<? namespace Bitrix\Main\Security\W;$GLOBALS['____1559629219']= array(base64_decode('d'.'GltZQ=='),base64_decode('dG'.'l'.'tZQ=='),base64_decode('anNv'.'bl'.'9kZWNvZGU='),base64_decode('YXJ'.'yY'.'Xlfb'.'WVyZ2U'.'='),base64_decode('a'.'m9pbg=='),base64_decode('am9pb'.'g='.'='),base64_decode(''.'am'.'9pbg=='),base64_decode('Y'.'X'.'JyYXlfcG9'.'w'),base64_decode('Y'.'X'.'Jy'.'YXl'.'fc'.'2'.'hpZ'.'nQ='),base64_decode('Y'.'XJ'.'yYXlf'.'c'.'2hp'.'Zn'.'Q='),base64_decode('Y'.'XJy'.'Y'.'Xl'.'fc'.'2h'.'pZnQ'.'='),base64_decode('YXJ'.'yYXlfc2hpZn'.'Q'.'='),base64_decode(''.'YXJyY'.'XlfbWVyZ2U'.'='),base64_decode('a'.'XNf'.'YXJyYX'.'k='),base64_decode('Y'.'XJyYXlfbW'.'VyZ'.'2U='),base64_decode('aW5f'.'YXJyYXk='),base64_decode(''.'a'.'W5fY'.'XJ'.'yYX'.'k='),base64_decode('aW5'.'fYXJyYXk='),base64_decode('aW'.'5fYXJy'.'YXk='),base64_decode('aW5fY'.'X'.'J'.'yYXk='),base64_decode('dGltZQ=='),base64_decode('dGltZ'.'Q=='),base64_decode('YX'.'JyYXlfb'.'WFw'),base64_decode('Z2V0X2xv'.'YWR'.'lZF'.'9l'.'e'.'H'.'R'.'l'.'bnNpb25z'),base64_decode('anNvbl'.'9lbmN'.'vZGU'.'='),base64_decode('anNvbl9lbmNvZGU'.'='),base64_decode('cGhw'.'dmVyc2'.'l'.'vbg=='),base64_decode('anNv'.'bl9lbm'.'NvZG'.'U='),base64_decode('am9'.'p'.'bg=='));if(!function_exists(__NAMESPACE__.'\\___1674692369')){function ___1674692369($_1392116308){static $_1824568943= false; if($_1824568943 == false) $_1824568943=array('V1dBTExfT'.'E9D'.'S'.'w==','c'.'2VjdX'.'JpdHk=','RE'.'FUQ'.'Q'.'==','eyI=','V1dB'.'TExfTE'.'9DS'.'w==','c'.'2VjdXJp'.'dHk=','U0VDVVJJV'.'Fl'.'fV1dBTE'.'xfRVhDRVBUSU9O','RkFJTF9'.'DSE'.'VDS0lORw='.'=','Q'.'2FuIG5v'.'dCBle'.'G'.'V'.'jdXRlIHd3YW'.'xsIHJ1'.'bGVzO'.'iA=','IF'.'RyYWNlOiA'.'=','UkVR'.'VUVTV'.'F9VU'.'kk=','a'.'2V'.'5cw==','dmFs'.'dWVz','U0V'.'DV'.'VJJVFlfV1dBT'.'ExfTU9ESUZZ','Lg==','U0VD'.'VVJJVF'.'lf'.'V1'.'dBTExf'.'VU5TRVQ=','Lg'.'==','U0V'.'D'.'V'.'VJ'.'JVFlf'.'V1dBTExfR'.'Vh'.'JVA'.'==','Lg'.'==','Z2'.'x'.'vYmFs',''.'a2V'.'5cw'.'==','dmFsd'.'W'.'V'.'z','Z2V0',''.'Z2V0','c'.'G9zd'.'A==','c'.'G9'.'zd'.'A==','Y29v'.'a2'.'ll','Y29va2ll','cm'.'VxdW'.'VzdA='.'=','cmVxdW'.'Vz'.'dA==','Z2xvYm'.'F'.'s',''.'Z2xvYmFs','bWFpbl'.'9z'.'ZWM=','V'.'1d'.'BT'.'E'.'xf'.'QUNU'.'V'.'UFMSV'.'pF'.'X1JVTEVT','dg='.'=','dmVyc'.'2lvb'.'g==','aQ==','a'.'XNJbnN0'.'YWxsZWQ=','dg==','aW'.'5'.'p','bW9kdWxl'.'cw='.'=',''.'bGljZW5zZQ==',''.'cGh'.'w',''.'dg'.'==','ZXh0','c2V'.'jd'.'XJpd'.'Hk'.'=','ZG'.'I=','dHlwZ'.'Q='.'=','ZGI=',''.'dmVy'.'c2lvbg'.'==','ZG'.'I=',''.'d'.'HlwZQ==',''.'ZGI=',''.'dH'.'l'.'wZQ='.'=','d'.'mVyc'.'2'.'lvbg='.'=','ZGI=','dmVy'.'c'.'2'.'lvbg==','ZW52aXJv'.'b'.'m1'.'lb'.'n'.'Q=','dm1fdmVyc2lvb'.'g='.'=','dm'.'0=','d'.'g==','ZW5'.'2aXJvbm1lbnQ'.'=','dm'.'1fdmVy'.'c2'.'lv'.'bg==','c29ja2V0VGltZ'.'W'.'91d'.'A==','c3RyZWF'.'t'.'VGltZW91dA==','KC'.'c=',''.'Z'.'GF0Y'.'Q==','JywgJ'.'w='.'=','b'.'W'.'9kdW'.'xl','JywgJw==','bW9k'.'dW'.'x'.'lX3Zl'.'cnNpb24=','J'.'yk=',''.'LCA=','U0'.'VDVVJJVF'.'lfV1'.'dBTExfRVhDRVB'.'US'.'U9O','bWFpb'.'g==','RkFJ'.'TF9S'.'RUZS'.'R'.'VNIS'.'U5H',''.'Q2F'.'u'.'IG'.'5'.'vdCB'.'yZWZyZX'.'NoIHd3YWx'.'sIHJ1bGVzOiA=','IFRyY'.'W'.'NlO'.'iA=',''.'ZGF0Y'.'Q==','e'.'yI=','LS'.'0'.'tL'.'S1CRUd'.'J'.'T'.'iBQVUJ'.'MSUMgS0VZLS0t'.'LS0=','C'.'k1JS'.'UJJ'.'akF'.'OQm'.'dr'.'cWhr'.'aU'.'c5dzBCQV'.'FFRkFBT'.'0N'.'BUThBT'.'UlJQkNnS0NBUUVBcTh'.'RRTBI'.'a'.'m1IS'.'lV'.'TdFdWNm'.'4wemE'.'KUlZvTHg'.'wMk'.'t'.'6Ym'.'Zy'.'YlMvUDZzV2F4VH'.'p3'.'OFNlR1R0Y'.'lR'.'DT'.'3'.'J'.'wSG'.'k1UUY2T1'.'J5al'.'ovWHh6L0tMVTFHYm'.'9mOUN'.'a'.'Mwo0ej'.'dT'.'a3F'.'VdDY2aWJY'.'dk9GQng0'.'ZncvQVBQUkdEcXRt'.'MG5EM2ZnR'.'3'.'N'.'1'.'M1Jl'.'U'.'Gd3MjlpOCt2b'.'TdtdEJ'.'LSlVZbDRy'.'ClZwY'.'jZz'.'Z'.'lpFVDlLRWI2VDFIRFlt'.'RXZjM'.'W'.'hxL2lpdXl4THJaW'.'mk1UTZVZ'.'mY0'.'VUV2VEkrNjhzc'.'0ZSa1Erb3dUUn'.'k'.'KZU9JTWJGaE'.'0'.'v'.'VV'.'R'.'t'.'ZlZZYlRS'.'R'.'nkyb1VROFdNemE'.'ybko'.'1U2Fo'.'emkx'.'V'.'U'.'tPMW'.'p'.'B'.'al'.'h'.'UUFJye'.'mM3QW'.'p1N'.'j'.'M5ajFPMApwcHFmbTV4'.'Z1ds'.'RkFKa0hRVGd'.'iZGQ1QVdxREZRa'.'3'.'Q'.'5SEtrWStUbmZCTEdWTXZWe'.'V'.'B'.'3V'.'EhOV1FZQXc0eH'.'BnL3dBC'.'lp3'.'S'.'URBUUFC'.'Ci'.'0tLS0tR'.'U'.'5'.'EI'.'FBVQkxJQyBLRVkt'.'LS0tLQ='.'=');return base64_decode($_1824568943[$_1392116308]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_997324240= 'https://wwall.bitrix.info/rules.php'; protected $_697472416= true; public function handle(){ try{  $_434640708= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_434640708)){ return;}  $_1800629860= Cache::createInstance(); $_1093438199= false; if($_1800629860->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_948252196= $_1800629860->getVars(); if($GLOBALS['____1559629219'][0]()- $_948252196> round(0+20)){  $_317784965= Application::getConnection(); $_308100665= RuleRecordTable::getTableName(); $_317784965->truncateTable($_308100665); RuleRecordTable::cleanCache(); $_1800629860->clean(___1674692369(0), ___1674692369(1));}} elseif($_1800629860->startDataCache()){  $_1800629860->endDataCache($GLOBALS['____1559629219'][1]()); $_1093438199= true;} foreach($_434640708 as $_825624673){ $_196663201= new PublicKeyCipher; $_1526566064= $_196663201->decrypt($_825624673[___1674692369(2)], static::__1529882642()); if(!str_starts_with($_1526566064, ___1674692369(3))){ continue;} $_1840483080= $GLOBALS['____1559629219'][2]($_1526566064, true); if(!empty($_1840483080)){ $_2115491451= Rule::make($_1840483080); $_1447225549= $this->handleRule($_2115491451); $this->applyHandlingResults($_1447225549);}}  if($_1093438199){ $_1800629860->clean(___1674692369(4), ___1674692369(5));}} catch(\Throwable $_1819891006){ $this->logEvent( ___1674692369(6), ___1674692369(7), ___1674692369(8). $_1819891006->getMessage(). ___1674692369(9). $_1819891006->getTraceAsString());}}  public function handleRule(Rule $_2115491451): array{ $_1447225549=[]; if($_2115491451->matchPath($_SERVER[___1674692369(10)])){  $_1826082667= $this->getContextElements($_2115491451->getContext()); foreach($_1826082667 as $_1188030456 => &$_1485725415){ $_1447225549= $GLOBALS['____1559629219'][3]($_1447225549, $this->recursiveContextKeyHandle($_1188030456, $_1485725415,[], $_2115491451));}} return $_1447225549;}  public function applyHandlingResults(array $_1447225549){ $_1826082667= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1447225549 as $_163457095){ $_1485725415=& $_1826082667[$_163457095->getContextName()]; $_1427273370= $_163457095->getRuleResult(); $_2115491451= $_163457095->getRule(); if($_1427273370 instanceof ModifyResult){ if($_2115491451->getProcess() === ___1674692369(11)){  static::rewriteContextKey( $_163457095->getContextName(), $_1485725415, $_163457095->getContextKey(), $_1427273370->getCleanValue());} elseif($_2115491451->getProcess() === ___1674692369(12)){ static::rewriteContextValue( $_163457095->getContextName(), $_1485725415, $_163457095->getContextKey(), $_1427273370->getCleanValue());} $this->logEvent( ___1674692369(13), $_163457095->getContextName(), $GLOBALS['____1559629219'][4](___1674692369(14), $_163457095->getContextKey()));} elseif($_1427273370 instanceof CheckResult &&!$_1427273370->isSuccess()){ if($_1427273370->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_163457095->getContextName(), $_1485725415, $_163457095->getContextKey(),); $this->logEvent( ___1674692369(15), $_163457095->getContextName(), $GLOBALS['____1559629219'][5](___1674692369(16), $_163457095->getContextKey()));} elseif($_1427273370->getAction() === RuleAction::EXIT){ $this->logEvent( ___1674692369(17), $_163457095->getContextName(), $GLOBALS['____1559629219'][6](___1674692369(18), $_163457095->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_697472416= false;} protected function rewriteContextKey($_1188030456, &$_1485725415, $_1351582122, $_1581073580){ $_902218311= $_1351582122;  $GLOBALS['____1559629219'][7]($_902218311); $_902218311[]= $_1581073580; if($_1188030456 === ___1674692369(19)){ $_1500999028= $GLOBALS['____1559629219'][8]($_1351582122); $GLOBALS['____1559629219'][9]($_902218311); if(empty($_1351582122)){ $GLOBALS[$_1581073580]= $GLOBALS[$_1500999028]; unset($GLOBALS[$_1500999028]);} else{ $_1485725415=& $GLOBALS[$_1500999028]; $_1461213937= ArrayHelper::getByNestedKey($_1485725415, $_1351582122);  ArrayHelper::setByNestedKey($_1485725415, $_902218311, $_1461213937);  ArrayHelper::unsetByNestedKey($_1485725415, $_1351582122);}} else{ $_1461213937= ArrayHelper::getByNestedKey($_1485725415, $_1351582122);  ArrayHelper::setByNestedKey($_1485725415, $_902218311, $_1461213937);  ArrayHelper::unsetByNestedKey($_1485725415, $_1351582122);}} protected function rewriteContextValue($_1188030456, &$_1485725415, $_266663859, $_1461213937){ if($_1188030456 === 'global'){ $_1500999028= $GLOBALS['____1559629219'][10]($_266663859); if(empty($_266663859)){ $GLOBALS[$_1500999028]= $_1461213937;} else{ $_1485725415=& $GLOBALS[$_1500999028]; ArrayHelper::setByNestedKey($_1485725415, $_266663859, $_1461213937);}} else{  ArrayHelper::setByNestedKey($_1485725415, $_266663859, $_1461213937);}} protected function unsetContextValue($_1188030456, &$_1485725415, $_266663859){ if($_1188030456 === 'global'){ $_1500999028= $GLOBALS['____1559629219'][11]($_266663859); if(empty($_266663859)){ unset($GLOBALS[$_1500999028]);} else{ $_1485725415=& $GLOBALS[$_1500999028]; ArrayHelper::unsetByNestedKey($_1485725415, $_266663859);}} else{ ArrayHelper::unsetByNestedKey($_1485725415, $_266663859);}}  protected function recursiveContextKeyHandle(string $_1188030456, array &$_1485725415, array $_852209247, Rule $_2115491451): array{  $_1447225549=[]; foreach($_1485725415 as $_1245242348 => $_1461213937){ $_266663859= $GLOBALS['____1559629219'][12]($_852209247,[$_1245242348]); if($_2115491451->matchKey($_266663859)){  if($_2115491451->getProcess() === ___1674692369(20)){ $_1427273370= $_2115491451->evaluate($_1245242348);} elseif($_2115491451->getProcess() === ___1674692369(21)){ $_1427273370= $_2115491451->evaluateValue($_1461213937);}  if(!empty($_1427273370) && $_1427273370 instanceof RuleResult){ $_1447225549[]= new HandlingResult($_1188030456, $_266663859, $_1427273370, $_2115491451);}}  if($GLOBALS['____1559629219'][13]($_1461213937)){ $_1447225549= $GLOBALS['____1559629219'][14]($_1447225549, $this->recursiveContextKeyHandle( $_1188030456, $_1485725415[$_1245242348], $_266663859, $_2115491451));}} return $_1447225549;} protected function getContextElements(array $_1943045981){ $_1447657275=[]; if($GLOBALS['____1559629219'][15](___1674692369(22), $_1943045981, true)){ $_1447657275[___1674692369(23)]= &$_GET;} if($GLOBALS['____1559629219'][16](___1674692369(24), $_1943045981, true)){ $_1447657275[___1674692369(25)]= &$_POST;} if($GLOBALS['____1559629219'][17](___1674692369(26), $_1943045981, true)){ $_1447657275[___1674692369(27)]= &$_COOKIE;} if($GLOBALS['____1559629219'][18](___1674692369(28), $_1943045981, true)){ $_1447657275[___1674692369(29)]= &$_REQUEST;} if($GLOBALS['____1559629219'][19](___1674692369(30), $_1943045981, true)){ $_1447657275[___1674692369(31)]= $GLOBALS;} return $_1447657275;} public static function refreshRules(){ try{ $_220504319= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1559629219'][20]()- $_220504319)< static::CACHE_RULES_TTL){ return;} Option::set(___1674692369(32), ___1674692369(33), $GLOBALS['____1559629219'][21]()); $_1700550440= null;  $_1962889123= $GLOBALS['____1559629219'][22](function($_1531413431){ return[___1674692369(34) => $_1531413431[___1674692369(35)], ___1674692369(36) => (int) $_1531413431[___1674692369(37)]];}, ModuleManager::getModulesFromDisk());  $_779122563=[]; foreach($GLOBALS['____1559629219'][23]() as $_368399245){ $_2031245581= new ReflectionExtension($_368399245); $_779122563[$_368399245]=[ ___1674692369(38) => $_2031245581->getVersion(), ___1674692369(39) => $_2031245581->getINIEntries()];} $_375285689=[ ___1674692369(40) => $GLOBALS['____1559629219'][24]($_1962889123), ___1674692369(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___1674692369(42) => $GLOBALS['____1559629219'][25]([ ___1674692369(43) => $GLOBALS['____1559629219'][26](), ___1674692369(44) => $_779122563])]; if(Loader::includeModule(___1674692369(45))){ $_363614182= CSecuritySystemInformation::getSystemInformation(); if(isset($_363614182[___1674692369(46)][___1674692369(47)]) && isset($_363614182[___1674692369(48)][___1674692369(49)])){ $_375285689[___1674692369(50)]=[ ___1674692369(51) => $_363614182[___1674692369(52)][___1674692369(53)], ___1674692369(54) => $_363614182[___1674692369(55)][___1674692369(56)]];} if(isset($_363614182[___1674692369(57)][___1674692369(58)])){ $_375285689[___1674692369(59)]=[___1674692369(60) => $_363614182[___1674692369(61)][___1674692369(62)]];}}  $_1909867122= new HttpClient([ ___1674692369(63) => round(0+1.6666666666667+1.6666666666667+1.6666666666667), ___1674692369(64) => round(0+1+1+1+1+1)]); $_1687867153= $_1909867122->post( static::$_997324240, $_375285689); if($_1909867122->getStatus() == round(0+200) &&!empty($_1687867153)){ $_1700550440= Json::decode($_1687867153);}  if($_1700550440 !== null){ $_317784965= Application::getConnection(); $_308100665= RuleRecordTable::getTableName(); if(!empty($_1700550440)){ foreach($_1700550440 as $_59988096){ if(!static::checkRuleSign($_59988096)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1559629219'][27]($_59988096));}}}  $_317784965->truncateTable($_308100665);  if(!empty($_1700550440)){ $_1285134294=[]; foreach($_1700550440 as $_59988096){ $_1285134294[]= ___1674692369(65). $_317784965->getSqlHelper()->forSql($_59988096[___1674692369(66)]). ___1674692369(67). $_317784965->getSqlHelper()->forSql($_59988096[___1674692369(68)]). ___1674692369(69). $_317784965->getSqlHelper()->forSql($_59988096[___1674692369(70)]). ___1674692369(71);} $_1454410238= $GLOBALS['____1559629219'][28](___1674692369(72), $_1285134294);  $_317784965->query("INSERT INTO {$_308100665} (DATA, MODULE, MODULE_VERSION) VALUES {$_1454410238}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_1819891006){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___1674692369(73), ___1674692369(74), ___1674692369(75), ___1674692369(76). $_1819891006->getMessage(). ___1674692369(77). $_1819891006->getTraceAsString());}} protected static function checkRuleSign($_2115491451){ $_196663201= new PublicKeyCipher; $_1840483080= $_196663201->decrypt($_2115491451[___1674692369(78)], static::__1529882642()); return str_starts_with($_1840483080, ___1674692369(79));} private static function __1529882642(){ $_205115871= ''; $_205115871 .= ___1674692369(80); $_205115871 .= ___1674692369(81); return $_205115871;} protected function logEvent($_338903868, $_829416504, $_283114845){ if($this->_697472416){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_338903868, 'main', $_829416504, $_283114845);}}}?>