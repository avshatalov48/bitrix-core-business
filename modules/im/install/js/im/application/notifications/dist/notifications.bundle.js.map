{"version":3,"file":"notifications.bundle.js","sources":["../src/notifications.js"],"sourcesContent":["/**\n * Bitrix Im\n * Core application\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2020 Bitrix\n */\nimport {Core} from \"im.application.core\";\nimport {VueVendorV2} from \"ui.vue\";\n\n// vue components\nimport 'im.component.notifications';\nimport { ImNotificationsPullHandler } from \"im.provider.pull\";\n\nexport class NotificationsApplication\n{\n\t/* region 01. Initialize */\n\n\tconstructor(params = {})\n\t{\n\t\tthis.inited = false;\n\t\tthis.initPromise = new BX.Promise;\n\n\t\tthis.params = params;\n\n\t\tthis.template = null;\n\t\tthis.rootNode = this.params.node || document.createElement('div');\n\t\tthis.legacyMode = this.params.mode === 'legacy';\n\t\tthis.initCounter = this.params.initCounter || null;\n\t\tthis.templateTemp = null;\n\n\t\tthis.eventBus = new VueVendorV2; // TODO remove this! change to Bitrix EventEmitter\n\n\t\tthis.initCore()\n\t\t\t.then(() => this.initParams())\n\t\t\t.then(() => this.initComponent(this.legacyMode))\n\t\t\t.then(() => this.initPullClient())\n\t\t\t.then(() => this.initPullHandlers())\n\t\t\t.then(() => this.initComplete())\n\n\t\t;\n\t}\n\n\tinitPullClient()\n\t{\n\t\tthis.pullClient = BX.PULL;\n\n\t\treturn new Promise((resolve, reject) => resolve());\n\t}\n\n\tinitPullHandlers()\n\t{\n\t\tthis.pullClient.subscribe(\n\t\t\tnew ImNotificationsPullHandler({\n\t\t\t\tstore: this.controller.getStore(),\n\t\t\t\tapplication: this,\n\t\t\t\tcontroller: this.controller,\n\t\t\t})\n\t\t);\n\n\t\treturn new Promise((resolve, reject) => resolve());\n\t}\n\n\tinitCore()\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tCore.ready().then(controller => {\n\t\t\t\tthis.controller = controller;\n\t\t\t\tresolve();\n\t\t\t})\n\t\t});\n\t}\n\n\tinitParams()\n\t{\n\t\tif (this.initCounter)\n\t\t{\n\t\t\tthis.controller.getStore().dispatch('notifications/setCounter', {\n\t\t\t\tunreadTotal: this.initCounter\n\t\t\t});\n\t\t}\n\t\tthis.controller.getStore().subscribe(mutation => this.eventStoreInteraction(mutation));\n\n\t\treturn new Promise((resolve, reject) => resolve());\n\t}\n\n\tinitComponent(legacy)\n\t{\n\t\tif (legacy)\n\t\t{\n\t\t\treturn new Promise((resolve, reject) => resolve());\n\t\t}\n\n\t\tlet template;\n\t\tif (this.legacyMode)\n\t\t{\n\t\t\ttemplate = '<bx-im-component-notifications/>';\n\t\t}\n\t\telse\n\t\t{\n\t\t\ttemplate = `<div style=\"height: 400px; border: 1px solid #ccc;\">\n\t\t\t\t<bx-im-component-notifications/>\n\t\t\t</div>`\n\t\t}\n\n\t\treturn this.controller.createVue(this, {el: this.rootNode, template}).then(vue => {\n\t\t\tthis.template = vue;\n\t\t\tthis.template.$el.id = this.rootNode.substr(1);\n\t\t\treturn new Promise((resolve, reject) => resolve());\n\t\t});\n\t}\n\n\tinitComplete()\n\t{\n\t\tthis.inited = true;\n\t\tthis.initPromise.resolve(this);\n\t}\n\n\tready()\n\t{\n\t\tif (this.inited)\n\t\t{\n\t\t\tlet promise = new BX.Promise;\n\t\t\tpromise.resolve(this);\n\n\t\t\treturn promise;\n\t\t}\n\n\t\treturn this.initPromise;\n\t}\n\n\t/* endregion 01. Initialize */\n\n\t/* region 02. Event Bus */\n\temit(eventName, params = {})\n\t{\n\t\tthis.eventBus.$emit(eventName, params);\n\n\t\treturn true;\n\t}\n\n\tlisten(eventName, callback)\n\t{\n\t\tif (typeof callback !== 'function')\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.eventBus.$on(eventName, callback);\n\n\t\treturn true;\n\t}\n\t/* endregion 02. Event Bus */\n\n\thasVueInstance()\n\t{\n\t\treturn this.template !== null;\n\t}\n\n\tdestroyVueInstance()\n\t{\n\t\tthis.template.$destroy();\n\t\tthis.template = null;\n\t}\n\n\teventStoreInteraction(data)\n\t{\n\t\tif (data.type === 'notifications/setCounter')\n\t\t{\n\t\t\tif (parseInt(data.payload) >= 0)\n\t\t\t{\n\t\t\t\tBXIM.notify.updateNotifyNextCount(parseInt(data.payload), true);\n\t\t\t}\n\t\t}\n\t}\n}"],"names":["NotificationsApplication","params","inited","initPromise","BX","Promise","template","rootNode","node","document","createElement","legacyMode","mode","initCounter","templateTemp","eventBus","VueVendorV2","initCore","then","initParams","initComponent","initPullClient","initPullHandlers","initComplete","pullClient","PULL","resolve","reject","subscribe","ImNotificationsPullHandler","store","controller","getStore","application","Core","ready","dispatch","unreadTotal","mutation","eventStoreInteraction","legacy","createVue","el","vue","$el","id","substr","promise","eventName","$emit","callback","$on","$destroy","data","type","parseInt","payload","BXIM","notify","updateNotifyNextCount"],"mappings":"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"}