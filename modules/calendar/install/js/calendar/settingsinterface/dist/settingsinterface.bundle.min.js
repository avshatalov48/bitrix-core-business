this.BX=this.BX||{};(function(e,t,s,i,a,n,o){"use strict";var c,l,r,h;var d=function(){function e(s){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"sliderId","calendar:settings-slider");babelHelpers.defineProperty(this,"name","SettingsInterface");babelHelpers.defineProperty(this,"SLIDER_WIDTH",500);babelHelpers.defineProperty(this,"SLIDER_DURATION",80);babelHelpers.defineProperty(this,"DOM",{});this.calendarContext=s.calendarContext;this.showPersonalSettings=s.showPersonalSettings;this.showGeneralSettings=s.showGeneralSettings;this.showAccessControl=s.showAccessControl!==false&&i.Type.isObjectLike(this.calendarContext.util.config.TYPE_ACCESS);this.settings=s.settings;this.BX=t.Util.getBX();this.hideMessageBinded=this.hideMessage.bind(this)}babelHelpers.createClass(e,[{key:"show",value:function e(){this.BX.SidePanel.Instance.open(this.sliderId,{contentCallback:this.createContent.bind(this),width:this.SLIDER_WIDTH,animationDuration:this.SLIDER_DURATION,events:{onCloseByEsc:this.escHide.bind(this),onClose:this.hide.bind(this),onCloseComplete:this.destroy.bind(this),onLoad:this.onLoadSlider.bind(this)}})}},{key:"escHide",value:function e(t){if(t&&t.getSlider&&t.getSlider().getUrl()===this.sliderId&&this.denyClose){t.denyAction()}}},{key:"close",value:function e(){this.isOpenedState=false;BX.SidePanel.Instance.close()}},{key:"isOpened",value:function e(){return this.isOpenedState}},{key:"hide",value:function e(t){if(t&&t.getSlider&&t.getSlider().getUrl()===this.sliderId){if(this.denyClose){t.denyAction()}else{BX.removeCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this))}}}},{key:"denySliderClose",value:function e(){this.denyClose=true}},{key:"allowSliderClose",value:function e(){this.denyClose=false}},{key:"destroy",value:function e(t){if(t&&t.getSlider&&t.getSlider().getUrl()===this.sliderId){BX.SidePanel.Instance.destroy(this.sliderId);delete this.DOM.sectionListWrap}}},{key:"createContent",value:function e(t){var s=this;return new Promise(function(e){top.BX.ajax.runAction("calendar.api.calendarajax.getSettingsSlider",{data:{showPersonalSettings:s.showPersonalSettings?"Y":"N",showGeneralSettings:s.showGeneralSettings?"Y":"N",showAccessControl:s.showAccessControl?"Y":"N",uid:s.uid}}).then(function(i){t.getData().set("sliderContent",i.data.html);var a=i.data.additionalParams;s.mailboxList=a.mailboxList;s.uid=a.uid;e(i.data.html)})})}},{key:"onLoadSlider",value:function e(t){var s=t.getSlider();this.DOM.content=s.layout.content;this.sliderId=s.getUrl();BX.html(s.layout.content,s.getData().get("sliderContent"));this.initControls();this.setControlsValue()}},{key:"initControls",value:function e(){this.DOM.buttonsWrap=this.DOM.content.querySelector(".calendar-form-buttons-fixed");BX.ZIndexManager.register(this.DOM.buttonsWrap);this.DOM.saveBtn=this.DOM.buttonsWrap.querySelector('[data-role="save_btn"]');this.DOM.closeBtn=this.DOM.buttonsWrap.querySelector('[data-role="close_btn"]');BX.Event.bind(this.DOM.saveBtn,"click",this.save.bind(this));BX.Event.bind(this.DOM.closeBtn,"click",this.close.bind(this));if(this.showPersonalSettings){this.DOM.denyBusyInvitation=this.DOM.content.querySelector('[data-role="deny_busy_invitation"]');this.DOM.showWeekNumbers=this.DOM.content.querySelector('[data-role="show_week_numbers"]');this.DOM.meetSectionSelect=this.DOM.content.querySelector('[data-role="meet_section"]');this.DOM.crmSelect=this.DOM.content.querySelector('[data-role="crm_section"]');this.DOM.showDeclined=this.DOM.content.querySelector('[data-role="show_declined"]');this.DOM.showTasks=this.DOM.content.querySelector('[data-role="show_tasks"]');this.DOM.syncTasks=this.DOM.content.querySelector('[data-role="sync_tasks"]');this.DOM.showCompletedTasks=this.DOM.content.querySelector('[data-role="show_completed_tasks"]');this.DOM.timezoneSelect=this.DOM.content.querySelector('[data-role="set_tz_sel"]');this.DOM.syncPeriodPast=this.DOM.content.querySelector('[data-role="sync_period_past"]');this.DOM.syncPeriodFuture=this.DOM.content.querySelector('[data-role="sync_period_future"]');this.DOM.sendFromEmailSelect=this.DOM.content.querySelector('[data-role="send_from_email"]');if(this.BX.Type.isElementNode(this.DOM.sendFromEmailSelect)){this.emailSelectorControl=new s.EmailSelectorControl({selectNode:this.DOM.sendFromEmailSelect,allowAddNewEmail:true,mailboxList:this.mailboxList});this.DOM.emailHelpIcon=this.DOM.content.querySelector(".calendar-settings-question");if(this.DOM.emailHelpIcon&&BX.Helper){BX.Event.bind(this.DOM.emailHelpIcon,"click",function(){BX.Helper.show("redirect=detail&code=12070142")});t.Util.initHintNode(this.DOM.emailHelpIcon)}this.emailSelectorControl.setValue(this.calendarContext.util.getUserOption("sendFromEmail"));this.DOM.emailWrap=this.DOM.content.querySelector(".calendar-settings-email-wrap");if(BX.Calendar.Util.isEventWithEmailGuestAllowed()){BX.Dom.removeClass(this.DOM.emailWrap,"lock");this.DOM.sendFromEmailSelect.disabled=false}else{BX.Dom.addClass(this.DOM.emailWrap,"lock");this.DOM.sendFromEmailSelect.disabled=true;BX.Event.bind(this.DOM.sendFromEmailSelect.parentNode,"click",function(){BX.UI.InfoHelper.show("limit_calendar_invitation_by_mail")})}}}if(this.showGeneralSettings){this.DOM.workTimeStart=this.DOM.content.querySelector('[data-role="work_time_start"]');this.DOM.workTimeEnd=this.DOM.content.querySelector('[data-role="work_time_end"]');this.DOM.weekHolidays=this.DOM.content.querySelector('[data-role="week_holidays"]');this.DOM.yearHolidays=this.DOM.content.querySelector('[data-role="year_holidays"]');this.DOM.yearWorkdays=this.DOM.content.querySelector('[data-role="year_workdays"]')}if(this.showAccessControl){this.DOM.accessMessageWrap=this.DOM.content.querySelector('[data-role="type-access-message-card"]');this.DOM.accessOuterWrap=this.DOM.content.querySelector('[data-role="type-access-values-cont"]');this.DOM.accessHelpIcon=this.DOM.content.querySelector(".calendar-settings-access-hint");if(i.Type.isElementNode(this.DOM.accessHelpIcon)&&this.calendarContext.util.type==="location"){this.initMessageControl()}else if(i.Type.isElementNode(this.DOM.accessHelpIcon)){this.DOM.accessHelpIcon.remove()}if(i.Type.isElementNode(this.DOM.accessOuterWrap)){this.initAccessController()}}}},{key:"initMessageControl",value:function e(){var t=this;var s=i.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a class="ui-btn ui-btn-primary">',"</a>\n\t\t"])),i.Loc.getMessage("EC_LOCATION_SETTINGS_MORE_INFO"));i.Event.bind(s,"click",this.openHelpDesk);var a="";var l=i.Loc.getMessage("EC_LOCATION_SETTINGS_MESSAGE_DESCRIPTION");this.message=new o.MessageCard({id:"locationSettingsInfo",header:a,description:l,angle:false,hidden:true,actionElements:[s]});n.EventEmitter.subscribe(this.message,"onClose",this.hideMessageBinded);i.Event.bind(this.DOM.accessHelpIcon,"click",function(){t.onClickHint()});if(this.DOM.accessMessageWrap){this.DOM.accessMessageWrap.appendChild(this.message.getLayout());this.DOM.accessMessageWrap.firstChild.childNodes[1].remove();if(!this.calendarContext.util.config.hideSettingsHintLocation){this.showMessage()}}}},{key:"onClickHint",value:function e(){if(!this.message){return}if(this.message.isShown()){this.hideMessage()}else{this.showMessage()}}},{key:"setControlsValue",value:function e(){if(this.showPersonalSettings){this.DOM.meetSectionSelect.options.length=0;var t=this.calendarContext.sectionManager.getSectionListForEdit();var s=parseInt(this.calendarContext.util.getUserOption("crmSection"));var a=parseInt(this.calendarContext.util.getUserOption("meetSection"));var n;var o;for(var c=0;c<t.length;c++){n=t[c];if(n.belongsToOwner()){if(!a){a=n.id}o=a===parseInt(n.id);this.DOM.meetSectionSelect.options.add(new Option(n.name,n.id,o,o));if(!s){s=n.id}o=s===parseInt(n.id);this.DOM.crmSelect.options.add(new Option(n.name,n.id,o,o))}}}if(this.DOM.showDeclined){this.DOM.showDeclined.checked=this.calendarContext.util.getUserOption("showDeclined")}var l=this.calendarContext.util.getUserOption("showTasks")==="Y";if(this.DOM.showTasks){this.DOM.showTasks.checked=l;BX.Event.bind(this.DOM.showTasks,"click",function(){if(this.DOM.showCompletedTasks){this.DOM.showCompletedTasks.disabled=!this.DOM.showTasks.checked;this.DOM.showCompletedTasks.checked=this.DOM.showCompletedTasks.checked&&this.DOM.showTasks.checked}if(this.DOM.syncTasks){this.DOM.syncTasks.disabled=!this.DOM.showTasks.checked;this.DOM.syncTasks.checked=this.DOM.syncTasks.checked&&this.DOM.showTasks.checked}}.bind(this))}if(this.DOM.showCompletedTasks){this.DOM.showCompletedTasks.checked=this.calendarContext.util.getUserOption("showCompletedTasks")==="Y"&&this.DOM.showTasks.checked;this.DOM.showCompletedTasks.disabled=!l}if(this.DOM.syncTasks){this.DOM.syncTasks.checked=this.calendarContext.util.getUserOption("syncTasks")==="Y"&&this.DOM.showTasks.checked;this.DOM.syncTasks.disabled=!l}if(this.DOM.denyBusyInvitation){this.DOM.denyBusyInvitation.checked=this.calendarContext.util.getUserOption("denyBusyInvitation")}if(this.DOM.showWeekNumbers){this.DOM.showWeekNumbers.checked=this.calendarContext.util.showWeekNumber()}if(this.DOM.timezoneSelect){this.DOM.timezoneSelect.value=this.calendarContext.util.getUserOption("timezoneName")||""}if(this.DOM.syncPeriodPast){this.DOM.syncPeriodPast.value=this.calendarContext.util.getUserOption("syncPeriodPast")||3}if(this.DOM.syncPeriodFuture){this.DOM.syncPeriodFuture.value=this.calendarContext.util.getUserOption("syncPeriodFuture")||12}if(this.showGeneralSettings){this.DOM.workTimeStart.value=this.settings.work_time_start;this.DOM.workTimeEnd.value=this.settings.work_time_end;if(this.DOM.weekHolidays){for(var r=0;r<this.DOM.weekHolidays.options.length;r++){this.DOM.weekHolidays.options[r].selected=this.settings.week_holidays.includes(this.DOM.weekHolidays.options[r].value)}}this.DOM.yearHolidays.value=this.settings.year_holidays;this.DOM.yearWorkdays.value=this.settings.year_workdays}if(this.showAccessControl&&i.Type.isElementNode(this.DOM.accessOuterWrap)){var h=this.calendarContext.util.config.TYPE_ACCESS;for(var d in h){if(h.hasOwnProperty(d)){this.insertAccessRow(this.calendarContext.util.getAccessName(d),d,h[d])}}}}},{key:"save",value:function e(){var t=this.calendarContext.util.config.userSettings;if(this.DOM.showDeclined){t.showDeclined=this.DOM.showDeclined.checked?1:0}if(this.DOM.showWeekNumbers){t.showWeekNumbers=this.DOM.showWeekNumbers.checked?"Y":"N"}if(this.DOM.showTasks){t.showTasks=this.DOM.showTasks.checked?"Y":"N"}if(this.DOM.syncTasks){t.syncTasks=this.DOM.syncTasks.checked?"Y":"N"}if(this.DOM.showCompletedTasks){t.showCompletedTasks=this.DOM.showCompletedTasks.checked?"Y":"N"}if(this.DOM.meetSectionSelect){t.meetSection=this.DOM.meetSectionSelect.value}if(this.DOM.crmSelect){t.crmSection=this.DOM.crmSelect.value}if(this.DOM.denyBusyInvitation){t.denyBusyInvitation=this.DOM.denyBusyInvitation.checked?1:0}if(this.DOM.timezoneSelect){t.userTimezoneName=this.DOM.timezoneSelect.value}if(this.DOM.syncPeriodPast){t.syncPeriodPast=this.DOM.syncPeriodPast.value}if(this.DOM.syncPeriodFuture){t.syncPeriodFuture=this.DOM.syncPeriodFuture.value}if(this.emailSelectorControl){t.sendFromEmail=this.emailSelectorControl.getValue()}var s={type:this.calendarContext.util.config.type,user_settings:t,user_timezone_name:t.userTimezoneName};if(this.showGeneralSettings&&this.DOM.workTimeStart){s.settings={work_time_start:this.DOM.workTimeStart.value,work_time_end:this.DOM.workTimeEnd.value,week_holidays:[],year_holidays:this.DOM.yearHolidays.value,year_workdays:this.DOM.yearWorkdays.value};for(var i=0;i<this.DOM.weekHolidays.options.length;i++){if(this.DOM.weekHolidays.options[i].selected){s.settings.week_holidays.push(this.DOM.weekHolidays.options[i].value)}}}if(this.showAccessControl){s.type_access=this.access}BX.ajax.runAction("calendar.api.calendarajax.saveSettings",{data:s}).then(function(){BX.reload()});this.close()}},{key:"initAccessController",value:function e(){var s,n,o,c,d,u=this;this.DOM.accessWrap=this.DOM.accessOuterWrap.appendChild(i.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="calendar-list-slider-access-container shown">\n\t\t\t\t\t<div class="calendar-list-slider-access-inner-wrap">\n\t\t\t\t\t\t','\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="calendar-list-slider-new-calendar-options-container">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t</div>"])),this.DOM.accessTable=i.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<table class="calendar-section-slider-access-table" />\n\t\t\t\t\t\t']))),this.DOM.accessButton=i.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t<span class="calendar-list-slider-new-calendar-option-add">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</span>"])),i.Loc.getMessage("EC_SEC_SLIDER_ACCESS_ADD"))));this.access={};this.accessControls={};this.accessTasks=(s=this.calendarContext)===null||s===void 0?void 0:(n=s.util)===null||n===void 0?void 0:n.getTypeAccessTasks();if((o=this.calendarContext)!==null&&o!==void 0&&(c=o.util)!==null&&c!==void 0&&(d=c.config)!==null&&d!==void 0&&d.accessNames){t.Util.setAccessNames(this.calendarContext.util.config.accessNames)}i.Event.bind(this.DOM.accessButton,"click",function(){u.entitySelectorDialog=new a.Dialog({targetNode:u.DOM.accessButton,context:"CALENDAR",preselectedItems:[],enableSearch:true,events:{"Item:onSelect":u.handleEntitySelectorChanges.bind(u),"Item:onDeselect":u.handleEntitySelectorChanges.bind(u)},popupOptions:{targetContainer:document.body},entities:[{id:"user"},{id:"project"},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}]});u.entitySelectorDialog.show();u.entitySelectorDialog.subscribe("onHide",u.allowSliderClose.bind(u));u.denySliderClose()});i.Event.bind(this.DOM.accessWrap,"click",function(e){var s=t.Util.findTargetNode(e.target||e.srcElement,u.DOM.outerWrap);if(i.Type.isElementNode(s)){if(s.getAttribute("data-bx-calendar-access-selector")!==null){var a=s.getAttribute("data-bx-calendar-access-selector");if(u.accessControls[a]){u.showAccessSelectorPopup({node:u.accessControls[a].removeIcon,setValueCallback:function e(t){if(u.accessTasks[t]&&u.accessControls[a]){u.accessControls[a].valueNode.innerHTML=i.Text.encode(u.accessTasks[t].title);u.access[a]=t}}})}}else if(s.getAttribute("data-bx-calendar-access-remove")!==null){var n=s.getAttribute("data-bx-calendar-access-remove");if(u.accessControls[n]){i.Dom.remove(u.accessControls[n].rowNode);u.accessControls[n]=null;delete u.access[n]}}}})}},{key:"handleEntitySelectorChanges",value:function e(){var s=this;var a=this.entitySelectorDialog.getSelectedItems();this.entitySelectorDialog.hide();if(i.Type.isArray(a)){a.forEach(function(e){var i=e.title.text;var a=t.Util.convertEntityToAccessCode(e);t.Util.setAccessName(a,i);s.insertAccessRow(i,a)})}i.Runtime.debounce(function(){s.entitySelectorDialog.destroy()},400)()}},{key:"insertAccessRow",value:function e(t,s,a){if(!this.accessControls[s]){if(a===undefined){for(var n in this.accessTasks){if(this.accessTasks.hasOwnProperty(n)&&this.accessTasks[n].name==="calendar_type_edit"){a=n;break}}}var o=i.Dom.adjust(this.DOM.accessTable.insertRow(-1),{props:{className:"calendar-section-slider-access-table-row"}});var c=i.Dom.adjust(o.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},html:'<span class="calendar-section-slider-access-title">'+i.Text.encode(t)+":</span>"});var l=i.Dom.adjust(o.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},attrs:{"data-bx-calendar-access-selector":s}});var r=l.appendChild(i.Dom.create("SPAN",{props:{className:"calendar-section-slider-access-container"}}));var h=r.appendChild(i.Dom.create("SPAN",{text:this.accessTasks[a]?this.accessTasks[a].title:"",props:{className:"calendar-section-slider-access-value"}}));var d=r.appendChild(i.Dom.create("SPAN",{props:{className:"calendar-section-slider-access-remove"},attrs:{"data-bx-calendar-access-remove":s}}));this.access[s]=a;this.accessControls[s]={rowNode:o,titleNode:c,valueNode:h,removeIcon:d}}}},{key:"checkAccessTableHeight",value:function e(){var t=this;if(this.checkTableTimeout){this.checkTableTimeout=clearTimeout(this.checkTableTimeout)}this.checkTableTimeout=setTimeout(function(){if(i.Dom.hasClass(t.DOM.accessWrap,"shown")){if(t.DOM.accessWrap.offsetHeight-t.DOM.accessTable.offsetHeight<36){t.DOM.accessWrap.style.maxHeight=parseInt(t.DOM.accessTable.offsetHeight)+100+"px"}}else{t.DOM.accessWrap.style.maxHeight=""}},300)}},{key:"showAccessSelectorPopup",value:function e(s){if(this.accessPopupMenu&&this.accessPopupMenu.popupWindow&&this.accessPopupMenu.popupWindow.isShown()){return this.accessPopupMenu.close()}var i=this;var a=[];for(var n in this.accessTasks){if(this.accessTasks.hasOwnProperty(n)){a.push({text:this.accessTasks[n].title,onclick:function(e){return function(){s.setValueCallback(e);i.accessPopupMenu.close()}}(n)})}}this.accessPopupMenu=this.BX.PopupMenu.create("section-access-popup"+t.Util.randomInt(),s.node,a,{closeByEsc:true,autoHide:true,offsetTop:-5,offsetLeft:0,angle:true,cacheable:false,events:{onPopupClose:this.allowSliderClose.bind(this)}});this.accessPopupMenu.show();this.denySliderClose()}},{key:"openHelpDesk",value:function e(){var t=14326208;top.BX.Helper.show("redirect=detail&code="+t)}},{key:"showMessage",value:function e(){if(this.message){this.message.show();this.DOM.accessMessageWrap.style.maxHeight=300+"px";i.Dom.addClass(this.DOM.accessHelpIcon,"calendar-settings-message-arrow-target")}}},{key:"hideMessage",value:function e(){if(this.message){i.Dom.removeClass(this.DOM.accessHelpIcon,"calendar-settings-message-arrow-target");this.message.hide();this.DOM.accessMessageWrap.style.maxHeight=0;if(!this.calendarContext.util.config.hideSettingsHintLocation){BX.ajax.runAction("calendar.api.locationajax.hideSettingsHintLocation",{data:{value:true}}).then(function(){})}}}}]);return e}();e.SettingsInterface=d})(this.BX.Calendar=this.BX.Calendar||{},BX.Calendar,BX.Calendar.Controls,BX,BX.UI.EntitySelector,BX.Event,BX.UI);
//# sourceMappingURL=settingsinterface.bundle.map.js