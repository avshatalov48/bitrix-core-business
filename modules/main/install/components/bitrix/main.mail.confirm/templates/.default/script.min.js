(function(){if(window.BXMainMailConfirm)return;var e={};var t=[];var a={};var i;var n={init:function(a){t=a.mailboxes;i=a.action;delete a.mailboxes;e=a},getMailboxes:function(){return t},showList:function(e,i,o){if(!BX.type.isNotEmptyString(o.placeholder)){o.placeholder=BX.message(o.required?"MAIN_MAIL_CONFIRM_MENU_UNKNOWN":"MAIN_MAIL_CONFIRM_MENU_PLACEHOLDER")}if(!(o.settings&&o.settings.length)){o.settings=[]}if(!BX.type.isFunction(o.callback)){o.callback=function(){}}if(typeof o.popupSettings!="object"){o.popupSettings={}}o.popupSettings.className="main-mail-confirm-menu-content";o.popupSettings.offsetLeft=40;o.popupSettings.angle=true;o.popupSettings.closeByEsc=true;a[e]=o;var l=[];var s=function(i,o){var l="apply";if(i&&i.target){var s="main-mail-confirm-menu-delete-icon";if(BX.hasClass(i.target,s)||BX.findParent(i.target,{class:s},o.layout.item)){l="delete"}}if("delete"==l){n.deleteSender(o.id,function(){t=t.filter(function(e,t){return o.id!==e.id});o.menuWindow.removeMenuItem(o.id);if(a[e].selected==o.title){a[e].callback("",a[e].placeholder)}})}else{a[e].callback(o.title,o.text);o.menuWindow.close()}};if(!o.required){l.push({text:BX.util.htmlspecialchars(o.placeholder),title:"",onclick:s});l.push({delimiter:true})}if(t&&t.length>0){var r,d;for(var u in t){d="menu-popup-no-icon";r=BX.util.htmlspecialchars(t[u].formated);if(t[u]["can_delete"]&&t[u].id>0){r+='<span class="main-mail-confirm-menu-delete-icon popup-window-close-icon popup-window-titlebar-close-icon"\t\t\t\t\t\t\t\ttitle="'+BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_DELETE"))+'"></span>';d="menu-popup-no-icon menu-popup-right-icon"}l.push({html:r,title:t[u].formated,onclick:s,className:d,id:t[u].id})}l.push({delimiter:true})}l.push({text:BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_MENU")),onclick:function(i,o){o.menuWindow.close();n.showForm(function(i,n){t.push({email:i.email,name:i.name,id:i.id,formated:n,can_delete:true});a[e].callback(n,BX.util.htmlspecialchars(n));BX.PopupMenu.destroy(e+"-menu")})}});if(o.settings.length>0){l=l.concat(o.settings)}BX.PopupMenu.show(e+"-menu",i,l,o.popupSettings)},showForm:function(t,a){var n="email";var o;var l=a&&a.mode?a.mode:"add";var s=new BX.PopupWindow("add_from_email",null,{titleBar:BX.message("MAIN_MAIL_CONFIRM_TITLE"),draggable:true,closeIcon:true,lightShadow:true,contentColor:"white",contentNoPaddings:true,content:BX("new_from_email_dialog_content").innerHTML,buttons:[new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_GET_CODE"),className:"popup-window-button-create",events:{click:function(){var e=this;if(BX.hasClass(e.buttonNode,"popup-window-button-wait"))return;var l=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-email-block",true);var r=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-code-block",true);var d=BX.findChild(l,{attr:{"data-name":"name"}},true);var u=BX.findChild(l,{attr:{"data-name":"email"}},true);var m=BX.findChild(r,{attr:{"data-name":"code"}},true);var c=BX.findChild(s.contentContainer,{attr:{"data-name":"public"}},true);var f=BX.findChild(l,{attr:{"data-name":"smtp-server"}},true);var _=BX.findChild(l,{attr:{"data-name":"smtp-port"}},true);var p=BX.findChild(l,{attr:{"data-name":"smtp-ssl"}},true);var M=BX.findChild(l,{attr:{"data-name":"smtp-login"}},true);var h=BX.findChild(l,{attr:{"data-name":"smtp-password"}},true);s.formFieldHint(h);if("email"==n||"smtp"==n){m.value="";var N="[=a-z0-9_+~'!$&*^`|#%/?{}-]";var I=new RegExp("^"+N+"+(\\."+N+"+)*@([a-z0-9-]+\\.)+[a-z0-9-]{2,20}$","i");if(!u.value.match(I)){s.showNotify(BX.message(u.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_EMAIL":"MAIN_MAIL_CONFIRM_EMPTY_EMAIL"));return}}if("smtp"==n){if(!f.value.match(/^([a-z0-9-]+\.)+[a-z0-9-]{2,20}$/)){s.showNotify(BX.message(f.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_SERVER":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_SERVER"));return}if(!_.value.match(/^[0-9]+$/)||_.value<1||_.value>65535){s.showNotify(BX.message(_.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_PORT":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_PORT"));return}if(!(M.value.length>0)){s.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_LOGIN"));return}if(h.value.length>0){if(h.value.match(/^\^/)){s.showNotify(BX.message("MAIN_MAIL_CONFIRM_INVALID_SMTP_PASSWORD_CARET"));return}else if(h.value.match(/\x00/)){s.showNotify(BX.message("MAIN_MAIL_CONFIRM_INVALID_SMTP_PASSWORD_NULL"));return}else if(h.value.match(/^\s|\s$/)){s.formFieldHint(h,"warning",BX.message("MAIN_MAIL_CONFIRM_SPACE_SMTP_PASSWORD"))}}else{s.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_PASSWORD"));return}}if("code"==n){if(m.value.length==0){s.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_CODE"));return}}s.hideNotify();BX.addClass(e.buttonNode,"popup-window-button-wait");var B={name:d.value,email:u.value,smtp:{},code:"",public:c.checked?c.value:""};if("smtp"==n){B.smtp={server:f.value,port:_.value,ssl:p.checked?p.value:"",login:M.value,password:h.value}}if("code"==n){B.code=m.value}if(a&&a.data){for(var C in a.data){if(a.data.hasOwnProperty(C)){B[C]=a.data[C]}}}BX.ajax({url:BX.util.add_url_param(i,{act:"add"}),method:"POST",dataType:"json",data:B,onsuccess:function(a){BX.removeClass(e.buttonNode,"popup-window-button-wait");if(a.senderId){o=a.senderId}if(a.result=="error"){s.showNotify(a.error)}else if(("email"==n||"smtp"==n)&&!a.confirmed){s.formFieldHint(h);s.switchBlock("code")}else{e.popupWindow.close();if(BX.type.isFunction(t)){var i=d.value.length>0?d.value:BX.message("MAIN_MAIL_CONFIRM_USER_FULL_NAME");t({name:i,email:u.value,id:o},i.length>0?i+" <"+u.value+">":u.value)}}},onfailure:function(t){BX.removeClass(e.buttonNode,"popup-window-button-wait");s.showNotify(BX.message("MAIN_MAIL_CONFIRM_AJAX_ERROR"))}})}}}),new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_CANCEL"),className:"popup-window-button-link",events:{click:function(){if("code"==n&&"confirm"!=l){var e=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-smtp-block",true);s.switchBlock(e&&e.offsetHeight>0?"smtp":"email")}else{this.popupWindow.close()}}}})]});s.formFieldHint=function(e,t,a){if(!e){return}var i=BX.findParent(e,{class:"new-from-email-dialog-cell"});var n=BX.findChildByClassName(i,"new-from-email-dialog-field-hint",true);BX.removeClass(i,"new-from-email-dialog-field-error");BX.removeClass(i,"new-from-email-dialog-field-warning");switch(t){case"error":BX.addClass(i,"new-from-email-dialog-field-error");break;case"warning":BX.addClass(i,"new-from-email-dialog-field-warning");break}if(typeof a!="undefined"&&a.length>0){BX.adjust(n,{html:a});BX.show(n,"block")}else{BX.hide(n,"block")}};s.hideNotify=function(){var e=BX.findChild(s.contentContainer,{class:"new-from-email-dialog-error"},true);BX.hide(e,"block")};s.showNotify=function(e){var t=BX.findChild(s.contentContainer,{class:"new-from-email-dialog-error"},true);t.innerHTML=e;BX.show(t,"block")};s.switchBlock=function(t,a){var i=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-email-block",true);var o=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-code-block",true);var l,r;if("code"!=n&&"code"==t){l=i;r=o;s.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_SAVE"));s.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_BACK"))}else if("code"==n&&"code"!=t){l=o;r=i;s.buttons[0].setName(BX.message("smtp"==t&&e.canCheckSmtp?"MAIN_MAIL_CONFIRM_SAVE":"MAIN_MAIL_CONFIRM_GET_CODE"));s.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_CANCEL"))}n=t;if(l&&r){if(a){r.style.position="";r.style.height="";r.style.display="";l.style.display="none"}else{l.style.height=l.offsetHeight+"px";l.offsetHeight;l.style.height="0px";r.style.position="absolute";r.style.height="";r.style.display="";var d=r.offsetHeight;r.style.height="0px";r.style.position="";r.offsetHeight;r.style.height=d+"px"}}};var r=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-smtp-link",true);var d=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-smtp-block",true);if(r&&d){BX.bind(r,"click",function(t){var a=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-email-block",true);a.style.height="";if("smtp"==n){n="email";BX.hide(d,"table-row-group");s.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_GET_CODE"))}else{n="smtp";BX.show(d,"table-row-group");s.buttons[0].setName(BX.message(e.canCheckSmtp?"MAIN_MAIL_CONFIRM_SAVE":"MAIN_MAIL_CONFIRM_GET_CODE"))}t.preventDefault()})}if("confirm"==l){s.switchBlock("code",true);s.setOverlay(true)}s.show();var u=BX.findChildByClassName(s.contentContainer,"new-from-email-dialog-email-block",true);var m=BX.findChild(u,{attr:{"data-name":"name"}},true);var c=BX.findChild(u,{attr:{"data-name":"email"}},true);if(m.value.length>0){c.focus()}else{m.focus()}},updateListCanDel:function(e){BX.ajax({url:BX.util.add_url_param(i,{act:"sendersListCanDel"}),method:"POST",dataType:"json",data:{},onsuccess:function(a){if(a.result=="error"){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}else{t=t.filter(function(e,t){if(!e.can_delete){return true}for(var i in a.mailboxes){if(a.mailboxes[i].id==e.id){return true}}return false});BX.PopupMenu.destroy(e+"-menu")}},onfailure:function(e){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}})},deleteSender:function(e,t){BX.UI.Dialogs.MessageBox.show({message:BX.message("MAIN_MAIL_CONFIRM_DELETE_SENDER_CONFIRM"),modal:true,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(a){return new Promise(function(a,n){BX.ajax({url:BX.util.add_url_param(i,{act:"delete"}),method:"POST",dataType:"json",data:{senderId:e},onsuccess:function(e){if(e.result=="error"){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")});n(e)}else{if(BX.type.isFunction(t)){t()}a(e)}},onfailure:function(e){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")});n(e)}})})},onCancel:function(e){e.close()}})}};window.BXMainMailConfirm=n})();
//# sourceMappingURL=script.map.js