this.BX=this.BX||{};(function(t,e,i,s,n,o,r,a,l,d){"use strict";let h=t=>t,c,u;class m extends i.DateTimeControl{create(){this.DOM.dateTimeWrap=this.DOM.outerContent.querySelector(`#${this.UID}_datetime_container`);this.DOM.editor=this.DOM.outerContent.querySelector(`#${this.UID}_datetime_editor`);this.DOM.fromDate=this.DOM.outerContent.querySelector(`#${this.UID}_date_from`);this.DOM.toDate=this.DOM.outerContent.querySelector(`#${this.UID}_date_to`);this.DOM.fromTime=this.DOM.outerContent.querySelector(`#${this.UID}_time_from`);this.DOM.toTime=this.DOM.outerContent.querySelector(`#${this.UID}_time_to`);this.fromTimeControl=new i.TimeSelector({input:this.DOM.fromTime,onChangeCallback:this.handleTimeFromChange.bind(this)});this.toTimeControl=new i.TimeSelector({input:this.DOM.toTime,onChangeCallback:this.handleTimeToChange.bind(this)});this.DOM.fullDay=this.DOM.outerContent.querySelector(`#${this.UID}_date_full_day`);this.DOM.defTimezoneWrap=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_default_wrap`);this.DOM.defTimezone=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_default`);this.DOM.fromTz=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_from`);this.DOM.toTz=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_to`);this.DOM.tzButton=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_btn`);this.DOM.tzOuterCont=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_wrap`);this.DOM.tzCont=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_inner_wrap`);this.DOM.outerContent.querySelector(`#${this.UID}_timezone_hint`).title=e.Loc.getMessage("EC_EVENT_TZ_HINT");this.DOM.outerContent.querySelector(`#${this.UID}_timezone_default_hint`).title=e.Loc.getMessage("EC_EVENT_TZ_DEF_HINT");this.prepareModel();this.bindEventHandlers();if(BX.isAmPmMode()){this.DOM.fromTime.style.minWidth="8em";this.DOM.toTime.style.minWidth="8em"}else{this.DOM.fromTime.style.minWidth="6em";this.DOM.toTime.style.minWidth="6em"}}prepareModel(){e.Dom.adjust(this.DOM.fromDate,{props:{autocomplete:"off"}});e.Dom.adjust(this.DOM.toDate,{props:{autocomplete:"off"}});e.Dom.adjust(this.DOM.fromTime,{props:{autocomplete:"off"}});e.Dom.adjust(this.DOM.toTime,{props:{autocomplete:"off"}})}setReadonly(t){const i=this.getValue();let n="";const o=s.Util.formatDateUsable(i.from,true,true);const r=s.Util.formatDateUsable(i.to,true,true);const a=this.DOM.fromTime.value;const l=this.DOM.toTime.value;n+=o+", ";if(i.fullDay){if(o===r){n+=e.Loc.getMessage("EC_ALL_DAY")}else{n+=" - "}}else{n+=a+" - "+l}if(!i.fullDay&&o!==r){n+=", "+r}let d="";if(e.Type.isStringFilled(t)){d=e.Tag.render(c||(c=h`
				<div class="calendar-date-selector-readonly-timezone" title="${0}">
					<div class="calendar-date-selector-readonly-timezone-icon"></div>
				</div>
			`),t)}e.Dom.style(this.DOM.editor,"display","none");const m=e.Tag.render(u||(u=h`
			<div class="calendar-options-item-column-right">
				<div class="calendar-field calendar-date-selector-readonly">
					${0}
					${0}
				</div>
			</div>
		`),n,d);e.Dom.append(m,this.DOM.dateTimeWrap)}}let p=t=>t,f,y,D,g,E,O,C,S,M,T,v,I,_,b;class L{constructor(t={}){var i,n,o,a;this.DOM={};this.uid=null;this.sliderId="calendar:edit-entry-slider";this.zIndex=3100;this.denyClose=false;this.formType="slider_main";this.STATE={READY:1,REQUEST:2,ERROR:3};this.sections=[];this.sectionIndex={};this.trackingUsersList=[];this.userSettings={};this.prevUserList=[];this.loadedAccessibilityData={};this.eventOptions={};this.name=t.name||"eventeditform";this.type=t.type||"user";this.isLocationCalendar=t.isLocationCalendar||false;this.locationAccess=t.locationAccess||false;this.isProjectFeatureEnabled=s.Util.isProjectFeatureEnabled()||false;this.locationCapacity=t.locationCapacity||0;this.roomsManager=t.roomsManager||null;this.userId=t.userId||parseInt(e.Loc.getMessage("USER_ID"));this.ownerId=t.ownerId;this.entryId=parseInt(t.entryId)||null;this.entry=t.entry||null;this.eventOptions=((i=this.entry)==null?void 0:(n=i.data)==null?void 0:n.OPTIONS)||{};this.formDataValue=t.formDataValue||{};this.emitter=new r.EventEmitter;this.emitter.setEventNamespace("BX.Calendar.EventEditForm");this.BX=s.Util.getBX();this.context=(o=s.Util.getCalendarContext())!=null?o:t.calendarContext;if(!s.Util.getCalendarContext()){s.Util.setCalendarContext(this.context)}this.isOpenEvent=(((a=this.entry)==null?void 0:a.data["CAL_TYPE"])||this.type)==="open_event";this.plannerEnabled=true;this.sectionSelectorEnabled=!this.isOpenEvent;this.attendeesControlEnabled=!this.isOpenEvent;this.formSettings={pinnedFields:{}};if(!this.ownerId&&this.type==="user"){this.ownerId=this.userId}if(e.Type.isDate(t.entryDateFrom)&&!this.formDataValue.from){this.formDataValue.from=t.entryDateFrom;this.formDataValue.to=new Date(t.entryDateFrom.getTime()+3600)}this.participantsEntityList=e.Type.isArray(t.participantsEntityList)?t.participantsEntityList:[];this.participantsSelectorEntityList=e.Type.isArray(t.participantsSelectorEntityList)?t.participantsSelectorEntityList:[];if(t.entryName&&!this.entryId){this.formDataValue.name=t.entryName}if(t.entryDescription&&!this.entryId){this.formDataValue.description=t.entryDescription}if(t.jumpToControl){this.jumpToControl=t.jumpToControl}if(this.plannerEnabled){this.refreshPlanner=e.Runtime.debounce(this.refreshPlannerState,100,this)}this.state=this.STATE.READY;this.doShowConfirmPopup=true;this.sliderOnClose=this.hideWithConfirm.bind(this);this.handlePullBind=this.handlePull.bind(this);this.keyHandlerBind=this.keyHandler.bind(this);this.lastUsedSaveOptions={};this.timezoneHint="";this.isAvailable=true}initInSlider(t,i){this.sliderId=t.getUrl();this.BX.addCustomEvent(t,"SidePanel.Slider:onLoad",this.onLoadSlider.bind(this));this.BX.addCustomEvent(t,"SidePanel.Slider:onClose",this.sliderOnClose);this.BX.addCustomEvent(t,"SidePanel.Slider:onBeforeCloseComplete",this.destroy.bind(this));this.setCurrentEntry(this.entry||null);this.createContent(t).then((t=>{if(e.Type.isFunction(i)){i(t)}}));this.opened=true;this.bindEventHandlers()}canEdit(){var t;if(e.Type.isBoolean((t=this.entry.permissions)==null?void 0:t.edit)){return this.entry.permissions.edit}if(this.entry.isMeeting()&&this.entry.sectionId!==this.getCurrentSectionId()){return false}if(this.entry.isResourcebooking()){return false}return new o.CalendarSection(this.getCurrentSection()).canDo("edit")}show(t={}){this.setCurrentEntry(t.entry);if(t.formType){this.formType=t.formType}this.BX.SidePanel.Instance.open(this.sliderId,{contentCallback:this.createContent.bind(this),label:{text:e.Loc.getMessage("CALENDAR_EVENT"),bgColor:"#55D0E0"},events:{onClose:this.sliderOnClose,onCloseComplete:this.destroy.bind(this),onLoad:this.onLoadSlider.bind(this)}});this.opened=true;this.bindEventHandlers()}isOpened(){return this.opened}bindEventHandlers(){e.Event.bind(document,"keydown",this.keyHandlerBind);r.EventEmitter.subscribe("onPullEvent-calendar",this.handlePullBind);this.mouseUpNodeCheck=null;e.Event.bind(document,"mousedown",(t=>{this.mousedownTarget=t.target||t.srcElement}));e.Event.bind(document,"mouseup",(t=>{const e=t.target||t.srcElement;if(this.mousedownTarget!==e){this.mouseUpNodeCheck=false}setTimeout((()=>{this.mouseUpNodeCheck=null}),0)}));r.EventEmitter.subscribe("Calendar.LocationControl.onValueChange",(()=>{if(this.locationBusyAlert){e.Dom.remove(this.locationBusyAlert);this.locationBusyAlert=null}}));this.BX.addCustomEvent(window,"onCalendarControlChildPopupShown",this.BX.proxy(this.denySliderClose,this));this.BX.addCustomEvent(window,"onCalendarControlChildPopupClosed",this.BX.proxy(this.allowSliderClose,this))}onLoadSlider(t){this.slider=t.getSlider();this.DOM.content=this.slider.layout.content;this.sliderId=this.slider.getUrl();if(!this.isAvailable){return}this.BX.html(this.slider.layout.content,this.slider.getData().get("sliderContent"));this.initControls(this.uid);this.setFormValues();if(e.Type.isStringFilled(this.jumpToControl)){if(this.jumpToControl==="userSelector"){const t=this.DOM.content.querySelector(`#${this.uid}_attendees_selector`);e.Dom.style(t,"transition","300ms background ease");setTimeout((()=>this.highlightField(t)),900)}if(this.jumpToControl==="location"){const t=document.querySelector(`[data-bx-block-placeholer=${this.jumpToControl}]`);e.Dom.style(t,"transition","300ms background ease");setTimeout((()=>this.highlightField(t)),900)}}e.Event.bind(this.DOM.content,"wheel",(()=>{var t;return(t=this.highlightFieldScrollAnimation)==null?void 0:t.stop()}))}close(){if(!this.checkDenyClose()){this.state=this.STATE.READY;this.BX.SidePanel.Instance.close()}}save(t={}){var o,a;if(this.state===this.STATE.REQUEST||this.DOM.locationRepeatBusyErrorPopup){return false}t=e.Type.isPlainObject(t)?t:{};const l=this.getFormDataChanges();if(this.isEditForm()&&l.length===0){this.BX.SidePanel.Instance.close();return true}if(!this.userSettings.sendFromEmail&&this.hasExternalEmailUsers()&&this.canEdit()&&!t.emailConfirmDialogShown){n.EntryManager.showConfirmedEmailDialog({callback:e=>{if(e.sendFromEmail){this.userSettings.sendFromEmail=e.sendFromEmail}t.emailConfirmDialogShown=true;this.save(t)}});return false}if(this.entry.id&&this.entry.isRecursive()&&!t.confirmed&&this.getFormDataChanges(["section"]).length>0){n.EntryManager.showConfirmEditDialog({callback:e=>{t.recursionMode=this.entry.isFirstInstance()&&e.recursionMode==="next"?"all":e.recursionMode;t.confirmed=true;this.lastUsedSaveOptions=t;this.save(t)},canEditOnlyThis:this.canEditOnlyThis()});return false}if(this.entry.id&&this.entry.isMeeting()&&t.sendInvitesAgain===undefined&&l.includes("date&time")&&this.entry.getAttendees().find((t=>t.STATUS==="N"))){n.EntryManager.showReInviteUsersDialog({callback:e=>{t.sendInvitesAgain=e.sendInvitesAgain;this.lastUsedSaveOptions=t;this.save(t)}});return false}if(this.entry.id&&this.entry.isRecursive()&&!t.confirmed&&l.includes("section")){t.recursionMode=this.entry.isFirstInstance()?"all":"next"}e.Dom.addClass(this.DOM.saveBtn,this.BX.UI.Button.State.CLOCKING);e.Dom.addClass(this.DOM.closeBtn,this.BX.UI.Button.State.DISABLED);this.state=this.STATE.REQUEST;this.DOM.form.id.value=this.entry.id||0;this.DOM.form.location.value=this.locationSelector.getTextValue();if(this.editor){this.editor.SaveContent()}const d=this.getCurrentSection();if(d&&d.COLOR.toLowerCase()!==this.colorSelector.getValue().toLowerCase()){this.DOM.form.color.value=this.colorSelector.getValue()}if(t.recursionMode){this.DOM.form.current_date_from.value=s.Util.formatDate(this.entry.from);this.DOM.form.rec_edit_mode.value=t.recursionMode}else{this.DOM.form.current_date_from.value=null;this.DOM.form.rec_edit_mode.value=null}if(t.sendInvitesAgain!==undefined){this.DOM.form.appendChild(e.Tag.render(f||(f=p`<input name="sendInvitesAgain" type="hidden" value="${0}">`),t.sendInvitesAgain?"Y":"N"))}if(!this.DOM.form.requestUid){this.DOM.requestUid=this.DOM.form.appendChild(e.Tag.render(y||(y=p`<input name="requestUid" type="hidden">`)))}if(!this.DOM.form.meeting_host){this.DOM.meeting_host=this.DOM.form.appendChild(e.Tag.render(D||(D=p`<input type="hidden" name="meeting_host" value="${0}">`),this.entry.data.MEETING_HOST||"0"))}if(!this.DOM.form.chat_id){this.DOM.chat_id=this.DOM.form.appendChild(e.Tag.render(g||(g=p`<input type="hidden" name="chat_id" value="${0}">`),this.entry.data.MEETING?this.entry.data.MEETING.CHAT_ID:0))}this.DOM.requestUid.value=s.Util.registerRequestId();let h;if(this.attendeesControlEnabled){h=this.getUserSelectorEntityList();e.Dom.clean(this.DOM.userSelectorValueWarp);h.forEach(((t,i)=>{this.DOM.userSelectorValueWarp.appendChild(e.Tag.render(E||(E=p`
				<input type="hidden" name="attendeesEntityList[${0}][entityId]" value="${0}">
			`),i,t.entityId));this.DOM.userSelectorValueWarp.appendChild(e.Tag.render(O||(O=p`
				<input type="hidden" name="attendeesEntityList[${0}][id]" value="${0}">
			`),i,t.id))}))}let c=!this.entry.id||this.checkCurrentUsersAccessibility();if(!c&&l.includes("codes")){const t=this.entry.getAttendeesEntityList();h.forEach((i=>{if(!t.find((t=>i.entityId===t.entityId&&Number(i.id)===Number(t.id)))){if(i.entityId==="user"){this.DOM.userSelectorValueWarp.appendChild(e.Tag.render(C||(C=p`
							<input type="hidden" name="newAttendeesList[]" value="${0}">
						`),parseInt(i.id)))}else{c=true}}}))}if(this.attendeesControlEnabled){this.DOM.userSelectorValueWarp.appendChild(e.Tag.render(S||(S=p`
				<input type="hidden" name="checkCurrentUsersAccessibility" value="${0}">
			`),c?"Y":"N"))}if(this.isOpenEvent){const t=this.categoryTagSelector.getDialog().getSelectedItems();const i=t[0].id;this.DOM.form.appendChild(e.Tag.render(M||(M=p`<input type="hidden" name="category" value="${0}">`),i))}this.DOM.form.doCheckOccupancy.value=t.doCheckOccupancy||"Y";const u=new FormData(this.DOM.form);this.BX.ajax.runAction("calendar.api.calendarentryajax.editEntry",{data:u,analyticsLabel:{calendarAction:this.isCreateForm()?"create_event":"edit_event",formType:"full",emailGuests:this.hasExternalEmailUsers()?"Y":"N",markView:s.Util.getCurrentView()||"outside",markCrm:(o=this.DOM.form)!=null&&o["UF_CRM_CAL_EVENT[]"]&&this.DOM.form["UF_CRM_CAL_EVENT[]"].value?"Y":"N",markRrule:(a=this.repeatSelector)==null?void 0:a.getType(),markMeeting:this.entry.isMeeting()?"Y":"N",markType:this.type}}).then((async s=>{if(this.canEditOnlyThis()&&l.includes("color")){var o,a,d;const t=(o=s.data)==null?void 0:(a=o.eventList)==null?void 0:a.find((t=>t.DATE_FROM.includes(u.get("date_from"))&&parseInt(t.OWNER_ID,10)===parseInt(this.ownerId,10)));const e=(d=t==null?void 0:t.ID)!=null?d:this.entryId;await this.BX.ajax.runAction("calendar.api.calendarajax.updateColor",{data:{entryId:e,color:this.colorSelector.getValue().toLowerCase()}})}if(this.isLocationCalendar){this.roomsManager.unsetHiddenRoom(i.Location.parseStringValue(this.DOM.form.location.value).room_id)}const h=this.getCurrentSection();if(h&&this.context&&this.context.sectionManager){this.unsetHiddenSection(h,this.context.sectionManager)}this.state=this.STATE.READY;this.allowSliderClose();this.doShowConfirmPopup=false;this.close();e.Dom.removeClass(this.DOM.closeBtn,this.BX.UI.Button.State.DISABLED);e.Dom.removeClass(this.DOM.saveBtn,this.BX.UI.Button.State.CLOCKING);if(s.data.entryId){if(this.entry.id){n.EntryManager.showEditEntryNotification(s.data.entryId)}else{n.EntryManager.showNewEntryNotification(s.data.entryId)}}if(e.Type.isArray(s.data.eventList)&&s.data.eventList.length>0&&s.data.eventList[0].REMIND&&s.data.eventList[0].REMIND.length>0){n.EntryManager.setNewEntryReminders(s.data.eventList[0].DT_SKIP_TIME==="Y"?"fullDay":"withTime",s.data.eventList[0].REMIND)}this.emitter.emit("onSave",new r.BaseEvent({data:{responseData:s.data,options:t}}));r.EventEmitter.emit("BX.Calendar:onEntrySave",new r.BaseEvent({data:{sliderId:this.sliderId,responseData:s.data,options:t}}))}),(t=>{e.Dom.removeClass(this.DOM.saveBtn,this.BX.UI.Button.State.CLOCKING);e.Dom.removeClass(this.DOM.closeBtn,this.BX.UI.Button.State.DISABLED);if(t.data&&e.Type.isPlainObject(t.data.busyUsersList)){this.handleBusyUsersError(t.data.busyUsersList);const e=[];t.errors.forEach((t=>{if(t.code!=="edit_entry_user_busy"){e.push(t)}}));t.errors=e}if(t.errors&&t.errors.length>0){this.showError(t.errors)}this.state=this.STATE.ERROR}));return true}canEditOnlyThis(){const t=this.entry.permissions;if(!t){return false}return t.edit_attendees&&t.edit_location&&!t.edit}handleBusyUsersError(t){const e=[];const s=[];for(const i in t){if(t.hasOwnProperty(i)){e.push(t[i]);s.push(i)}}this.busyUsersDialog=new i.BusyUsersDialog;this.busyUsersDialog.subscribe("onSaveWithout",(()=>{this.DOM.form.exclude_users.value=s.join(",");this.save()}));this.busyUsersDialog.show({users:e})}hideWithConfirm(t){if(!(t&&t.getSlider&&t.getSlider().getUrl()===this.sliderId)){return}if(!this.isAvailable){this.BX.removeCustomEvent("SidePanel.Slider:onClose",this.sliderOnClose);return}s.Util.closeAllPopups();if(this.checkDenyClose()){t.denyAction();return}if(this.needToShowConfirmPopup()){t.denyAction();const i=this.isCreateForm()?e.Loc.getMessage("EC_CLOSE_CREATE_FORM_CONFIRM_QUESTION"):e.Loc.getMessage("EC_CLOSE_EDIT_FORM_CONFIRM_QUESTION");s.Util.showConfirmPopup(this.hide.bind(this),i,{okCaption:e.Loc.getMessage("EC_CLOSE_EDIT_FORM_CONFIRM_OK"),minWidth:350,maxWidth:350})}else{this.BX.removeCustomEvent("SidePanel.Slider:onClose",this.sliderOnClose)}}hide(){this.doShowConfirmPopup=false;this.slider.close()}destroy(t){if(t&&t.getSlider()&&t.getSlider().getUrl()===this.sliderId){this.BX.onCustomEvent("OnCalendarPlannerDoUninstall",[{plannerId:this.plannerId}]);e.Event.unbind(document,"keydown",this.keyHandlerBind);r.EventEmitter.unsubscribe("onPullEvent-calendar",this.handlePullBind);this.BX.SidePanel.Instance.destroy(this.sliderId);if(i.Location){i.Location.setCurrentCapacity(0)}s.Util.closeAllPopups();this.planner=null;this.opened=false;s.Util.clearPlannerWatches()}}createContent(t){var i,n;const r=new this.BX.Promise;let a=this.getCurrentEntry();this.BX.ajax.runAction("calendar.api.calendarajax.getEditEventSlider",{data:{event_id:this.entryId||a.id,date_from:a?s.Util.formatDate(a.from):"",form_type:this.formType,type:(i=a.data.CAL_TYPE)!=null?i:this.type,ownerId:(n=a.data.OWNER_ID)!=null?n:this.ownerId,entityList:this.participantsEntityList}}).then((i=>{if(e.Type.isFunction(t.isOpen)&&t.isOpen()||t.isOpen===true){const d=this.BX.util.trim(i.data.html);t.getData().set("sliderContent",d);const h=i.data.additionalParams;this.updateEntryData(h.entry,{userSettings:this.userSettings,meetSection:h.meetSection});a=this.getCurrentEntry();this.uid=h.uniqueId;this.editorId=h.editorId;this.formSettings=this.getSettings(h.formSettings||[]);let c=this.formDataValue.attendeesEntityList||h.attendeesEntityList||[];if(!a.id&&this.participantsEntityList.length>0){c=this.participantsEntityList}if(e.Type.isArray(c)){c.forEach((t=>{if(t.entityId==="user"&&h.userIndex[t.id]){if(h.userIndex[t.id].EMAIL_USER){t.entityType="email";t.title=h.userIndex[t.id].DISPLAY_NAME}else if(h.userIndex[t.id].SHARING_USER){t.entityType="sharing";t.title=h.userIndex[t.id].DISPLAY_NAME}else{t.entityType="employee"}}}))}this.setUserSelectorEntityList(c);this.attendeesPreselectedItems=this.getUserSelectorEntityList().map((t=>[t.entityId,t.id]));this.setUserSettings(h.userSettings);s.Util.setEventWithEmailGuestEnabled(h.eventWithEmailGuestEnabled);this.handleSections(h.sections,h.trackingUsersList);this.handleLocationData(h.locationFeatureEnabled,h.locationList,h.iblockMeetingRoomList);this.locationAccess=h.locationAccess;this.plannerFeatureEnabled=Boolean(h.plannerFeatureEnabled);this.isProjectFeatureEnabled=h.projectFeatureEnabled;if(this.planner&&!this.plannerFeatureEnabled){this.planner.lock()}if(!a.id&&!a.sectionId){this.setCurrentEntry()}if(this.userSettings.meetSection&&this.type==="user"){o.SectionManager.setNewEntrySectionId(this.userSettings.meetSection)}if(this.isOpenEvent){var n,l;const t=((n=this.formDataValue)==null?void 0:n.category)||((l=this.eventOptions)==null?void 0:l.CATEGORY_ID);const e=t||h.defaultCategoryId;this.preSelectedCategory=e?["event-category",e]:null}this.timezoneHint=h.timezoneHint;r.fulfill(d)}}),(i=>{if(i.data&&!e.Type.isNil(i.data.isAvailable)&&!i.data.isAvailable){this.isAvailable=false;const t=()=>{top.BX.UI.InfoHelper.show("limit_office_calendar_off",{isLimit:true,limitAnalyticsLabels:{module:"calendar",source:"eventEditForm"}})};const e=BX.SidePanel.Instance.getSlider(this.sliderId);if(e){this.BX.removeCustomEvent("SidePanel.Slider:onClose",this.sliderOnClose);e.close(true,t)}else{t()}}const s=this.BX.util.trim("<div></div>");t.getData().set("sliderContent",s);r.fulfill(s)}));return r}initControls(t){this.DOM.title=this.DOM.content.querySelector(`#${t}_title`);this.DOM.formWrap=this.DOM.content.querySelector(`#${t}_form_wrap`);this.DOM.form=this.DOM.content.querySelector(`#${t}_form`);this.DOM.buttonsWrap=this.DOM.content.querySelector(".calendar-form-buttons-fixed");this.DOM.saveBtn=this.DOM.buttonsWrap.querySelector(`#${t}_save`);this.DOM.closeBtn=this.DOM.buttonsWrap.querySelector(`#${t}_close`);e.Event.bind(this.DOM.saveBtn,"click",this.save.bind(this));e.Event.bind(this.DOM.closeBtn,"click",this.close.bind(this));this.initFormFieldManager(t);this.initDateTimeControl(t);this.initNameControl(t);this.initEditorControl(t);this.initAttendeesControl();if(this.plannerEnabled){this.initPlanner(t)}this.initReminderControl(t);if(this.sectionSelectorEnabled){this.initSectionSelector(t)}this.initLocationControl(t);this.initRepeatRuleControl(t);this.initColorControl(t);this.initCrmUfControl(t);this.initAdditionalControls(t);this.checkLastItemBorder();if(this.isOpenEvent){this.initCategoryControl()}if(this.DOM.buttonsWrap){BX.ZIndexManager.register(this.DOM.buttonsWrap)}}updateEntryData(t,i={}){if(this.entry instanceof n.Entry){const s=i.userSettings||{};if(e.Type.isPlainObject(t)){this.entry.prepareData(t)}else if(!this.entry.getTimezoneFrom()||this.entry.getTimezoneTo()){this.entry.setTimezone(s.timezoneName||s.timezoneDefaultName||null)}if(!this.entry.id&&i.meetSection&&this.type===n.Entry.CAL_TYPES.user){this.entry.setSectionId(i.meetSection)}}}handleSections(t,i){this.sections=t;this.sectionIndex={};this.trackingUsersList=i||[];if(e.Type.isArray(t)){t.forEach(((t,e)=>{this.sectionIndex[parseInt(t.ID)]=e}))}const s=this.getCurrentSection();if(this.entry.id){this.getSectionsForEditEvent(this.sections,s)}}handleLocationData(t,s,n){this.locationFeatureEnabled=Boolean(t);this.locationList=e.Type.isArray(s)?s.filter((t=>t.PERM.view_full)):[];this.iblockMeetingRoomList=n||[];i.Location.setLocationList(s);i.Location.setMeetingRoomList(n)}setUserSettings(t){this.userSettings=t;s.Util.setUserSettings(t)}setFormValues(){var t;const i=this.entry;this.dateTimeControl.setValue({from:this.formDataValue.from||i.from,to:this.formDataValue.to||i.to,fullDay:e.Type.isBoolean(this.formDataValue.fullDay)?this.formDataValue.fullDay:i.fullDay,timezoneFrom:i.getTimezoneFrom()||"",timezoneTo:i.getTimezoneTo()||"",timezoneName:this.userSettings.timezoneName});this.initialTimezoneFrom=i.getTimezoneFrom();this.initialTimezoneTo=i.getTimezoneTo();if(i.isSharingEvent()||!this.canEdit()){this.dateTimeControl.setReadonly(this.timezoneHint)}if(!this.canEdit()){e.Dom.attr(this.DOM.entryName,"readonly","readonly");e.Dom.style(this.DOM.entryName,"pointer-events","none")}const n=this.formDataValue.name||i.getName();this.DOM.entryName.value=n;this.DOM.entryName.title=n;e.Event.bind(this.DOM.entryName,"keyup",this.updateEventNameInputTitle.bind(this));e.Event.bind(this.DOM.entryName,"change",this.updateEventNameInputTitle.bind(this));const o=this.getCurrentSection();this.initialSectionId=this.getCurrentSectionId();if(this.sectionSelectorEnabled){if(this.formDataValue.section){i.sectionId=Number(this.formDataValue.section)}this.DOM.sectionInput.value=this.getCurrentSectionId();this.initialSectionId=this.getCurrentSectionId();this.sectionSelector.updateValue();if(!this.fieldIsPinned("section")&&(o.CAL_TYPE!==this.type||o.CAL_TYPE===this.type)&&parseInt(o.OWNER_ID,10)!==this.ownerId){this.pinField("section")}if((this.isSyncSection(o)||i.isSharingEvent())&&i.id||!this.canEdit()){this.sectionSelector.setViewMode(true)}}if(this.formDataValue.color){i.data.COLOR=this.formDataValue.color}this.colorSelector.setValue(i.getColor()||o.COLOR);this.remindersControl.setValue(this.formDataValue.reminder||i.getReminders(),true,false);(t=this.repeatSelector)==null?void 0:t.setValue(this.formDataValue.rrule||i.getRrule());this.initialRrule=this.getFormRrule();if(i.id&&i.isSharingEvent()||!this.canEdit()){var r;(r=this.repeatSelector)==null?void 0:r.setViewMode(i.getRRuleDescription())}if(i.hasRecurrenceId()){var a;(a=this.repeatSelector)==null?void 0:a.setViewMode(i.getRRuleDescription())}if(this.DOM.accessibilityInput){this.DOM.accessibilityInput.value=i.accessibility}if(this.locationSelector){this.locationSelector.setValue(this.formDataValue.location||this.locationSelector.default||i.getLocation(),false);this.locationSelector.checkLocationAccessibility({from:this.formDataValue.from||i.from,to:this.formDataValue.to||i.to,timezone:this.entry.getTimezoneFrom(),fullDay:e.Type.isBoolean(this.formDataValue.fullDay)?this.formDataValue.fullDay:i.fullDay,currentEventId:this.entry.id})}if(this.DOM.form.max_attendees){var l,d,h,c;const t=(l=i==null?void 0:(d=i.data)==null?void 0:(h=d.OPTIONS)==null?void 0:h.OPTIONS)!=null?l:null;this.DOM.form.max_attendees.value=((c=JSON.parse(t))==null?void 0:c.max_attendees)||""}if(this.DOM.privateEventCheckbox){this.DOM.privateEventCheckbox.checked=i.private}if(this.DOM.importantEventCheckbox){this.DOM.importantEventCheckbox.checked=i.important}if(this.DOM.form.meeting_notify){if(this.formDataValue.meetingNotify!==undefined){this.DOM.form.meeting_notify.checked=this.formDataValue.meetingNotify}if(this.entry.data&&this.entry.data.MEETING){this.DOM.form.meeting_notify.checked=this.entry.data.MEETING.NOTIFY}else{this.DOM.form.meeting_notify.checked=true}}if(this.DOM.form.hide_guests){if(this.formDataValue.hideGuests!==undefined){this.DOM.form.hide_guests.checked=this.formDataValue.hideGuests==="Y"}else if(this.entry.data&&this.entry.data.MEETING){this.DOM.form.hide_guests.checked=this.entry.data.MEETING.HIDE_GUESTS}else{this.DOM.form.hide_guests.checked=true}}if(this.DOM.form.allow_invite){if(this.entry.data){this.DOM.form.allow_invite.checked=this.entry.data.MEETING&&this.entry.data.MEETING.ALLOW_INVITE}else{this.DOM.form.allow_invite.checked=this.entry.allowInvite}}const u=this.dateTimeControl.getValue();if(this.plannerEnabled){this.planner.updateSelector(u.from,u.to,u.fullDay,{focus:true})}if(i.isSharingEvent()||!this.canEdit()){this.planner.setReadonly();this.planner.setSolid();this.planner.setShowWorkTimeNotice()}if(!this.canEdit()){const[t,i]=this.getPlaceholders();for(const s of this.getFieldsEditableOnlyByPermission()){e.Dom.style(t[s],"display","none");e.Dom.style(i[s],"display","none")}e.Dom.style(this.DOM.importantEventCheckbox,"display","none");e.Dom.style(this.DOM.importantEventCheckboxContainer,"display","none");e.Dom.style(this.DOM.moreSettings,"display","none");e.Dom.style(this.DOM.accessibilityInput,"display","none");const s=e.Tag.render(T||(T=p`
				<span class="calendar-field calendar-repeat-selector-readonly">
					${0}
				</span>
			`),this.DOM.accessibilityInput.options[this.DOM.accessibilityInput.selectedIndex].text);this.DOM.accessibilityInput.after(s)}if(this.plannerEnabled){this.loadPlannerData({entityList:this.getUserSelectorEntityList(),from:s.Util.formatDate(i.from.getTime()-s.Util.getDayLength()*3),to:s.Util.formatDate(i.to.getTime()+s.Util.getDayLength()*10),timezone:i.getTimezoneFrom(),location:this.locationSelector.getTextValue()})}}initCategoryControl(){this.DOM.categorySelectorWrap=this.DOM.content.querySelector(".calendar-category-selector-wrap");this.DOM.categorySelectorValueWarp=this.DOM.categorySelectorWrap.appendChild(e.Tag.render(v||(v=p`<div></div>`)));this.categoryTagSelector=new l.TagSelector({multiple:false,dialogOptions:{context:"calendar",preselectedItems:this.preSelectedCategory?[this.preSelectedCategory]:[],preload:true,zIndex:this.slider.zIndex,multiple:false,entities:[{id:"event-category",dynamicLoad:true,dynamicSearch:true}],events:{onLoad:()=>{this.categoryTagSelector.getDialog().getItems().forEach((t=>t.setDeselectable(false)));this.categoryTagSelector.getTags().forEach((t=>t.render()))}}}});this.categoryTagSelector.renderTo(this.DOM.categorySelectorWrap)}updateEventNameInputTitle(){if(this.isTitleOverflowing()){this.DOM.entryName.title=this.DOM.entryName.value}else{this.DOM.entryName.title=""}}isTitleOverflowing(){const t=this.DOM.entryName;return t.clientWidth<t.scrollWidth||t.clientHeight<t.scrollHeight}switchFullDay(t){t=Boolean(this.DOM.fullDay.checked);if(t&&e.Type.isString(this.userSettings.timezoneName)&&(!this.DOM.fromTz.value||!this.DOM.toTz.value)){this.DOM.fromTz.value=this.userSettings.timezoneName;this.DOM.toTz.value=this.userSettings.timezoneName;this.DOM.defTimezone.value=this.userSettings.timezoneName}if(t){e.Dom.addClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}else{e.Dom.removeClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}if(this.remindersControl){this.remindersControl.setFullDayMode(t)}this.refreshPlanner()}switchTimezone(){if(e.Dom.hasClass(this.DOM.tzCont,"calendar-options-timezone-collapse")){e.Dom.addClass(this.DOM.tzCont,"calendar-options-timezone-expand");e.Dom.removeClass(this.DOM.tzCont,"calendar-options-timezone-collapse")}else{e.Dom.addClass(this.DOM.tzCont,"calendar-options-timezone-collapse");e.Dom.removeClass(this.DOM.tzCont,"calendar-options-timezone-expand")}}initFormFieldManager(t){this.DOM.mainBlock=this.DOM.content.querySelector(`#${t}_main_block_wrap`);this.DOM.additionalBlockWrap=this.DOM.content.querySelector(`#${t}_additional_block_wrap`);this.DOM.additionalBlock=this.DOM.content.querySelector(`#${t}_additional_block`);this.DOM.pinnedNamesWrap=this.DOM.content.querySelector(`#${t}_additional_pinned_names`);this.DOM.additionalSwitch=this.DOM.content.querySelector(`#${t}_additional_switch`);if(this.isLocationCalendar&&!this.fieldIsPinned("location")){this.pinField("location")}e.Event.bind(this.DOM.additionalSwitch,"click",(()=>{e.Dom.toggleClass(this.DOM.additionalSwitch,"opened");e.Dom.toggleClass(this.DOM.additionalBlock,"invisible")}));e.Event.bind(this.DOM.formWrap,"click",(t=>{const e=t.target||t.srcElement;if(e&&e.getAttribute&&e.getAttribute("data-bx-fixfield")){const t=e.getAttribute("data-bx-fixfield");if(this.fieldIsPinned(t)){this.unPinField(t)}else{this.pinField(t)}}}));const i=document.querySelectorAll("[data-bx-field-id]");this.bindAdditionalFieldButtons(i)}initDateTimeControl(t){this.dateTimeControl=new m(t,{showTimezone:true,outerContent:this.DOM.content});this.dateTimeControl.subscribe("onChange",(t=>{if(t instanceof r.BaseEvent){const e=t.getData().value;this.entry.setTimezone(e.timezoneFrom);if(this.remindersControl){this.remindersControl.setFullDayMode(e.fullDay);if(!this.entry.id&&!this.remindersControl.wasChangedByUser()){const t=n.EntryManager.getNewEntryReminders(e.fullDay?"fullDay":"withTime");this.remindersControl.setValue(t,true,false)}}if(this.planner){this.planner.updateSelector(e.from,e.to,e.fullDay);this.planner.updateTimezone(e.timezoneFrom)}if(this.locationSelector){this.locationSelector.checkLocationAccessibility({from:e.from,to:e.to,timezone:this.entry.getTimezoneFrom(),fullDay:e.fullDay,currentEventId:this.entry.id})}}}))}initNameControl(t){this.DOM.entryName=this.DOM.content.querySelector(`#${t}_entry_name`);if(this.canEdit()){setTimeout((()=>{this.DOM.entryName.focus();this.DOM.entryName.select()}),500)}let i=false;e.Event.bind(this.DOM.entryName,"focusout",(()=>{if(this.DOM.entryName.scrollWidth>this.DOM.entryName.offsetWidth){this.getTitleFade(t).classList.add("--show")}else{this.getTitleFade(t).classList.remove("--show")}i=false}));e.Event.bind(this.DOM.entryName,"focus",(()=>{this.getTitleFade(t).classList.remove("--show");i=true}));e.Event.bind(this.DOM.entryName,"scroll",(()=>{if(this.DOM.entryName.scrollWidth>this.DOM.entryName.offsetWidth&&Math.ceil(this.DOM.entryName.offsetWidth+this.DOM.entryName.scrollLeft)<this.DOM.entryName.scrollWidth&&!i){this.getTitleFade(t).classList.add("--show")}else{this.getTitleFade(t).classList.remove("--show")}}))}getTitleFade(t){if(!this.DOM.entryNameFade){this.DOM.entryNameFade=this.DOM.content.querySelector(`#${t}_input_fade`)}return this.DOM.entryNameFade}initReminderControl(t){const s=this.DOM.content.querySelector(`#${t}_reminder`);if(!s){return}this.reminderValues=[];this.DOM.reminderWrap=s;this.DOM.reminderInputsWrap=this.DOM.reminderWrap.appendChild(e.Tag.render(I||(I=p`<span></span>`)));this.remindersControl=new i.Reminder({wrap:this.DOM.reminderWrap,zIndex:this.zIndex});this.remindersControl.subscribe("onChange",(t=>{if(t instanceof r.BaseEvent){this.reminderValues=t.getData().values;e.Dom.clean(this.DOM.reminderInputsWrap);this.reminderValues.forEach((t=>{this.DOM.reminderInputsWrap.appendChild(e.Tag.render(_||(_=p`
						<input value="${0}" name="reminder[]" type="hidden">
					`),t))}))}}))}initSectionSelector(t){this.DOM.sectionInput=this.DOM.content.querySelector(`#${t}_section`);this.sectionSelector=new i.SectionSelector({outerWrap:this.DOM.content.querySelector(`#${t}_section_wrap`),defaultCalendarType:this.type,defaultOwnerId:this.ownerId,sectionList:this.sections,sectionGroupList:o.SectionManager.getSectionGroupList({type:this.type||"user",ownerId:this.ownerId||this.userId,userId:this.userId,trackingUsersList:this.trackingUsersList}),mode:"full",zIndex:this.zIndex,getCurrentSection:()=>{const t=this.getCurrentSection();if(t){return{id:t.ID,name:t.NAME,color:t.COLOR}}return false},selectCallback:t=>{if(t){this.DOM.sectionInput.value=t.id;if(this.colorSelector){this.colorSelector.setValue(t.color)}this.entry.setSectionId(t.id);o.SectionManager.saveDefaultSectionId(t.id,{calendarType:this.type,ownerId:this.ownerId,userId:this.userId,sections:this.sections})}}})}initEditorControl(t){if(!window.BXHtmlEditor){return setTimeout(BX.delegate(this.initEditorControl,this),50)}this.editor=null;if(window.BXHtmlEditor){this.editor=window.BXHtmlEditor.Get(this.editorId)}if(!this.editor&&top.BXHtmlEditor&&top.BXHtmlEditor!==window.BXHtmlEditor){this.editor=top.BXHtmlEditor.Get(this.editorId)}if(this.editor&&this.editor.IsShown()){this.customizeHtmlEditor();if(this.formDataValue.description){this.editor.SetContent(this.formDataValue.description)}}else{this.BX.addCustomEvent(window.BXHtmlEditor,"OnEditorCreated",(t=>{if(t.id===this.editorId){this.editor=t;this.customizeHtmlEditor();if(this.formDataValue.description){this.editor.SetContent(this.formDataValue.description)}}}))}}customizeHtmlEditor(){const t=this.editor;if(t.toolbar&&t.toolbar.controls&&t.toolbar.controls.spoiler){e.Dom.remove(t.toolbar.controls.spoiler.pCont)}}initLocationControl(t){this.DOM.locationWrap=this.DOM.content.querySelector(`#${t}_location_wrap`);this.DOM.locationInput=this.DOM.content.querySelector(`#${t}_location`);this.locationSelector=new i.Location({inputName:"lo_cation",wrap:this.DOM.locationWrap,richLocationEnabled:this.locationFeatureEnabled,locationList:this.locationList||[],roomsManager:this.roomsManager||null,locationAccess:this.locationAccess||false,iblockMeetingRoomList:this.iblockMeetingRoomList,onChangeCallback:this.refreshPlanner})}initRepeatRuleControl(t){const e=this.DOM.content.querySelector(`#${t}_rrule_wrap`);if(!e){return}this.DOM.rruleWrap=e;this.repeatSelector=new i.RepeatSelector({wrap:this.DOM.rruleWrap,rruleType:this.DOM.content.querySelector(`#${t}_rrule_type`),getDate:function(){return this.dateTimeControl.getValue().from}.bind(this)});this.dateTimeControl.subscribe("onChange",(()=>{if(this.repeatSelector.getType()==="weekly"){this.repeatSelector.changeType(this.repeatSelector.getType())}}));if(this.plannerEnabled){this.planner.subscribe("onDateChange",(()=>{if(this.repeatSelector.getType()==="weekly"){this.repeatSelector.changeType(this.repeatSelector.getType())}}))}}initAttendeesControl(){if(this.attendeesControlEnabled){this.DOM.userSelectorWrap=this.DOM.content.querySelector(".calendar-attendees-selector-wrap");this.DOM.userSelectorValueWarp=this.DOM.userSelectorWrap.appendChild(e.Tag.render(b||(b=p`<div></div>`)));this.userTagSelector=new l.TagSelector({dialogOptions:{context:"CALENDAR",preselectedItems:this.attendeesPreselectedItems||[],zIndex:this.slider.zIndex,events:{"Item:onSelect":this.handleUserSelectorChanges.bind(this),"Item:onDeselect":this.handleUserSelectorChanges.bind(this)},entities:this.getParticipantsSelectorEntityList(),selectedItems:this.getSelectedItemsForTagSelector(),searchTabOptions:{stubOptions:{title:e.Loc.getMessage("EC_USER_DIALOG_404_TITLE"),subtitle:e.Loc.getMessage("EC_USER_DIALOG_404_SUBTITLE"),icon:"/bitrix/images/calendar/search-email.svg",iconOpacity:100,arrow:true}}}});this.userTagSelector.renderTo(this.DOM.userSelectorWrap)}if(this.plannerEnabled){this.DOM.hideGuestsWrap=this.DOM.content.querySelector(".calendar-hide-members-wrap")}}handleUserSelectorChanges(){if(this.planner){this.planner.show();this.planner.showLoader();const t=this.userTagSelector.getDialog().getSelectedItems();this.setUserSelectorEntityList(t.map((t=>({entityId:t.entityId,id:t.id,entityType:t.entityType}))));this.refreshPlanner()}}getSelectedItemsForTagSelector(){const t=[];const e=this.canEdit();this.getUserSelectorEntityList().forEach((i=>{if(i.entityType==="sharing"){t.push({id:i.id,entityId:i.entityId,entityType:"extranet",title:i.title,deselectable:false})}if(!e&&i.entityType==="email"){t.push({id:i.id,entityId:i.entityId,entityType:"email",title:i.title,deselectable:false})}}));return t}hasExternalEmailUsers(){return Boolean(this.getUserSelectorEntityList().find((t=>t.entityType==="email")))}showHideGuestsOption(){this.DOM.hideGuestsWrap.style.display="";s.Util.initHintNode(this.DOM.hideGuestsWrap.querySelector(".calendar-hide-members-helper"))}hideHideGuestsOption(){this.DOM.hideGuestsWrap.style.display="none"}setHideGuestsValue(t=true){this.hideGuests=t}initPlanner(t){this.DOM.plannerOuterWrap=this.DOM.content.querySelector(`#${t}_planner_outer_wrap`);this.planner=new a.Planner({wrap:this.DOM.plannerOuterWrap,minWidth:parseInt(this.DOM.plannerOuterWrap.offsetWidth),locked:!this.plannerFeatureEnabled,entryTimezone:this.entry.getTimezoneFrom()});this.planner.subscribe("onDateChange",this.handlePlannerSelectorChanges.bind(this));this.planner.subscribe("onExpandTimeline",this.handleExpandPlannerTimeline.bind(this));this.planner.subscribe("onDisplayAttendees",this.checkLocationForm.bind(this));this.planner.show();this.planner.showLoader()}loadPlannerData(t={}){this.planner.showLoader();return new Promise((i=>{this.BX.ajax.runAction("calendar.api.calendarajax.updatePlanner",{data:{entryId:this.entry.id||0,entryLocation:this.entry.data.LOCATION||"",ownerId:this.ownerId,hostId:this.entry.data.MEETING_HOST||null,type:this.type,entityList:!this.isOpenEvent&&t.entityList||[],dateFrom:s.Util.formatDate(this.planner.scaleDateFrom),dateTo:s.Util.formatDate(this.planner.scaleDateTo),timezone:t.timezone||"",location:t.location||"",prevUserList:this.prevUserList}}).then((t=>{if(this.planner){for(const e in t.data.accessibility){if(t.data.accessibility.hasOwnProperty(e)){this.loadedAccessibilityData[e]=t.data.accessibility[e]}}if(e.Type.isArray(t.data.entries)){t.data.entries.forEach((t=>{const e=this.loadedAccessibilityData[t.id];if(t.type==="user"&&!this.prevUserList.includes(parseInt(t.id))&&e){this.prevUserList.push(parseInt(t.id))}}))}this.planner.hideLoader();this.planner.update(t.data.entries,this.loadedAccessibilityData)}if(this.hasExternalEmailUsers()){this.showHideGuestsOption()}else{this.hideHideGuestsOption()}i(t)}),(t=>{i(t)}))}))}initAdditionalControls(t){this.DOM.accessibilityInput=this.DOM.content.querySelector(`#${t}_accessibility`);this.DOM.privateEventCheckbox=this.DOM.content.querySelector(`#${t}_private`);this.DOM.importantEventCheckbox=this.DOM.content.querySelector(`#${t}_important`);this.DOM.importantEventCheckboxContainer=this.DOM.importantEventCheckbox.closest(".calendar-info-panel-important");this.DOM.moreSettings=this.DOM.content.querySelector(`#${t}_more_outer_wrap`)}initColorControl(t){this.DOM.colorWrap=this.DOM.content.querySelector(`#${t}_color_selector_wrap`);this.colorSelector=new i.ColorSelector({wrap:this.DOM.colorWrap})}initCrmUfControl(t){const i=BX(`${t}-uf-crm-wrap`);if(!i){return}this.DOM.crmUfWrap=i;if(this.DOM.crmUfWrap){const t=this.getCurrentEntry();const i=this.DOM.crmUfWrap.appendChild(e.Dom.adjust(s.Util.getLoader(50),{style:{height:"40px",width:"40px"}}));this.DOM.saveBtn.disabled=true;setTimeout((()=>{this.BX.ajax.runAction("calendar.api.calendarajax.getCrmUserfield",{data:{event_id:t&&t.id?t.id:0}}).then((t=>{if(e.Type.isDomNode(this.DOM.crmUfWrap)){this.BX.html(this.DOM.crmUfWrap,t.data.html);this.DOM.saveBtn.disabled=false}}),(t=>{e.Dom.remove(i);this.DOM.saveBtn.disabled=false}))}),800)}}denySliderClose(){this.denyClose=true}allowSliderClose(){this.denyClose=false}checkDenyClose(){if(this.state===this.STATE.REQUEST){return true}if(!e.Type.isNull(this.mouseUpNodeCheck)){return!this.mouseUpNodeCheck}return this.denyClose}needToShowConfirmPopup(){return this.doShowConfirmPopup&&this.formDataChanged()}setCurrentEntry(t=null,e=null){this.entry=n.EntryManager.getEntryInstance(t,e,{type:this.type,ownerId:this.ownerId});n.EntryManager.registerEntrySlider(this.entry,this)}getCurrentEntry(){return this.entry}getCurrentSection(){let t=false;const e=this.getCurrentSectionId();if(e&&this.sectionIndex[e]!==undefined&&this.sections[this.sectionIndex[e]]!==undefined){t=this.sections[this.sectionIndex[e]]}return t}getCurrentSectionId(){let t=0;const e=this.getCurrentEntry();if(e instanceof n.Entry&&this.sections[this.sectionIndex[e.sectionId]]){t=parseInt(e.sectionId)}if(!t){if(this.type==="location"){t=d.RoomsManager.getNewEntrySectionId()}else{t=o.SectionManager.getNewEntrySectionId(this.type,this.ownerId)}if(!this.sectionIndex[t]){t=null}}if(!t&&this.sections[0]){t=parseInt(this.sections[0].ID)}return t}pinField(t){const[i,s]=this.getPlaceholders();const n=s[t];const o=i[t];const r=n.offsetHeight;n.style.height=`${r}px`;setTimeout((()=>{e.Dom.addClass(n,"calendar-hide-field")}),0);o.style.height="0";if(t==="description"){setTimeout((()=>{if(!this.DOM.descriptionAdditionalWrap){this.DOM.descriptionAdditionalWrap=this.DOM.additionalBlock.querySelector(".calendar-info-panel-description")}if(this.DOM.descriptionAdditionalWrap){while(this.DOM.descriptionAdditionalWrap.firstChild){o.appendChild(this.DOM.descriptionAdditionalWrap.firstChild)}}o.style.height=`${r}px`}),200);setTimeout((()=>{e.Dom.removeClass(n,"calendar-hide-field");n.style.display="none";o.style.height="";this.pinnedFieldsIndex[t]=true;const i=window.BXHtmlEditor.Get(this.editorId);if(i){i.CheckAndReInit()}this.saveSettings();this.updateAdditionalBlockState()}),500)}else{setTimeout((()=>{while(n.firstChild){o.appendChild(n.firstChild)}o.style.height=`${r}px`}),200);setTimeout((()=>{e.Dom.removeClass(n,"calendar-hide-field");n.style.height="";o.style.height="";this.pinnedFieldsIndex[t]=true;this.saveSettings();this.updateAdditionalBlockState()}),300)}}unPinField(t){const[i,s]=this.getPlaceholders();const n=i[t];const o=s[t];const r=n.offsetHeight;n.style.height=`${r}px`;setTimeout((()=>{e.Dom.addClass(n,"calendar-hide-field")}),0);o.style.height="0";if(t==="description"){setTimeout((()=>{if(!this.DOM.descriptionAdditionalWrap){this.DOM.descriptionAdditionalWrap=this.DOM.additionalBlock.querySelector(".calendar-info-panel-description")}if(this.DOM.descriptionAdditionalWrap){while(n.firstChild){this.DOM.descriptionAdditionalWrap.appendChild(n.firstChild)}}o.style.display="";o.style.height=`${r}px`}),200);setTimeout((()=>{e.Dom.removeClass(n,"calendar-hide-field");n.style.height="";o.style.height="";this.pinnedFieldsIndex[t]=false;const i=window.BXHtmlEditor.Get(this.editorId);if(i){i.CheckAndReInit()}this.saveSettings();this.updateAdditionalBlockState()}),300)}else{setTimeout((()=>{while(n.firstChild){o.appendChild(n.firstChild)}o.style.height=`${r}px`}),200);setTimeout((()=>{e.Dom.removeClass(n,"calendar-hide-field");n.style.height="";o.style.height="";this.pinnedFieldsIndex[t]=false;this.saveSettings();this.updateAdditionalBlockState()}),300)}}fieldIsPinned(t){return this.pinnedFieldsIndex[t]}getPlaceholders(){if(!this.placeHolders){this.placeHolders={};this.placeHoldersAdditional={};let t;let e;let i=this.DOM.formWrap.querySelectorAll(".calendar-field-additional-placeholder");for(t=0;t<i.length;t++){e=i[t].getAttribute("data-bx-block-placeholer");if(e){this.placeHoldersAdditional[e]=i[t]}}i=this.DOM.formWrap.querySelectorAll(".calendar-field-placeholder");for(t=0;t<i.length;t++){e=i[t].getAttribute("data-bx-block-placeholer");if(e){this.placeHolders[e]=i[t]}}}return[this.placeHolders,this.placeHoldersAdditional]}getSettings(t){this.pinnedFieldsIndex={};let e;const i=[];for(e in t.pinnedFields){if(t.pinnedFields.hasOwnProperty(e)){i.push(t.pinnedFields[e]);this.pinnedFieldsIndex[t.pinnedFields[e]]=true}}t.pinnedFields=i;return t}saveSettings(){let t;const e=[];for(t in this.pinnedFieldsIndex){if(this.pinnedFieldsIndex.hasOwnProperty(t)&&this.pinnedFieldsIndex[t]){e.push(t)}}this.formSettings.pinnedFields=e;this.BX.userOptions.save("calendar",this.formType,"pinnedFields",e)}updateAdditionalBlockState(t){if(t===false){e.Dom.clean(this.DOM.pinnedNamesWrap);const t=[...this.DOM.additionalBlock.querySelectorAll(".calendar-field-additional-placeholder[data-bx-block-placeholer]")].filter((t=>t.innerText!==""&&t.style.display!=="none"));const i=t.map((t=>e.Dom.create("SPAN",{attrs:{"data-bx-field-id":t.getAttribute("data-bx-block-placeholer")},props:{className:"calendar-additional-alt-promo-text"},html:t.querySelector(".js-calendar-field-name").innerText})));this.DOM.pinnedNamesWrap.append(...i);this.bindAdditionalFieldButtons(i);if(i.length===0){e.Dom.addClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}else if(e.Dom.hasClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")){e.Dom.removeClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}this.checkLastItemBorder()}else{if(this.updateAdditionalBlockTimeout){clearTimeout(this.updateAdditionalBlockTimeout);this.updateAdditionalBlockTimeout=null}this.updateAdditionalBlockTimeout=setTimeout((()=>{this.updateAdditionalBlockState(false)}),300)}}bindAdditionalFieldButtons(t){for(const i of t){const t=i.getAttribute("data-bx-field-id");if(!this.canEdit()&&this.getFieldsEditableOnlyByPermission().includes(t)){i.remove();continue}e.Event.bind(i,"click",(e=>{const i=document.querySelector(`.calendar-openable-block [data-bx-block-placeholer=${t}]`);this.highlightField(i);if(this.isAdditionalBlockOpened()){e.stopPropagation()}}))}}getFieldsEditableOnlyByPermission(){return["description","private","crm"]}highlightField(t){e.Dom.addClass(t,"calendar-field-highlighted");const i=this.DOM.content.scrollTop+t.getBoundingClientRect().top;this.highlightFieldScrollAnimation=new BX.easing({duration:400,start:{scroll:this.DOM.content.scrollTop},finish:{scroll:i},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:t=>{this.DOM.content.scrollTop=t.scroll},complete:()=>{}});this.highlightFieldScrollAnimation.animate();clearTimeout(t.highlightTimeout);t.highlightTimeout=setTimeout((()=>BX.Dom.removeClass(t,"calendar-field-highlighted")),2500)}isAdditionalBlockOpened(){return e.Dom.hasClass(this.DOM.additionalSwitch,"opened")}checkLastItemBorder(){const t="no-border";let i;let s;s=this.DOM.mainBlock.querySelectorAll(".calendar-options-item-border");for(i=0;i<s.length;i++){if(i===s.length-1){e.Dom.addClass(s[i],t)}else{e.Dom.removeClass(s[i],t)}}s=this.DOM.additionalBlock.querySelectorAll(".calendar-options-item-border");for(i=0;i<s.length;i++){if(i===s.length-1){e.Dom.addClass(s[i],t)}else{e.Dom.removeClass(s[i],t)}}}handlePlannerSelectorChanges(t){if(t instanceof r.BaseEvent){const e=t.getData();this.dateTimeControl.setValue({from:e.dateFrom,to:e.dateTo});if(this.locationSelector){this.locationSelector.checkLocationAccessibility({from:e.dateFrom,to:e.dateTo,timezone:this.entry.getTimezoneFrom(),fullDay:e.fullDay,currentEventId:this.entry.id})}if(this.planner){const t=parseInt(e.dateFrom.getHours())+Math.floor(e.dateFrom.getMinutes()/60);const i=parseInt(e.dateTo.getHours())+Math.floor(e.dateTo.getMinutes()/60);if(t!==0&&t<=this.planner.shownScaleTimeFrom||i!==0&&i!==23&&i+1>=this.planner.shownScaleTimeTo){this.planner.updateSelector(e.dateFrom,e.dateTo,e.fullDay)}}}}handleExpandPlannerTimeline(t){if(t instanceof r.BaseEvent){const e=t.getData();if(e.reload){this.prevUserList=[];const t=this.dateTimeControl.getValue();this.loadPlannerData({entityList:this.getUserSelectorEntityList(),from:s.Util.formatDate(e.dateFrom),to:s.Util.formatDate(e.dateTo),timezone:t.timezoneFrom,location:this.locationSelector.getTextValue(),focusSelector:false})}}}getUserSelectorEntityList(){return this.selectorEntityList}setUserSelectorEntityList(t){this.selectorEntityList=t}refreshPlannerState(){const t=this.dateTimeControl.getValue();this.loadPlannerData({entityList:this.isOpenEvent?[]:this.getUserSelectorEntityList(),from:s.Util.formatDate(t.from.getTime()-s.Util.getDayLength()*3),to:s.Util.formatDate(t.to.getTime()+s.Util.getDayLength()*10),timezone:t.timezoneFrom,location:this.locationSelector.getTextValue()})}checkLocationForm(t){if(t&&t instanceof r.BaseEvent){const e=t.getData();const s=e.usersCount;if(this.locationCapacity!==0){i.Location.setCurrentCapacity(this.locationCapacity);this.locationCapacity=0}let n=i.Location.getCurrentCapacity()||0;if(this.locationSelector.value.type===undefined&&n){n=0;i.Location.setCurrentCapacity(0)}if(n<s&&n!==0){this.locationSelector.addCapacityAlert()}else{this.locationSelector.removeCapacityAlert()}}}plannerIsShown(){return this.DOM.plannerWrap&&e.Dom.hasClass(this.DOM.plannerWrap,"calendar-edit-planner-wrap-shown")}keyHandler(t){if((t.ctrlKey||t.metaKey)&&!t.altKey&&t.keyCode===s.Util.getKeyCode("enter")&&this.checkTopSlider()&&!this.isAdditionalPopupShown()){if(this.busyUsersDialog&&this.busyUsersDialog.isShown()){return}this.save()}}isAdditionalPopupShown(){var t,e;return(t=this.DOM.locationRepeatBusyErrorPopup)==null?void 0:(e=t.getPopupWindow())==null?void 0:e.isShown()}checkTopSlider(){const t=s.Util.getBX().SidePanel.Instance.getTopSlider();return t&&t.options.type==="calendar:slider"}showError(t){let i="";if(e.Type.isArray(t)){t.forEach((t=>{if(t.code==="edit_entry_location_busy"||t.code==="edit_entry_location_busy_recurrence"){this.locationBusyAlert=s.Util.showFieldError(t.message,this.DOM.locationWrap,{clearTimeout:1e4});return}if(t.code==="edit_entry_location_repeat_busy"){this.showLocationRepeatBusyErrorPopup(t.message);return}i+=`${t.message}\n`}))}if(i!==""){alert(i)}}showLocationRepeatBusyErrorPopup(t){if(!this.DOM.locationRepeatBusyErrorPopup){this.DOM.locationRepeatBusyErrorPopup=n.EntryManager.getLocationRepeatBusyErrorPopup({message:t,onYesCallback:()=>{if(e.Type.isDomNode(this.locationBusyAlert)){e.Dom.remove(this.locationBusyAlert);this.locationBusyAlert=null}this.lastUsedSaveOptions.doCheckOccupancy="N";this.DOM.locationRepeatBusyErrorPopup.close();this.save(this.lastUsedSaveOptions);this.lastUsedSaveOptions={}},onCancelCallback:()=>{this.lastUsedSaveOptions={};this.DOM.locationRepeatBusyErrorPopup.close()},onPopupCloseCallback:()=>{delete this.DOM.locationRepeatBusyErrorPopup}});this.DOM.locationRepeatBusyErrorPopup.show()}}getFormDataChanges(t=[]){var s,n,o,r,a,l,d;if(!this.DOM.form){return[]}const h=this.entry;const c=[];if(!t.includes("name")&&h.name!==this.DOM.form.name.value){c.push("name")}if(!t.includes("description")&&h.getDescription()!==this.DOM.form.desc.value){c.push("description")}if(!t.includes("location")&&this.locationSelector.getTextLocation(i.Location.parseStringValue(this.entry.getLocation()))!==this.locationSelector.getTextLocation(i.Location.parseStringValue(this.locationSelector.getTextValue()))){c.push("location")}const u=this.dateTimeControl.getValue();if(!t.includes("date&time")&&(h.isFullDay()!==u.fullDay||u.from.toString()!==h.from.toString()||u.to.toString()!==h.to.toString())){c.push("date&time")}if(this.sectionSelectorEnabled&&!t.includes("section")&&Number(this.initialSectionId)!==Number(this.DOM.sectionInput.value)){c.push("section")}if(this.attendeesControlEnabled&&!t.includes("codes")&&this.getUserSelectorEntityList().map((t=>t.entityId+":"+t.id)).join("|")!==h.getAttendeesEntityList().map((t=>t.entityId+":"+t.id)).join("|")){c.push("codes")}if(!t.includes("color")){const t=(h.data.COLOR||this.getCurrentSection().COLOR).toLowerCase();if(t!==this.colorSelector.getValue().toLowerCase()){c.push("color")}}if(!t.includes("reminder")){const t=h.getReminders();if(e.Type.isArrayFilled(t)&&t.length!==this.reminderValues.length){c.push("reminder")}}if(this.wasRruleChanged()){c.push("rrule")}if(this.DOM.privateEventCheckbox&&this.DOM.privateEventCheckbox.checked!==h.isPrivate()){c.push("private")}if(this.DOM.importantEventCheckbox&&this.DOM.importantEventCheckbox.checked!==h.important){c.push("important")}if(this.DOM.form.tz_from.value!==this.initialTimezoneFrom){c.push("tz_from")}if(this.DOM.form.tz_to.value!==this.initialTimezoneTo){c.push("tz_to")}const m=h.data.UF_CRM_CAL_EVENT||[];const p=new FormData(this.DOM.form).getAll("UF_CRM_CAL_EVENT[]");if(JSON.stringify(m.sort())!==JSON.stringify(p.sort())){c.push("uf_crm")}if(this.DOM.form.meeting_notify&&h.data.MEETING&&this.DOM.form.meeting_notify.checked!==h.data.MEETING.NOTIFY){c.push("meeting_notify")}if(this.DOM.accessibilityInput&&this.DOM.accessibilityInput.value!==h.accessibility){c.push("accessibility")}const f=parseInt((s=this.DOM.form)==null?void 0:(n=s.max_attendees)==null?void 0:n.value,10)||0;const y=(o=h==null?void 0:(r=h.data)==null?void 0:(a=r.OPTIONS)==null?void 0:a.OPTIONS)!=null?o:null;const D=(l=(d=JSON.parse(y))==null?void 0:d.max_attendees)!=null?l:0;if(f!==D){c.push("max_attendees")}const g=this.entry.data.UF_WEBDAV_CAL_EVENT||[];const E=new FormData(this.DOM.form).getAll("UF_WEBDAV_CAL_EVENT[]").filter(Boolean);if(JSON.stringify(g.sort())!==JSON.stringify(E.sort())){c.push("UF_WEBDAV_CAL_EVENT[]")}return c}wasRruleChanged(){return JSON.stringify(this.getFormRrule())!==JSON.stringify(this.initialRrule)&&!this.entry.hasRecurrenceId()}getFormRrule(){var t;const e=new FormData(this.DOM.form);const i=e.get("rrule_endson");const s=(t=e.get("EVENT_RRULE[FREQ]"))!=null?t:"NONE";let n=parseInt(e.get("EVENT_RRULE[INTERVAL]"),10)||null;let o=null;let r=null;let a=null;if(i==="count"){const t=10;o=parseInt(e.get("EVENT_RRULE[COUNT]"),10)||t}if(i==="until"){r=e.get("EVENT_RRULE[UNTIL]")}if(s==="NONE"){n=o=r=null}if(s==="WEEKLY"){a=e.getAll("EVENT_RRULE[BYDAY][]")}return{FREQ:s,INTERVAL:n,COUNT:o,UNTIL:r,BYDAY:a}}checkCurrentUsersAccessibility(){return this.getFormDataChanges().includes("date&time")}formDataChanged(){return this.getFormDataChanges().length>0}getUserCodes(){const t=[];const e=this.DOM.attendeesWrap.querySelectorAll('input[name="EVENT_DESTINATION[]"]');for(const i of e){if(!t.includes(i.value)){t.push(i.value)}}return t}handlePull(t){var i,s,n,o;if(!t instanceof r.BaseEvent){return}const a=t.getData();const l=a[0];const d=e.Type.isObjectLike(a[1])?a[1]:{};switch(l){case"edit_event":case"delete_event":case"set_meeting_status":const t=e.Type.isArray(d==null?void 0:(i=d.fields)==null?void 0:i.ATTENDEES)?d.fields.ATTENDEES:[];const r=(d==null?void 0:(s=d.fields)==null?void 0:s.CAL_TYPE)==="user"?parseInt(d==null?void 0:(n=d.fields)==null?void 0:n.OWNER_ID):parseInt(d==null?void 0:(o=d.fields)==null?void 0:o.CREATED_BY);if(!t.includes(r)){t.push(r)}this.clearAccessibilityData(t);this.refreshPlannerState();break}}clearAccessibilityData(t){if(e.Type.isArray(t)&&t.length>0&&this.prevUserList.length>0){this.prevUserList=this.prevUserList.filter((e=>!t.includes(e)))}}getParticipantsSelectorEntityList(){if(this.participantsSelectorEntityList&&this.participantsSelectorEntityList.length>0){return this.participantsSelectorEntityList}let t=[{id:"user",options:{inviteEmployeeLink:this.canEdit(),inviteGuestLink:this.canEdit(),emailUsers:s.Util.isEventWithEmailGuestAllowed()&&this.canEdit(),analyticsSource:"calendar",lockGuestLink:!s.Util.isEventWithEmailGuestAllowed(),lockGuestLinkFeatureId:"calendar_events_with_email_guests"},filters:[{id:"calendar.attendeeFilter",options:{isSharingEvent:this.entry.isSharingEvent(),eventId:this.entry.id}}]},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}];if(this.isProjectFeatureEnabled){t.push({id:"project"})}if(this.attendeesPreselectedItems){let e=null;this.attendeesPreselectedItems.forEach((t=>{const i=t[0];const s=t[1];if(i==="project-roles"){e=s}}));if(e){t=[{id:"user"},{id:"project-roles",options:{projectId:e.split("_")[0]},dynamicLoad:true}]}}return t}isSyncSection(t){return t.EXTERNAL_TYPE==="icloud"||t.EXTERNAL_TYPE==="google"||t.EXTERNAL_TYPE==="office365"||t.connectionLinks&&t.connectionLinks.length>0}getSectionsForEditEvent(t,i){const s=[];const n=i.CAL_TYPE;s.push(i);t.forEach((t=>{if(!this.isSyncSection(t)&&t.CAL_TYPE===n){s.push(t)}}));this.sections=s;this.sectionIndex=[];if(e.Type.isArray(this.sections)){this.sections.forEach(((t,e)=>{this.sectionIndex[parseInt(t.ID)]=e}))}}unsetHiddenSection(t,e){const i=parseInt(t.ID);if(!e.sectionIsShown(i)){let t=e.getHiddenSections();t=t.filter((t=>t!==i));e.setHiddenSections(t);e.saveHiddenSections()}}isCreateForm(){return!this.isEditForm()}isEditForm(){return parseInt(this.entry.id)>0}}t.EventEditForm=L})(this.BX.Calendar=this.BX.Calendar||{},BX,BX.Calendar.Controls,BX.Calendar,BX.Calendar,BX.Calendar,BX.Event,BX.Calendar,BX.UI.EntitySelector,BX.Calendar);
//# sourceMappingURL=eventeditform.bundle.map.js