this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};(function(e,t,n,i,s,r){"use strict";function o(e,t){if(!n.Type.isArray(e)){throw new TypeError("array is not a array")}if(!n.Type.isInteger(t)){throw new TypeError("index is not a integer")}const i=t<0?e.length+t:t;return e[i]}class c extends r.BBCodeScheme{getTagScheme(e){return new r.BBCodeTagScheme({name:"any"})}isAllowedTag(e){return true}isChildAllowed(e,t){return true}}const l=/\[(\/)?(\w+|\*).*?]/;const a=/\[(\/)?(\w+|\*)(.*?)]/gs;const d=e=>["\n","\t"].includes(e);const h=e=>["list","ul","ol"].includes(String(e).toLowerCase());const u=e=>["*","li"].includes(String(e).toLowerCase());const f=new c;class g{constructor(e={}){this.allowedLinkify=true;if(e.scheme){this.setScheme(e.scheme)}else{this.setScheme(new r.DefaultBBCodeScheme)}if(n.Type.isFunction(e.onUnknown)){this.setOnUnknown(e.onUnknown)}else{this.setOnUnknown(g.defaultOnUnknownHandler)}if(e.encoder instanceof i.BBCodeEncoder){this.setEncoder(e.encoder)}else{this.setEncoder(new i.BBCodeEncoder)}if(n.Type.isBoolean(e.linkify)){this.setIsAllowedLinkify(e.linkify)}}setScheme(e){this.scheme=e}getScheme(){return this.scheme}setOnUnknown(e){if(!n.Type.isFunction(e)){throw new TypeError("handler is not a function")}this.onUnknownHandler=e}getOnUnknownHandler(){return this.onUnknownHandler}setEncoder(e){if(e instanceof i.BBCodeEncoder){this.encoder=e}else{throw new TypeError("encoder is not BBCodeEncoder instance")}}getEncoder(){return this.encoder}setIsAllowedLinkify(e){this.allowedLinkify=Boolean(e)}isAllowedLinkify(){return this.allowedLinkify}canBeLinkified(e){if(e.getName()==="#text"){const n=["url","img","video","code"];const i=n.some((n=>Boolean(t.AstProcessor.findParentNodeByName(e,n))));return!i}return false}static defaultOnUnknownHandler(e,t){if(e.getType()===r.BBCodeNode.ELEMENT_NODE){const n=e.getName();if(["left","center","right","justify"].includes(n)){const n=t.createElement({name:"p"});e.replace(n);n.setChildren(e.getChildren())}else if(["background","color","size"].includes(n)){const n=t.createElement({name:"b"});e.replace(n);n.setChildren(e.getChildren())}else if(["span","font"].includes(n)){const n=t.createFragment({children:e.getChildren()});e.replace(n)}else{const n=e.getOpeningTag();const i=e.getClosingTag();e.replace(t.createText(n),...e.getChildren(),t.createText(i))}}}static toLowerCase(e){if(n.Type.isStringFilled(e)){return e.toLowerCase()}return e}parseText(e){if(n.Type.isStringFilled(e)){return[...e].reduce(((e,t)=>{if(d(t)){e.push(t)}else{const i=o(e,-1);if(d(i)||n.Type.isNil(i)){e.push(t)}else{e[e.length-1]+=t}}return e}),[]).map((e=>{if(e==="\n"){return f.createNewLine()}if(e==="\t"){return f.createTab()}return f.createText({content:this.getEncoder().decodeText(e)})}))}return[]}static findNextTagIndex(e,t=0){const n=e.slice(t);const i=n.match(new RegExp(l));if(i){return i.index+t}return-1}static findNextTag(e,t=0){const n=e.slice(t);const i=n.match(new RegExp(l));if(i){const[,e,t]=i;return{tagName:t,isClosedTag:e==="\\"}}return null}static trimQuotes(e){const t=String(e);if(/^["'].*["']$/g.test(t)){return t.slice(1,-1)}return e}parseAttributes(e){const t={value:"",attributes:[]};if(n.Type.isStringFilled(e)){if(e.startsWith("=")){t.value=this.getEncoder().decodeAttribute(g.trimQuotes(e.slice(1)));return t}return e.trim().split(" ").filter(Boolean).reduce(((e,t)=>{const[n,i=""]=t.split("=");e.attributes.push([g.toLowerCase(n),this.getEncoder().decodeAttribute(g.trimQuotes(i))]);return e}),t)}return t}parse(e){const t=f.createRoot();const i=g.findNextTagIndex(e);if(i!==0){const n=i===-1?e:e.slice(0,i);t.appendChild(...this.parseText(n))}const c=[t];const l=[];let d=null;let p=0;e.replace(a,((t,i,s,r,o)=>{const a=Boolean(i)===false;const m=t.length+o;const B=e.slice(m);const T=this.parseAttributes(r);const w=g.toLowerCase(s);let C=c[p];if(a){const n=!B.includes(`[/${s}]`);if(n&&!u(w)){const n=this.getScheme().getTagScheme(w);const i=n&&n.isVoid();if(i){d=f.createElement({name:w,value:T.value,attributes:Object.fromEntries(T.attributes)});d.setScheme(this.getScheme());C.appendChild(d)}else{C.appendChild(f.createText(t))}const s=g.findNextTagIndex(e,m);if(s!==0){const t=s===-1?B:e.slice(m,s);C.appendChild(...this.parseText(t))}}else{if(u(w)&&d&&u(d.getName())){p--;C=c[p]}d=f.createElement({name:w,value:T.value,attributes:Object.fromEntries(T.attributes)});const t=g.findNextTagIndex(e,m);if(t!==0){const n=t===-1?B:e.slice(m,t);d.appendChild(...this.parseText(n))}if(!C){p++;C=c[p]}C.appendChild(d);p++;c[p]=d;l.push(w)}}else{if(l.includes(w)){p--;const e=l.indexOf(w);l.splice(e,1)}else{c[p].appendChild(f.createText(t))}if(h(w)&&p>0){p--}const i=g.findNextTagIndex(e,m);if(i!==0&&c[p]){const t=i===-1?B:e.slice(m,i);c[p].appendChild(...this.parseText(t))}if(p>0&&u(c[p].getName())){const t=g.findNextTag(e,m);if(n.Type.isNull(t)||u(t.tagName)){p--}}}}));const m=e=>{let t=false;return e.getChildren().reduceRight(((e,n,i)=>{if(!t&&n.getName()==="#linebreak"){e.push(i)}else if(!t&&n.getName()!=="#tab"){t=true}return e}),[])};r.BBCodeNode.flattenAst(t).forEach((e=>{if(e.getName()==="*"){const t=m(e);if(t.length===1){e.setChildren(e.getChildren().slice(0,o(t,0)))}if(t.length>1&&(t&2)===0){e.setChildren(e.getChildren().slice(0,o(t,0)))}}if(this.isAllowedLinkify()&&this.canBeLinkified(e)){const t=e.toString({encode:false});const n=s.Linkify.tokenize(t);const i=n.map((e=>{if(e.t==="url"){return f.createElement({name:"url",value:e.toHref().replace(/^http:\/\//,"https://"),children:[f.createText(e.toString())]})}if(e.t==="email"){return f.createElement({name:"url",value:e.toHref(),children:[f.createText(e.toString())]})}return f.createText(e.toString())}));e.replace(...i)}}));t.setScheme(this.getScheme(),this.getOnUnknownHandler());return t}}e.BBCodeParser=g})(this.BX.UI.BBCode=this.BX.UI.BBCode||{},BX.UI.BBCode,BX,BX.UI.BBCode,BX.UI,BX.UI.BBCode);
//# sourceMappingURL=parser.bundle.map.js