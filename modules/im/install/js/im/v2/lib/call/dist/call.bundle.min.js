this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,l,r,i,o,n,c,d,b,u,v,p){"use strict";class h{static createRoom(e){c.runAction(d.RestMethod.imCallBetaCreateRoom,{data:{chatId:e}})}}let g=e=>e,C;const L=e=>{const s=()=>{const s=a.getSelectedItems();const t=P(s);e.onSelect({users:t})};const t=()=>{a.hide()};const a=new u.Dialog({targetNode:e.bindElement,width:400,enableSearch:true,dropdownMode:true,context:"IM_CHAT_SEARCH",entities:[{id:"user",dynamicLoad:true,itemOptions:{default:{linkTitle:"",link:""}},options:{inviteEmployeeLink:false,"!userId":p.Core.getUserId()},filters:[{id:"im.userDataFilter"}]}],footer:B(s,t)});a.show();return Promise.resolve({close:()=>{a.hide()}})};const P=e=>e.map((e=>({id:e.id,name:e.title.text,avatar:e.avatar,avatar_hr:e.avatar,gender:e.customData.get("imUser").GENDER})));const B=(e,s)=>{const t=b.Loc.getMessage("IM_LIB_CALL_ADD_BUTTON");const a=b.Loc.getMessage("IM_LIB_CALL_CANCEL_BUTTON");return b.Tag.render(C||(C=g`
		<button class="ui-btn ui-btn-xs ui-btn-primary" onclick="${0}">${0}</button>
		<button class="ui-btn ui-btn-xs ui-btn-light-border" onclick="${0}">${0}</button>
	`),e,t,s,a)};var f=babelHelpers.classPrivateFieldLooseKey("controller");var F=babelHelpers.classPrivateFieldLooseKey("store");var H=babelHelpers.classPrivateFieldLooseKey("getController");var y=babelHelpers.classPrivateFieldLooseKey("subscribeToEvents");var I=babelHelpers.classPrivateFieldLooseKey("onCallCreated");var M=babelHelpers.classPrivateFieldLooseKey("onCallJoin");var S=babelHelpers.classPrivateFieldLooseKey("onCallLeave");var m=babelHelpers.classPrivateFieldLooseKey("onCallDestroy");var E=babelHelpers.classPrivateFieldLooseKey("onOpenChat");var X=babelHelpers.classPrivateFieldLooseKey("checkCallSupport");var O=babelHelpers.classPrivateFieldLooseKey("checkUserCallSupport");var A=babelHelpers.classPrivateFieldLooseKey("checkChatCallSupport");var D=babelHelpers.classPrivateFieldLooseKey("pushServerIsActive");var j=babelHelpers.classPrivateFieldLooseKey("getCurrentDialogId");var w=babelHelpers.classPrivateFieldLooseKey("isUser");var K=babelHelpers.classPrivateFieldLooseKey("prepareUserCall");class T{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}static init(){T.getInstance()}constructor(){Object.defineProperty(this,K,{value:z});Object.defineProperty(this,w,{value:G});Object.defineProperty(this,j,{value:Z});Object.defineProperty(this,D,{value:W});Object.defineProperty(this,A,{value:J});Object.defineProperty(this,O,{value:q});Object.defineProperty(this,X,{value:$});Object.defineProperty(this,E,{value:V});Object.defineProperty(this,m,{value:x});Object.defineProperty(this,S,{value:N});Object.defineProperty(this,M,{value:k});Object.defineProperty(this,I,{value:_});Object.defineProperty(this,y,{value:R});Object.defineProperty(this,H,{value:U});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,F)[F]=p.Core.getStore();babelHelpers.classPrivateFieldLooseBase(this,f)[f]=babelHelpers.classPrivateFieldLooseBase(this,H)[H]();babelHelpers.classPrivateFieldLooseBase(this,y)[y]()}createBetaCallRoom(e){h.createRoom(e)}startCall(e,s=true){i.Logger.warn("CallManager: startCall",e,s);if(babelHelpers.classPrivateFieldLooseBase(this,w)[w](e)){babelHelpers.classPrivateFieldLooseBase(this,K)[K](e)}babelHelpers.classPrivateFieldLooseBase(this,f)[f].startCall(e,s)}joinCall(e,s=true){i.Logger.warn("CallManager: joinCall",e,s);babelHelpers.classPrivateFieldLooseBase(this,f)[f].joinCall(e,s)}leaveCurrentCall(){i.Logger.warn("CallManager: leaveCurrentCall");babelHelpers.classPrivateFieldLooseBase(this,f)[f].leaveCurrentCall()}foldCurrentCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].fold()}unfoldCurrentCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].unfold()}getCurrentCallDialogId(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return""}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall.associatedEntity.id}getCurrentCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall}hasCurrentCall(){return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()}hasCurrentScreenSharing(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall.isScreenSharingStarted()}hasVisibleCall(){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()}startTest(){babelHelpers.classPrivateFieldLooseBase(this,f)[f].test()}toggleDebugFlag(e){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f]){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].debug=e}chatCanBeCalled(e){const s=babelHelpers.classPrivateFieldLooseBase(this,X)[X](e);const t=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["recent/calls/hasActiveCall"](e);return s&&!t}}function U(){return new a.Controller({init:true,language:p.Core.getLanguageId(),messengerFacade:{getDefaultZIndex:()=>r.MessengerSlider.getInstance().getZIndex(),isMessengerOpen:()=>r.MessengerSlider.getInstance().isOpened(),isSliderFocused:()=>r.MessengerSlider.getInstance().isFocused(),isThemeDark:()=>false,openMessenger:e=>l.Messenger.openChat(e),openHistory:e=>l.Messenger.openChat(e),openSettings:()=>l.Messenger.openSettings(),openHelpArticle:()=>{},getContainer:()=>document.querySelector(`.${T.viewContainerClass}`),getMessageCount:()=>babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["counters/getTotalChatCounter"],getCurrentDialogId:()=>babelHelpers.classPrivateFieldLooseBase(this,j)[j](),isPromoRequired:e=>o.PromoManager.getInstance().needToShow(e),repeatSound:(e,s,t)=>{n.SoundNotificationManager.getInstance().playLoop(e,s,t)},stopRepeatSound:e=>{n.SoundNotificationManager.getInstance().stop(e)},showUserSelector:L},events:{[a.Controller.Events.onPromoViewed]:e=>{const{code:s}=e.getData();o.PromoManager.getInstance().markAsWatched(s)},[a.Controller.Events.onOpenVideoConference]:e=>{var s;const{dialogId:t}=e.getData();const a=p.Core.getStore().getters["chats/get"](`chat${t}`,true);return l.Messenger.openConference({code:(s=a.public)==null?void 0:s.code})}}})}function R(){s.EventEmitter.subscribe(d.EventType.layout.onOpenChat,babelHelpers.classPrivateFieldLooseBase(this,E)[E].bind(this));s.EventEmitter.subscribe(d.EventType.layout.onOpenNotifications,this.foldCurrentCall.bind(this));s.EventEmitter.subscribe("CallEvents::callCreated",babelHelpers.classPrivateFieldLooseBase(this,I)[I].bind(this))}function _(e){const{call:s}=e.getData()[0];s.addEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,M)[M].bind(this));s.addEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,S)[S].bind(this));s.addEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,m)[m].bind(this));const t=s.state===a.State.Connected||s.state===a.State.Proceeding?d.RecentCallStatus.joined:d.RecentCallStatus.waiting;babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/addActiveCall",{dialogId:s.associatedEntity.id,name:s.associatedEntity.name,call:s,state:t})}function k(e){babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:d.RecentCallStatus.joined}})}function N(e){babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:d.RecentCallStatus.waiting}})}function x(e){const s=e.call.associatedEntity.id;const t=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["recent/calls/getCallByDialog"](s);if((t==null?void 0:t.call.id)===e.call.id){babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/deleteActiveCall",{dialogId:s})}}function V(e){const s=this.getCurrentCallDialogId();const t=e.getData().dialogId;if(s===t){return}this.foldCurrentCall()}function $(e){if(!babelHelpers.classPrivateFieldLooseBase(this,D)[D]()||!BX.Call.Util.isWebRTCSupported()){return false}const s=Number.parseInt(e,10);return s>0?babelHelpers.classPrivateFieldLooseBase(this,O)[O](s):babelHelpers.classPrivateFieldLooseBase(this,A)[A](e)}function q(e){const s=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["users/get"](e);return s&&s.status!=="guest"&&!s.bot&&!s.network&&s.id!==p.Core.getUserId()&&!!s.lastActivityDate}function J(e){const s=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["chats/get"](e);if(!s){return false}const{userCounter:t}=s;return t>1&&t<=BX.Call.Util.getUserLimit()}function W(){return true}function Z(){const e=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["application/getLayout"];if(e.name!==d.Layout.chat.name){return""}return e.entityId}function G(e){const s=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["chats/get"](e);return(s==null?void 0:s.type)===d.ChatType.user}function z(e){const s=p.Core.getUserId();const t=p.Core.getStore().getters["users/get"](s);const a=p.Core.getStore().getters["users/get"](e);babelHelpers.classPrivateFieldLooseBase(this,f)[f].prepareUserCall({dialogId:e,user:a.id,userData:{[s]:t,[a.id]:a}})}T.viewContainerClass="bx-im-messenger__call_container";e.CallManager=T})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Event,BX.Vue3.Vuex,BX.Call,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX,BX.UI.EntitySelector,BX.UI,BX.Messenger.v2.Application);
//# sourceMappingURL=call.bundle.map.js