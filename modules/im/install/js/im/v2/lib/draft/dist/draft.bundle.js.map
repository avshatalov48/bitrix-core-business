{"version":3,"file":"draft.bundle.js","sources":["../src/draft.js"],"sourcesContent":["import {EventEmitter, BaseEvent} from 'main.core.events';\n\nimport {Core} from 'im.v2.application.core';\nimport {LocalStorageManager} from 'im.v2.lib.local-storage';\nimport {Logger} from 'im.v2.lib.logger';\nimport {LocalStorageKey, EventType, Layout} from 'im.v2.const';\n\nimport type {OnLayoutChangeEvent} from 'im.v2.const';\n\nconst WRITE_TO_STORAGE_TIMEOUT = 1000;\nconst SHOW_DRAFT_IN_RECENT_TIMEOUT = 1500;\n\nexport class DraftManager\n{\n\tstatic instance: DraftManager;\n\tstatic inited: boolean;\n\n\t#drafts: {[string]: string} = {};\n\t#store: Object;\n\n\tstatic getInstance(): DraftManager\n\t{\n\t\tif (!this.instance)\n\t\t{\n\t\t\tthis.instance = new this();\n\t\t}\n\n\t\treturn this.instance;\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\n\t\tEventEmitter.subscribe(EventType.layout.onLayoutChange, this.#onLayoutChange.bind(this));\n\t}\n\n\tinitDraftHistory()\n\t{\n\t\tif (DraftManager.inited)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\t\tthis.#drafts = LocalStorageManager.getInstance().get(LocalStorageKey.draft, {});\n\t\tLogger.warn('DraftManager: initDrafts:', this.#drafts);\n\t\tthis.#setDraftsInRecentList();\n\t\tDraftManager.inited = true;\n\t}\n\n\tsetDraft(dialogId: number, text: string)\n\t{\n\t\ttext = text.trim();\n\t\tif (text === '')\n\t\t{\n\t\t\tdelete this.#drafts[dialogId];\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.#drafts[dialogId] = text;\n\t\t}\n\n\t\tclearTimeout(this.writeToStorageTimeout);\n\t\tthis.writeToStorageTimeout = setTimeout(() => {\n\t\t\tLocalStorageManager.getInstance().set(LocalStorageKey.draft, this.#drafts);\n\t\t}, WRITE_TO_STORAGE_TIMEOUT);\n\t}\n\n\tclearDraft(dialogId: number)\n\t{\n\t\tthis.setDraft(dialogId, '');\n\t}\n\n\tgetDraft(dialogId: number): string\n\t{\n\t\treturn this.#drafts[dialogId] ?? '';\n\t}\n\n\tclearDraftInRecentList(dialogId: number)\n\t{\n\t\tthis.#setDraftInRecentList(dialogId, '');\n\t}\n\n\t#setDraftsInRecentList()\n\t{\n\t\tObject.entries(this.#drafts).forEach(([dialogId, text]) => {\n\t\t\tthis.#setDraftInRecentList(dialogId, text);\n\t\t});\n\t}\n\n\t#setDraftInRecentList(dialogId: number, text: string)\n\t{\n\t\tthis.#store.dispatch('recent/draft', {\n\t\t\tid: dialogId,\n\t\t\ttext\n\t\t});\n\t}\n\n\t#onLayoutChange(event: BaseEvent<OnLayoutChangeEvent>)\n\t{\n\t\tconst {from} = event.getData();\n\t\tif (from.name !== Layout.chat.name || from.entityId === '')\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst dialogId = from.entityId;\n\t\tsetTimeout(() => {\n\t\t\tthis.#setDraftInRecentList(dialogId, this.getDraft(dialogId));\n\t\t}, SHOW_DRAFT_IN_RECENT_TIMEOUT);\n\t}\n}"],"names":["WRITE_TO_STORAGE_TIMEOUT","SHOW_DRAFT_IN_RECENT_TIMEOUT","DraftManager","getInstance","instance","constructor","Core","getStore","EventEmitter","subscribe","EventType","layout","onLayoutChange","bind","initDraftHistory","inited","LocalStorageManager","get","LocalStorageKey","draft","Logger","warn","setDraft","dialogId","text","trim","clearTimeout","writeToStorageTimeout","setTimeout","set","clearDraft","getDraft","clearDraftInRecentList","Object","entries","forEach","dispatch","id","event","from","getData","name","Layout","chat","entityId"],"mappings":";;;;;;CASA,MAAMA,wBAAwB,GAAG,IAAI;CACrC,MAAMC,4BAA4B,GAAG,IAAI;CAAC;CAAA;CAAA;CAAA;CAAA;AAE1C,CAAO,MAAMC,YAAY,CACzB;GAOC,OAAOC,WAAW,GAClB;KACC,IAAI,CAAC,IAAI,CAACC,QAAQ,EAClB;OACC,IAAI,CAACA,QAAQ,GAAG,IAAI,IAAI,EAAE;;KAG3B,OAAO,IAAI,CAACA,QAAQ;;GAGrBC,WAAW,GACX;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;;KAAA;OAAA;OAAA,OAd8B;;KAAE;OAAA;OAAA;;KAe/B,4CAAI,oBAAUC,2BAAI,CAACC,QAAQ,EAAE;KAE7BC,6BAAY,CAACC,SAAS,CAACC,qBAAS,CAACC,MAAM,CAACC,cAAc,EAAE,4CAAI,oCAAiBC,IAAI,CAAC,IAAI,CAAC,CAAC;;GAGzFC,gBAAgB,GAChB;KACC,IAAIZ,YAAY,CAACa,MAAM,EACvB;OACC,OAAO,KAAK;;KAEb,4CAAI,sBAAWC,0CAAmB,CAACb,WAAW,EAAE,CAACc,GAAG,CAACC,2BAAe,CAACC,KAAK,EAAE,EAAE,CAAC;KAC/EC,uBAAM,CAACC,IAAI,CAAC,2BAA2B,0CAAE,IAAI,oBAAS;KACtD,4CAAI;KACJnB,YAAY,CAACa,MAAM,GAAG,IAAI;;GAG3BO,QAAQ,CAACC,QAAgB,EAAEC,IAAY,EACvC;KACCA,IAAI,GAAGA,IAAI,CAACC,IAAI,EAAE;KAClB,IAAID,IAAI,KAAK,EAAE,EACf;OACC,OAAO,4CAAI,oBAASD,QAAQ,CAAC;MAC7B,MAED;OACC,4CAAI,oBAASA,QAAQ,CAAC,GAAGC,IAAI;;KAG9BE,YAAY,CAAC,IAAI,CAACC,qBAAqB,CAAC;KACxC,IAAI,CAACA,qBAAqB,GAAGC,UAAU,CAAC,MAAM;OAC7CZ,0CAAmB,CAACb,WAAW,EAAE,CAAC0B,GAAG,CAACX,2BAAe,CAACC,KAAK,0CAAE,IAAI,oBAAS;MAC1E,EAAEnB,wBAAwB,CAAC;;GAG7B8B,UAAU,CAACP,QAAgB,EAC3B;KACC,IAAI,CAACD,QAAQ,CAACC,QAAQ,EAAE,EAAE,CAAC;;GAG5BQ,QAAQ,CAACR,QAAgB,EACzB;KAAA;KACC,gCAAO,4CAAI,oBAASA,QAAQ,CAAC,oCAAI,EAAE;;GAGpCS,sBAAsB,CAACT,QAAgB,EACvC;KACC,4CAAI,gDAAuBA,QAAQ,EAAE,EAAE;;CA+BzC;CAAC,mCA3BA;GACCU,MAAM,CAACC,OAAO,yCAAC,IAAI,oBAAS,CAACC,OAAO,CAAC,CAAC,CAACZ,QAAQ,EAAEC,IAAI,CAAC,KAAK;KAC1D,4CAAI,gDAAuBD,QAAQ,EAAEC,IAAI;IACzC,CAAC;CACH;CAAC,gCAEqBD,QAAgB,EAAEC,IAAY,EACpD;GACC,4CAAI,kBAAQY,QAAQ,CAAC,cAAc,EAAE;KACpCC,EAAE,EAAEd,QAAQ;KACZC;IACA,CAAC;CACH;CAAC,0BAEec,KAAqC,EACrD;GACC,MAAM;KAACC;IAAK,GAAGD,KAAK,CAACE,OAAO,EAAE;GAC9B,IAAID,IAAI,CAACE,IAAI,KAAKC,kBAAM,CAACC,IAAI,CAACF,IAAI,IAAIF,IAAI,CAACK,QAAQ,KAAK,EAAE,EAC1D;KACC;;GAGD,MAAMrB,QAAQ,GAAGgB,IAAI,CAACK,QAAQ;GAC9BhB,UAAU,CAAC,MAAM;KAChB,4CAAI,gDAAuBL,QAAQ,EAAE,IAAI,CAACQ,QAAQ,CAACR,QAAQ,CAAC;IAC5D,EAAEtB,4BAA4B,CAAC;CACjC;;;;;;;;"}