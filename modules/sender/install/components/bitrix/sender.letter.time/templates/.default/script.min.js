(function(){BX.namespace("BX.Sender.Letter");if(BX.Sender.Letter.Time){return}var e=BX.Sender.Page;var t=BX.Sender.Helper;function i(){this.context=null}i.prototype.init=function(i){this.context=BX(i.containerId);this.actionUri=i.actionUri;this.isFrame=i.isFrame||false;this.isSaved=i.isSaved||false;this.isOutside=i.isOutside||false;this.canEdit=i.canEdit||false;this.isSupportReiterate=i.isSupportReiterate||false;this.prettyDateFormat=i.prettyDateFormat;this.mess=i.mess||{atTime:"",defered:""};this.selectorNode=t.getNode("time-selector",this.context);this.inputNode=t.getNode("time-input",this.context);if(this.canEdit){BX.bind(this.selectorNode,"click",this.showMenu.bind(this))}if(this.isFrame&&this.isSaved){BX.Sender.Page.slider.close();if(this.isOutside&&parent.BX){if(!parent.BX.UI||!parent.BX.UI.Notification){parent.BX.namespace("BX.UI");parent.BX.UI.Notification=BX.UI.Notification}parent.BX.UI.Notification.Center.notify({content:this.mess.outsideSaveSuccess,autoHideDelay:5e3})}}this.scheduleNodes={daysOfMonth:t.getNode("time-reiterate-days-of-month",this.context),daysOfWeek:t.getNode("time-reiterate-days-of-week",this.context),timesOfDay:t.getNode("time-reiterate-times-of-day",this.context),monthsOfYear:t.getNode("time-reiterate-months-of-year",this.context)};this.schedule=new s({caller:this,context:t.getNode("time-reiterate",this.context)});var a=this.inputNode.value;var o=BX.parseDate(this.inputNode.value);if(a&&o){this.setFormattedDate(o)}else if(this.scheduleNodes.timesOfDay.value){this.schedule.setText()}else{this.selectorNode.textContent=this.mess.defered}e.initButtons()};i.prototype.onPopupClose=function(){};i.prototype.onClick=function(e){this.popupMenu.close();if(e==="time"){this.showCalendar(this.selectorNode);return}if(e==="schedule"){this.schedule.show();return}var t=null;var i=this.popupMenu.getMenuItem(e);if(!i){return}else if(e==="defered"){t=null}else if(e==="now"){t="now"}this.selectorNode.textContent=i.text;this.inputNode.value=t};i.prototype.onTimeSet=function(e){if(!e){return}var t=new Date;if(e<t){e=t}this.setFormattedDate(e);this.inputNode.value=BX.date.format(BX.date.convertBitrixFormat(BX.message("FORMAT_DATETIME")),e)};i.prototype.setFormattedDate=function(e){var t=BX.isAmPmMode();var i=this.prettyDateFormat+" ";var s=BX.date.format(i,e);var a=BX.date.format(t?"g:i a":"H:i",e);this.selectorNode.textContent=s+" "+this.mess.atTime+" "+a};i.prototype.onPopupItemEnter=function(e){var t=this.popupMenu.getMenuItem(e);if(!t){return}if(e==="time"){}else{BX.calendar.get().Close()}};i.prototype.showCalendar=function(e){var t=this.inputNode.value;if(t){t=BX.parseDate(t,true)}BX.calendar({node:e,value:t,bTime:true,bHideTime:false,callback:function(){return true},callback_after:this.onTimeSet.bind(this)})};i.prototype.showMenu=function(){if(this.popupMenu){this.popupMenu.show();return}var e=[{id:"now",text:this.mess.now},{id:"defered",text:this.mess.defered},{id:"time",text:this.mess.time}];if(this.isSupportReiterate){e.push({id:"schedule",text:this.mess.schedule})}e.forEach((function(e){e.onclick=this.onClick.bind(this,e.id);e.events={onMouseEnter:this.onPopupItemEnter.bind(this,e.id)}}),this);this.popupMenu=BX.PopupMenu.create("sender-letter-time",this.selectorNode,e,{autoHide:true,offsetLeft:40,angle:{position:"top",offset:42},events:{onPopupClose:this.onPopupClose.bind(this)}});this.popupMenu.show()};function s(e){this.init(e)}s.prototype={popup:null,activeClassName:"sender-letter-time-popup-date-item-current",init:function(e){this.caller=e.caller;this.context=e.context;this.timesOfDayNode=t.getNode("reiterate-times-of-day",this.context);if(this.caller.scheduleNodes.timesOfDay.value){this.timesOfDayNode.value=this.caller.scheduleNodes.timesOfDay.value}this.daysOfMonthNode=t.getNode("reiterate-days-of-month",this.context);if(this.caller.scheduleNodes.daysOfMonth.value){this.daysOfMonthNode.value=this.caller.scheduleNodes.daysOfMonth.value}this.daysOfWeekNodes=t.getNodes("reiterate-days-of-week",this.context);var i=this.caller.scheduleNodes.daysOfWeek.value;this.daysOfWeekNodes.forEach((function(e){BX.bind(e,"click",this.selectWeekDay.bind(this,e));if(i){var s=i.indexOf(e.getAttribute("data-value"))>=0;t.changeClass(e,this.activeClassName,s)}}),this);this.daysOfMonthNodes=t.getNodes("reiterate-days-of-month",this.context);var s=this.caller.scheduleNodes.daysOfMonth.value.split(",");this.daysOfMonthNodes.forEach((function(e){BX.bind(e,"click",this.selectWeekDay.bind(this,e));var i=e.getAttribute("data-value");if(s&&i){var a=BX.util.in_array(i,s);t.changeClass(e,this.activeClassName,a)}}),this);this.monthsOfYearNodes=t.getNodes("reiterate-months-of-year",this.context);var a=this.caller.scheduleNodes.monthsOfYear.value.split(",");this.monthsOfYearNodes.forEach((function(e){BX.bind(e,"click",this.selectWeekDay.bind(this,e));var i=e.getAttribute("data-value");if(a&&i){var s=BX.util.in_array(i,a);t.changeClass(e,this.activeClassName,s)}}),this);this.additionalNode=t.getNode("reiterate-additional",this.context);this.additionalBtnNode=t.getNode("reiterate-additional-btn",this.context);if(this.additionalBtnNode&&this.additionalNode){BX.bind(this.additionalBtnNode,"click",this.showAdditional.bind(this));if(s.length||a.length){this.showAdditional()}}},showAdditional:function(){t.display.change(this.additionalNode,true);t.display.change(this.additionalBtnNode,false)},show:function(){if(!this.popup){this.popup=BX.PopupWindowManager.create("sender-letter-time-schedule",this.caller.selectorNode,{content:this.context,autoHide:true,lightShadow:false,width:270,closeByEsc:true,contentColor:"white",angle:true,buttons:[new BX.PopupWindowButton({text:this.caller.mess.accept,className:"popup-window-button-accept",events:{click:this.onApply.bind(this)}})]})}if(this.popup.isShown()){return}this.popup.show()},selectWeekDay:function(e){var t=e.getAttribute("data-value");if(!t){return}BX.toggleClass(e,this.activeClassName)},setText:function(){var e=this.getTime();var t=this.getSelectedNames(this.daysOfWeekNodes);var i=this.getSelectedNames(this.daysOfMonthNodes);var s=this.getSelectedNames(this.monthsOfYearNodes);var a=[];if(i.length&&s.length){s.forEach((function(e){i.forEach((function(t){a.push(t+" "+e)}))}))}else if(i.length){a=i}else if(s.length){a=s}a=this.getString(a);var o=this.caller.mess.scheduleText;o=o.replace("%time%",e);if((t.length===0||t.length===7)&&a){o=o.replace("%days%",a)}else{o=o.replace("%days%",this.getString(t));if(a){o=o+". "+this.caller.mess.scheduleTextMo.replace("%days%",a)}}this.caller.selectorNode.textContent=o},getTime:function(){return this.timesOfDayNode.value},getSelectedNodes:function(e){return e.filter((function(e){return BX.hasClass(e,this.activeClassName)}),this)},getSelectedValues:function(e){return this.getSelectedNodes(e).map((function(e){return e.getAttribute("data-value")}),this)},getSelectedValuesString:function(e){return this.getSelectedValues(e).join(",")},getSelectedNames:function(e){return this.getSelectedNodes(e).map((function(e){return e.textContent.trim()}),this)},getString:function(e){return e.join(", ")},onApply:function(){this.caller.scheduleNodes.timesOfDay.value=this.getTime();this.caller.scheduleNodes.daysOfWeek.value=this.getSelectedValuesString(this.daysOfWeekNodes);this.caller.scheduleNodes.daysOfMonth.value=this.getSelectedValuesString(this.daysOfMonthNodes);this.caller.scheduleNodes.monthsOfYear.value=this.getSelectedValuesString(this.monthsOfYearNodes);this.caller.inputNode.value="schedule";this.setText()}};BX.Sender.Letter.Time=new i})(window);
//# sourceMappingURL=script.map.js