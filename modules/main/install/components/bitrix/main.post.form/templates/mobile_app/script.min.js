(function(){if(!window["BX"]||window["BX"]["MPF"]||!window["app"])return;var t={},e=function(){var t=function(t){if(BX.type.isNotEmptyString(t)){this.id=t;this.url=t;this.name=t.substr(t.lastIndexOf("/")+1);if(this.name.indexOf("?")>=0)this.name=this.name.substr(0,this.name.indexOf("?"));this.ext=this.name.lastIndexOf(".")>0?this.name.substr(this.name.lastIndexOf(".")+1).toLowerCase():""}else{for(var e in t){if(t.hasOwnProperty(e)){this[e]=t[e]}}}};t.prototype={getErrorText:function(t){return t||BX.message("MPFFileWasNotUploaded")}};return t}(),i=function(){var t=function(t,e,i){this.id=e;this.url=window.location.protocol+"//"+window.location.host+this.urlUpload;this.values={};this.params=i;this.propertyName=this.params["FIELD_NAME"];this.catchUF=BX.delegate(this.catchUF,this);this.parseUF=BX.delegate(this.parseUF,this);this.prepareToSaveUF=BX.delegate(this.prepareToSaveUF,this)};t.prototype={prefixHTMLNode:"disk-attach-",userTypeId:"disk_file",urlUpload:"/bitrix/tools/disk/uf.php?action=uploadFile&ncc=1",uploadBase64:function(t){var e=new window.FileUploadOptions,i=new window.FileTransfer,s=BX.proxy(function(e){e=BX.parseJSON(e.response);if(e==null)n();else this.uploadBase64Response(t,e)},this),n=BX.proxy(function(){this.uploadBase64Failure(t,BX.message("MPFIncorrectResponse"))},this);e.fileKey=this.userTypeId;e.fileName=t.name;e.params={sessid:BX.bitrix_sessid()};e.mimeType="image/jpeg";e.chunkedMode=false;i.upload(t.url,this.url,s,BX.proxy(function(){window.app.BasicAuth({success:BX.proxy(function(o){e.params.sessid=o.sessid_md5;i.upload(t.url,this.url,s,n,e)},this),failure:n})},this),e)},uploadBase64Failure:function(t,e){BX.onCustomEvent(t,"onUploadError",[t.getErrorText(e)])},uploadBase64Response:function(t,e){var i;if(e.status!="success"){i=e["message"];if(!i&&BX.type.isArray(e["errors"])){for(var s=0;s<e["errors"].length;s++){if(e["errors"][s]&&e["errors"][s]["message"]){i=(i||"")+e["errors"][s]["message"]}}}this.uploadBase64Failure(t,i)}else{e=e.data;var n=e["attachId"]||e["id"],o="blank";if(BX.util.in_array(t.ext,["jpg","bmp","jpeg","jpe","gif","png"]))o="img";else if(BX.util.in_array(t.ext,["doc","pdf","ppt","rar","xls","zip"]))o=t.ext;BX.onCustomEvent(t,"onUploadOk",["[DISK FILE ID="+n+"]",{extension:e["ext"],iconUrl:"/bitrix/components/bitrix/mobile.disk.file.detail/images/"+o+".png",previewImageUrl:"",id:n,fileId:n,xmlID:"0",name:e["name"],type:e["ext"],propertyName:this.propertyName,fieldName:this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":""),fieldValue:n,url:(BX.message("MobileSiteDir")||"/")+"mobile/ajax.php?attachedId="+n+"&action=download&ncc=1&mobile_action=disk_uf_view&filename="+["name"]},this])}},catchUF:function(t,e,i){if(t&&t[this.propertyName]&&t[this.propertyName]["USER_TYPE_ID"]==this.userTypeId&&BX.type.isArray(t[this.propertyName]["VALUE"])){i["uf"]=i["uf"]||{};t=t[this.propertyName];var s=function(){var t="id"+Math.random();while(i["uf"][t])t="id"+Math.random();return t};for(var n=0,o,r,a,l,h,m,d;n<t["VALUE"].length;n++){r=t["VALUE"][n];o=BX(this.prefixHTMLNode+r);a=o.getAttribute("data-bx-title")||"noname";l=a.lastIndexOf(".")>0?a.substr(a.lastIndexOf(".")+1).toLowerCase():"";h="blank";d=s();if(BX.util.in_array(l,["jpg","bmp","jpeg","jpe","gif","png"]))h="img";else if(BX.util.in_array(l,["doc","pdf","ppt","rar","xls","zip"]))h=l;if(o){m={extension:l,iconUrl:"/bitrix/components/bitrix/mobile.disk.file.detail/images/"+h+".png",previewImageUrl:o.getAttribute("data-bx-src")||o.getAttribute("src")||undefined,id:d,fileId:o.getAttribute("bx-attach-file-id"),xmlID:o.getAttribute("bx-attach-xml-id"),name:a,type:l,propertyName:this.propertyName,fieldName:this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":""),fieldValue:r,url:(BX.message("MobileSiteDir")||"/")+"mobile/ajax.php?attachedId="+r+"&action=download&ncc=1&mobile_action=disk_uf_view&filename="+a};i["uf"][d]=m;e.push(m)}}}},parseUF:function(t,e){if(e&&e.length>0){var i=t.text,s,n;if(BX.type.isNotEmptyString(i)){for(s=0;s<e.length;s++){n=e[s];if(n.propertyName==this.propertyName){if(parseInt(n.fileId)>0){i=i.replace("[DISK FILE ID=n"+n.fileId+"]","[DISK FILE ID="+n.id+"]")}else if(e.length==1&&BX.util.in_array(n.type,["gif","jpg","jpeg","png","jpe","bmp"])){i+="\n[DISK FILE ID="+(n.fieldValue?n.fieldValue:"n"+n.fileId)+"]"}}}}else{for(s=0;s<e.length;s++){n=e[s];if(n.propertyName==this.propertyName){i+="[DISK FILE ID="+(n.fieldValue?n.fieldValue:"n"+n.fileId)+"]"}}}t.text=i}},prepareToSaveUF:function(t,e){if(t.length>0){var i,s,n=[];for(i=0;i<t.length;i++){s=t[i];if(!s["propertyName"]&&(!s["disk"]||s["base64"])){s["propertyName"]=this.propertyName;n.push(s)}else if(!s["propertyName"]&&s["VALUE"]){s["name"]=s["NAME"];s["ext"]=s["name"].lastIndexOf(".")>0?s["name"].substr(s["name"].lastIndexOf(".")+1).toLowerCase():"";s["id"]=s["ID"];s["fileId"]=s["ID"];s["xmlID"]=0;s["type"]=s["ext"];s["propertyName"]=this.propertyName;s["fieldName"]=this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":"");s["fieldValue"]=s["VALUE"];s["url"]=s["URL"]["URL"]}else if(!s["propertyName"]&&s["dataAttributes"]&&s["dataAttributes"]["VALUE"]){var o=s["dataAttributes"];s["name"]=o["NAME"];s["ext"]=s["name"].lastIndexOf(".")>0?s["name"].substr(s["name"].lastIndexOf(".")+1).toLowerCase():"";s["id"]=o["ID"];s["fileId"]=o["ID"];s["xmlID"]=0;s["type"]=s["ext"];s["propertyName"]=this.propertyName;s["fieldName"]=this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":"");s["fieldValue"]=o["VALUE"];s["url"]=o["URL"]["URL"]}}if(n.length>0){e.add(this,n)}}else{t.push({fieldName:this.propertyName+(this.params["MULTIPLE"]=="Y"?"[]":""),fieldValue:""})}},upload:function(t){var e=t.pop();if(e){var i=BX.proxy(function(n,o){BX.removeCustomEvent(e,"onUploadOk",i);BX.removeCustomEvent(e,"onUploadError",s);for(var r in o){if(o.hasOwnProperty(r)){e[r]=o[r]}}this.upload(t)},this),s=BX.proxy(function(t){BX.removeCustomEvent(e,"onUploadOk",i);BX.removeCustomEvent(e,"onUploadError",s);BX.onCustomEvent(this,"onUploadError",[t])},this);BX.addCustomEvent(e,"onUploadOk",i);BX.addCustomEvent(e,"onUploadError",s);this.uploadBase64(e);return}BX.onCustomEvent(this,"onUploadOk",[])}};return t}(),s=function(){var t=function(){};t.prototype={files:[],queue:{},getId:function(){return"id"+Math.random()},add:function(t,e){if(!t["__queueId"]){t.__queueId=this.getId();t.__onUploadOk=BX.delegate(function(){this.start(t)},this);t.__onUploadError=BX.delegate(this.error,this);BX.addCustomEvent(t,"onUploadOk",t.__onUploadOk);BX.addCustomEvent(t,"onUploadError",t.__onUploadError)}else{var i,s=(this.queue[t.__queueId]||[t,[]])[1];while((i=e.pop())&&i){s.push(i)}e=s}this.queue[t.__queueId]=[t,e]},start:function(t){if(t&&t.__queueId){this.clear(t)}var e;for(var i in this.queue){if(this.queue.hasOwnProperty(i)){e=this.queue[i];delete this.queue[i];if(e[0]&&e[0]["upload"]){e[0]["upload"](e[1])}else{this.start(e[0])}return}}BX.onCustomEvent(this,"onUploadOk",[])},clear:function(t){if(t.__queueId){delete this.queue[t.__queueId];delete t.__queueId;BX.removeCustomEvent(t,"onUploadOk",t.__onUploadOk);BX.removeCustomEvent(t,"onUploadError",t.__onUploadError);delete t.__onUploadOk;delete t.__onUploadError}},error:function(){var t=[],e;for(e in this.queue){if(this.queue.hasOwnProperty(e)){t.push(e)}}while((e=t.pop())&&e)this.clear(this.queue[e]);BX.onCustomEvent(this,"onUploadError",[BX.message("MPFFileWasNotUploaded")])},hasSmthToUpload:function(){for(var t in this.queue){if(this.queue.hasOwnProperty(t)){return true}}return false}};return t}(),n=function(){var t=function(t){this.handler=t;this.id=BX.util.getRandomString(8);this.params={placeholder:BX.message("MPFPlaceholder"),onEvent:BX.delegate(this.handleAppCallback,this),onSend:BX.delegate(this.handleAppData,this)}};t.prototype={handleAppData:function(t,i){t=BX.type.isNotEmptyString(t)?{text:t}:BX.type.isPlainObject(t)?t:{};var s=t["attachedFiles"]||[],n=t["text"]||"";if(!i){this.handler.comment.node=null}for(var o=0;o<s.length;o++){s[o]=new e(s[o])}this.stopCheckWriting();BX.onCustomEvent(this,"onFormSubmitted",[n,s])},handleAppFile:function(t,i){if(!i){this.handler.comment.node=null}this.stopCheckWriting();var s=this;window.BXMobileApp.UI.Page.TextPanel.getText(function(i){BX.onCustomEvent(s,"onFileSubmitted",[i,new e(t)])})},handleAppCallback:function(t){if(this.writingParams.lastEvent!=t&&(!t||t["event"]!="removeFocus")){this.writingParams.lastEvent=t;this.writingParams.text+=t.text;this.writingParams["~text"]=t.text;BX.onCustomEvent("main.post.form/text",[t.text]);if(this.writingParams.text.length>4){this.writingParams.text="";this.startCheckWriting()}}},init:function(t){t=t||"";this.params.text=t;window.BX.MobileUI.TextField.show(this.params);if(BX.type.isNotEmptyString(t)){this.writingParams["~text"]=t}else{this.writingParams["~text"]=""}this.writingParams.text=""},show:function(t){if(BX.type.isString(t)){window.BXMobileApp.UI.Page.TextPanel.setText(t);this.writingParams["~text"]=t}window.BXMobileApp.UI.Page.TextPanel.focus()},clear:function(){this.writingParams.text="";this.writingParams["~text"]="";window.BXMPage.TextPanel.clear()},writingParams:{lastFired:0,lastEvent:null,frequency:1e4,text:"","~text":""},stopCheckWriting:function(){this.writingParams.text=""},startCheckWriting:function(){var t=new Date;if(t-this.writingParams.lastFired>this.writingParams.frequency){BX.onCustomEvent(this,"onUserIsWriting",[this]);this.writingParams.lastFired=t}},showWait:function(){window.BXMobileApp.UI.Page.TextPanel.showLoading(true)},closeWait:function(){window.BXMobileApp.UI.Page.TextPanel.showLoading(false)}};return t}(),o=function(){var t=function(t,e){this.handler=t;this.formSettings={attachButton:{items:this.initFiles(e["CID"])},attachFileSettings:{resize:[40,1,1,1e3,1e3,0,0,false,true,false,null,0],sendLocalFileMethod:"base64",saveToPhotoAlbum:true},attachedFiles:[],extraData:{},mentionButton:{dataSource:{return_full_mode:"YES",outsection:"NO",okname:BX.message("MPFButtonSend"),cancelname:BX.message("MPFButtonCancel"),multiple:"NO",alphabet_index:"YES",url:BX.message("MobileSiteDir")+"mobile/index.php?mobile_action=get_user_list"}},smileButton:{},message:{text:""},okButton:{callback:BX.delegate(this.applyExtendedForm,this),name:BX.message("MPFButtonSend")},cancelButton:{callback:BX.delegate(this.cancelExtendedForm,this),name:BX.message("MPFButtonCancel")}}};t.prototype={initFiles:function(t){this.controllers={};if(!t||typeof t!=="object")return[];var e,i=[],s;for(e in t){if(t.hasOwnProperty(e)){if(t[e]["USER_TYPE_ID"]=="disk_file"){s={id:"disk",name:BX.message("MPFPostFormDisk"),dataSource:{multiple:"NO",url:BX.message("SITE_DIR")+"mobile/?mobile_action=disk_folder_list&type=user&path=%2F&entityId="+BX.message("USER_ID")}};s.dataSource[window["platform"]=="ios"?"table_settings":"TABLE_SETTINGS"]={searchField:"YES",showtitle:"YES",modal:"YES",name:BX.message("MPFPostFormDiskTitle")};i.push(s)}}}if(i.length>0){i.push({id:"mediateka",name:BX.message("MPFPostFormPhotoGallery")});i.push({id:"camera",name:BX.message("MPFPostFormPhotoCamera")})}return i},applyExtendedForm:function(t){this.stopCheckWriting();t.text=t.text||"";t.attachedFiles=t.attachedFiles||[];for(var i=0;i<t.attachedFiles.length;i++){t.attachedFiles[i]=new e(t.attachedFiles[i])}t.extraData=t.extraData||{};BX.onCustomEvent(this,"onApplyComment",[t,t.attachedFiles]);BX.onCustomEvent(this,"onFormSubmitted",[t.text,t.attachedFiles,t.extraData])},cancelExtendedForm:function(){this.stopCheckWriting()},show:function(t,e){this.formSettings.message={text:t};this.formSettings.attachedFiles=[];this.formSettings.extraData={};if(e){BX.onCustomEvent(this,"onEditCommentUF",[e["UF"],this.formSettings.attachedFiles,this.formSettings.extraData]);BX.onCustomEvent(this,"onEditCommentFiles",[e["FILES"],this.formSettings.attachedFiles,this.formSettings.extraData])}window.app.exec("showPostForm",this.formSettings)},clear:function(){this.writingParams.text="";this.writingParams["~text"]=""},writingParams:{lastFired:0,lastEvent:null,frequency:1e4,text:""},stopCheckWriting:function(){this.writingParams.text=""},startCheckWriting:function(){var t=new Date;if(t-this.writingParams.lastFired>this.writingParams.frequency){this.writingParams.lastFired=t}},showWait:function(){},closeWait:function(){}};return t}();BX.MPF=function(){var e=function(e){if(!window.app.enableInVersion(4))throw this.errors["error00"];if(t[e["formId"]])t[e["formId"]].destroy();this.form=BX(e["formId"]);if(!this.form)throw this.errors["error01"];this.id=this.form.id;BX.hide(this.form);document.body.appendChild(this.form);this.text=this.form.elements[e.text.name];if(!this.text){this.text=BX.create("INPUT",{props:{type:"hidden",name:e.text.name,value:""}});this.form.appendChild(this.text)}this.block=BX.create("DIV",{className:"bx-additional-block-data"});this.form.appendChild(this.block);this.simpleForm=new n(this);this.extendedForm=new o(this,e);this.currentForm=null;t[this.id]=this;this.initEvents();this.controllers={};this.initControllers(e["CID"]);BX.onCustomEvent(window,"onMPFIsInitialized",[this])};e.prototype={errors:{error00:"BX.MPL: Mobile Application is obsolete.",error01:"BX.MPL: form does not exist."},initEvents:function(){BX.addCustomEvent(this.simpleForm,"onFormSubmitted",BX.delegate(this.submitExtended,this));BX.addCustomEvent(this.simpleForm,"onUserIsWriting",BX.delegate(this.writing,this));BX.addCustomEvent(this.extendedForm,"onFormSubmitted",BX.delegate(this.submitExtended,this))},initControllers:function(t){if(t||typeof t=="object"){var e,s=false;for(e in t){if(t.hasOwnProperty(e)){if(t[e]["USER_TYPE_ID"]=="disk_file"){this.controllers[e]=new i(this,e,t[e]);if(!s){BX.addCustomEvent(this,"onExtendedCheckUpload",this.controllers[e]["prepareToSaveUF"]);BX.addCustomEvent(this,"onExtendedCheckData",this.controllers[e]["parseUF"]);s=true}BX.addCustomEvent(this.extendedForm,"onEditCommentUF",this.controllers[e]["catchUF"]);BX.addCustomEvent(this.extendedForm,"onApplyComment",this.controllers[e]["parseUF"])}}}}},destroy:function(){BX.remove(this.form);BX.onCustomEvent(this.handler,"onMPFHasBeenDestroyed",[this.id,t[this.id],this]);t[this.id]=null},writing:function(){BX.onCustomEvent(this,"onMPFUserIsWriting",[this.comment])},setForm:function(t){this.currentForm=t===true?this.extendedForm:this.simpleForm},init:function(t){this.comment=t;this.setForm(false);this.simpleForm.init(t.text)},show:function(t,e){BX.onCustomEvent(this,"onShow",[this,t]);this.comment=t;this.setForm(e);this.currentForm.show(t.text,t.attachments)},clear:function(){if(this.currentForm!==null){this.currentForm.clear()}},submitBase64:function(t,e){var i={filesToPost:false};BX.onCustomEvent(this,"onBase64Submitted",[e,i]);if(i["filesToPost"]!==false){BX.onCustomEvent(this.comment,"onStart",[this.comment,t,[e]]);BX.addCustomEvent(e,"onUploadOk",BX.proxy(function(e,i){this.submit(BX.type.isNotEmptyString(t)?t:e,[i])},this));BX.addCustomEvent(e,"onUploadError",BX.proxy(this.error,this));BX.onCustomEvent(e,"onUploadStart",[e])}else{this.cancel()}},submitExtended:function(t,e,i){if(!(BX.type.isNotEmptyString(t)||BX.type.isArray(e)&&e.length>0)){this.cancel();return}if(typeof i!="undefined"&&typeof i["uf"]!="undefined"){for(var n=0,o,r;n<e.length;n++){if(e[n]&&e[n]["id"]&&i["uf"][e[n]["id"]]){for(r in i["uf"][e[n]["id"]]){if(i["uf"][e[n]["id"]].hasOwnProperty(r)){if(!e[n][r]){e[n][r]=i["uf"][e[n]["id"]][r]}}}e[n]["id"]=i["uf"][e[n]["id"]]["fieldValue"]}}}BX.onCustomEvent(this.comment,"onStart",[this.comment,t,e]);var a=new s;BX.onCustomEvent(this,"onExtendedCheckUpload",[e,a]);var l=BX.proxy(function(){var i={text:t};BX.onCustomEvent(this,"onExtendedCheckData",[i,e]);if(BX.type.isNotEmptyString(i.text))this.submit(i.text,e);else this.cancel()},this);if(a.hasSmthToUpload()){this.setForm(false);this.clear();BX.addCustomEvent(a,"onUploadOk",l);BX.addCustomEvent(a,"onUploadError",BX.proxy(function(){this.comment.text=t;this.comment.attachments=e;this.comment.extraData=i;this.error()},this));a.start()}else{l()}},cancel:function(){this.setForm(false);this.clear();BX.onCustomEvent(this.comment,"onCancel",[this.comment])},error:function(t){this.setForm(false);this.clear();BX.onCustomEvent(this.comment,"onError",[this.comment,t])},submit:function(t,e,i){this.setForm(false);this.clear();this.comment.text=t;this.text.value=this.comment.getText();this.comment.attachments=e;this.comment.extraData=i;BX.onCustomEvent(this.comment,"onSubmit",[this.comment])},getForm:function(t){return BX.ajax.prepareForm(this.form,t).data},showWait:function(){if(this.currentForm!==null)this.currentForm.showWait()},closeWait:function(){if(this.currentForm!==null)this.currentForm.closeWait()}};return e}();BX.MPF.createInstance=function(e){if(!t[e["ID"]])new BX.MPF(e);return t[e["ID"]]};BX.MPF.getInstance=function(e){return t[e]};BX.onCustomEvent(window,"main.post.form/mobile",["mobile"])})();
//# sourceMappingURL=script.map.js