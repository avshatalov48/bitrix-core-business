this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.Embedding=this.BX.Messenger.Embedding||{};(function(t,e,i,s,n,a,r,o,c,l,d,h,g,m){"use strict";const u={name:"NewUserPopup",props:{title:{type:String,required:true},text:{type:String,required:true}},emits:["click","close"],mounted(){BX.MessengerProxy.playNewUserSound();this.setCloseTimer(5e3);this.onClosePopupHandler=this.onClosePopup.bind(this);g.EventEmitter.subscribe(m.EventType.dialog.closePopup,this.onClosePopupHandler)},beforeUnmount(){g.EventEmitter.unsubscribe(m.EventType.dialog.closePopup,this.onClosePopupHandler)},methods:{onClick(){this.$emit("click");this.$emit("close")},onMouseOver(){clearTimeout(this.closeTimeout)},onMouseLeave(){this.setCloseTimer(2e3)},setCloseTimer(t){this.closeTimeout=setTimeout((()=>{this.$emit("close")}),t)},onClosePopup(){this.$emit("close")}},template:`\n\t\t<Transition name="bx-im-recent-new-user-popup">\n\t\t\t<div @click="onClick" @mouseover="onMouseOver" @mouseleave="onMouseLeave" class="bx-im-recent-new-user-popup">\n\t\t\t\t<div class="bx-im-recent-new-user-popup-title">{{ title }}</div>\n\t\t\t\t<div class="bx-im-recent-new-user-popup-text">{{ text }}</div>\n\t\t\t</div>\n\t\t</Transition>\n\t`};const p={name:"RecentItem",components:{Avatar:c.Avatar,ChatTitle:c.ChatTitle,NewUserPopup:u},props:{item:{type:Object,required:true},compactMode:{type:Boolean,default:false},isVisibleOnScreen:{type:Boolean,required:true}},data(){return{showNewUserPopup:false}},computed:{AvatarSize:()=>c.AvatarSize,formattedDate(){if(this.needsBirthdayPlaceholder){return this.$Bitrix.Loc.getMessage("IM_RECENT_BIRTHDAY_DATE")}return this.formatDate(this.item.message.date)},messageText(){const t=a.Parser.purifyRecent(this.item);if(!t){return this.isUser?this.$store.getters["users/getPosition"](this.item.dialogId):this.hiddenMessageText}return t},formattedMessageText(){const t=24;return d.Utils.text.insertUnseenWhitespace(this.messageText,t)},hiddenMessageText(){if(this.isUser){return this.$store.getters["users/getPosition"](this.item.dialogId)}if(this.dialog.type===m.DialogType.open){return this.$Bitrix.Loc.getMessage("IM_RECENT_CHAT_TYPE_OPEN")}return this.$Bitrix.Loc.getMessage("IM_RECENT_CHAT_TYPE_GROUP")},statusIcon(){if(!this.isLastMessageAuthor||this.isBot||this.needsBirthdayPlaceholder||!this.item.message){return""}if(this.isSelfChat){return""}if(this.item.message.status===m.MessageStatus.error){return"error"}if(this.item.liked){return"like"}if(this.item.message.status===m.MessageStatus.delivered){return"read"}return"unread"},formattedCounter(){return this.dialog.counter>99?"99+":this.dialog.counter},user(){return this.$store.getters["users/get"](this.item.dialogId,true)},dialog(){return this.$store.getters["dialogues/get"](this.item.dialogId,true)},currentUserId(){return this.$store.state.application.common.userId},isUser(){return this.dialog.type===m.DialogType.user},isChat(){return!this.isUser},isSelfChat(){return this.isUser&&this.user.id===this.currentUserId},isBot(){if(this.isUser){return this.user.bot}return false},isLastMessageAuthor(){if(!this.item.message){return false}return this.currentUserId===this.item.message.senderId},lastMessageAuthorAvatar(){const t=this.$store.getters["dialogues/get"](this.item.message.senderId);if(!t){return""}return t.avatar},lastMessageAuthorAvatarStyle(){return{backgroundImage:`url('${this.lastMessageAuthorAvatar}')`}},isChatMuted(){if(this.isUser){return false}const t=this.dialog.muteList.find((t=>t===this.currentUserId));return!!t},needsBirthdayPlaceholder(){if(!this.isUser){return false}return this.$store.getters["recent/needsBirthdayPlaceholder"](this.item.dialogId)},showBirthdays(){return this.$store.getters["recent/getOption"](m.RecentSettings.showBirthday)},showLastMessage(){return this.$store.getters["recent/getOption"](m.RecentSettings.showLastMessage)},invitation(){return this.item.invitation},newUserPopupContainer(){return`#popup-window-content-bx-im-recent-welcome-${this.item.dialogId}`}},watch:{invitation(t,e){if(!this.compactMode){return false}if(e.isActive===true&&t.isActive===false){this.openNewUserPopup()}}},methods:{openNewUserPopup(){if(!this.isVisibleOnScreen||BX.MessengerProxy.isSliderOpened()){return false}this.newUserPopup=this.getNewUserPopup();this.newUserPopup.show();this.showNewUserPopup=true;this.$nextTick((()=>{this.newUserPopup.setOffset({offsetTop:-this.newUserPopup.popupContainer.offsetHeight+1,offsetLeft:-this.newUserPopup.popupContainer.offsetWidth+13});this.newUserPopup.adjustPosition()}))},getNewUserPopup(){return o.PopupManager.create({id:`bx-im-recent-welcome-${this.item.dialogId}`,bindElement:this.$refs.container,bindOptions:{forceBindPosition:true},className:"bx-im-recent-welcome",cacheable:false,animation:{showClassName:"bx-im-recent-new-user-popup-show",closeClassName:"bx-im-recent-new-user-popup-hide",closeAnimationType:"animation"}})},onNewUserPopupClick(t){const e=!this.compactMode||t.altKey?m.OpenTarget.current:m.OpenTarget.auto;g.EventEmitter.emit(m.EventType.dialog.open,{...this.item,target:e})},onNewUserPopupClose(){this.newUserPopup.close();this.newUserPopup=null;this.showNewUserPopup=false},formatDate(t){const e=[["today","H:i"],["d7","D"],["","d.m.Y"]];return BX.date.format(e,t)}},template:`\n\t\t<div :data-id="item.dialogId" class="bx-im-recent-item-wrap">\n\t\t<div v-if="!compactMode" :class="{'bx-im-recent-item-no-text': !showLastMessage, 'bx-im-recent-item-pinned': item.pinned}" class="bx-im-recent-item">\n\t\t\t<div class="bx-im-recent-avatar-wrap">\n\t\t\t\t<Avatar :dialogId="item.dialogId" :size="AvatarSize.L" :withTyping="true"/>\n\t\t\t</div>\n\t\t\t<div class="bx-im-recent-item-content">\n\t\t\t\t<div class="bx-im-recent-item-content-header">\n\t\t\t\t\t<ChatTitle :dialogId="item.dialogId" :withMute="true" />\n\t\t\t\t\t<div class="bx-im-recent-date">\n\t\t\t\t\t\t<div v-if="statusIcon" :class="'bx-im-recent-status-icon bx-im-recent-status-icon-' + statusIcon"></div>\n\t\t\t\t\t\t{{ formattedDate }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-recent-item-content-bottom">\n\t\t\t\t\t<div class="bx-im-recent-message-text-wrap">\n\t\t\t\t\t\t\x3c!-- Message text --\x3e\n\t\t\t\t\t\t<span class="bx-im-recent-message-text">\n\t\t\t\t\t\t\t<template v-if="item.draft.text && dialog.counter === 0">\n\t\t\t\t\t\t\t\t<span class="bx-im-recent-draft-prefix">{{ $Bitrix.Loc.getMessage('IM_RECENT_MESSAGE_DRAFT_2', {'#TEXT#': ''}) }}</span>\n\t\t\t\t\t\t\t\t<span>{{ item.draft.text }}</span>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<template v-else-if="item.invitation.isActive">\n\t\t\t\t\t\t\t\t<span class="bx-im-recent-message-text-invitation">{{ $Bitrix.Loc.getMessage('IM_RECENT_INVITATION_NOT_ACCEPTED') }}</span>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<template v-else-if="needsBirthdayPlaceholder">\n\t\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_RECENT_BIRTHDAY') }}\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<template v-else-if="!showLastMessage">\n\t\t\t\t\t\t\t\t{{ hiddenMessageText }}\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t\t\t<span v-if="isLastMessageAuthor" class="bx-im-recent-last-message-author-icon-self"></span>\n\t\t\t\t\t\t\t\t<template v-else-if="isChat && item.message.senderId">\n\t\t\t\t\t\t\t\t\t<span v-if="lastMessageAuthorAvatar" :style="lastMessageAuthorAvatarStyle" class="bx-im-recent-last-message-author-icon-user"></span>\n\t\t\t\t\t\t\t\t\t<span v-else class="bx-im-recent-last-message-author-icon-user bx-im-recent-last-message-author-icon-user-default"></span>\n\t\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t\t\t<span>{{ formattedMessageText }}</span>\n\t\t\t\t\t\t\t</template>\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t\x3c!-- End message text --\x3e\n\t\t\t\t\t</div>\n\t\t\t\t\t<div :class="{'bx-im-recent-counter-static-wrap-extended': dialog.counter > 99}" class="bx-im-recent-counter-static-wrap">\n\t\t\t\t\t\t<div v-if="item.unread || item.pinned || dialog.counter > 0" class="bx-im-recent-counter-wrap">\n\t\t\t\t\t\t\t<div v-if="item.pinned && dialog.counter === 0 && !item.unread" class="bx-im-recent-pinned-icon"></div>\n\t\t\t\t\t\t\t<div v-if="dialog.counter > 0 && !isSelfChat" :class="{'bx-im-recent-counter-muted': isChatMuted}" class="bx-im-recent-counter">\n\t\t\t\t\t\t\t\t{{ formattedCounter }}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t<div v-else-if="item.unread" :class="{'bx-im-recent-counter-muted': isChatMuted}"  class="bx-im-recent-counter bx-im-recent-counter-unread"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t<div v-if="compactMode" class="bx-im-recent-item" :class="{'bx-im-recent-item-pinned': item.pinned, 'bx-im-recent-item-no-counter': dialog.counter === 0}" ref="container">\n\t\t\t<div class="bx-im-recent-avatar-wrap">\n\t\t\t\t<Avatar\n\t\t\t\t\t:dialogId="item.dialogId"\n\t\t\t\t\t:size="AvatarSize.M"\n\t\t\t\t\t:withStatus="false"\n\t\t\t\t\t:withCounter="true"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<template v-if="showNewUserPopup">\n\t\t\t\t<Teleport :to="newUserPopupContainer">\n\t\t\t\t\t<NewUserPopup :title="dialog.name" :text="$Bitrix.Loc.getMessage('IM_RECENT_NEW_USER_POPUP_TEXT')" @click="onNewUserPopupClick" @close="onNewUserPopupClose"/>\n\t\t\t\t</Teleport>\n\t\t\t</template>\n\t\t</div>\n\t\t</div>\n\t`};const v={name:"ActiveCall",components:{Avatar:c.Avatar},props:{item:{type:Object,required:true},compactMode:{type:Boolean,default:false}},emits:["click","contextmenu"],computed:{RecentCallStatus:()=>m.RecentCallStatus,AvatarSize:()=>c.AvatarSize,chatData(){return this.item.call.associatedEntity},isUser(){return this.chatData.advanced.chatType===m.DialogType.private},isTabWithActiveCall(){return this.getCallController().hasActiveCall()},avatarStyle(){return{backgroundImage:`url(${this.chatData.avatar})`}},avatarText(){return d.Utils.text.getFirstLetters(this.item.name)},isDarkTheme(){return this.application.options.darkTheme},formattedName(){return d.Utils.text.htmlspecialcharsback(this.item.name)},...r.mapState({application:t=>t.application})},methods:{onJoinClick(t){if(this.joinMenu){this.joinMenu.destroy()}this.joinMenu=this.getJoinMenu(t);this.joinMenu.show()},onHangupClick(){this.getCallController().leaveCurrentCall()},onClick(t){if(this.item.state===m.RecentCallStatus.joined){this.getCallController().unfold();return}const e=this.$store.getters["recent/get"](this.item.dialogId);if(!e){return}this.$emit("click",{item:e,$event:t})},onRightClick(){const t=this.$store.getters["recent/get"](this.item.dialogId);if(!t){return}this.$emit("contextmenu",{item:t,$event:event})},getJoinMenu(t){return o.MenuManager.create({id:"im-recent-active-call-join-menu",bindElement:t.target,darkMode:this.isDarkTheme,cacheable:false,items:[{text:h.Loc.getMessage("IM_RECENT_ACTIVE_CALL_JOIN_VIDEO"),onclick:function(){this.getCallController().joinCall(this.item.call.id,true);this.joinMenu.close()}.bind(this)},{text:h.Loc.getMessage("IM_RECENT_ACTIVE_CALL_JOIN_AUDIO"),onclick:function(){this.getCallController().joinCall(this.item.call.id,false);this.joinMenu.close()}.bind(this)}]})},getCallController(){return BX.MessengerProxy.getCallController()}},template:`\n\t\t<div :data-id="item.dialogId" class="bx-im-recent-item-wrap">\n\t\t<div v-if="!compactMode" @click="onClick" @click.right.prevent="onRightClick" class="bx-im-recent-item bx-im-recent-active-call-item">\n\t\t\t<div class="bx-im-recent-avatar-wrap">\n\t\t\t\t<Avatar :dialogId="item.dialogId" :size="AvatarSize.L" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-recent-item-content">\n\t\t\t\t\x3c!-- Waiting status --\x3e\n\t\t\t\t<template v-if="item.state === RecentCallStatus.waiting">\n\t\t\t\t\t\x3c!-- 1-on-1 --\x3e\n\t\t\t\t\t<div v-if="isUser"  class="bx-im-recent-active-call-waiting-content">\n\t\t\t\t\t\t<div class="bx-im-recent-active-call-icon bx-im-recent-active-call-waiting-icon"></div>\n\t\t\t\t\t\t<div class="bx-im-recent-active-call-waiting-title">\n\t\t\t\t\t\t\t{{ formattedName }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\x3c!-- Chat --\x3e\n\t\t\t\t\t<div v-else>\n\t\t\t\t\t\t<div class="bx-im-recent-item-content-header">\n\t\t\t\t\t\t\t<div class="bx-im-recent-active-call-icon bx-im-recent-active-call-waiting-icon"></div>\n\t\t\t\t\t\t\t<span class="bx-im-recent-active-call-waiting-title" :title="formattedName">\n\t\t\t\t\t\t\t\t{{ formattedName }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="bx-im-recent-item-content-bottom">\n\t\t\t\t\t\t\t<div @click.stop="onJoinClick" class="bx-im-recent-active-call-button bx-im-recent-active-call-join-button">\n\t\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_RECENT_ACTIVE_CALL_JOIN') }}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t\t\x3c!-- Joined status --\x3e\n\t\t\t\t<template v-else-if="item.state === RecentCallStatus.joined">\n\t\t\t\t\t\x3c!-- 1-on-1 --\x3e\n\t\t\t\t\t<div v-if="isUser || !isTabWithActiveCall" class="bx-im-recent-active-call-joined-content">\n\t\t\t\t\t\t<div class="bx-im-recent-active-call-icon bx-im-recent-active-call-joined-icon"></div>\n\t\t\t\t\t\t<div class="bx-im-recent-active-call-joined-title">\n\t\t\t\t\t\t\t{{ formattedName }}\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t\x3c!-- Chat --\x3e\n\t\t\t\t\t<div v-else-if="!isUser && isTabWithActiveCall">\n\t\t\t\t\t\t<div class="bx-im-recent-item-content-header">\n\t\t\t\t\t\t\t<div class="bx-im-recent-active-call-icon bx-im-recent-active-call-joined-icon"></div>\n\t\t\t\t\t\t\t<span class="bx-im-recent-active-call-joined-title" :title="formattedName">\n\t\t\t\t\t\t\t\t{{ formattedName }}\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="bx-im-recent-item-content-bottom">\n\t\t\t\t\t\t\t<div @click.stop="onHangupClick" class="bx-im-recent-active-call-button bx-im-recent-active-call-hangup-button">\n\t\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_RECENT_ACTIVE_CALL_HANGUP') }}\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</template>\n\t\t\t</div>\n\t\t</div>\n\t\t<div v-if="compactMode" @click="onClick" @click.right.prevent="onRightClick" class="bx-im-recent-item bx-im-recent-active-call-item">\n\t\t\t<div class="bx-im-recent-avatar-wrap">\n\t\t\t\t<Avatar :dialogId="item.dialogId" :size="AvatarSize.M" />\n\t\t\t\t<div class="bx-im-recent-active-call-compact-icon-container">\n\t\t\t\t\t<div v-if="item.state === RecentCallStatus.waiting" class="bx-im-recent-active-call-icon bx-im-recent-active-call-waiting-icon"></div>\n\t\t\t\t\t<div v-else-if="item.state === RecentCallStatus.joined" class="bx-im-recent-active-call-icon bx-im-recent-active-call-joined-icon"></div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t\t</div>\n\t`};class b{static init(t){if(this.instance){return}this.instance=new this(t)}constructor(t){this.store=null;this.store=t.Data.get("controller").store;this.initSettings();this.onSettingsChangeHandler=this.onSettingsChange.bind(this);g.EventEmitter.subscribe(m.EventType.dialog.settingsChange,this.onSettingsChangeHandler);if(d.Utils.platform.isBitrixDesktop()&&!h.Type.isUndefined(BX.desktop)){BX.desktop.addCustomEvent("bxSaveSettings",(t=>{this.onSettingsChangeHandler({data:t})}))}}initSettings(){if(!BX.MessengerProxy){console.error("Im.RecentList: SettingsManager: BX.MessengerProxy is not available");return false}this.initGeneralSettings();this.initRecentSettings()}initGeneralSettings(){const t={};Object.entries(m.SettingsMap).forEach((([e,i])=>{t[i]=BX.MessengerProxy.getOption(e)}));this.store.dispatch("application/setOptions",t)}initRecentSettings(){const t={};Object.entries(m.RecentSettingsMap).forEach((([e,i])=>{t[i]=BX.MessengerProxy.getOption(e)}));this.store.dispatch("recent/setOptions",t)}onSettingsChange({data:t}){l.Logger.warn("Im.RecentList: SettingsChange",t);const e={};const i={};Object.entries(t).forEach((([t,s])=>{if(Object.keys(m.RecentSettingsMap).includes(t)){i[m.RecentSettingsMap[t]]=s}if(Object.keys(m.SettingsMap).includes(t)){e[m.SettingsMap[t]]=s}}));this.store.dispatch("application/setOptions",e);this.store.dispatch("recent/setOptions",i)}destroy(){g.EventEmitter.unsubscribe(m.EventType.dialog.settingsChange,this.onSettingsChangeHandler)}}b.instance=null;class C extends g.EventEmitter{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}constructor(){super();this.setEventNamespace(C.eventNamespace);this.init()}isSupported(){return!h.Type.isUndefined(window.BroadcastChannel)&&!d.Utils.platform.isBitrixDesktop()}init(){if(!this.isSupported()){return}this.channel=new BroadcastChannel(C.channelName);this.channel.addEventListener("message",(({data:{type:t,data:e}})=>{this.emit(t,e)}))}sendRecentList(t){if(!this.isSupported()){return}this.channel.postMessage({type:C.events.recentListUpdate,data:t})}}C.instance=null;C.channelName="im-recent";C.eventNamespace="BX.Messenger.Embedding.Recent.BroadcastManager";C.events={recentListUpdate:"recentListUpdate"};class f{static init(t){if(this.instance){return}this.instance=new this(t)}constructor(t){this.store=null;this.store=t.Data.get("controller").store;this.onCallCreatedHandler=this.onCallCreated.bind(this);g.EventEmitter.subscribe("CallEvents::callCreated",this.onCallCreatedHandler)}onCallCreated(t){const{call:e}=t.getData()[0];e.addEventListener(BX.Call.Event.onJoin,this.onCallJoin.bind(this));e.addEventListener(BX.Call.Event.onLeave,this.onCallLeave.bind(this));e.addEventListener(BX.Call.Event.onDestroy,this.onCallDestroy.bind(this));this.store.dispatch("recent/addActiveCall",{dialogId:e.associatedEntity.id,name:e.associatedEntity.name,call:e,state:m.RecentCallStatus.waiting})}onCallJoin(t){this.store.dispatch("recent/updateActiveCall",{dialogId:t.call.associatedEntity.id,fields:{state:m.RecentCallStatus.joined}})}onCallLeave(t){this.store.dispatch("recent/updateActiveCall",{dialogId:t.call.associatedEntity.id,fields:{state:m.RecentCallStatus.waiting}})}onCallDestroy(t){this.store.dispatch("recent/deleteActiveCall",{dialogId:t.call.associatedEntity.id})}destroy(){g.EventEmitter.unsubscribe(window,"CallEvents::callCreated",this.onCallCreatedHandler)}}f.instance=null;class x{static init(t){if(this.instance){return}this.instance=new this(t)}constructor(t){this.store=null;this.store=t.Data.get("controller").store;this.initDraftHistory();this.onSetDraftHandler=this.onSetDraft.bind(this);g.EventEmitter.subscribe(m.EventType.recent.setDraftMessage,this.onSetDraftHandler)}initDraftHistory(){if(!BX.MessengerProxy){return false}const t=BX.MessengerProxy.getTextareaHistory();Object.entries(t).forEach((([t,e])=>{this.setDraftMessage(t,e)}))}onSetDraft({data:{dialogId:t,text:e}}){this.setDraftMessage(t,e)}setDraftMessage(t,e){this.store.dispatch("recent/draft",{id:t,text:e})}destroy(){g.EventEmitter.unsubscribe(m.EventType.recent.setDraftMessage,this.onSetDraftHandler)}}x.instance=null;class M{static init(t){if(this.instance){return}this.instance=new this(t)}constructor(t){this.store=null;this.store=t.Data.get("controller").store;this.subscribeToEvents()}subscribeToEvents(){this.onSetCounterHandler=this.onSetCounter.bind(this);this.onSetMessageHandler=this.onSetMessage.bind(this);this.onHideChatHandler=this.onHideChat.bind(this);this.onLeaveChatHandler=this.onLeaveChat.bind(this);this.onClearLikeHandler=this.onClearLike.bind(this);this.onClearHistoryHandler=this.onClearHistory.bind(this);g.EventEmitter.subscribe(m.EventType.recent.setCounter,this.onSetCounterHandler);g.EventEmitter.subscribe(m.EventType.recent.setMessage,this.onSetMessageHandler);g.EventEmitter.subscribe(m.EventType.recent.hideChat,this.onHideChatHandler);g.EventEmitter.subscribe(m.EventType.recent.leaveChat,this.onLeaveChatHandler);g.EventEmitter.subscribe(m.EventType.recent.clearLike,this.onClearLikeHandler);g.EventEmitter.subscribe(m.EventType.dialog.clearHistory,this.onClearHistoryHandler)}onSetCounter({data:{dialogId:t,counter:e}}){const i=this.store.getters["recent/get"](t);const s=this.store.getters["dialogues/get"](t);if(!i||!s){return false}this.store.dispatch("dialogues/update",{dialogId:t,fields:{counter:e}})}onSetMessage({data:{id:t,dialogId:e,text:i,date:s}}){const n=this.store.getters["recent/get"](e);const a=this.store.getters["dialogues/get"](e);if(!n||!a){return false}if(t&&!t.toString().startsWith("temp")&&t!==n.message.id){return false}this.store.dispatch("recent/update",{id:e,fields:{message:{id:t||0,text:i,senderId:this.getCurrentUserId(),status:n.message.status,date:s||n.message.date}}})}onHideChat({data:{dialogId:t}}){const e=this.store.getters["recent/get"](t);if(!e){return false}this.store.dispatch("recent/delete",{id:t})}onLeaveChat({data:{dialogId:t}}){this.onHideChat({data:{dialogId:t}})}onClearLike({data:{dialogId:t}}){const e=this.store.getters["recent/get"](t);if(!e||!e.liked){return false}this.store.dispatch("recent/like",{id:t,liked:false})}onClearHistory({data:{dialogId:t}}){const e=this.store.getters["recent/get"](t);if(!e){return false}this.store.dispatch("recent/update",{id:t,fields:{message:{...e.message,text:h.Loc.getMessage("IM_RECENT_DELETED_MESSAGE")}}})}getCurrentUserId(){return this.store.state.application.common.userId}destroy(){this.unsubscribeEvents()}unsubscribeEvents(){g.EventEmitter.unsubscribe(m.EventType.recent.setCounter,this.onSetCounterHandler);g.EventEmitter.unsubscribe(m.EventType.recent.setMessage,this.onSetMessageHandler);g.EventEmitter.unsubscribe(m.EventType.recent.hideChat,this.onHideChatHandler);g.EventEmitter.unsubscribe(m.EventType.recent.leaveChat,this.onLeaveChatHandler);g.EventEmitter.unsubscribe(m.EventType.recent.clearLike,this.onClearLikeHandler)}}M.instance=null;const E={name:"RecentList",components:{LoadingState:c.RecentLoadingState,RecentItem:p,ActiveCall:v},directives:{"recent-list-observer":{mounted(t,e){e.instance.observer.observe(t)}}},props:{compactMode:{type:Boolean,default:false}},data(){return{isLoading:false,visibleElements:new Set}},computed:{collection(){return this.$store.getters["recent/getRecentCollection"]},sections(){return[this.pinnedItems,this.generalItems]},preparedItems(){const t=this.collection.filter((t=>{if(!this.showBirthdays&&t.options.birthdayPlaceholder){return false}const e=this.$store.getters["dialogues/get"](t.dialogId,true);const i=e.type===m.DialogType.user;const s=i&&this.showBirthdays&&this.$store.getters["users/hasBirthday"](t.dialogId);if(!this.showInvited&&t.options.defaultUserRecord&&!s){return false}return true}));return[...t].sort(((t,e)=>{const i=this.$store.getters["recent/getMessageDate"](t.dialogId);const s=this.$store.getters["recent/getMessageDate"](e.dialogId);return s-i}))},pinnedItems(){return this.preparedItems.filter((t=>t.pinned===true))},generalItems(){return this.preparedItems.filter((t=>t.pinned===false))},isDarkTheme(){return this.application.options.darkTheme},showBirthdays(){return this.$store.getters["recent/getOption"](m.RecentSettings.showBirthday)},showInvited(){return this.$store.getters["recent/getOption"](m.RecentSettings.showInvited)},transitionType(){if(this.compactMode){return""}if(this.isLoading){return""}return"bx-messenger-recent-transition"},...r.mapState({activeCalls:t=>t.recent.activeCalls,application:t=>t.application})},created(){this.recentService=i.RecentService.getInstance();this.contextMenuManager=new s.RecentMenu(this.$Bitrix);f.init(this.$Bitrix);M.init(this.$Bitrix);b.init(this.$Bitrix);this.initBroadcastManager();this.initObserver();this.initBirthdayCheck();this.manageChatOptions();this.managePreloadedList();this.isLoading=true;const t=!this.compactMode;this.recentService.loadFirstPage({ignorePreloadedItems:t}).then((()=>{this.isLoading=false;x.init(this.$Bitrix)}))},beforeUnmount(){this.contextMenuManager.destroy();this.clearBirthdayCheck();this.destroyBroadcastManager()},methods:{onScroll(t){this.contextMenuManager.close();if(!this.oneScreenRemaining(t)||!this.recentService.hasMoreItemsToLoad){return false}this.isLoading=true;this.recentService.loadNextPage().then((()=>{this.isLoading=false}))},onClick(t,e){const i=!this.compactMode||e.altKey?m.OpenTarget.current:m.OpenTarget.auto;g.EventEmitter.emit(m.EventType.dialog.open,{...t,chat:this.$store.getters["dialogues/get"](t.dialogId,true),user:this.$store.getters["users/get"](t.dialogId,true),target:i})},onRightClick(t,e){if(e.altKey&&e.shiftKey){return}const i=!this.compactMode||e.altKey?m.OpenTarget.current:m.OpenTarget.auto;const s={...t,compactMode:this.compactMode,target:i};this.contextMenuManager.openMenu(s,e.currentTarget);e.preventDefault()},onCallClick({item:t,$event:e}){this.onClick(t,e)},onCallRightClick({item:t,$event:e}){this.onRightClick(t,e)},oneScreenRemaining(t){return t.target.scrollTop+t.target.clientHeight>=t.target.scrollHeight-t.target.clientHeight},initObserver(){this.observer=new IntersectionObserver((t=>{t.forEach((t=>{if(t.isIntersecting&&t.intersectionRatio===1){this.visibleElements.add(t.target.dataset.id)}else if(!t.isIntersecting){this.visibleElements.delete(t.target.dataset.id)}}))}),{threshold:[0,1]})},initBroadcastManager(){this.onRecentListUpdate=t=>{this.recentService.setPreloadedData(t.data)};this.broadcastManager=C.getInstance();this.broadcastManager.subscribe(C.events.recentListUpdate,this.onRecentListUpdate)},destroyBroadcastManager(){this.broadcastManager=C.getInstance();this.broadcastManager.unsubscribe(C.events.recentListUpdate,this.onRecentListUpdate)},initBirthdayCheck(){const t=6e4*60*4;const e=6e4*60*24;this.birthdayCheckTimeout=setTimeout((()=>{this.recentService.loadFirstPage({ignorePreloadedItems:true});this.birthdayCheckInterval=setInterval((()=>{this.recentService.loadFirstPage({ignorePreloadedItems:true})}),e)}),d.Utils.date.getTimeToNextMidnight()+t)},clearBirthdayCheck(){clearTimeout(this.birthdayCheckTimeout);clearInterval(this.birthdayCheckInterval)},managePreloadedList(){const{preloadedList:t}=this.$Bitrix.Application.get().params;if(!t){return false}this.recentService.setPreloadedData(t);this.broadcastManager.sendRecentList(t)},manageChatOptions(){const{chatOptions:t}=this.$Bitrix.Application.get().params;if(!t){return false}this.$store.dispatch("dialogues/setChatOptions",t)}},template:`\n\t\t<div @scroll="onScroll" class="bx-messenger-recent-list" :class="{'bx-messenger-recent-compact': compactMode}" >\n\t\t\t<transition-group :name="transitionType">\n\t\t\t\t<ActiveCall\n\t\t\t\t\tv-for="activeCall in activeCalls"\n\t\t\t\t\t:key="'call-' + activeCall.dialogId"\n\t\t\t\t\t:item="activeCall"\n\t\t\t\t\t:compactMode="compactMode"\n\t\t\t\t\t@click="onCallClick"\n\t\t\t\t\t@click.right="onCallRightClick"\n\t\t\t\t/>\n\t\t\t\t<template v-for="section in sections">\n\t\t\t\t\t<RecentItem\n\t\t\t\t\t\tv-for="item in section"\n\t\t\t\t\t\t:key="item.dialogId"\n\t\t\t\t\t\t:item="item"\n\t\t\t\t\t\t:compactMode="compactMode"\n\t\t\t\t\t\t:isVisibleOnScreen="visibleElements.has(item.dialogId)"\n\t\t\t\t\t\tv-recent-list-observer\n\t\t\t\t\t\t@click="onClick(item, $event)"\n\t\t\t\t\t\t@click.right="onRightClick(item, $event)"\n\t\t\t\t\t/>\n\t\t\t\t</template>\n\t\t\t</transition-group>\n\t\t\t<LoadingState v-if="isLoading" :compactMode="compactMode" />\n\t\t\t<template v-if="collection.length === 0">\n\t\t\t\t<div class="bx-im-recent-empty">{{ $Bitrix.Loc.getMessage('IM_RECENT_EMPTY') }}</div>\n\t\t\t</template>\n\t\t</div>\n\t`};t.RecentList=E})(this.BX.Messenger.Embedding.ComponentLegacy=this.BX.Messenger.Embedding.ComponentLegacy||{},BX,BX.Messenger.Embedding.Provider.Service,BX.Messenger.Embedding.LibLegacy,BX.Main,BX.Messenger.v2.Lib,BX.Vue3.Vuex,BX.Main,BX.Messenger.Embedding.ComponentLegacy,BX.Messenger.Embedding.Lib,BX.Messenger.Embedding.Lib,BX,BX.Event,BX.Messenger.Embedding.Const);
//# sourceMappingURL=recent-list.bundle.map.js