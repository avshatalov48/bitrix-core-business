<? namespace Bitrix\Main\Security\W;$GLOBALS['____1619925626']= array(base64_decode('dG'.'l'.'tZQ=='),base64_decode('dGlt'.'Z'.'Q=='),base64_decode('anNvbl9kZ'.'WNvZGU='),base64_decode('YXJyYX'.'lfb'.'W'.'VyZ2U='),base64_decode('am9p'.'bg='.'='),base64_decode('am9pbg=='),base64_decode(''.'am'.'9pb'.'g=='),base64_decode(''.'Y'.'XJy'.'YX'.'lfc'.'G9w'),base64_decode(''.'YXJ'.'yYX'.'lf'.'c2'.'hpZnQ='),base64_decode('YX'.'Jy'.'YX'.'lfc2hp'.'Z'.'n'.'Q='),base64_decode('YX'.'JyYXlfc'.'2'.'h'.'pZnQ='),base64_decode(''.'YX'.'JyY'.'Xlfc'.'2hpZn'.'Q='),base64_decode('YXJy'.'YXlf'.'bWVy'.'Z'.'2U='),base64_decode('a'.'XNfYXJyYXk='),base64_decode('YX'.'JyYXlfbWVy'.'Z2U='),base64_decode('aW5fY'.'XJyY'.'Xk='),base64_decode('aW'.'5'.'fY'.'X'.'JyYXk='),base64_decode('aW5f'.'Y'.'XJyYXk='),base64_decode('a'.'W5fYX'.'JyYXk='),base64_decode('aW5fYX'.'JyYX'.'k='),base64_decode('dGltZQ=='),base64_decode(''.'d'.'GltZQ='.'='),base64_decode('YXJyYXl'.'fbWF'.'w'),base64_decode('Z2V0X2'.'x'.'vYW'.'RlZ'.'F9leH'.'R'.'lb'.'nNpb25z'),base64_decode('anNvbl9'.'lbmNvZGU='),base64_decode('anN'.'vb'.'l9lbmNvZ'.'G'.'U='),base64_decode('c'.'GhwdmVyc'.'2lvbg'.'=='),base64_decode('a'.'n'.'Nvbl9'.'lbm'.'NvZGU='),base64_decode('a'.'m9p'.'bg='.'='));if(!function_exists(__NAMESPACE__.'\\___945166015')){function ___945166015($_1286419393){static $_950272580= false; if($_950272580 == false) $_950272580=array('V1dB'.'TExfTE9DSw==','c'.'2VjdXJ'.'pdH'.'k=',''.'REF'.'UQQ==',''.'e'.'yI'.'=','V1dBTExfT'.'E9D'.'Sw==',''.'c2VjdXJ'.'pdHk'.'=',''.'U0'.'VDVVJJVFl'.'fV1dBTExf'.'RVhD'.'RVBUSU9O','RkF'.'J'.'TF9DSEVDS0lORw='.'=','Q2FuI'.'G5vd'.'CBl'.'eGVjdXRlIHd3YW'.'xsI'.'HJ1b'.'GVzO'.'iA=','IF'.'RyYW'.'Nl'.'OiA=',''.'U'.'kVRV'.'UVT'.'VF9VUkk'.'=','a2'.'V5c'.'w==',''.'dmFsdWVz','U'.'0'.'VDVV'.'J'.'JV'.'FlfV1dB'.'TExfTU'.'9ESUZZ','Lg==','U0V'.'D'.'VVJJV'.'FlfV'.'1dBTEx'.'f'.'VU5TRVQ=','Lg==','U0'.'VDVVJJVFl'.'f'.'V1dBTExf'.'RVhJVA==','L'.'g==','Z2xvYmFs','a2'.'V5c'.'w'.'==','dmFs'.'dWV'.'z',''.'Z2V'.'0',''.'Z2V'.'0','cG'.'9'.'zdA==','cG9zdA'.'==','Y'.'29va2ll','Y29'.'va2l'.'l','cmV'.'xdWVz'.'dA==','cmVx'.'dWVzdA='.'=','Z2xvYmFs','Z2'.'xvYm'.'F'.'s','bWF'.'pbl9'.'z'.'ZWM=',''.'V1d'.'B'.'TExfQ'.'UN'.'UVUFMSVpFX1J'.'VTEVT','dg==','dm'.'Vyc'.'2l'.'vbg==','a'.'Q==','a'.'X'.'NJbn'.'N0YWx'.'sZW'.'Q'.'=','d'.'g==','aW5p','bW'.'9k'.'dWxlcw'.'==','bGljZ'.'W'.'5zZQ='.'=',''.'cGh'.'w','dg==','ZXh0','c2V'.'j'.'dXJpd'.'Hk=','ZGI=','dHlw'.'ZQ==','Z'.'GI=','dmVyc2lvbg==','Z'.'GI=',''.'dH'.'lwZ'.'Q==','Z'.'GI=','dHlw'.'ZQ==','dmVyc2lvb'.'g==','ZGI=','dmV'.'yc'.'2'.'lvb'.'g==','ZW5'.'2'.'a'.'X'.'Jvb'.'m1'.'lbnQ=','dm1'.'fd'.'mVyc2l'.'vbg='.'=','dm'.'0=','d'.'g='.'=','ZW52aXJv'.'bm1lbn'.'Q=','dm1fd'.'mV'.'yc2lvbg'.'==','c29ja2'.'V0'.'VG'.'lt'.'ZW91'.'d'.'A==','c3'.'RyZ'.'WFtV'.'GltZW9'.'1dA==','KCc=','Z'.'GF0'.'YQ==','JywgJw='.'=',''.'bW9kdWx'.'l','J'.'ywgJw==',''.'bW9kdWx'.'lX3Zlc'.'n'.'N'.'pb24=',''.'Jyk=','LC'.'A=','U0'.'V'.'DV'.'VJJ'.'VFlf'.'V1dB'.'T'.'ExfRV'.'hDR'.'VBU'.'S'.'U'.'9O','bWFpbg==','RkFJ'.'TF9SRUZSR'.'V'.'NIS'.'U5'.'H','Q2FuIG'.'5'.'vdCByZ'.'W'.'ZyZX'.'NoIHd3YWxsIH'.'J1bGVzOi'.'A=','I'.'FRyYWN'.'lOiA=','ZGF0YQ==','eyI'.'=','LS0tLS1CRUdJT'.'iBQVUJMSU'.'Mg'.'S0VZLS0tLS0=','C'.'k1J'.'SU'.'JJakFO'.'Q'.'mdr'.'cWhr'.'aU'.'c5dzBCQVFFRkFBT0NBUT'.'hBTUlJQkNnS0NBUUV'.'B'.'cThR'.'RTBIam'.'1ISlVT'.'dFdWN'.'m4wemEKUl'.'ZvTHg'.'wMkt6YmZyYl'.'M'.'vUDZzV'.'2'.'F4VHp3O'.'FNl'.'R'.'1R0YlRDT3'.'JwSGk1UUY'.'2T'.'1J'.'5alovWHh6'.'L'.'0tMVTF'.'HYm9mOUNaMwo0'.'ejdTa3FVdDY2aWJY'.'dk9G'.'Qng0ZncvQV'.'B'.'QUk'.'dEcXRtM'.'G5EM2Z'.'nR3N1'.'M1JlU'.'Gd'.'3MjlpOCt2bTdtdEJLS'.'lVZbDR'.'yClZ'.'wYjZ'.'zZlpFVDlL'.'RW'.'I2VDFIRFltRXZj'.'MWhx'.'L2lpd'.'Xl4TH'.'J'.'aWm'.'k1U'.'TZVZmY0VU'.'V2VEkrNjhzc'.'0'.'ZSa1E'.'rb3dU'.'U'.'n'.'kK'.'ZU9JTWJGa'.'E'.'0'.'vVVR'.'tZl'.'ZZYlRSR'.'nky'.'b1'.'VROFdNemEybko1U'.'2F'.'oemkx'.'VUtP'.'MWp'.'Bal'.'hU'.'U'.'FJyemM'.'3QWp1NjM5aj'.'FPMA'.'p'.'wc'.'HFmb'.'T'.'V4Z1dsRk'.'FKa0hR'.'VGdiZGQ'.'1QVdxRE'.'ZR'.'a3Q5S'.'EtrWStU'.'bmZCT'.'EdW'.'TXZWeVB'.'3VE'.'hOV1FZ'.'Q'.'Xc'.'0eHBnL3dBClp3SURBUUFCCi'.'0tLS0t'.'RU5EIF'.'BV'.'Q'.'kxJQ'.'yBLR'.'VktLS0t'.'LQ='.'=');return base64_decode($_950272580[$_1286419393]);}}; use Bitrix\Main\Application; use Bitrix\Main\Config\Option; use Bitrix\Main\Data\Cache; use Bitrix\Main\Loader; use Bitrix\Main\ModuleManager; use Bitrix\Main\Security\PublicKeyCipher; use Bitrix\Main\SystemException; use Bitrix\Main\Web\HttpClient; use Bitrix\Main\Web\Json; use Bitrix\Main\Security\W\Rules\Rule; use Bitrix\Main\Security\W\Rules\Results\RuleAction; use Bitrix\Main\Security\W\Rules\Results\RuleResult; use Bitrix\Main\Security\W\Rules\Results\CheckResult; use Bitrix\Main\Security\W\Rules\Results\ModifyResult; use Bitrix\Main\Type\ArrayHelper; use Bitrix\Main\Security\W\Rules\RuleRecordTable; use CSecuritySystemInformation; use ReflectionExtension; class WWall{ const CACHE_RULES_TTL= 10800; private static $_1838228423= 'https://wwall.bitrix.info/rules.php'; protected $_1790303479= true; public function handle(){ try{  $_235459768= RuleRecordTable::getList([ 'cache' =>['ttl' => 3600* 24* 7]])->fetchAll(); if(empty($_235459768)){ return;}  $_167346844= Cache::createInstance(); $_427635432= false; if($_167346844->initCache(static::CACHE_RULES_TTL, 'WWALL_LOCK', 'security')){ $_1403551370= $_167346844->getVars(); if($GLOBALS['____1619925626'][0]()- $_1403551370> round(0+5+5+5+5)){  $_1998912322= Application::getConnection(); $_1149328754= RuleRecordTable::getTableName(); $_1998912322->truncateTable($_1149328754); RuleRecordTable::cleanCache(); $_167346844->clean(___945166015(0), ___945166015(1));}} elseif($_167346844->startDataCache()){  $_167346844->endDataCache($GLOBALS['____1619925626'][1]()); $_427635432= true;} foreach($_235459768 as $_656448172){ $_948582901= new PublicKeyCipher; $_480802383= $_948582901->decrypt($_656448172[___945166015(2)], static::__1346308139()); if(!str_starts_with($_480802383, ___945166015(3))){ continue;} $_805214841= $GLOBALS['____1619925626'][2]($_480802383, true); if(!empty($_805214841)){ $_498140423= Rule::make($_805214841); $_1083860117= $this->handleRule($_498140423); $this->applyHandlingResults($_1083860117);}}  if($_427635432){ $_167346844->clean(___945166015(4), ___945166015(5));}} catch(\Throwable $_507736108){ $this->logEvent( ___945166015(6), ___945166015(7), ___945166015(8). $_507736108->getMessage(). ___945166015(9). $_507736108->getTraceAsString());}}  public function handleRule(Rule $_498140423): array{ $_1083860117=[]; if($_498140423->matchPath($_SERVER[___945166015(10)])){  $_698307269= $this->getContextElements($_498140423->getContext()); foreach($_698307269 as $_768308972 => &$_1267307630){ $_1083860117= $GLOBALS['____1619925626'][3]($_1083860117, $this->recursiveContextKeyHandle($_768308972, $_1267307630,[], $_498140423));}} return $_1083860117;}  public function applyHandlingResults(array $_1083860117){ $_698307269= $this->getContextElements([ 'get', 'post', 'cookie', 'request', 'global']); foreach($_1083860117 as $_969185680){ $_1267307630=& $_698307269[$_969185680->getContextName()]; $_1277745795= $_969185680->getRuleResult(); $_498140423= $_969185680->getRule(); if($_1277745795 instanceof ModifyResult){ if($_498140423->getProcess() === ___945166015(11)){  static::rewriteContextKey( $_969185680->getContextName(), $_1267307630, $_969185680->getContextKey(), $_1277745795->getCleanValue());} elseif($_498140423->getProcess() === ___945166015(12)){ static::rewriteContextValue( $_969185680->getContextName(), $_1267307630, $_969185680->getContextKey(), $_1277745795->getCleanValue());} $this->logEvent( ___945166015(13), $_969185680->getContextName(), $GLOBALS['____1619925626'][4](___945166015(14), $_969185680->getContextKey()));} elseif($_1277745795 instanceof CheckResult &&!$_1277745795->isSuccess()){ if($_1277745795->getAction() === RuleAction::UNSET){ static::unsetContextValue( $_969185680->getContextName(), $_1267307630, $_969185680->getContextKey(),); $this->logEvent( ___945166015(15), $_969185680->getContextName(), $GLOBALS['____1619925626'][5](___945166015(16), $_969185680->getContextKey()));} elseif($_1277745795->getAction() === RuleAction::EXIT){ $this->logEvent( ___945166015(17), $_969185680->getContextName(), $GLOBALS['____1619925626'][6](___945166015(18), $_969185680->getContextKey())); exit;}}}} public function disableEventLogging(){ $this->_1790303479= false;} protected function rewriteContextKey($_768308972, &$_1267307630, $_1381580795, $_895211075){ $_827659746= $_1381580795;  $GLOBALS['____1619925626'][7]($_827659746); $_827659746[]= $_895211075; if($_768308972 === ___945166015(19)){ $_806837241= $GLOBALS['____1619925626'][8]($_1381580795); $GLOBALS['____1619925626'][9]($_827659746); if(empty($_1381580795)){ $GLOBALS[$_895211075]= $GLOBALS[$_806837241]; unset($GLOBALS[$_806837241]);} else{ $_1267307630=& $GLOBALS[$_806837241]; $_402479840= ArrayHelper::getByNestedKey($_1267307630, $_1381580795);  ArrayHelper::setByNestedKey($_1267307630, $_827659746, $_402479840);  ArrayHelper::unsetByNestedKey($_1267307630, $_1381580795);}} else{ $_402479840= ArrayHelper::getByNestedKey($_1267307630, $_1381580795);  ArrayHelper::setByNestedKey($_1267307630, $_827659746, $_402479840);  ArrayHelper::unsetByNestedKey($_1267307630, $_1381580795);}} protected function rewriteContextValue($_768308972, &$_1267307630, $_190839214, $_402479840){ if($_768308972 === 'global'){ $_806837241= $GLOBALS['____1619925626'][10]($_190839214); if(empty($_190839214)){ $GLOBALS[$_806837241]= $_402479840;} else{ $_1267307630=& $GLOBALS[$_806837241]; ArrayHelper::setByNestedKey($_1267307630, $_190839214, $_402479840);}} else{  ArrayHelper::setByNestedKey($_1267307630, $_190839214, $_402479840);}} protected function unsetContextValue($_768308972, &$_1267307630, $_190839214){ if($_768308972 === 'global'){ $_806837241= $GLOBALS['____1619925626'][11]($_190839214); if(empty($_190839214)){ unset($GLOBALS[$_806837241]);} else{ $_1267307630=& $GLOBALS[$_806837241]; ArrayHelper::unsetByNestedKey($_1267307630, $_190839214);}} else{ ArrayHelper::unsetByNestedKey($_1267307630, $_190839214);}}  protected function recursiveContextKeyHandle(string $_768308972, array &$_1267307630, array $_1869236039, Rule $_498140423): array{  $_1083860117=[]; foreach($_1267307630 as $_726836853 => $_402479840){ $_190839214= $GLOBALS['____1619925626'][12]($_1869236039,[$_726836853]); if($_498140423->matchKey($_190839214)){  if($_498140423->getProcess() === ___945166015(20)){ $_1277745795= $_498140423->evaluate($_726836853);} elseif($_498140423->getProcess() === ___945166015(21)){ $_1277745795= $_498140423->evaluateValue($_402479840);}  if(!empty($_1277745795) && $_1277745795 instanceof RuleResult){ $_1083860117[]= new HandlingResult($_768308972, $_190839214, $_1277745795, $_498140423);}}  if($GLOBALS['____1619925626'][13]($_402479840)){ $_1083860117= $GLOBALS['____1619925626'][14]($_1083860117, $this->recursiveContextKeyHandle( $_768308972, $_1267307630[$_726836853], $_190839214, $_498140423));}} return $_1083860117;} protected function getContextElements(array $_1673760825){ $_54982486=[]; if($GLOBALS['____1619925626'][15](___945166015(22), $_1673760825, true)){ $_54982486[___945166015(23)]= &$_GET;} if($GLOBALS['____1619925626'][16](___945166015(24), $_1673760825, true)){ $_54982486[___945166015(25)]= &$_POST;} if($GLOBALS['____1619925626'][17](___945166015(26), $_1673760825, true)){ $_54982486[___945166015(27)]= &$_COOKIE;} if($GLOBALS['____1619925626'][18](___945166015(28), $_1673760825, true)){ $_54982486[___945166015(29)]= &$_REQUEST;} if($GLOBALS['____1619925626'][19](___945166015(30), $_1673760825, true)){ $_54982486[___945166015(31)]= $GLOBALS;} return $_54982486;} public static function refreshRules(){ try{ $_518424160= Option::get('main_sec', 'WWALL_ACTUALIZE_RULES', 0); if(($GLOBALS['____1619925626'][20]()- $_518424160)< static::CACHE_RULES_TTL){ return;} Option::set(___945166015(32), ___945166015(33), $GLOBALS['____1619925626'][21]()); $_1809853405= null;  $_982246906= $GLOBALS['____1619925626'][22](function($_1286808145){ return[___945166015(34) => $_1286808145[___945166015(35)], ___945166015(36) => (int) $_1286808145[___945166015(37)]];}, ModuleManager::getModulesFromDisk());  $_1026297324=[]; foreach($GLOBALS['____1619925626'][23]() as $_36978380){ $_1145078848= new ReflectionExtension($_36978380); $_1026297324[$_36978380]=[ ___945166015(38) => $_1145078848->getVersion(), ___945166015(39) => $_1145078848->getINIEntries()];} $_2041825677=[ ___945166015(40) => $GLOBALS['____1619925626'][24]($_982246906), ___945166015(41) => Application::getInstance()->getLicense()->getHashLicenseKey(), ___945166015(42) => $GLOBALS['____1619925626'][25]([ ___945166015(43) => $GLOBALS['____1619925626'][26](), ___945166015(44) => $_1026297324])]; if(Loader::includeModule(___945166015(45))){ $_1801922067= CSecuritySystemInformation::getSystemInformation(); if(isset($_1801922067[___945166015(46)][___945166015(47)]) && isset($_1801922067[___945166015(48)][___945166015(49)])){ $_2041825677[___945166015(50)]=[ ___945166015(51) => $_1801922067[___945166015(52)][___945166015(53)], ___945166015(54) => $_1801922067[___945166015(55)][___945166015(56)]];} if(isset($_1801922067[___945166015(57)][___945166015(58)])){ $_2041825677[___945166015(59)]=[___945166015(60) => $_1801922067[___945166015(61)][___945166015(62)]];}}  $_107677195= new HttpClient([ ___945166015(63) => round(0+1+1+1+1+1), ___945166015(64) => round(0+1+1+1+1+1)]); $_268971770= $_107677195->post( static::$_1838228423, $_2041825677); if($_107677195->getStatus() == round(0+200) &&!empty($_268971770)){ $_1809853405= Json::decode($_268971770);}  if($_1809853405 !== null){ $_1998912322= Application::getConnection(); $_1149328754= RuleRecordTable::getTableName(); if(!empty($_1809853405)){ foreach($_1809853405 as $_886273660){ if(!static::checkRuleSign($_886273660)){ throw new SystemException('Invalid sign for rule '.$GLOBALS['____1619925626'][27]($_886273660));}}}  $_1998912322->truncateTable($_1149328754);  if(!empty($_1809853405)){ $_805558070=[]; foreach($_1809853405 as $_886273660){ $_805558070[]= ___945166015(65). $_1998912322->getSqlHelper()->forSql($_886273660[___945166015(66)]). ___945166015(67). $_1998912322->getSqlHelper()->forSql($_886273660[___945166015(68)]). ___945166015(69). $_1998912322->getSqlHelper()->forSql($_886273660[___945166015(70)]). ___945166015(71);} $_1655048889= $GLOBALS['____1619925626'][28](___945166015(72), $_805558070);  $_1998912322->query("INSERT INTO {$_1149328754} (DATA, MODULE, MODULE_VERSION) VALUES {$_1655048889}");  RuleRecordTable::cleanCache();}}} catch(\Throwable $_507736108){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, ___945166015(73), ___945166015(74), ___945166015(75), ___945166015(76). $_507736108->getMessage(). ___945166015(77). $_507736108->getTraceAsString());}} protected static function checkRuleSign($_498140423){ $_948582901= new PublicKeyCipher; $_805214841= $_948582901->decrypt($_498140423[___945166015(78)], static::__1346308139()); return str_starts_with($_805214841, ___945166015(79));} private static function __1346308139(){ $_371916845= ''; $_371916845 .= ___945166015(80); $_371916845 .= ___945166015(81); return $_371916845;} protected function logEvent($_1098058229, $_1382772364, $_227041091){ if($this->_1790303479){ \CEventLog::log( \CEventLog::SEVERITY_SECURITY, $_1098058229, 'main', $_1382772364, $_227041091);}}}?>