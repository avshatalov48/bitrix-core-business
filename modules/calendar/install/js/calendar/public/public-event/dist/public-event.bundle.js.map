{"version":3,"file":"public-event.bundle.js","sources":["../src/public-event.js"],"sourcesContent":["import { Loc } from 'main.core';\nimport { EventLayout, Props as EventLayoutProps } from 'calendar.sharing.public-v2';\nimport { Util } from 'calendar.util';\n\ntype Action = 'accept' | 'decline' | 'ics';\ntype Status = 'Q' | 'Y' | 'N';\n\ntype User = {\n\tname: string,\n\tlastName: string,\n\tavatar: string,\n\tstatus: Status,\n\tisOwner: boolean,\n};\n\ntype File = {\n\tlink: string,\n\tname: string,\n\tsize: number,\n};\n\ntype Params = {\n\tcontainer: HTMLElement,\n\tevent: {\n\t\tid: number,\n\t\thash: string,\n\t\tisDeleted: boolean,\n\t\tname: string,\n\t\ttimestampFrom: number,\n\t\ttimestampTo: number,\n\t\ttimezone: string,\n\t\tisFullDay: boolean,\n\t\tlocation: string,\n\t\tdescription: string,\n\t\tfiles: File[],\n\t\trruleDescription: string,\n\t\tmembers: User[],\n\t},\n\ttitle: string,\n\tisRu: boolean,\n\taction: Action,\n};\n\nexport class PublicEvent\n{\n\t#params: Params;\n\n\t#icsFile: string;\n\n\tconstructor(params: Params)\n\t{\n\t\tthis.#params = params;\n\t\tthis.#handleAction(params.action);\n\t}\n\n\t#handleAction(action: Action): void\n\t{\n\t\tif (action === 'accept')\n\t\t{\n\t\t\tthis.#handleDecisionAction('Y');\n\t\t}\n\n\t\tif (action === 'decline')\n\t\t{\n\t\t\tthis.#handleDecisionAction('N');\n\t\t}\n\n\t\tif (action === 'ics')\n\t\t{\n\t\t\tthis.#downloadIcsFile();\n\t\t}\n\t}\n\n\trender(): void\n\t{\n\t\tconst eventLayout = new EventLayout(this.#getLayoutProps());\n\t\tthis.#params.container.innerHTML = '';\n\t\tthis.#params.container.append(eventLayout.render());\n\t}\n\n\t#getLayoutProps(): EventLayoutProps\n\t{\n\t\tif (!this.#params.event)\n\t\t{\n\t\t\treturn {\n\t\t\t\teventNotFound: {\n\t\t\t\t\ttitle: Loc.getMessage('CALENDAR_PUBLIC_EVENT_TITLE_NOT_ATTENDEES'),\n\t\t\t\t\tsubtitle: Loc.getMessage('CALENDAR_PUBLIC_EVENT_DESCRIPTION_NOT_ATTENDEES'),\n\t\t\t\t},\n\t\t\t};\n\t\t}\n\n\t\tlet offset = 0;\n\t\tif (this.#params.event.timezone)\n\t\t{\n\t\t\toffset = (Util.getTimeZoneOffset() - Util.getTimeZoneOffset(this.#params.event.timezone)) * 60 * 1000;\n\t\t}\n\n\t\treturn {\n\t\t\teventName: this.#params.event.name,\n\t\t\tfrom: new Date(parseInt(this.#params.event.timestampFrom) * 1000 + offset),\n\t\t\tto: new Date(parseInt(this.#params.event.timestampTo) * 1000 + offset),\n\t\t\ttimezone: this.#params.event.timezone,\n\t\t\tbrowserTimezone: Intl.DateTimeFormat().resolvedOptions().timeZone,\n\t\t\tisFullDay: this.#params.event.isFullDay,\n\t\t\tlocation: this.#params.event.location,\n\t\t\tdescription: this.#params.event.description,\n\t\t\trruleDescription: this.#params.event.rruleDescription,\n\t\t\tmembers: this.#prepareMembers(),\n\t\t\tfiles: this.#params.event.files,\n\t\t\tallAttendees: true,\n\t\t\tfilled: true,\n\n\t\t\tonDeclineEvent: this.#getStatus() === 'Y' ? this.#declineInvitation.bind(this) : null,\n\n\t\t\ttitle: this.#getTitle(),\n\t\t\ticonClassName: this.#getIconClassName(),\n\t\t\tbottomButtons: this.#getBottomButtons(),\n\n\t\t\tpoweredLabel: {\n\t\t\t\tisRu: this.#params.isRu,\n\t\t\t},\n\t\t};\n\t}\n\n\t#prepareMembers(): User[]\n\t{\n\t\tif (this.#params.event.members?.length === 1 && this.#params.event.members[0].isOwner)\n\t\t{\n\t\t\treturn [];\n\t\t}\n\n\t\treturn [...this.#params.event.members].sort((member1, member2) => {\n\t\t\tconst value1 = member1.isOwner ? 1 : 0;\n\t\t\tconst value2 = member2.isOwner ? 1 : 0;\n\n\t\t\treturn value2 - value1;\n\t\t});\n\t}\n\n\t#getTitle(): string\n\t{\n\t\tif (this.#params.event.isDeleted || !this.#getStatus())\n\t\t{\n\t\t\treturn Loc.getMessage('CALENDAR_PUBLIC_EVENT_MEETING_IS_CANCELLED');\n\t\t}\n\n\t\tif (this.#getStatus() === 'Q')\n\t\t{\n\t\t\treturn Loc.getMessage('CALENDAR_PUBLIC_EVENT_YOU_WAS_INVITED');\n\t\t}\n\n\t\tif (this.#getStatus() === 'Y')\n\t\t{\n\t\t\treturn Loc.getMessage('CALENDAR_PUBLIC_EVENT_YOU_ACCEPTED_MEETING');\n\t\t}\n\n\t\tif (this.#getStatus() === 'N')\n\t\t{\n\t\t\treturn Loc.getMessage('CALENDAR_PUBLIC_EVENT_YOU_DECLINED_MEETING');\n\t\t}\n\n\t\treturn '';\n\t}\n\n\t#getIconClassName(): string\n\t{\n\t\tif (this.#getStatus() === 'N' || !this.#getStatus() || this.#params.event.isDeleted)\n\t\t{\n\t\t\treturn '--decline';\n\t\t}\n\n\t\treturn '--accept';\n\t}\n\n\t#getBottomButtons(): any\n\t{\n\t\tif (this.#params.event.isDeleted)\n\t\t{\n\t\t\treturn {};\n\t\t}\n\n\t\tif (this.#getStatus() === 'Q')\n\t\t{\n\t\t\treturn {\n\t\t\t\tonAcceptInvitation: this.#acceptInvitation.bind(this),\n\t\t\t\tonDeclineInvitation: this.#declineInvitation.bind(this),\n\t\t\t};\n\t\t}\n\n\t\tif (this.#getStatus() === 'Y')\n\t\t{\n\t\t\treturn {\n\t\t\t\tonDownloadIcs: this.#downloadIcsFile.bind(this),\n\t\t\t};\n\t\t}\n\n\t\tif (this.#getStatus() === 'N')\n\t\t{\n\t\t\treturn {\n\t\t\t\tonAcceptInvitation: this.#acceptInvitation.bind(this),\n\t\t\t};\n\t\t}\n\n\t\treturn {};\n\t}\n\n\t#acceptInvitation(): void\n\t{\n\t\tthis.#handleDecisionAction('Y');\n\t}\n\n\t#declineInvitation(): void\n\t{\n\t\tthis.#handleDecisionAction('N');\n\t}\n\n\t#handleDecisionAction(decision: Status): void\n\t{\n\t\tBX.ajax.runAction('calendar.api.publicevent.handleDecision', {\n\t\t\tdata: {\n\t\t\t\tdecision,\n\t\t\t\teventId: this.#params.event.id,\n\t\t\t\thash: this.#params.event.hash,\n\t\t\t},\n\t\t}).then((response) => {\n\t\t\tthis.#updateStatus(response.data);\n\t\t});\n\t}\n\n\t#getStatus(): Status\n\t{\n\t\tconst owner = this.#getOwner();\n\n\t\treturn owner.status;\n\t}\n\n\t#updateStatus(status): void\n\t{\n\t\tconst owner = this.#getOwner();\n\t\towner.status = status;\n\t\tthis.render();\n\t}\n\n\t#getOwner(): User\n\t{\n\t\treturn this.#params.event.members.find((member) => member.isOwner) ?? {};\n\t}\n\n\tasync #downloadIcsFile(): Promise\n\t{\n\t\tif (!this.#icsFile)\n\t\t{\n\t\t\tconst response = await BX.ajax.runAction('calendar.api.publicevent.getIcsFileContent', {\n\t\t\t\tdata: {\n\t\t\t\t\teventId: this.#params.event.id,\n\t\t\t\t\thash: this.#params.event.hash,\n\t\t\t\t},\n\t\t\t});\n\t\t\tthis.#icsFile = response.data;\n\t\t}\n\n\t\tUtil.downloadIcsFile(this.#icsFile, 'event');\n\t}\n}"],"names":["PublicEvent","constructor","params","action","render","eventLayout","EventLayout","container","innerHTML","append","event","eventNotFound","title","Loc","getMessage","subtitle","offset","timezone","Util","getTimeZoneOffset","eventName","name","from","Date","parseInt","timestampFrom","to","timestampTo","browserTimezone","Intl","DateTimeFormat","resolvedOptions","timeZone","isFullDay","location","description","rruleDescription","members","files","allAttendees","filled","onDeclineEvent","bind","iconClassName","bottomButtons","poweredLabel","isRu","length","isOwner","sort","member1","member2","value1","value2","isDeleted","onAcceptInvitation","onDeclineInvitation","onDownloadIcs","decision","BX","ajax","runAction","data","eventId","id","hash","then","response","owner","status","find","member","downloadIcsFile"],"mappings":"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"}