{"version":3,"file":"sound-notification-manager.bundle.js","sources":["../src/classes/sound-player.js","../src/sound-notification-manager.js"],"sourcesContent":["import {EventEmitter} from 'main.core.events';\n\nimport {SoundType} from 'im.v2.const';\n\nconst SoundFile = {\n\t[SoundType.reminder]: '/bitrix/js/im/audio/reminder.mp3',\n\t[SoundType.newMessage1]: '/bitrix/js/im/audio/new-message-1.mp3',\n\t[SoundType.newMessage2]: '/bitrix/js/im/audio/new-message-2.mp3',\n\t[SoundType.send]: '/bitrix/js/im/audio/send.mp3',\n\t[SoundType.dialtone]: '/bitrix/js/im/audio/video-dialtone.mp3',\n\t[SoundType.ringtone]: '/bitrix/js/im/audio/video-ringtone.mp3',\n\t[SoundType.ringtoneModern]: '/bitrix/js/im/audio/video-ringtone-modern.mp3?v2',\n\t[SoundType.start]: '/bitrix/js/im/audio/video-start.mp3',\n\t[SoundType.stop]: '/bitrix/js/im/audio/video-stop.mp3',\n\t[SoundType.error]: '/bitrix/js/im/audio/video-error.mp3',\n};\n\nexport class SoundPlayer\n{\n\tstatic syncEvent = 'im-sound-stop';\n\n\t#isPlayingLoop: boolean = false;\n\t#currentPlayingSound: ?HTMLAudioElement;\n\t#loopTimers: {[type: string]: number} = {};\n\n\tconstructor()\n\t{\n\t\tEventEmitter.subscribe('onLocalStorageSet', (event) => {\n\t\t\tconst [changedLocalStorageData] = event.getData();\n\t\t\tif (changedLocalStorageData.key !== SoundPlayer.syncEvent)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.stop(changedLocalStorageData.value.soundType, true);\n\t\t});\n\t}\n\n\tplaySingle(type: $Keys<typeof SoundFile>)\n\t{\n\t\tif (this.#currentPlayingSound)\n\t\t{\n\t\t\tthis.stop(type);\n\t\t}\n\n\t\tthis.#notifyOtherTabs(type);\n\n\t\tthis.#currentPlayingSound = new Audio(SoundFile[type]);\n\t\tthis.#currentPlayingSound.play().catch(() => {\n\t\t\tthis.#currentPlayingSound = null;\n\t\t});\n\t}\n\n\tplayLoop(type: $Keys<typeof SoundFile>, timeout: number = 5000)\n\t{\n\t\tif (this.#currentPlayingSound)\n\t\t{\n\t\t\tthis.stop(type);\n\t\t}\n\n\t\tthis.#isPlayingLoop = false;\n\t\tthis.playSingle(type);\n\n\t\tthis.#isPlayingLoop = true;\n\t\tthis.#loopTimers[type] = setTimeout(() => {\n\t\t\tthis.playLoop(type, timeout);\n\t\t}, timeout);\n\t}\n\n\tstop(type, skip = false)\n\t{\n\t\tif (!skip)\n\t\t{\n\t\t\tthis.#notifyOtherTabs(type);\n\t\t}\n\n\t\tif (this.#loopTimers[type])\n\t\t{\n\t\t\tthis.#isPlayingLoop = false;\n\t\t\tclearTimeout(this.#loopTimers[type]);\n\t\t}\n\n\t\tif (!this.#currentPlayingSound)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#currentPlayingSound.src.endsWith(SoundFile[type]))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#currentPlayingSound.pause();\n\t\tthis.#currentPlayingSound.currentTime = 0;\n\t\tthis.#currentPlayingSound = null;\n\t}\n\n\t#notifyOtherTabs(soundType: $Keys<typeof SoundFile>)\n\t{\n\t\tconst localStorageTtl = 1;\n\n\t\tBX.localStorage.set(SoundPlayer.syncEvent, {soundType}, localStorageTtl);\n\t}\n}","import { Store } from 'ui.vue3.vuex';\n\nimport { Core } from 'im.v2.application.core';\nimport { UserStatus, SoundType, Settings } from 'im.v2.const';\nimport { DesktopManager } from 'im.v2.lib.desktop';\nimport { CallManager } from 'im.v2.lib.call';\n\nimport { SoundPlayer } from './classes/sound-player';\n\nexport class SoundNotificationManager\n{\n\tstore: Store;\n\tdesktopManager: DesktopManager;\n\tsoundPlayer: SoundPlayer;\n\tcallManager: CallManager;\n\n\tstatic instance: SoundNotificationManager | null = null;\n\n\tstatic getInstance(): SoundNotificationManager\n\t{\n\t\tif (!this.instance)\n\t\t{\n\t\t\tconst store = Core.getStore();\n\t\t\tconst desktopManager = DesktopManager.getInstance();\n\t\t\tconst callManager = CallManager.getInstance();\n\t\t\tconst soundPlayer = new SoundPlayer();\n\n\t\t\tthis.instance = new this(store, desktopManager, callManager, soundPlayer);\n\t\t}\n\n\t\treturn this.instance;\n\t}\n\n\tconstructor(store, desktopManager, callManager, soundPlayer)\n\t{\n\t\tthis.store = store;\n\t\tthis.desktopManager = desktopManager;\n\t\tthis.soundPlayer = soundPlayer;\n\t\tthis.callManager = callManager;\n\t}\n\n\tplayOnce(type: $Keys<typeof SoundType>)\n\t{\n\t\tif (this.#hasActiveCall() || !this.#canPlayInContext())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#isSoundEnabled() || this.#isUserDnd())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.soundPlayer.playSingle(type);\n\t}\n\n\tforcePlayOnce(type: $Keys<typeof SoundType>)\n\t{\n\t\tif (!this.#canPlayInContext())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#isSoundEnabled())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.soundPlayer.playSingle(type);\n\t}\n\n\tplayLoop(type: $Keys<typeof SoundType>, timeout: number = 5000, force = false)\n\t{\n\t\tif (this.#hasActiveCall() && !force)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (!this.#canPlayInContext())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (force)\n\t\t{\n\t\t\tthis.soundPlayer.playLoop(type, timeout);\n\n\t\t\treturn;\n\t\t}\n\n\t\tif (this.#isUserDnd() || !this.#isSoundEnabled())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.soundPlayer.playLoop(type, timeout);\n\t}\n\n\tstop(type: $Keys<typeof SoundType>)\n\t{\n\t\tthis.soundPlayer.stop(type);\n\t}\n\n\t#canPlayInContext(): boolean\n\t{\n\t\treturn DesktopManager.isDesktop() || !this.desktopManager.isDesktopActive();\n\t}\n\n\t#isUserDnd(): boolean\n\t{\n\t\tconst status = this.store.getters['application/settings/get'](Settings.user.status);\n\n\t\treturn status === UserStatus.dnd;\n\t}\n\n\t#hasActiveCall(): boolean\n\t{\n\t\treturn this.callManager.hasCurrentCall();\n\t}\n\n\t#isSoundEnabled(): boolean\n\t{\n\t\treturn this.store.getters['application/settings/get'](Settings.notification.enableSound);\n\t}\n}\n"],"names":["SoundFile","SoundType","reminder","newMessage1","newMessage2","send","dialtone","ringtone","ringtoneModern","start","stop","error","SoundPlayer","constructor","EventEmitter","subscribe","event","changedLocalStorageData","getData","key","syncEvent","value","soundType","playSingle","type","Audio","play","catch","playLoop","timeout","setTimeout","skip","clearTimeout","src","endsWith","pause","currentTime","localStorageTtl","BX","localStorage","set","SoundNotificationManager","getInstance","instance","store","Core","getStore","desktopManager","DesktopManager","callManager","CallManager","soundPlayer","playOnce","forcePlayOnce","force","isDesktop","isDesktopActive","status","getters","Settings","user","UserStatus","dnd","hasCurrentCall","notification","enableSound"],"mappings":"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"}