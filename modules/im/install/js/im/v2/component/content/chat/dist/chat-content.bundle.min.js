this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,n,s,a,o,i,r,l,d,g,h,c,m,C,u,p,I,M,v,S,_,T){"use strict";const y={accessDenied:"ACCESS_DENIED",chatNotFound:"CHAT_NOT_FOUND",messageNotFound:"MESSAGE_NOT_FOUND",messageAccessDenied:"MESSAGE_ACCESS_DENIED",messageAccessDeniedByTariff:"MESSAGE_ACCESS_DENIED_BY_TARIFF"};const B={name:"CommentsButton",props:{dialogId:{type:String,required:true},counter:{type:Number,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)}},template:`\n\t\t<div class="bx-im-dialog-channel__comments-button">\n\t\t\t<div class="bx-im-dialog-channel__comments-button_counter">\n\t\t\t\t{{ counter }}\n\t\t\t</div>\n\t\t</div>\n\t`};class b extends M.MessageMenu{getMenuItems(){return[this.getCopyItem(),this.getCopyLinkItem(),this.getCopyFileItem(),this.getPinItem(),this.getForwardItem(),this.getDelimiter(),this.getMarkItem(),this.getFavoriteItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getEditItem(),this.getDeleteItem()]}}const E={name:"ChannelMessageList",components:{MessageList:M.MessageList},props:{dialogId:{type:String,required:true}},computed:{ChannelMessageMenu:()=>b},template:`\n\t\t<MessageList :dialogId="dialogId" :messageMenuClass="ChannelMessageMenu" />\n\t`};const f={name:"ChannelDialog",components:{ChatDialog:C.ChatDialog,ChannelMessageList:E,CommentsButton:B},props:{dialogId:{type:String,required:true}},data(){return{lastScrolledChatId:0}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},layout(){return this.$store.getters["application/getLayout"]},isGuest(){return this.dialog.role===v.UserRole.guest},isChatLayout(){return this.layout.name===v.Layout.chat.name},channelComments(){return this.$store.getters["counters/getChannelComments"](this.dialog.chatId)},totalChannelCommentsCounter(){let t=0;Object.values(this.channelComments).forEach((e=>{t+=e}));return t},showCommentsButton(){return this.isChatLayout&&this.totalChannelCommentsCounter>0}},beforeUnmount(){this.readAllChannelComments()},methods:{async onCommentsButtonClick(){const t=this.getNextChatIdToJump();this.lastScrolledChatId=t;const e=this.$store.getters["messages/comments/getMessageIdByChatId"](t);if(e){this.$refs.dialog.goToMessageContext(e,{position:C.ScrollManager.scrollPosition.messageBottom});return}await this.goToMessageContextByCommentsChatId(t)},async goToMessageContextByCommentsChatId(t){this.$refs.dialog.showLoadingBar();const e=await this.$refs.dialog.getMessageService().loadContextByChatId(t).catch((t=>{console.error("ChannelDialog: goToMessageContextByCommentsChatId error",t)}));this.$refs.dialog.hideLoadingBar();if(!e){console.error("ChannelDialog: no messageId after loading context")}await this.$nextTick();this.$refs.dialog.getScrollManager().scrollToMessage(e,{position:C.ScrollManager.scrollPosition.messageBottom});await this.$nextTick();this.$refs.dialog.highlightMessage(e)},getNextChatIdToJump(){const t=this.getCommentsChatIds();t.sort(((t,e)=>t-e));if(this.lastScrolledChatId===0){return t[0]}const e=t.filter((t=>t>this.lastScrolledChatId));if(e.length===0){return t[0]}return e[0]},getCommentsChatIds(){return Object.keys(this.channelComments).map((t=>Number(t)))},readAllChannelComments(){T.CommentsService.readAllChannelComments(this.dialogId)}},template:`\n\t\t<ChatDialog ref="dialog" :dialogId="dialogId" :resetOnExit="isGuest">\n\t\t\t<template #message-list>\n\t\t\t\t<ChannelMessageList :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #additional-float-button>\n\t\t\t\t<Transition name="float-button-transition">\n\t\t\t\t\t<CommentsButton\n\t\t\t\t\t\tv-if="showCommentsButton"\n\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t:counter="totalChannelCommentsCounter"\n\t\t\t\t\t\t@click="onCommentsButtonClick"\n\t\t\t\t\t\tkey="comments"\n\t\t\t\t\t/>\n\t\t\t\t</Transition>\n\t\t\t</template>\n\t\t</ChatDialog>\n\t`};const x={components:{ChatButton:_.Button},props:{dialogId:{type:String,required:true}},computed:{ButtonSize:()=>_.ButtonSize,ButtonColor:()=>_.ButtonColor},methods:{onButtonClick(){this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new T.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHANNEL_V2')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const L={name:"ChannelTextarea",components:{ChatTextarea:S.ChatTextarea},props:{dialogId:{type:String,default:""}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<ChatTextarea\n\t\t\t:dialogId="dialogId"\n\t\t\t:placeholder="this.loc('IM_CONTENT_CHANNEL_TEXTAREA_PLACEHOLDER')"\n\t\t\t:withCreateMenu="false"\n\t\t\t:withMarket="false"\n\t\t\t:withAudioInput="false"\n\t\t\tclass="bx-im-channel-send-panel__container"\n\t\t/>\n\t`};const A={name:"ChannelContent",components:{BaseChatContent:h.BaseChatContent,ChannelDialog:f,ChannelTextarea:L,JoinPanel:x},props:{dialogId:{type:String,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId">\n\t\t\t<template #dialog>\n\t\t\t\t<ChannelDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #join-panel>\n\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #textarea="{ onTextareaMount }">\n\t\t\t\t<ChannelTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const w="COLLAB_GROUP_ID";const N={name:"CollabHeader",components:{ChatHeader:h.ChatHeader},props:{dialogId:{type:String,default:""}},data(){return{groupId:0}},computed:{entityLinks(){return[{title:"Tasks",clickHandler:()=>{BX.SidePanel.Instance.open(`https://kotlyarchuk.bx/workgroups/group/${this.groupId}/tasks/`)}},{title:"Files",clickHandler:()=>{BX.SidePanel.Instance.open(`https://kotlyarchuk.bx/workgroups/group/${this.groupId}/disk/path/`)}},{title:"Calendar",clickHandler:()=>{BX.SidePanel.Instance.open(`https://kotlyarchuk.bx/workgroups/group/${this.groupId}/calendar/`)}}]}},created(){var t;const e=new URLSearchParams(window.location.search);this.groupId=(t=e.get(w))!=null?t:1},template:`\n\t\t<ChatHeader :dialogId="dialogId" class="bx-im-collab-header__container">\n\t\t\t<template #before-actions>\n\t\t\t\t<div class="bx-im-collab-header__links-container">\n\t\t\t\t\t<div v-for="{ title, clickHandler } in entityLinks" :key="title" @click="clickHandler" class="bx-im-collab-header__links-container_item">\n\t\t\t\t\t\t{{ title }}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</ChatHeader>\n\t`};const D={name:"CollabContent",components:{BaseChatContent:h.BaseChatContent,CollabHeader:N},props:{dialogId:{type:String,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId">\n\t\t\t<template #header>\n\t\t\t\t<CollabHeader :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const k={name:"MultidialogChatTitle",components:{EditableChatTitle:_.EditableChatTitle,ChatTitle:_.ChatTitle},props:{dialogId:{type:String,required:true}},emits:["newTitle"],computed:{isSupportBot(){return this.$store.getters["users/bots/isSupport"](this.dialogId)},subtitle(){return this.$Bitrix.Loc.getMessage("IM_CONTENT_CHAT_HEADER_SUPPORT_SUBTITLE")}},template:`\n\t\t<div class="bx-im-chat-header__info">\n\t\t\t<ChatTitle v-if="isSupportBot" :dialogId="dialogId" />\n\t\t\t<EditableChatTitle v-else :dialogId="dialogId" @newTitleSubmit="$emit('newTitle', $event)" />\n\t\t\t<div class="bx-im-chat-header__subtitle_container">\n\t\t\t\t<div class="bx-im-chat-header__subtitle_content">{{ subtitle }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const $={name:"MultidialogHeader",components:{ChatHeader:h.ChatHeader,MultidialogChatTitle:k},props:{dialogId:{type:String,default:""}},template:`\n\t\t<ChatHeader :dialogId="dialogId">\n\t\t\t<template #title="{ onNewTitleHandler }">\n\t\t\t\t<MultidialogChatTitle\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t@newTitle="onNewTitleHandler"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t</ChatHeader>\n\t`};const O={name:"MultidialogContent",components:{BaseChatContent:h.BaseChatContent,MultidialogHeader:$},props:{dialogId:{type:String,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId">\n\t\t\t<template #header>\n\t\t\t\t<MultidialogHeader :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const P={data(){return{}},computed:{iconClass(){return this.isEmptyRecent?"--empty":"--default"},text(){if(this.isEmptyRecent){return this.loc("IM_CONTENT_CHAT_NO_CHATS_START_MESSAGE")}if(this.isChannelLayout){return this.loc("IM_CONTENT_CHANNEL_START_MESSAGE_V3")}return this.loc("IM_CONTENT_CHAT_START_MESSAGE_V2")},subtext(){if(this.isChannelLayout){return this.loc("IM_CONTENT_CHANNEL_START_MESSAGE_SUBTITLE")}return""},isEmptyRecent(){return T.RecentService.getInstance().getCollection().length===0},isChannelLayout(){return this.layout.name===v.Layout.channel.name},layout(){return this.$store.getters["application/getLayout"]},backgroundStyle(){return i.ThemeManager.getCurrentBackgroundStyle()}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="bx-im-content-chat-start__container" :style="backgroundStyle">\n\t\t\t<div class="bx-im-content-chat-start__content">\n\t\t\t\t<div class="bx-im-content-chat-start__icon" :class="iconClass"></div>\n\t\t\t\t<div class="bx-im-content-chat-start__title">\n\t\t\t\t\t{{ text }}\n\t\t\t\t</div>\n\t\t\t\t<div v-if="subtext" class="bx-im-content-chat-start__subtitle">\n\t\t\t\t\t{{ subtext }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};class H{async updateLastActivityDate(t){if(this.isPullServerWithUserStatusSupport()){const e=await this.getUserActivityFromPull(t);if(!e){return Promise.resolve()}return this.updateUserModel(t,{lastActivityDate:e})}const e=await this.requestUserData(t);return this.updateUserModel(t,e)}async getUserActivityFromPull(t){const e=await r.Core.getPullClient().getUsersLastSeen([t]).catch((t=>{console.error("UserService: error getting user activity from P&P",t)}));if(!p.Type.isNumber(e[t])){return null}const n=e[t]*1e3;return new Date(Date.now()-n)}async requestUserData(t){c.Logger.warn(`UserService: get actual user data for - ${t}`);const e=await r.Core.getRestClient().callMethod(v.RestMethod.imUserGet,{ID:t}).catch((t=>{console.error("UserService: error getting user data",t)}));return e.data()}async updateUserModel(t,e){c.Logger.warn("UserService: update user data",e);return r.Core.getStore().dispatch("users/update",{id:t,fields:e})}isPullServerWithUserStatusSupport(){return r.Core.getPullClient().isJsonRpc()}}const X={name:"ChatOpener",components:{BaseChatContent:h.BaseChatContent,ChannelContent:A,CollabContent:D,MultidialogContent:O,EmptyState:P},props:{dialogId:{type:String,required:true}},emits:["close"],data(){return{}},computed:{layout(){return this.$store.getters["application/getLayout"]},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isUser(){return this.dialog.type===v.ChatType.user},isChannel(){return a.ChannelManager.isChannel(this.dialogId)},isCollab(){return this.dialog.type===v.ChatType.collab},isMultidialog(){return this.$store.getters["sidebar/multidialog/isSupport"](this.dialogId)},isGuest(){return this.dialog.role===v.UserRole.guest}},watch:{dialogId(t,e){c.Logger.warn(`ChatContent: switching from ${e||"empty"} to ${t}`);this.onChatChange()}},created(){if(!this.dialogId){return}this.onChatChange()},methods:{async onChatChange(){if(this.dialogId===""){return}if(s.Utils.dialog.isExternalId(this.dialogId)){const t=await this.getChatService().prepareDialogId(this.dialogId);void n.LayoutManager.getInstance().setLayout({name:v.Layout.chat.name,entityId:t,contextId:this.layout.contextId});return}if(this.dialog.inited){c.Logger.warn(`ChatContent: chat ${this.dialogId} is already loaded`);if(this.isUser){const t=parseInt(this.dialog.dialogId,10);void this.getUserService().updateLastActivityDate(t)}else if(this.isChannel&&!this.isGuest){c.Logger.warn(`ChatContent: channel ${this.dialogId} is loaded, loading comments metadata`);void this.getChatService().loadCommentInfo(this.dialogId)}d.Analytics.getInstance().onOpenChat(this.dialog);return}if(this.dialog.loading){c.Logger.warn(`ChatContent: chat ${this.dialogId} is loading`);return}if(this.layout.contextId){await this.loadChatWithContext();d.Analytics.getInstance().onOpenChat(this.dialog);return}await this.loadChat();d.Analytics.getInstance().onOpenChat(this.dialog)},async loadChatWithContext(){c.Logger.warn(`ChatContent: loading chat ${this.dialogId} with context - ${this.layout.contextId}`);await this.getChatService().loadChatWithContext(this.dialogId,this.layout.contextId).catch((t=>{this.sendAnalytics(t);this.handleChatLoadError(t);c.Logger.error(t);e.Messenger.openChat()}));c.Logger.warn(`ChatContent: chat ${this.dialogId} is loaded with context of ${this.layout.contextId}`)},async loadChat(){c.Logger.warn(`ChatContent: loading chat ${this.dialogId}`);await this.getChatService().loadChatWithMessages(this.dialogId).catch((t=>{this.handleChatLoadError(t);c.Logger.error(t);e.Messenger.openChat()}));c.Logger.warn(`ChatContent: chat ${this.dialogId} is loaded`)},handleChatLoadError(t){const[e]=t;if(e.code===y.accessDenied){this.showNotification(this.loc("IM_CONTENT_CHAT_ACCESS_ERROR_MSGVER_1"))}else if(e.code===y.messageNotFound){this.showNotification(this.loc("IM_CONTENT_CHAT_CONTEXT_MESSAGE_NOT_FOUND"))}},sendAnalytics(t){const[e]=t;if(e.code!==y.messageNotFound){return}d.Analytics.getInstance().messageDelete.onNotFoundNotification({dialogId:this.dialogId})},showNotification(t){BX.UI.Notification.Center.notify({content:t})},getChatService(){if(!this.chatService){this.chatService=new T.ChatService}return this.chatService},getUserService(){if(!this.userService){this.userService=new H}return this.userService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-default-chat__container">\n\t\t\t<EmptyState v-if="!dialogId" />\n\t\t\t<ChannelContent v-else-if="isChannel" :dialogId="dialogId" />\n\t\t\t<CollabContent v-else-if="isCollab" :dialogId="dialogId" />\n\t\t\t<MultidialogContent v-else-if="isMultidialog" :dialogId="dialogId" />\n\t\t\t<BaseChatContent v-else :dialogId="dialogId" />\n\t\t</div>\n\t`};const U={name:"SubscribeToggle",components:{Toggle:_.Toggle},props:{dialogId:{type:String,required:true}},data(){return{}},computed:{ToggleSize:()=>_.ToggleSize,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},isSubscribed(){return this.$store.getters["messages/comments/isUserSubscribed"](this.postMessageId)}},methods:{onToggleClick(){if(this.isSubscribed){T.CommentsService.unsubscribe(this.postMessageId);return}T.CommentsService.subscribe(this.postMessageId)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div @click="onToggleClick" class="bx-im-comments-header-follow__container">\n\t\t\t<div class="bx-im-comments-header-follow__text">{{ loc('IM_CONTENT_COMMENTS_FOLLOW_TOGGLE_TEXT') }}</div>\n\t\t\t<Toggle :size="ToggleSize.M" :isEnabled="isSubscribed" />\n\t\t</div>\n\t`};const R={name:"CommentsHeader",components:{ChatHeader:h.ChatHeader,ChatAvatar:_.ChatAvatar,SubscribeToggle:U},props:{dialogId:{type:String,default:""},channelId:{type:String,required:true}},computed:{AvatarSize:()=>_.AvatarSize,channel(){return this.$store.getters["chats/get"](this.channelId,true)},showSubscribeToggle(){return g.PermissionManager.getInstance().canPerformAction(v.ChatActionType.subscribeToComments,this.dialogId)}},methods:{onBackClick(){I.EventEmitter.emit(v.EventType.dialog.closeComments)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<ChatHeader\n\t\t\t:dialogId="dialogId"\n\t\t\tclass="bx-im-comment-header__container"\n\t\t>\n\t\t\t<template #left>\n\t\t\t\t<div @click="onBackClick" class="bx-im-comment-header__back"></div>\n\t\t\t\t<div class="bx-im-comment-header__info">\n\t\t\t\t\t<div class="bx-im-comment-header__title">{{ loc('IM_CONTENT_COMMENTS_HEADER_TITLE') }}</div>\n\t\t\t\t\t<div class="bx-im-comment-header__subtitle">\n\t\t\t\t\t\t<div class="bx-im-comment-header__subtitle_avatar">\n\t\t\t\t\t\t\t<ChatAvatar :avatarDialogId="channelId" :contextDialogId="channelId" :size="AvatarSize.XS" />\n\t\t\t\t\t\t</div>\n\t\t\t\t\t\t<div class="bx-im-comment-header__subtitle_text">{{ channel.name }}</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<template v-if="showSubscribeToggle" #before-actions>\n\t\t\t\t<SubscribeToggle :dialogId="dialogId" />\n\t\t\t</template>\n\t\t</ChatHeader>\n\t`};const F={name:"CommentsDialogLoader",data(){return{}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-comments-dialog-loader__container">\n\t\t\t<div class="bx-im-comments-dialog-loader__spinner"></div>\n\t\t</div>\n\t`};class G extends M.MessageMenu{getMenuItems(){if(this.isPostMessage()){return[this.getCopyItem(),this.getCopyFileItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getOpenInChannelItem()]}return[this.getReplyItem(),this.getCopyItem(),this.getCopyFileItem(),this.getDelimiter(),this.getFavoriteItem(),this.getDelimiter(),this.getCreateItem(),this.getDelimiter(),this.getDownloadFileItem(),this.getSaveToDisk(),this.getDelimiter(),this.getEditItem(),this.getDeleteItem()]}getOpenInChannelItem(){return{text:p.Loc.getMessage("IM_CONTENT_COMMENTS_MESSAGE_MENU_OPEN_IN_CHANNEL"),onclick:()=>{I.EventEmitter.emit(v.EventType.dialog.closeComments);this.menuInstance.close()}}}isPostMessage(){const{dialogId:t}=this.store.getters["chats/getByChatId"](this.context.chatId);return t!==this.context.dialogId}}const q={name:"CommentsMessageList",components:{MessageList:M.MessageList,CommentsDialogLoader:F,AuthorGroup:M.AuthorGroup,...M.MessageComponents},props:{dialogId:{type:String,required:true}},computed:{CommentsMessageMenu:()=>G,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},showPostMessage(){return this.dialog.inited&&!this.dialog.hasPrevPage},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},postMessage(){return this.$store.getters["messages/getById"](this.postMessageId)},postAuthorGroup(){if(!this.dialog.inited){return null}const t=new M.CollectionManager(this.dialogId);return t.formatAuthorGroup(this.postMessage)}},methods:{onPostMessageMouseUp(t,e){this.$refs.messageList.onMessageMouseUp(t,e)},getMessageComponentName(t){return new u.MessageComponentManager(t).getName()}},template:`\n\t\t<MessageList\n\t\t\t:dialogId="dialogId"\n\t\t\t:messageMenuClass="CommentsMessageMenu"\n\t\t\tref="messageList"\n\t\t>\n\t\t\t<template #loader>\n\t\t\t\t<CommentsDialogLoader />\n\t\t\t</template>\n\t\t\t<template v-if="showPostMessage" #before-messages>\n\t\t\t\t<div class="bx-im-comments-message-list__channel-post">\n\t\t\t\t\t<AuthorGroup :item="postAuthorGroup" :contextDialogId="dialogId">\n\t\t\t\t\t\t<template #message>\n\t\t\t\t\t\t\t<component\n\t\t\t\t\t\t\t\t:is="getMessageComponentName(postMessage)"\n\t\t\t\t\t\t\t\t:item="postMessage"\n\t\t\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t\t\t:key="postMessage.id"\n\t\t\t\t\t\t\t\t@mouseup="onPostMessageMouseUp(postMessage, $event)"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t</component>\n\t\t\t\t\t\t</template>\n\t\t\t\t\t</AuthorGroup>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t</MessageList>\n\t`};const z={name:"CommentsDialog",components:{ChatDialog:C.ChatDialog,CommentsMessageList:q,PinnedMessages:C.PinnedMessages},props:{dialogId:{type:String,required:true}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},dialogInited(){return this.dialog.inited},postMessageId(){return this.$store.getters["messages/comments/getMessageIdByChatId"](this.dialog.chatId)},postMessage(){return this.$store.getters["messages/getById"](this.postMessageId)}},methods:{async goToPostMessageContext(){const t=this.$refs.dialog;const e=this.dialogInited&&!this.dialog.hasPrevPage;if(e){await t.getScrollManager().animatedScrollToMessage(this.postMessageId);t.highlightMessage(this.postMessageId);return}t.showLoadingBar();await t.getMessageService().loadFirstPage().catch((t=>{c.Logger.error("goToMessageContext error",t)}));await this.$nextTick();t.hideLoadingBar();t.getScrollManager().scrollToMessage(this.postMessageId);await this.$nextTick();t.highlightMessage(this.postMessageId)},onPinnedPostMessageClick(){this.goToPostMessageContext()}},template:`\n\t\t<ChatDialog ref="dialog" :dialogId="dialogId" :saveScrollOnExit="false" :resetOnExit="true">\n\t\t\t<template v-if="dialogInited" #pinned-panel>\n\t\t\t\t<PinnedMessages\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:messages="[postMessage]"\n\t\t\t\t\t@messageClick="onPinnedPostMessageClick"\n\t\t\t\t/>\n\t\t\t</template>\n\t\t\t<template #message-list>\n\t\t\t\t<CommentsMessageList :dialogId="dialogId" />\n\t\t\t</template>\n\t\t</ChatDialog>\n\t`};const J={name:"CommentsTextarea",components:{ChatTextarea:S.ChatTextarea},props:{dialogId:{type:String,default:""}},template:`\n\t\t<ChatTextarea\n\t\t\t:dialogId="dialogId"\n\t\t\t:withMarket="false"\n\t\t\t:withAudioInput="false"\n\t\t\tclass="bx-im-comments-send-panel__container"\n\t\t/>\n\t`};const W={components:{ChatButton:_.Button},props:{dialogId:{type:String,required:true}},computed:{ButtonSize:()=>_.ButtonSize,ButtonColor:()=>_.ButtonColor},methods:{onButtonClick(){this.getChatService().joinChat(this.dialogId)},getChatService(){if(!this.chatService){this.chatService=new T.ChatService}return this.chatService},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-content-chat__textarea_placeholder">\n\t\t\t<ChatButton\n\t\t\t\t:size="ButtonSize.XL"\n\t\t\t\t:color="ButtonColor.Primary"\n\t\t\t\t:text="loc('IM_CONTENT_BLOCKED_TEXTAREA_JOIN_CHANNEL_V2')"\n\t\t\t\t:isRounded="true"\n\t\t\t\t@click="onButtonClick"\n\t\t\t/>\n\t\t</div>\n\t`};const j={name:"CommentsContent",components:{BaseChatContent:h.BaseChatContent,CommentsHeader:R,CommentsDialog:z,CommentsTextarea:J,JoinPanel:W},props:{dialogId:{type:String,required:true},channelId:{type:String,required:true}},template:`\n\t\t<BaseChatContent :dialogId="dialogId">\n\t\t\t<template #header>\n\t\t\t\t<CommentsHeader :dialogId="dialogId" :channelId="channelId" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #dialog>\n\t\t\t\t<CommentsDialog :dialogId="dialogId" :key="dialogId" />\n\t\t\t</template>\n\t\t\t<template #join-panel>\n\t\t\t\t<JoinPanel :dialogId="dialogId" />\n\t\t\t</template>\n\t\t\t<template #textarea="{ onTextareaMount }">\n\t\t\t\t<CommentsTextarea :dialogId="dialogId" :key="dialogId" @mounted="onTextareaMount" />\n\t\t\t</template>\n\t\t</BaseChatContent>\n\t`};const V={name:"CommentsOpener",components:{CommentsContent:j},props:{postId:{type:Number,required:true},channelId:{type:String,required:true}},emits:["close"],data(){return{}},computed:{dialog(){return this.$store.getters["chats/getByChatId"](this.commentsChatId)},commentInfo(){return this.$store.getters["messages/comments/getByMessageId"](this.postId)},commentsChatId(){return this.commentInfo.chatId},commentsDialogId(){if(!this.dialog){return""}return this.dialog.dialogId}},created(){this.onCreated()},methods:{async onCreated(){await this.loadChat();d.Analytics.getInstance().onOpenChat(this.dialog)},async loadChat(){c.Logger.warn(`CommentsContent: loading comments for post ${this.postId}`);await this.getChatService().loadComments(this.postId).catch((t=>{this.handleChatLoadError(t);c.Logger.error(t);this.$emit("close")}));c.Logger.warn(`CommentsContent: comments for post ${this.postId} are loaded`)},handleChatLoadError(t){const[e]=t;if(e.code==="ACCESS_DENIED"){this.showNotification(this.loc("IM_CONTENT_CHAT_ACCESS_ERROR_MSGVER_1"))}},showNotification(t){BX.UI.Notification.Center.notify({content:t})},getChatService(){if(!this.chatService){this.chatService=new T.ChatService}return this.chatService}},template:`\n\t\t<div class="bx-im-content-comments__container">\n\t\t\t<CommentsContent :dialogId="commentsDialogId" :channelId="channelId" />\n\t\t</div>\n\t`};const K={name:"ChatContent",components:{ChatOpener:X,CommentsOpener:V},props:{entityId:{type:String,default:""}},data(){return{commentsPostId:0,commentsAnimationFlag:false}},computed:{layout(){return this.$store.getters["application/getLayout"]},showComments(){return this.$store.getters["messages/comments/areOpened"]}},watch:{layout(){this.closeComments()}},created(){I.EventEmitter.subscribe(v.EventType.dialog.openComments,this.onOpenComments);I.EventEmitter.subscribe(v.EventType.dialog.closeComments,this.onCloseComments)},beforeUnmount(){I.EventEmitter.unsubscribe(v.EventType.dialog.openComments,this.onOpenComments);I.EventEmitter.unsubscribe(v.EventType.dialog.closeComments,this.onCloseComments)},methods:{onOpenComments(t){const{messageId:e}=t.getData();this.commentsPostId=e;this.commentsAnimationFlag=true;this.$store.dispatch("messages/comments/setOpened",{channelDialogId:this.entityId,commentsPostId:this.commentsPostId})},onCloseComments(){this.closeComments()},closeComments(){this.commentsPostId=0;this.$store.dispatch("messages/comments/setClosed")},onCommentsAnimationEnd(){this.commentsAnimationFlag=false}},template:`\n\t\t<ChatOpener :dialogId="entityId" :class="{'--comments-show-animation': commentsAnimationFlag}" />\n\t\t<Transition name="comments-content" @after-enter="onCommentsAnimationEnd">\n\t\t\t<CommentsOpener\n\t\t\t\tv-if="showComments"\n\t\t\t\t:postId="commentsPostId"\n\t\t\t\t:channelId="entityId"\n\t\t\t/>\n\t\t</Transition>\n\t`};t.ChatContent=K})(this.BX.Messenger.v2.Component.Content=this.BX.Messenger.v2.Component.Content||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Content,BX.Messenger.v2.Lib,BX.Messenger.v2.Model,BX.Messenger.v2.Component.Dialog,BX.Messenger.v2.Lib,BX,BX.Event,BX.Messenger.v2.Component,BX.Messenger.v2.Const,BX.Messenger.v2.Component,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Service);
//# sourceMappingURL=chat-content.bundle.map.js