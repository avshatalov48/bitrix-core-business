(function(e,t,n,i,r,a){"use strict";var s,l,o,u,d;function h(e,t){var n=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!n){if(Array.isArray(e)||(n=c(e))||t&&e&&typeof e.length==="number"){if(n)e=n;var i=0;var r=function e(){};return{s:r,n:function t(){if(i>=e.length)return{done:true};return{done:false,value:e[i++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,l;return{s:function t(){n=n.call(e)},n:function e(){var t=n.next();a=t.done;return t},e:function e(t){s=true;l=t},f:function e(){try{if(!a&&n["return"]!=null)n["return"]()}finally{if(s)throw l}}}}function c(e,t){if(!e)return;if(typeof e==="string")return f(e,t);var n=Object.prototype.toString.call(e).slice(8,-1);if(n==="Object"&&e.constructor)n=e.constructor.name;if(n==="Map"||n==="Set")return Array.from(e);if(n==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n))return f(e,t)}function f(e,t){if(t==null||t>e.length)t=e.length;for(var n=0,i=new Array(t);n<t;n++)i[n]=e[n];return i}function g(e,t,n){v(e,t);m(n,"get");return p(e,n)}function m(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function v(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function p(e,t){if(t.get){return t.get.call(e)}return t.value}var y=t.Reflection.namespace("BX.Main.UserField");var b=function(){function e(n){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"id",0);babelHelpers.defineProperty(this,"inputs",new Map);babelHelpers.defineProperty(this,"tabs",new Map);babelHelpers.defineProperty(this,"container",null);babelHelpers.defineProperty(this,"settingsContainer",null);babelHelpers.defineProperty(this,"settingsTable",null);babelHelpers.defineProperty(this,"errorsContainer",null);babelHelpers.defineProperty(this,"saveButton",null);babelHelpers.defineProperty(this,"cancelButton",null);babelHelpers.defineProperty(this,"deleteButton",null);this.tabs=new Map;this.inputs=new Map;var i=document.getElementById("ui-button-panel-save");if(i){this.saveButton=a.ButtonManager.createFromNode(i)}var r=document.getElementById("ui-button-panel-cancel");if(r){this.cancelButton=a.ButtonManager.createFromNode(r)}var s=document.getElementById("ui-button-panel-remove");if(s){this.deleteButton=a.ButtonManager.createFromNode(s)}if(t.Type.isPlainObject(n)){this.id=t.Text.toInteger(n.id);if(t.Type.isDomNode(n.container)){this.container=n.container}if(t.Type.isDomNode(n.errorsContainer)){this.errorsContainer=n.errorsContainer}this.moduleId=n.moduleId}this.bindEvents();this.fillTabs();g(this.constructor,e,D).set(this.id,this);this.adjustVisibility();this.syncEnumDefaultSelector()}babelHelpers.createClass(e,[{key:"getBooleanInputNames",value:function e(){return["multiple","mandatory","showFilter","isSearchable"]}},{key:"getSettingsContainer",value:function e(){if(this.container&&!this.settingsContainer){this.settingsContainer=this.container.querySelector('[data-role="main-user-field-settings-container"]')}return this.settingsContainer}},{key:"getSettingsTable",value:function e(){if(!this.settingsTable){var t=this.getSettingsContainer();if(t){this.settingsTable=t.querySelector('[data-role="main-user-field-settings-table"]')}}return this.settingsTable}},{key:"fillTabs",value:function e(){var t=this;var n=["common","labels","additional","list"];if(this.container){n.forEach((function(e){var n=t.container.querySelector('[data-tab="'+e+'"]');if(n){t.tabs.set(e,n)}}))}}},{key:"showTab",value:function e(t){var n=this;Array.from(this.tabs.keys()).forEach((function(e){if(e===t){n.tabs.get(e).classList.add("main-user-field-edit-tab-current");if(t==="list"){n.syncEnumDefaultSelector()}}else{n.tabs.get(e).classList.remove("main-user-field-edit-tab-current")}}))}},{key:"getInput",value:function e(t){if(this.container&&!this.inputs.has(t)){var n=this.container.querySelector('[data-role="main-user-field-'+t+'"]');if(n){this.inputs.set(t,n)}}return this.inputs.get(t)}},{key:"getInputValue",value:function e(t){if(t==="userTypeId"){return this.getSelectedUserTypeId()}var n=this.getInput(t);if(n){if(this.getBooleanInputNames().includes(t)){return n.checked?"Y":"N"}return n.value}return""}},{key:"bindEvents",value:function e(){var n=this;var i=this.getInput("userTypeId");if(i){t.Event.bind(i,"change",this.handleUserTypeChange.bind(this))}var r=this.getInput("editFormLabel");if(r&&r.parentElement&&r.parentElement.parentElement){var a=r.parentElement.parentElement.dataset["language"];var s=this.getInput("editFormLabel-"+a);if(s){t.Event.bind(r,"change",(function(){n.syncLabelInputs(r,s)}));t.Event.bind(s,"change",(function(){n.syncLabelInputs(s,r)}))}}var l=this.container.querySelector('[data-role="main-user-field-enum-add"]');if(l){t.Event.bind(l,"click",this.addEnumRow.bind(this))}var o=Array.from(this.container.querySelectorAll('[data-role="main-user-field-enum-delete"]'));o.forEach((function(e){t.Event.bind(e,"click",n.deleteEnumRow.bind(n))}));var u=Array.from(this.container.querySelectorAll('[data-role="main-user-field-enum-row"]'));u.forEach((function(e){var i=e.querySelector('[data-role="main-user-field-enum-value"]');if(i){t.Event.bind(i,"change",n.syncEnumDefaultSelector.bind(n))}}));t.Event.bind(this.saveButton.getContainer(),"click",(function(e){e.preventDefault();n.save()}),{passive:false});if(this.deleteButton){t.Event.bind(this.deleteButton.getContainer(),"click",(function(e){e.preventDefault();n["delete"]()}))}}},{key:"getSelectedUserTypeId",value:function e(){var t=this.getSelectedOption("userTypeId");if(t){return t.value}return null}},{key:"getSelectedOption",value:function e(t){var n=this.getInput(t);if(n){var i=Array.from(n.querySelectorAll("option"));var r=n.selectedIndex;return i[r]}return null}},{key:"getSelectedOptions",value:function e(t){var n=this.getInput(t);if(n&&n instanceof HTMLSelectElement){return n.selectedOptions}return null}},{key:"handleUserTypeChange",value:function e(){var n=this;if(this.isProgress){return}var i=this.getSettingsTable();if(!i){return}var r=this.getSelectedUserTypeId();if(!r){return}this.startProgress();t.ajax.runComponentAction("bitrix:main.field.config.detail","getSettings",{data:{userTypeId:r},analyticsLabel:"mainUserFieldConfigGetSettings",mode:"class"}).then((function(e){n.stopProgress();var r="";if(e.data.html&&e.data.html.length>0){r=e.data.html}t.Runtime.html(i,r).then((function(){n.adjustVisibility()}))}))["catch"]((function(e){n.stopProgress();n.showErrors(e.errors)}))}},{key:"getLoader",value:function e(){if(!this.loader){this.loader=new n.Loader({size:150})}return this.loader}},{key:"startProgress",value:function e(){this.isProgress=true;if(!this.getLoader().isShown()){this.getLoader().show(this.container)}this.hideErrors()}},{key:"stopProgress",value:function e(){var n=this;this.isProgress=false;this.getLoader().hide();setTimeout((function(){n.saveButton.setWaiting(false);t.Dom.removeClass(n.saveButton.getContainer(),"ui-btn-wait");if(n.deleteButton){n.deleteButton.setWaiting(false);t.Dom.removeClass(n.deleteButton.getContainer(),"ui-btn-wait")}}),200)}},{key:"showErrors",value:function e(n){var i="";n.forEach((function(e){i+=e}));if(t.Type.isDomNode(this.errorsContainer)){this.errorsContainer.innerText=i;this.errorsContainer.parentElement.style.display="block"}else{console.error(i)}}},{key:"hideErrors",value:function e(){if(t.Type.isDomNode(this.errorsContainer)){this.errorsContainer.innerText="";this.errorsContainer.parentElement.style.display="none"}}},{key:"getSettings",value:function e(){var t={};var n=this.container.querySelector('[data-role="main-user-field-settings"]');if(n){var i=new FormData(n);var r=h(i.entries()),a;try{for(r.s();!(a=r.n()).done;){var s=a.value;var l=s[0].substr(9,s[0].length-10);t[l]=s[1]}}catch(e){r.e(e)}finally{r.f()}}return t}},{key:"prepareFieldData",value:function e(){var n=this;if(!this.container){return{}}var i={};var r=Array.from(this.container.querySelectorAll('[data-role="main-user-field-label-container"]'));r.forEach((function(e){var t=e.dataset["language"];i[t]=n.getInputValue("editFormLabel-"+t)}));var a=[];var s=this.getInputValue("userTypeId");if(s==="enumeration"){this.syncEnumDefaultSelector();var l=this.getSelectedEnumDefaultAttributes();var o=100;var u=0;var d=Array.from(this.container.querySelectorAll('[data-role="main-user-field-enum-row"]'));d.forEach((function(e){var n=e.querySelector('[data-role="main-user-field-enum-value"]');if(!n){return}var i=t.Text.toInteger(e.dataset["id"]);var r=n.value;var s="N";if(i>0&&l.id.includes(i)||l.value.includes(r)){s="Y"}u+=o;a.push({value:n.value,def:s,sort:u,id:i})}))}var h=t.Text.toInteger(this.getInputValue("id"));var c=this.getInputValue("fieldName");if(h<=0){c=this.getInputValue("fieldPrefix")+c}return{id:h,editFormLabel:i,entityId:this.getInputValue("entityId"),fieldName:c,sort:this.getInputValue("sort"),multiple:this.getInputValue("multiple"),mandatory:this.getInputValue("mandatory"),showFilter:this.getInputValue("showFilter"),isSearchable:this.getInputValue("isSearchable"),userTypeId:s,settings:this.getSettings(),enum:a}}},{key:"save",value:function e(){var t=this;if(this.isProgress){return}if(!this.moduleId){return}this.startProgress();var n=this.prepareFieldData();var i=null;var a=this.getInput("editFormLabel");if(a&&a.parentElement&&a.parentElement.parentElement){i=a.parentElement.parentElement.dataset["language"]}var s=new r.UserField(n,{languageId:i,moduleId:this.moduleId});s.save().then((function(){t.afterSave(s);t.stopProgress()}))["catch"]((function(e){t.showErrors(e);t.stopProgress()}))}},{key:"delete",value:function e(){var n=this;if(this.isProgress){return}if(!this.moduleId){return}var a=t.Text.toInteger(this.getInputValue("id"));if(a<=0){return}i.MessageBox.confirm(t.Loc.getMessage("MAIN_FIELD_CONFIG_DELETE_CONFIRM"),(function(){return new Promise((function(e){var a=new r.UserField(n.prepareFieldData(),{moduleId:n.moduleId});n.startProgress();a["delete"]().then((function(){n.stopProgress();var r=n.getSlider();if(r){n.addDataToSlider("userFieldData",a.serialize());r.close()}else{i.MessageBox.alert(t.Loc.getMessage("MAIN_FIELD_CONFIG_DELETE_SUCCESS"))}e()}))["catch"]((function(t){n.stopProgress();n.showErrors(t);e()}))}))}),null,(function(e){n.stopProgress();e.close()}))}},{key:"adjustVisibility",value:function e(){var t=this.getSettingsTable();var n=document.querySelector('[data-role="tab-additional"]');var i=document.querySelector('[data-role="tab-list"]');if(!t||!n||!i){return}if(t.childElementCount<=0){n.style.display="none"}else{n.style.display="block"}var r=this.getSelectedUserTypeId();if(r==="enumeration"){i.style.display="flex"}else{i.style.display="none"}if(r==="boolean"){this.changeInputVisibility("multiple","none");this.changeInputVisibility("mandatory","none")}else{this.changeInputVisibility("multiple","block");this.changeInputVisibility("mandatory","block")}}},{key:"changeInputVisibility",value:function e(t,n){var i=this.getInput(t);if(i&&i.parentElement&&i.parentElement.parentElement){i.parentElement.parentElement.style.display=n}}},{key:"afterSave",value:function e(n){this.addDataToSlider("userFieldData",n.serialize());var i=this.getSlider();if(i){i.close()}else{var r=t.Text.toInteger(this.getInputValue("id"));if(r<=0){if(!!n.getDetailUrl()){location.href=n.getDetailUrl();return}this.getInput("id").value=n.getId();var a=this.getInput("fieldPrefix");if(a&&a.parentElement&&a.parentElement.parentElement){a.parentElement.parentElement.classList.remove("main-user-field-name-with-prefix");t.Dom.remove(a.parentElement)}this.getInput("fieldName").value=n.getName();this.getInput("fieldName").disabled=true;this.getInput("fieldName").parentElement.classList.remove("ui-ctl-inline")}}}},{key:"getSlider",value:function e(){if(t.Reflection.getClass("BX.SidePanel")){return BX.SidePanel.Instance.getSliderByWindow(window)}return null}},{key:"addDataToSlider",value:function e(n,i){if(t.Type.isString(n)){var r=this.getSlider();if(r){r.getData().set(n,i);BX.SidePanel.Instance.postMessage(r,"userfield-list-update")}}}},{key:"syncLabelInputs",value:function e(t,n){var i=t.closest(".main-user-field-edit-tab");if(i&&i.classList.contains("main-user-field-edit-tab-current")){n.value=t.value}}},{key:"addEnumRow",value:function e(){var n=this.container.querySelector('[data-role="main-user-field-enum-add"]');if(n){var i=t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['<input class="ui-ctl-element" type="text" name="ENUM[][VALUE]" value=""\n\t\t\t\t\t\t\t\t data-role="main-user-field-enum-value"\n\t\t\t\t\t\t\t\t onchange="','">'])),this.syncEnumDefaultSelector.bind(this));var r=t.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="main-user-field-enum-row" data-role="main-user-field-enum-row">\n\t\t\t\t\t\t<div class="main-user-field-enum-row-inner ui-ctl ui-ctl-textbox ui-ctl-w100 ui-ctl-row">\n\t\t\t\t\t\t\t<span class="main-user-field-enum-row-draggable" style=""></span>\n\t\t\t\t\t\t\t','\n\t\t\t\t\t\t\t<div class="main-user-field-enum-delete" onclick="','"></div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>'])),i,this.deleteEnumRow.bind(this));t.Dom.append(r,document.querySelector(".main-user-field-enum-row-list"));i.focus();var a=new E;a.init(r)}}},{key:"deleteEnumRow",value:function e(n){var i=n.target;t.Dom.remove(i.parentElement);this.syncEnumDefaultSelector()}},{key:"getSelectedEnumDefaultAttributes",value:function e(){var n={id:[],value:[]};var i=this.getSelectedOptions("enumDefault");if(i){Array.from(i).forEach((function(e){if(e.dataset["id"]&&e.dataset["id"]>0){n["id"].push(t.Text.toInteger(e.dataset["id"]))}else{n["value"].push(e.value)}}))}return n}},{key:"syncEnumDefaultSelector",value:function e(){var n=this.getInputValue("userTypeId");if(n==="enumeration"){var i=this.getInput("enumDefault");if(!i){return}var r=this.getInputValue("multiple");if(r==="Y"){i.multiple=true;i.size=3;i.parentElement.classList.add("ui-ctl-multiple-select");i.parentElement.classList.remove("ui-ctl-after-icon");i.parentElement.classList.remove("ui-ctl-dropdown")}else{i.multiple=false;i.parentElement.classList.remove("ui-ctl-multiple-select");i.parentElement.classList.add("ui-ctl-after-icon");i.parentElement.classList.add("ui-ctl-dropdown")}var a=this.getSelectedEnumDefaultAttributes();var s=Array.from(i.querySelectorAll("option"));s.forEach((function(e){if(e.value!=="empty"){t.Dom.remove(e)}}));var l=Array.from(this.container.querySelectorAll('[data-role="main-user-field-enum-row"]'));l.forEach((function(e){var n=t.Text.toInteger(e.dataset["id"]);var r=e.querySelector('[data-role="main-user-field-enum-value"]');if(!r){return}var s=r.value;var l=n>0&&a.id.includes(n)||a.value.includes(s);if(s.length>0){i.appendChild(t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(["<option ",' value="','" data-id="','">',"</option>"])),l?'selected="selected"':"",t.Text.encode(s),n,t.Text.encode(s)))}}))}}}],[{key:"handleLeftMenuClick",value:function t(n,i){if(g(e,e,D)){var r=g(e,e,D).get(n);if(r){r.showTab(i)}}}}]);return e}();var D={writable:true,value:new Map};var E=function(){function e(){babelHelpers.classCallCheck(this,e);this.itemContainer=null;this.draggableItemContainer=null;this.dragElement=null}babelHelpers.createClass(e,[{key:"init",value:function e(t){this.itemContainer=t;var n=this.itemContainer.querySelector(".main-user-field-enum-row-draggable");if(jsDD){n.onbxdragstart=this.onDragStart.bind(this);n.onbxdrag=this.onDrag.bind(this);n.onbxdragstop=this.onDragStop.bind(this);jsDD.registerObject(n);this.itemContainer.onbxdestdraghover=this.onDragEnter.bind(this);this.itemContainer.onbxdestdraghout=this.onDragLeave.bind(this);this.itemContainer.onbxdestdragfinish=this.onDragDrop.bind(this);jsDD.registerDest(this.itemContainer,30)}}},{key:"onDragStart",value:function e(){t.Dom.addClass(this.itemContainer,"main-user-field-enum-row-disabled");if(!this.dragElement){this.dragElement=this.itemContainer.cloneNode(true);this.dragElement.style.position="absolute";this.dragElement.style.width=this.itemContainer.offsetWidth+"px";this.dragElement.className="main-user-field-enum-row-drag";t.Dom.append(this.dragElement,document.body)}}},{key:"onDrag",value:function e(t,n){if(this.dragElement){this.dragElement.style.left=t+"px";this.dragElement.style.top=n+"px"}}},{key:"onDragStop",value:function e(){t.Dom.removeClass(this.itemContainer,"main-user-field-enum-row-disabled");t.Dom.remove(this.dragElement);this.dragElement=null}},{key:"onDragEnter",value:function e(t){this.draggableBtnContainer=t.closest(".main-user-field-enum-row");if(this.draggableBtnContainer!==this.itemContainer){this.showDragTarget()}}},{key:"onDragLeave",value:function e(){this.hideDragTarget()}},{key:"onDragDrop",value:function e(){if(this.draggableBtnContainer!==this.itemContainer){this.hideDragTarget();t.Dom.remove(this.draggableBtnContainer);t.Dom.insertBefore(this.draggableBtnContainer,this.itemContainer)}}},{key:"showDragTarget",value:function e(){t.Dom.addClass(this.itemContainer,"main-user-field-enum-row-target-shown");this.getDragTarget().style.height=this.itemContainer.offsetHeight+"px"}},{key:"hideDragTarget",value:function e(){t.Dom.removeClass(this.itemContainer,"main-user-field-enum-row-target-shown");this.getDragTarget().style.height=0}},{key:"getDragTarget",value:function e(){if(!this.dragTarget){this.dragTarget=t.Tag.render(u||(u=babelHelpers.taggedTemplateLiteral(['<div class="main-user-field-enum-row-drag-target"></div>'])));t.Dom.prepend(this.dragTarget,this.itemContainer)}return this.dragTarget}}]);return e}();var I=function(){function e(){babelHelpers.classCallCheck(this,e);this.container=document.querySelector(".main-user-field-enum-row-list");this.height=null}babelHelpers.createClass(e,[{key:"init",value:function e(){this.container.onbxdestdraghover=BX.delegate(this.onDragEnter,this);this.container.onbxdestdraghout=BX.delegate(this.onDragLeave,this);this.container.onbxdestdragfinish=BX.delegate(this.onDragDrop,this);jsDD.registerDest(this.container,40)}},{key:"onDragEnter",value:function e(t){this.draggableBtnContainer=t.closest(".main-user-field-enum-row");this.height=this.draggableBtnContainer.offsetHeight;this.showDragTarget()}},{key:"onDragLeave",value:function e(){this.hideDragTarget()}},{key:"onDragDrop",value:function e(){this.hideDragTarget();t.Dom.remove(this.draggableBtnContainer);t.Dom.insertBefore(this.draggableBtnContainer,this.dragTarget)}},{key:"showDragTarget",value:function e(){t.Dom.addClass(this.container,"main-user-field-enum-row-list-target-shown");this.getDragTarget().style.height=this.height+"px"}},{key:"hideDragTarget",value:function e(){t.Dom.removeClass(this.container,"main-user-field-enum-row-list-target-shown");this.getDragTarget().style.height=0}},{key:"getDragTarget",value:function e(){if(!this.dragTarget){this.dragTarget=t.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['<div class="main-user-field-enum-row-list-target"></div>'])));t.Dom.append(this.dragTarget,this.container)}return this.dragTarget}}]);return e}();y.Config=b;y.DragDropItem=E;y.DragDropBtnContainer=I})(this.window=this.window||{},BX,BX,BX.UI.Dialogs,BX.UI.UserField,BX.UI);
//# sourceMappingURL=script.map.js