this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};this.BX.Catalog.Store=this.BX.Catalog.Store||{};(function(e,t,i,r,n,a,s,o,l,u,d,c){"use strict";o=o&&o.hasOwnProperty("default")?o["default"]:o;var h;var v=function(){function e(t){babelHelpers.classCallCheck(this,e);this.editor=t}babelHelpers.createClass(e,[{key:"load",value:function e(t,i){if(!this.hintPopup){this.hintPopup=new r.Popup("ui-hint-popup-"+this.editor.getId(),null,{darkMode:true,closeIcon:true,animation:"fading-slide"})}this.hintPopup.setBindElement(t);this.hintPopup.adjustPosition();this.hintPopup.setContent(u.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-hint-content'>","</div>\n\t\t"])),u.Text.encode(i)));return this.hintPopup}},{key:"show",value:function e(){if(this.hintPopup){this.hintPopup.show()}}},{key:"close",value:function e(){if(this.hintPopup){this.hintPopup.close()}}}]);return e}();function f(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function g(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?f(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):f(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function p(e,t,i){E(e,t);t.set(e,i)}function E(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var y=new WeakMap;var b=function(){function e(t){babelHelpers.classCallCheck(this,e);p(this,y,{writable:true,value:{basePrice:0,finalPrice:0,extra:null,extraType:e.EXTRA_TYPE_PERCENTAGE}});babelHelpers.classPrivateFieldSet(this,y,g(g({},babelHelpers.classPrivateFieldGet(this,y)),t))}babelHelpers.createClass(e,[{key:"getBasePrice",value:function e(){return babelHelpers.classPrivateFieldGet(this,y).basePrice}},{key:"getFinalPrice",value:function e(){return babelHelpers.classPrivateFieldGet(this,y).finalPrice}},{key:"getExtra",value:function e(){return babelHelpers.classPrivateFieldGet(this,y).extra}},{key:"getExtraType",value:function e(){return babelHelpers.classPrivateFieldGet(this,y).extraType}},{key:"calculateBasePrice",value:function t(i){babelHelpers.classPrivateFieldGet(this,y).basePrice=i;babelHelpers.classPrivateFieldGet(this,y).extra=u.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).extra);if(babelHelpers.classPrivateFieldGet(this,y).extraType===e.EXTRA_TYPE_MONETARY){babelHelpers.classPrivateFieldGet(this,y).finalPrice=babelHelpers.classPrivateFieldGet(this,y).basePrice+babelHelpers.classPrivateFieldGet(this,y).extra}else{babelHelpers.classPrivateFieldGet(this,y).finalPrice=babelHelpers.classPrivateFieldGet(this,y).basePrice*(1+babelHelpers.classPrivateFieldGet(this,y).extra/100)}return this}},{key:"calculateFinalPrice",value:function t(i){babelHelpers.classPrivateFieldGet(this,y).finalPrice=i;var r=u.Text.toNumber(babelHelpers.classPrivateFieldGet(this,y).basePrice);if(r<=0){babelHelpers.classPrivateFieldGet(this,y).extraType=e.EXTRA_TYPE_MONETARY}if(babelHelpers.classPrivateFieldGet(this,y).extraType===e.EXTRA_TYPE_MONETARY){babelHelpers.classPrivateFieldGet(this,y).extra=babelHelpers.classPrivateFieldGet(this,y).finalPrice-r}else{babelHelpers.classPrivateFieldGet(this,y).extra=(babelHelpers.classPrivateFieldGet(this,y).finalPrice/r-1)*100}return this}},{key:"calculateExtra",value:function e(t){babelHelpers.classPrivateFieldGet(this,y).extra=t;if(u.Type.isNil(t)){return this}return this.calculateBasePrice(babelHelpers.classPrivateFieldGet(this,y).basePrice)}},{key:"calculateExtraType",value:function t(i){if(i!==e.EXTRA_TYPE_MONETARY){i=e.EXTRA_TYPE_PERCENTAGE}babelHelpers.classPrivateFieldGet(this,y).extraType=i;return this.calculateFinalPrice(babelHelpers.classPrivateFieldGet(this,y).finalPrice)}}]);return e}();babelHelpers.defineProperty(b,"EXTRA_TYPE_PERCENTAGE",1);babelHelpers.defineProperty(b,"EXTRA_TYPE_MONETARY",2);var m,P,S;function C(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=T(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var r=0;var n=function e(){};return{s:n,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(s)throw o}}}}function T(e,t){if(!e)return;if(typeof e==="string")return I(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return I(e,t)}function I(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++){r[i]=e[i]}return r}function A(e,t){R(e,t);t.add(e)}function R(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function F(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var k="EDIT";var _="SET";var w=2;var O=new WeakSet;var N=new WeakSet;var D=new WeakSet;var H=new WeakSet;var B=new WeakSet;var M=new WeakSet;var U=new WeakSet;var G=new WeakSet;var L=new WeakSet;var x=new WeakSet;var V=new WeakSet;var X=new WeakSet;var W=new WeakSet;var q=function(){function e(t,i,r,n){babelHelpers.classCallCheck(this,e);A(this,W);A(this,X);A(this,V);A(this,x);A(this,L);A(this,G);A(this,U);A(this,M);A(this,B);A(this,H);A(this,D);A(this,N);A(this,O);babelHelpers.defineProperty(this,"fields",{});babelHelpers.defineProperty(this,"storeSelectors",[]);babelHelpers.defineProperty(this,"externalActions",[]);babelHelpers.defineProperty(this,"cache",new u.Cache.MemoryCache);babelHelpers.defineProperty(this,"modeChanges",{EDIT:k,SET:_});babelHelpers.defineProperty(this,"validatingFields",new Map);this.setId(t);this.setSettings(r);this.setEditor(n);this.setModel(i,r);this.initFields(i);F(this,N,Y).call(this);F(this,D,K).call(this);F(this,B,Q).call(this,this.getSettingValue("storeHeaderMap",{}));F(this,O,j).call(this);requestAnimationFrame(this.initHandlers.bind(this))}babelHelpers.createClass(e,[{key:"getNode",value:function e(){var t=this;return this.cache.remember("node",(function(){var e=t.getField("ID",0);return t.getEditorContainer().querySelector('[data-id="'+e+'"]')}))}},{key:"getSelector",value:function e(){return this.mainSelector}},{key:"getBarcodeSelector",value:function e(){return this.barcodeSelector}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=u.Type.isPlainObject(t)?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"setEditor",value:function e(t){this.editor=t}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorContainer",value:function e(){return this.getEditor().getContainer()}},{key:"getHintPopup",value:function e(){return this.getEditor().getHintPopup()}},{key:"initHandlers",value:function e(){var t=this.getEditor();this.getNode().querySelectorAll("input").forEach((function(e){u.Event.bind(e,"input",t.changeProductFieldHandler);u.Event.bind(e,"change",t.changeProductFieldHandler);u.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}));this.getNode().querySelectorAll("select").forEach((function(e){u.Event.bind(e,"change",t.changeProductFieldHandler);u.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}},{key:"initHandlersForSelectors",value:function e(){var t=this;var i=this.getEditor();var r=["MAIN_INFO","BARCODE_INFO"];var n=this.getSettingValue("storeHeaderMap",{});r=[].concat(babelHelpers.toConsumableArray(r),babelHelpers.toConsumableArray(Object.keys(n)));r.forEach((function(e){t.getNode().querySelectorAll('[data-name="'+e+'"] input[type="text"]').forEach((function(e){u.Event.bind(e,"input",i.changeProductFieldHandler);u.Event.bind(e,"change",i.changeProductFieldHandler);u.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}))}},{key:"setRowNumber",value:function e(t){this.getNode().querySelectorAll(".main-grid-row-number").forEach((function(e){e.textContent=t+"."}))}},{key:"getFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i;if(!u.Type.isArrayFilled(t)){i=u.Runtime.clone(this.fields)}else{i={};var r=C(t),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;i[a]=this.getField(a)}}catch(e){r.e(e)}finally{r.f()}}return i}},{key:"initFields",value:function e(t){this.getModel().initFields(t,false);this.setFields(t)}},{key:"setFields",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.setField(i,t[i])}}}},{key:"getField",value:function e(t,i){return this.fields.hasOwnProperty(t)?this.fields[t]:i}},{key:"setField",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.fields[t]=i;if(r){this.getModel().setField(t,i)}}},{key:"getUiFieldId",value:function e(t){return this.getId()+"_"+t}},{key:"getBasePrice",value:function e(){return this.getField("BASE_PRICE",0)}},{key:"getAmount",value:function e(){return this.getField("AMOUNT",1)}},{key:"updateFieldByEvent",value:function e(t,i){var r=i.target;var n=r.type==="checkbox"?r.checked:r.value;var a=i.type==="input"||i.type==="change"?k:_;this.updateField(t,n,a)}},{key:"updateDropdownField",value:function e(t,i){this.updateField(t,i,k)}},{key:"updateField",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:_;this.resetExternalActions();this.updateFieldValue(t,i,r);this.executeExternalActions()}},{key:"updateFieldValue",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:_;switch(t){case"SKU_ID":this.changeProductId(i);break;case"BASE_PRICE":this.changeBasePrice(i,r);break;case"PURCHASING_PRICE":this.changePurchasingPrice(i,r);break;case"AMOUNT":this.changeAmount(i,r);break;case"MEASURE_CODE":this.changeMeasureCode(i,r);break;case"BARCODE":this.changeBarcode(i,r);break;case"STORE_FROM":case"STORE_TO":this.changeStore(i,t);break;case"STORE_FROM_TITLE":case"STORE_TO_TITLE":this.changeStoreName(i,t);break;case"NAME":case"MAIN_INFO":this.changeProductName(i,r);break;case"SORT":this.changeSort(i,r);break}}},{key:"updateFieldByName",value:function e(t,i){switch(t){case"TAX_INCLUDED":this.setTaxIncluded(i);break}}},{key:"changeProductId",value:function e(t){var i=this.parseInt(t);this.setProductId(i)}},{key:"handleCopyAction",value:function e(t,i){var r;(r=this.getEditor())===null||r===void 0?void 0:r.copyRow(this);var n=i.getMenuWindow();if(n){n.destroy()}}},{key:"handleDeleteAction",value:function e(t,i){var r;(r=this.getEditor())===null||r===void 0?void 0:r.deleteRow(this);var n=i.getMenuWindow();if(n){n.destroy()}this.unsubscribeEvents();F(this,G,J).call(this)}},{key:"unsubscribeEvents",value:function e(){this.getBarcodeSelector().unsubscribeEvents()}},{key:"handleSelectExtraPriceType",value:function e(t,i){this.changeExtraType(i.type,k);var r=i.getMenuWindow();if(r){r.destroy()}}},{key:"changeExtraType",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r="%";if(t===b.EXTRA_TYPE_MONETARY){r=this.getEditor().getCurrencyText()}else{t=b.EXTRA_TYPE_PERCENTAGE}if(t===this.getField("BASE_PRICE_EXTRA_RATE")){return}if(i===k){var n=F(this,U,$).call(this).calculateExtraType(t);this.changeExtra(n.getExtra());this.changeBasePrice(n.getFinalPrice())}var a=this.getNode().querySelector('[data-name="BASE_PRICE_EXTRA_RATE"]');if(u.Type.isDomNode(a)){a.innerHTML=r}this.setField("BASE_PRICE_EXTRA_RATE",t)}},{key:"changeExtra",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r=u.Type.isNil(t)||t===""?null:this.parseFloat(t,this.getPricePrecision());this.setField("BASE_PRICE_EXTRA",r);if(r===null){return}if(i===k){var n=F(this,U,$).call(this).calculateExtra(r);this.changeBasePrice(n.getFinalPrice())}else{var a=this.getNode().querySelector('[data-name="BASE_PRICE_EXTRA"]');if(u.Type.isDomNode(a)){a.value=r}}}},{key:"changeBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r=this.parseFloat(t,this.getPricePrecision());this.setBasePrice(r,i)}},{key:"changePurchasingPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r=this.parseFloat(t,this.getPricePrecision());this.setPurchasingPrice(r,i)}},{key:"changeAmount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r=this.parseFloat(t,this.getQuantityPrecision());this.setAmount(r,i)}},{key:"changeMeasureCode",value:function e(t){var i=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;this.getEditor().getMeasures().filter((function(e){return e.CODE===t})).forEach((function(e){return i.setMeasure(e,r)}))}},{key:"changeBarcode",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r=t.toString();var n=this.getField("BARCODE")!==r;if(n&&i===_){this.setField("BARCODE",r);this.setField("DOC_BARCODE",r);this.addActionProductChange()}else if(i===k){this.setField("DOC_BARCODE",r);this.addActionProductChange()}}},{key:"changeStore",value:function e(t,i){var r=u.Text.toNumber(t);var n=this.getField(i)!==r;if(n){this.setField(i,r);this.setStoreAmount(t,i);this.addActionProductChange()}}},{key:"changeStoreName",value:function e(t,i){var r=t.toString();this.setField(i,r);this.addActionProductChange()}},{key:"changeProductName",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r=t.toString();var n=this.getField("NAME")!==r;if(n&&i===_){this.setField("NAME",r);this.addActionProductChange()}}},{key:"changeSort",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;var r=this.parseInt(t);if(i===_){this.setField("SORT",r)}var n=this.getField("SORT")!==r;if(n){this.addActionProductChange()}}},{key:"refreshFieldsLayout",value:function e(){var t,i,r;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];for(var a in this.fields){if(this.fields.hasOwnProperty(a)&&!n.includes(a)){this.updateUiField(a,this.fields[a])}}this.updateUiMeasure(this.getField("MEASURE_CODE"),this.getField("MEASURE_NAME"));(t=this.getSelector())===null||t===void 0?void 0:t.reloadFileInput();(i=this.getSelector())===null||i===void 0?void 0:i.layout();(r=this.getBarcodeSelector())===null||r===void 0?void 0:r.layout();this.updateUiStoreValues()}},{key:"setModel",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i="catalog_document_grid_"+this.getId();if(i){var r=l.ProductModel.getById(i);if(r){this.model=r}}if(!(this.model instanceof l.ProductModel)){this.model=new l.ProductModel({id:i,currency:this.getEditor().getCurrencyId(),iblockId:t["IBLOCK_ID"],basePriceId:t["BASE_PRICE_ID"],skuTree:u.Type.isStringFilled(t["SKU_TREE"])?JSON.parse(t["SKU_TREE"]):null,storeMap:t["STORE_AMOUNT_MAP"],fields:t});if(u.Type.isObject(t["IMAGE_INFO"])){this.model.getImageCollection().setPreview(t["IMAGE_INFO"]["preview"]);this.model.getImageCollection().setEditInput(t["IMAGE_INFO"]["input"]);this.model.getImageCollection().setMorePhotoValues(t["IMAGE_INFO"]["values"])}if(!u.Type.isNil(t["DETAIL_URL"])){this.model.setDetailPath(t["DETAIL_URL"])}}n.EventEmitter.subscribe(this.model,"onErrorsChange",u.Runtime.debounce(F(this,G,J),500,this));n.EventEmitter.subscribe(this.model,"onChangeStoreData",this.updateUiStoreValues.bind(this))}},{key:"getModel",value:function e(){return this.model}},{key:"setProductId",value:function e(t){var i=this.getField("PRODUCT_ID")!==t;if(i){this.setField("PRODUCT_ID",t);this.setField("SKU_ID",t);this.updateUiStoreValues();this.addActionProductChange();this.addActionUpdateTotal()}}},{key:"setBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;t=Math.max(t,0);if(i===_){this.updateUiField("BASE_PRICE",t.toFixed(this.getPricePrecision()))}this.setField("BASE_PRICE",t);this.addActionProductChange();this.addActionUpdateTotal();this.updateRowTotalPrice()}},{key:"updateRowTotalPrice",value:function e(){var t=this.getEditor().getSettingValue("totalCalculationSumField","PURCHASING_PRICE");var i=this.getAmount()*this.getField(t,0);i=Math.max(i,0);this.setField("TOTAL_PRICE",i);this.updateUiField("TOTAL_PRICE",i.toFixed(this.getPricePrecision()))}},{key:"updateProductStoreValues",value:function e(){var t=this;this.storeSelectors.forEach((function(e){e.setProductId(t.getModel().getSkuId())}))}},{key:"updateUiStoreValues",value:function e(){var t=this;var r=this.getSettingValue("storeHeaderMap",{});Object.keys(r).forEach((function(e){var n=r[e];var a=t.getField(n);if(n==="STORE_FROM"){var s=t.model.getStoreCollection().getStoreAmount(a);if(s<=0){var o=t.model.getStoreCollection().getMaxFilledStore();var l=i.StoreSelector.getById(t.getId()+"_"+e);if(o.AMOUNT>s&&l){l.onStoreSelect(o.STORE_ID,o.STORE_TITLE);a=o.STORE_ID}}}t.setStoreAmount(a,n)}))}},{key:"setStoreAmount",value:function e(t,i){var r=this;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:_;if(n===_){var a;var s={_AMOUNT:function e(){return r.model.getStoreCollection().getStoreAmount(t)},_RESERVED:function e(){return r.model.getStoreCollection().getStoreReserved(t)},_AVAILABLE_AMOUNT:function e(){return r.model.getStoreCollection().getStoreAvailableAmount(t)}};for(var o in s){if(Object.hasOwnProperty.call(s,o)){var l=this.getNode().querySelector("[data-name="+i+o+"]");if(l){a=s[o]()||0;l.innerHTML=a+" "+u.Text.encode(this.getField("MEASURE_NAME"))}}}}}},{key:"setPurchasingPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;t=Math.max(t,0);if(i===_){this.updateUiField("PURCHASING_PRICE",t.toFixed(this.getPricePrecision()))}this.setField("PURCHASING_PRICE",t);this.addActionProductChange();this.addActionUpdateTotal();this.updateRowTotalPrice()}},{key:"setAmount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;if(i===_){this.updateUiInputField("AMOUNT",t)}var r=this.getField("AMOUNT")!==t;if(r){this.setField("AMOUNT",t);this.addActionProductChange();this.addActionUpdateTotal();this.updateRowTotalPrice()}}},{key:"setMeasure",value:function e(t){var i=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:_;if(this.model.isEmpty()){this.setField("MEASURE_CODE",t.CODE);this.setField("MEASURE_NAME",t.SYMBOL);this.updateUiMeasure(t.CODE,t.SYMBOL);return}if(r===k){this.getModel().showSaveNotifier("measureChanger_"+this.getId(),{title:u.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_MEASURE_CHANGED_QUERY"),declineCancelTitle:u.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_DECLINE_SAVE"),events:{onSave:function e(){i.setField("MEASURE_CODE",t.CODE);i.setField("MEASURE_NAME",t.SYMBOL);i.updateUiMeasure(i.getField("MEASURE_CODE"),i.getField("MEASURE_NAME"));i.getModel().save(["MEASURE_CODE","MEASURE_NAME"])},onCancel:function e(){i.updateUiMeasure(i.getField("MEASURE_CODE"),i.getField("MEASURE_NAME"))}}})}else{this.updateUiMeasure(t.CODE,t.SYMBOL)}this.addActionProductChange()}},{key:"getInputByFieldName",value:function e(t){var i=this.getUiFieldId(t);var r=document.getElementById(i);if(!u.Type.isElementNode(r)){r=this.getNode().querySelector('[name="'+i+'"]')}return r}},{key:"getInputWrapperByFieldName",value:function e(t){var i=this.getInputByFieldName(t);if(u.Type.isElementNode(i)){return u.Type.isElementNode(i.parentNode)?i.parentNode:i}return undefined}},{key:"updateUiInputField",value:function e(t,i){var r=this.getInputByFieldName(t);if(u.Type.isElementNode(r)){r.value=i}}},{key:"updateUiCheckboxField",value:function e(t,i){var r=this.getInputByFieldName(t);if(u.Type.isElementNode(r)){r.checked=i==="Y"}}},{key:"getMoneyFieldDropdownApi",value:function e(t){if(!u.Reflection.getClass("BX.Main.dropdownManager")){return null}return BX.Main.dropdownManager.getById(this.getId()+"_"+t+"_control")}},{key:"updateMoneyFieldUiWithDropdownApi",value:function e(t,i){if(t.getValue()===i){return}if(t.menu){t.menu.destroy()}var r=t.menu.itemsContainer.querySelector('[data-value="'+i+'"]');var n=r&&t.getMenuItem(r);if(n){t.refresh(n);t.selectItem(n)}}},{key:"updateUiMoneyField",value:function e(t,i,r){var n=this.getInputByFieldName(t);if(!u.Type.isElementNode(n)){return}n.dataset.value=i;var a=n.querySelector("span.main-dropdown-inner");if(!u.Type.isElementNode(a)){return}a.innerHTML=r}},{key:"updateUiMeasure",value:function e(t,i){this.updateUiMoneyField("MEASURE_CODE",t,u.Text.encode(i));this.updateUiStoreValues()}},{key:"updateUiHtmlField",value:function e(t,i){var r=this.getNode().querySelector('[data-name="'+t+'"]');if(u.Type.isElementNode(r)){r.innerHTML=i}}},{key:"updateUiCurrencyFields",value:function e(){var t=this;var i=this.getEditor().getCurrencyText();var r=""+this.getEditor().getCurrencyId();var n=["BASE_PRICE_CURRENCY","PURCHASING_PRICE_CURRENCY"];n.forEach((function(e){var n=[];n.push({NAME:i,VALUE:r});u.Dom.attr(t.getInputByFieldName(e),"data-items",n);t.updateUiMoneyField(e,r,i)}))}},{key:"updateUiField",value:function e(t,i){var r=this.getUiFieldName(t);if(!r){return}var n=this.getUiFieldType(t);if(!n){return}switch(n){case"input":this.updateUiInputField(r,i);break;case"money":i=BX.util.number_format(i,this.getPricePrecision(),".","");this.updateUiInputField(r,i);break;case"money_html":i=a.CurrencyCore.currencyFormat(i,this.getEditor().getCurrencyId(),true);this.updateUiHtmlField(r,i);break}}},{key:"getUiFieldName",value:function e(t){var i=null;switch(t){case"AMOUNT":case"MEASURE_CODE":case"BASE_PRICE":case"PURCHASING_PRICE":case"TOTAL_PRICE":i=t;break}return i}},{key:"getUiFieldType",value:function e(t){var i=["BASE_PRICE","PURCHASING_PRICE","TOTAL_PRICE"];if(i.includes(t)){var r,n;var a=(r=this.getEditor())===null||r===void 0?void 0:r.getColumnInfo(t);if((a===null||a===void 0?void 0:(n=a.editable)===null||n===void 0?void 0:n.TYPE)==="MONEY"){return"money"}return"money_html"}else if(t==="AMOUNT"){return"input"}return null}},{key:"parseInt",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return this.getEditor().parseInt(t,i)}},{key:"parseFloat",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this.getEditor().parseFloat(t,i,r)}},{key:"getPricePrecision",value:function e(){return this.getEditor().getPricePrecision()}},{key:"getQuantityPrecision",value:function e(){return this.getEditor().getQuantityPrecision()}},{key:"getCommonPrecision",value:function e(){return this.getEditor().getCommonPrecision()}},{key:"resetExternalActions",value:function e(){this.externalActions.length=0}},{key:"addExternalAction",value:function e(t){this.externalActions.push(t)}},{key:"addActionProductChange",value:function e(){this.addExternalAction({type:this.getEditor().actions.productChange,id:this.getId()})}},{key:"addActionUpdateTotal",value:function e(){this.addExternalAction({type:this.getEditor().actions.updateTotal})}},{key:"executeExternalActions",value:function e(){if(this.externalActions.length===0){return}this.getEditor().executeActions(this.externalActions);this.resetExternalActions()}},{key:"isEmptyRow",value:function e(){return!u.Type.isStringFilled(this.getField("NAME","").trim())&&this.model.isEmpty()&&this.getBasePrice()<=0}},{key:"validate",value:function e(){var t=[];if(!F(this,W,re).call(this,this.getAmount())){F(this,X,ie).call(this,"AMOUNT",F(this,W,re));t.push(u.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_INVALID_AMOUNT"))}return t}}]);return e}();function j(){var e=this;if(this.getEditor().isReadOnly()){return}var t=this.getNode().querySelector(".main-grid-cell-action .main-grid-cell-content");if(u.Type.isDomNode(t)){var i=u.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="#"\n\t\t\t\t\tclass="main-grid-row-action-button"\n\t\t\t\t></a>\n\t\t\t'])));u.Event.bind(i,"click",(function(t){var n=[{text:u.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_COPY_ACTION"),onclick:e.handleCopyAction.bind(e)},{text:u.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_DELETE_ACTION"),onclick:e.handleDeleteAction.bind(e)}];r.PopupMenu.show({id:e.getId()+"_actions_popup",bindElement:i,items:n});t.preventDefault();t.stopPropagation()}));u.Dom.append(i,t)}}function Y(){var e={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:this.getSettingValue("isAllowedCreationProduct",true),ENABLE_IMAGE_INPUT:true,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:true,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:true,ENABLE_EMPTY_PRODUCT_ERROR:true,RESTRICTED_PRODUCT_TYPES:[w],URL_BUILDER_CONTEXT:this.editor.getSettingValue("productUrlBuilderContext")},mode:s.ProductSelector.MODE_EDIT};this.mainSelector=new s.ProductSelector("catalog_document_grid_"+this.getId(),e);var t=this.getNode().querySelector('[data-name="MAIN_INFO"]');if(t){var i=t.querySelector(".main-grid-row-number");if(!u.Type.isDomNode(i)){t.appendChild(u.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-number"></div>']))))}var r=t.querySelector(".main-grid-row-product-selector");if(!u.Type.isDomNode(r)){r=u.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-product-selector"></div>'])));t.appendChild(r)}this.mainSelector.renderTo(r)}n.EventEmitter.subscribe(this.mainSelector,"onBeforeCreate",F(this,L,Z).bind(this))}function K(){var e={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,inputFieldName:"BARCODE",type:s.ProductSelector.INPUT_FIELD_BARCODE,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:this.getSettingValue("isAllowedCreationProduct",true),ENABLE_INFO_SPOTLIGHT:this.editor.getSettingValue("showBarcodeSpotlightInfo",true),ENABLE_BARCODE_QR_AUTH:this.editor.getSettingValue("showBarcodeQrAuth",true),ENABLE_IMAGE_INPUT:false,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:false,ENABLE_SKU_TREE:false,ENABLE_EMPTY_PRODUCT_ERROR:false,RESTRICTED_PRODUCT_TYPES:[w]},mode:s.ProductSelector.MODE_EDIT,scannerToken:this.getEditor().scannerToken};this.barcodeSelector=new s.ProductSelector("catalog_document_grid_"+this.getId()+"_barcode",e);var t=this.getNode().querySelector('[data-name="BARCODE_INFO"]');if(t){this.barcodeSelector.renderTo(t)}n.EventEmitter.subscribe(this.barcodeSelector,"onBeforeCreate",F(this,L,Z).bind(this));n.EventEmitter.subscribe(this.barcodeSelector,"onSpotlightClose",F(this,x,ee).bind(this));n.EventEmitter.subscribe(this.barcodeSelector,"onBarcodeQrClose",F(this,V,te).bind(this))}function Q(e){var t=this;Object.keys(e).forEach((function(r){var a={inputFieldId:e[r],inputFieldTitle:e[r]+"_TITLE",config:{ENABLE_SEARCH:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:t.getId()},mode:i.StoreSelector.MODE_EDIT,model:t.model};var s=new i.StoreSelector(t.getId()+"_"+r,a);var o=t.getNode().querySelector('[data-name="'+r+'"]');if(s){s.renderTo(o)}n.EventEmitter.subscribe(s,"onChange",u.Runtime.debounce(F(t,M,z).bind(t),500,t));t.storeSelectors.push(s)}))}function z(e){var t=this;var i=e.getData();i.fields.forEach((function(e){t.updateField(e.NAME,e.VALUE)}))}function $(){var e=u.Type.isNumber(this.getModel().getField("BASE_PRICE_EXTRA"))?this.getModel().getField("BASE_PRICE_EXTRA"):null;return new b({basePrice:u.Text.toNumber(this.getModel().getField("PURCHASING_PRICE")),finalPrice:u.Text.toNumber(this.getModel().getField("BASE_PRICE")),extra:e,extraType:u.Text.toNumber(this.getModel().getField("BASE_PRICE_EXTRA_RATE"))})}function J(){var e=this.getModel().getErrorCollection().getErrors();for(var t in e){if(t===s.ProductSelector.ErrorCodes.NOT_SELECTED_PRODUCT){this.getSelector().layoutErrors()}}this.getEditor().handleProductErrorsChange()}function Z(e){var t=e.getData(),i=t.model;i.setField("BARCODE",this.barcodeSelector.getNameInputFilledValue());i.setField("NAME",this.mainSelector.getNameInputFilledValue())}function ee(e){this.editor.closeBarcodeSpotlights()}function te(e){this.editor.closeBarcodeQrAuths()}function ie(e,t){var i=this;var r=this.getInputByFieldName(e);var n=this.getInputWrapperByFieldName(e);if(t(r.valueAsNumber)||this.validatingFields.get(e)){return}this.validatingFields.set(e,true);n.classList.add("main-grid-editor-cell-danger");var a=function a(s){if(Boolean(t(s.target.valueAsNumber))){i.validatingFields.set(e,false);u.Event.unbind(r,"blur",a);n.classList.remove("main-grid-editor-cell-danger")}};u.Event.bind(r,"blur",a)}function re(e){return e>0}var ne=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"_settings",{});this._settings=t?t:{};this.eventHandlers={}}babelHelpers.createClass(e,[{key:"registerEventHandler",value:function e(t,i){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(i);BX.addCustomEvent(this,t,i)}},{key:"fireEvent",value:function e(t,i){BX.onCustomEvent(this,t,i)}},{key:"unregisterEventHandlers",value:function e(t){if(this.eventHandlers[t]){for(var i=0;i<this.eventHandlers[t].length;i++){BX.removeCustomEvent(this,t,this.eventHandlers[t][i])}delete this.eventHandlers[t]}}}]);return e}();var ae,se,oe,le;function ue(e,t){ce(e,t);t.add(e)}function de(e,t,i){ce(e,t);t.set(e,i)}function ce(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function he(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ve=new WeakMap;var fe=new WeakMap;var ge=new WeakMap;var pe=new WeakMap;var Ee=new WeakSet;var ye=new WeakSet;var be=new WeakSet;var me=new WeakSet;var Pe=new WeakSet;var Se=new WeakSet;var Ce=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var r=arguments.length>2?arguments[2]:undefined;babelHelpers.classCallCheck(this,e);ue(this,Se);ue(this,Pe);ue(this,me);ue(this,be);ue(this,ye);ue(this,Ee);de(this,ve,{writable:true,value:void 0});de(this,fe,{writable:true,value:void 0});de(this,ge,{writable:true,value:void 0});de(this,pe,{writable:true,value:new u.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,ve,t);babelHelpers.classPrivateFieldSet(this,fe,i);babelHelpers.classPrivateFieldSet(this,ge,r)}babelHelpers.createClass(e,[{key:"show",value:function e(){this.getPopup().show()}},{key:"getPopup",value:function e(){var t=this;return babelHelpers.classPrivateFieldGet(this,pe).remember("settings-popup",(function(){return new r.Popup(babelHelpers.classPrivateFieldGet(t,ge).getId()+"_"+Math.random()*100,babelHelpers.classPrivateFieldGet(t,ve),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:he(t,ye,Ie).call(t)})}))}},{key:"updateCheckboxState",value:function e(){var t=this;var i=this.getPopup().getContentContainer();babelHelpers.classPrivateFieldGet(this,fe).filter((function(e){return e.action==="grid"&&u.Type.isArray(e.columns)})).forEach((function(e){var r=true;e.columns.forEach((function(e){if(!babelHelpers.classPrivateFieldGet(t,ge).getGrid().getColumnHeaderCellByName(e)){r=false}}));var n=i.querySelector('input[data-setting-id="'+e.id+'"]');if(u.Type.isDomNode(n)){n.checked=r}}))}}]);return e}();function Te(e){return babelHelpers.classPrivateFieldGet(this,fe).filter((function(t){return t.id===e}))[0]}function Ie(){var e=this;var t=u.Tag.render(ae||(ae=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-entity-editor-popup-create-field-list'></div>\n\t\t"])));babelHelpers.classPrivateFieldGet(this,fe).forEach((function(i){t.append(he(e,be,Ae).call(e,i))}));return t}function Ae(e){var t=u.Tag.render(se||(se=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="checkbox">\n\t\t'])));t.checked=e.checked;t.dataset.settingId=e.id;var i=u.Type.isStringFilled(e.desc)?u.Tag.render(oe||(oe=babelHelpers.taggedTemplateLiteral(['<span class="ui-entity-editor-popup-create-field-item-desc">',"</span>"])),e.desc):"";var r=u.Tag.render(le||(le=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="ui-ctl-block ui-entity-editor-popup-create-field-item ui-ctl-w100">\n\t\t\t\t<div class="ui-ctl-w10" style="text-align: center">','</div>\n\t\t\t\t<div class="ui-ctl-w75">\n\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-title">',"</span>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</label>\n\t\t"])),t,e.title,i);u.Event.bind(r,"change",he(this,me,Re).bind(this));return r}function Re(e){var t=he(this,Ee,Te).call(this,e.target.dataset.settingId);if(!t){return}var i=e.target.checked;he(this,Pe,Fe).call(this,t,i)}function Fe(e,t){var i=this;var r=[];var n=babelHelpers.classPrivateFieldGet(this,ge).getGrid().getRows().getHeadFirstChild().getCells();Array.from(n).forEach((function(e){if("name"in e.dataset){r.push(e.dataset.name)}}));u.ajax.runComponentAction(babelHelpers.classPrivateFieldGet(this,ge).getComponentName(),"setGridSetting",{mode:"class",data:{signedParameters:babelHelpers.classPrivateFieldGet(this,ge).getSignedParameters(),settingId:e.id,selected:t,currentHeaders:r}}).then((function(){e.checked=t;if(e.id==="ADD_NEW_ROW_TOP"){var r=t?"top":"bottom";babelHelpers.classPrivateFieldGet(i,ge).setSettingValue("newRowPosition",r);var n=babelHelpers.classPrivateFieldGet(i,ge).changeActivePanelButtons(r);var a=n.querySelector('[data-role="product-list-settings-button"]');i.getPopup().setBindElement(a)}else{babelHelpers.classPrivateFieldGet(i,ge).reloadGrid()}i.getPopup().close();var s=t?u.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_SETTING_ENABLED"):u.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_SETTING_DISABLED");he(i,Se,ke).call(i,s.replace("#NAME#",e.title),{category:"popup-settings"})}))}function ke(e,t){t=t||{};BX.UI.Notification.Center.notify({content:e,stack:t.stack||null,position:"top-right",width:"auto",category:t.category||null,autoHideDelay:t.autoHideDelay||3e3})}function _e(e,t){Oe(e,t);t.add(e)}function we(e,t,i){Oe(e,t);t.set(e,i)}function Oe(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Ne(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var De=new WeakMap;var He=new WeakMap;var Be=new WeakSet;var Me=new WeakSet;var Ue=new WeakSet;var Ge=new WeakSet;var Le=new WeakSet;var xe=new WeakSet;var Ve=function(){function e(t,i){babelHelpers.classCallCheck(this,e);_e(this,xe);_e(this,Le);_e(this,Ge);_e(this,Ue);_e(this,Me);_e(this,Be);babelHelpers.defineProperty(this,"fieldHintIsBusy",false);babelHelpers.defineProperty(this,"activeHintGuide",null);we(this,De,{writable:true,value:void 0});we(this,He,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,He,t);babelHelpers.classPrivateFieldSet(this,De,i)}babelHelpers.createClass(e,[{key:"processFieldTour",value:function e(t,i,r){var n=this;var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(this.fieldHintIsBusy){return}this.fieldHintIsBusy=true;i.events={onClose:function e(){r();n.fieldHintIsBusy=false;n.activeHintGuide=null}};if(Ne(this,Ue,qe).call(this,t)){var s=Ne(this,xe,Ke).call(this,t,i);Ne(this,Le,Ye).call(this,(function(){s.close()}))}else{var o=babelHelpers.classPrivateFieldGet(this,De).call(this).getContainer();var l=o.querySelector(".main-grid-ear-left");var u=o.querySelector(".main-grid-ear-right");var d=t.getClientRects()[0].x;var c=o.getClientRects()[0].x;var h=null;if(d>c){h=Ne(this,Ge,je).call(this,u)}else{h=Ne(this,Ge,je).call(this,l)}Ne(this,Be,Xe).call(this,t,(function(){h.close();var e=Ne(n,xe,Ke).call(n,t,i);Ne(n,Le,Ye).call(n,(function(){e.close()}))}),[],a)}}},{key:"getActiveHint",value:function e(){if(!this.fieldHintIsBusy){return null}else if(this.activeHintGuide instanceof c.Guide){return this.activeHintGuide}return null}}]);return e}();function Xe(e,t){var i,r=this;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];var s=(i=Ne(this,Me,We)).call.apply(i,[this,e].concat(babelHelpers.toConsumableArray(a)));var o=function e(i){var a;if((a=Ne(r,Ue,qe)).call.apply(a,[r].concat(babelHelpers.toConsumableArray(s)))){u.Event.unbind(babelHelpers.classPrivateFieldGet(r,De).call(r).getScrollContainer(),"scroll",e);u.Event.unbind(window,"resize",e);t.apply(void 0,babelHelpers.toConsumableArray(n))}};u.Event.bind(babelHelpers.classPrivateFieldGet(this,De).call(this).getScrollContainer(),"scroll",o);u.Event.bind(window,"resize",o)}function We(e){var t,i;var r=[];for(var n=arguments.length,a=new Array(n>1?n-1:0),s=1;s<n;s++){a[s-1]=arguments[s]}for(var o=0,l=a;o<l.length;o++){var u=l[o];r.push({node:u,nodeRect:u.getClientRects()[0]})}var d={node:e,nodeRect:e.getClientRects()[0]};r.push(d);r.sort((function(e,t){var i=e.nodeRect.x;var r=t.nodeRect.x;if(i<r){return-1}else if(i>r){return 1}else{return 0}}));var c=(t=babelHelpers.classPrivateFieldGet(this,De).call(this))===null||t===void 0?void 0:(i=t.getContainer().getClientRects())===null||i===void 0?void 0:i[0];function h(e,t){return Math.abs(e-t)<c.width}while(r.length>1&&!h(r[0].nodeRect.x,r[r.length-1].nodeRect.x)){var v=r[0];var f=r[r.length-1];if(v===d){r.pop()}else if(f===d){r.shift()}else{var g=d.nodeRect.x-v.nodeRect.x;var p=f.nodeRect.x-d.nodeRect.x;if(g>=p){r.shift()}else{r.pop()}}}return r.map((function(e){return e.node}))}function qe(){var e,t;var i=(e=babelHelpers.classPrivateFieldGet(this,De).call(this))===null||e===void 0?void 0:(t=e.getContainer().getClientRects())===null||t===void 0?void 0:t[0];if(i===undefined){return false}var r=i.x;var n=i.x+i.width;for(var a=arguments.length,s=new Array(a),o=0;o<a;o++){s[o]=arguments[o]}for(var l=0,u=s;l<u.length;l++){var d;var c=u[l];var h=(d=c.getClientRects())===null||d===void 0?void 0:d[0];if(h===undefined){return false}var v=h.x;var f=h.x+h.width;if(v<r||f>n){return false}}return true}function je(e){var t=new BX.SpotLight({id:"arrow_spotlight",targetElement:e,autoSave:true,targetVertex:"middle-center",zIndex:200});t.show();t.container.style.pointerEvents="none";return t}function Ye(e){var t=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var r=babelHelpers.classPrivateFieldGet(this,De).call(this).getContainer();var n=r.querySelector(".main-grid-ear-left");var a=r.querySelector(".main-grid-ear-right");r.style.pointerEvents="none";n.style.pointerEvents="none";a.style.pointerEvents="none";var s=function s(o){r.style.pointerEvents="auto";n.style.pointerEvents="auto";a.style.pointerEvents="auto";u.Event.unbind(babelHelpers.classPrivateFieldGet(t,He),"click",s);e.apply(void 0,babelHelpers.toConsumableArray(i))};setTimeout((function(){u.Event.bind(babelHelpers.classPrivateFieldGet(t,He),"click",s)}),500)}function Ke(e,t){var i=new c.Guide({steps:[Object.assign({target:e},t)],onEvents:true});this.activeHintGuide=i;i.showNextStep();return i}function Qe(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function ze(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Qe(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Qe(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function $e(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=Je(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var r=0;var n=function e(){};return{s:n,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(s)throw o}}}}function Je(e,t){if(!e)return;if(typeof e==="string")return Ze(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return Ze(e,t)}function Ze(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++){r[i]=e[i]}return r}function et(e,t){it(e,t);t.add(e)}function tt(e,t,i){it(e,t);t.set(e,i)}function it(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function rt(e,t,i){nt(e,t);return i}function nt(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function at(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var st="template_0";var ot=2;var lt=new WeakMap;var ut=new WeakSet;var dt=new WeakSet;var ct=function(){function e(t){babelHelpers.classCallCheck(this,e);et(this,dt);et(this,ut);babelHelpers.defineProperty(this,"products",[]);babelHelpers.defineProperty(this,"productsWasInitiated",false);babelHelpers.defineProperty(this,"cache",new u.Cache.MemoryCache);tt(this,lt,{writable:true,value:void 0});babelHelpers.defineProperty(this,"actions",{productChange:"productChange",productListChanged:"productListChanged",updateListField:"listField",updateTotal:"total"});babelHelpers.defineProperty(this,"updateFieldForList",null);babelHelpers.defineProperty(this,"productRowAddHandler",this.handleProductRowAdd.bind(this));babelHelpers.defineProperty(this,"productRowCreateHandler",this.handleProductRowCreate.bind(this));babelHelpers.defineProperty(this,"showBarcodeSettingsPopupHandler",this.handleShowBarcodeSettingsPopup.bind(this));babelHelpers.defineProperty(this,"showSettingsPopupHandler",this.handleShowSettingsPopup.bind(this));babelHelpers.defineProperty(this,"onSaveHandler",this.handleOnSave.bind(this));babelHelpers.defineProperty(this,"onEditorSubmit",this.handleEditorSubmit.bind(this));babelHelpers.defineProperty(this,"onFocusToProductList",this.handleProductListFocus.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onGridUpdatedHandler",this.handleOnGridUpdated.bind(this));babelHelpers.defineProperty(this,"onGridRowMovedHandler",this.handleOnGridRowMoved.bind(this));babelHelpers.defineProperty(this,"onBeforeProductChangeHandler",this.handleOnBeforeProductChange.bind(this));babelHelpers.defineProperty(this,"onProductChangeHandler",this.handleOnProductChange.bind(this));babelHelpers.defineProperty(this,"onProductClearHandler",this.handleOnProductClear.bind(this));babelHelpers.defineProperty(this,"dropdownChangeHandler",this.handleDropdownChange.bind(this));babelHelpers.defineProperty(this,"onScanEmitHandler",this.handleMobileScanEvent.bind(this));babelHelpers.defineProperty(this,"changeProductFieldHandler",this.handleFieldChange.bind(this));babelHelpers.defineProperty(this,"updateTotalDataDelayedHandler",u.Runtime.debounce(this.updateTotalDataDelayed,100,this));this.setId(t)}babelHelpers.createClass(e,[{key:"init",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setSettings(i);this.scannerToken=(t=this.scannerToken)!==null&&t!==void 0?t:u.Text.getRandom(16);if(this.canEdit()){this.addFirstRowIfEmpty();this.enableEdit()}this.initForm();this.initProducts();this.initGridData();this.paintColumns();babelHelpers.classPrivateFieldSet(this,lt,new Ve(this.getContainer(),this.getGrid.bind(this)));n.EventEmitter.emit("DocumentProductListController",[this]);at(this,ut,ht).call(this);this.subscribeDomEvents();this.subscribeCustomEvents()}},{key:"subscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(u.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){u.Event.bind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-create-button"]').forEach((function(e){u.Event.bind(e,"click",t.productRowCreateHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){u.Event.bind(e,"click",t.showSettingsPopupHandler)}));i.querySelectorAll('[data-role="product-list-barcode-settings-button"]').forEach((function(e){u.Event.bind(e,"click",t.showBarcodeSettingsPopupHandler)}))}}},{key:"unsubscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(u.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-select-button"]').forEach((function(e){u.Event.unbind(e,"click",t.productSelectionPopupHandler)}));i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){u.Event.unbind(e,"click",t.productRowCreateHandler)}));i.querySelectorAll('[data-role="product-list-barcode-settings-button"]').forEach((function(e){u.Event.unbind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){u.Event.unbind(e,"click",t.showSettingsPopupHandler)}))}}},{key:"subscribeCustomEvents",value:function e(){n.EventEmitter.subscribe("BX.UI.EntityEditor:onSave",this.onSaveHandler);n.EventEmitter.subscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit);n.EventEmitter.subscribe("onFocusToProductList",this.onFocusToProductList);n.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);n.EventEmitter.subscribe("Grid::updated",this.onGridUpdatedHandler);n.EventEmitter.subscribe("Grid::rowMoved",this.onGridRowMovedHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);n.EventEmitter.subscribe("Dropdown::change",this.dropdownChangeHandler);n.EventEmitter.subscribe("BarcodeScanner::onScanEmit",this.onScanEmitHandler)}},{key:"unsubscribeCustomEvents",value:function e(){n.EventEmitter.unsubscribe("BX.UI.EntityEditor:onSave",this.onSaveHandler);n.EventEmitter.unsubscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit);n.EventEmitter.unsubscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);n.EventEmitter.unsubscribe("Grid::updated",this.onGridUpdatedHandler);n.EventEmitter.unsubscribe("Grid::rowMoved",this.onGridRowMovedHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);n.EventEmitter.unsubscribe("Dropdown::change",this.dropdownChangeHandler);n.EventEmitter.unsubscribe("BarcodeScanner::onScanEmit",this.onScanEmitHandler)}},{key:"handleMobileScanEvent",value:function e(t){var i,r;var n=t.getData();if(this.scannerToken!==n.id||!u.Type.isStringFilled(n.barcode)){return}var a=$e(this.products),s;try{for(a.s();!(s=a.n()).done;){var o,l;var d=s.value;if(((o=d.getBarcodeSelector())===null||o===void 0?void 0:(l=o.searchInput)===null||l===void 0?void 0:l.getNameInput())===document.activeElement){var c;(c=d.getBarcodeSelector().searchInput)===null||c===void 0?void 0:c.applyScannerData(n.barcode);return}}}catch(e){a.e(e)}finally{a.f()}var h=$e(this.products),v;try{for(h.s();!(v=h.n()).done;){var f,g,p,E;var y=v.value;if(((f=y.getBarcodeSelector())===null||f===void 0?void 0:(g=f.searchInput)===null||g===void 0?void 0:g.getNameInput().value)===""&&((p=y.getSelector())===null||p===void 0?void 0:(E=p.searchInput)===null||E===void 0?void 0:E.getNameInput().value)===""){var b;(b=y.getBarcodeSelector().searchInput)===null||b===void 0?void 0:b.applyScannerData(n.barcode);return}}}catch(e){h.e(e)}finally{h.f()}var m=this.addProductRow();(i=this.getProductById(m))===null||i===void 0?void 0:(r=i.getBarcodeSelector().searchInput)===null||r===void 0?void 0:r.applyScannerData(n.barcode)}},{key:"selectProductInRow",value:function e(t,i){var r=this;if(!u.Type.isStringFilled(t)||u.Text.toNumber(i)<=0){return}requestAnimationFrame((function(){var e;(e=r.getProductSelector(t))===null||e===void 0?void 0:e.onProductSelect(i)}))}},{key:"handleOnSave",value:function e(t){var i=l.ProductModel.getLastActiveSaveNotification();if(i){i.close()}var r=[];this.products.forEach((function(e){var t={fields:ze({},e.fields),rowId:e.fields.ROW_ID};r.push(t)}));this.setSettingValue("items",r)}},{key:"handleEditorSubmit",value:function e(t){}},{key:"handleProductListFocus",value:function e(t){if(this.isReadOnly()){return}var i=false;var r=$e(this.products),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;if(a.isEmptyRow()){i=true;this.focusProductSelector(a.fields["ROW_ID"]);break}}}catch(e){r.e(e)}finally{r.f()}if(!i){this.handleProductRowAdd()}}},{key:"onInnerCancel",value:function e(){this.reloadGrid(false)}},{key:"changeActivePanelButtons",value:function e(t){var i=this.getContainer();var r=i.querySelector(".catalog-document-product-list-add-block-"+t);if(u.Type.isDomNode(r)){u.Dom.removeClass(r,"catalog-document-product-list-add-block-hidden");u.Dom.addClass(r,"catalog-document-product-list-add-block-active")}var n=t==="top"?"bottom":"top";var a=i.querySelector(".catalog-document-product-list-add-block-"+n);if(u.Type.isDomNode(a)){u.Dom.addClass(a,"catalog-document-product-list-add-block-hidden");u.Dom.removeClass(a,"catalog-document-product-list-add-block-active")}return r}},{key:"reloadGrid",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(r===null){r=!i}this.getGrid().reloadTable("POST",{useProductsFromRequest:i},(function(){return t.actionUpdateTotalData({isInternalChanging:r})}))}},{key:"handleOnBeforeGridRequest",value:function t(i){var r=this;var a=i.getCompatData(),s=babelHelpers.slicedToArray(a,2),o=s[0],l=s[1];if(!o||!o.parent||o.parent.getId()!==this.getGridId()){return}var u=!("useProductsFromRequest"in l.data);var d=u?true:l.data.useProductsFromRequest;l.url=this.getReloadUrl();l.method="POST";l.sessid=BX.bitrix_sessid();l.data=ze(ze({},l.data),{},{useProductsFromRequest:d,signedParameters:this.getSignedParameters(),products:d?this.getProductsFields(rt(e,e,ft).call(e)):null});var c=false;if(l.data["action_button_"+l.gridId]==="delete"){c=true}this.clearEditor();if(u){n.EventEmitter.subscribeOnce("Grid::updated",(function(e){var t=e.getCompatData(),i=babelHelpers.slicedToArray(t,1),n=i[0];if(!n||n.getId()!==r.getGridId()){return}r.actionUpdateTotalData({isInternalChanging:false});if(c){r.executeActions([{type:r.actions.productListChanged}])}}))}}},{key:"handleOnGridUpdated",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,1),n=r[0];if(!n||n.getId()!==this.getGridId()){return}this.getSettingsPopup().updateCheckboxState()}},{key:"handleOnGridRowMoved",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,3),n=r[0],a=r[2];if(!a||a.getId()!==this.getGridId()){return}var s=this.resortProductsByIds(n);if(s){this.refreshSortFields();this.numerateRows();this.executeActions([{type:this.actions.productListChanged}])}}},{key:"initPageEventsManager",value:function e(){var t=this.getSettingValue("componentId");this.pageEventsManager=new ne({id:t})}},{key:"getPageEventsManager",value:function e(){if(!this.pageEventsManager){this.initPageEventsManager()}return this.pageEventsManager}},{key:"canEdit",value:function e(){return this.getSettingValue("allowEdit",false)===true}},{key:"enableEdit",value:function e(){var t=this.getGrid().getRows().getRows();t.forEach((function(e){if(!e.isHeadChild()&&!e.isTemplate()){e.edit()}}))}},{key:"addFirstRowIfEmpty",value:function e(){var t=this;if(this.getGrid().getRows().getCountDisplayed()===0){requestAnimationFrame((function(){return t.addProductRow()}))}}},{key:"clearEditor",value:function e(){this.unsubscribeProductsEvents();this.products=[];this.productsWasInitiated=false;this.destroySettingsPopup();this.unsubscribeDomEvents();this.unsubscribeCustomEvents();u.Event.unbindAll(this.container)}},{key:"wasProductsInitiated",value:function e(){return this.productsWasInitiated}},{key:"unsubscribeProductsEvents",value:function e(){this.products.forEach((function(e){var t=e.getSelector();if(t){t.unsubscribeEvents()}var i=e.getBarcodeSelector();if(i){i.unsubscribeEvents()}}))}},{key:"destroy",value:function e(){this.setForm(null);this.clearController();this.clearEditor()}},{key:"setController",value:function e(t){if(this.controller===t){return}if(this.controller){this.controller.clearProductList()}this.controller=t}},{key:"clearController",value:function e(){this.controller=null}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=t?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"getComponentName",value:function e(){return this.getSettingValue("componentName","")}},{key:"getReloadUrl",value:function e(){return this.getSettingValue("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getSettingValue("signedParameters","")}},{key:"getContainerId",value:function e(){return this.getSettingValue("containerId","")}},{key:"getGridId",value:function e(){return this.getSettingValue("gridId","")}},{key:"getLanguageId",value:function e(){return this.getSettingValue("languageId","")}},{key:"getSiteId",value:function e(){return this.getSettingValue("siteId","")}},{key:"getCatalogId",value:function e(){return this.getSettingValue("catalogId",0)}},{key:"isReadOnly",value:function e(){return this.getSettingValue("readOnly",true)}},{key:"setReadOnly",value:function e(t){this.setSettingValue("readOnly",t)}},{key:"getCurrencyId",value:function e(){return this.getSettingValue("currencyId","")}},{key:"setCurrencyId",value:function e(t){this.setSettingValue("currencyId",t);return a.CurrencyCore.loadCurrencyFormat(t)}},{key:"changeCurrencyId",value:function e(t){var i=this;var r=this.getCurrencyId();if(r===t){return}this.setCurrencyId(t).then((function(){var e=[];i.products.forEach((function(i){i.getModel().setOption("currency",t);e.push({fields:i.getFields(),id:i.getId()})}));if(e.length>0){u.ajax.runComponentAction(i.getComponentName(),"calculateProductPrices",{mode:"class",signedParameters:i.getSignedParameters(),data:{products:e,currencyId:t,oldCurrencyId:r}}).then(i.onCalculatePricesResponse.bind(i))}var n=i.getGridEditData();var a=n[st];a["CURRENCY"]=i.getCurrencyId();var s=["BASE_PRICE","PURCHASING_PRICE"];s.forEach((function(e){if(a[e]&&a[e]["CURRENCY"]){a[e]["CURRENCY"]["VALUE"]=i.getCurrencyId()}}));i.setGridEditData(n)}))}},{key:"onCalculatePricesResponse",value:function e(t){var i=t.data;this.products.forEach((function(e){if(u.Type.isObject(i[e.getId()])){e.updateField("BASE_PRICE",i[e.getId()]["BASE_PRICE"]);e.updateField("PURCHASING_PRICE",i[e.getId()]["PURCHASING_PRICE"]);e.updateUiCurrencyFields()}}));this.updateTotalDataDelayed();this.updateTotalUiCurrency()}},{key:"updateTotalUiCurrency",value:function e(){var t=this;var i=BX(this.getSettingValue("totalBlockContainerId",null));if(u.Type.isElementNode(i)){i.querySelectorAll('[data-role="currency-wrapper"]').forEach((function(e){e.innerHTML=t.getCurrencyText()}))}}},{key:"getCurrencyText",value:function e(){var t=this.getCurrencyId();if(!u.Type.isStringFilled(t)){return""}var i=a.CurrencyCore.getCurrencyFormat(t);return i&&i.FORMAT_STRING.replace(/(^|[^&])#/,"$1").trim()||""}},{key:"getDataFieldName",value:function e(){return this.getSettingValue("dataFieldName","")}},{key:"getDataSettingsFieldName",value:function e(){var t=this.getDataFieldName();return u.Type.isStringFilled(t)?t+"_SETTINGS":""}},{key:"getPricePrecision",value:function e(){return this.getSettingValue("pricePrecision",ot)}},{key:"getQuantityPrecision",value:function e(){return this.getSettingValue("quantityPrecision",ot)}},{key:"getCommonPrecision",value:function e(){return this.getSettingValue("commonPrecision",ot)}},{key:"getMeasures",value:function e(){return this.getSettingValue("measures",[])}},{key:"getDefaultMeasure",value:function e(){return this.getSettingValue("defaultMeasure",{})}},{key:"getRowIdPrefix",value:function e(){return this.getSettingValue("rowIdPrefix","catalog_entity_product_list_")}},{key:"parseInt",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var i;var r=u.Type.isNumber(e);var n=u.Type.isStringFilled(e);if(!r&&!n){return t}if(n){e=e.replace(/^\s+|\s+$/g,"");var a=e.indexOf("-")===0;i=parseInt(e.replace(/[^\d]/g,""),10);if(isNaN(i)){i=t}else{if(a){i=-i}}}else{i=parseInt(e,10);if(isNaN(i)){i=t}}return i}))},{key:"parseFloat",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ot;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var r;var n=u.Type.isNumber(e);var a=u.Type.isStringFilled(e);if(!n&&!a){return i}if(a){e=e.replace(/^\s+|\s+$/g,"");var s=e.indexOf(".");var o=e.indexOf(",");var l=e.indexOf("-")===0;if(s<0&&o>=0){var d=e.substr(0,o);var c=e.length-o-1;if(c>0){d+="."+e.substr(o+1,c)}e=d}e=e.replace(/[^\d.]+/g,"");r=parseFloat(e);if(isNaN(r)){r=i}if(l){r=-r}}else{r=parseFloat(e)}if(t>=0){r=this.round(r,t)}return r}))},{key:"round",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:ot;var r=Math.pow(10,i);return Math.round(t*r)/r}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){return document.getElementById(t.getContainerId())}))}},{key:"initForm",value:function e(){var t=this.getSettingValue("formId","");var i=u.Type.isStringFilled(t)?BX("form_"+t):null;if(u.Type.isElementNode(i)){this.setForm(i)}}},{key:"isExistForm",value:function e(){return u.Type.isElementNode(this.getForm())}},{key:"getForm",value:function e(){return this.form}},{key:"setForm",value:function e(t){this.form=t}},{key:"initFormFields",value:function e(){var t=this.getForm();if(u.Type.isElementNode(t)){var i=this.getDataField();if(!u.Type.isElementNode(i)){this.initDataField()}var r=this.getDataSettingsField();if(!u.Type.isElementNode(r)){this.initDataSettingsField()}}}},{key:"initFormField",value:function e(t){var i=this.getForm();if(u.Type.isElementNode(i)&&u.Type.isStringFilled(t)){i.appendChild(u.Dom.create("input",{attrs:{type:"hidden",name:t}}))}}},{key:"removeFormFields",value:function e(){var t=this.getDataField();if(u.Type.isElementNode(t)){u.Dom.remove(t)}var i=this.getDataSettingsField();if(u.Type.isElementNode(i)){u.Dom.remove(i)}}},{key:"initDataField",value:function e(){this.initFormField(this.getDataFieldName())}},{key:"initDataSettingsField",value:function e(){this.initFormField(this.getDataSettingsFieldName())}},{key:"getFormField",value:function e(t){var i=this.getForm();if(u.Type.isElementNode(i)&&u.Type.isStringFilled(t)){return i.querySelector('input[name="'+t+'"]')}return null}},{key:"getDataField",value:function e(){return this.getFormField(this.getDataFieldName())}},{key:"getDataSettingsField",value:function e(){return this.getFormField(this.getDataSettingsFieldName())}},{key:"getProductCount",value:function e(){return this.products.filter((function(e){return!e.isEmptyRow()})).length}},{key:"initProducts",value:function e(){var t=this.getSettingValue("items",[]);var i=$e(t),r;try{for(i.s();!(r=i.n()).done;){var n=r.value;var a=ze({},n.fields);this.products.push(new q(n.rowId,a,this.getSettingValue("rowSettings",{}),this))}}catch(e){i.e(e)}finally{i.f()}this.numerateRows();this.productsWasInitiated=true;this.updateTotalDataDelayed()}},{key:"numerateRows",value:function e(){this.products.forEach((function(e,t){e.setRowNumber(t+1)}))}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",(function(){var e=t.getGridId();if(!u.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(e,"' id."))}return BX.Main.gridManager.getInstanceById(e)}))}},{key:"initGridData",value:function e(){var t=this.getSettingValue("templateGridEditData",null);if(t){this.setGridEditData(t)}}},{key:"paintColumns",value:function e(){var t=this.getSettingValue("paintedColumns",null);var i=this.getGrid();if(i&&u.Type.isArray(t)){t.forEach((function(e){var t=i.getRows().getRows();t.forEach((function(t){var i=t.getCellById(e);if(i){u.Dom.addClass(i,"main-grid-cell-light-blue-background")}}))}))}}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"getColumnInfo",value:function e(t){var i,r;return((i=this.getGrid())===null||i===void 0?void 0:(r=i.arParams)===null||r===void 0?void 0:r.COLUMNS_ALL[t])||{}}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[st]=t}},{key:"handleProductErrorsChange",value:function e(){if(at(this,dt,vt).call(this)){this.controller.disableSaveButton()}else{this.controller.enableSaveButton()}}},{key:"handleFieldChange",value:function e(t){var i=t.target.closest("tr");if(i&&i.hasAttribute("data-id")){var r=this.getProductById(i.getAttribute("data-id"));if(r){var n=t.target.getAttribute("data-name");if(!u.Type.isStringFilled(n)){var a=t.target.closest("td");n=this.getFieldCodeByGridCell(i,a)}if(n){r.updateFieldByEvent(n,t)}}}}},{key:"handleDropdownChange",value:function e(t){var i=t.getData(),r=babelHelpers.slicedToArray(i,5),n=r[0],a=r[4];var s=new RegExp(this.getRowIdPrefix()+"([A-Za-z0-9]+)_(\\w+)_control","i");var o=n.match(s);if(o){var l=babelHelpers.slicedToArray(o,3),u=l[1],d=l[2];var c=this.getProductById(u);if(c){c.updateDropdownField(d,a)}}}},{key:"getProductById",value:function e(t){var i=this.getRowIdPrefix()+t;return this.getProductByRowId(i)}},{key:"getProductByRowId",value:function e(t){return this.products.find((function(e){return e.getId()===t}))}},{key:"getFieldCodeByGridCell",value:function e(t,i){if(!u.Type.isDomNode(t)||!u.Type.isDomNode(i)){return null}var r=this.getGrid();if(r){var n=r.getRows().getHeadFirstChild();var a=babelHelpers.toConsumableArray(t.cells).indexOf(i);return n.getCellNameByCellIndex(a)}return null}},{key:"addProductRow",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=this.createGridProductRow();var r=i.getId();if(t){var n;var a=(n=this.getGrid().getRows().getById(t.getField("ID")))===null||n===void 0?void 0:n.getNode();if(a){a.parentNode.insertBefore(i.getNode(),a.nextSibling)}}this.initializeNewProductRow(r,t);this.getGrid().bindOnRowEvents();return r}},{key:"handleProductRowAdd",value:function e(){var t=this.addProductRow();this.focusProductSelector(t)}},{key:"handleProductRowCreate",value:function e(){}},{key:"handleShowBarcodeSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"handleShowSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"destroySettingsPopup",value:function e(){if(this.cache.has("settings-popup")){this.cache.get("settings-popup").getPopup().destroy();this.cache["delete"]("settings-popup")}}},{key:"getSettingsPopup",value:function e(){var t=this;return this.cache.remember("settings-popup",(function(){return new Ce(t.getContainer().querySelector('.catalog-document-product-list-add-block-active [data-role="product-list-settings-button"]'),t.getSettingValue("popupSettings",[]),t)}))}},{key:"getHintPopup",value:function e(){var t=this;return this.cache.remember("hint-popup",(function(){return new v(t)}))}},{key:"createGridProductRow",value:function e(){var t=u.Text.getRandom();var i=this.redefineTemplateEditData(t);var r=this.getGrid();var a;if(this.getSettingValue("newRowPosition")==="bottom"){a=r.appendRowEditor()}else{a=r.prependRowEditor()}var s=a.getNode();if(u.Type.isDomNode(s)){s.setAttribute("data-id",t);a.makeCountable()}if(i){this.setOriginalTemplateEditData(i)}n.EventEmitter.emit("Grid::thereEditedRows",[]);r.adjustRows();r.updateCounterDisplayed();r.updateCounterSelected();return a}},{key:"handleDeleteRow",value:function e(t,i){i.preventDefault();var r=this.getProductByRowId(t);if(r){this.deleteRow(t)}}},{key:"redefineTemplateEditData",value:function e(t){var i=this.getGridEditData();var r=i[st];var n=this.prepareCustomEditData(r,t);this.setOriginalTemplateEditData(ze(ze({},r),n));return r}},{key:"prepareCustomEditData",value:function e(t,i){var r={};var n=this.getSettingValue("templateIdMask","");for(var a in t){if(t.hasOwnProperty(a)){if(u.Type.isStringFilled(t[a])&&t[a].indexOf(n)>=0){r[a]=t[a].replace(new RegExp(n,"g"),i)}else if(u.Type.isPlainObject(t[a])){r[a]=this.prepareCustomEditData(t[a],i)}else{r[a]=t[a]}}}return r}},{key:"initializeNewProductRow",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var r={};if(i!==null){r=Object.assign(r,i===null||i===void 0?void 0:i.getFields())}else{r=ze(ze({},this.getSettingValue("templateItemFields",{})),{CURRENCY:this.getCurrencyId()})}var n=this.getRowIdPrefix()+t;r.ID=t;r.ROW_ID=t;if(u.Type.isObject(r.IMAGE_INFO)){delete r.IMAGE_INFO.input}var a=new q(n,r,this.getSettingValue("rowSettings",{}),this);if(i instanceof q){this.products.splice(1+this.products.indexOf(i),0,a);a.refreshFieldsLayout()}else if(this.getSettingValue("newRowPosition")==="bottom"){this.products.push(a)}else{this.products.unshift(a)}this.refreshSortFields();this.numerateRows();a.updateUiCurrencyFields();this.updateTotalUiCurrency();return a}},{key:"getProductSelector",value:function e(t){return this.getProductById(t).getSelector()}},{key:"focusProductSelector",value:function e(t){var i=this;requestAnimationFrame((function(){var e;(e=i.getProductSelector(t))===null||e===void 0?void 0:e.searchInDialog().focusName()}))}},{key:"handleOnBeforeProductChange",value:function e(t){var i=t.getData();var r=this.getProductByRowId(i.rowId);if(r){this.getGrid().tableFade();r.resetExternalActions()}}},{key:"handleOnProductChange",value:function e(t){var i=t.getData();var r=this.getProductByRowId(i.rowId);if(r&&i.fields){var n,a;delete i.fields.ID;r.setFields(i.fields);Object.keys(i.fields).forEach((function(e){r.updateFieldValue(e,i.fields[e])}));r.setField("IS_NEW",i.isNew?"Y":"N");(n=r.getSelector())===null||n===void 0?void 0:n.layout();(a=r.getBarcodeSelector())===null||a===void 0?void 0:a.layout();r.updateProductStoreValues();r.initHandlersForSelectors();r.executeExternalActions();this.getGrid().tableUnfade()}else{this.getGrid().tableUnfade()}}},{key:"handleOnProductClear",value:function e(t){var i=t.getData(),r=i.selectorId,n=i.rowId;var a=this.getProductByRowId(n);if(a&&a.getSelector().getId()===r){var s;a.initHandlersForSelectors();a.setMeasure(this.getDefaultMeasure());a.changePurchasingPrice(0);a.changeBasePrice(0);a.changeAmount(0);a.updateUiStoreValues();a.updateProductStoreValues();a.changeBarcode("");(s=a.getBarcodeSelector())===null||s===void 0?void 0:s.setConfig("ENABLE_SEARCH",true).layout();a.executeExternalActions()}}},{key:"compileProductData",value:function e(){if(!this.isExistForm()){return}this.initFormFields();var t=this.getDataField();var i=this.getDataSettingsField();this.cleanProductRows();if(u.Type.isElementNode(t)&&u.Type.isElementNode(i)){t.value=this.prepareProductDataValue()}}},{key:"prepareProductDataValue",value:function t(){var i="";if(this.getProductCount()){var r=[];this.products.forEach((function(t){var i=t.getFields(rt(e,e,ft).call(e));if(!/^[0-9]+$/.test(i["ID"])){i["ID"]=0}i["CUSTOMIZED"]="Y";r.push(i)}));i=JSON.stringify(r)}return i}},{key:"executeActions",value:function e(t){if(!u.Type.isArrayFilled(t)){return}var i=$e(t),r;try{for(i.s();!(r=i.n()).done;){var n=r.value;if(!u.Type.isPlainObject(n)||!u.Type.isStringFilled(n.type)){continue}switch(n.type){case this.actions.productChange:this.actionSendProductChange(n);break;case this.actions.productListChanged:this.actionSendProductListChanged();break;case this.actions.updateTotal:this.actionUpdateTotalData();break}}}catch(e){i.e(e)}finally{i.f()}}},{key:"actionSendProductChange",value:function e(t){if(!u.Type.isStringFilled(t.id)){return}var i=this.getProductByRowId(t.id);if(!i){return}if(this.controller){this.controller.productChange()}}},{key:"actionSendProductListChanged",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.controller){this.controller.productChange(t)}}},{key:"actionUpdateListField",value:function e(t){if(!u.Type.isStringFilled(t.field)||!("value"in t)){return}this.updateFieldForList=t.field;var i=$e(this.products),r;try{for(i.s();!(r=i.n()).done;){var n=r.value;n.updateFieldByName(t.field,t.value)}}catch(e){i.e(e)}finally{i.f()}this.updateFieldForList=null}},{key:"actionUpdateTotalData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.updateTotalDataDelayedHandler(t)}},{key:"updateTotalDataDelayed",value:function e(){var t=0;var i=this.getSettingValue("totalCalculationSumField","PURCHASING_PRICE");this.products.forEach((function(e){return t+=u.Text.toNumber(e.getField(i))*u.Text.toNumber(e.getField("AMOUNT"))}));this.setTotalData({totalCost:t})}},{key:"getProductsFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i=[];var r=$e(this.products),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;i.push(a.getFields(t))}}catch(e){r.e(e)}finally{r.f()}return i}},{key:"setTotalData",value:function e(t){var i;var r=BX(this.getSettingValue("totalBlockContainerId",null));if(u.Type.isElementNode(r)){var n=this.getCurrencyId();var s=["totalCost"];for(var o=0,l=s;o<l.length;o++){var d=l[o];var c=r.querySelector('[data-total="'+d+'"]');if(u.Type.isElementNode(c)&&d in t){c.innerHTML=a.CurrencyCore.currencyFormat(t[d],n,false)}}}(i=this.controller)===null||i===void 0?void 0:i.setTotal(t)}},{key:"ajaxResultCommonCheck",value:function e(t){if(!u.Type.isPlainObject(t)){return false}if(!u.Type.isStringFilled(t.status)){return false}if(t.status!=="success"){return false}if(!u.Type.isPlainObject(t.data)){return false}if(!u.Type.isStringFilled(t.data.action)){return false}if(!("result"in t.data)){return false}return true}},{key:"deleteRow",value:function e(t){var i=this.getGrid().getRows().getById(t.getField("ID"));if(i){u.Dom.remove(i.getNode());this.getGrid().getRows().reset()}var r=this.products.indexOf(t);if(r>-1){this.products.splice(r,1);this.refreshSortFields();this.numerateRows()}n.EventEmitter.emit("Grid::thereEditedRows",[]);this.addFirstRowIfEmpty();this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"copyRow",value:function e(t){this.addProductRow(t);this.refreshSortFields();this.numerateRows();n.EventEmitter.emit("Grid::thereEditedRows",[]);this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"cleanProductRows",value:function e(){var t=this;this.products.filter((function(e){return e.isEmptyRow()})).forEach((function(e){return t.deleteRow(e)}))}},{key:"resortProductsByIds",value:function e(t){var i=false;if(u.Type.isArrayFilled(t)){this.products.sort((function(e,r){if(t.indexOf(e.getField("ID"))>t.indexOf(r.getField("ID"))){return 1}i=true;return-1}))}return i}},{key:"refreshSortFields",value:function e(){this.products.forEach((function(e,t){return e.setField("SORT",(t+1)*10,false)}))}},{key:"handleOnTabShow",value:function e(){n.EventEmitter.emit("onDemandRecalculateWrapper",[this])}},{key:"closeBarcodeSpotlights",value:function e(){this.products.forEach((function(e){var t;(t=e.getBarcodeSelector())===null||t===void 0?void 0:t.removeSpotlight()}));this.setSettingValue("showBarcodeSpotlightInfo",false)}},{key:"closeBarcodeQrAuths",value:function e(){this.products.forEach((function(e){var t;(t=e.getBarcodeSelector())===null||t===void 0?void 0:t.removeQrAuth()}));this.setSettingValue("showBarcodeQrAuth",false)}},{key:"validate",value:function e(){if(this.getProductCount()===0){return[u.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_IS_EMPTY")]}var t=[];this.products.forEach((function(e){t=t.concat(e.validate())}));return t}},{key:"showFieldTourHint",value:function e(t,i,r){var n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(this.products.length>0){var a=this.products[0].getNode();var s=[];var o=$e(n),l;try{for(o.s();!(l=o.n()).done;){var u=l.value;var d=a.querySelector('[data-name="'.concat(u,'"]'));if(d!==null){s.push(d)}}}catch(e){o.e(e)}finally{o.f()}var c=a.querySelector('[data-name="'.concat(t,'"]'));if(c!==null){babelHelpers.classPrivateFieldGet(this,lt).processFieldTour(c,i,r,s)}}}},{key:"getActiveHint",value:function e(){return babelHelpers.classPrivateFieldGet(this,lt).getActiveHint()}}]);return e}();function ht(){this.getGrid()._clickOnRowActionsButton=function(){}}function vt(){return this.products.filter((function(e){return e.getModel().getErrorCollection().hasErrors()})).length>0}function ft(){return["ID","SKU_ID","AMOUNT","PURCHASING_PRICE","BASE_PRICE","BASE_PRICE_EXTRA","BASE_PRICE_EXTRA_RATE","DOC_BARCODE","BARCODE","STORE_TO","STORE_FROM","BASE_PRICE_ID","BASKET_ID","DOC_ID","ELEMENT_ID","IBLOCK_ID","MEASURE_CODE","MEASURE_NAME","NAME","OFFERS_IBLOCK_ID","PARENT_PRODUCT_ID","PRODUCT_ID","ROW_ID","STORE_FROM_AMOUNT","STORE_FROM_AVAILABLE_AMOUNT","STORE_FROM_RESERVED","STORE_FROM_TITLE","STORE_TO_AMOUNT","STORE_TO_AVAILABLE_AMOUNT","STORE_TO_RESERVED","STORE_TO_TITLE","TOTAL_PRICE"]}e.Editor=ct;e.PageEventsManager=ne})(this.BX.Catalog.Store.ProductList=this.BX.Catalog.Store.ProductList||{},BX,BX.Catalog,BX.Main,BX.Event,BX.Currency,BX.Catalog,BX.Catalog.DocumentCard,BX.Catalog,BX,BX,BX.UI.Tour);
//# sourceMappingURL=script.map.js