this.BX=this.BX||{};(function(e,t,n,a,o,i,l,s,r,c){"use strict";function d(e){return!!e&&!!e.querySelector(".block-wrapper")}function u(e){return!!e&&!!e.querySelector('button[data-id="insert_first_block"]')}function f(e,t){return new Promise((function(n){var a=function a(o){if(!t||o.animationName===t){n(o);r.Event.bind(e,"animationend",a)}};r.Event.bind(e,"animationend",a)}))}function k(e){if(r.Type.isNil(e)){return true}if(r.Type.isArrayLike(e)){return!e.length}if(r.Type.isObject(e)){return Object.keys(e).length<=0}return true}function h(e,t){m(e,t);t.add(e)}function g(e,t,n){m(e,t);t.set(e,n)}function m(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function b(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var v=new WeakMap;var B=new WeakMap;var p=new WeakMap;var y=new WeakMap;var C=new WeakMap;var E=new WeakMap;var w=new WeakSet;var L=new WeakSet;var P=new WeakSet;var A=new WeakSet;var T=function(){function e(){babelHelpers.classCallCheck(this,e);h(this,A);h(this,P);h(this,L);h(this,w);g(this,v,{writable:true,value:{mode:"mode",register:"register",changeState:"changestate",editorEnable:"editorenable",showControls:"showcontrols",showBlockControls:"showblockcontrols",hideAll:"hideall",backendAction:"backendaction"}});g(this,B,{writable:true,value:-1});g(this,p,{writable:true,value:false});g(this,y,{writable:true,value:false});g(this,C,{writable:true,value:0});g(this,E,{writable:true,value:[]});if(O.isExternalControlsEnabled()){b(this,w,S).call(this)}}babelHelpers.createClass(e,[{key:"onBackendAction",value:function e(t,n){babelHelpers.classPrivateFieldSet(this,y,false);this.postExternalCommand(babelHelpers.classPrivateFieldGet(this,v).backendAction,{action:t,data:n})}},{key:"isControlsExternal",value:function e(){return r.Dom.hasClass(document.body,"landing-ui-external-controls")}},{key:"recalculateTops",value:function e(t){var n=this;babelHelpers.classPrivateFieldSet(this,E,[]);if(t){babelHelpers.classPrivateFieldSet(this,B,-1)}babelHelpers.toConsumableArray(document.body.querySelectorAll(".block-wrapper")).map((function(e){var t=e.getBoundingClientRect();if(t.height>1){babelHelpers.classPrivateFieldGet(n,E).push({blockId:parseInt(e.getAttribute("data-id")),top:t.top,height:t.height})}}));this.onMobileMouseMove(babelHelpers.classPrivateFieldGet(this,C))}},{key:"recalculateTopsIfExternals",value:function e(t){if(this.isControlsExternal()){this.recalculateTops(t)}}},{key:"onMobileMouseMove",value:function e(t){if(babelHelpers.classPrivateFieldGet(this,y)||!this.isControlsExternal()){return}if(t<=0){babelHelpers.classPrivateFieldSet(this,B,-1);return}babelHelpers.classPrivateFieldSet(this,C,t);for(var n=0,a=babelHelpers.classPrivateFieldGet(this,E).length;n<a;n++){if(t>=babelHelpers.classPrivateFieldGet(this,E)[n]["top"]&&(!babelHelpers.classPrivateFieldGet(this,E)[n+1]||t<babelHelpers.classPrivateFieldGet(this,E)[n+1]["top"])){if(babelHelpers.classPrivateFieldGet(this,E)[n]["top"]!==babelHelpers.classPrivateFieldGet(this,B)){babelHelpers.classPrivateFieldSet(this,B,babelHelpers.classPrivateFieldGet(this,E)[n]["top"]);this.postExternalCommand(babelHelpers.classPrivateFieldGet(this,v).showControls,{blockId:babelHelpers.classPrivateFieldGet(this,E)[n]["blockId"],top:babelHelpers.classPrivateFieldGet(this,E)[n]["top"],height:babelHelpers.classPrivateFieldGet(this,E)[n]["height"]})}break}}}},{key:"postExternalCommand",value:function e(t,n){if(window.parent){window.parent.postMessage({action:t,payload:n},window.location.origin)}}},{key:"listenExternalCommands",value:function e(t,n){var a=this;var o=BX.Landing.PageObject.getBlocks().get(n!==null&&n!==void 0&&n.blockId?n.blockId:-1);if(n!==null&&n!==void 0&&n.blockId&&!o){return}var i=function e(){setTimeout((function(){babelHelpers.classPrivateFieldSet(a,C,0);a.recalculateTops()}),300)};switch(t){case"onDesignerBlockClick":{o.onDesignerBlockClick();break}case"onEditBlockClick":{o.onShowContentPanel();break}case"onStyleBlockClick":{o.onStyleShow();break}case"onSortDownBlockClick":{o.moveDown();i();break}case"onSortUpBlockClick":{o.moveUp();i();break}case"onRemoveBlockClick":{o.deleteBlock();break}case"onChangeStateBlockClick":{o.onStateChange();break}case"onCutBlockClick":{O.getInstance().onCutBlock.bind(O.getInstance(),o)();break}case"onCopyBlockClick":{O.getInstance().onCopyBlock.bind(O.getInstance(),o)();break}case"onPasteBlockClick":{O.getInstance().onPasteBlock.bind(O.getInstance(),o,(function(e){setTimeout((function(){b(a,A,I).call(a,e)}),300)}))();break}case"onFeedbackClick":{o.showFeedbackForm();break}case"onSaveInLibraryClick":{o.saveBlock();break}case"onHideEditorPanel":{BX.Landing.UI.Panel.EditorPanel.getInstance().hide();break}}}}]);return e}();function S(){var e=this;setTimeout((function(){b(e,P,X).call(e)}),0);window.addEventListener("message",(function(t){if(e.isControlsExternal()){e.listenExternalCommands(t.data.action,t.data.payload)}}));document.addEventListener("mouseenter",(function(t){babelHelpers.classPrivateFieldSet(e,p,true)}));document.addEventListener("mouseleave",(function(t){babelHelpers.classPrivateFieldSet(e,p,false)}));document.addEventListener("mousemove",(function(t){e.onMobileMouseMove(t.y)}));document.addEventListener("scroll",(function(){if(babelHelpers.classPrivateFieldGet(e,p)){e.recalculateTopsIfExternals()}}));BX.addCustomEvent("BX.Landing.Main:changeControls",(function(t,n){if(t==="internal"){e.postExternalCommand(babelHelpers.classPrivateFieldGet(e,v).hideAll,{})}else{setTimeout((function(){e.recalculateTops(true)}),400)}}));BX.addCustomEvent("BX.Landing.Editor:enable",(function(){babelHelpers.classPrivateFieldSet(e,y,true);if(e.isControlsExternal()){e.postExternalCommand(babelHelpers.classPrivateFieldGet(e,v).hideAll,{})}}));BX.addCustomEvent("BX.Landing.Editor:disable",(function(){babelHelpers.classPrivateFieldSet(e,y,false);e.recalculateTopsIfExternals(true)}));BX.addCustomEvent("BX.Landing.Block:onAfterAdd",(function(t){setTimeout((function(){var n=t.getData();b(e,A,I).call(e,n.id)}),500)}));BX.addCustomEvent("BX.Landing.Block:changeState",(function(t,n){e.postExternalCommand(babelHelpers.classPrivateFieldGet(e,v).changeState,{blockId:t,state:n})}));BX.addCustomEvent("BX.Landing.Block:onFormSettingsOpen",(function(){if(e.isControlsExternal()){e.postExternalCommand(babelHelpers.classPrivateFieldGet(e,v).hideAll,{})}babelHelpers.classPrivateFieldSet(e,y,true)}));BX.addCustomEvent("BX.Landing.Block:onFormSettingsClose",(function(t){setTimeout((function(){babelHelpers.classPrivateFieldSet(e,y,false);e.recalculateTopsIfExternals(true)}),400);e.postExternalCommand(babelHelpers.classPrivateFieldGet(e,v).hideAll,{})}));BX.addCustomEvent("BX.Landing.Block:onAfterFormSave",(function(t){setTimeout((function(){e.postExternalCommand(babelHelpers.classPrivateFieldGet(e,v).backendAction,{action:"Landing\\Block::saveForm",data:{block:t}})}),1e3)}));BX.addCustomEvent("BX.Landing.Block:onBlockEditClose",(function(){babelHelpers.classPrivateFieldSet(e,y,false);e.recalculateTopsIfExternals(true)}));BX.addCustomEvent("BX.Landing.Block:onContentSave",this.recalculateTopsIfExternals.bind(this));BX.addCustomEvent("BX.Landing.Block:onDesignerBlockSave",this.recalculateTopsIfExternals.bind(this));BX.addCustomEvent("BX.Landing.Block:Card:add",this.recalculateTopsIfExternals.bind(this));BX.addCustomEvent("BX.Landing.Block:Card:remove",this.recalculateTopsIfExternals.bind(this));BX.addCustomEvent("BX.Landing.Block:afterRemove",this.recalculateTopsIfExternals.bind(this));BX.addCustomEvent("BX.Landing.Backend:action",this.onBackendAction.bind(this));BX.addCustomEvent("BX.Landing.Backend:batch",this.onBackendAction.bind(this))}function D(e){return{id:parseInt(e.id),state:e.isEnabled(),permissions:{allowDesignBlock:e.isDesignBlockAllowed(),allowModifyStyles:e.isStyleModifyAllowed(),allowEditContent:e.isEditBlockAllowed(),allowSorting:e.isEditBlockAllowed(),allowRemove:e.isRemoveBlockAllowed(),allowChangeState:e.isChangeStateBlockAllowed(),allowPaste:e.isPasteBlockAllowed(),allowSaveInLibrary:e.isSaveBlockInLibraryAllowed()}}}function X(){var e=this;var t=BX.Landing.PageObject.getBlocks();var n=[];babelHelpers.toConsumableArray(t).map((function(t){return n.push(b(e,L,D).call(e,t))}));this.postExternalCommand(babelHelpers.classPrivateFieldGet(this,v).register,{blocks:n})}function I(e){var t=BX.Landing.PageObject.getBlocks().get(e);if(t){this.postExternalCommand(babelHelpers.classPrivateFieldGet(this,v).register,{blocks:[b(this,L,D).call(this,t)]});if(this.isControlsExternal()){this.recalculateTops()}else{this.postExternalCommand(babelHelpers.classPrivateFieldGet(this,v).hideAll,{})}}}var F,_,H;BX.Landing.getMode=function(){return"edit"};var O=function(e){babelHelpers.inherits(t,e);babelHelpers.createClass(t,null,[{key:"getMode",value:function e(){return"edit"}},{key:"createInstance",value:function e(t){var n=BX.Landing.PageObject.getRootWindow();if(n.BX.Landing.Main.instance){n.BX.Landing.Main.instance.clear()}n.BX.Landing.Main.instance=new BX.Landing.Main(t)}},{key:"getInstance",value:function e(){var n=BX.Landing.PageObject.getRootWindow();n.BX.Reflection.namespace("BX.Landing.Main");if(n.BX.Landing.Main.instance){return n.BX.Landing.Main.instance}n.BX.Landing.Main.instance=new t(-1);return n.BX.Landing.Main.instance}},{key:"isEditorMode",value:function e(){return r.Dom.hasClass(document.body,"landing-editor")}},{key:"isExternalControlsEnabled",value:function e(){return r.Dom.hasClass(document.body,"enable-external-controls")}},{key:"topInPercent",value:function e(){var t=Math.max(document.body.scrollHeight,document.documentElement.scrollHeight,document.body.offsetHeight,document.documentElement.offsetHeight,document.body.clientHeight,document.documentElement.clientHeight);var n=document.documentElement.scrollTop||document.body.scrollTop;return n/t*100}}]);function t(e){var a;babelHelpers.classCallCheck(this,t);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));a.setEventNamespace("BX.Landing.Main");var o=n.Env.getInstance().getOptions();a.id=e;a.options=Object.freeze(o);a.blocks=a.options.blocks;a.currentBlock=null;a.isDesignBlockModeFlag=a.options["design_block"]===true;a.loadedDeps={};a.cache=new r.Cache.MemoryCache;a.externalControls=new T;a.onSliderFormLoaded=a.onSliderFormLoaded.bind(babelHelpers.assertThisInitialized(a));a.onBlockDelete=a.onBlockDelete.bind(babelHelpers.assertThisInitialized(a));BX.addCustomEvent("Landing.Block:onAfterDelete",a.onBlockDelete);a.adjustEmptyAreas();BX.Landing.UI.Panel.StatusPanel.setLastModified(o.lastModified);if(!a.isDesignBlockModeFlag){BX.Landing.UI.Panel.StatusPanel.getInstance().show()}var i=n.Env.getInstance().getType();if(i===t.TYPE_KNOWLEDGE||i===t.TYPE_GROUP){var l=document.querySelector(".landing-main");if(r.Type.isDomNode(l)){r.Dom.addClass(l,"landing-ui-collapse")}}return a}babelHelpers.createClass(t,[{key:"clear",value:function e(){BX.removeCustomEvent("Landing.Block:onAfterDelete",this.onBlockDelete)}},{key:"isCrmFormPage",value:function e(){return n.Env.getInstance().getSpecialType()==="crm_forms"}},{key:"isDesignBlockMode",value:function e(){return this.isDesignBlockModeFlag}},{key:"getSaveBlockPanel",value:function e(){var t=new i.SaveBlock("save_block_panel",{block:this.currentBlock});t.layout.hidden=true;t.content.hidden=false;r.Dom.append(t.layout,window.parent.document.body);return t}},{key:"getBlocksPanel",value:function e(){var t=this;return this.cache.remember("blockPanel",(function(){var e=t.createBlocksPanel();setTimeout((function(){if(e.sidebarButtons.get(t.options.default_section)){e.sidebarButtons.get(t.options.default_section).layout.click()}else{babelHelpers.toConsumableArray(e.sidebarButtons)[0].layout.click()}}));e.layout.hidden=true;e.content.hidden=false;r.Dom.append(e.layout,window.parent.document.body);return e}))}},{key:"hideBlocksPanel",value:function e(){if(this.getBlocksPanel()){return this.getBlocksPanel().hide()}return Promise.resolve()}},{key:"getLayoutAreas",value:function e(){return this.cache.remember("layoutAreas",(function(){return[].concat(babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-header")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-sidebar")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-main")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-footer")))}))}},{key:"createInsertBlockButton",value:function e(t){var n=new BX.Landing.UI.Button.Plus("insert_first_block",{text:a.Loc.getMessage("ACTION_BUTTON_CREATE")});n.on("click",this.showBlocksPanel.bind(this,null,t,n));n.on("mouseover",this.onCreateButtonMouseover.bind(this,t,n));n.on("mouseout",this.onCreateButtonMouseout.bind(this,t,n));return n}},{key:"onCreateButtonMouseover",value:function e(t,n){if(r.Dom.hasClass(t,"landing-header")||r.Dom.hasClass(t,"landing-footer")){var o=this.getLayoutAreas();if(o.length>1){var i=a.Loc.getMessage("ACTION_BUTTON_CREATE");if(r.Dom.hasClass(t,"landing-main")){n.setText("".concat(i," ").concat(a.Loc.getMessage("LANDING_ADD_BLOCK_TO_MAIN")))}if(r.Dom.hasClass(t,"landing-header")){n.setText("".concat(i," ").concat(a.Loc.getMessage("LANDING_ADD_BLOCK_TO_HEADER")))}if(r.Dom.hasClass(t,"landing-sidebar")){n.setText("".concat(i," ").concat(a.Loc.getMessage("LANDING_ADD_BLOCK_TO_SIDEBAR")))}if(r.Dom.hasClass(t,"landing-footer")){n.setText("".concat(i," ").concat(a.Loc.getMessage("LANDING_ADD_BLOCK_TO_FOOTER")))}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout((function(){r.Dom.addClass(t,"landing-area-highlight");o.filter((function(e){return e!==t})).forEach((function(e){r.Dom.addClass(e,"landing-area-fade")}))}),400)}}}},{key:"onCreateButtonMouseout",value:function e(t,n){clearTimeout(this.fadeTimeout);if(r.Dom.hasClass(t,"landing-header")||r.Dom.hasClass(t,"landing-footer")){var o=this.getLayoutAreas();if(o.length>1){n.setText(a.Loc.getMessage("ACTION_BUTTON_CREATE"));o.forEach((function(e){r.Dom.removeClass(e,"landing-area-highlight");r.Dom.removeClass(e,"landing-area-fade")}))}}}},{key:"initEmptyArea",value:function e(t){if(t){t.innerHTML="";r.Dom.append(this.createInsertBlockButton(t).layout,t);r.Dom.addClass(t,"landing-empty")}}},{key:"destroyEmptyArea",value:function e(t){if(t){var n=t.querySelector('button[data-id="insert_first_block"]');if(n){r.Dom.remove(n)}r.Dom.removeClass(t,"landing-empty")}}},{key:"adjustEmptyAreas",value:function e(){this.getLayoutAreas().filter((function(e){return d(e)&&u(e)})).forEach(this.destroyEmptyArea,this);this.getLayoutAreas().filter((function(e){return!d(e)&&!u(e)})).forEach(this.initEmptyArea,this);var t=document.body.querySelector("main.landing-edit-mode");var n=!this.getLayoutAreas().some(d);if(t){if(n){r.Dom.addClass(t,"landing-empty");return}r.Dom.removeClass(t,"landing-empty")}}},{key:"enableControls",value:function e(){r.Dom.removeClass(document.body,"landing-ui-hide-controls")}},{key:"disableControls",value:function e(){r.Dom.addClass(document.body,"landing-ui-hide-controls")}},{key:"isControlsEnabled",value:function e(){return!r.Dom.hasClass(document.body,"landing-ui-hide-controls")}},{key:"makeControlsInternal",value:function e(){BX.onCustomEvent("BX.Landing.Main:changeControls",["internal",t.topInPercent()]);r.Dom.removeClass(document.body,"landing-ui-external-controls")}},{key:"makeControlsExternal",value:function e(){BX.onCustomEvent("BX.Landing.Main:changeControls",["external",t.topInPercent()]);r.Dom.addClass(document.body,"landing-ui-external-controls")}},{key:"isControlsExternal",value:function e(){return r.Dom.hasClass(document.body,"landing-ui-external-controls")}},{key:"setDeviceCode",value:function e(t){document.body.setAttribute("data-device",t)}},{key:"getDeviceCode",value:function e(){return document.body.getAttribute("data-device")}},{key:"setTouchDevice",value:function e(){r.Dom.removeClass(document.documentElement,"bx-no-touch");r.Dom.addClass(document.documentElement,"bx-touch")}},{key:"setNoTouchDevice",value:function e(){r.Dom.removeClass(document.documentElement,"bx-touch");r.Dom.addClass(document.documentElement,"bx-no-touch")}},{key:"appendBlock",value:function e(t,n){if(!this.isAllowedAppendBlock(t)){return r.Tag.render(F||(F=babelHelpers.taggedTemplateLiteral([""])))}var a=r.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(["",""])),t.content);a.id="block".concat(t.id);if(!n){r.Dom.addClass(a,"landing-ui-show");f(a,"showBlock").then((function(){r.Dom.removeClass(a,"landing-ui-show")}))}this.insertToBlocksFlow(a);return a}},{key:"isAllowedAppendBlock",value:function e(t){var n;var a=BX.Landing.Env.getInstance().getType().toLowerCase();var o=(n=t.manifest.block.type)!==null&&n!==void 0?n:[];if(a==="mainpage"||o.includes("mainpage")){if(r.Type.isString(o)){o=[o]}if(!o.includes(a)){return false}}return true}},{key:"showBlocksPanel",value:function e(t,n,a,o){this.currentBlock=t;this.currentArea=n;this.insertBefore=o;BX.Landing.UI.Panel.EditorPanel.getInstance().hide();if(this.isCrmFormPage()||this.isControlsExternal()){var i=s.PageObject.getRootWindow();r.Dom.append(this.getBlocksPanel().layout,i.document.body);r.Dom.append(this.getBlocksPanel().overlay,i.document.body)}this.getBlocksPanel().show();this.disableAddBlockButtons();if(!!n&&!!a){this.onCreateButtonMouseout(n,a)}}},{key:"showSaveBlock",value:function e(t){this.currentBlock=t;this.getSaveBlockPanel().show()}},{key:"disableAddBlockButtons",value:function e(){s.PageObject.getBlocks().forEach((function(e){var t=e.panels.get("create_action");if(t){var n=t.buttons.get("insert_after");if(n){n.disable()}}}))}},{key:"enableAddBlockButtons",value:function e(){s.PageObject.getBlocks().forEach((function(e){var t=e.panels.get("create_action");if(t){var n=t.buttons.get("insert_after");if(n){n.enable()}}}))}},{key:"createBlocksPanel",value:function e(){var t=this;var n=this.options.blocks;var i=Object.keys(n);var l=new o.Content("blocks_panel",{title:a.Loc.getMessage("LANDING_CONTENT_BLOCKS_TITLE"),className:"landing-ui-panel-block-list",scrollAnimation:true});l.subscribe("onCancel",(function(){t.enableAddBlockButtons()}));i.forEach((function(e){var a=!k(n[e].items);var o=e==="popular";var i=n[e].separator;if(a&&!o||i){l.appendSidebarButton(t.createBlockPanelSidebarButton(e,n[e]))}}));l.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("feedback_button",{className:"landing-ui-button-sidebar-feedback",text:a.Loc.getMessage("LANDING_BLOCKS_LIST_FEEDBACK_BUTTON"),onClick:this.showFeedbackForm.bind(this)}));return l}},{key:"showSliderFeedbackForm",value:function e(){var n=this;r.Runtime.loadExtension("ui.feedback.form").then((function(){var e={};e.bitrix24=n.options.server_name;e.siteId=n.options.site_id;e.siteUrl=n.options.url;e.siteTemplate=n.options.xml_id;e.productType=n.options.productType||"Undefined";e.typeproduct=function(){if(n.options.params.type===t.TYPE_GROUP){return"KNOWLEDGE_GROUP"}return n.options.params.type}();BX.UI.Feedback.Form.open({id:Math.random()+"",forms:n.getFeedbackFormOptions(),presets:e})}))}},{key:"getFeedbackFormOptions",value:function e(){return[{zones:["en","eu","in","uk"],id:16,lang:"en",sec:"3h483y"},{zones:["ru","by","kz"],id:8,lang:"ru",sec:"x80yjw"},{zones:["ua"],id:18,lang:"ua",sec:"d9e09o"},{zones:["la","co","mx"],id:14,lang:"la",sec:"wu561i"},{zones:["de"],id:10,lang:"de",sec:"eraz2q"},{zones:["com.br","br"],id:12,lang:"br",sec:"r6wvge"}]}},{key:"onSliderFormLoaded",value:function e(){this.sliderFormLoader.hide()}},{key:"showFeedbackForm",value:function e(){this.showSliderFeedbackForm({target:"blocksList"})}},{key:"initFeedbackForm",value:function e(){var t=s.PageObject.getRootWindow();(function(e,t,n,a){e.Bitrix24FormObject=a;e[a]=e[a]||function(){arguments[0].ref=n;(e[a].forms=e[a].forms||[]).push(arguments[0])};if(e[a].forms)return;var o=t.createElement("script");var i=1*new Date;o.async=1;o.src="".concat(n,"?").concat(i);var l=t.getElementsByTagName("script")[0];l.parentNode.insertBefore(o,l)})(t,t.document,"https://product-feedback.bitrix24.com/bitrix/js/crm/form_loader.js","b24formFeedBack")}},{key:"createBlockPanelSidebarButton",value:function e(t,n){return new BX.Landing.UI.Button.SidebarButton(t,{text:n.name,child:!n.separator,className:n["new"]?"landing-ui-new-section":"",onClick:this.onBlocksListCategoryChange.bind(this,t)})}},{key:"addNewBlockToCategory",value:function e(t,n){if(this.blocks[t]){var a=n["codeOriginal"]||n["code"];if(t==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.blocks.last.items)}this.lastBlocks.unshift(a)}else{this.blocks[t].items[a]=n}this.onBlocksListCategoryChange(t)}}},{key:"removeBlockFromList",value:function e(t){var n=false;for(var a in this.blocks){if(this.blocks[a].items[t]!==undefined){delete this.blocks[a].items[t];n=true}}if(this.lastBlocks.indexOf(t)!==-1){this.lastBlocks.splice(this.lastBlocks.indexOf(t),1);n=true}if(n){var o=this.getBlocksPanel().sidebarButtons.find((function(e){return r.Dom.hasClass(e.layout,"landing-ui-active")}));if(o){this.onBlocksListCategoryChange(o.id)}}}},{key:"getTemplateCode",value:function e(){var t=n.Env.getInstance().getOptions(),a=t.tplCode;if(a.indexOf("@")>0){a=a.split("@")[1]}if(!a||a.length<=0){a=null}return a}},{key:"onBlocksListCategoryChange",value:function e(t){var n=this;var a=this.getTemplateCode();this.getBlocksPanel().content.hidden=false;this.getBlocksPanel().sidebarButtons.forEach((function(e){var n=e.id===t?"add":"remove";e.layout.classList[n]("landing-ui-active")}));this.getBlocksPanel().content.innerHTML="";if(t==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.blocks.last.items)}this.lastBlocks=babelHelpers.toConsumableArray(new Set(this.lastBlocks));this.lastBlocks.forEach((function(e){var t=n.getBlockFromRepository(e);n.getBlocksPanel().appendCard(n.createBlockCard(e,t))}));return}Object.keys(this.blocks[t].items).forEach((function(e){var o=n.blocks[t].items[e];var i=o["tpl_code"]&&o["tpl_code"].length>0?o["tpl_code"]:null;if(!a||!i||i&&i===a){n.getBlocksPanel().appendCard(n.createBlockCard(e,o))}}));if(this.getBlocksPanel().content.scrollTop){requestAnimationFrame((function(){n.getBlocksPanel().content.scrollTop=0}))}}},{key:"getBlockFromRepository",value:function e(t){var n=this.options.blocks;var a=Object.keys(n);var o=a.find((function(e){return t in n[e].items}));if(o){return n[o].items[t]}}},{key:"onCopyBlock",value:function e(t){window.localStorage.landingBlockId=t.id;window.localStorage.landingBlockName=t.manifest.block.name;window.localStorage.landingBlockAction="copy";try{window.localStorage.requiredUserAction=JSON.stringify(t.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}}},{key:"onCutBlock",value:function e(t){window.localStorage.landingBlockId=t.id;window.localStorage.landingBlockName=t.manifest.block.name;window.localStorage.landingBlockAction="cut";try{window.localStorage.requiredUserAction=JSON.stringify(t.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}BX.Landing.PageObject.getBlocks().remove(t);r.Dom.remove(t.node);BX.onCustomEvent("Landing.Block:onAfterDelete",[t])}},{key:"onPasteBlock",value:function e(t,n){var a=this;if(window.localStorage.landingBlockId){var o="Landing::copyBlock";if(window.localStorage.landingBlockAction==="cut"){o="Landing::moveBlock"}var i={};i[o]={action:o,data:{lid:t.lid||BX.Landing.Main.getInstance().id,block:window.localStorage.landingBlockId,params:{AFTER_ID:t.id,RETURN_CONTENT:"Y"}}};BX.Landing.Backend.getInstance().batch(o,i,{action:o}).then((function(e){a.currentBlock=t;return a.addBlock(e[o].result.content,false,false,n)}))}}},{key:"addBlock",value:function e(t,n){var a=arguments.length>3?arguments[3]:undefined;if(this.lastBlocks){this.lastBlocks.unshift(t.manifest.codeOriginal||t.manifest.code)}var o=this;var i=this.appendBlock(t,n);return this.loadBlockDeps(t).then((function(e){o.currentBlock=null;o.currentArea=null;var n=parseInt(t.id);var l=BX.Landing.PageObject.getBlocks();if(l){l.forEach((function(e){if(e.id===n){r.Dom.remove(e.node);BX.Landing.PageObject.getBlocks().remove(e)}}))}void new BX.Landing.Block(i,{id:n,sections:t.sections,requiredUserAction:t.requiredUserAction,manifest:t.manifest,access:t.access,active:r.Text.toBoolean(t.active),php:t.php,designed:t.designed,anchor:t.anchor,dynamicParams:t.dynamicParams,repoId:t.repoId});return o.runBlockScripts(t).then((function(){if(a){a(n)}return i}))}))["catch"]((function(e){console.warn(e)}))}},{key:"onAddBlock",value:function e(t,n){var a=this;var o=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var i=r.Text.toNumber(n);this.hideBlocksPanel();return this.showBlockLoader().then(this.loadBlock(t,i,o)).then((function(e){return new Promise((function(t){setTimeout((function(){t(e)}),500)}))})).then((function(e){e.manifest.codeOriginal=t;var n=a.addBlock(e,false,a.insertBefore);a.insertBefore=false;a.adjustEmptyAreas();void a.hideBlockLoader();a.enableAddBlockButtons();BX.onCustomEvent("BX.Landing.Block:onAfterAdd",e);a.sendAnalyticsData("onAddBlock",e);return n}))}},{key:"insertToBlocksFlow",value:function e(t){var n=this.currentBlock&&this.currentBlock.node&&this.currentBlock.node.parentNode;if(n&&!this.insertBefore){r.Dom.insertAfter(t,this.currentBlock.node);return}if(n&&this.insertBefore){r.Dom.insertBefore(t,this.currentBlock.node)}r.Dom.prepend(t,this.currentArea)}},{key:"getBlockLoader",value:function e(){if(!this.blockLoader){this.blockLoader=new BX.Loader({size:60});this.blockLoaderContainer=r.Dom.create("div",{props:{className:"landing-block-loader-container"},children:[this.blockLoader.layout]})}return this.blockLoaderContainer}},{key:"showBlockLoader",value:function e(){this.insertToBlocksFlow(this.getBlockLoader());this.blockLoader.show();return Promise.resolve()}},{key:"hideBlockLoader",value:function e(){r.Dom.remove(this.getBlockLoader());this.blockLoader=null;return Promise.resolve()}},{key:"loadBlockDeps",value:function e(t){var n=this;var o=BX.processHTML(t.content_ext);if(BX.type.isArray(o.SCRIPT)){o.SCRIPT=o.SCRIPT.filter((function(e){return!e.isInternal}))}if(BX.type.isObject(t.lang)){a.Loc.setMessage(t.lang)}var i=0;var l=t.js.length+o.SCRIPT.length+o.STYLE.length+t.css.length;var s=null;if(!this.loadedDeps[t.manifest.code]&&l>0){s=new Promise((function(e){function a(){i+=1;if(i===l){e(t)}}if(l>i){o.SCRIPT.forEach((function(e){if(!e.isInternal){BX.loadScript(e.JS,a)}}));o.STYLE.forEach((function(e){BX.loadScript(e,a)}));t.css.forEach((function(e){BX.loadScript(e,a)}));t.js.forEach((function(e){BX.loadScript(e,a)}))}else{a()}n.loadedDeps[t.manifest.code]=true}))}else{s=Promise.resolve(t)}return s.then((function(e){if(BX.type.isArray(e.assetStrings)){var t=document.head;e.assetStrings.forEach((function(e){var n=r.Tag.render(H||(H=babelHelpers.taggedTemplateLiteral(["",""])),e);r.Dom.insertAfter(n,t.lastChild)}))}return e}))}},{key:"runBlockScripts",value:function e(t){return new Promise((function(e){var n=BX.processHTML(t.content).SCRIPT;if(n.length){BX.ajax.processScripts(n,undefined,(function(){e(t)}))}else{e(t)}}))}},{key:"loadBlock",value:function e(t,n,a){var o=this;return function(){var e=o.id;var i=o.options.site_id;if(o.currentBlock){e=o.currentBlock.lid;i=o.currentBlock.siteId}if(o.currentArea){e=r.Dom.attr(o.currentArea,"data-landing");i=r.Dom.attr(o.currentArea,"data-site")}var l={lid:e,siteId:i,preventHistory:a?1:0};var s={ACTIVE:"Y",CODE:t,AFTER_ID:o.currentBlock?o.currentBlock.id:0,RETURN_CONTENT:"Y"};if(!r.Type.isBoolean(a)||a===false){BX.Landing.History.getInstance().push()}if(!n){l.fields=s;return c.Backend.getInstance().action("Landing::addBlock",l,{code:t}).then((function(t){if(o.insertBefore){return c.Backend.getInstance().action("Landing::upBlock",{lid:e,siteId:i,block:t.id}).then((function(){return t}))}return t}))}return BX.Landing.Backend.getInstance().action("Block::getContent",{block:n,lid:e,fields:s,editMode:1}).then((function(e){e.id=n;return e}))}}},{key:"createBlockCard",value:function e(t,n,a){return new BX.Landing.UI.Card.BlockPreviewCard({title:n.name,image:n.preview,code:t,app_expired:n.app_expired,favorite:!!n.favorite,favoriteMy:!!n.favoriteMy,repo_id:n.repo_id,mode:a,isNew:n["new"]===true,onClick:this.onAddBlock.bind(this,t)})}},{key:"onBlockDelete",value:function e(t){if(!t.parent.querySelector(".block-wrapper")){this.adjustEmptyAreas()}this.sendAnalyticsData("onDeleteBlock",t)}},{key:"showOverlay",value:function e(){var t=document.querySelector("main.landing-edit-mode");if(t){r.Dom.addClass(t,"landing-ui-overlay")}}},{key:"hideOverlay",value:function e(){var t=document.querySelector("main.landing-edit-mode");if(t){r.Dom.removeClass(t,"landing-ui-overlay")}}},{key:"reloadSlider",value:function e(t){return l.SliderHacks.reloadSlider(t,window.parent)}},{key:"sendAnalyticsData",value:function e(t,n){var a=n.manifest.code;var o=this.getBlockFromRepository(a);var i="";var l="";var s="";var r=BX.Landing.Env.getInstance().getType();if(r==="MAINPAGE"){i="vibe";if(t==="onAddBlock"){s="add_widget"}if(t==="onDeleteBlock"){s="delete_widget"}var c=a.replaceAll(/[._]/g,"-");l="widget-id_".concat(c)}else{i="site";if(t==="onAddBlock"){s="add_block"}if(t==="onDeleteBlock"){s="delete_block"}var d=a.replaceAll(/[._]/g,"-");l="widget-id_".concat(d)}var u="";var f="";if(o.repo_id){u="partner";if(o.app_code){f=o.app_code.replaceAll(/[._]/g,"-")}}else{u="system";f="system"}BX.UI.Analytics.sendData({tool:"landing",category:i,event:s,type:u,p1:f,p2:l})}}]);return t}(t.EventEmitter);babelHelpers.defineProperty(O,"TYPE_PAGE","PAGE");babelHelpers.defineProperty(O,"TYPE_STORE","STORE");babelHelpers.defineProperty(O,"TYPE_KNOWLEDGE","KNOWLEDGE");babelHelpers.defineProperty(O,"TYPE_GROUP","GROUP");e.Main=O})(this.BX.Landing=this.BX.Landing||{},BX.Event,BX.Landing,BX.Landing,BX.Landing.UI.Panel,BX.Landing.UI.Panel,BX.Landing,BX.Landing,BX,BX.Landing);
//# sourceMappingURL=main.bundle.map.js