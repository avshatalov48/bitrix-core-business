(function(e,t,i,r,a){"use strict";function n(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<li data-role="createItem"\n\t\t\t\t\t\t class="catalog-productcard-popup-select-item catalog-productcard-popup-select-item-new"\n\t\t\t\t\t\t onclick="BX.Catalog.VariationGrid.firePropertyModification(',')">\n\t\t\t\t\t\t<label class="catalog-productcard-popup-select-label">\n\t\t\t\t\t\t\t<span class="catalog-productcard-popup-select-add"></span>\n\t\t\t\t\t\t\t<span class="catalog-productcard-popup-select-text">\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t\t</span>\n\t\t\t\t\t\t</label>\n\t\t\t\t\t</li>"]);n=function t(){return e};return e}var o="template_0";var s=function(){function e(){var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"grid",null);babelHelpers.defineProperty(this,"isNew",false);babelHelpers.defineProperty(this,"propertiesWithMenu",[]);this.createPropertyId=i.createPropertyId;this.createPropertyHintId=i.createPropertyHintId;this.gridId=i.gridId;this.isNew=i.isNew;this.hiddenProperties=i.hiddenProperties;this.modifyPropertyLink=i.modifyPropertyLink;this.gridEditData=i.gridEditData;this.canHaveSku=i.canHaveSku||false;var r=i.isGridReload||false;if(!r){this.addCustomClassToGrid();this.bindCreateNewVariation();this.bindCreateSkuProperty();this.clearGridSettingsPopupStuff()}var a=i.gridEditData||null;if(a){this.setGridEditData(a)}if(this.isNew){this.enableEdit();this.prepareNewNodes()}else{this.bindInlineEdit()}t.Event.bind(this.getGrid().getScrollContainer(),"scroll",t.Runtime.throttle(this.onScrollHandler.bind(this),50));t.Event.bind(this.getGridSettingsButton(),"click",this.showGridSettingsWindowHandler.bind(this));this.subscribeCustomEvents()}babelHelpers.createClass(e,[{key:"subscribeCustomEvents",value:function e(){this.onPropertySaveHandler=this.onPropertySave.bind(this);i.EventEmitter.subscribe("SidePanel.Slider:onMessage",this.onPropertySaveHandler);this.onAllRowsSelectHandler=this.enableEdit.bind(this);i.EventEmitter.subscribe("Grid::allRowsSelected",this.onAllRowsSelectHandler);this.showPropertySettingsSliderHandler=this.showPropertySettingsSlider.bind(this);i.EventEmitter.subscribe("VariationGrid::propertyModify",this.showPropertySettingsSliderHandler);this.onPrepareDropDownItemsHandler=this.onPrepareDropDownItems.bind(this);i.EventEmitter.subscribe("Dropdown::onPrepareItems",this.onPrepareDropDownItemsHandler)}},{key:"unsubscribeCustomEvents",value:function e(){if(this.onPropertySaveHandler){i.EventEmitter.unsubscribe("SidePanel.Slider:onMessage",this.onPropertySaveHandler);this.onPropertySaveHandler=null}if(this.showPropertySettingsSliderHandler){i.EventEmitter.unsubscribe("VariationGrid::propertyModify",this.showPropertySettingsSliderHandler);this.showPropertySettingsSliderHandler=null}if(this.onPrepareDropDownItemsHandler){i.EventEmitter.unsubscribe("Dropdown::onPrepareItems",this.onPrepareDropDownItemsHandler);this.onPrepareDropDownItemsHandler=null}if(this.onAllRowsSelectHandler){i.EventEmitter.unsubscribe("Grid::allRowsSelected",this.onAllRowsSelectHandler);this.onAllRowsSelectHandler=null}}},{key:"getGridSettingsButton",value:function e(){return this.getGrid().getContainer().querySelector("."+this.getGrid().settings.get("classSettingsButton"))}},{key:"showGridSettingsWindowHandler",value:function e(t){var i=this;t.preventDefault();t.stopPropagation();this.askToLossGridData(function(){i.getGrid().getSettingsWindow()._onSettingsButtonClick()})}},{key:"onScrollHandler",value:function e(t){var i=r.PopupManager.getCurrentPopup();if(i){i.close()}this.propertiesWithMenu.forEach(function(e){var t=r.MenuManager.getMenuById(e+"_menu");if(t){t.close()}})}},{key:"onPrepareDropDownItems",value:function e(i){var r=i.getData(),a=babelHelpers.slicedToArray(r,3),n=a[0],o=a[1],s=a[2];if(!t.Type.isStringFilled(n)){return}this.propertiesWithMenu.push(n);if(n.indexOf("SKU_GRID_PROPERTY_")===-1){return}if(!t.Type.isArray(s)){return}var d=s.filter(function(e){return e.action==="create-new"});if(d.length>0){return}var l=n.replace("SKU_GRID_PROPERTY_","").replace("_control","");s.push({action:"create-new",text:'\n\t\t\t\t<li data-role="createItem" class="catalog-productcard-popup-select-item catalog-productcard-popup-select-item-new">\n\t\t\t\t\t<label class="catalog-productcard-popup-select-label main-dropdown-item" data-pseudo="true">\n\t\t\t\t\t\t<span class="catalog-productcard-popup-select-add"></span>\n\t\t\t\t\t\t<span class="catalog-productcard-popup-select-text">\n\t\t\t\t\t\t\t'.concat(t.Loc.getMessage("C_PVG_ADD_NEW_PROPERTY_VALUE_BUTTON"),"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</label>\n\t\t\t\t</li>"),onclick:function e(){return BX.Catalog.VariationGrid.firePropertyModification(l,o)}});requestAnimationFrame(function(){var e=document.getElementById("menu-popup-"+o);t.Dom.addClass(e,"catalog-productcard-popup-list")})}},{key:"clearGridSettingsPopupStuff",value:function e(){t.Dom.remove(document.getElementById(this.gridId+"-grid-settings-window"))}},{key:"bindCreateNewVariation",value:function e(){if(!this.canHaveSku){return}var i=document.querySelector('[data-role="catalog-productcard-variation-add-row"]');if(t.Type.isDomNode(i)){t.Event.bind(i,"click",this.addRowToGrid.bind(this))}}},{key:"addCustomClassToGrid",value:function e(){t.Dom.addClass(this.getGrid().getContainer(),"catalog-product-variation-grid")}},{key:"getGrid",value:function e(){if(this.grid===null){if(!t.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(this.gridId,"' id."))}this.grid=BX.Main.gridManager.getInstanceById(this.gridId)}return this.grid}},{key:"enableEdit",value:function e(){this.getGrid().getRows().selectAll();this.getGrid().editSelected()}},{key:"prepareNewNodes",value:function e(){var t=this;this.getGrid().getRows().getBodyChild().map(function(e){var i=e.getNode();t.markNodeAsNew(i);t.addSkuListCreationItem(i);t.modifyCustomSkuProperties(i)})}},{key:"markNodeAsNew",value:function e(i){t.Dom.addClass(i,"main-grid-row-new")}},{key:"bindInlineEdit",value:function e(){var i=this;this.getGrid().getRows().getBodyChild().forEach(function(e){return t.Event.bind(e.node,"click",function(t){return i.toggleInlineEdit(e,t)})})}},{key:"getEditorInstance",value:function e(){if(t.Reflection.getClass("BX.UI.EntityEditor")){return BX.UI.EntityEditor.getDefault()}return null}},{key:"bindCreateSkuProperty",value:function e(){if(!this.canHaveSku){return}var i=document.getElementById(this.createPropertyId);var r=this.getEditorInstance().getControlByIdRecursive("variation_grid");if(t.Type.isDomNode(i)&&r){r._createChildButton=i;t.Event.bind(i,"click",r.onCreateFieldBtnClick.bind(r))}var a=document.getElementById(this.createPropertyHintId);t.Event.bind(a,"click",this.showHelp.bind(this))}},{key:"showHelp",value:function e(i){if(t.Reflection.getClass("top.BX.Helper")){top.BX.Helper.show("redirect=detail&code=11657102");i.preventDefault()}}},{key:"toggleInlineEdit",value:function e(t,r){var a=false;if(t.isEdit()){if(this.hasClickedOnCheckboxArea(t,r.target)){a=true;this.deactivateInlineEdit(t)}}else{if(r.target.nodeName!=="A"){a=true;this.activateInlineEdit(t)}}if(a){if(this.getGrid().getRows().isSelected()){i.EventEmitter.emit("Grid::thereEditedRows",[])}else{i.EventEmitter.emit("Grid::noEditedRows",[])}this.getGrid().adjustRows();this.getGrid().updateCounterSelected();this.getGrid().updateCounterDisplayed();this.getGrid().adjustCheckAllCheckboxes()}}},{key:"hasClickedOnCheckboxArea",value:function e(i,r){if(!t.Type.isDomNode(r)){return}var a=i.getCells();for(var n in a){if(a.hasOwnProperty(n)&&a[n].contains(i.getCheckbox())&&(a[n]===r||a[n].contains(r))){return true}}return false}},{key:"activateInlineEdit",value:function e(t){t.select();t.edit();this.addSkuListCreationItem(t.getNode())}},{key:"deactivateInlineEdit",value:function e(t){var i=this;t.editCancel();t.unselect();this.getGrid().clickPrevent=true;setTimeout(function(){i.getGrid().clickPrevent=false},100)}},{key:"modifyCustomSkuProperties",value:function e(t){var i="_"+t.getAttribute("data-id");t.querySelectorAll('input[type="radio"]').forEach(function(e){e.id+=i;e.setAttribute("name",e.getAttribute("name")+i)});t.querySelectorAll("label[data-role]").forEach(function(e){e.setAttribute("for",e.getAttribute("for")+i)})}},{key:"addSkuListCreationItem",value:function e(i){i.querySelectorAll('[data-role="dropdownContent"] ul').forEach(function(e){if(!e.querySelector('[data-role="createItem"]')){var i=e.getAttribute("data-propertyId");var r=t.Tag.render(n(),i,BX.message("C_PVG_ADD_NEW_PROPERTY_VALUE_BUTTON"));e.appendChild(r)}})}},{key:"addRowToGrid",value:function e(){var r=this.redefineTemplateEditData();var a=this.getGrid();var n=a.prependRowEditor();var o=n.getCheckbox();if(t.Type.isDomNode(o)){o.setAttribute("disabled","disabled")}var s=n.getNode();a.getRows().reset();if(t.Type.isDomNode(s)){s.setAttribute("data-id",t.Text.getRandom());this.markNodeAsNew(s);this.modifyCustomSkuProperties(s);this.addSkuListCreationItem(s);n.makeCountable()}if(r){this.setOriginalTemplateEditData(r)}i.EventEmitter.emit("Grid::thereEditedRows",[]);a.adjustRows();a.updateCounterDisplayed();a.updateCounterSelected()}},{key:"removeRowFromGrid",value:function e(t){this.getGrid().removeRow(t)}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[o]=t}},{key:"redefineTemplateEditData",value:function e(){var t=this.getEditDataFromSelectedValues();if(!t){t=this.getEditDataFromNotSelectedValues()}if(t){t=babelHelpers.objectSpread({},t);this.prepareNewRowData(t);var i=this.getGridEditData();var r=i[o];var a=this.prepareCustomEditData(r);this.setOriginalTemplateEditData(babelHelpers.objectSpread({},r,t,a));return r}return null}},{key:"getEditDataFromSelectedValues",value:function e(){var t=this.getGrid().getRows().getSelected();return t.length?t[0].editGetValues():null}},{key:"getEditDataFromNotSelectedValues",value:function e(){var i=this.getGrid().arParams.EDITABLE_DATA;var r=Object.keys(i).reverse().find(function(e){return e!==o&&t.Type.isPlainObject(i[e])});return r?i[r]:null}},{key:"prepareNewRowData",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)&&(i.includes("[VIEW_HTML]")||i.includes("[EDIT_HTML]"))){delete t[i]}}}},{key:"prepareCustomEditData",value:function e(t){var i={};for(var r in t){if(t.hasOwnProperty(r)&&r.includes("[EDIT_HTML]")){if(t[r].indexOf("new BX.UI.ImageInput")>=0){var a="bx_file_"+r.replace("[EDIT_HTML]","").toLowerCase()+"_";var n=t[r].match(new RegExp("'("+a+"[A-Za-z0-9_]+)'"));if(n[1]){i[r]=t[r].replace(new RegExp(n[1],"g"),a+this.getRandomInt())}}}}return i}},{key:"getRandomInt",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:1e5;return Math.floor(Math.random()*Math.floor(t))}},{key:"getHeaderNames",value:function e(){var t=[];var i=this.getGrid().getRows().getHeadFirstChild().getCells();Array.from(i).forEach(function(e){if("name"in e.dataset){t.push(e.dataset.name)}});return t}},{key:"addPropertyToGridHeader",value:function e(t){var i=this;BX.ajax.runComponentAction("bitrix:catalog.productcard.variation.grid","addPropertyHeader",{mode:"ajax",data:{gridId:this.getGrid().getId(),propertyCode:t.id,anchor:t.anchor||null,currentHeaders:this.getHeaderNames()}}).then(function(e){i.reloadGrid()})}},{key:"reloadGrid",value:function e(){this.getGrid().reload()}},{key:"onPropertySave",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,1),a=r[0];if(a.getEventId()==="PropertyCreationForm:onAdd"){var n=a.getData();this.addPropertyToGridHeader({id:n.fields.CODE})}if(a.getEventId()==="PropertyCreationForm:onModify"){this.reloadGrid()}}},{key:"showPropertySettingsSlider",value:function e(t){var i=t.getData(),r=babelHelpers.slicedToArray(i,1),a=r[0];var n=this.modifyPropertyLink.replace("#PROPERTY_ID#",a);this.askToLossGridData(function(){BX.SidePanel.Instance.open(n,{width:550,allowChangeHistory:false,cacheable:false})})}},{key:"askToLossGridData",value:function e(i,r,n){if(this.isGridInEditMode()){var o={title:t.Loc.getMessage("C_PVG_UNSAVED_DATA_TITLE"),message:t.Loc.getMessage("C_PVG_UNSAVED_DATA_MESSAGE"),modal:true,buttons:a.MessageBoxButtons.OK_CANCEL,okCaption:t.Loc.getMessage("C_PVG_UNSAVED_DATA_CONTINUE"),onOk:function e(t){i&&i();t.close()},onCancel:function e(t){r&&r();t.close()}};a.MessageBox.show(babelHelpers.objectSpread({},o,n))}else{i&&i()}}},{key:"isGridInEditMode",value:function e(){return this.getGrid().getRows().getBodyChild().filter(function(e){return e.isShown()&&e.isEdit()}).length>0}}],[{key:"firePropertyModification",value:function e(t,a){if(a){var n=r.MenuManager.getMenuById(a);if(n){n.close();n.destroy()}}else{var o=r.PopupManager.getCurrentPopup();if(o){o.close()}}i.EventEmitter.emit("VariationGrid::propertyModify",[t])}}]);return e}();t.Reflection.namespace("BX.Catalog").VariationGrid=s})(this.window=this.window||{},BX,BX.Event,BX.Main,BX.UI.Dialogs);
//# sourceMappingURL=script.map.js