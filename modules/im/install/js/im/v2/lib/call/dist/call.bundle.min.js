this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,s,t,a,l,i,r,o,n,c,d,b,v,u,h){"use strict";class p{static createRoom(e){c.runAction(d.RestMethod.imCallBetaCreateRoom,{data:{chatId:e}})}}let g=e=>e,C;const L=e=>{const s=()=>{const s=a.getSelectedItems();const t=P(s);e.onSelect({users:t})};const t=()=>{a.hide()};const a=new v.Dialog({targetNode:e.bindElement,width:400,enableSearch:true,dropdownMode:true,context:"IM_CHAT_SEARCH",entities:[{id:"user",dynamicLoad:true,itemOptions:{default:{linkTitle:"",link:""}},options:{inviteEmployeeLink:false,"!userId":h.Core.getUserId()},filters:[{id:"im.userDataFilter"}]}],footer:B(s,t)});a.show();return Promise.resolve({close:()=>{a.hide()}})};const P=e=>e.map((e=>({id:e.id,name:e.title.text,avatar:e.avatar,avatar_hr:e.avatar,gender:e.customData.get("imUser").GENDER})));const B=(e,s)=>{const t=b.Loc.getMessage("IM_LIB_CALL_ADD_BUTTON");const a=b.Loc.getMessage("IM_LIB_CALL_CANCEL_BUTTON");return b.Tag.render(C||(C=g`
		<button class="ui-btn ui-btn-xs ui-btn-primary" onclick="${0}">${0}</button>
		<button class="ui-btn ui-btn-xs ui-btn-light-border" onclick="${0}">${0}</button>
	`),e,t,s,a)};var f=babelHelpers.classPrivateFieldLooseKey("controller");var F=babelHelpers.classPrivateFieldLooseKey("store");var H=babelHelpers.classPrivateFieldLooseKey("getController");var y=babelHelpers.classPrivateFieldLooseKey("subscribeToEvents");var m=babelHelpers.classPrivateFieldLooseKey("onCallCreated");var A=babelHelpers.classPrivateFieldLooseKey("onCallJoin");var I=babelHelpers.classPrivateFieldLooseKey("onCallLeave");var E=babelHelpers.classPrivateFieldLooseKey("onCallDestroy");var M=babelHelpers.classPrivateFieldLooseKey("onOpenChat");var S=babelHelpers.classPrivateFieldLooseKey("checkCallSupport");var X=babelHelpers.classPrivateFieldLooseKey("checkUserCallSupport");var O=babelHelpers.classPrivateFieldLooseKey("checkChatCallSupport");var D=babelHelpers.classPrivateFieldLooseKey("pushServerIsActive");var j=babelHelpers.classPrivateFieldLooseKey("getCurrentDialogId");var U=babelHelpers.classPrivateFieldLooseKey("isUser");var w=babelHelpers.classPrivateFieldLooseKey("prepareUserCall");var T=babelHelpers.classPrivateFieldLooseKey("getChatUserCounter");class R{static getInstance(){if(!this.instance){this.instance=new this}return this.instance}static init(){R.getInstance()}constructor(){Object.defineProperty(this,T,{value:Y});Object.defineProperty(this,w,{value:Q});Object.defineProperty(this,U,{value:z});Object.defineProperty(this,j,{value:G});Object.defineProperty(this,D,{value:Z});Object.defineProperty(this,O,{value:W});Object.defineProperty(this,X,{value:q});Object.defineProperty(this,S,{value:J});Object.defineProperty(this,M,{value:$});Object.defineProperty(this,E,{value:V});Object.defineProperty(this,I,{value:N});Object.defineProperty(this,A,{value:x});Object.defineProperty(this,m,{value:k});Object.defineProperty(this,y,{value:_});Object.defineProperty(this,H,{value:K});Object.defineProperty(this,f,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,F)[F]=h.Core.getStore();if(this.isAvailable()){babelHelpers.classPrivateFieldLooseBase(this,f)[f]=babelHelpers.classPrivateFieldLooseBase(this,H)[H]()}babelHelpers.classPrivateFieldLooseBase(this,y)[y]()}isAvailable(){const{callInstalled:e}=b.Extension.getSettings("im.v2.lib.call");return e===true}createBetaCallRoom(e){if(!this.isAvailable()){return}p.createRoom(e)}startCall(e,s=true){if(!this.isAvailable()){return}r.Logger.warn("CallManager: startCall",e,s);if(babelHelpers.classPrivateFieldLooseBase(this,U)[U](e)){babelHelpers.classPrivateFieldLooseBase(this,w)[w](e)}babelHelpers.classPrivateFieldLooseBase(this,f)[f].startCall(e,s)}joinCall(e,s=true){if(!this.isAvailable()){return}r.Logger.warn("CallManager: joinCall",e,s);babelHelpers.classPrivateFieldLooseBase(this,f)[f].joinCall(e,s)}leaveCurrentCall(){if(!this.isAvailable()){return}r.Logger.warn("CallManager: leaveCurrentCall");babelHelpers.classPrivateFieldLooseBase(this,f)[f].leaveCurrentCall()}onJoinFromRecentItem(){babelHelpers.classPrivateFieldLooseBase(this,f)[f].closeCallNotification()}deleteRecentCall(e){babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/deleteActiveCall",{dialogId:e})}foldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].fold()}unfoldCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].unfold()}getCurrentCallDialogId(){var e,s;if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return""}return(e=babelHelpers.classPrivateFieldLooseBase(this,f)[f])==null?void 0:(s=e.currentCall)==null?void 0:s.associatedEntity.id}getCurrentCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall}hasCurrentCall(){if(!this.isAvailable()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()}hasCurrentScreenSharing(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].currentCall.isScreenSharingStarted()}hasVisibleCall(){if(!this.isAvailable()||!babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasActiveCall()){return false}return babelHelpers.classPrivateFieldLooseBase(this,f)[f].hasVisibleCall()}startTest(){if(!this.isAvailable()){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].test()}toggleDebugFlag(e){if(!babelHelpers.classPrivateFieldLooseBase(this,f)[f]){return}babelHelpers.classPrivateFieldLooseBase(this,f)[f].debug=e}chatCanBeCalled(e){if(!this.isAvailable()){return false}const s=babelHelpers.classPrivateFieldLooseBase(this,S)[S](e);const t=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["recent/calls/hasActiveCall"](e);return s&&!t}hasActiveCurrentCall(e){return babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["recent/calls/hasActiveCall"](e)&&this.getCurrentCallDialogId()===e}hasActiveAnotherCall(e){return babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["recent/calls/hasActiveCall"]()&&!this.hasActiveCurrentCall(e)}getCallUserLimit(){return BX.Call.Util.getUserLimit()}isChatUserLimitExceeded(e){return babelHelpers.classPrivateFieldLooseBase(this,T)[T](e)>this.getCallUserLimit()}isConference(e){const s=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["chats/get"](e);return s.type===d.ChatType.videoconf}}function K(){return new a.Controller({init:true,language:h.Core.getLanguageId(),messengerFacade:{getDefaultZIndex:()=>i.MessengerSlider.getInstance().getZIndex(),isMessengerOpen:()=>i.MessengerSlider.getInstance().isOpened(),isSliderFocused:()=>i.MessengerSlider.getInstance().isFocused(),isThemeDark:()=>false,openMessenger:e=>l.Messenger.openChat(e),openHistory:e=>l.Messenger.openChat(e),openSettings:()=>l.Messenger.openSettings(),openHelpArticle:()=>{},getContainer:()=>document.querySelector(`.${R.viewContainerClass}`),getMessageCount:()=>babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["counters/getTotalChatCounter"],getCurrentDialogId:()=>babelHelpers.classPrivateFieldLooseBase(this,j)[j](),isPromoRequired:e=>o.PromoManager.getInstance().needToShow(e),repeatSound:(e,s,t)=>{n.SoundNotificationManager.getInstance().playLoop(e,s,t)},stopRepeatSound:e=>{n.SoundNotificationManager.getInstance().stop(e)},showUserSelector:L},events:{[a.Controller.Events.onPromoViewed]:e=>{const{code:s}=e.getData();o.PromoManager.getInstance().markAsWatched(s)},[a.Controller.Events.onOpenVideoConference]:e=>{var s;const{dialogId:t}=e.getData();const a=h.Core.getStore().getters["chats/get"](`chat${t}`,true);return l.Messenger.openConference({code:(s=a.public)==null?void 0:s.code})}}})}function _(){s.EventEmitter.subscribe(d.EventType.layout.onOpenChat,babelHelpers.classPrivateFieldLooseBase(this,M)[M].bind(this));s.EventEmitter.subscribe(d.EventType.layout.onOpenNotifications,this.foldCurrentCall.bind(this));s.EventEmitter.subscribe(d.EventType.call.onJoinFromRecentItem,this.onJoinFromRecentItem.bind(this));s.EventEmitter.subscribe("CallEvents::callCreated",babelHelpers.classPrivateFieldLooseBase(this,m)[m].bind(this))}function k(e){const{call:s}=e.getData()[0];const t=!babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["recent/calls/getCallByDialog"](s.associatedEntity.id);const l=s.state===a.State.Connected||s.state===a.State.Proceeding?d.RecentCallStatus.joined:d.RecentCallStatus.waiting;if(t){s.addEventListener(BX.Call.Event.onJoin,babelHelpers.classPrivateFieldLooseBase(this,A)[A].bind(this));s.addEventListener(BX.Call.Event.onLeave,babelHelpers.classPrivateFieldLooseBase(this,I)[I].bind(this));s.addEventListener(BX.Call.Event.onDestroy,babelHelpers.classPrivateFieldLooseBase(this,E)[E].bind(this));babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/addActiveCall",{dialogId:s.associatedEntity.id,name:s.associatedEntity.name,call:s,state:l});return}babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/updateActiveCall",{dialogId:s.associatedEntity.id,fields:{name:s.associatedEntity.name,state:l,call:s}})}function x(e){babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:d.RecentCallStatus.joined}})}function N(e){babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/updateActiveCall",{dialogId:e.call.associatedEntity.id,fields:{state:d.RecentCallStatus.waiting}})}function V(e){const s=e.call.associatedEntity.id;const t=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["recent/calls/getCallByDialog"](s);if((t==null?void 0:t.call.id)===e.call.id){babelHelpers.classPrivateFieldLooseBase(this,F)[F].dispatch("recent/calls/deleteActiveCall",{dialogId:s})}}function $(e){const s=this.getCurrentCallDialogId();const t=e.getData().dialogId;if(s===t){return}this.foldCurrentCall()}function J(e){if(!babelHelpers.classPrivateFieldLooseBase(this,D)[D]()||!BX.Call.Util.isWebRTCSupported()){return false}const s=Number.parseInt(e,10);return s>0?babelHelpers.classPrivateFieldLooseBase(this,X)[X](s):babelHelpers.classPrivateFieldLooseBase(this,O)[O](e)}function q(e){const s=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["users/get"](e);const t=s.type===d.UserType.bot;return s&&s.status!=="guest"&&!t&&!s.network&&s.id!==h.Core.getUserId()&&Boolean(s.lastActivityDate)}function W(e){const s=babelHelpers.classPrivateFieldLooseBase(this,T)[T](e);return(s>1||this.isConference(e))&&s<=this.getCallUserLimit()}function Z(){return true}function G(){const e=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["application/getLayout"];if(e.name!==d.Layout.chat.name){return""}return e.entityId}function z(e){const s=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["chats/get"](e);return(s==null?void 0:s.type)===d.ChatType.user}function Q(e){if(!this.isAvailable()){return}const s=h.Core.getUserId();const t=h.Core.getStore().getters["users/get"](s);const a=h.Core.getStore().getters["users/get"](e);babelHelpers.classPrivateFieldLooseBase(this,f)[f].prepareUserCall({dialogId:e,user:a.id,userData:{[s]:t,[a.id]:a}})}function Y(e){const{userCounter:s}=babelHelpers.classPrivateFieldLooseBase(this,F)[F].getters["chats/get"](e,true);return s}R.viewContainerClass="bx-im-messenger__call_container";e.CallManager=R})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Event,BX.Vue3.Vuex,BX.Call,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX,BX.UI.EntitySelector,BX.UI,BX.Messenger.v2.Application);
//# sourceMappingURL=call.bundle.map.js