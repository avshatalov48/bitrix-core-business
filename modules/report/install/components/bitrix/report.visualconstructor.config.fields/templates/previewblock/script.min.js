(function(){"use strict";BX.namespace("BX.Report.VisualConstructor.Widget.Config.Fields");BX.namespace("BX.Report.VisualConstructor.Board");BX.Report.VisualConstructor.Board.CreateFormWidgetPreset=function(e){BX.VisualConstructor.Widget.call(this,e);this.draggable=false};BX.Report.VisualConstructor.Board.CreateFormWidgetPreset.prototype={__proto__:BX.VisualConstructor.Widget.prototype,constructor:BX.Report.VisualConstructor.Board.CreateFormWidgetPreset,getControlsContainer:function(){var e=BX.Report.Dashboard.Widget.prototype.getControlsContainer.call(this);e.classList.add("report-widget-configurations-control-hidden");return e},renderTo:function(e){BX.cleanNode(e);this.loaded=true;e.style.height=this.getHeight()+"px";e.appendChild(this.render());if(!this.getContent().getHeight()){e.style.overflowY="auto"}else{e.style.overflow="hidden"}BX.onCustomEvent(this,"Dashboard.Board.Widget:onAfterRender")}};BX.Report.VisualConstructor.Widget.Config.Fields.PreviewBlock=function(e){BX.Report.VisualConstructor.Field.Base.apply(this,arguments);this.previewBlock=e.previewBlock;this.viewMiniatureBoxes=this.previewBlock.querySelectorAll('[data-type="view-miniature-box"]');this.id=this.fieldScope.id;this.value=e.value;this.widgetOptions=e.widgetOptions;this.previewBlockWidgetContainer=e.previewBlockWidgetContainer;this.init()};BX.Report.VisualConstructor.Widget.Config.Fields.PreviewBlock.prototype={__proto__:BX.Report.VisualConstructor.Field.Base.prototype,constructor:BX.Report.VisualConstructor.Widget.Config.Fields.PreviewBlock,init:function(){for(var e=0;e<this.viewMiniatureBoxes.length;e++){this.viewMiniatureBoxes[e].addEventListener("click",this.handlerMiniatureBoxClick.bind(this,this.viewMiniatureBoxes[e]));this.viewMiniatureBoxes[e].addEventListener("mouseover",this.handlerMiniatureBoxMouseOver.bind(this,this.viewMiniatureBoxes[e]));this.viewMiniatureBoxes[e].addEventListener("mouseout",this.handlerMiniatureBoxMouseOut.bind(this,this.viewMiniatureBoxes[e]))}this.setPresetWidget(new BX.Report.VisualConstructor.Board.CreateFormWidgetPreset(this.widgetOptions))},handlerMiniatureBoxClick:function(e){var t=e.getAttribute("data-view-key");if(this.value===t){return}var i=this.changeView.bind(this,t);var o=this.openConfirmationPopup.bind(this,e);this.checkCompatibilityWithNewViewType(t,i,o)},checkCompatibilityWithNewViewType:function(e,t,i){BX.Report.VC.Core.ajaxPost("widget.checkIsCompatibleWithSelectedView",{data:{params:{newViewKey:e,oldViewKey:this.value}},onFullSuccess:BX.delegate(function(e){if(e.data.isCompatible===true){t.call()}else{i.call()}},this)})},openConfirmationPopup:function(e){var t=e.getAttribute("data-view-key");if(this.confirmationPopup){this.confirmationPopup.destroy()}this.confirmationPopup=new BX.PopupWindow("visualconstructor-dashboard-confirm-popup",e,{closeByEsc:true,offsetLeft:30,autoHide:true,zIndex:9999,width:290,angle:true,content:this.getConfirmDialogContent(),buttons:[new BX.PopupWindowCustomButton({text:BX.message("REPORT_CHANGE_VIEW_CHANGE_CONFIRM_BUTTON_TITLE"),className:"ui-btn ui-btn-lg ui-btn-primary",events:{click:this.handleConfirmButtonClick.bind(this,t)}}),new BX.PopupWindowCustomButton({text:BX.message("REPORT_CHANGE_VIEW_CHANGE_CANCEL_BUTTON_TITLE"),className:"ui-btn ui-btn-lg ui-btn-link",events:{click:function(){this.confirmationPopup.close()}.bind(this)}})]});this.confirmationPopup.show()},changeView:function(e){this.setValue(e);BX.onCustomEvent(this.fieldScope,this.id+"_onSelect",[this,{mode:"reloadWidgetPreview"}])},changeViewWithReloadConfigurations:function(e){this.setValue(e);BX.onCustomEvent(this.fieldScope,this.id+"_onSelect",[this,{mode:"reloadConfigurations"}])},getConfirmDialogContent:function(){return BX.create("div",{attrs:{className:"report-preview-block-confirm-dialog-content-container"},children:[BX.create("div",{attrs:{className:"report-preview-block-confirm-dialog-title-container"},html:BX.message("REPORT_CHANGE_VIEW_ATTENTION_TITLE")}),BX.create("div",{attrs:{className:"report-preview-block-confirm-dialog-text-container"},html:BX.message("REPORT_CHANGE_VIEW_ATTENTION_TEXT")})]})},setValue:function(e){this.fieldScope.value=e;this.value=e;this.markViewMiniature(e)},markViewMiniature:function(e){for(var t=0;t<this.viewMiniatureBoxes.length;t++){this.viewMiniatureBoxes[t].classList.remove("report-widget-view-miniature-container-active")}this.previewBlock.querySelector("[data-view-key="+e+"]").classList.add("report-widget-view-miniature-container-active")},handlerChangePseudoWidget:function(e,t){this.setPresetWidget(new BX.Report.VisualConstructor.Board.CreateFormWidgetPreset(t.data.widget.pseudoWidget))},handleConfirmButtonClick:function(e){this.confirmationPopup.close();this.changeViewWithReloadConfigurations(e)},handlerMiniatureBoxMouseOver:function(e){if(this.miniatureNameHighlightPopup&&this.miniatureNameHighlightPopup.bindElement===e){return}else if(this.miniatureNameHighlightPopup){this.miniatureNameHighlightPopup.destroy()}var t=e.querySelector("img").getAttribute("title");this.miniatureNameHighlightPopup=new BX.PopupWindow("visualconstructor-dashboard-miniature-name-popup",e,{closeByEsc:true,autoHide:true,offsetLeft:35,zIndex:9999,darkMode:true,bindOptions:{position:"top"},angle:{position:"bottom"},content:BX.create("div",{attrs:{className:"report-preview-block-miniature-name-wrapper"},html:t})});this.miniatureNameHighlightPopup.show()},handlerMiniatureBoxMouseOut:function(e,t){var i=t.toElement||t.relatedTarget;if(!i||!i.parentNode||i.parentNode===e||i===e){return}this.miniatureNameHighlightPopup.destroy()},showLoader:function(){BX.cleanNode(this.previewBlockWidgetContainer);var e=this.presetWidget.getLazyLoadPresetContainer();e.classList.remove("report-visualconstructor-dashboard-widget-lazy-load-preset-disable");e.style.backgroundColor="#fcfcfc";this.previewBlockWidgetContainer.appendChild(e)},setPresetWidget:function(e){this.presetWidget=e;this.presetWidget.renderTo(this.previewBlockWidgetContainer);var t=this.previewBlockWidgetContainer.parentNode;var i=this.previewBlockWidgetContainer;if(t.clientHeight/i.clientHeight>1){var o=this.getEmptyCellSkeleton();o.style.height=i.clientHeight+"px";t.appendChild(o)}},getEmptyCellSkeleton:function(){return BX.create("div",{attrs:{className:"report-preview-block-empty-miniature-container"}})}}})();