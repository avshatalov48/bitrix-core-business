this.BX=this.BX||{};(function(e,t,s,i,a,o,n){"use strict";var r=function(){function e(){babelHelpers.classCallCheck(this,e);this.label="";this.formLabel="";this.displayed=false;this.valuePopup=null;this.statePopup=null;this.displayCheckboxDisabled=false;this.DOM={}}babelHelpers.createClass(e,[{key:"build",value:function e(t){this.updateConfig(t.params);this.DOM.fieldWrap=n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-item"}});this.DOM.labelWrap=this.DOM.fieldWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-field"}}));this.DOM.labelNode=this.DOM.labelWrap.appendChild(n.Dom.create("span",{props:{className:"calendar-resbook-webform-settings-popup-field-title"},text:this.getLabel()}));this.DOM.formTitleWrap=this.DOM.labelWrap.appendChild(n.Dom.create("span",{props:{className:"calendar-resbook-webform-settings-popup-field-subtitle"+(this.isDisplayed()?" show":"")}}));this.DOM.formTitleLabel=this.DOM.formTitleWrap.appendChild(n.Dom.create("span",{props:{className:"calendar-resbook-webform-settings-popup-field-subtitle-text"},text:this.getFormLabel(),events:{click:this.enableFormTitleEditMode.bind(this)}}));this.DOM.formTitleEditIcon=this.DOM.formTitleWrap.appendChild(n.Dom.create("span",{props:{className:"calendar-resbook-webform-settings-popup-field-edit"},events:{click:this.enableFormTitleEditMode.bind(this)}}));this.DOM.checkboxNode=this.DOM.fieldWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-checkbox-container"}})).appendChild(n.Dom.create("input",{attrs:{type:"checkbox",value:"Y",checked:this.isDisplayed(),disabled:this.displayCheckboxDisabled},events:{click:this.checkDisplayMode.bind(this)}}));this.buildStatePopup({wrap:this.DOM.fieldWrap,config:t.config||{}});this.buildValuePopup({wrap:this.DOM.fieldWrap,config:t.config||{}});if(n.Type.isFunction(t.changeSettingsCallback)){this.changeSettingsCallback=t.changeSettingsCallback}t.wrap.appendChild(this.DOM.fieldWrap)}},{key:"destroy",value:function e(){if(this.valuePopup&&n.Type.isFunction(this.valuePopup.closePopup)){this.valuePopup.closePopup()}if(this.statePopup&&n.Type.isFunction(this.statePopup.closePopup)){this.statePopup.closePopup()}}},{key:"updateConfig",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setFormLabel(t.label||this.formLabel);if(t.show){this.displayed=t.show!=="N"}}},{key:"buildStatePopup",value:function e(t){}},{key:"buildValuePopup",value:function e(t){}},{key:"getLabel",value:function e(){return this.label}},{key:"getFormLabel",value:function e(){return this.formLabel}},{key:"setFormLabel",value:function e(t){this.formLabel=t||""}},{key:"isDisplayed",value:function e(){return this.displayed}},{key:"checkDisplayMode",value:function e(){this.displayed=!!this.DOM.checkboxNode.checked;if(this.displayed){this.displayInForm()}else{this.hideInForm()}}},{key:"displayInForm",value:function e(){n.Dom.addClass(this.DOM.formTitleWrap,"show");this.triggerChangeRefresh()}},{key:"hideInForm",value:function e(){n.Dom.removeClass(this.DOM.formTitleWrap,"show");this.triggerChangeRefresh()}},{key:"enableFormTitleEditMode",value:function e(){if(!this.DOM.formTitleInputNode){this.DOM.formTitleInputNode=this.DOM.formTitleWrap.appendChild(n.Dom.create("input",{attrs:{type:"text",className:"calendar-resbook-webform-settings-popup-field-subtitle-text"},events:{blur:this.finishFormTitleEditMode.bind(this)}}))}this.DOM.formTitleInputNode.value=this.getFormLabel();this.DOM.formTitleInputNode.style.display="";this.DOM.formTitleLabel.style.display="none";this.DOM.formTitleEditIcon.style.display="none";this.DOM.formTitleInputNode.focus()}},{key:"finishFormTitleEditMode",value:function e(){this.setFormLabel(this.DOM.formTitleInputNode.value);n.Dom.adjust(this.DOM.formTitleLabel,{text:this.getFormLabel()});this.DOM.formTitleLabel.style.display="";this.DOM.formTitleEditIcon.style.display="";this.DOM.formTitleInputNode.style.display="none";this.triggerChangeRefresh()}},{key:"getSettingsValue",value:function e(){}},{key:"triggerChangeRefresh",value:function e(){setTimeout(function(){BX.onCustomEvent("ResourceBooking.webformSettings:onChanged")}.bind(this),50)}}]);return e}();var l=function(){function e(t){babelHelpers.classCallCheck(this,e);this.id="resourcebooking-settings-popup-"+Math.round(Math.random()*1e5);this.menuItems=[];this.DOM={outerWrap:t.wrap};this.handleClickFunc=this.handleClick.bind(this)}babelHelpers.createClass(e,[{key:"build",value:function e(){this.DOM.innerWrap=this.DOM.outerWrap.appendChild(a.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-select"}}));this.DOM.currentStateLink=this.DOM.innerWrap.appendChild(a.Dom.create("span",{props:{className:"calendar-resbook-webform-settings-popup-select-value"},text:this.getCurrentModeState(),events:{click:this.showPopup.bind(this)}}))}},{key:"showPopup",value:function e(){var t=this;if(this.isPopupShown()||this.disabled){return this.closePopup()}this.menuItems=this.getMenuItems();a.Event.unbind(document,"click",this.handleClickFunc);this.popup=BX.PopupMenu.create(this.id,this.DOM.currentStateLink,this.menuItems,{className:"popup-window-resource-select",closeByEsc:true,autoHide:false,offsetTop:0,offsetLeft:0,cacheable:false});this.popup.popupWindow.setAngle({offset:30,position:"top"});this.popup.show(true);this.popupContainer=this.popup.popupWindow.popupContainer;this.popup.menuItems.forEach(function(e){var t=false,s,i,a="";if(e.dataset&&e.dataset.type){i=e.dataset.checked;var o="menu-popup-item";if(e.dataset.type==="radio"){t="radio";s="menu-popup-item-resource-radio";if(e.dataset.inputName){a=' name="'+e.dataset.inputName+'" '}}else if(e.dataset.type==="checkbox"){t="checkbox";s="menu-popup-item-resource-checkbox"}var n='<div class="menu-popup-item-inner">';if(e.dataset.type==="submenu-list"){o+=" menu-popup-item-submenu";n+='<div class="menu-popup-item-resource menu-popup-item-resource-wide">'+'<span class="menu-popup-item-text">'+"<span>"+e.text+"</span>"+'<span class="menu-popup-item-resource-subvalue">'+(e.dataset.textValue||e.dataset.value)+"</span>"+"</span>"+"</div>"}else if(t){n+='<div class="menu-popup-item-resource">';if(t){n+='<input class="'+s+'" type="'+t+'"'+(i?'checked="checked"':"")+' id="'+e.id+'" '+a+">"+'<label class="menu-popup-item-text"  for="'+e.id+'">'+e.text+"</label>"}n+="</div>"}n+="</div>";e.layout.item.className=o;e.layout.item.innerHTML=n}},this);setTimeout(function(){a.Event.bind(document,"click",t.handleClickFunc)},50)}},{key:"closePopup",value:function e(){if(this.isPopupShown()){this.popup.close();this.popupContainer.style.maxHeight=""}}},{key:"isPopupShown",value:function e(){return this.popup&&this.popup.popupWindow&&this.popup.popupWindow.isShown&&this.popup.popupWindow.isShown()&&this.popup.popupWindow.popupContainer&&BX.isNodeInDom(this.popup.popupWindow.popupContainer)}},{key:"getCurrentModeState",value:function e(){return""}},{key:"getMenuItems",value:function e(){return[]}},{key:"getPopupContent",value:function e(){this.DOM.innerWrap=a.Dom.create("div",{props:{className:""}});return this.DOM.innerWrap}},{key:"handlePopupClick",value:function e(t){var s=t.target||t.srcElement;if(s.hasAttribute("data-bx-resbook-control-node")||BX.findParent(s,{attribute:"data-bx-resbook-control-node"},this.DOM.innerWrap)){this.handleControlChanges()}}},{key:"handleControlChanges",value:function e(){if(this.changesTimeout){this.changesTimeout=clearTimeout(this.changesTimeout)}this.changesTimeout=setTimeout(BX.delegate(function(){BX.onCustomEvent("ResourceBooking.webformSettings:onChanged")},this),50)}},{key:"menuItemClick",value:function e(t,s){}},{key:"handleClick",value:function e(t){var s=t.target||t.srcElement;if(this.isPopupShown()&&!BX.isParentForNode(this.popupContainer,s)){return this.closePopup({animation:true})}}},{key:"setDisabled",value:function e(){this.disabled=true;if(this.isPopupShown()){this.closePopup()}a.Dom.addClass(this.DOM.innerWrap,"disabled")}},{key:"setEnabled",value:function e(){this.disabled=false;a.Dom.removeClass(this.DOM.innerWrap,"disabled")}}]);return e}();var c=function(){function e(t){babelHelpers.classCallCheck(this,e);this.id="resourcebooking-settings-value-popup-"+Math.round(Math.random()*1e5);this.selectedValues=[];this.DOM={outerWrap:t.wrap}}babelHelpers.createClass(e,[{key:"build",value:function e(){this.DOM.innerWrap=this.DOM.outerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-select-result"}}));this.DOM.valueLink=this.DOM.innerWrap.appendChild(n.Dom.create("span",{props:{className:"calendar-resbook-webform-settings-popup-select-value"},text:this.getCurrentValueState(),events:{click:this.showPopup.bind(this),mouseover:this.showHoverPopup.bind(this),mouseout:this.hideHoverPopup.bind(this)}}))}},{key:"showPopup",value:function e(){if(this.popup&&this.popup.isShown()){return this.popup.close()}this.popup=new BX.PopupWindow(this.id,this.DOM.valueLink,{autoHide:true,loseByEsc:true,offsetTop:0,offsetLeft:0,width:this.getPopupWidth(),lightShadow:true,content:this.getPopupContent()});this.popup.setAngle({offset:60,position:"top"});this.popup.show(true);BX.unbind(this.DOM.innerWrap,"click",BX.proxy(this.handlePopupClick,this));BX.bind(this.DOM.innerWrap,"click",BX.proxy(this.handlePopupClick,this));BX.addCustomEvent(this.popup,"onPopupClose",BX.delegate(function(){this.handlePopupCloose();this.popup.destroy(this.id);this.popup=null},this))}},{key:"closePopup",value:function e(){if(this.isPopupShown()){this.popup.close()}}},{key:"isPopupShown",value:function e(){return this.popup&&this.popup.popupWindow&&this.popup.popupWindow.isShown&&this.popup.popupWindow.isShown()&&this.popup.popupWindow.popupContainer&&BX.isNodeInDom(this.popup.popupWindow.popupContainer)}},{key:"showHoverPopup",value:function e(){}},{key:"hideHoverPopup",value:function e(){}},{key:"handlePopupCloose",value:function e(){}},{key:"getCurrentValueState",value:function e(){return BX.message("WEBF_RES_NO_VALUE")}},{key:"getPopupContent",value:function e(){this.DOM.innerWrap=n.Dom.create("div",{props:{className:""}});this.DOM.innerWrap.style.minWidth="500px";this.DOM.innerWrap.style.minHeight="30px";return this.DOM.innerWrap}},{key:"getPopupWidth",value:function e(){return null}},{key:"handlePopupClick",value:function e(t){var s=t.target||t.srcElement;if(s.hasAttribute("data-bx-resbook-control-node")||BX.findParent(s,{attribute:"data-bx-resbook-control-node"},this.DOM.innerWrap)){this.handleControlChanges()}}},{key:"handleControlChanges",value:function e(){setTimeout(BX.delegate(function(){BX.onCustomEvent("ResourceBooking.webformSettings:onChanged")},this),50)}},{key:"showPopupLoader",value:function e(){if(this.DOM.innerWrap){this.hidePopupLoader();this.DOM.popupLoader=this.DOM.innerWrap.appendChild(n.BookingUtil.getLoader(50))}}},{key:"hidePopupLoader",value:function e(){n.Dom.remove(this.DOM.popupLoader)}}]);return e}();var u=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.id="resourcebooking-settings-multiple-checknox-"+Math.round(Math.random()*1e5);return s}babelHelpers.createClass(t,[{key:"showPopup",value:function e(){if(this.isPopupShown()){return this.closePopup()}var t=[];this.values.forEach(function(e){t.push({id:e.id,text:BX.util.htmlspecialchars(e.title),dataset:e.dataset,onclick:BX.proxy(this.menuItemClick,this)})},this);if(t.length>1){this.selectAllMessage=this.selectAllMessage||"select all";t.push({text:this.selectAllMessage,onclick:BX.proxy(this.selectAllItemClick,this)})}this.popup=BX.PopupMenu.create(this.id,this.DOM.valueLink,t,{className:"popup-window-resource-select",closeByEsc:true,autoHide:false,offsetTop:0,offsetLeft:0});this.popup.popupWindow.setAngle({offset:60,position:"top"});this.popup.show(true);this.popupContainer=this.popup.popupWindow.popupContainer;BX.addCustomEvent(this.popup.popupWindow,"onPopupClose",BX.proxy(function(){this.handlePopupCloose();BX.PopupMenu.destroy(this.id);this.popup=null},this));this.popup.menuItems.forEach(function(e){var t;if(e.dataset&&e.dataset.id){t=this.selectedValues.find(function(t){return t===e.id});e.layout.item.className="menu-popup-item";e.layout.item.innerHTML='<div class="menu-popup-item-inner">'+'<div class="menu-popup-item-resource">'+'<input class="menu-popup-item-resource-checkbox" type="checkbox"'+(t?'checked="checked"':"")+' id="'+e.id+'">'+'<label class="menu-popup-item-text" for="'+e.id+'">'+e.text+"</label>"+"</div>"+"</div>"}else{this.selectAllChecked=!this.values.find(function(e){return!this.selectedValues.find(function(t){return t===e.id})},this);e.layout.item.className="menu-popup-item menu-popup-item-resource-all";e.layout.item.innerHTML='<div class="menu-popup-item-inner">'+'<div class="menu-popup-item-resource">'+'<input class="menu-popup-item-resource-checkbox menu-popup-item-all-resources-checkbox" type="checkbox"'+(this.selectAllChecked?'checked="checked"':"")+' id="'+e.id+'">'+'<label class="menu-popup-item-text" for="'+e.id+'">'+e.text+"</label>"+"</div>"+"</div>"}},this);setTimeout(BX.delegate(function(){BX.bind(document,"click",BX.proxy(this.handleClick,this))},this),50)}},{key:"menuItemClick",value:function e(t,s){var i,a=t.target||t.srcElement,o=s.layout.item.querySelector(".menu-popup-item-resource-checkbox"),r=this.values.find(function(e){return e.id===s.id});if(r){if(a&&(n.Dom.hasClass(a,"menu-popup-item")||n.Dom.hasClass(a,"menu-popup-item-resource-checkbox")||n.Dom.hasClass(a,"menu-popup-item-inner"))){if(!n.Dom.hasClass(a,"menu-popup-item-resource-checkbox")){o.checked=!o.checked}if(o.checked){this.selectItem(r)}else{this.deselectItem(r);i=this.popupContainer.querySelector(".menu-popup-item-all-resources-checkbox");this.selectAllChecked=false;if(i){i.checked=false}}}this.handleControlChanges()}}},{key:"selectItem",value:function e(t){if(!BX.util.in_array(t.id,this.selectedValues)){this.selectedValues.push(t.id)}}},{key:"deselectItem",value:function e(t){var s=BX.util.array_search(t.id,this.selectedValues);if(s>=0){this.selectedValues=BX.util.deleteFromArray(this.selectedValues,s)}}},{key:"selectAllItemClick",value:function e(t,s){var i=t.target||t.srcElement;if(i&&(n.Dom.hasClass(i,"menu-popup-item")||n.Dom.hasClass(i,"menu-popup-item-resource-checkbox"))){var a=s.layout.item.querySelector(".menu-popup-item-resource-checkbox");if(n.Dom.hasClass(i,"menu-popup-item")){a.checked=!a.checked}var o,r=this.popupContainer.querySelectorAll("input.menu-popup-item-resource-checkbox");this.selectAllChecked=a.checked;for(o=0;o<r.length;o++){r[o].checked=this.selectAllChecked}this.selectedValues=[];if(this.selectAllChecked){this.values.forEach(function(e){this.selectedValues.push(e.id)},this)}this.handleControlChanges()}}},{key:"handleClick",value:function e(t){var s=t.target||t.srcElement;if(this.isPopupShown()&&!BX.isParentForNode(this.popupContainer,s)){this.closePopup({animation:true})}this.handleControlChanges()}},{key:"closePopup",value:function e(){if(this.isPopupShown()){this.popup.close();this.popupContainer.style.maxHeight="";BX.unbind(document,"click",BX.proxy(this.handleClick,this))}}},{key:"getSelectedValues",value:function e(){return this.selectedValues}}]);return t}(c);function p(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t<span \n\t\t\t\t\t\t\tclass="calendar-resbook-webform-settings-popup-select-value"\n\t\t\t\t\t\t\tonclick="','"\n\t\t\t\t\t\t\t>\n\t\t\t\t\t\t\t\t',"\n\t\t\t\t\t\t</span>\n\t\t\t\t\t"]);p=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="calendar-resbook-webform-settings-popup-select-result">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);h=function t(){return e};return e}var d=function(e){babelHelpers.inherits(i,e);function i(){var e;babelHelpers.classCallCheck(this,i);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));e.label=a.Loc.getMessage("WEBF_RES_USERS");e.formLabel=a.Loc.getMessage("WEBF_RES_USERS_LABEL");e.displayed=true;e.selectedUsers=[];return e}babelHelpers.createClass(i,[{key:"updateConfig",value:function e(t){babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"updateConfig",this).call(this,t);this.defaultMode=t.defaultMode}},{key:"buildStatePopup",value:function e(t){t.isDisplayed=this.isDisplayed.bind(this);t.defaultMode=t.defaultMode||this.defaultMode;this.statePopup=new m(t)}},{key:"buildValuePopup",value:function e(t){this.selectedUsers=a.Type.isArray(t.config.selected)?t.config.selected:t.config.selected.split("|");this.DOM.valueWrap=t.wrap;this.DOM.valueWrap.appendChild(a.Tag.render(h(),this.DOM.usersValueLink=a.Tag.render(p(),this.showUserSelectorDialog.bind(this),this.getCurrentUsersValueText())))}},{key:"getCurrentUsersValueText",value:function e(){var t=this.selectedUsers.length;return t?t+" "+W.getPluralMessage("WEBF_RES_USER",t):a.Loc.getMessage("WEBF_RES_NO_VALUE")}},{key:"showUserSelectorDialog",value:function e(){if(!(this.userSelectorDialog instanceof t.Dialog)){this.userSelectorDialog=new t.Dialog({targetNode:this.DOM.usersValueLink,context:"RESOURCEBOOKING",preselectedItems:this.selectedUsers.map(function(e){return["user",e]}),enableSearch:true,zIndex:this.zIndex+10,events:{"Item:onSelect":this.handleUserSelectorChanges.bind(this),"Item:onDeselect":this.handleUserSelectorChanges.bind(this)},entities:[{id:"user",options:{inviteGuestLink:false,emailUsers:false}}]})}this.userSelectorDialog.show()}},{key:"handleUserSelectorChanges",value:function e(){var t=this;this.selectedUsers=[];this.userSelectorDialog.getSelectedItems().forEach(function(e){if(e.entityId==="user"){t.selectedUsers.push(e.id)}});this.DOM.usersValueLink.innerHTML=this.getCurrentUsersValueText();s.EventEmitter.emit("ResourceBooking.settingsUserSelector:onChanged");setTimeout(function(){s.EventEmitter.emit("ResourceBooking.webformSettings:onChanged")},50)}},{key:"displayInForm",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"displayInForm",this).call(this);this.statePopup.handleControlChanges();this.statePopup.setEnabled()}},{key:"hideInForm",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(i.prototype),"hideInForm",this).call(this);this.statePopup.handleControlChanges();this.statePopup.setDisabled()}},{key:"getValue",value:function e(){return{show:this.isDisplayed()?"Y":"N",label:this.getFormLabel(),defaultMode:this.statePopup.getDefaultMode(),value:this.selectedUsers}}}]);return i}(r);var m=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.name="usersStatePopup";s.inputName="user-select-mode";s.id="users-state-"+Math.round(Math.random()*1e3);s.defaultMode=e.defaultMode==="none"?"none":"auto";s.isDisplayed=a.Type.isFunction(e.isDisplayed)?e.isDisplayed:function(){return false};s.build();return s}babelHelpers.createClass(t,[{key:"build",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"build",this).call(this);this.handleControlChanges()}},{key:"getMenuItems",value:function e(){var t="main-buttons-submenu-separator main-buttons-submenu-item main-buttons-hidden-label";return[{html:"<span>"+a.Loc.getMessage("WEBF_RES_SELECT_DEFAULT_TITLE")+"</span>",className:t},{id:"users-state-list",text:a.Loc.getMessage("WEBF_RES_SELECT_DEFAULT_EMPTY"),dataset:{type:"radio",value:"none",inputName:this.inputName,checked:this.defaultMode==="none"},onclick:this.menuItemClick.bind(this)},{id:"users-state-auto",text:a.Loc.getMessage("WEBF_RES_SELECT_DEFAULT_FREE_USER"),dataset:{type:"radio",value:"auto",inputName:this.inputName,checked:this.defaultMode==="auto"},onclick:this.menuItemClick.bind(this)}]}},{key:"menuItemClick",value:function e(t,s){var i=t.target||t.srcElement;if(a.Type.isDomNode(i)&&i.nodeName.toLowerCase()==="input"&&s.dataset&&s.dataset.inputName===this.inputName){this.defaultMode=s.dataset.value}this.handleControlChanges();setTimeout(this.closePopup.bind(this),50)}},{key:"getCurrentModeState",value:function e(){return this.isDisplayed()?a.Loc.getMessage("WEBF_RES_SELECT_USER_FROM_LIST_SHORT")+(this.defaultMode==="none"?"":",<br>"+a.Loc.getMessage("WEBF_RES_AUTO_SELECT_USER_SHORT")):a.Loc.getMessage("WEBF_RES_SELECT_USER_FROM_LIST_AUTO")}},{key:"handleControlChanges",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleControlChanges",this).call(this);this.DOM.currentStateLink.innerHTML=this.getCurrentModeState();BX.onCustomEvent(this,"ResourceBooking.userSettingsField:onControlChanged",[])}},{key:"getDefaultMode",value:function e(){return this.defaultMode}}]);return t}(l);var f=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.label=a.Loc.getMessage("WEBF_RES_RESOURCES");e.formLabel=a.Loc.getMessage("WEBF_RES_RESOURCES_LABEL");e.displayed=true;return e}babelHelpers.createClass(t,[{key:"updateConfig",value:function e(s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"updateConfig",this).call(this,s);this.defaultMode=s.defaultMode;this.multiple=s.multiple==="Y"}},{key:"buildStatePopup",value:function e(t){t.isDisplayed=this.isDisplayed.bind(this);t.defaultMode=t.defaultMode||this.defaultMode;t.multiple=t.multiple==null?this.multiple:t.multiple;this.statePopup=new b(t)}},{key:"buildValuePopup",value:function e(t){this.valuePopup=new g(t)}},{key:"displayInForm",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"displayInForm",this).call(this);this.statePopup.handleControlChanges();this.statePopup.setEnabled()}},{key:"hideInForm",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"hideInForm",this).call(this);this.statePopup.handleControlChanges();this.statePopup.setDisabled()}},{key:"getValue",value:function e(){return{show:this.isDisplayed()?"Y":"N",label:this.getFormLabel(),defaultMode:this.statePopup.getDefaultMode(),multiple:this.statePopup.getMultiple()?"Y":"N",value:this.valuePopup.getSelectedId()}}}]);return t}(r);var b=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.name="resourcesStatePopup";s.inputName="resource-select-mode";s.defaultMode=e.defaultMode==="none"?"none":"auto";s.multiple=!!e.multiple;s.isDisplayed=a.Type.isFunction(e.isDisplayed)?e.isDisplayed:function(){return false};s.build();return s}babelHelpers.createClass(t,[{key:"build",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"build",this).call(this);this.handleControlChanges()}},{key:"getMenuItems",value:function e(){var t="main-buttons-submenu-separator main-buttons-submenu-item main-buttons-hidden-label";return[{html:"<span>"+a.Loc.getMessage("WEBF_RES_SELECT_DEFAULT_TITLE")+"</span>",className:t},{id:"resources-state-list",text:a.Loc.getMessage("WEBF_RES_SELECT_DEFAULT_EMPTY"),dataset:{type:"radio",value:"none",inputName:this.inputName,checked:this.defaultMode==="none"},onclick:this.menuItemClick.bind(this)},{id:"resources-state-auto",text:a.Loc.getMessage("WEBF_RES_AUTO_SELECT_RES"),dataset:{type:"radio",value:"auto",inputName:this.inputName,checked:this.defaultMode==="auto"},onclick:this.menuItemClick.bind(this)},{delimiter:true},{id:"resources-state-multiple",text:a.Loc.getMessage("WEBF_RES_MULTIPLE"),dataset:{type:"checkbox",value:"Y",checked:this.multiple},onclick:this.menuItemClick.bind(this)}]}},{key:"getCurrentModeState",value:function e(){return this.isDisplayed()?a.Loc.getMessage("WEBF_RES_SELECT_RES_FROM_LIST_SHORT")+(this.defaultMode==="none"?"":",<br>"+a.Loc.getMessage("WEBF_RES_AUTO_SELECT_RES_SHORT")):a.Loc.getMessage("WEBF_RES_SELECT_RES_FROM_LIST_AUTO")}},{key:"handleControlChanges",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleControlChanges",this).call(this);this.DOM.currentStateLink.innerHTML=this.getCurrentModeState();BX.onCustomEvent(this,"ResourceBooking.userSettingsField:onControlChanged",[])}},{key:"menuItemClick",value:function e(t,s){var i=t.target||t.srcElement;if(a.Type.isDomNode(i)&&i.nodeName.toLowerCase()==="input"&&s.dataset){if(s.dataset.inputName===this.inputName){this.defaultMode=s.dataset.value}else if(s.id==="resources-state-multiple"){this.multiple=!!i.checked}}this.handleControlChanges()}},{key:"getDefaultMode",value:function e(){return this.defaultMode}},{key:"getMultiple",value:function e(){return this.multiple}}]);return t}(l);var g=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.name="resourcesValuePopup";s.selectAllMessage=a.Loc.getMessage("USER_TYPE_RESOURCE_SELECT_ALL");var i,o={},n=e.config.selected===null;if(a.Type.isArray(e.config.selected)){i=e.config.selected}else if(a.Type.isString(e.config.selected)){i=e.config.selected.split("|")}if(a.Type.isArray(i)){for(var r=0;r<i.length;r++){o[i[r]]=true}}s.values=[];s.selectedValues=[];if(a.Type.isArray(e.config.resources)){e.config.resources.forEach(function(e){var t=this.prepareValueId(e);this.values.push({id:t,title:e.title,dataset:e});if(n||o[e.id]){this.selectedValues.push(t)}},babelHelpers.assertThisInitialized(s))}s.build();return s}babelHelpers.createClass(t,[{key:"handleControlChanges",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleControlChanges",this).call(this);a.Dom.adjust(this.DOM.valueLink,{text:this.getCurrentValueState()})}},{key:"getCurrentValueState",value:function e(){var t=this.selectedValues.length;return t?t+" "+W.getPluralMessage("WEBF_RES_RESOURCE",t):a.Loc.getMessage("WEBF_RES_NO_VALUE")}},{key:"prepareValueId",value:function e(t){return t.type+"|"+t.id}},{key:"getSelectedId",value:function e(){var t=[];this.getSelectedValues().forEach(function(e){var s=e.split("|");if(s&&s[1]){t.push(parseInt(s[1]))}});return t}}]);return t}(u);var k=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.label=a.Loc.getMessage("WEBF_RES_SERVICES");e.formLabel=a.Loc.getMessage("WEBF_RES_SERVICE_LABEL");e.displayed=true;return e}babelHelpers.createClass(t,[{key:"buildStatePopup",value:function e(t){if(t&&a.Type.isDomNode(t.wrap)){t.wrap.appendChild(a.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-select disabled"},html:'<span class="calendar-resbook-webform-settings-popup-select-value">'+a.Loc.getMessage("WEBF_RES_FROM_LIST")+"</span>"}))}}},{key:"buildValuePopup",value:function e(t){this.valuePopup=new E(t)}},{key:"getValue",value:function e(){return{show:this.isDisplayed()?"Y":"N",label:this.getFormLabel(),value:this.valuePopup.getSelectedValues()}}}]);return t}(r);var E=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.name="ServiceValuePopup";s.selectAllMessage=a.Loc.getMessage("WEBF_RES_SELECT_ALL_SERVICES");var i=e.config.selected===null||e.config.selected===""||e.config.selected===undefined;s.values=[];s.selectedValues=[];var o,r={};if(a.Type.isArray(e.config.selected)){o=e.config.selected}else if(a.Type.isString(e.config.selected)){o=e.config.selected.split("|")}if(a.Type.isArray(o)){for(var l=0;l<o.length;l++){r[n.BookingUtil.translit(o[l])]=true}}if(a.Type.isArray(e.config.services)){e.config.services.forEach(function(e){e.id=n.BookingUtil.translit(e.name);if(e.id!==""){this.values.push({id:e.id,title:e.name+" - "+n.BookingUtil.getDurationLabel(e.duration),dataset:e});if(i||r[n.BookingUtil.translit(e.name)]){this.selectedValues.push(e.id)}}},babelHelpers.assertThisInitialized(s))}s.config={};s.build();return s}babelHelpers.createClass(t,[{key:"handleControlChanges",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleControlChanges",this).call(this);a.Dom.adjust(this.DOM.valueLink,{text:this.getCurrentValueState()})}},{key:"getSelectedValues",value:function e(){return this.selectedValues.length?this.selectedValues:"#EMPTY-SERVICE-LIST#"}},{key:"getCurrentValueState",value:function e(){var t=this.selectedValues.length;return t?t+" "+W.getPluralMessage("WEBF_RES_SERVICE",t):a.Loc.getMessage("WEBF_RES_NO_VALUE")}}]);return t}(u);var C=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.label=a.Loc.getMessage("WEBF_RES_DURATION");e.formLabel=a.Loc.getMessage("WEBF_RES_DURATION_LABEL");return e}babelHelpers.createClass(t,[{key:"updateConfig",value:function e(s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"updateConfig",this).call(this);this.defaultValue=s.defaultValue;this.manualInput=s.manualInput==="Y"}},{key:"buildStatePopup",value:function e(t){t.isDisplayed=this.isDisplayed.bind(this);t.defaultValue=this.defaultValue;t.manualInput=this.manualInput;this.statePopup=new S(t)}},{key:"displayInForm",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"displayInForm",this).call(this);this.statePopup.handleControlChanges()}},{key:"hideInForm",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"hideInForm",this).call(this);this.statePopup.handleControlChanges()}},{key:"getValue",value:function e(){return{show:this.isDisplayed()?"Y":"N",label:this.getFormLabel(),defaultValue:this.statePopup.getDefaultValue(),manualInput:this.statePopup.getManualInput()?"Y":"N"}}}]);return t}(r);var S=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.name="durationStatePopup";s.inputName="duration-select-mode";s.manualInput=!!e.manualInput;s.defaultValue=e.defaultValue||60;s.isDisplayed=a.Type.isFunction(e.isDisplayed)?e.isDisplayed:function(){return false};s.durationList=n.BookingUtil.getDurationList(e.fullDay);s.build();return s}babelHelpers.createClass(t,[{key:"build",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"build",this).call(this);this.handleControlChanges()}},{key:"getMenuItems",value:function e(){return[{id:"duration-default-value",text:a.Loc.getMessage("WEBF_RES_SELECT_DURATION_AUTO"),dataset:{type:"submenu-list",value:this.defaultValue,textValue:this.getDurationLabelByValue(this.defaultValue)},items:this.getDefaultMenuItems()}].concat(this.isDisplayed()?[{delimiter:true},{id:"duration-manual-input",text:a.Loc.getMessage("WEBF_RES_SELECT_MANUAL_INPUT"),dataset:{type:"checkbox",value:"Y",checked:this.manualInput},onclick:this.menuItemClick.bind(this)}]:[])}},{key:"getDefaultMenuItems",value:function e(){var t=[];if(a.Type.isArray(this.durationList)){this.durationList.forEach(function(e){t.push({id:"duration-"+e.value,dataset:{type:"duration",value:e.value},text:e.label,onclick:this.menuItemClick.bind(this)})},this)}return t}},{key:"getDurationLabelByValue",value:function e(t){var s=this.durationList.find(function(e){return parseInt(e.value)===parseInt(t)});return s?s.label:null}},{key:"getCurrentModeState",value:function e(){return this.isDisplayed()?a.Loc.getMessage("WEBF_RES_SELECT_DURATION_FROM_LIST_SHORT")+(",<br>"+a.Loc.getMessage("WEBF_RES_SELECT_DURATION_BY_DEFAULT")+" "+this.getDurationLabelByValue(this.defaultValue)):a.Loc.getMessage("WEBF_RES_SELECT_DURATION_AUTO")+" "+this.getDurationLabelByValue(this.defaultValue)}},{key:"handleControlChanges",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleControlChanges",this).call(this);this.DOM.currentStateLink.innerHTML=this.getCurrentModeState();BX.onCustomEvent(this,"ResourceBooking.userSettingsField:onControlChanged",[])}},{key:"menuItemClick",value:function e(t,s){var i=t.target||t.srcElement;if(a.Type.isDomNode(i)&&i.nodeName.toLowerCase()==="input"&&s.dataset){if(s.id==="duration-manual-input"){this.manualInput=!!i.checked}}else if(s.dataset&&s.dataset.type==="duration"){this.defaultValue=parseInt(s.dataset.value)}this.handleControlChanges()}},{key:"getManualInput",value:function e(){return this.manualInput}},{key:"getDefaultValue",value:function e(){return this.defaultValue}}]);return t}(l);var v=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.label=a.Loc.getMessage("WEBF_RES_DATE");e.formLabel=a.Loc.getMessage("WEBF_RES_DATE_LABEL");e.displayed=true;e.displayCheckboxDisabled=true;return e}babelHelpers.createClass(t,[{key:"updateConfig",value:function e(s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"updateConfig",this).call(this);this.style=s.style;this.start=s.start}},{key:"buildStatePopup",value:function e(t){t.style=t.style||this.style;t.start=t.start||this.start;this.statePopup=new y(t)}},{key:"getValue",value:function e(){return{label:this.getFormLabel(),style:this.statePopup.getStyle(),start:this.statePopup.getStart()}}}]);return t}(r);var y=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.name="dateStatePopup";s.styleInputName="date-select-style";s.startInputName="date-select-start";s.style=e.style==="popup"?"popup":"line";s.start=e.start==="today"?"today":"free";s.build();return s}babelHelpers.createClass(t,[{key:"getMenuItems",value:function e(){var t="main-buttons-submenu-separator main-buttons-submenu-item main-buttons-hidden-label";return[{html:"<span>"+a.Loc.getMessage("WEBF_RES_CALENDAR_STYLE")+"</span>",className:t},{id:"date-state-style-popup",text:a.Loc.getMessage("WEBF_RES_CALENDAR_STYLE_POPUP"),dataset:{type:"radio",value:"popup",inputName:this.styleInputName,checked:this.style==="popup"},onclick:this.menuItemClick.bind(this)},{id:"date-state-style-line",text:a.Loc.getMessage("WEBF_RES_CALENDAR_STYLE_LINE"),dataset:{type:"radio",value:"line",inputName:this.styleInputName,checked:this.style==="line"},onclick:this.menuItemClick.bind(this)},{html:"<span>"+a.Loc.getMessage("WEBF_RES_CALENDAR_START_FROM")+"</span>",className:t},{id:"date-state-start-from-today",text:a.Loc.getMessage("WEBF_RES_CALENDAR_START_FROM_TODAY"),dataset:{type:"radio",value:"today",inputName:this.startInputName,checked:this.start==="today"},onclick:this.menuItemClick.bind(this)},{id:"date-state-start-from-free",text:a.Loc.getMessage("WEBF_RES_CALENDAR_START_FROM_FREE"),dataset:{type:"radio",value:"free",inputName:this.startInputName,checked:this.start==="free"},onclick:this.menuItemClick.bind(this)}]}},{key:"getCurrentModeState",value:function e(){return(this.style==="popup"?a.Loc.getMessage("WEBF_RES_CALENDAR_STYLE_POPUP"):a.Loc.getMessage("WEBF_RES_CALENDAR_STYLE_LINE"))+", "+(this.start==="today"?a.Loc.getMessage("WEBF_RES_CALENDAR_START_FROM_TODAY_SHORT"):a.Loc.getMessage("WEBF_RES_CALENDAR_START_FROM_FREE_SHORT"))}},{key:"handleControlChanges",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleControlChanges",this).call(this);a.Dom.adjust(this.DOM.currentStateLink,{text:this.getCurrentModeState()})}},{key:"menuItemClick",value:function e(t,s){var i=t.target||t.srcElement;if(a.Type.isDomNode(i)&&i.nodeName.toLowerCase()==="input"&&s.dataset){if(s.dataset.inputName===this.styleInputName){this.style=s.dataset.value}else if(s.dataset.inputName===this.startInputName){this.start=s.dataset.value}}this.handleControlChanges()}},{key:"getStyle",value:function e(){return this.style}},{key:"getStart",value:function e(){return this.start}}]);return t}(l);var D=function(e){babelHelpers.inherits(t,e);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e.label=a.Loc.getMessage("WEBF_RES_TIME");e.formLabel=a.Loc.getMessage("WEBF_RES_TIME_LABEL");e.displayed=true;e.displayCheckboxDisabled=true;return e}babelHelpers.createClass(t,[{key:"updateConfig",value:function e(s){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"updateConfig",this).call(this);this.style=s.style;this.showOnlyFree=s.showOnlyFree==="Y";this.showFinishTime=s.showFinishTime==="Y";this.scale=parseInt(s.scale)}},{key:"buildStatePopup",value:function e(t){t.style=t.style||this.style;t.showOnlyFree=this.showOnlyFree;t.showFinishTime=this.showFinishTime;t.scale=this.scale;this.statePopup=new O(t)}},{key:"getValue",value:function e(){return{label:this.getFormLabel(),style:this.statePopup.getStyle(),showFinishTime:this.statePopup.getShowFinishTime(),showOnlyFree:this.statePopup.getShowOnlyFree(),scale:this.statePopup.getScale()}}}]);return t}(r);var O=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e));s.name="timeStatePopup";s.styleInputName="date-select-style";s.showOnlyFree=e.showOnlyFree;s.showFinishTime=e.showFinishTime;s.scale=e.scale;s.stateShowFreeId="time-state-show-free";s.stateShowFinishId="time-state-show-finish";s.style=e.style==="select"?"select":"slots";s.build();return s}babelHelpers.createClass(t,[{key:"build",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"build",this).call(this);this.handleControlChanges()}},{key:"getMenuItems",value:function e(){var t="main-buttons-submenu-separator main-buttons-submenu-item main-buttons-hidden-label";return[{html:"<span>"+a.Loc.getMessage("WEBF_RES_TIME_STYLE")+"</span>",className:t},{id:"time-state-style-select",text:a.Loc.getMessage("WEBF_RES_TIME_STYLE_SELECT"),dataset:{type:"radio",value:"select",inputName:this.styleInputName,checked:this.style==="select"},onclick:this.menuItemClick.bind(this)},{id:"time-state-style-slots",text:a.Loc.getMessage("WEBF_RES_TIME_STYLE_SLOT"),dataset:{type:"radio",value:"slots",inputName:this.styleInputName,checked:this.style==="slots"},onclick:this.menuItemClick.bind(this)},{delimiter:true},{id:"time-state-scale",text:a.Loc.getMessage("WEBF_RES_TIME_BOOKING_SIZE"),dataset:{type:"submenu-list",value:this.scale,textValue:this.getDurationLabelByValue(this.scale)},items:this.getDurationMenuItems()},{delimiter:true},{id:this.stateShowFreeId,text:a.Loc.getMessage("WEBF_RES_TIME_SHOW_FREE_ONLY"),dataset:{type:"checkbox",value:"Y",checked:this.showOnlyFree},onclick:this.menuItemClick.bind(this)},{id:this.stateShowFinishId,text:a.Loc.getMessage("WEBF_RES_TIME_SHOW_FINISH_TIME"),dataset:{type:"checkbox",value:"Y",checked:this.showFinishTime},onclick:this.menuItemClick.bind(this)}]}},{key:"getCurrentModeState",value:function e(){return(this.style==="select"?a.Loc.getMessage("WEBF_RES_TIME_STYLE_SELECT"):a.Loc.getMessage("WEBF_RES_TIME_STYLE_SLOT"))+",<br>"+a.Loc.getMessage("WEBF_RES_TIME_BOOKING_SIZE")+": "+this.getDurationLabelByValue(this.scale)}},{key:"handleControlChanges",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"handleControlChanges",this).call(this);this.DOM.currentStateLink.innerHTML=this.getCurrentModeState()}},{key:"menuItemClick",value:function e(t,s){var i=t.target||t.srcElement;if(a.Type.isDomNode(i)&&i.nodeName.toLowerCase()==="input"&&s.dataset){if(s.dataset.inputName===this.styleInputName){this.style=s.dataset.value}else if(s.id===this.stateShowFreeId){this.showOnlyFree=!!i.checked}else if(s.id===this.stateShowFinishId){this.showFinishTime=!!i.checked}}else if(s.dataset&&s.dataset.type==="scale"){this.scale=parseInt(s.dataset.value)}this.handleControlChanges()}},{key:"getDurationMenuItems",value:function e(){var t=this.getDurationList(),s=[];t.forEach(function(e){s.push({id:"duration-"+e.value,dataset:{type:"scale",value:e.value},text:e.label,onclick:this.menuItemClick.bind(this)})},this);return s}},{key:"getDurationList",value:function e(){if(!this.durationList){this.durationList=n.BookingUtil.getDurationList(false);this.durationList=this.durationList.filter(function(e){return e.value&&e.value>=15&&e.value<=240})}return this.durationList}},{key:"getDurationLabelByValue",value:function e(t){var s=this.getDurationList().find(function(e){return e.value===t});return s?s.label:null}},{key:"getStyle",value:function e(){return this.style}},{key:"getScale",value:function e(){return this.scale}},{key:"getShowOnlyFree",value:function e(){return this.showOnlyFree?"Y":"N"}},{key:"getShowFinishTime",value:function e(){return this.showFinishTime?"Y":"N"}}]);return t}(l);var L=function(e){babelHelpers.inherits(t,e);function t(e){var s;babelHelpers.classCallCheck(this,t);s=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));s.setEventNamespace("BX.Calendar.ResourcebookingUserfield.AdjustFieldController");s.params=e;s.complexFields={};s.userFieldParams=null;s.id="resbook-settings-popup-"+Math.round(Math.random()*1e5);s.settingsData=t.getSettingsData(s.params.settings.data);s.params.settings.data=s.settingsData;s.DOM={innerWrap:s.params.innerWrap,settingsWrap:s.params.innerWrap.appendChild(n.Dom.create("div",{attrs:{"data-bx-resource-field-settings":"Y"}})),captionNode:s.params.captionNode,settingsInputs:{}};return s}babelHelpers.createClass(t,[{key:"init",value:function e(){var t=this;this.showFieldLoader();W.getUserFieldParams({fieldName:this.params.entityName,selectedUsers:this.getSelectedUsers()}).then(function(e){t.hideFieldLoader();t.userFieldParams=e;t.fieldLayout=new n.FieldViewControllerEdit({wrap:t.DOM.innerWrap,displayTitle:false,title:t.getCaption(),settings:t.getSettings()});t.fieldLayout.build();t.updateSettingsDataInputs();t.emit("afterInit",new n.BaseEvent({data:{fieldName:t.params.entityName,settings:t.getSettings()}}))})}},{key:"showSettingsPopup",value:function e(){W.getUserFieldParams({fieldName:this.params.entityName,selectedUsers:this.getSelectedUsers()}).then(function(e){this.userFieldParams=e;this.settingsPopupId="calendar-resourcebooking-settings-popup-"+Math.round(Math.random()*1e5);this.settingsPopup=new BX.PopupWindow(this.settingsPopupId,null,{content:this.getSettingsContentNode(),className:"calendar-resbook-webform-settings-popup-window",autoHide:false,lightShadow:true,closeByEsc:true,overlay:{backgroundColor:"black",opacity:500},zIndex:-400,titleBar:n.Loc.getMessage("WEBF_RES_SETTINGS"),closeIcon:true,buttons:[new BX.PopupWindowButton({})]});var t=this.settingsPopup.buttons[0].buttonNode.parentNode;n.Dom.remove(this.settingsPopup.buttons[0].buttonNode);this.settingsPopup.buttons[0].buttonNode=t.appendChild(n.Dom.create("button",{props:{className:"ui-btn ui-btn-success"},events:{click:function(){this.settingsPopup.close()}.bind(this)},text:n.Loc.getMessage("WEBF_RES_CLOSE_SETTINGS_POPUP")}));BX.removeClass(this.settingsPopup.buttons[0].buttonNode,"popup-window-button");this.settingsPopup.show();BX.addCustomEvent(this.settingsPopup,"onPopupClose",function(e){this.destroyControls();this.settingsPopup.destroy(this.id);this.settingsPopup=null;if(this.previewFieldLayout){this.previewFieldLayout.destroy()}}.bind(this))}.bind(this))}},{key:"getSettingsContentNode",value:function e(){var t=n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup"}});var s=t.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-inner"}}));this.buildSettingsForm({wrap:s});var i=t.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-preview"}}));this.previewFieldLayout=new n.FieldViewControllerPreview({wrap:i,title:this.getCaption(),settings:this.getSettings()});this.previewFieldLayout.build();BX.addCustomEvent("ResourceBooking.webformSettings:onChanged",this.handleWebformSettingsChanges.bind(this));return t}},{key:"buildSettingsForm",value:function e(t){var s=this.getSettings(),i=t.wrap,a="title-"+this.id;this.DOM.captionWrap=i.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-title"},html:'<label for="'+a+'" class="calendar-resbook-webform-settings-popup-label">'+n.Loc.getMessage("WEBF_RES_NAME_LABEL")+"</label>"}));this.DOM.captionInput=this.DOM.captionWrap.appendChild(n.Dom.create("input",{attrs:{id:a,className:"calendar-resbook-webform-settings-popup-input",type:"text",value:this.getCaption()},events:{change:this.updateCaption.bind(this),blur:this.updateCaption.bind(this),keyup:this.updateCaption.bind(this)}}));this.updateCaption();this.DOM.fieldsOuterWrap=i.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-content"},html:'<div class="calendar-resbook-webform-settings-popup-head">'+'<div class="calendar-resbook-webform-settings-popup-head-inner">'+'<span class="calendar-resbook-webform-settings-popup-head-text">'+n.Loc.getMessage("WEBF_RES_FIELD_NAME")+"</span>"+'<span class="calendar-resbook-webform-settings-popup-head-decs">'+n.Loc.getMessage("WEBF_RES_FIELD_NAME_IN_FORM")+"</span>"+"</div>"+'<div class="calendar-resbook-webform-settings-popup-head-inner">'+'<span class="calendar-resbook-webform-settings-popup-head-text">'+n.Loc.getMessage("WEBF_RES_FIELD_SHOW_IN_FORM")+"</span>"+"</div>"+"</div>"}));this.DOM.fieldsWrap=this.DOM.fieldsOuterWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-list"}}));if(s.userfieldSettings.useUsers){this.buildComplexField("users",{wrap:this.DOM.fieldsWrap,changeSettingsCallback:this.updateSettings.bind(this),params:s.data.users,config:{users:s.userfieldSettings.users,selected:s.data.users.value}});BX.addCustomEvent("ResourceBooking.settingsUserSelector:onChanged",this.checkBitrix24Limitation.bind(this))}if(s.userfieldSettings.useResources){this.buildComplexField("resources",{wrap:this.DOM.fieldsWrap,changeSettingsCallback:this.updateSettings.bind(this),params:s.data.resources,config:{resources:s.userfieldSettings.resources,selected:s.data.resources.value}})}if(s.userfieldSettings.useServices){this.buildComplexField("services",{wrap:this.DOM.fieldsWrap,changeSettingsCallback:this.updateSettings.bind(this),params:s.data.services,config:{services:s.userfieldSettings.services,selected:s.data.services.value}})}else{this.buildComplexField("duration",{wrap:this.DOM.fieldsWrap,changeSettingsCallback:this.updateSettings.bind(this),params:s.data.duration})}this.buildComplexField("date",{wrap:this.DOM.fieldsWrap,changeSettingsCallback:this.updateSettings.bind(this),params:s.data.date});if(!s.userfieldSettings.fullDay){this.buildComplexField("time",{wrap:this.DOM.fieldsWrap,changeSettingsCallback:this.updateSettings.bind(this),params:s.data.time})}this.DOM.fieldsWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-webform-settings-popup-item"},html:'<div class="calendar-resbook-webform-settings-popup-decs">'+n.Loc.getMessage("WEBF_RES_BOOKING_SETTINGS_HELP").replace("#START_LINK#",'<a href="javascript:void(0);"'+" onclick=\"if (top.BX.Helper){top.BX.Helper.show('redirect=detail&code=8366733');}\">").replace("#END_LINK#","</a>")+"</div>"}))}},{key:"destroyControls",value:function e(){for(var t in this.complexFields){if(this.complexFields.hasOwnProperty(t)&&n.Type.isFunction(this.complexFields[t].destroy)){this.complexFields[t].destroy()}}}},{key:"handleWebformSettingsChanges",value:function e(){if(this.refreshLayoutTimeout){this.refreshLayoutTimeout=clearTimeout(this.refreshLayoutTimeout)}this.refreshLayoutTimeout=setTimeout(function(){for(var e in this.complexFields){if(this.complexFields.hasOwnProperty(e)&&n.Type.isFunction(this.complexFields[e].getValue)){this.settingsData[e]=this.complexFields[e].getValue()}}this.updateSettingsDataInputs();this.previewFieldLayout.refreshLayout(this.settingsData);this.fieldLayout.refreshLayout(this.settingsData);this.previewFieldLayout.getOuterWrap().style.maxHeight=Math.round(this.previewFieldLayout.getInnerWrap().offsetHeight*.73)+"px"}.bind(this),100)}},{key:"buildComplexField",value:function e(t,s){switch(t){case"users":this.complexFields[t]=new d;break;case"resources":this.complexFields[t]=new f;break;case"services":this.complexFields[t]=new k;break;case"duration":this.complexFields[t]=new C;break;case"date":this.complexFields[t]=new v;break;case"time":this.complexFields[t]=new D;break}if(n.Type.isObject(this.complexFields[t])){this.complexFields[t].build(s)}}},{key:"getSelectedUsers",value:function e(){return this.settingsData&&this.settingsData.users&&n.Type.isString(this.settingsData.users.value)?this.settingsData.users.value.split("|"):[]}},{key:"updateSettingsDataInputs",value:function e(){var t,s;for(t in this.settingsData){if(this.settingsData.hasOwnProperty(t)){if(n.Type.isPlainObject(this.settingsData[t])){for(s in this.settingsData[t]){if(this.settingsData[t].hasOwnProperty(s)){this.updateSettingsInputValue([t,s],this.settingsData[t][s])}}}else{this.updateSettingsInputValue([t],this.settingsData[t])}}}}},{key:"updateSettingsInputValue",value:function e(t,s){var i=t.join("-");if(!this.DOM.settingsInputs[i]){this.DOM.settingsInputs[i]=this.DOM.settingsWrap.appendChild(n.Dom.create("input",{attrs:{type:"hidden",name:this.params.formName+"[SETTINGS_DATA]["+t.join("][")+"]"}}))}if(n.Type.isArray(s)){s=s.join("|")}this.DOM.settingsInputs[i].value=s}},{key:"showFieldLoader",value:function e(){if(this.DOM.innerWrap){this.hideFieldLoader();this.DOM.fieldLoader=this.DOM.innerWrap.appendChild(n.BookingUtil.getLoader(100))}}},{key:"hideFieldLoader",value:function e(){n.Dom.remove(this.DOM.fieldLoader)}},{key:"getSettings",value:function e(){if(!this.params.settings.userfieldSettings){this.params.settings.userfieldSettings={resources:this.userFieldParams.SETTINGS.SELECTED_RESOURCES,users:this.userFieldParams.SETTINGS.SELECTED_USERS,services:this.userFieldParams.SETTINGS.SERVICE_LIST,fullDay:this.userFieldParams.SETTINGS.FULL_DAY==="Y",useResources:this.userFieldParams.SETTINGS.USE_RESOURCES==="Y"&&this.userFieldParams.SETTINGS.SELECTED_RESOURCES.length,useUsers:this.userFieldParams.SETTINGS.USE_USERS==="Y",useServices:this.userFieldParams.SETTINGS.USE_SERVICES==="Y",resourceLimit:this.userFieldParams.SETTINGS.RESOURCE_LIMIT,userIndex:this.userFieldParams.SETTINGS.USER_INDEX}}return this.params.settings}},{key:"updateSettings",value:function e(t){}},{key:"getCaption",value:function e(){return this.params.settings.caption}},{key:"updateCaption",value:function e(){var t=this.DOM.captionInput.value;if(this.params.settings.caption!==t||!this.DOM.settingsInputs.caption){this.params.settings.caption=t;if(this.previewFieldLayout){this.previewFieldLayout.updateTitle(this.params.settings.caption)}if(!this.DOM.settingsInputs.caption){this.DOM.settingsInputs.caption=this.DOM.settingsWrap.appendChild(n.Dom.create("input",{attrs:{type:"hidden",name:this.params.formName+"[CAPTION]"}}))}this.DOM.settingsInputs.caption.value=this.params.settings.caption;if(this.DOM.captionNode){n.Dom.adjust(this.DOM.captionNode,{text:this.params.settings.caption})}}}},{key:"isRequired",value:function e(){return this.params.settings.required==="Y"}},{key:"updateRequiredValue",value:function e(){this.params.settings.required=this.DOM.requiredCheckbox.checked?"Y":"N";if(!this.DOM.settingsInputs.required){this.DOM.settingsInputs.required=this.DOM.settingsWrap.appendChild(n.Dom.create("input",{attrs:{type:"hidden",name:this.params.formName+"[REQUIRED]"}}))}this.DOM.settingsInputs.required.value=this.params.settings.required}},{key:"checkBitrix24Limitation",value:function e(){var t=0,s=this.getSettings();if(n.Type.isArray(this.params.settings.userfieldSettings.resources)){t+=this.params.settings.userfieldSettings.resources.length}if(s.userfieldSettings.useUsers&&this.complexFields.users){var i=this.complexFields.users.getValue();if(i&&n.Type.isArray(i.value)){t+=i.value.length}}if(s.userfieldSettings.resourceLimit>0&&t>s.userfieldSettings.resourceLimit){n.BookingUtil.showLimitationPopup()}}}],[{key:"getSettingsData",value:function e(s){var i,a,o=BX.clone(t.getDefaultSettingsData(),true);if(n.Type.isPlainObject(s)){for(i in s){if(s.hasOwnProperty(i)&&o[i]){if(n.Type.isPlainObject(s[i])){for(a in s[i]){if(s[i].hasOwnProperty(a)){o[i][a]=s[i][a]}}}else{o[i]=s[i]}}}}return o}},{key:"getDefaultSettingsData",value:function e(){return{users:{show:"Y",label:n.Loc.getMessage("WEBF_RES_USERS_LABEL"),defaultMode:"auto",value:null},resources:{show:"Y",label:n.Loc.getMessage("WEBF_RES_RESOURCES_LABEL"),defaultMode:"auto",multiple:"N",value:null},services:{show:"Y",label:n.Loc.getMessage("WEBF_RES_SERVICE_LABEL"),value:null},duration:{show:"Y",label:n.Loc.getMessage("WEBF_RES_DURATION_LABEL"),defaultValue:60,manualInput:"N"},date:{label:n.Loc.getMessage("WEBF_RES_DATE_LABEL"),style:"line",start:"today"},time:{label:n.Loc.getMessage("WEBF_RES_TIME_LABEL"),style:"slots",showOnlyFree:"Y",showFinishTime:"N",scale:60}}}}]);return t}(n.EventEmitter);var R=function(){function e(t){babelHelpers.classCallCheck(this,e);this.params=t||{};this.id=this.params.id||"user-selector-"+Math.round(Math.random()*1e5);this.wrapNode=this.params.wrapNode;this.destinationInputName=this.params.inputName||"EVENT_DESTINATION";this.params.selectGroups=false;this.addMessage=this.params.addMessage||BX.message("USER_TYPE_RESOURCE_ADD_USER");this.checkLimit=BX.type.isFunction(t.checkLimitCallback)?t.checkLimitCallback:false;if(BX.type.isArray(this.params.itemsSelected)){this.params.itemsSelected=this.convertAttendeesCodes(this.params.itemsSelected)}else{this.params.itemsSelected=this.getSocnetDestinationConfig("itemsSelected")}this.DOM={outerWrap:this.params.outerWrap,wrapNode:this.params.wrapNode};this.create()}babelHelpers.createClass(e,[{key:"create",value:function e(){if(this.DOM.outerWrap){n.Dom.addClass(this.DOM.outerWrap,"calendar-resourcebook-folding-block"+(this.params.shown!==false?" shown":""))}var t=this.id;BX.bind(this.wrapNode,"click",BX.delegate(function(e){var s=e.target||e.srcElement;if(s.className==="calendar-resourcebook-content-block-control-delete"){BX.SocNetLogDestination.deleteItem(s.getAttribute("data-item-id"),s.getAttribute("data-item-type"),t);var i=BX.findParent(s,{className:"calendar-resourcebook-content-block-control-inner"});if(i&&BX.hasClass(i,"shown")){BX.removeClass(i,"shown");setTimeout(function(){BX.remove(i)},300)}}else{BX.SocNetLogDestination.openDialog(t)}},this));this.socnetDestinationInputWrap=this.wrapNode.appendChild(BX.create("SPAN",{props:{className:"calendar-resourcebook-destination-input-box"}}));this.socnetDestinationInput=this.socnetDestinationInputWrap.appendChild(BX.create("INPUT",{props:{id:t+"-inp",className:"calendar-resourcebook-destination-input"},attrs:{value:"",type:"text"},events:{keydown:function e(s){return BX.SocNetLogDestination.searchBeforeHandler(s,{formName:t,inputId:t+"-inp"})},keyup:function e(s){return BX.SocNetLogDestination.searchHandler(s,{formName:t,inputId:t+"-inp",linkId:"event-grid-dest-add-link",sendAjax:true})}}}));this.socnetDestinationLink=this.wrapNode.appendChild(BX.create("DIV",{props:{className:"calendar-resourcebook-content-block-control-text calendar-resourcebook-content-block-control-text-add"},text:this.addMessage}));this.init()}},{key:"show",value:function e(){if(this.DOM.outerWrap){n.Dom.addClass(this.DOM.outerWrap,"shown")}}},{key:"hide",value:function e(){if(this.DOM.outerWrap){BX.removeClass(this.DOM.outerWrap,"shown")}}},{key:"isShown",value:function e(){if(this.DOM.outerWrap){return BX.hasClass(this.DOM.outerWrap,"shown")}}},{key:"init",value:function e(){if(!this.socnetDestinationInput||!this.wrapNode)return;var t=this;this.params.items=this.getSocnetDestinationConfig("items");this.params.itemsLast=this.getSocnetDestinationConfig("itemsLast");if(this.params.selectGroups===false){this.params.items.groups={};this.params.items.department={};this.params.items.sonetgroups={}}BX.SocNetLogDestination.init({name:this.id,searchInput:this.socnetDestinationInput,extranetUser:false,userSearchArea:"I",bindMainPopup:{node:this.wrapNode,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:this.wrapNode,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.proxy(this.selectCallback,this),unSelect:BX.proxy(this.unSelectCallback,this),openDialog:BX.proxy(this.openDialogCallback,this),closeDialog:BX.proxy(this.closeDialogCallback,this),openSearch:BX.proxy(this.openDialogCallback,this),closeSearch:function e(){t.closeDialogCallback(true)}},items:this.params.items,itemsLast:this.params.itemsLast,itemsSelected:this.params.itemsSelected,departmentSelectDisable:this.params.selectGroups===false})}},{key:"closeAll",value:function e(){if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.SocNetLogDestination.closeSearch()}},{key:"selectCallback",value:function e(t,s){if(s==="users"){this.addUserBlock(t);BX.onCustomEvent("OnResourceBookDestinationAddNewItem",[t,this.id]);this.socnetDestinationInput.value=""}}},{key:"addUserBlock",value:function e(t,s){if(this.checkLimit&&!this.checkLimit()){return n.BookingUtil.showLimitationPopup()}if(this.getAttendeesCodesList().includes(t.id)){return}var i=this.wrapNode.querySelectorAll("calendar-resourcebook-content-block-control-inner[data-id='".concat(t.id,"']"));for(var a=0;a<i.length;a++){BX.remove(i[a])}var o=this.wrapNode.appendChild(BX.create("DIV",{attrs:{"data-id":t.id,className:"calendar-resourcebook-content-block-control-inner green"},html:'<div class="calendar-resourcebook-content-block-control-text">'+t.name+"</div>"+'<div data-item-id="'+t.id+'" data-item-type="users" class="calendar-resourcebook-content-block-control-delete"></div>'+'<input type="hidden" name="'+this.destinationInputName+"[U][]"+'" value="'+t.id+'">'}));if(s!==false){setTimeout(BX.delegate(function(){n.Dom.addClass(o,"shown")},this),1)}else{n.Dom.addClass(o,"shown")}this.wrapNode.appendChild(this.socnetDestinationInputWrap);this.wrapNode.appendChild(this.socnetDestinationLink)}},{key:"unSelectCallback",value:function e(t){var s=BX.findChildren(this.wrapNode,{attribute:{"data-id":t.id}},true);if(s!=null){for(var i=0;i<s.length;i++){BX.remove(s[i])}}BX.onCustomEvent("OnResourceBookDestinationUnselect",[t,this.id]);this.socnetDestinationInput.value="";this.socnetDestinationLink.innerHTML=this.addMessage}},{key:"openDialogCallback",value:function e(){BX.style(this.socnetDestinationInputWrap,"display","inline-block");BX.style(this.socnetDestinationLink,"display","none");BX.focus(this.socnetDestinationInput)}},{key:"closeDialogCallback",value:function e(t){if(!BX.SocNetLogDestination.isOpenSearch()&&this.socnetDestinationInput.value.length<=0){BX.style(this.socnetDestinationInputWrap,"display","none");BX.style(this.socnetDestinationLink,"display","inline-block");if(t===true)this.socnetDestinationInput.value="";if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!=null)BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.bind(window,"keydown",BX.SocNetLogDestination.backspaceDisable=function(e){if(e.keyCode===8){e.preventDefault();return false}});setTimeout(function(){BX.unbind(window,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5e3)}}},{key:"getCodes",value:function e(){var t=this.wrapNode.getElementsByTagName("INPUT"),s=[],i,a;for(i=0;i<t.length;i++){a=BX.util.trim(t[i].value);if(a){s.push(t[i].value)}}return s}},{key:"getAttendeesCodes",value:function e(){var t=this.wrapNode.getElementsByTagName("INPUT"),s=[],i;for(i=0;i<t.length;i++){s.push(t[i].value)}return this.convertAttendeesCodes(s)}},{key:"convertAttendeesCodes",value:function e(t){var s={};if(BX.type.isArray(t)){t.forEach(function(e){if(e.substr(0,2)==="DR"){s[e]="department"}else if(e.substr(0,2)==="UA"){s[e]="groups"}else if(e.substr(0,2)==="SG"){s[e]="sonetgroups"}else if(e.substr(0,1)==="U"){s[e]="users"}})}return s}},{key:"getAttendeesCodesList",value:function e(t){var s=[];if(!t)t=this.getAttendeesCodes();for(var i in t){if(t.hasOwnProperty(i)){s.push(i)}}return s}},{key:"getSocnetDestinationConfig",value:function e(t){var s,i=this.params.socnetDestination||{};if(t==="items"){s={users:i.USERS||{},groups:i.EXTRANET_USER==="Y"||i.DENY_TOALL?{}:{UA:{id:"UA",name:BX.message("USER_TYPE_RESOURCE_TO_ALL_USERS")}},sonetgroups:i.SONETGROUPS||{},department:i.DEPARTMENT||{},departmentRelation:i.DEPARTMENT_RELATION||{}}}else if(t==="itemsLast"&&i.LAST){s={users:i.LAST.USERS||{},groups:i.EXTRANET_USER==="Y"?{}:{UA:true},sonetgroups:i.LAST.SONETGROUPS||{},department:i.LAST.DEPARTMENT||{}}}else if(t==="itemsSelected"){s=i.SELECTED||{}}return s||{}}},{key:"getSelectedValues",value:function e(){var t=[],s,i=this.wrapNode.querySelectorAll("input");for(s=0;s<i.length;s++){if(i[s].type==="hidden"&&i[s].value){if(i[s].value.substr(0,1)==="U"){t.push(parseInt(i[s].value.substr(1)))}}}return t}},{key:"setValues",value:function e(t,s){var i,a;var o=this.wrapNode.querySelectorAll(".calendar-resourcebook-content-block-control-inner");for(i=0;i<o.length;i++){BX.remove(o[i])}for(i=0;i<t.length;i++){if(BX.SocNetLogDestination.obItems[this.id]["users"]){a=BX.SocNetLogDestination.obItems[this.id]["users"]["U"+t[i]];if(a){this.addUserBlock({id:"U"+t[i],name:a.name},false)}}}if(s!==false&&this.onChangeCallback&&BX.type.isFunction(this.onChangeCallback)){setTimeout(BX.proxy(this.onChangeCallback,this),100)}}},{key:"getId",value:function e(){return this.id}}]);return e}();var M=function(){function e(t){babelHelpers.classCallCheck(this,e);this.params=t||{};this.editMode=!!this.params.editMode;this.id=this.params.id||"resource-selector-"+Math.round(Math.random()*1e5);this.resourceList=BX.type.isArray(t.resourceList)?t.resourceList:[];this.checkLimit=BX.type.isFunction(t.checkLimitCallback)?t.checkLimitCallback:false;this.checkLimitForNew=BX.type.isFunction(t.checkLimitCallbackForNew)?t.checkLimitCallbackForNew:false;this.selectedValues=[];this.selectedValuesIndex={};this.selectedBlocks=[];this.newValues=[];this.DOM={outerWrap:this.params.outerWrap,blocksWrap:this.params.blocksWrap||false,listWrap:this.params.listWrap};if(this.editMode){this.DOM.controlsWrap=this.params.controlsWrap}else{this.DOM.arrowNode=BX.create("span",{props:{className:"calendar-resourcebook-content-block-detail-icon calendar-resourcebook-content-block-detail-icon-arrow"}})}this.onChangeCallback=this.params.onChangeCallback||null;this.create();this.setValues(t.values)}babelHelpers.createClass(e,[{key:"create",value:function e(){BX.addClass(this.DOM.outerWrap,"calendar-resourcebook-resource-list-wrap calendar-resourcebook-folding-block"+(this.params.shown!==false?" shown":""));if(this.editMode){this.DOM.addButton=this.DOM.controlsWrap.appendChild(BX.create("span",{props:{className:"calendar-resource-content-block-add-link"},text:BX.message("USER_TYPE_RESOURCE_ADD"),events:{click:BX.delegate(this.addResourceBlock,this)}}));if(this.resourceList.length>0){this.DOM.selectButton=this.DOM.controlsWrap.appendChild(BX.create("span",{props:{className:"calendar-resource-content-block-add-link"},text:BX.message("USER_TYPE_RESOURCE_SELECT"),events:{click:BX.delegate(this.openResourcesPopup,this)}}))}}else{BX.bind(this.DOM.blocksWrap,"click",BX.delegate(this.handleBlockClick,this))}}},{key:"show",value:function e(){BX.addClass(this.DOM.outerWrap,"shown")}},{key:"hide",value:function e(){this.DOM.outerWrap.style.maxHeight="";BX.removeClass(this.DOM.outerWrap,"shown")}},{key:"isShown",value:function e(){return BX.hasClass(this.DOM.outerWrap,"shown")}},{key:"handleBlockClick",value:function e(t){var s=t.target||t.srcElement;if(s){var i=s.getAttribute("data-bx-remove-block");if(i){this.selectedBlocks.find(function(e,t){if(e.value===i){BX.removeClass(e.wrap,"shown");setTimeout(BX.delegate(function(){BX.remove(e.wrap)},this),300);this.selectedBlocks=BX.util.deleteFromArray(this.selectedBlocks,t)}},this);this.selectedValues.find(function(e,t){if(e.title===i){this.selectedValues=BX.util.deleteFromArray(this.selectedValues,t)}},this);if(BX.type.isFunction(this.onChangeCallback)){setTimeout(BX.proxy(this.onChangeCallback,this),100)}this.checkBlockWrapState()}if(!i){this.openResourcesPopup()}}}},{key:"openResourcesPopup",value:function e(){if(!this.resourceList.length){return this.addResourceBlock()}if(this.isResourcesPopupShown()){return}var t=[];this.resourceList.forEach(function(e){if(e.deleted){return}t.push({text:BX.util.htmlspecialchars(e.title),dataset:{type:e.type,id:e.id,title:e.title},onclick:BX.delegate(function(e,t){var s,i=e.target||e.srcElement,a=t.layout.item.querySelector(".menu-popup-item-resource-checkbox"),o=this.resourceList.find(function(e){return parseInt(e.id)===parseInt(t.dataset.id)&&e.type===t.dataset.type},this);if(o){if(i&&BX.hasClass(i,"calendar-resourcebook-content-block-control-delete")){this.removeResourceBlock({resource:o,trigerOnChange:true});this.selectedValues=this.getSelectedValues();this.checkResourceInputs();s=this.popupContainer.querySelector(".menu-popup-item-all-resources-checkbox");this.selectAllChecked=false;if(s){s.checked=false}var r=BX.findParent(i,{className:"menu-popup-item"});if(r){BX.addClass(r,"menu-popup-item-resource-remove-loader");r.appendChild(n.BookingUtil.getLoader(25));var l=r.querySelector(".menu-popup-item-text");if(l){l.innerHTML=BX.message("USER_TYPE_RESOURCE_DELETING")}}o.deleted=true;setTimeout(BX.delegate(function(){if(r){r.style.maxHeight="0"}if(!this.resourceList.find(function(e){return!e.deleted})){BX.PopupMenu.destroy(this.id);this.DOM.selectButton.style.opacity=0;setTimeout(BX.delegate(function(){BX.remove(this.DOM.selectButton)},this),500)}},this),500)}else if(i&&(BX.hasClass(i,"menu-popup-item")||BX.hasClass(i,"menu-popup-item-resource-checkbox")||BX.hasClass(i,"menu-popup-item-inner"))){if(!BX.hasClass(i,"menu-popup-item-resource-checkbox")){a.checked=!a.checked}if(a.checked){this.addResourceBlock({resource:o,value:o.title,trigerOnChange:true});this.selectedValues=this.getSelectedValues()}else{this.removeResourceBlock({resource:o,trigerOnChange:true});this.selectedValues=this.getSelectedValues();this.checkResourceInputs();s=this.popupContainer.querySelector(".menu-popup-item-all-resources-checkbox");this.selectAllChecked=false;if(s){s.checked=false}}}}},this)})},this);if(t.length>1){t.push({text:BX.message("USER_TYPE_RESOURCE_SELECT_ALL"),onclick:BX.delegate(function(e,t){var s=e.target||e.srcElement;if(s&&(BX.hasClass(s,"menu-popup-item")||BX.hasClass(s,"menu-popup-item-resource-checkbox"))){var i=t.layout.item.querySelector(".menu-popup-item-resource-checkbox");if(BX.hasClass(s,"menu-popup-item")){i.checked=!i.checked}var a,o=this.popupContainer.querySelectorAll("input.menu-popup-item-resource-checkbox");this.selectAllChecked=i.checked;for(a=0;a<o.length;a++){o[a].checked=this.selectAllChecked}this.resourceList.forEach(function(e){if(e.deleted){return}if(this.selectAllChecked){this.addResourceBlock({resource:e,value:e.title,trigerOnChange:true})}else{this.removeResourceBlock({resource:e,trigerOnChange:true})}},this);this.selectedValues=this.getSelectedValues();this.checkResourceInputs()}},this)})}this.popup=BX.PopupMenu.create(this.id,this.DOM.selectButton||this.DOM.blocksWrap,t,{className:"popup-window-resource-select",closeByEsc:true,autoHide:false,offsetTop:0,offsetLeft:0});this.popup.show(true);this.popupContainer=this.popup.popupWindow.popupContainer;if(!this.editMode){this.popupContainer.style.width=parseInt(this.DOM.blocksWrap.offsetWidth)+"px"}BX.addCustomEvent(this.popup.popupWindow,"onPopupClose",BX.proxy(function(){BX.PopupMenu.destroy(this.id)},this));this.popup.menuItems.forEach(function(e){var t;if(e.dataset&&e.dataset.type){t=this.selectedValues.find(function(t){return parseInt(t.id)===parseInt(e.dataset.id)&&t.type===e.dataset.type});e.layout.item.className="menu-popup-item";e.layout.item.innerHTML='<div class="menu-popup-item-inner">'+'<div class="menu-popup-item-resource">'+'<input class="menu-popup-item-resource-checkbox" type="checkbox"'+(t?'checked="checked"':"")+' id="'+e.id+'">'+'<label class="menu-popup-item-text" for="'+e.id+'">'+BX.util.htmlspecialchars(e.dataset.title)+"</label>"+"</div>"+(this.editMode?'<div class="calendar-resourcebook-content-block-control-delete"></div>':"")+"</div>"}else{this.selectAllChecked=!this.resourceList.find(function(e){return!this.selectedValues.find(function(t){return parseInt(t.id)===parseInt(e.id)&&t.type===e.type})},this);e.layout.item.className="menu-popup-item menu-popup-item-resource-all";e.layout.item.innerHTML='<div class="menu-popup-item-inner">'+'<div class="menu-popup-item-resource">'+'<input class="menu-popup-item-resource-checkbox menu-popup-item-all-resources-checkbox" type="checkbox"'+(this.selectAllChecked?'checked="checked"':"")+' id="'+e.id+'">'+'<label class="menu-popup-item-text" for="'+e.id+'">'+BX.message("USER_TYPE_RESOURCE_SELECT_ALL")+"</label>"+"</div>"+"</div>"}},this);setTimeout(BX.delegate(function(){BX.bind(document,"click",BX.proxy(this.handleClick,this))},this),50)}},{key:"addResourceBlock",value:function e(t){if(!BX.type.isPlainObject(t)){t={}}if(t.resource&&this.checkLimit&&!this.checkLimit()&&window.B24||!t.resource&&this.checkLimitForNew&&!this.checkLimitForNew()&&window.B24){return n.BookingUtil.showLimitationPopup()}var s=this,i;if(this.editMode){if(t.resource&&this.selectedValues.find(function(e){return e.id&&parseInt(e.id)===parseInt(t.resource.id)&&e.type===t.resource.type})){return}if(!t.value){t.value=""}i={value:t.value,wrap:this.DOM.listWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-detail calendar-resourcebook-outer-resource-wrap"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-detail-resource"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-detail-resource-inner calendar-resourcebook-content-block-detail-resource-inner-wide"}}))};i.input=i.wrap.appendChild(BX.create("input",{props:{className:"calendar-resourcebook-content-input",value:t.value,type:"text",placeholder:BX.message("USER_TYPE_RESOURCE_NAME")},dataset:{resourceType:t.resource?t.resource.type:"",resourceId:t.resource?t.resource.id:""}}));i.delButton=i.wrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-delete"},events:{click:function e(){BX.remove(BX.findParent(this,{className:"calendar-resourcebook-outer-resource-wrap"}));s.selectedValues=s.getSelectedValues();s.checkResourceInputs()}}}));if(t.focusInput!==false){BX.focus(i.input)}}else{if(t.value&&this.selectedBlocks.find(function(e){return e.value&&e.value===t.value})){return}i={value:t.value,resource:t.resource||false,wrap:this.DOM.blocksWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-inner"+(t.animation?"":" shown")+(t.transparent?" transparent":"")},children:[BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-text"},text:t.value||""}),BX.create("div",{attrs:{"data-bx-remove-block":t.value},props:{className:"calendar-resourcebook-content-block-control-delete"}})]}))};this.selectedBlocks.push(i);if(t.animation){setTimeout(BX.delegate(function(){BX.addClass(i.wrap,"shown")},this),1)}if(t.trigerOnChange!==false&&this.onChangeCallback&&BX.type.isFunction(this.onChangeCallback)){setTimeout(BX.proxy(this.onChangeCallback,this),100)}this.checkBlockWrapState()}if(this.DOM.listWrap&&this.DOM.outerWrap){if(BX.hasClass(this.DOM.outerWrap,"shown")){this.DOM.outerWrap.style.maxHeight=Math.max(1e4,this.DOM.listWrap.childNodes.length*45+100)+"px"}else{this.DOM.outerWrap.style.maxHeight=""}}return i}},{key:"removeResourceBlock",value:function e(t){if(this.editMode){var s,i,a,o=this.DOM.listWrap.querySelectorAll(".calendar-resourcebook-content-input");for(a=0;a<o.length;a++){s=o[a].getAttribute("data-resource-type");i=o[a].getAttribute("data-resource-id");if(s===t.resource.type&&parseInt(i)===parseInt(t.resource.id)){BX.remove(BX.findParent(o[a],{className:"calendar-resourcebook-outer-resource-wrap"}))}}}else{if(t.resource){this.selectedBlocks.find(function(e,s){if(e.value===t.resource.title){BX.removeClass(e.wrap,"shown");setTimeout(BX.delegate(function(){BX.remove(e.wrap)},this),300);this.selectedBlocks=BX.util.deleteFromArray(this.selectedBlocks,s)}},this)}this.checkBlockWrapState();if(t.trigerOnChange!==false&&this.onChangeCallback&&BX.type.isFunction(this.onChangeCallback)){setTimeout(BX.proxy(this.onChangeCallback,this),100)}}}},{key:"checkResourceInputs",value:function e(){if(this.editMode){if(!this.selectedValues.length){this.addResourceBlock({animation:true})}}}},{key:"checkBlockWrapState",value:function e(){if(!this.editMode){if(!this.selectedBlocks.length){if(!this.DOM.emptyPlaceholder){this.DOM.emptyPlaceholder=this.DOM.blocksWrap.appendChild(BX.create("DIV",{props:{className:"calendar-resourcebook-content-block-control-empty"},html:'<span class="calendar-resourcebook-content-block-control-text">'+BX.message("USER_TYPE_RESOURCE_LIST_PLACEHOLDER")+"</span>"}))}else{this.DOM.emptyPlaceholder.className="calendar-resourcebook-content-block-control-empty";this.DOM.blocksWrap.appendChild(this.DOM.emptyPlaceholder)}setTimeout(BX.delegate(function(){if(BX.isNodeInDom(this.DOM.emptyPlaceholder)){BX.addClass(this.DOM.emptyPlaceholder,"show")}},this),50)}else if(this.DOM.emptyPlaceholder){BX.remove(this.DOM.emptyPlaceholder)}}}},{key:"handleClick",value:function e(t){var s=t.target||t.srcElement;if(this.isResourcesPopupShown()&&!BX.isParentForNode(this.popupContainer,s)){this.closeResourcesPopup({animation:true})}}},{key:"isResourcesPopupShown",value:function e(){return this.popup&&this.popup.popupWindow&&this.popup.popupWindow.isShown&&this.popup.popupWindow.isShown()&&this.popup.popupWindow.popupContainer&&BX.isNodeInDom(this.popup.popupWindow.popupContainer)}},{key:"closeResourcesPopup",value:function e(t){if(this.popup){this.popup.close();this.popupContainer.style.maxHeight="";BX.unbind(document,"click",BX.proxy(this.handleClick,this))}}},{key:"getValues",value:function e(){return this.resourceList}},{key:"addToSelectedValues",value:function e(t){if(!this.selectedValues.find(function(e){return parseInt(e.id)===parseInt(t.id)&&e.type===t.type})){this.selectedValues.push(t)}}},{key:"getSelectedValues",value:function e(){this.selectedValues=[];if(this.editMode){var t,s,i,a=this.DOM.listWrap.querySelectorAll(".calendar-resourcebook-content-input");for(i=0;i<a.length;i++){t=a[i].getAttribute("data-resource-type");s=a[i].getAttribute("data-resource-id");if(t&&s){this.selectedValues.push({type:t,id:s,title:a[i].value})}else{this.selectedValues.push({type:"resource",title:a[i].value})}}}else{this.selectedBlocks.forEach(function(e){this.selectedValues.push({type:e.resource.type,id:e.resource.id})},this)}return this.selectedValues}},{key:"getDeletedValues",value:function e(){return this.resourceList.filter(function(e){return e.deleted})}},{key:"setValues",value:function e(t,s){this.selectedBlocks.forEach(function(e){BX.remove(e.wrap)});this.selectedBlocks=[];s=s!==false;if(BX.type.isArray(t)){t.forEach(function(e){var t=this.resourceList.find(function(t){return parseInt(t.id)===parseInt(e.id)&&t.type===e.type},this);if(t){this.addResourceBlock({resource:t,value:t.title,trigerOnChange:s});this.addToSelectedValues(t)}},this)}if(this.editMode){this.selectedValues=this.getSelectedValues();this.checkResourceInputs()}else{if(this.DOM.arrowNode){this.DOM.blocksWrap.appendChild(this.DOM.arrowNode)}}this.checkBlockWrapState()}}]);return e}();var _=function(){function e(t){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,[{key:"show",value:function e(t){if(!t){t={}}this.params=t;this.bindNode=t.bindNode;this.plannerId=this.params.plannerId;this.config=this.params.plannerConfig;if(this.isShown()||!this.bindNode){return}if(this.lastPlannerIdShown&&this.lastPlannerIdShown!==this.plannerId){this.close({animation:false})}this.currentEntries=[];this.plannerWrap=n.Dom.create("DIV",{attrs:{id:this.plannerId,className:"calendar-planner-wrapper"}});this.popup=new BX.PopupWindow(this.plannerId+"_popup",this.bindNode,{autoHide:false,closeByEsc:true,offsetTop:-parseInt(this.bindNode.offsetHeight)-20,offsetLeft:this.bindNode.offsetWidth+38,lightShadow:true,content:this.plannerWrap});this.popup.setAngle({offset:100,position:"left"});this.popup.show(true);this.lastPlannerIdShown=this.plannerId;var s=BX.pos(this.bindNode),i=BX.GetWindowSize();this.plannerWidth=i.innerWidth-s.right-160;this.config.width=this.plannerWidth;setTimeout(function(){if(this.popup&&this.popup.popupContainer){n.Dom.addClass(this.popup.popupContainer,"calendar-resbook-planner-popup");this.popup.popupContainer.style.width=0}}.bind(this),1);setTimeout(function(){if(this.popup&&this.popup.popupContainer){this.popup.popupContainer.style.width=this.plannerWidth+40+"px";n.Dom.addClass(this.popup.popupContainer,"show")}n.Event.bind(document,"click",this.handleClick.bind(this))}.bind(this),50);setTimeout(this.showPlanner.bind(this),350);BX.addCustomEvent(this.popup,"onPopupClose",this.close.bind(this))}},{key:"update",value:function e(t,s){if(!this.isShown()){return}var i=[],a,o,r,l={},c=BX.clone(this.config,true),u,p,h,d;if(n.Type.isPlainObject(this.lastUpdateParams)&&n.Type.isPlainObject(t)&&s!==true){for(o in t){if(t.hasOwnProperty(o)){this.lastUpdateParams[o]=t[o]}}t=this.lastUpdateParams}if(n.Type.isPlainObject(t)){this.lastUpdateParams=t}t.focusSelector=t.focusSelector!==false;if(t.from&&t.to){h=n.BookingUtil.parseDate(t.from);d=n.BookingUtil.parseDate(t.to);u=h.getTime();p=d.getTime()}else{if(t.selector.fullDay){u=t.selector.from.getTime()-n.BookingUtil.getDayLength()*12;p=t.selector.from.getTime()+n.BookingUtil.getDayLength()*14}else{u=t.selector.from.getTime()-n.BookingUtil.getDayLength()*3;p=t.selector.from.getTime()+n.BookingUtil.getDayLength()*5}h=new Date(u);d=new Date(p);c.scaleDateFrom=h;c.scaleDateTo=d}if(n.Type.isArray(t.userList)){for(a=0;a<t.userList.length;a++){r="U"+t.userList[a].id;if(!l[r]){i.push(r);l[r]=true}}}if(n.Type.isArray(t.selectedUsers)){for(a=0;a<t.selectedUsers.length;a++){r="U"+t.selectedUsers[a];if(!l[r]){i.push(r);l[r]=true}}}var m={codes:i,resources:t.resourceList,from:n.BookingUtil.formatDate(null,u/1e3),to:n.BookingUtil.formatDate(null,p/1e3),currentEventList:this.params.currentEventList||[]};if(this.checkUpdateParams(m)&&this.isShown()){this.showPlannerLoader();BX.ajax.runAction("calendar.api.resourcebookingajax.getplannerdata",{data:m}).then(function(e){this.hidePlannerLoader();if(this.lastRequestData){this.lastRequestData.response=e}this.currentEntries=e.data.entries;this.currentAccessibility=e.data.accessibility;this.currentLoadedDataFrom=h;this.currentLoadedDataTo=d;if(n.Type.isArray(e.data.entries)){e.data.entries.forEach(function(e){e.selected=e.type==="user"&&t.selectedUsers.find(function(t){return parseInt(e.id)===parseInt(t)})||e.type==="resource"&&t.selectedResources.find(function(t){return e.type===t.type&&parseInt(e.id)===parseInt(t.id)})})}if(this.isShown()){BX.onCustomEvent("OnCalendarPlannerDoUpdate",[{plannerId:this.plannerId,config:c,focusSelector:t.focusSelector,selector:{from:t.selector.from,to:t.selector.to,fullDay:t.selector.fullDay,animation:t.focusSelector,updateScaleLimits:t.focusSelector},data:{entries:e.data.entries,accessibility:e.data.accessibility},loadedDataFrom:h,loadedDataTo:d,show:false}])}}.bind(this))}else if(n.Type.isPlainObject(this.lastRequestData.response)){var f=this.lastRequestData.response;this.currentEntries=f.data.entries;this.currentAccessibility=f.data.accessibility;this.currentLoadedDataFrom=h;this.currentLoadedDataTo=d;if(n.Type.isArray(f.data.entries)){f.data.entries.forEach(function(e){e.selected=e.type==="user"&&t.selectedUsers.find(function(t){return parseInt(e.id)===parseInt(t)})||e.type==="resource"&&t.selectedResources.find(function(t){return e.type===t.type&&parseInt(e.id)===parseInt(t.id)})})}if(this.isShown()){BX.onCustomEvent("OnCalendarPlannerDoUpdate",[{plannerId:this.plannerId,config:c,focusSelector:t.focusSelector,selector:{from:t.selector.from,to:t.selector.to,fullDay:t.selector.fullDay,animation:t.focusSelector,updateScaleLimits:t.focusSelector},data:{entries:f.data.entries,accessibility:f.data.accessibility},loadedDataFrom:h,loadedDataTo:d,show:false}])}}}},{key:"checkUpdateParams",value:function e(t){var s=false;if(!this.lastRequestData||this.lastRequestPlannerId!==this.plannerId){s=true}if(!s&&t.from!==this.lastRequestData.from){s=true}if(!s&&n.Type.isArray(t.codes)&&n.Type.isArray(this.lastRequestData.codes)&&BX.util.array_diff(t.codes,this.lastRequestData.codes).length>0){s=true}if(!s&&n.Type.isArray(t.resources)&&n.Type.isArray(this.lastRequestData.resources)){if(t.resources.length!==this.lastRequestData.resources.length){s=true}else{var i={};t.resources.forEach(function(e){i[e.type+"_"+e.id]=true});this.lastRequestData.resources.forEach(function(e){if(!i[e.type+"_"+e.id]){s=true}})}}if(s){this.lastRequestData=t;this.lastRequestPlannerId=this.plannerId}return s}},{key:"showPlanner",value:function e(){this.planner=new CalendarPlanner(this.params.plannerConfig,{config:this.config,data:{accessibility:this.currentAccessibility||{},entries:this.currentEntries},selector:{from:this.params.selector.from,to:this.params.selector.to,fullDay:this.params.selector.fullDay,updateScaleLimits:true,updateScaleType:false,focus:true,RRULE:false,animation:false},loadedDataFrom:this.currentLoadedDataFrom,loadedDataTo:this.currentLoadedDataTo,focusSelector:true,plannerId:this.plannerId,show:true});if(n.Type.isFunction(this.params.selectorOnChangeCallback)){BX.addCustomEvent("OnCalendarPlannerSelectorChanged",this.params.selectorOnChangeCallback)}if(n.Type.isFunction(this.params.selectEntriesOnChangeCallback)){BX.addCustomEvent("OnCalendarPlannerSelectedEntriesOnChange",this.params.selectEntriesOnChangeCallback)}if(n.Type.isFunction(this.params.checkSelectorStatusCallback)){BX.addCustomEvent("OnCalendarPlannerSelectorStatusOnChange",this.params.checkSelectorStatusCallback)}BX.addCustomEvent("OnCalendarPlannerScaleChanged",BX.proxy(function(e){this.update({from:e.from,to:e.to,focusSelector:e.focusSelector===true})},this))}},{key:"showPlannerLoader",value:function e(){if(this.planner&&this.planner.outerWrap){if(this.loader){n.Dom.remove(this.loader)}this.loader=this.planner.outerWrap.appendChild(n.BookingUtil.getLoader(150))}}},{key:"hidePlannerLoader",value:function e(){if(this.loader){n.Dom.remove(this.loader);this.loader=false}}},{key:"close",value:function e(t){if(this.popup){if(t&&t.animation){n.Dom.removeClass(this.popup.popupContainer,"show");setTimeout(BX.delegate(function(){t.animation=false;this.close(t)},this),300)}else{BX.unbind(document,"click",BX.proxy(this.handleClick,this));BX.removeCustomEvent(this.popup,"onPopupClose",BX.proxy(this.close,this));this.popup.destroy();this.planner=null;this.popup=null}}}},{key:"isShown",value:function e(){return this.lastPlannerIdShown===this.plannerId&&this.popup&&this.popup.isShown&&this.popup.isShown()}},{key:"getPlannerId",value:function e(){if(typeof this.plannerId==="undefined"){this.plannerId="calendar-planner-"+Math.round(Math.random()*1e5)}return this.plannerId}},{key:"getPlannerContainer",value:function e(){return BX("calendar-planner-outer"+this.getPlannerId(),true)}},{key:"refreshDateTimeView",value:function e(t){}},{key:"handleClick",value:function e(t){var s=t.target||t.srcElement;if(this.isShown()&&!BX.isParentForNode(this.bindNode,s)&&!BX.isParentForNode(BX("BXSocNetLogDestination"),s)&&!BX.isParentForNode(this.popup.popupContainer,s)){if(!document.querySelector("div.popup-window-resource-select")){this.close({animation:true})}}}}]);return e}();var B=function(){function e(t){babelHelpers.classCallCheck(this,e);this.params=t;this.plannerPopup=null;this.DOM={outerWrap:BX(t.controlId),valueInputs:[]};this.isNew=!this.params.value||!this.params.value.DATE_FROM;if(this.params.socnetDestination){o.ResourcebookingUserfield.setSocnetDestination(this.params.socnetDestination)}}babelHelpers.createClass(e,[{key:"init",value:function e(){this.buildUserfieldWrap();this.createEventHandlers();this.setControlValues()}},{key:"buildUserfieldWrap",value:function e(){this.buildDateControl();this.buildTimeControl();this.buildServiceControl();this.buildDurationControl();this.buildUserSelectorControl();this.buildResourceSelectorControl()}},{key:"createEventHandlers",value:function e(){n.Event.bind(this.DOM.outerWrap,"click",this.showPlannerPopup.bind(this));n.Event.bind(this.DOM.fromInput,"focus",this.showPlannerPopup.bind(this));n.Event.bind(this.DOM.durationInput,"focus",this.showPlannerPopup.bind(this));setTimeout(function(){BX.onCustomEvent(window,"onCrmEntityEditorUserFieldSetValidator",[this.params.controlId,function(e){if(!this.params.allowOverbooking&&this.isOverbooked()){if(e&&e.addError&&BX.Crm&&BX.Crm.EntityValidationError){e.addError(BX.Crm.EntityValidationError.create({field:this}))}}return new Promise(function(e){e()})}.bind(this)])}.bind(this),100);setTimeout(this.onChangeValues.bind(this),100)}},{key:"setControlValues",value:function e(){this.allValuesValue=null;var t,s,i=this.params.fullDay?1440:60,a;if(this.isNew){var r=o.ResourcebookingUserfield.getParamsFromHash(this.params.userfieldId);if(r&&r.length>1){t=BX.parseDate(r[0]);a=BX.parseDate(r[1]);if(t&&a){s=Math.round(Math.max((a.getTime()-t.getTime())/6e4,0))}}if(!t){t=new Date;var l=30,c=l*60*1e3,u=Math.ceil(t.getTime()/c)*c;t=new Date(u)}}else{t=BX.parseDate(this.params.value.DATE_FROM);a=BX.parseDate(this.params.value.DATE_TO);s=Math.round(Math.max((a.getTime()-t.getTime())/6e4,0))}if(!s){s=i}this.DOM.fromInput.value=n.BookingUtil.formatDate(n.BookingUtil.getDateFormat(),t);if(this.DOM.timeFromInput){this.DOM.timeFromInput.value=n.BookingUtil.formatDate(n.BookingUtil.getTimeFormatShort(),t)}if(this.durationList){this.durationList.setValue(s)}if(this.serviceList){this.serviceList.setValue(this.params.value.SERVICE_NAME||"")}var p=[];var h=[];if(this.params.value&&n.Type.isArray(this.params.value.ENTRIES)){this.params.value.ENTRIES.forEach(function(e){if(e.TYPE==="user"){p.push(parseInt(e.RESOURCE_ID))}else{h.push({id:parseInt(e.RESOURCE_ID),type:e.TYPE})}})}if(this.resourceSelector){this.resourceSelector.setValues(h,false)}if(this.userSelector){this.userSelector.setValues(p,false)}}},{key:"buildDateControl",value:function t(){this.DOM.dateTimeWrap=this.DOM.outerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-wrap calendar-resourcebook-content-block-detail-wrap-flex"}}));this.DOM.dateWrap=this.DOM.dateTimeWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-inner calendar-resourcebook-content-block-detail-wrap-down"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail"},html:'<div class="calendar-resourcebook-content-block-title"><span class="calendar-resourcebook-content-block-title-text">'+n.Loc.getMessage("USER_TYPE_RESOURCE_DATE_LABEL")+"</span></div>"}));this.DOM.fromInput=this.DOM.dateWrap.appendChild(n.Dom.create("INPUT",{attrs:{value:"",placeholder:n.Loc.getMessage("USER_TYPE_RESOURCE_DATE_LABEL"),type:"text"},events:{click:e.showCalendarPicker,change:this.triggerUpdatePlanner.bind(this)},props:{className:"calendar-resbook-date-input calendar-resbook-field-datetime"}}));this.DOM.emptyInput=this.DOM.dateWrap.appendChild(n.Dom.create("INPUT",{attrs:{value:"",type:"text"},props:{className:"calendar-resbook-empty-input"}}))}},{key:"buildTimeControl",value:function e(){var t=this;if(!this.params.fullDay){this.DOM.timeWrap=this.DOM.dateTimeWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-inner calendar-resourcebook-content-block-detail-wrap-down"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail"},html:'<div class="calendar-resourcebook-content-block-title"><span class="calendar-resourcebook-content-block-title-text">'+n.Loc.getMessage("USER_TYPE_RESOURCE_TIME_LABEL")+"</span></div>"}));this.DOM.timeFromInput=this.DOM.timeWrap.appendChild(n.Dom.create("INPUT",{attrs:{value:"",placeholder:n.Loc.getMessage("USER_TYPE_RESOURCE_TIME_LABEL"),type:"text"},style:{width:"100px"},props:{className:"calendar-resbook-date-input calendar-resbook-field-datetime-menu"}}));this.fromTime=new n.SelectInput({input:this.DOM.timeFromInput,values:n.BookingUtil.getSimpleTimeList(),onChangeCallback:this.triggerUpdatePlanner.bind(this),onAfterMenuOpen:function e(s,i){if(!s&&i){var a=BX.isAmPmMode()?n.Loc.getMessage("FORMAT_DATETIME").replace(":SS",""):n.Loc.getMessage("FORMAT_DATETIME");var o=n.BookingUtil.parseDate(t.DOM.fromInput.value+" "+t.DOM.timeFromInput.value,false,false,a);var r,l;var c=n.BookingUtil.adaptTimeValue({h:o.getHours(),m:o.getMinutes()});if(c&&c.label){for(r=0;r<i.menuItems.length;r++){l=i.menuItems[r];if(l&&c.label===l.text&&l.layout){i.layout.menuContainer.scrollTop=l.layout.item.offsetTop-2}}}}}})}}},{key:"buildServiceControl",value:function e(){if(this.params.useServices&&n.Type.isArray(this.params.serviceList)&&this.params.serviceList.length>0){if(this.params.fullDay){this.DOM.durationWrap=this.DOM.dateTimeWrap}else{this.DOM.durationWrap=this.DOM.outerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-wrap calendar-resourcebook-content-block-detail-wrap-flex"}}))}this.DOM.servicesWrap=this.DOM.durationWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-inner calendar-resourcebook-content-block-detail-wrap-down"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail"},html:'<div class="calendar-resourcebook-content-block-title"><span class="calendar-resourcebook-content-block-title-text">'+n.Loc.getMessage("USER_TYPE_RESOURCE_SERVICE_LABEL")+"</span></div>"}));this.DOM.serviceInput=this.DOM.servicesWrap.appendChild(n.Dom.create("INPUT",{attrs:{value:"",placeholder:n.Loc.getMessage("USER_TYPE_RESOURCE_SERVICE_LABEL"),type:"text"},style:{width:"200px"},props:{className:"calendar-resbook-date-input calendar-resbook-field-datetime-menu"}}));var t=[];this.params.serviceList.forEach(function(e){if(e.name!==""){t.push({value:e.duration,label:e.name})}});if(this.isNew&&t.length>=1){this.DOM.serviceInput.value=t[0].label}this.serviceList=new n.SelectInput({input:this.DOM.serviceInput,values:t,onChangeCallback:function(e){if(n.Type.isPlainObject(e)&&e.realValue){this.durationList.setValue(parseInt(e.realValue));this.duration=n.BookingUtil.parseDuration(this.DOM.durationInput.value);this.triggerUpdatePlanner()}}.bind(this)})}}},{key:"buildDurationControl",value:function e(){if(!this.DOM.durationWrap){this.DOM.durationWrap=this.DOM.dateTimeWrap}this.DOM.durationControlWrap=this.DOM.durationWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-inner calendar-resourcebook-content-block-detail-wrap-down"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail"},html:'<div class="calendar-resourcebook-content-block-title"><span class="calendar-resourcebook-content-block-title-text">'+n.Loc.getMessage("USER_TYPE_RESOURCE_DURATION_LABEL")+"</span></div>"}));this.DOM.durationInput=this.DOM.durationControlWrap.appendChild(n.Dom.create("INPUT",{attrs:{placeholder:n.Loc.getMessage("USER_TYPE_RESOURCE_DURATION_LABEL"),type:"text"},style:{width:"90px"},props:{className:"calendar-resbook-date-input calendar-resbook-field-datetime-menu"}}));this.durationList=new n.SelectInput({input:this.DOM.durationInput,values:n.BookingUtil.getDurationList(this.params.fullDay),onChangeCallback:function(){this.duration=n.BookingUtil.parseDuration(this.DOM.durationInput.value);this.triggerUpdatePlanner()}.bind(this)})}},{key:"buildUserSelectorControl",value:function e(){if(this.params.useUsers){this.DOM.userSelectorWrap=this.DOM.outerWrap.appendChild(n.Dom.create("DIV",{props:{className:"calendar-resbook-users-selector-wrap"}}));this.DOM.userSelectorWrap=this.DOM.outerWrap.appendChild(n.Dom.create("DIV",{props:{className:"calendar-resourcebook-content-block-control-field"}}));var t=n.Loc.getMessage("USER_TYPE_RESOURCE_USERS_CONTROL_DEFAULT_NAME");this.DOM.userSelectorWrap.appendChild(n.Dom.create("DIV",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(n.Dom.create("SPAN",{props:{className:"calendar-resourcebook-content-block-title-text"},text:t}));this.DOM.userListWrap=this.DOM.userSelectorWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-control custom-field-item"}}));this.userSelector=new R({wrapNode:this.DOM.userListWrap,socnetDestination:o.ResourcebookingUserfield.getSocnetDestination(),addMessage:n.Loc.getMessage("USER_TYPE_RESOURCE_SELECT_USER"),checkLimitCallback:this.checkResourceCountLimit.bind(this)});BX.addCustomEvent("OnResourceBookDestinationAddNewItem",this.triggerUpdatePlanner.bind(this));BX.addCustomEvent("OnResourceBookDestinationUnselect",this.triggerUpdatePlanner.bind(this))}}},{key:"buildResourceSelectorControl",value:function e(){if(this.params.useResources){this.DOM.resourcesWrap=this.DOM.outerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));var t=n.Loc.getMessage("USER_TYPE_RESOURCE_RESOURCE_CONTROL_DEFAULT_NAME");this.DOM.resourcesWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:t}));this.DOM.resourcesListWrap=this.DOM.resourcesWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-control custom-field-item"}}));this.resourceSelector=new M({outerWrap:this.DOM.resourcesWrap,blocksWrap:this.DOM.resourcesListWrap,values:[],resourceList:this.params.resourceList,onChangeCallback:this.triggerUpdatePlanner.bind(this),checkLimitCallback:this.checkResourceCountLimit.bind(this)})}}},{key:"onChangeValues",value:function e(){this.duration=this.duration||n.BookingUtil.parseDuration(this.DOM.durationInput.value);var t=this.duration*60;var s="",i=BX.isAmPmMode()?n.Loc.getMessage("FORMAT_DATETIME").replace(":SS",""):n.Loc.getMessage("FORMAT_DATETIME"),a,o="",r=this.DOM.serviceInput?this.DOM.serviceInput.value:"",l=[];a=this.params.fullDay?n.BookingUtil.parseDate(this.DOM.fromInput.value):n.BookingUtil.parseDate(this.DOM.fromInput.value+" "+this.DOM.timeFromInput.value,false,false,i);if(n.Type.isDate(a)){if(this.params.useResources){l=l.concat(this.getSelectedResourceList())}if(this.params.useUsers){l=l.concat(this.getSelectedUserList())}o=n.BookingUtil.formatDate(n.BookingUtil.getDateTimeFormat(),a.getTime()/1e3)}this.DOM.valueInputs.forEach(function(e){BX.remove(e)});this.DOM.valueInputs=[];l.forEach(function(e){var i=e.type+"|"+e.id+"|"+o+"|"+t+"|"+r;s+=i+"#";this.DOM.valueInputs.push(this.DOM.outerWrap.appendChild(n.Dom.create("INPUT",{attrs:{name:this.params.inputName,value:i,type:"hidden"}})))},this);if(!l.length){this.DOM.valueInputs.push(this.DOM.outerWrap.appendChild(n.Dom.create("INPUT",{attrs:{name:this.params.inputName,value:"empty",type:"hidden"}})))}if(this.allValuesValue!==null&&this.allValuesValue!==s){BX.onCustomEvent(window,"onCrmEntityEditorUserFieldExternalChanged",[this.params.controlId]);BX.fireEvent(this.DOM.emptyInput,"change")}this.allValuesValue=s}},{key:"showPlannerPopup",value:function e(){var t=[];if(this.params.value&&n.Type.isArray(this.params.value.ENTRIES)){this.params.value.ENTRIES.forEach(function(e){t.push(e.EVENT_ID)})}if(n.Type.isNull(this.plannerPopup)){this.plannerPopup=new _}this.plannerPopup.show({plannerId:this.params.plannerId,bindNode:this.DOM.outerWrap,plannerConfig:this.getPlannerConfig(),selector:this.getSelectorData(),selectorOnChangeCallback:this.plannerSelectorOnChange.bind(this),selectEntriesOnChangeCallback:this.plannerSelectedEntriesOnChange.bind(this),checkSelectorStatusCallback:this.checkSelectorStatusCallback.bind(this),currentEventList:t});this.triggerUpdatePlanner()}},{key:"triggerUpdatePlanner",value:function e(){if(!n.Type.isNull(this.plannerPopup)&&this.plannerPopup.plannerId===this.params.plannerId&&this.plannerPopup.isShown()){this.plannerPopup.update({plannerId:this.params.plannerId,plannerConfig:this.getPlannerConfig(),selector:this.getSelectorData(),resourceList:this.getResourceList(),selectedResources:this.resourceSelector?this.resourceSelector.getSelectedValues():false,userList:this.getUserList(),selectedUsers:this.userSelector?this.userSelector.getSelectedValues():false},true)}this.onChangeValues()}},{key:"getPlannerConfig",value:function e(){if(!this.params.plannerConfig){this.params.plannerConfig={id:this.params.plannerId,selectEntriesMode:true,scaleLimitOffsetLeft:2,scaleLimitOffsetRight:2,maxTimelineSize:300,minEntryRows:300,entriesListWidth:120,timelineCellWidth:49,minWidth:300,accuracy:300,workTime:[parseInt(this.params.workTime[0]),parseInt(this.params.workTime[1])]}}this.params.plannerConfig.clickSelectorScaleAccuracy=Math.max(this.duration*60||300,3600);return this.params.plannerConfig}},{key:"plannerSelectorOnChange",value:function e(t){if(t.plannerId===this.params.plannerId&&n.Type.isDate(t.dateFrom)&&n.Type.isDate(t.dateTo)){var s=t.dateFrom,i=t.dateTo;this.DOM.fromInput.value=n.BookingUtil.formatDate(n.BookingUtil.getDateFormat(),s);if(this.DOM.timeFromInput){this.DOM.timeFromInput.value=n.BookingUtil.formatDate(n.BookingUtil.getTimeFormatShort(),s)}this.duration=(i.getTime()-s.getTime()+(this.params.fullDay?n.BookingUtil.getDayLength():0))/6e4;this.duration=Math.round(Math.max(this.duration,0));this.durationList.setValue(this.duration);this.onChangeValues()}}},{key:"plannerSelectedEntriesOnChange",value:function e(t){if(t.plannerId===this.params.plannerId&&n.Type.isArray(t.entries)){var s=[],i=[];t.entries.forEach(function(e){if(e.selected){if(e.type==="user"){i.push(e.id)}else{s.push({id:e.id,type:e.type})}}});if(this.resourceSelector){this.resourceSelector.setValues(s,false)}if(this.userSelector){this.userSelector.setValues(i,false)}this.onChangeValues()}}},{key:"checkSelectorStatusCallback",value:function e(t){if(t.plannerId===this.params.plannerId&&!this.params.allowOverbooking){var s="calendar-resbook-error";this.overbooked=t.status==="busy";if(this.overbooked){if(!this.DOM.errorNode){this.DOM.errorNode=this.DOM.dateTimeWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resbook-content-error-text"},text:n.Loc.getMessage("USER_TYPE_RESOURCE_BOOKED_ERROR")}))}if(this.DOM.fromInput){BX.addClass(this.DOM.fromInput,s)}if(this.DOM.timeFromInput){BX.addClass(this.DOM.timeFromInput,s)}setTimeout(BX.delegate(function(){BX.focus(this.DOM.fromInput)},this),50)}else{if(this.DOM.errorNode){BX.remove(this.DOM.errorNode);this.DOM.errorNode=null}if(this.DOM.fromInput){BX.removeClass(this.DOM.fromInput,s)}if(this.DOM.timeFromInput){BX.removeClass(this.DOM.timeFromInput,s)}}}}},{key:"getSelectorData",value:function e(){var t=BX.isAmPmMode()?n.Loc.getMessage("FORMAT_DATETIME").replace(":SS",""):n.Loc.getMessage("FORMAT_DATETIME"),s,i,a=this.duration,o=n.BookingUtil.parseDate(this.DOM.fromInput.value+(this.DOM.timeFromInput?" "+this.DOM.timeFromInput.value:""),false,false,t);if(!a){a=this.params.fullDay?1440:60}if(!n.Type.isDate(o)){o=new Date}i=new Date(o.getTime()+a*6e4-(this.params.fullDay?n.BookingUtil.getDayLength():0));s={from:o,to:i,fullDay:this.params.fullDay,updateScaleLimits:true};return s}},{key:"getResourceList",value:function e(){var t=[];if(this.resourceSelector){this.resourceSelector.getValues().forEach(function(e){t.push({id:parseInt(e.id),type:e.type,name:e.title})})}return t}},{key:"getSelectedResourceList",value:function e(){var t=[];if(this.resourceSelector){this.resourceSelector.getSelectedValues().forEach(function(e){t.push({id:parseInt(e.id),type:e.type,name:e.title})})}return t}},{key:"getUserList",value:function e(){var t=[],s={},i;if(this.userSelector){if(n.Type.isArray(this.params.userList)){this.params.userList.forEach(function(e){if(!s[e]){t.push({id:e,type:"user"});s[e]=true}})}this.userSelector.getAttendeesCodesList().forEach(function(e){if(e.substr(0,1)==="U"){i=parseInt(e.substr(1));if(!s[i]){t.push({id:i,type:"user"});s[i]=true}}})}return t}},{key:"getSelectedUserList",value:function e(){var t=[];if(this.userSelector){this.userSelector.getAttendeesCodesList().forEach(function(e){if(e.substr(0,1)==="U"){t.push({id:parseInt(e.substr(1)),type:"user"})}})}return t}},{key:"checkResourceCountLimit",value:function e(){return this.params.resourceLimit<=0||this.getTotalResourceCount()<=this.params.resourceLimit}},{key:"getTotalResourceCount",value:function e(){var t=0;if(this.params.useResources&&this.resourceSelector){t+=this.resourceSelector.getValues().length}if(this.params.useUsers){t+=this.getSelectedUserList().length}return t}},{key:"isOverbooked",value:function e(){return this.overbooked}}],[{key:"showCalendarPicker",value:function e(t){var s=t.target||t.srcElement;BX.calendar({node:s,field:s,bTime:false});BX.focus(s)}}]);return e}();var T=function(){function e(t){babelHelpers.classCallCheck(this,e);this.params=n.Type.isPlainObject(t)?t:{};this.outerCont=this.params.outerCont;this.fieldSettings=this.params.fieldSettings||{};this.create()}babelHelpers.createClass(e,[{key:"create",value:function e(){this.serviceListOuterWrap=this.outerCont.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-wrap calendar-resourcebook-service-list-wrap"}}));this.durationTitleId="duration-title-wrap-"+Math.round(Math.random()*1e5);this.servicesTitleWrap=this.serviceListOuterWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-inner"},html:'<div class="calendar-resourcebook-content-block-detail-resource">'+'<div class="calendar-resourcebook-content-block-title">'+'<span class="calendar-resourcebook-content-block-title-text">'+n.Loc.getMessage("USER_TYPE_RESOURCE_SERVICE_LABEL")+"</span>"+"</div>"+'<div id="'+this.durationTitleId+'" class="calendar-resourcebook-content-block-title calendar-resourcebook-content-block-duration-title">'+'<span class="calendar-resourcebook-content-block-title-text">'+n.Loc.getMessage("USER_TYPE_RESOURCE_DURATION_LABEL")+"</span>"+"</div>"+"</div>"}));this.serviceListRowsWrap=this.serviceListOuterWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-inner"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail"}}));BX.bind(this.serviceListRowsWrap,"click",this.handlePopupClick.bind(this));if(n.Type.isArray(this.fieldSettings.SERVICE_LIST)&&this.fieldSettings.SERVICE_LIST.length>0){this.fieldSettings.SERVICE_LIST.forEach(function(e){this.addRow(e,false)},this)}else{this.addRow(false,false)}this.serviceListAddWrap=this.serviceListOuterWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resource-content-block-add-field"}}));this.serviceAddButton=this.serviceListAddWrap.appendChild(n.Dom.create("span",{props:{className:"calendar-resource-content-block-add-link calendar-resource-content-block-add-link-icon"},text:n.Loc.getMessage("USER_TYPE_RESOURCE_ADD_SERVICE"),events:{click:this.addRow.bind(this)}}));BX.bind(window,"resize",this.checkDurationTitlePosition.bind(this));this.checkDurationTitlePosition();this.show(this.fieldSettings.USE_SERVICES==="Y")}},{key:"show",value:function e(t){if(t){this.serviceListOuterWrap.style.display="";n.Dom.addClass(this.serviceListOuterWrap,"show")}else{this.serviceListOuterWrap.style.display="none";n.Dom.removeClass(this.serviceListOuterWrap,"show")}}},{key:"addRow",value:function e(t,s){s=s!==false;if(!n.Type.isPlainObject(t)){t={name:"",duration:this.getDefaultDuration()}}var i={outerWrap:this.serviceListRowsWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-resource calendar-resourcebook-service-row"}}))};if(s){setTimeout(function(){n.Dom.addClass(i.outerWrap,"show")},1)}else{n.Dom.addClass(i.outerWrap,"show")}i.wrap=i.outerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-detail-resource-inner"}}));i.nameInput=i.wrap.appendChild(n.Dom.create("input",{props:{className:"calendar-resourcebook-content-input calendar-resourcebook-service-input",placeholder:n.Loc.getMessage("USER_TYPE_RESOURCE_SERVICE_PLACEHOLDER"),type:"text",value:t.name},attrs:{}}));i.durationInput=i.wrap.appendChild(n.Dom.create("input",{props:{className:"calendar-resbook-duration-input calendar-resbook-field-datetime-menu",type:"text",value:t.duration},attrs:{}}));i.durationList=new n.SelectInput({input:i.durationInput,getValues:function(){var e=false;if(n.Type.isFunction(this.params.getFullDayValue)){e=this.params.getFullDayValue()}return n.BookingUtil.getDurationList(e)}.bind(this),value:t.duration});i.deleteWrap=i.wrap.appendChild(n.Dom.create("DIV",{props:{className:"calendar-resourcebook-content-block-detail-delete"},html:'<span class="calendar-resourcebook-content-block-control-delete calendar-resourcebook-content-block-control-delete-detail"></span>'}));this.serviceListOuterWrap.style.maxHeight=Math.max(500,this.serviceListRowsWrap.childNodes.length*45+100)+"px"}},{key:"checkDurationTitlePosition",value:function e(t){if(t!==false){if(this.checkDurationTitlePositionTimeout){clearTimeout(this.checkDurationTitlePositionTimeout)}this.checkDurationTitlePositionTimeout=setTimeout(function(){this.checkDurationTitlePosition(false)}.bind(this),100);return}var s=this.serviceListOuterWrap.querySelector("input.calendar-resbook-duration-input");if(this.durationTitleId&&BX(this.durationTitleId)&&s){BX(this.durationTitleId).style.left=s.offsetLeft+15+"px"}}},{key:"getDefaultDuration",value:function e(){var t=false;if(n.Type.isFunction(this.params.getFullDayValue)){t=this.params.getFullDayValue()}return t?1440:30}},{key:"clickHandler",value:function e(t){var s=t.target||t.srcElement;if(n.Dom.hasClass(s,"calendar-resourcebook-content-block-control-delete")||n.Dom.hasClass(s,"calendar-resourcebook-content-block-detail-delete")){var i=BX.findParent(s,{className:"calendar-resourcebook-service-row"});if(i){n.Dom.removeClass(i,"show");setTimeout(function(){n.Dom.remove(i)},500);this.checkRows()}}}},{key:"getValues",value:function e(t){var s=[],i,a,o,r=this.serviceListRowsWrap.querySelectorAll(".calendar-resourcebook-service-row");for(o=0;o<r.length;o++){if(n.Dom.hasClass(r[o],"show")){i=r[o].querySelector("input.calendar-resourcebook-service-input");a=r[o].querySelector("input.calendar-resbook-duration-input");if(i&&a){s.push({name:i.value,duration:n.BookingUtil.parseDuration(a.value)})}}}return s}},{key:"checkRows",value:function e(){var t=this.getValues();if(!t.length){this.show(false);if(n.Type.isFunction(this.params.onFullClearHandler)){this.params.onFullClearHandler()}this.addRow(false,false)}}},{key:"handlePopupClick",value:function e(t){var s=t.target||t.srcElement;if(n.Dom.hasClass(s,"calendar-resourcebook-content-block-control-delete")||n.Dom.hasClass(s,"calendar-resourcebook-content-block-detail-delete")){var i=BX.findParent(s,{className:"calendar-resourcebook-service-row"});if(i){BX.removeClass(i,"show");setTimeout(function(){BX.remove(i)},500);this.checkRows()}}}}]);return e}();var I=function(){function e(t){babelHelpers.classCallCheck(this,e);this.params=n.Type.isPlainObject(t)?t:{};this.DOM={outerWrap:this.params.outerWrap};n.Dom.addClass(this.DOM.outerWrap,"fields enumeration field-item");this.create()}babelHelpers.createClass(e,[{key:"create",value:function e(){this.DOM.select=this.DOM.outerWrap.appendChild(n.Dom.create("select"));this.DOM.select.options.add(new Option(n.Loc.getMessage("USER_TYPE_LOADING_TIMEZONE_LIST"),this.params.selectedValue||"",true,true));this.getTimezoneList().then(function(e){n.Dom.remove(this.DOM.select.options[0]);e.forEach(function(e){var t=this.params.selectedValue?this.params.selectedValue===e.value:e.selected;this.DOM.select.options.add(new Option(e.label,e.value,t,t))},this)}.bind(this))}},{key:"getTimezoneList",value:function t(s){var i=this;s=s||{};return new Promise(function(t){if(!e.timezoneList||s.clearCache){BX.ajax.runAction("calendar.api.calendarajax.getTimezoneList").then(function(s){e.timezoneList=[];for(var i in s.data){if(s.data.hasOwnProperty(i)){e.timezoneList.push({value:s.data[i].timezone_id,label:s.data[i].title,selected:s.data[i].default})}}t(e.timezoneList)}.bind(i),function(e){t(e)})}else{t(e.timezoneList)}})}},{key:"getValue",value:function e(){return this.DOM.select.value}}]);return e}();var w=function(){function e(t){babelHelpers.classCallCheck(this,e);this.params=t;this.outerWrap=this.create()}babelHelpers.createClass(e,[{key:"create",value:function e(){var t=n.Dom.create("span",{props:{className:"calendar-resourcebook-content-block-select calendar-resourcebook-mode-selector"}}),s=[{text:n.Loc.getMessage("USER_TYPE_RESOURCE_CHOOSE_RESOURCES"),onclick:function(e,s){if(n.Type.isFunction(this.params.showResources)){this.params.showResources()}t.innerHTML=s.text;this.modeSwitcherPopup.close()}.bind(this)},{text:n.Loc.getMessage("USER_TYPE_RESOURCE_CHOOSE_USERS"),onclick:function(e,s){if(n.Type.isFunction(this.params.showUsers)){this.params.showUsers()}t.innerHTML=s.text;this.modeSwitcherPopup.close()}.bind(this)},{text:n.Loc.getMessage("USER_TYPE_RESOURCE_CHOOSE_RESOURCES_AND_USERS"),onclick:function(e,s){if(n.Type.isFunction(this.params.showResourcesAndUsers)){this.params.showResourcesAndUsers()}t.innerHTML=s.text;this.modeSwitcherPopup.close()}.bind(this)}],i="mode-switcher-"+Math.round(Math.random()*1e5);n.Event.bind(t,"click",function(){if(this.modeSwitcherPopup&&this.modeSwitcherPopup.popupWindow&&this.modeSwitcherPopup.popupWindow.isShown()){return this.modeSwitcherPopup.close()}this.modeSwitcherPopup=BX.PopupMenu.create(i,t,s,{closeByEsc:true,autoHide:true,offsetTop:0,offsetLeft:20,angle:true});this.modeSwitcherPopup.show();BX.addCustomEvent(this.modeSwitcherPopup.popupWindow,"onPopupClose",function(){BX.PopupMenu.destroy(i);this.modeSwitcherPopup=null}.bind(this))}.bind(this));if(this.params.useUsers&&!this.params.useResources){t.innerHTML=n.Loc.getMessage("USER_TYPE_RESOURCE_CHOOSE_USERS")}else if(this.params.useUsers&&this.params.useResources){t.innerHTML=n.Loc.getMessage("USER_TYPE_RESOURCE_CHOOSE_RESOURCES_AND_USERS")}else{t.innerHTML=n.Loc.getMessage("USER_TYPE_RESOURCE_CHOOSE_RESOURCES")}return t}},{key:"getOuterWrap",value:function e(){return this.outerWrap}}]);return e}();var N=function e(t){var s=function e(){e.superclass.constructor.apply(this)};BX.extend(s,t);s.create=function(e,t){var i=new s;i.initialize(e,t);return i};s.prototype.layout=function(e,t){if(this._hasLayout){return}if(!BX.type.isPlainObject(t)){t={}}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorUserFieldConfigurator. View mode is not supported by this control type."}this.getBitrix24Limitation({callback:BX.delegate(function(e){this.RESOURCE_LIMIT=e},this)});if(this._field){this.fieldInfo=this._field.getFieldInfo()}else if(!t.settings){return this.getDefaultUserfieldSettings({displayCallback:BX.delegate(function(t){this.layout(e,{settings:t})},this)})}this._wrapper=BX.create("div",{props:{className:"calendar-resourcebook-content"}});this._innerWrapper=this._wrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-wrap"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-inner"}}));var s=this.fieldInfo?this.fieldInfo.SETTINGS:t.settings,i=[],a=[],n=this._field===null,r=this.getMessage("labelField"),l=this._editor.getUserFieldManager(),c=this._field?this._field.getTitle():l.getDefaultFieldLabel(this._typeId);this.RESOURCE_LIMIT=s.RESOURCE_LIMIT||0;this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:c}});this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:r})]}),BX.create("div",{props:{className:"calendar-resourcebook-content-block-field"},children:[this._labelInput]}),BX.create("hr",{props:{className:"crm-entity-widget-hr"}})]}));this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block"},children:[BX.create("span",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_CHOOSE")}),new w({useResources:s.USE_RESOURCES==="Y",useUsers:s.USE_USERS==="Y",showUsers:function(){this.resourceList.hide();this.userList.show()}.bind(this),showResources:function(){this.resourceList.show();this.userList.hide()}.bind(this),showResourcesAndUsers:function(){this.resourceList.show();this.userList.show()}.bind(this)}).getOuterWrap()]}));var u=this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block"}}));this.resourcesWrap=u.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.resourcesTitleWrap=this.resourcesWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_RESOURCE_CONTROL_DEFAULT_NAME")+":"}));this.resourcesListWrap=this.resourcesWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-new-entries-wrap calendar-resourcebook-content-block-detail-inner"}}));this.resourcesListLowControls=this.resourcesWrap.appendChild(BX.create("div",{props:{className:"calendar-resource-content-block-add-field"}}));if(s.RESOURCES&&BX.type.isPlainObject(s.RESOURCES["resource"])&&BX.type.isArray(s.RESOURCES["resource"].SECTIONS)){s.RESOURCES["resource"].SECTIONS.forEach(function(e){i.push({id:e.ID,title:e.NAME,type:e.CAL_TYPE})})}if(BX.type.isArray(s.SELECTED_RESOURCES)){s.SELECTED_RESOURCES.forEach(function(e){a.push({id:e.id,type:e.type})})}this.resourceList=new M({shown:s.USE_RESOURCES==="Y",editMode:true,outerWrap:this.resourcesWrap,listWrap:this.resourcesListWrap,controlsWrap:this.resourcesListLowControls,values:a,resourceList:i,checkLimitCallback:this.checkResourceCountLimit.bind(this),checkLimitCallbackForNew:this.checkResourceCountLimitForNewEntries.bind(this)});this.userSelectorWrap=u.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.usersTitleWrap=this.userSelectorWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_USERS_CONTROL_DEFAULT_NAME")+":"}));this.usersListWrap=this.userSelectorWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control"}}));var p=[];if(BX.type.isArray(s.SELECTED_USERS)){s.SELECTED_USERS.forEach(function(e){p.push("U"+parseInt(e))})}this.userList=new R({shown:s.USE_USERS==="Y",outerWrap:this.userSelectorWrap,wrapNode:this.usersListWrap,socnetDestination:o.ResourcebookingUserfield.getSocnetDestination(),itemsSelected:p,checkLimitCallback:this.checkResourceCountLimit.bind(this)});u.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this.datetimeOptionsWrap=u.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.datetimeOptionsWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_DATETIME_BLOCK_TITLE")+":"}));this.datetimeOptionsInnerWrap=this.datetimeOptionsWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-options"}}));this.timezoneSettingsWrap=u.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-options"},style:{display:s.FULL_DAY==="Y"?"none":""}}));this.timezoneSettingsWrap.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this.timezoneSettingsWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(BX.create("span",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_TIMEZONE_SETTINGS_TITLE")+":"}));this.timezoneSelectorWrap=this.timezoneSettingsWrap.appendChild(BX.create("div",{style:{display:s.USE_USER_TIMEZONE==="Y"?"none":""}}));this.timezoneSelectWrap=this.timezoneSelectorWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-field"}}));this.timezoneSelector=new I({outerWrap:this.timezoneSelectWrap,selectedValue:s.TIMEZONE});this.useUserTimezoneCheckBox=BX.create("input",{props:{type:"checkbox",checked:s.USE_USER_TIMEZONE==="Y"}});this.timezoneSettingsWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this.useUserTimezoneCheckBox,BX.create("span",{text:BX.message("USER_TYPE_RESOURCE_USE_USER_TIMEZONE")})],events:{click:BX.proxy(this.handleUserTimezoneCheckbox,this)}}));this._fulldayCheckBox=BX.create("input",{props:{type:"checkbox",checked:s.FULL_DAY==="Y"},events:{click:BX.proxy(this.handleFullDayMode,this)}});this.datetimeOptionsInnerWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._fulldayCheckBox,BX.create("span",{text:BX.message("USER_TYPE_RESOURCE_FULL_DAY")})]}));this._servicesCheckBox=BX.create("input",{props:{type:"checkbox",checked:s.USE_SERVICES==="Y"},events:{click:BX.delegate(function(){if(this.serviceList){this.serviceList.show(this._servicesCheckBox.checked)}},this)}});this.datetimeOptionsInnerWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._servicesCheckBox,BX.create("span",{text:BX.message("USER_TYPE_RESOURCE_ADD_SERVICES")})]}));this.serviceList=new T({outerCont:this.datetimeOptionsInnerWrap,onFullClearHandler:function(){this._servicesCheckBox.checked=false}.bind(this),fieldSettings:s,getFullDayValue:function(){return this._fulldayCheckBox.checked}.bind(this)});u.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this.additionaOptionsWrap=u.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-options"}}));this._isRequiredCheckBox=BX.create("input",{props:{type:"checkbox",checked:this._field&&this._field.isRequired()}});this.additionaOptionsWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._isRequiredCheckBox,BX.create("span",{text:this.getMessage("isRequiredField")})]}));this._showAlwaysCheckBox=BX.create("input",{props:{type:"checkbox"}});if(n){this._showAlwaysCheckBox.checked=BX.prop.getBoolean(this._settings,"showAlways",true)}else{this._showAlwaysCheckBox.checked=this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.additionaOptionsWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._showAlwaysCheckBox,BX.create("span",{text:this.getMessage("showAlways")})]}));this._overbookingCheckBox=BX.create("input",{props:{type:"checkbox",checked:s.ALLOW_OVERBOOKING==="Y"}});this.additionaOptionsWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._overbookingCheckBox,BX.create("span",{text:BX.message("USER_TYPE_RESOURCE_OVERBOOKING")})]}));this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-btn-container"},children:[BX.create("hr",{props:{className:"crm-entity-widget-hr"}}),BX.create("button",{props:{type:"button",className:"ui-btn ui-btn-sm ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}}),BX.create("button",{props:{type:"button",className:"ui-btn ui-btn-sm ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}})]}));this.fieldSettings=s;this.registerLayout(e);this._hasLayout=true};s.prototype.getDefaultUserfieldSettings=function(e){BX.ajax.runAction("calendar.api.resourcebookingajax.getdefaultuserfieldsettings",{data:{}}).then(function(t){if(e&&BX.type.isFunction(e.displayCallback)){e.displayCallback(t.data)}},function(e){})};s.prototype.getBitrix24Limitation=function(e){BX.ajax.runAction("calendar.api.resourcebookingajax.getbitrix24limitation",{data:{}}).then(function(t){if(e&&BX.type.isFunction(e.callback)){e.callback(t.data)}},function(e){})};s.prototype.onSaveButtonClick=function(){if(this._isLocked){return}if(this.RESOURCE_LIMIT>0&&this.getTotalResourceCount()>this.RESOURCE_LIMIT){n.BookingUtil.showLimitationPopup();return}var e={typeId:this._typeId,label:this._labelInput.value,mandatory:this._isRequiredCheckBox.checked,showAlways:this._showAlwaysCheckBox.checked,multiple:true};if(this._field){e["field"]=this._field}this.fieldSettings.USE_RESOURCES=this.resourceList.isShown()?"Y":"N";this.fieldSettings.USE_USERS=this.userList.isShown()?"Y":"N";if(this.fieldSettings&&BX.type.isPlainObject(this.fieldSettings.RESOURCES)&&BX.type.isPlainObject(this.fieldSettings.RESOURCES["resource"])){this.fieldSettings.SELECTED_RESOURCES=[];this.resourceList.getSelectedValues().forEach(function(e){this.fieldSettings.SELECTED_RESOURCES.push(e)},this);this.resourceList.getDeletedValues().forEach(function(e){this.fieldSettings.SELECTED_RESOURCES.push(e)},this)}if(this.fieldSettings&&this.userList){this.fieldSettings.SELECTED_USERS=[0];this.userList.getAttendeesCodesList().forEach(function(e){if(e.substr(0,1)==="U"){this.fieldSettings.SELECTED_USERS.push(parseInt(e.substr(1)))}},this)}this.fieldSettings.USE_SERVICES=this._servicesCheckBox.checked?"Y":"N";this.fieldSettings.SERVICE_LIST=[];if(this._servicesCheckBox.checked&&this.serviceList){this.fieldSettings.SERVICE_LIST=this.serviceList.getValues()}this.fieldSettings.FULL_DAY=this._fulldayCheckBox.checked?"Y":"N";this.fieldSettings.ALLOW_OVERBOOKING=this._overbookingCheckBox.checked?"Y":"N";if(this.fieldSettings.FULL_DAY==="N"){this.fieldSettings.TIMEZONE=this.timezoneSelector.getValue();this.fieldSettings.USE_USER_TIMEZONE=this.useUserTimezoneCheckBox.checked?"Y":"N"}else{this.fieldSettings.TIMEZONE="";this.fieldSettings.USE_USER_TIMEZONE="N"}e["settings"]=this.fieldSettings;BX.onCustomEvent(this,"onSave",[this,e])};s.prototype.getTotalResourceCount=function(){var e=0;if(this.fieldSettings){if(BX.type.isPlainObject(this.fieldSettings.RESOURCES)&&BX.type.isPlainObject(this.fieldSettings.RESOURCES.resource)&&BX.type.isArray(this.fieldSettings.RESOURCES.resource.SECTIONS)){e+=this.fieldSettings.RESOURCES.resource.SECTIONS.length}e-=this.resourceList.getDeletedValues().length;this.resourceList.getSelectedValues().forEach(function(t){if(!t.id&&t.title!==""){e++}},this);if(this.userList){e+=this.userList.getAttendeesCodesList().length}}return e};s.prototype.checkResourceCountLimitForNewEntries=function(){return this.RESOURCE_LIMIT<=0||this.getTotalResourceCount()<this.RESOURCE_LIMIT};s.prototype.checkResourceCountLimit=function(){return this.RESOURCE_LIMIT<=0||this.getTotalResourceCount()<=this.RESOURCE_LIMIT};s.prototype.handleFullDayMode=function(){this.timezoneSettingsWrap.style.display=this._fulldayCheckBox.checked?"none":""};s.prototype.handleUserTimezoneCheckbox=function(){this.timezoneSelectorWrap.style.display=this.useUserTimezoneCheckBox.checked?"none":""};return s};var U=function(){function e(t){babelHelpers.classCallCheck(this,e);this.id="calendar_custom_settings_"+Math.round(Math.random()*1e6);this.zIndex=3100;this.sliderId="calendar:resbook-settings-slider";this.SLIDER_WIDTH=400;this.SLIDER_DURATION=80;this.DOM={};this.params=t}babelHelpers.createClass(e,[{key:"show",value:function e(){BX.SidePanel.Instance.open(this.sliderId,{contentCallback:BX.delegate(this.create,this),width:this.SLIDER_WIDTH,animationDuration:this.SLIDER_DURATION});this.hideHandler=this.hide.bind(this);this.destroyHandler=this.destroy.bind(this);BX.addCustomEvent("SidePanel.Slider:onClose",this.hideHandler);BX.addCustomEvent("SidePanel.Slider:onCloseComplete")}},{key:"close",value:function e(){BX.SidePanel.Instance.close()}},{key:"hide",value:function e(t){if(t&&t.getSliderPage&&t.getSliderPage().getUrl()===this.sliderId){BX.removeCustomEvent("SidePanel.Slider:onClose",this.hideHandler)}}},{key:"destroy",value:function e(t){if(t&&t.getSliderPage&&t.getSliderPage().getUrl()===this.sliderId){BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",this.destroyHandler);BX.SidePanel.Instance.destroy(this.sliderId)}}},{key:"create",value:function e(){var t=new BX.Promise;var s='<div class="webform-buttons calendar-form-buttons-fixed">'+'<span id="'+this.id+'_save" class="webform-small-button webform-small-button-blue">'+BX.message("USER_TYPE_RESOURCE_SAVE")+"</span>"+'<span id="'+this.id+'_close" class="webform-button-link">'+BX.message("USER_TYPE_RESOURCE_CLOSE")+"</span>"+"</div>"+'<div class="calendar-slider-calendar-wrap">'+'<div class="calendar-slider-header"><div class="calendar-head-area"><div class="calendar-head-area-inner"><div class="calendar-head-area-title">'+'<span class="calendar-head-area-name">'+BX.message("USER_TYPE_RESOURCE_SETTINGS")+"</span>"+"</div></div></div></div>"+'<div class="resource-booking-slider-workarea"><div class="resource-booking-slider-content"><div id="'+this.id+'_content" class="resource-booking-settings"></div></div></div></div>';t.fulfill(s);setTimeout(this.initControls.bind(this),100);return t}},{key:"initControls",value:function e(){this.DOM.content=BX(this.id+"_content");BX.bind(BX(this.id+"_save"),"click",this.save.bind(this));BX.bind(BX(this.id+"_close"),"click",this.close.bind(this));if(this.params&&BX.type.isArray(this.params.filterSelectValues)){this.DOM.fieldOuterWrap=this.DOM.content.appendChild(BX.create("DIV",{attrs:{className:"calendar-settings-control"}}));this.DOM.fieldOuterWrap.appendChild(BX.create("DIV",{attrs:{className:"calendar-settings-control-name"},text:BX.message("USER_TYPE_RESOURCE_FILTER_NAME")}));this.DOM.fieldSelect=this.DOM.fieldOuterWrap.appendChild(BX.create("DIV",{attrs:{className:"calendar-field-container calendar-field-container-select"}})).appendChild(BX.create("DIV",{attrs:{className:"calendar-field-block"}})).appendChild(BX.create("select",{attrs:{className:"calendar-field calendar-field-select"}}));this.params.filterSelectValues.forEach(function(e){this.DOM.fieldSelect.options.add(new Option(e.TEXT,e.VALUE,this.params.filterSelect===e.VALUE,this.params.filterSelect===e.VALUE))},this)}}},{key:"save",value:function e(){var t=this.params.entityType||"none";BX.userOptions.save("calendar","resourceBooking",t,this.DOM.fieldSelect.value);this.close();BX.reload()}}]);return e}();var P=function(){function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};babelHelpers.classCallCheck(this,e);this.params=n.Type.isPlainObject(t)?t:{};this.fieldSettings=n.Type.isPlainObject(this.params.settings)?this.params.settings:{};this.DOM={outerWrap:document.getElementById(this.params.outerWrapId),form:document.forms[this.params.formName]}}babelHelpers.createClass(e,[{key:"showLayout",value:function e(){if(!this.DOM.outerWrap||!this.DOM.form)return;n.Event.bind(this.DOM.form,"submit",this.onSubmit.bind(this));n.Dom.addClass(this.DOM.outerWrap,"calendar-resourcebook-content calendar-resourcebook-content-admin-settings");this.DOM.innerWrap=this.DOM.outerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-wrap"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-inner"}}));var t=[],s=[];this.DOM.innerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block"},children:[n.Dom.create("span",{props:{className:"calendar-resourcebook-content-block-title-text"},text:n.Loc.getMessage("USER_TYPE_RESOURCE_CHOOSE")}),new w({useResources:this.fieldSettings.USE_RESOURCES==="Y",useUsers:this.fieldSettings.USE_USERS==="Y",showUsers:function(){this.resourceList.hide();this.userList.show()}.bind(this),showResources:function(){this.resourceList.show();this.userList.hide()}.bind(this),showResourcesAndUsers:function(){this.resourceList.show();this.userList.show()}.bind(this)}).getOuterWrap()]}));this.DOM.optionWrap=this.DOM.innerWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block"}}));this.resourcesWrap=this.DOM.optionWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.resourcesTitleWrap=this.resourcesWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:n.Loc.getMessage("USER_TYPE_RESOURCE_RESOURCE_CONTROL_DEFAULT_NAME")+":"}));this.resourcesListWrap=this.resourcesWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-new-entries-wrap calendar-resourcebook-content-block-detail-inner"}}));this.resourcesListLowControls=this.resourcesWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resource-content-block-add-field"}}));if(this.fieldSettings.RESOURCES&&n.Type.isPlainObject(this.fieldSettings.RESOURCES["resource"])&&n.Type.isArray(this.fieldSettings.RESOURCES["resource"].SECTIONS)){this.fieldSettings.RESOURCES["resource"].SECTIONS.forEach(function(e){t.push({id:e.ID,title:e.NAME,type:e.CAL_TYPE})})}if(n.Type.isArray(this.fieldSettings.SELECTED_RESOURCES)){this.fieldSettings.SELECTED_RESOURCES.forEach(function(e){s.push({id:e.id,type:e.type})})}this.resourceList=new M({shown:this.fieldSettings.USE_RESOURCES==="Y",editMode:true,outerWrap:this.resourcesWrap,listWrap:this.resourcesListWrap,controlsWrap:this.resourcesListLowControls,values:s,resourceList:t,checkLimitCallback:this.checkResourceCountLimit.bind(this)});this.userSelectorWrap=this.DOM.optionWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.usersTitleWrap=this.userSelectorWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:n.Loc.getMessage("USER_TYPE_RESOURCE_USERS_CONTROL_DEFAULT_NAME")+":"}));this.usersListWrap=this.userSelectorWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-control custom-field-item"}}));var i=[];if(n.Type.isArray(this.fieldSettings.SELECTED_USERS)){this.fieldSettings.SELECTED_USERS.forEach(function(e){i.push("U"+parseInt(e))})}this.userList=new R({shown:this.fieldSettings.USE_USERS==="Y",outerWrap:this.userSelectorWrap,wrapNode:this.usersListWrap,socnetDestination:this.params.socnetDestination,itemsSelected:i});this.DOM.optionWrap.appendChild(n.Dom.create("hr",{props:{className:"calendar-resbook-hr"}}));this.datetimeOptionsWrap=this.DOM.optionWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.datetimeOptionsWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:n.Loc.getMessage("USER_TYPE_RESOURCE_DATETIME_BLOCK_TITLE")+":"}));this.datetimeOptionsInnerWrap=this.datetimeOptionsWrap.appendChild(n.Dom.create("div",{props:{className:"calendar-resourcebook-content-block-options"}}));this.DOM.fulldayCheckBox=n.Dom.create("input",{props:{type:"checkbox",checked:this.fieldSettings.FULL_DAY==="Y"}});this.datetimeOptionsInnerWrap.appendChild(n.Dom.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this.DOM.fulldayCheckBox,n.Dom.create("span",{text:n.Loc.getMessage("USER_TYPE_RESOURCE_FULL_DAY")})]}));this.DOM.useServicedayCheckBox=n.Dom.create("input",{props:{type:"checkbox",checked:this.fieldSettings.USE_SERVICES==="Y"},events:{click:function(){if(this.serviceList){this.serviceList.show(this.DOM.useServicedayCheckBox.checked)}}.bind(this)}});this.datetimeOptionsInnerWrap.appendChild(n.Dom.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this.DOM.useServicedayCheckBox,n.Dom.create("span",{text:n.Loc.getMessage("USER_TYPE_RESOURCE_ADD_SERVICES")})]}));this.serviceList=new T({outerCont:this.datetimeOptionsInnerWrap,fieldSettings:this.fieldSettings,getFullDayValue:function(){return this.DOM.fulldayCheckBox.checked}.bind(this)});this.DOM.optionWrap.appendChild(n.Dom.create("hr",{props:{className:"calendar-resbook-hr"}}));this.DOM.overbookingCheckbox=n.Dom.create("input",{props:{type:"checkbox",checked:this.fieldSettings.ALLOW_OVERBOOKING==="Y"}});this.DOM.optionWrap.appendChild(n.Dom.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this.DOM.overbookingCheckbox,n.Dom.create("span",{text:n.Loc.getMessage("USER_TYPE_RESOURCE_OVERBOOKING")})]}))}},{key:"onSubmit",value:function e(t){if(!this.DOM.inputsWrap){this.DOM.inputsWrap=this.DOM.outerWrap.appendChild(n.Dom.create("DIV"))}else{n.Dom.clean(this.DOM.inputsWrap)}var s=this.params.htmlControl.NAME;this.DOM.inputsWrap.appendChild(n.Dom.create("INPUT",{attrs:{name:s+"[USE_USERS]",value:this.userList.isShown()?"Y":"N",type:"hidden"}}));this.DOM.inputsWrap.appendChild(n.Dom.create("INPUT",{attrs:{name:s+"[USE_RESOURCES]",value:this.resourceList.isShown()?"Y":"N",type:"hidden"}}));this.DOM.inputsWrap.appendChild(n.Dom.create("INPUT",{attrs:{name:s+"[USE_SERVICES]",value:this.DOM.useServicedayCheckBox.checked?"Y":"N",type:"hidden"}}));this.DOM.inputsWrap.appendChild(n.Dom.create("INPUT",{attrs:{name:s+"[FULL_DAY]",value:this.DOM.fulldayCheckBox.checked?"Y":"N",type:"hidden"}}));this.DOM.inputsWrap.appendChild(n.Dom.create("INPUT",{attrs:{name:s+"[ALLOW_OVERBOOKING]",value:this.DOM.overbookingCheckbox.checked?"Y":"N",type:"hidden"}}));if(this.resourceList){this.prepareFormDataInputs(this.DOM.inputsWrap,this.resourceList.getSelectedValues().concat(this.resourceList.getDeletedValues()),s+"[SELECTED_RESOURCES]")}if(this.userList){var i=[];this.userList.getAttendeesCodesList().forEach(function(e){if(e.substr(0,1)==="U"){i.push(parseInt(e.substr(1)))}},this);this.prepareFormDataInputs(this.DOM.inputsWrap,i,s+"[SELECTED_USERS]")}if(this.DOM.useServicedayCheckBox.checked&&this.serviceList){this.prepareFormDataInputs(this.DOM.inputsWrap,this.serviceList.getValues(),s+"[SERVICE_LIST]")}}},{key:"prepareFormDataInputs",value:function e(t,s,i){s.forEach(function(e,s){if(n.Type.isPlainObject(e)){var a;for(a in e){if(e.hasOwnProperty(a)){t.appendChild(n.Dom.create("INPUT",{attrs:{name:i+"["+s+"]["+a+"]",value:e[a],type:"hidden"}}))}}}else{t.appendChild(n.Dom.create("INPUT",{attrs:{name:i+"["+s+"]",value:e,type:"hidden"}}))}},this)}},{key:"getTotalResourceCount",value:function e(){var t=0;if(this.fieldSettings){if(n.Type.isPlainObject(this.fieldSettings.RESOURCES)&&n.Type.isPlainObject(this.fieldSettings.RESOURCES.resource)&&n.Type.isArray(this.fieldSettings.RESOURCES.resource.SECTIONS)){t+=this.fieldSettings.RESOURCES.resource.SECTIONS.length}if(this.resourceList){t-=this.resourceList.getDeletedValues().length;this.resourceList.getSelectedValues().forEach(function(e){if(!e.id&&e.title!==""){t++}},this)}if(this.userList){t+=this.userList.getAttendeesCodesList().length}}return t}},{key:"checkResourceCountLimitForNewEntries",value:function e(){return this.RESOURCE_LIMIT<=0||this.getTotalResourceCount()<this.RESOURCE_LIMIT}},{key:"checkResourceCountLimit",value:function e(){return this.RESOURCE_LIMIT<=0||this.getTotalResourceCount()<=this.RESOURCE_LIMIT}}]);return e}();var W=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"initCrmFormFieldController",value:function e(t){if(!a.Type.isPlainObject(t)){t={field:{}}}var s={};if(a.Type.isDomNode(t.field.node)){s.outerWrap=t.field.node}else{throw new Error('The argument "params.field.node" must be a DOM node.')}s.innerWrap=s.outerWrap.querySelector(".crm-webform-resourcebooking-wrap");if(!s.innerWrap){throw new Error('Can\'t find necessary DOM node "div.crm-webform-resourcebooking-wrap"')}s.name=t.field.name;s.formName="FIELD["+t.field.name+"]";s.captionNode=t.field.lblCaption;s.entityFieldName=t.field.entity_field_name;s.entityName=t.field.dict.entity_field_name;s.settings={caption:t.field.captionValue||t.field.dict.caption,required:t.field.isRequired||t.field.dict.required,data:a.Type.isPlainObject(t.field.booking)&&a.Type.isPlainObject(t.field.booking.settings_data)?t.field.booking.settings_data:t.field.settingsData||[]};var i=new L(s);i.init();return i}},{key:"initEditFieldController",value:function e(t){var s=new B(t);s.init();return s}},{key:"getCrmFieldConfigurator",value:function e(t,s){if(window.BX&&BX.Crm&&a.Type.isFunction(BX.Crm.EntityEditorUserFieldConfigurator)){return N(BX.Crm.EntityEditorUserFieldConfigurator).create(t,s)}}},{key:"getUserFieldParams",value:function t(){var s=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};return new Promise(function(t){var i=s.fieldName||"";if(s.clearCache||!e.fieldParamsCache[s.fieldName]){BX.ajax.runAction("calendar.api.resourcebookingajax.getfieldparams",{data:{fieldname:s.fieldName,selectedUsers:s.selectedUsers||[]}}).then(function(s){e.fieldParamsCache[i]=s.data;t(s.data)},function(e){})}else{t(e.fieldParamsCache[i])}})}},{key:"getPluralMessage",value:function e(t,s){var i,a;a=BX.message("LANGUAGE_ID")||"en";s=parseInt(s);if(s<0){s=-1*s}if(a){switch(a){case"ru":case"ua":if(s%10===1&&s%100!==11){i=0}else{i=s%10>=2&&s%10<=4&&(s%100<10||s%100>=20)?1:2}break;case"pl":if(s<=4){i=s===1?0:1}else{i=2}break;default:i=s!==1?1:0;break}}else{i=1}return BX.message(t+"_PLURAL_"+i)}},{key:"getParamsFromHash",value:function e(t){var s,i,a=unescape(window.location.hash);if(a){i=new RegExp("#calendar:"+t+"\\|(.*)","ig").exec(a);if(i&&i.length>1){s=i[1].split("|")}}return s}},{key:"openExternalSettingsSlider",value:function e(t){var s=new U(t);s.show()}},{key:"setSocnetDestination",value:function t(s){e.socnetDestination=s}},{key:"getSocnetDestination",value:function t(){return e.socnetDestination}}]);return e}();babelHelpers.defineProperty(W,"fieldParamsCache",{});babelHelpers.defineProperty(W,"socnetDestination",null);e.Resourcebooking=n.Resourcebooking;e.BookingUtil=n.BookingUtil;e.AdminSettingsViewer=P;e.ResourcebookingUserfield=W})(this.BX.Calendar=this.BX.Calendar||{},BX.UI.EntitySelector,BX.Event,BX,BX,BX.Calendar,BX.Calendar);
//# sourceMappingURL=resourcebookinguserfield.bundle.map.js