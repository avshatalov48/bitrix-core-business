(function(){if(window.BXMainMailConfirm)return;var e={};var t=[];var a={};var i;let n=null;let o=false;var l={init:function(a){t=a.mailboxes;i=a.action;o=a.canCheckSmtp??false;n=new BX.UI.Mail.SenderSelector({mailboxes:t,isSenderAvailable:o??false});delete a.mailboxes;e=a},getMailboxes:function(){return t},showList:function(e,i,s){if(!BX.type.isNotEmptyString(s.placeholder)){s.placeholder=BX.message(s.required?"MAIN_MAIL_CONFIRM_MENU_UNKNOWN":"MAIN_MAIL_CONFIRM_MENU_PLACEHOLDER")}if(!(s.settings&&s.settings.length)){s.settings=[]}if(!BX.type.isFunction(s.callback)){s.callback=function(){}}if(typeof s.popupSettings!="object"){s.popupSettings={}}s.popupSettings.className="main-mail-confirm-menu-content";s.popupSettings.offsetLeft=40;s.popupSettings.angle=true;s.popupSettings.closeByEsc=true;s.popupSettings.events={onFirstShow:function(e){if(e&&e.target&&e.target.contentContainer){BX.UI.Hint.init(e.target.contentContainer)}}};const r=!e.includes("crm_mail_template_edit_form");if(BX.UI.Mail?.SenderSelector&&n===null&&r){n=new BX.UI.Mail.SenderSelector({mailboxes:t,isSenderAvailable:o??false})}a[e]=s;if(n&&r){n.selectCallback=a[e].callback;n.showDialog(i);return}var d=[];var m=function(i,n){var o="apply";if(i&&i.target){var s="main-mail-confirm-menu-delete-icon";if(BX.hasClass(i.target,s)||BX.findParent(i.target,{class:s},n.layout.item)){o="delete"}if(BX.hasClass(i.target,"sender-hint")||BX.findParent(i.target,{class:"sender-hint"},n.layout.item)){o="edit"}}if("delete"==o){l.deleteSender(n.id,(function(){t=t.filter((function(e,t){return n.id!==e.id}));n.menuWindow.removeMenuItem(n.id);if(a[e].selected===n.formated){a[e].callback("",a[e].placeholder)}}))}else if("edit"===o){l.showEditForm(n.id,(function(t,i){var o=BX.util.htmlspecialchars(i);if(n.options&&n.options.mailbox){n.options.mailbox.name=t.name;n.options.mailbox.formated=i;if(n.options.mailbox.can_delete&&n.options.mailbox.id>0){o+=l.getItemIconsHtml()}}n.text=BX.util.htmlspecialchars(i);n.name=t.name;n.formated=i;n.layout.text.innerHTML=o;n.options.title=i;a[e].callback(i,BX.util.htmlspecialchars(i))}))}else{a[e].callback(n.formated,n.text);n.menuWindow.close()}};if(!s.required){d.push({text:BX.util.htmlspecialchars(s.placeholder),formated:"",onclick:m});d.push({delimiter:true})}if(t&&t.length>0){var u,c;for(var f in t){c="menu-popup-no-icon";u=BX.util.htmlspecialchars(t[f].formated);d.push({html:u,mailbox:t[f],formated:t[f].formated,onclick:m,className:c,id:0})}d.push({delimiter:true})}d.push({text:BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_MENU")),onclick:function(i,n){n.menuWindow.close();l.showForm((function(i){const n=`${i.name} <${i.email}>`;t.push({email:i.email,name:i.name,id:0,formated:n,can_delete:false});a[e].callback(n,BX.util.htmlspecialchars(n));BX.PopupMenu.destroy(e+"-menu")}))}});if(s.settings.length>0){d=d.concat(s.settings)}BX.PopupMenu.show(e+"-menu",i,d,s.popupSettings)},showForm:function(e,t){if(n){n.showProviderShowcase(e);return}window.step="email";var a;window.mode=t&&t.mode?t.mode:"add";var i=new BX.PopupWindow("add_from_email",null,{titleBar:BX.message("MAIN_MAIL_CONFIRM_TITLE"),draggable:true,closeIcon:true,lightShadow:true,contentColor:"white",contentNoPaddings:true,cacheable:false,content:BX("new_from_email_dialog_content").innerHTML,buttons:this.prepareDialogButtons(null,"add",t,e)});this.prepareDialog(i)},prepareDialog:function(t){t.formFieldHint=function(e,t,a){if(!e){return}var i=BX.findParent(e,{class:"new-from-email-dialog-cell"});var n=BX.findChildByClassName(i,"new-from-email-dialog-field-hint",true);BX.removeClass(i,"new-from-email-dialog-field-error");BX.removeClass(i,"new-from-email-dialog-field-warning");switch(t){case"error":BX.addClass(i,"new-from-email-dialog-field-error");break;case"warning":BX.addClass(i,"new-from-email-dialog-field-warning");break}if(typeof a!="undefined"&&a.length>0){BX.adjust(n,{html:a});BX.show(n,"block")}else{BX.hide(n,"block")}};t.hideNotify=function(){var e=BX.findChild(t.contentContainer,{class:"new-from-email-dialog-error"},true);if(e){BX.hide(e,"block")}};t.showNotify=function(e){var a=BX.findChild(t.contentContainer,{class:"new-from-email-dialog-error"},true);if(a){a.innerHTML=e;BX.show(a,"block")}};t.switchBlock=function(a,i){var n=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);var o=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-code-block",true);var l,s;if("code"!=step&&"code"==a){l=n;s=o;t.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_SAVE"));t.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_BACK"))}else if("code"==step&&"code"!=a){l=o;s=n;t.buttons[0].setName(BX.message("smtp"==a&&e.canCheckSmtp?"MAIN_MAIL_CONFIRM_SAVE":"MAIN_MAIL_CONFIRM_GET_CODE"));t.buttons[1].setName(BX.message("MAIN_MAIL_CONFIRM_CANCEL"))}step=a;if(l&&s){if(i){s.style.position="";s.style.height="";s.style.display="";l.style.display="none"}else{l.style.height=l.offsetHeight+"px";l.offsetHeight;l.style.height="0px";s.style.position="absolute";s.style.height="";s.style.display="";var r=s.offsetHeight;s.style.height="0px";s.style.position="";s.offsetHeight;s.style.height=r+"px"}}};var a=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-smtp-link",true);var i=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-smtp-block",true);var n=BX.findChildByClassName(t.contentContainer,"new-from-email-smtp-use-limit",true);if(n){BX.bind(n,"click",(function(){var e=BX.findChildByClassName(t.contentContainer,"new-from-email-smtp-use-limit",true);var a=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);var i=BX.findChild(a,{attr:{"data-name":"smtp-limit"}},true);i.disabled=!e.checked}))}if(a&&i){BX.bind(a,"click",(a=>{var n=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);n.style.height="";if("smtp"==step){step="email";BX.hide(i,"table-row-group");t.buttons[0].setName(BX.message("MAIN_MAIL_CONFIRM_GET_CODE"))}else{step="smtp";BX.show(i,"table-row-group");t.buttons[0].setName(BX.message(e.canCheckSmtp?"MAIN_MAIL_CONFIRM_SAVE":"MAIN_MAIL_CONFIRM_GET_CODE"))}a.preventDefault()}))}if("confirm"==window.mode){t.switchBlock("code",true);t.setOverlay(true)}BX.UI.Hint.init(t.contentContainer);t.show();var o=BX.findChildByClassName(t.contentContainer,"new-from-email-dialog-email-block",true);var l=BX.findChild(o,{attr:{"data-name":"name"}},true);var s=BX.findChild(o,{attr:{"data-name":"email"}},true);if(l.value.length>0){s.focus()}else{l.focus()}},showEditForm:function(e,t){window.step="email";window.mode="edit";var a=this;var n=new BX.PopupWindow("edit_from_email",null,{titleBar:BX.message("MAIN_MAIL_CONFIRM_EDIT_TITLE"),draggable:true,closeIcon:true,lightShadow:true,contentColor:"white",contentNoPaddings:true,cacheable:false,content:BX("new_from_email_dialog_content").innerHTML,events:{onPopupShow:function(){BX.ajax({url:BX.util.add_url_param(i,{act:"info",senderId:e}),method:"GET",dataType:"json",onsuccess:function(e){var t=BX.findChildByClassName(n.contentContainer,"new-from-email-dialog-email-block",true);var i=BX.findChildByClassName(n.contentContainer,"new-from-email-dialog-smtp-link",true);var o=BX.findChildByClassName(n.contentContainer,"new-from-email-smtp-use-limit",true);var l=BX.findChild(n.contentContainer,{attr:{"data-name":"public"}},true);var s=BX.findChild(t,{attr:{"data-name":"name"}},true);var r=BX.findChild(t,{attr:{"data-name":"email"}},true);var d=BX.findChild(t,{attr:{"data-name":"smtp-server"}},true);var m=BX.findChild(t,{attr:{"data-name":"smtp-port"}},true);var u=BX.findChild(t,{attr:{"data-name":"smtp-ssl"}},true);var c=BX.findChild(t,{attr:{"data-name":"smtp-login"}},true);var f=BX.findChild(t,{attr:{"data-name":"smtp-limit"}},true);s.value=e.name||"";r.value=BX.util.htmlspecialchars(e.email);d.value=BX.util.htmlspecialchars(e.server||"");m.value=BX.util.htmlspecialchars(e.port||"");c.value=BX.util.htmlspecialchars(e.login||"");if(e.isPublic>0){l.checked=true}var p=typeof e.limit==="undefined"||e.limit===null;f.value=p?f.value:e.limit;if(!p){o.checked=true;f.disabled=false}if(e.protocol==="smtps"){u.checked=true}if(e.isOauth){a.disableSmtpFields(n.contentContainer);n.setTitleBar(BX.Loc.getMessage("MAIN_MAIL_CONFIRM_EDIT_TITLE_EMAIL",{"#EMAIL#":BX.util.htmlspecialchars(e.email)}))}if(e.server){BX.fireEvent(i,"click")}},onfailure:function(e){}})}},buttons:this.prepareDialogButtons(e,"edit",null,t)});this.prepareDialog(n)},prepareDialogButtons:function(e,t,a,n){return[new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_GET_CODE"),className:"popup-window-button-create",events:{click:function(o,l){var s=this;var r=s.popupWindow;if(BX.hasClass(s.buttonNode,"popup-window-button-wait"))return;var d=BX.findChildByClassName(r.contentContainer,"new-from-email-dialog-email-block",true);var m=BX.findChildByClassName(r.contentContainer,"new-from-email-dialog-code-block",true);var u=BX.findChild(d,{attr:{"data-name":"name"}},true);var c=BX.findChild(d,{attr:{"data-name":"email"}},true);var f=BX.findChild(m,{attr:{"data-name":"code"}},true);var p=BX.findChild(r.contentContainer,{attr:{"data-name":"public"}},true);var h=BX.findChild(d,{attr:{"data-name":"smtp-server"}},true);var B=BX.findChild(d,{attr:{"data-name":"smtp-port"}},true);var _=BX.findChild(d,{attr:{"data-name":"smtp-ssl"}},true);var C=BX.findChild(d,{attr:{"data-name":"smtp-login"}},true);var w=BX.findChild(d,{attr:{"data-name":"smtp-password"}},true);var X=BX.findChild(d,{attr:{"data-name":"smtp-limit"}},true);r.formFieldHint(w);if("email"==window.step||"smtp"==window.step){f.value="";var I="[=a-z0-9_+~'!$&*^`|#%/?{}-]";var M=new RegExp("^"+I+"+(\\."+I+"+)*@([a-z0-9-]+\\.)+[a-z0-9-]{2,20}$","i");if(!c.value.match(M)){r.showNotify(BX.message(c.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_EMAIL":"MAIN_MAIL_CONFIRM_EMPTY_EMAIL"));return}}if("smtp"==window.step){if(!h.value.match(/^([a-z0-9-]+\.)+[a-z0-9-]{2,20}$/)){r.showNotify(BX.message(h.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_SERVER":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_SERVER"));return}if(!B.value.match(/^[0-9]+$/)||B.value<1||B.value>65535){r.showNotify(BX.message(B.value.length>0?"MAIN_MAIL_CONFIRM_INVALID_SMTP_PORT":"MAIN_MAIL_CONFIRM_EMPTY_SMTP_PORT"));return}if(!(C.value.length>0)){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_LOGIN"));return}if(!e&&w.value.length>0){if(w.value.match(/^\^/)){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_INVALID_SMTP_PASSWORD_CARET"));return}else if(w.value.match(/\x00/)){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_INVALID_SMTP_PASSWORD_NULL"));return}else if(w.value.match(/^\s|\s$/)){r.formFieldHint(w,"warning",BX.message("MAIN_MAIL_CONFIRM_SPACE_SMTP_PASSWORD"))}}else if(!e){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_SMTP_PASSWORD"));return}}if("code"==window.step){if(f.value.length==0){r.showNotify(BX.message("MAIN_MAIL_CONFIRM_EMPTY_CODE"));return}}r.hideNotify();BX.addClass(s.buttonNode,"popup-window-button-wait");var g={id:e,name:u.value,email:c.value,smtp:{},code:"",public:p.checked?p.value:""};if("smtp"==window.step){g.smtp={server:h.value,port:B.value,ssl:_.checked?_.value:"",login:C.value,password:w.value,limit:X.disabled?null:X.value}}if("code"==window.step){g.code=f.value}if(a&&a.data){for(var N in a.data){if(a.data.hasOwnProperty(N)){g[N]=a.data[N]}}}BX.ajax({url:BX.util.add_url_param(i,{act:t}),method:"POST",dataType:"json",data:g,onsuccess:function(t){BX.removeClass(s.buttonNode,"popup-window-button-wait");if(t.senderId){e=t.senderId}if(t.result=="error"){r.showNotify(t.error)}else if(("email"==window.step||"smtp"==window.step)&&!t.confirmed){r.formFieldHint(w);r.switchBlock("code")}else{s.popupWindow.close();if(n&&BX.type.isFunction(n)){var a=u.value.length>0?u.value:BX.message("MAIN_MAIL_CONFIRM_USER_FULL_NAME");n({name:a,email:c.value,id:e},a.length>0?a+" <"+c.value+">":c.value)}}},onfailure:function(){BX.removeClass(s.buttonNode,"popup-window-button-wait");r.showNotify(BX.message("MAIN_MAIL_CONFIRM_AJAX_ERROR"))}})}}}),new BX.PopupWindowButton({text:BX.message("MAIN_MAIL_CONFIRM_CANCEL"),className:"popup-window-button-link",events:{click:function(){var e=this.popupWindow;if("code"==window.step&&"confirm"!=window.mode){var t=BX.findChildByClassName(e.contentContainer,"new-from-email-dialog-smtp-block",true);e.switchBlock(t&&t.offsetHeight>0?"smtp":"email")}else{this.popupWindow.close()}}}})]},updateListCanDel:function(e){BX.ajax({url:BX.util.add_url_param(i,{act:"sendersListCanDel"}),method:"POST",dataType:"json",data:{},onsuccess:function(a){if(a.result=="error"){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}else{t=t.filter((function(e,t){if(!e.can_delete){return true}for(var i in a.mailboxes){if(a.mailboxes[i].id==e.id){return true}}return false}));BX.PopupMenu.destroy(e+"-menu")}},onfailure:function(e){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")})}})},deleteSender:function(e,t){BX.UI.Dialogs.MessageBox.show({message:BX.message("MAIN_MAIL_CONFIRM_DELETE_SENDER_CONFIRM"),modal:true,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:function(a){return new Promise((function(a,n){BX.ajax({url:BX.util.add_url_param(i,{act:"delete"}),method:"POST",dataType:"json",data:{senderId:e},onsuccess:function(e){if(e.result=="error"){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")});n(e)}else{if(BX.type.isFunction(t)){t()}a(e)}},onfailure:function(e){BX.UI.Notification.Center.notify({content:BX.message("MAIN_MAIL_DELETE_SENDER_ERROR")});n(e)}})}))},onCancel:function(e){e.close()}})},disableSmtpFields:function(e){var t=BX.findChildByClassName(e,"new-from-email-dialog-email-block",true);var a=BX.findChild(t,{attr:{"data-name":"email"}},true);this.disableAndHide(a);var i=BX.findChild(t,{attr:{"data-name":"smtp-server"}},true);this.disableAndHide(i);var n=BX.findChild(t,{attr:{"data-name":"smtp-port"}},true);this.disableAndHide(n);var o=BX.findChild(t,{attr:{"data-name":"smtp-ssl"}},true);this.disableAndHide(o);var l=BX.findChild(t,{attr:{"data-name":"smtp-login"}},true);this.disableAndHide(l);var s=BX.findChild(t,{attr:{"data-name":"smtp-password"}},true);this.disableAndHide(s);var r=BX.findChild(t,{class:"new-from-email-dialog-smtp-warning"},true);this.hideParentDialogRow(r);var d=BX.findChild(t,{class:"new-from-email-dialog-block-content-message"},true);if(d){BX.hide(d)}},hideParentDialogRow:function(e){if(e){var t=e.closest(".new-from-email-dialog-row");if(t){BX.hide(t)}}},disableAndHide:function(e){this.hideParentDialogRow(e);this.safeDisable(e)},safeDisable:function(e){if(e){e.setAttribute("disabled","disabled")}},getItemIconsHtml:function(){return'<span class="main-mail-confirm-menu-delete-icon popup-window-close-icon popup-window-titlebar-close-icon"\t\t\t\t\t\t\t\ttitle="'+BX.util.htmlspecialchars(BX.message("MAIN_MAIL_CONFIRM_DELETE"))+'"></span>\t\t\t'}};window.BXMainMailConfirm=l})();
//# sourceMappingURL=script.map.js