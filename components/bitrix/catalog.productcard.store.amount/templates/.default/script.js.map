{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Event, Reflection, Type, Uri } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { EnableWizardOpener, AnalyticsContextList } from 'catalog.store-enable-wizard';\n\nclass ProductStoreGridManager\n{\n\tgrid = null;\n\ttotalWrapper = null;\n\n\tconstructor(settings = {})\n\t{\n\t\tthis.gridId = settings.gridId;\n\t\tthis.grid = BX.Main.gridManager.getInstanceById(this.gridId);\n\t\tthis.signedParameters = settings.signedParameters;\n\t\tthis.totalWrapperId = settings.totalWrapperId || null;\n\t\tthis.inventoryManagementLink = settings.inventoryManagementLink || null;\n\t\tthis.productId = settings.productId;\n\t\tthis.reservedDealsSliderLink = settings.reservedDealsSliderLink;\n\n\t\tif (this.totalWrapperId)\n\t\t{\n\t\t\tthis.totalWrapper = BX(this.totalWrapperId);\n\t\t\tthis.refreshTotalWrapper();\n\t\t}\n\n\t\tthis.subscribeEvents();\n\t\tthis.bindSliderToReservedQuantityNodes();\n\t}\n\n\tsubscribeEvents()\n\t{\n\t\tthis.onGridUpdatedHandler = this.onGridUpdated.bind(this);\n\t\tEventEmitter.subscribe('Grid::updated', this.onGridUpdatedHandler);\n\t}\n\n\tbindSliderToReservedQuantityNodes()\n\t{\n\t\tconst rows = this.grid.getRows().getRows();\n\t\trows.forEach((row) => {\n\t\t\tif (row.isBodyChild() && !row.isTemplate())\n\t\t\t{\n\t\t\t\tconst reservedQuantityNode = row.getNode().querySelector(\n\t\t\t\t\t'.main-grid-cell-content-store-amount-reserved-quantity'\n\t\t\t\t);\n\t\t\t\tif (Type.isDomNode(reservedQuantityNode))\n\t\t\t\t{\n\t\t\t\t\tEvent.bind(\n\t\t\t\t\t\treservedQuantityNode,\n\t\t\t\t\t\t'click',\n\t\t\t\t\t\tthis.openDealsWithReservedProductSlider.bind(this, this.productId, row.getId())\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t}\n\t\t});\n\t}\n\n\topenDealsWithReservedProductSlider(rowId, storeId = 0)\n\t{\n\t\tif (!this.reservedDealsSliderLink)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst sliderLink = new Uri(this.reservedDealsSliderLink);\n\t\tsliderLink.setQueryParam('productId', rowId);\n\t\tif (storeId > 0)\n\t\t{\n\t\t\tsliderLink.setQueryParam('storeId', storeId);\n\t\t}\n\t\tBX.SidePanel.Instance.open(sliderLink.toString(), {\n\t\t\tallowChangeHistory: false,\n\t\t\tcacheable: false\n\t\t});\n\t}\n\n\tonGridUpdated(event: BaseEvent)\n\t{\n\t\tconst [grid, eventArgs] = event.getCompatData();\n\n\t\tif (!grid || grid.getId() !== this.getGridId())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.bindSliderToReservedQuantityNodes();\n\t\tthis.refreshTotalWrapper();\n\t}\n\n\tgetGridId()\n\t{\n\t\treturn this.gridId;\n\t}\n\n\treloadGrid()\n\t{\n\t\tif (this.grid)\n\t\t{\n\t\t\tthis.grid.reload();\n\t\t}\n\t}\n\n\tsetTotalData(totalData)\n\t{\n\t\tfor (var propertyId in totalData)\n\t\t{\n\t\t\tif (totalData.hasOwnProperty(propertyId))\n\t\t\t{\n\t\t\t\tthis.setTotalDataBySelector(`#${propertyId}`, totalData[propertyId]);\n\t\t\t}\n\t\t}\n\t}\n\n\tsetTotalDataBySelector(selector, data)\n\t{\n\t\tif (this.totalWrapper)\n\t\t{\n\t\t\tvar totalWrapperItem = this.totalWrapper.querySelector(selector);\n\n\t\t\tif (totalWrapperItem)\n\t\t\t{\n\t\t\t\ttotalWrapperItem.innerHTML = data;\n\t\t\t\treturn true;\n\t\t\t}\n\t\t}\n\t\treturn false;\n\t}\n\n\thideTotalData()\n\t{\n\t\tBX.hide(this.totalWrapper);\n\t}\n\n\tshowTotalData()\n\t{\n\t\tBX.show(this.totalWrapper);\n\t}\n\n\trefreshTotalWrapper()\n\t{\n\t\tif (this.totalWrapper)\n\t\t{\n\t\t\t//this.grid.tableFade();\n\t\t\tBX.ajax.runComponentAction(\n\t\t\t\t'bitrix:catalog.productcard.store.amount',\n\t\t\t\t'getStoreAmountTotal',\n\t\t\t\t{\n\t\t\t\t\tmode: 'ajax',\n\t\t\t\t\tdata: {\n\t\t\t\t\t\tsignedParameters: this.signedParameters,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t).then(response => {\n\t\t\t\tconst amount = response.data.AMOUNT || '';\n\t\t\t\tconst quantity = response.data.QUANTITY || '';\n\t\t\t\tconst quantityReserved = response.data.QUANTITY_RESERVED || '';\n\t\t\t\tconst quantityCommon = response.data.QUANTITY_COMMON || '';\n\n\t\t\t\tif (amount || quantity || quantityCommon || quantityReserved)\n\t\t\t\t{\n\t\t\t\t\tvar totalData = {\n\t\t\t\t\t\t'total_amount': amount,\n\t\t\t\t\t\t'total_quantity': quantity,\n\t\t\t\t\t\t'total_quantity_common': quantityCommon,\n\t\t\t\t\t\t'total_quantity_reserved': quantityReserved,\n\t\t\t\t\t};\n\n\t\t\t\t\tthis.setTotalData(totalData);\n\n\t\t\t\t\tif (BX.isNodeHidden(this.totalWrapper))\n\t\t\t\t\t{\n\t\t\t\t\t\tthis.showTotalData();\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\tthis.hideTotalData();\n\t\t\t\t}\n\t\t\t\t//this.grid.tableUnfade();\n\t\t\t});\n\t\t}\n\t}\n\n\topenInventoryManagementSlider()\n\t{\n\t\tif (this.inventoryManagementLink)\n\t\t{\n\t\t\tnew EnableWizardOpener().open(\n\t\t\t\tthis.inventoryManagementLink,\n\t\t\t\t{\n\t\t\t\t\turlParams: {\n\t\t\t\t\t\tanalyticsContextSection: AnalyticsContextList.PRODUCT_CARD,\n\t\t\t\t\t},\n\t\t\t\t\tdata: {\n\t\t\t\t\t\topenGridOnDone: false,\n\t\t\t\t\t},\n\t\t\t\t\tevents: {\n\t\t\t\t\t\tonCloseComplete: function(event) {\n\t\t\t\t\t\t\tconst slider = event.getSlider();\n\t\t\t\t\t\t\tif (!slider)\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t\t}\n\n\t\t\t\t\t\t\tif (slider.getData().get('isInventoryManagementEnabled'))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\twindow.top.location.reload();\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t},\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t);\n\t\t}\n\t}\n}\n\nReflection.namespace('BX.Catalog').ProductStoreGridManager = ProductStoreGridManager;\n"],"names":["ProductStoreGridManager","settings","gridId","grid","BX","Main","gridManager","getInstanceById","signedParameters","totalWrapperId","inventoryManagementLink","productId","reservedDealsSliderLink","totalWrapper","refreshTotalWrapper","subscribeEvents","bindSliderToReservedQuantityNodes","onGridUpdatedHandler","onGridUpdated","bind","EventEmitter","subscribe","rows","getRows","forEach","row","isBodyChild","isTemplate","reservedQuantityNode","getNode","querySelector","Type","isDomNode","Event","openDealsWithReservedProductSlider","getId","rowId","storeId","sliderLink","Uri","setQueryParam","SidePanel","Instance","open","toString","allowChangeHistory","cacheable","event","getCompatData","eventArgs","getGridId","reload","totalData","propertyId","hasOwnProperty","setTotalDataBySelector","selector","data","totalWrapperItem","innerHTML","hide","show","ajax","runComponentAction","mode","then","response","amount","AMOUNT","quantity","QUANTITY","quantityReserved","QUANTITY_RESERVED","quantityCommon","QUANTITY_COMMON","setTotalData","isNodeHidden","showTotalData","hideTotalData","EnableWizardOpener","urlParams","analyticsContextSection","AnalyticsContextList","PRODUCT_CARD","openGridOnDone","events","onCloseComplete","slider","getSlider","getData","get","window","top","location","Reflection","namespace"],"mappings":"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"}