this.BX=this.BX||{};(function(t,e,i,s,n,o,r,a,l,h){"use strict";let d=t=>t,c,u;class m extends l.DateTimeControl{create(){this.DOM.dateTimeWrap=this.DOM.outerContent.querySelector(`#${this.UID}_datetime_container`);this.DOM.editor=this.DOM.outerContent.querySelector(`#${this.UID}_datetime_editor`);this.DOM.fromDate=this.DOM.outerContent.querySelector(`#${this.UID}_date_from`);this.DOM.toDate=this.DOM.outerContent.querySelector(`#${this.UID}_date_to`);this.DOM.fromTime=this.DOM.outerContent.querySelector(`#${this.UID}_time_from`);this.DOM.toTime=this.DOM.outerContent.querySelector(`#${this.UID}_time_to`);this.fromTimeControl=new l.TimeSelector({input:this.DOM.fromTime,onChangeCallback:this.handleTimeFromChange.bind(this)});this.toTimeControl=new l.TimeSelector({input:this.DOM.toTime,onChangeCallback:this.handleTimeToChange.bind(this)});this.DOM.fullDay=this.DOM.outerContent.querySelector(`#${this.UID}_date_full_day`);this.DOM.defTimezoneWrap=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_default_wrap`);this.DOM.defTimezone=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_default`);this.DOM.fromTz=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_from`);this.DOM.toTz=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_to`);this.DOM.tzButton=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_btn`);this.DOM.tzOuterCont=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_wrap`);this.DOM.tzCont=this.DOM.outerContent.querySelector(`#${this.UID}_timezone_inner_wrap`);this.DOM.outerContent.querySelector(`#${this.UID}_timezone_hint`).title=a.Loc.getMessage("EC_EVENT_TZ_HINT");this.DOM.outerContent.querySelector(`#${this.UID}_timezone_default_hint`).title=a.Loc.getMessage("EC_EVENT_TZ_DEF_HINT");this.prepareModel();this.bindEventHandlers();if(BX.isAmPmMode()){this.DOM.fromTime.style.minWidth="8em";this.DOM.toTime.style.minWidth="8em"}else{this.DOM.fromTime.style.minWidth="6em";this.DOM.toTime.style.minWidth="6em"}}prepareModel(){a.Dom.adjust(this.DOM.fromDate,{props:{autocomplete:"off"}});a.Dom.adjust(this.DOM.toDate,{props:{autocomplete:"off"}});a.Dom.adjust(this.DOM.fromTime,{props:{autocomplete:"off"}});a.Dom.adjust(this.DOM.toTime,{props:{autocomplete:"off"}})}setReadonly(t){const e=this.getValue();let i="";const s=h.Util.formatDateUsable(e.from,true,true);const n=h.Util.formatDateUsable(e.to,true,true);const o=this.DOM.fromTime.value;const r=this.DOM.toTime.value;i+=s+", ";if(e.fullDay){if(s===n){i+=a.Loc.getMessage("EC_ALL_DAY")}else{i+=" - "}}else{i+=o+" - "+r}if(!e.fullDay&&s!==n){i+=", "+n}let l="";if(a.Type.isStringFilled(t)){l=a.Tag.render(c||(c=d`
				<div class="calendar-date-selector-readonly-timezone" title="${0}">
					<div class="calendar-date-selector-readonly-timezone-icon"></div>
				</div>
			`),t)}a.Dom.style(this.DOM.editor,"display","none");const m=a.Tag.render(u||(u=d`
			<div class="calendar-options-item-column-right">
				<div class="calendar-field calendar-date-selector-readonly">
					${0}
					${0}
				</div>
			</div>
		`),i,l);a.Dom.append(m,this.DOM.dateTimeWrap)}}let p=t=>t,f,y,D,g,C,E,S,O,M,T,I,v,b,_,L,w;class A{constructor(t={}){var e,i,s,n;this.DOM={};this.uid=null;this.sliderId="calendar:edit-entry-slider";this.zIndex=3100;this.denyClose=false;this.formType="slider_main";this.STATE={READY:1,REQUEST:2,ERROR:3};this.sections=[];this.sectionIndex={};this.trackingUsersList=[];this.userSettings={};this.prevUserList=[];this.loadedAccessibilityData={};this.eventOptions={};this.name=t.name||"eventeditform";this.type=t.type||"user";this.isLocationCalendar=t.isLocationCalendar||false;this.locationAccess=t.locationAccess||false;this.isProjectFeatureEnabled=h.Util.isProjectFeatureEnabled()||false;this.locationCapacity=t.locationCapacity||0;this.roomsManager=t.roomsManager||null;this.userId=t.userId||parseInt(a.Loc.getMessage("USER_ID"));this.ownerId=t.ownerId;this.entryId=parseInt(t.entryId)||null;this.entry=t.entry||null;this.eventOptions=((e=this.entry)==null?void 0:(i=e.data)==null?void 0:i.OPTIONS)||{};this.formDataValue=t.formDataValue||{};this.emitter=new o.EventEmitter;this.emitter.setEventNamespace("BX.Calendar.EventEditForm");this.BX=h.Util.getBX();this.isCollabUser=((s=t.calendarContext)==null?void 0:s.isCollabUser)||false;this.analyticsChatId=t.createChatId||null;this.analyticsSubSection=t.analyticsSubSection||this.getFormAnalyticsContext();if(this.isCollabUser){h.Util.setCalendarContext(t.calendarContext)}else{var r;this.context=(r=h.Util.getCalendarContext())!=null?r:t.calendarContext;if(!h.Util.getCalendarContext()){h.Util.setCalendarContext(this.context)}}this.isOpenEvent=(((n=this.entry)==null?void 0:n.data["CAL_TYPE"])||this.type)==="open_event";this.plannerEnabled=true;this.sectionSelectorEnabled=!this.isOpenEvent;this.attendeesControlEnabled=!this.isOpenEvent;this.formSettings={pinnedFields:{}};if(!this.ownerId&&this.type==="user"){this.ownerId=this.userId}if(a.Type.isDate(t.entryDateFrom)&&!this.formDataValue.from){this.formDataValue.from=t.entryDateFrom;this.formDataValue.to=new Date(t.entryDateFrom.getTime()+3600)}this.participantsEntityList=a.Type.isArray(t.participantsEntityList)?t.participantsEntityList:[];this.participantsSelectorEntityList=a.Type.isArray(t.participantsSelectorEntityList)?t.participantsSelectorEntityList:[];if(t.entryName&&!this.entryId){this.formDataValue.name=t.entryName}if(t.entryDescription&&!this.entryId){this.formDataValue.description=t.entryDescription}if(t.jumpToControl){this.jumpToControl=t.jumpToControl}if(this.plannerEnabled){this.refreshPlanner=a.Runtime.debounce(this.refreshPlannerState,100,this)}this.state=this.STATE.READY;this.doShowConfirmPopup=true;this.sliderOnClose=this.hideWithConfirm.bind(this);this.handlePullBind=this.handlePull.bind(this);this.keyHandlerBind=this.keyHandler.bind(this);this.lastUsedSaveOptions={};this.timezoneHint="";this.isAvailable=true}getFormAnalyticsContext(){if(this.analyticsChatId){return"chat_textarea"}if(this.type==="group"){return"calendar_collab"}return"calendar_personal"}initInSlider(t,e){this.sliderId=t.getUrl();this.BX.addCustomEvent(t,"SidePanel.Slider:onLoad",this.onLoadSlider.bind(this));this.BX.addCustomEvent(t,"SidePanel.Slider:onClose",this.sliderOnClose);this.BX.addCustomEvent(t,"SidePanel.Slider:onBeforeCloseComplete",this.destroy.bind(this));this.setCurrentEntry(this.entry||null);this.createContent(t).then((t=>{if(a.Type.isFunction(e)){e(t)}}));this.opened=true;this.bindEventHandlers()}canEdit(){var t;if(a.Type.isBoolean((t=this.entry.permissions)==null?void 0:t.edit)){return this.entry.permissions.edit}if(this.entry.isMeeting()&&this.entry.sectionId!==this.getCurrentSectionId()){return false}if(this.entry.isResourcebooking()){return false}return new n.CalendarSection(this.getCurrentSection()).canDo("edit")}show(t={}){this.setCurrentEntry(t.entry);if(t.formType){this.formType=t.formType}this.BX.SidePanel.Instance.open(this.sliderId,{contentCallback:this.createContent.bind(this),label:{text:a.Loc.getMessage("CALENDAR_EVENT"),bgColor:"#55D0E0"},events:{onClose:this.sliderOnClose,onCloseComplete:this.destroy.bind(this),onLoad:this.onLoadSlider.bind(this)}});this.opened=true;this.bindEventHandlers()}isOpened(){return this.opened}bindEventHandlers(){a.Event.bind(document,"keydown",this.keyHandlerBind);o.EventEmitter.subscribe("onPullEvent-calendar",this.handlePullBind);this.mouseUpNodeCheck=null;a.Event.bind(document,"mousedown",(t=>{this.mousedownTarget=t.target||t.srcElement}));a.Event.bind(document,"mouseup",(t=>{const e=t.target||t.srcElement;if(this.mousedownTarget!==e){this.mouseUpNodeCheck=false}setTimeout((()=>{this.mouseUpNodeCheck=null}),0)}));o.EventEmitter.subscribe("Calendar.LocationControl.onValueChange",(()=>{if(this.locationBusyAlert){a.Dom.remove(this.locationBusyAlert);this.locationBusyAlert=null}}));this.BX.addCustomEvent(window,"onCalendarControlChildPopupShown",this.BX.proxy(this.denySliderClose,this));this.BX.addCustomEvent(window,"onCalendarControlChildPopupClosed",this.BX.proxy(this.allowSliderClose,this))}onLoadSlider(t){this.slider=t.getSlider();this.DOM.content=this.slider.layout.content;this.sliderId=this.slider.getUrl();if(!this.isAvailable){return}this.BX.html(this.slider.layout.content,this.slider.getData().get("sliderContent"));this.initControls(this.uid);this.setFormValues();if(a.Type.isStringFilled(this.jumpToControl)){if(this.jumpToControl==="userSelector"){const t=this.DOM.content.querySelector(`#${this.uid}_attendees_selector`);a.Dom.style(t,"transition","300ms background ease");setTimeout((()=>this.highlightField(t)),900)}if(this.jumpToControl==="location"){const t=document.querySelector(`[data-bx-block-placeholer=${this.jumpToControl}]`);a.Dom.style(t,"transition","300ms background ease");setTimeout((()=>this.highlightField(t)),900)}}a.Event.bind(this.DOM.content,"wheel",(()=>{var t;return(t=this.highlightFieldScrollAnimation)==null?void 0:t.stop()}))}close(){if(!this.checkDenyClose()){this.state=this.STATE.READY;this.BX.SidePanel.Instance.close()}}save(t={}){if(this.state===this.STATE.REQUEST||this.DOM.locationRepeatBusyErrorPopup){return false}t=a.Type.isPlainObject(t)?t:{};const i=this.getFormDataChanges();if(this.isEditForm()&&i.length===0){this.BX.SidePanel.Instance.close();return true}if(!this.userSettings.sendFromEmail&&this.hasExternalEmailUsers()&&this.canEdit()&&!t.emailConfirmDialogShown){e.EntryManager.showConfirmedEmailDialog({callback:e=>{if(e.sendFromEmail){this.userSettings.sendFromEmail=e.sendFromEmail}t.emailConfirmDialogShown=true;this.save(t)}});return false}if(this.entry.id&&this.entry.isRecursive()&&!t.confirmed&&this.getFormDataChanges(["section"]).length>0){e.EntryManager.showConfirmEditDialog({callback:e=>{t.recursionMode=this.entry.isFirstInstance()&&e.recursionMode==="next"?"all":e.recursionMode;t.confirmed=true;this.lastUsedSaveOptions=t;this.save(t)},canEditOnlyThis:this.canEditOnlyThis()});return false}if(this.entry.id&&this.entry.isMeeting()&&t.sendInvitesAgain===undefined&&i.includes("date&time")&&this.entry.getAttendees().find((t=>t.STATUS==="N"))){e.EntryManager.showReInviteUsersDialog({callback:e=>{t.sendInvitesAgain=e.sendInvitesAgain;this.lastUsedSaveOptions=t;this.save(t)}});return false}if(this.entry.id&&this.entry.isRecursive()&&!t.confirmed&&i.includes("section")){t.recursionMode=this.entry.isFirstInstance()?"all":"next"}a.Dom.addClass(this.DOM.saveBtn,this.BX.UI.Button.State.CLOCKING);a.Dom.addClass(this.DOM.closeBtn,this.BX.UI.Button.State.DISABLED);this.state=this.STATE.REQUEST;this.DOM.form.id.value=this.entry.id||0;this.DOM.form.location.value=this.locationSelector.getTextValue();if(this.editor){this.editor.SaveContent()}const s=this.getCurrentSection();if(s&&s.COLOR.toLowerCase()!==this.colorSelector.getValue().toLowerCase()){this.DOM.form.color.value=this.colorSelector.getValue()}if(t.recursionMode){this.DOM.form.current_date_from.value=h.Util.formatDate(this.entry.from);this.DOM.form.rec_edit_mode.value=t.recursionMode}else{this.DOM.form.current_date_from.value=null;this.DOM.form.rec_edit_mode.value=null}if(t.sendInvitesAgain!==undefined){this.DOM.form.appendChild(a.Tag.render(f||(f=p`<input name="sendInvitesAgain" type="hidden" value="${0}">`),t.sendInvitesAgain?"Y":"N"))}if(!this.DOM.form.requestUid){this.DOM.requestUid=this.DOM.form.appendChild(a.Tag.render(y||(y=p`<input name="requestUid" type="hidden">`)))}if(!this.DOM.form.meeting_host){this.DOM.meeting_host=this.DOM.form.appendChild(a.Tag.render(D||(D=p`<input type="hidden" name="meeting_host" value="${0}">`),this.entry.data.MEETING_HOST||"0"))}if(!this.DOM.form.chat_id){this.DOM.chat_id=this.DOM.form.appendChild(a.Tag.render(g||(g=p`<input type="hidden" name="chat_id" value="${0}">`),this.entry.data.MEETING?this.entry.data.MEETING.CHAT_ID:0))}this.DOM.requestUid.value=h.Util.registerRequestId();let n;if(this.attendeesControlEnabled){n=this.getUserSelectorEntityList();a.Dom.clean(this.DOM.userSelectorValueWarp);n.forEach(((t,e)=>{this.DOM.userSelectorValueWarp.appendChild(a.Tag.render(C||(C=p`
				<input type="hidden" name="attendeesEntityList[${0}][entityId]" value="${0}">
			`),e,t.entityId));this.DOM.userSelectorValueWarp.appendChild(a.Tag.render(E||(E=p`
				<input type="hidden" name="attendeesEntityList[${0}][id]" value="${0}">
			`),e,t.id))}))}let r=!this.entry.id||this.checkCurrentUsersAccessibility();if(!r&&i.includes("codes")){const t=this.entry.getAttendeesEntityList();n.forEach((e=>{if(!t.find((t=>e.entityId===t.entityId&&Number(e.id)===Number(t.id)))){if(e.entityId==="user"){this.DOM.userSelectorValueWarp.appendChild(a.Tag.render(S||(S=p`
							<input type="hidden" name="newAttendeesList[]" value="${0}">
						`),parseInt(e.id)))}else{r=true}}}))}if(this.attendeesControlEnabled){this.DOM.userSelectorValueWarp.appendChild(a.Tag.render(O||(O=p`
				<input type="hidden" name="checkCurrentUsersAccessibility" value="${0}">
			`),r?"Y":"N"))}if(this.isOpenEvent){const t=this.categoryTagSelector.getDialog().getSelectedItems();const e=t[0].id;this.DOM.form.appendChild(a.Tag.render(M||(M=p`<input type="hidden" name="category" value="${0}">`),e))}if(this.analyticsSubSection){this.DOM.form.appendChild(a.Tag.render(T||(T=p`<input type="hidden" name="analyticsSubSection" value="${0}">`),this.analyticsSubSection))}if(this.analyticsChatId){this.DOM.form.appendChild(a.Tag.render(I||(I=p`<input type="hidden" name="analyticsChatId" value="${0}">`),this.analyticsChatId))}this.DOM.form.doCheckOccupancy.value=t.doCheckOccupancy||"Y";const d=new FormData(this.DOM.form);this.BX.ajax.runAction("calendar.api.calendarentryajax.editEntry",{data:d}).then((async s=>{if(this.canEditOnlyThis()&&i.includes("color")){var n,r,h;const t=(n=s.data)==null?void 0:(r=n.eventList)==null?void 0:r.find((t=>t.DATE_FROM.includes(d.get("date_from"))&&parseInt(t.OWNER_ID,10)===parseInt(this.ownerId,10)));const e=(h=t==null?void 0:t.ID)!=null?h:this.entryId;await this.BX.ajax.runAction("calendar.api.calendarajax.updateColor",{data:{entryId:e,color:this.colorSelector.getValue().toLowerCase()}})}if(this.isLocationCalendar){this.roomsManager.unsetHiddenRoom(l.Location.parseStringValue(this.DOM.form.location.value).room_id)}const c=this.getCurrentSection();if(c&&this.context&&this.context.sectionManager){this.unsetHiddenSection(c,this.context.sectionManager)}this.state=this.STATE.READY;this.allowSliderClose();this.doShowConfirmPopup=false;this.close();a.Dom.removeClass(this.DOM.closeBtn,this.BX.UI.Button.State.DISABLED);a.Dom.removeClass(this.DOM.saveBtn,this.BX.UI.Button.State.CLOCKING);if(s.data.entryId){if(this.entry.id){e.EntryManager.showEditEntryNotification(s.data.entryId)}else{e.EntryManager.showNewEntryNotification(s.data.entryId)}}if(a.Type.isArray(s.data.eventList)&&s.data.eventList.length>0&&s.data.eventList[0].REMIND&&s.data.eventList[0].REMIND.length>0){e.EntryManager.setNewEntryReminders(s.data.eventList[0].DT_SKIP_TIME==="Y"?"fullDay":"withTime",s.data.eventList[0].REMIND)}this.emitter.emit("onSave",new o.BaseEvent({data:{responseData:s.data,options:t}}));o.EventEmitter.emit("BX.Calendar:onEntrySave",new o.BaseEvent({data:{sliderId:this.sliderId,responseData:s.data,options:t}}))}),(t=>{a.Dom.removeClass(this.DOM.saveBtn,this.BX.UI.Button.State.CLOCKING);a.Dom.removeClass(this.DOM.closeBtn,this.BX.UI.Button.State.DISABLED);if(t.data&&a.Type.isPlainObject(t.data.busyUsersList)){this.handleBusyUsersError(t.data.busyUsersList);const e=[];t.errors.forEach((t=>{if(t.code!=="edit_entry_user_busy"){e.push(t)}}));t.errors=e}if(t.errors&&t.errors.length>0){this.showError(t.errors)}this.state=this.STATE.ERROR}));return true}canEditOnlyThis(){const t=this.entry.permissions;if(!t){return false}return t.edit_attendees&&t.edit_location&&!t.edit}handleBusyUsersError(t){const e=[];const i=[];for(const s in t){if(t.hasOwnProperty(s)){e.push(t[s]);i.push(s)}}this.busyUsersDialog=new l.BusyUsersDialog;this.busyUsersDialog.subscribe("onSaveWithout",(()=>{this.DOM.form.exclude_users.value=i.join(",");this.save()}));this.busyUsersDialog.show({users:e})}hideWithConfirm(t){if(!(t&&t.getSlider&&t.getSlider().getUrl()===this.sliderId)){return}if(!this.isAvailable){this.BX.removeCustomEvent("SidePanel.Slider:onClose",this.sliderOnClose);return}h.Util.closeAllPopups();if(this.checkDenyClose()){t.denyAction();return}if(this.needToShowConfirmPopup()){t.denyAction();const e=this.isCreateForm()?a.Loc.getMessage("EC_CLOSE_CREATE_FORM_CONFIRM_QUESTION"):a.Loc.getMessage("EC_CLOSE_EDIT_FORM_CONFIRM_QUESTION");h.Util.showConfirmPopup(this.hide.bind(this),e,{okCaption:a.Loc.getMessage("EC_CLOSE_EDIT_FORM_CONFIRM_OK"),minWidth:350,maxWidth:350})}else{this.BX.removeCustomEvent("SidePanel.Slider:onClose",this.sliderOnClose)}}hide(){this.doShowConfirmPopup=false;this.slider.close()}destroy(t){if(t&&t.getSlider()&&t.getSlider().getUrl()===this.sliderId){this.BX.onCustomEvent("OnCalendarPlannerDoUninstall",[{plannerId:this.plannerId}]);a.Event.unbind(document,"keydown",this.keyHandlerBind);o.EventEmitter.unsubscribe("onPullEvent-calendar",this.handlePullBind);this.BX.SidePanel.Instance.destroy(this.sliderId);if(l.Location){l.Location.setCurrentCapacity(0)}h.Util.closeAllPopups();this.planner=null;this.opened=false;h.Util.clearPlannerWatches()}}createContent(t){var e,i;const s=new this.BX.Promise;let o=this.getCurrentEntry();this.BX.ajax.runAction("calendar.api.calendarajax.getEditEventSlider",{data:{event_id:this.entryId||o.id,date_from:o?h.Util.formatDate(o.from):"",form_type:this.formType,type:(e=o.data.CAL_TYPE)!=null?e:this.type,ownerId:(i=o.data.OWNER_ID)!=null?i:this.ownerId,entityList:this.participantsEntityList}}).then((e=>{if(a.Type.isFunction(t.isOpen)&&t.isOpen()||t.isOpen===true){const l=this.BX.util.trim(e.data.html);t.getData().set("sliderContent",l);const d=e.data.additionalParams;this.updateEntryData(d.entry,{userSettings:this.userSettings,meetSection:d.meetSection});o=this.getCurrentEntry();this.uid=d.uniqueId;this.editorId=d.editorId;this.formSettings=this.getSettings(d.formSettings||[]);this.isCollabUser=d.isCollabUser;let c=this.formDataValue.attendeesEntityList||d.attendeesEntityList||[];if(!o.id&&this.participantsEntityList.length>0){c=this.participantsEntityList}if(a.Type.isArray(c)){c.forEach((t=>{if(t.entityId==="user"&&d.userIndex[t.id]){if(d.userIndex[t.id].EMAIL_USER){t.entityType="email";t.title=d.userIndex[t.id].DISPLAY_NAME}else if(d.userIndex[t.id].SHARING_USER){t.entityType="sharing";t.title=d.userIndex[t.id].DISPLAY_NAME}else{t.entityType="employee"}}}))}this.setUserSelectorEntityList(c);this.attendeesPreselectedItems=this.getUserSelectorEntityList().map((t=>[t.entityId,t.id]));this.setUserSettings(d.userSettings);h.Util.setEventWithEmailGuestEnabled(d.eventWithEmailGuestEnabled);this.handleSections(d.sections,d.trackingUsersList);this.handleLocationData(d.locationFeatureEnabled,d.locationList,d.iblockMeetingRoomList);this.locationAccess=d.locationAccess;this.plannerFeatureEnabled=Boolean(d.plannerFeatureEnabled);this.isProjectFeatureEnabled=d.projectFeatureEnabled;if(this.planner&&!this.plannerFeatureEnabled){this.planner.lock()}if(!o.id&&!o.sectionId){this.setCurrentEntry()}if(this.userSettings.meetSection&&this.type==="user"){n.SectionManager.setNewEntrySectionId(this.userSettings.meetSection)}if(this.isOpenEvent){var i,r;const t=((i=this.formDataValue)==null?void 0:i.category)||((r=this.eventOptions)==null?void 0:r.CATEGORY_ID);const e=t||d.defaultCategoryId;this.preSelectedCategory=e?["event-category",e]:null}this.timezoneHint=d.timezoneHint;s.fulfill(l)}}),(e=>{if(e.data&&!a.Type.isNil(e.data.isAvailable)&&!e.data.isAvailable){this.isAvailable=false;const t=()=>{top.BX.UI.InfoHelper.show("limit_office_calendar_off",{isLimit:true,limitAnalyticsLabels:{module:"calendar",source:"eventEditForm"}})};const e=BX.SidePanel.Instance.getSlider(this.sliderId);if(e){this.BX.removeCustomEvent("SidePanel.Slider:onClose",this.sliderOnClose);e.close(true,t)}else{t()}}const i=this.BX.util.trim("<div></div>");t.getData().set("sliderContent",i);s.fulfill(i)}));return s}initControls(t){this.DOM.title=this.DOM.content.querySelector(`#${t}_title`);this.DOM.formWrap=this.DOM.content.querySelector(`#${t}_form_wrap`);this.DOM.form=this.DOM.content.querySelector(`#${t}_form`);this.DOM.buttonsWrap=this.DOM.content.querySelector(".calendar-form-buttons-fixed");this.DOM.saveBtn=this.DOM.buttonsWrap.querySelector(`#${t}_save`);this.DOM.closeBtn=this.DOM.buttonsWrap.querySelector(`#${t}_close`);a.Event.bind(this.DOM.saveBtn,"click",this.save.bind(this));a.Event.bind(this.DOM.closeBtn,"click",this.close.bind(this));this.initFormFieldManager(t);this.initDateTimeControl(t);this.initNameControl(t);this.initEditorControl(t);this.initAttendeesControl();if(this.plannerEnabled){this.initPlanner(t)}this.initReminderControl(t);if(this.sectionSelectorEnabled){this.initSectionSelector(t)}this.initLocationControl(t);this.initRepeatRuleControl(t);this.initColorControl(t);this.initCrmUfControl(t);this.initAdditionalControls(t);this.checkLastItemBorder();if(this.isOpenEvent){this.initCategoryControl()}if(this.DOM.buttonsWrap){BX.ZIndexManager.register(this.DOM.buttonsWrap)}}updateEntryData(t,i={}){if(this.entry instanceof e.Entry){const s=i.userSettings||{};if(a.Type.isPlainObject(t)){this.entry.prepareData(t)}else if(!this.entry.getTimezoneFrom()||this.entry.getTimezoneTo()){this.entry.setTimezone(s.timezoneName||s.timezoneDefaultName||null)}if(!this.entry.id&&i.meetSection&&this.type===e.Entry.CAL_TYPES.user){this.entry.setSectionId(i.meetSection)}}}handleSections(t,e){this.sections=h.Util.filterSectionsByContext(t,{isCollabUser:this.isCollabUser,calendarType:this.type,calendarOwnerId:this.ownerId});this.sectionIndex={};this.trackingUsersList=e||[];if(a.Type.isArray(this.sections)){this.sections.forEach(((t,e)=>{this.sectionIndex[parseInt(t.ID,10)]=e}))}const i=this.getCurrentSection();if(this.entry.id){this.getSectionsForEditEvent(this.sections,i)}}handleLocationData(t,e,i){this.locationFeatureEnabled=Boolean(t);this.locationList=a.Type.isArray(e)?e.filter((t=>t.PERM.view_full)):[];this.iblockMeetingRoomList=i||[];l.Location.setLocationList(e);l.Location.setMeetingRoomList(i)}setUserSettings(t){this.userSettings=t;h.Util.setUserSettings(t)}setFormValues(){var t;const e=this.entry;this.dateTimeControl.setValue({from:this.formDataValue.from||e.from,to:this.formDataValue.to||e.to,fullDay:a.Type.isBoolean(this.formDataValue.fullDay)?this.formDataValue.fullDay:e.fullDay,timezoneFrom:e.getTimezoneFrom()||"",timezoneTo:e.getTimezoneTo()||"",timezoneName:this.userSettings.timezoneName});this.initialTimezoneFrom=e.getTimezoneFrom();this.initialTimezoneTo=e.getTimezoneTo();if(e.isSharingEvent()||!this.canEdit()){this.dateTimeControl.setReadonly(this.timezoneHint)}if(!this.canEdit()){a.Dom.attr(this.DOM.entryName,"readonly","readonly");a.Dom.style(this.DOM.entryName,"pointer-events","none")}const i=this.formDataValue.name||e.getName();this.DOM.entryName.value=i;this.DOM.entryName.title=i;a.Event.bind(this.DOM.entryName,"keyup",this.updateEventNameInputTitle.bind(this));a.Event.bind(this.DOM.entryName,"change",this.updateEventNameInputTitle.bind(this));const s=this.getCurrentSection();this.initialSectionId=this.getCurrentSectionId();if(this.sectionSelectorEnabled){if(this.formDataValue.section){e.sectionId=Number(this.formDataValue.section)}this.DOM.sectionInput.value=this.getCurrentSectionId();this.initialSectionId=this.getCurrentSectionId();this.sectionSelector.updateValue();if(!this.fieldIsPinned("section")&&(s.CAL_TYPE!==this.type||s.CAL_TYPE===this.type)&&parseInt(s.OWNER_ID,10)!==this.ownerId){this.pinField("section")}if((this.isSyncSection(s)||e.isSharingEvent())&&e.id||!this.canEdit()){this.sectionSelector.setViewMode(true)}}if(this.formDataValue.color){e.data.COLOR=this.formDataValue.color}this.colorSelector.setValue(e.getColor()||s.COLOR);this.remindersControl.setValue(this.formDataValue.reminder||e.getReminders(),true,false);(t=this.repeatSelector)==null?void 0:t.setValue(this.formDataValue.rrule||e.getRrule());this.initialRrule=this.getFormRrule();if(e.id&&e.isSharingEvent()||!this.canEdit()){var n;(n=this.repeatSelector)==null?void 0:n.setViewMode(e.getRRuleDescription())}if(e.hasRecurrenceId()){var o;(o=this.repeatSelector)==null?void 0:o.setViewMode(e.getRRuleDescription())}if(this.DOM.accessibilityInput){this.DOM.accessibilityInput.value=e.accessibility}if(this.locationSelector){this.locationSelector.setValue(this.formDataValue.location||this.locationSelector.default||e.getLocation(),false);this.locationSelector.checkLocationAccessibility({from:this.formDataValue.from||e.from,to:this.formDataValue.to||e.to,timezone:this.entry.getTimezoneFrom(),fullDay:a.Type.isBoolean(this.formDataValue.fullDay)?this.formDataValue.fullDay:e.fullDay,currentEventId:this.entry.id})}if(this.DOM.form.max_attendees){var r,l,d,c;const t=(r=e==null?void 0:(l=e.data)==null?void 0:(d=l.OPTIONS)==null?void 0:d.OPTIONS)!=null?r:null;this.DOM.form.max_attendees.value=((c=JSON.parse(t))==null?void 0:c.max_attendees)||""}if(this.DOM.privateEventCheckbox){this.DOM.privateEventCheckbox.checked=e.private}if(this.DOM.importantEventCheckbox){this.DOM.importantEventCheckbox.checked=e.important}if(this.DOM.form.meeting_notify){if(this.formDataValue.meetingNotify!==undefined){this.DOM.form.meeting_notify.checked=this.formDataValue.meetingNotify}if(this.entry.data&&this.entry.data.MEETING){this.DOM.form.meeting_notify.checked=this.entry.data.MEETING.NOTIFY}else{this.DOM.form.meeting_notify.checked=true}}if(this.DOM.form.hide_guests){if(this.formDataValue.hideGuests!==undefined){this.DOM.form.hide_guests.checked=this.formDataValue.hideGuests==="Y"}else if(this.entry.data&&this.entry.data.MEETING){this.DOM.form.hide_guests.checked=this.entry.data.MEETING.HIDE_GUESTS}else{this.DOM.form.hide_guests.checked=true}}if(this.DOM.form.allow_invite){if(this.entry.data){this.DOM.form.allow_invite.checked=this.entry.data.MEETING&&this.entry.data.MEETING.ALLOW_INVITE}else{this.DOM.form.allow_invite.checked=this.entry.allowInvite}}const u=this.dateTimeControl.getValue();if(this.plannerEnabled){this.planner.updateSelector(u.from,u.to,u.fullDay,{focus:true})}if(e.isSharingEvent()||!this.canEdit()){this.planner.setReadonly();this.planner.setSolid();this.planner.setShowWorkTimeNotice()}if(!this.canEdit()){const[t,e]=this.getPlaceholders();for(const i of this.getFieldsEditableOnlyByPermission()){a.Dom.style(t[i],"display","none");a.Dom.style(e[i],"display","none")}a.Dom.style(this.DOM.importantEventCheckbox,"display","none");a.Dom.style(this.DOM.importantEventCheckboxContainer,"display","none");a.Dom.style(this.DOM.moreSettings,"display","none");a.Dom.style(this.DOM.accessibilityInput,"display","none");const i=a.Tag.render(v||(v=p`
				<span class="calendar-field calendar-repeat-selector-readonly">
					${0}
				</span>
			`),this.DOM.accessibilityInput.options[this.DOM.accessibilityInput.selectedIndex].text);this.DOM.accessibilityInput.after(i)}if(this.plannerEnabled){this.loadPlannerData({entityList:this.getUserSelectorEntityList(),from:h.Util.formatDate(e.from.getTime()-h.Util.getDayLength()*3),to:h.Util.formatDate(e.to.getTime()+h.Util.getDayLength()*10),timezone:e.getTimezoneFrom(),location:this.locationSelector.getTextValue()})}}initCategoryControl(){this.DOM.categorySelectorWrap=this.DOM.content.querySelector(".calendar-category-selector-wrap");this.DOM.categorySelectorValueWarp=this.DOM.categorySelectorWrap.appendChild(a.Tag.render(b||(b=p`<div></div>`)));this.categoryTagSelector=new r.TagSelector({multiple:false,dialogOptions:{context:"calendar",preselectedItems:this.preSelectedCategory?[this.preSelectedCategory]:[],preload:true,zIndex:this.slider.zIndex,multiple:false,entities:[{id:"event-category",dynamicLoad:true,dynamicSearch:true}],events:{onLoad:()=>{this.categoryTagSelector.getDialog().getItems().forEach((t=>t.setDeselectable(false)));this.categoryTagSelector.getTags().forEach((t=>t.render()))}}}});this.categoryTagSelector.renderTo(this.DOM.categorySelectorWrap)}updateEventNameInputTitle(){if(this.isTitleOverflowing()){this.DOM.entryName.title=this.DOM.entryName.value}else{this.DOM.entryName.title=""}}isTitleOverflowing(){const t=this.DOM.entryName;return t.clientWidth<t.scrollWidth||t.clientHeight<t.scrollHeight}switchFullDay(t){t=Boolean(this.DOM.fullDay.checked);if(t&&a.Type.isString(this.userSettings.timezoneName)&&(!this.DOM.fromTz.value||!this.DOM.toTz.value)){this.DOM.fromTz.value=this.userSettings.timezoneName;this.DOM.toTz.value=this.userSettings.timezoneName;this.DOM.defTimezone.value=this.userSettings.timezoneName}if(t){a.Dom.addClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}else{a.Dom.removeClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}if(this.remindersControl){this.remindersControl.setFullDayMode(t)}this.refreshPlanner()}switchTimezone(){if(a.Dom.hasClass(this.DOM.tzCont,"calendar-options-timezone-collapse")){a.Dom.addClass(this.DOM.tzCont,"calendar-options-timezone-expand");a.Dom.removeClass(this.DOM.tzCont,"calendar-options-timezone-collapse")}else{a.Dom.addClass(this.DOM.tzCont,"calendar-options-timezone-collapse");a.Dom.removeClass(this.DOM.tzCont,"calendar-options-timezone-expand")}}initFormFieldManager(t){this.DOM.mainBlock=this.DOM.content.querySelector(`#${t}_main_block_wrap`);this.DOM.additionalBlockWrap=this.DOM.content.querySelector(`#${t}_additional_block_wrap`);this.DOM.additionalBlock=this.DOM.content.querySelector(`#${t}_additional_block`);this.DOM.pinnedNamesWrap=this.DOM.content.querySelector(`#${t}_additional_pinned_names`);this.DOM.additionalSwitch=this.DOM.content.querySelector(`#${t}_additional_switch`);if(this.isLocationCalendar&&!this.fieldIsPinned("location")){this.pinField("location")}a.Event.bind(this.DOM.additionalSwitch,"click",(()=>{a.Dom.toggleClass(this.DOM.additionalSwitch,"opened");a.Dom.toggleClass(this.DOM.additionalBlock,"invisible")}));a.Event.bind(this.DOM.formWrap,"click",(t=>{const e=t.target||t.srcElement;if(e&&e.getAttribute&&e.getAttribute("data-bx-fixfield")){const t=e.getAttribute("data-bx-fixfield");if(this.fieldIsPinned(t)){this.unPinField(t)}else{this.pinField(t)}}}));const e=document.querySelectorAll("[data-bx-field-id]");this.bindAdditionalFieldButtons(e)}initDateTimeControl(t){this.dateTimeControl=new m(t,{showTimezone:true,outerContent:this.DOM.content});this.dateTimeControl.subscribe("onChange",(t=>{if(t instanceof o.BaseEvent){const i=t.getData().value;this.entry.setTimezone(i.timezoneFrom);if(this.remindersControl){this.remindersControl.setFullDayMode(i.fullDay);if(!this.entry.id&&!this.remindersControl.wasChangedByUser()){const t=e.EntryManager.getNewEntryReminders(i.fullDay?"fullDay":"withTime");this.remindersControl.setValue(t,true,false)}}if(this.planner){this.planner.updateSelector(i.from,i.to,i.fullDay);this.planner.updateTimezone(i.timezoneFrom)}if(this.locationSelector){this.locationSelector.checkLocationAccessibility({from:i.from,to:i.to,timezone:this.entry.getTimezoneFrom(),fullDay:i.fullDay,currentEventId:this.entry.id})}}}))}initNameControl(t){this.DOM.entryName=this.DOM.content.querySelector(`#${t}_entry_name`);if(this.canEdit()){setTimeout((()=>{this.DOM.entryName.focus();this.DOM.entryName.select()}),500)}let e=false;a.Event.bind(this.DOM.entryName,"focusout",(()=>{if(this.DOM.entryName.scrollWidth>this.DOM.entryName.offsetWidth){this.getTitleFade(t).classList.add("--show")}else{this.getTitleFade(t).classList.remove("--show")}e=false}));a.Event.bind(this.DOM.entryName,"focus",(()=>{this.getTitleFade(t).classList.remove("--show");e=true}));a.Event.bind(this.DOM.entryName,"scroll",(()=>{if(this.DOM.entryName.scrollWidth>this.DOM.entryName.offsetWidth&&Math.ceil(this.DOM.entryName.offsetWidth+this.DOM.entryName.scrollLeft)<this.DOM.entryName.scrollWidth&&!e){this.getTitleFade(t).classList.add("--show")}else{this.getTitleFade(t).classList.remove("--show")}}))}getTitleFade(t){if(!this.DOM.entryNameFade){this.DOM.entryNameFade=this.DOM.content.querySelector(`#${t}_input_fade`)}return this.DOM.entryNameFade}initReminderControl(t){const e=this.DOM.content.querySelector(`#${t}_reminder`);if(!e){return}this.reminderValues=[];this.DOM.reminderWrap=e;this.DOM.reminderInputsWrap=this.DOM.reminderWrap.appendChild(a.Tag.render(_||(_=p`<span></span>`)));this.remindersControl=new l.Reminder({wrap:this.DOM.reminderWrap,zIndex:this.zIndex});this.remindersControl.subscribe("onChange",(t=>{if(t instanceof o.BaseEvent){this.reminderValues=t.getData().values;a.Dom.clean(this.DOM.reminderInputsWrap);this.reminderValues.forEach((t=>{this.DOM.reminderInputsWrap.appendChild(a.Tag.render(L||(L=p`
						<input value="${0}" name="reminder[]" type="hidden">
					`),t))}))}}))}initSectionSelector(t){this.DOM.sectionInput=this.DOM.content.querySelector(`#${t}_section`);this.sectionSelector=new l.SectionSelector({outerWrap:this.DOM.content.querySelector(`#${t}_section_wrap`),defaultCalendarType:this.type,defaultOwnerId:this.ownerId,sectionList:this.sections,sectionGroupList:n.SectionManager.getSectionGroupList({type:this.type||"user",ownerId:this.ownerId||this.userId,userId:this.userId,trackingUsersList:this.trackingUsersList,isCollabUser:this.isCollabUser,isCollabContext:this.isCollabContext()}),mode:"full",zIndex:this.zIndex,getCurrentSection:()=>{const t=this.getCurrentSection();if(t){return{id:t.ID,name:t.NAME,color:t.COLOR}}return false},selectCallback:t=>{if(t){this.DOM.sectionInput.value=t.id;if(this.colorSelector){this.colorSelector.setValue(t.color)}this.entry.setSectionId(t.id);n.SectionManager.saveDefaultSectionId(t.id,{calendarType:this.type,ownerId:this.ownerId,userId:this.userId,sections:this.sections})}}})}initEditorControl(t){if(!window.BXHtmlEditor){return setTimeout(BX.delegate(this.initEditorControl,this),50)}this.editor=null;if(window.BXHtmlEditor){this.editor=window.BXHtmlEditor.Get(this.editorId)}if(!this.editor&&top.BXHtmlEditor&&top.BXHtmlEditor!==window.BXHtmlEditor){this.editor=top.BXHtmlEditor.Get(this.editorId)}if(this.editor&&this.editor.IsShown()){this.customizeHtmlEditor();if(this.formDataValue.description){this.editor.SetContent(this.formDataValue.description)}}else{this.BX.addCustomEvent(window.BXHtmlEditor,"OnEditorCreated",(t=>{if(t.id===this.editorId){this.editor=t;this.customizeHtmlEditor();if(this.formDataValue.description){this.editor.SetContent(this.formDataValue.description)}}}))}}customizeHtmlEditor(){const t=this.editor;if(t.toolbar&&t.toolbar.controls&&t.toolbar.controls.spoiler){a.Dom.remove(t.toolbar.controls.spoiler.pCont)}}initLocationControl(t){this.DOM.locationWrap=this.DOM.content.querySelector(`#${t}_location_wrap`);this.DOM.locationInput=this.DOM.content.querySelector(`#${t}_location`);this.locationSelector=new l.Location({inputName:"lo_cation",wrap:this.DOM.locationWrap,richLocationEnabled:this.locationFeatureEnabled,hideLocationLock:this.isCollabUser,locationList:this.locationList||[],roomsManager:this.roomsManager||null,locationAccess:this.locationAccess||false,iblockMeetingRoomList:this.iblockMeetingRoomList,onChangeCallback:this.refreshPlanner})}initRepeatRuleControl(t){const e=this.DOM.content.querySelector(`#${t}_rrule_wrap`);if(!e){return}this.DOM.rruleWrap=e;this.repeatSelector=new l.RepeatSelector({wrap:this.DOM.rruleWrap,rruleType:this.DOM.content.querySelector(`#${t}_rrule_type`),getDate:function(){return this.dateTimeControl.getValue().from}.bind(this)});this.dateTimeControl.subscribe("onChange",(()=>{if(this.repeatSelector.getType()==="weekly"){this.repeatSelector.changeType(this.repeatSelector.getType())}}));if(this.plannerEnabled){this.planner.subscribe("onDateChange",(()=>{if(this.repeatSelector.getType()==="weekly"){this.repeatSelector.changeType(this.repeatSelector.getType())}}))}}initAttendeesControl(){if(this.attendeesControlEnabled){this.DOM.userSelectorWrap=this.DOM.content.querySelector(".calendar-attendees-selector-wrap");this.DOM.userSelectorValueWarp=this.DOM.userSelectorWrap.appendChild(a.Tag.render(w||(w=p`<div></div>`)));this.userTagSelector=new r.TagSelector({dialogOptions:{context:"CALENDAR",preselectedItems:this.attendeesPreselectedItems||[],zIndex:this.slider.zIndex,events:{"Item:onSelect":this.handleUserSelectorChanges.bind(this),"Item:onDeselect":this.handleUserSelectorChanges.bind(this)},entities:this.getParticipantsSelectorEntityList(),selectedItems:this.getSelectedItemsForTagSelector(),searchTabOptions:{stubOptions:{title:a.Loc.getMessage("EC_USER_DIALOG_404_TITLE"),subtitle:a.Loc.getMessage("EC_USER_DIALOG_404_SUBTITLE"),icon:"/bitrix/images/calendar/search-email.svg",iconOpacity:100,arrow:true}}}});this.userTagSelector.renderTo(this.DOM.userSelectorWrap)}if(this.plannerEnabled){this.DOM.hideGuestsWrap=this.DOM.content.querySelector(".calendar-hide-members-wrap")}}handleUserSelectorChanges(){if(this.planner){this.planner.show();this.planner.showLoader();const t=this.userTagSelector.getDialog().getSelectedItems();this.setUserSelectorEntityList(t.map((t=>({entityId:t.entityId,id:t.id,entityType:t.entityType}))));this.refreshPlanner()}}getSelectedItemsForTagSelector(){const t=[];const e=this.canEdit();this.getUserSelectorEntityList().forEach((i=>{if(i.entityType==="sharing"){t.push({id:i.id,entityId:i.entityId,entityType:"extranet",title:i.title,deselectable:false})}if(!e&&i.entityType==="email"){t.push({id:i.id,entityId:i.entityId,entityType:"email",title:i.title,deselectable:false})}}));return t}hasExternalEmailUsers(){return Boolean(this.getUserSelectorEntityList().find((t=>t.entityType==="email")))}showHideGuestsOption(){this.DOM.hideGuestsWrap.style.display="";h.Util.initHintNode(this.DOM.hideGuestsWrap.querySelector(".calendar-hide-members-helper"))}hideHideGuestsOption(){this.DOM.hideGuestsWrap.style.display="none"}setHideGuestsValue(t=true){this.hideGuests=t}initPlanner(t){this.DOM.plannerOuterWrap=this.DOM.content.querySelector(`#${t}_planner_outer_wrap`);this.planner=new i.Planner({wrap:this.DOM.plannerOuterWrap,minWidth:parseInt(this.DOM.plannerOuterWrap.offsetWidth),locked:!this.plannerFeatureEnabled,entryTimezone:this.entry.getTimezoneFrom()});this.planner.subscribe("onDateChange",this.handlePlannerSelectorChanges.bind(this));this.planner.subscribe("onExpandTimeline",this.handleExpandPlannerTimeline.bind(this));this.planner.subscribe("onDisplayAttendees",this.checkLocationForm.bind(this));this.planner.show();this.planner.showLoader()}loadPlannerData(t={}){this.planner.showLoader();return new Promise((e=>{this.BX.ajax.runAction("calendar.api.calendarajax.updatePlanner",{data:{entryId:this.entry.id||0,entryLocation:this.entry.data.LOCATION||"",ownerId:this.ownerId,hostId:this.entry.data.MEETING_HOST||null,type:this.type,entityList:!this.isOpenEvent&&t.entityList||[],dateFrom:h.Util.formatDate(this.planner.scaleDateFrom),dateTo:h.Util.formatDate(this.planner.scaleDateTo),timezone:t.timezone||"",location:t.location||"",prevUserList:this.prevUserList}}).then((t=>{if(this.planner){for(const e in t.data.accessibility){if(t.data.accessibility.hasOwnProperty(e)){this.loadedAccessibilityData[e]=t.data.accessibility[e]}}if(a.Type.isArray(t.data.entries)){t.data.entries.forEach((t=>{const e=this.loadedAccessibilityData[t.id];if(t.type==="user"&&!this.prevUserList.includes(parseInt(t.id))&&e){this.prevUserList.push(parseInt(t.id))}}))}this.planner.hideLoader();this.planner.update(t.data.entries,this.loadedAccessibilityData)}if(this.hasExternalEmailUsers()){this.showHideGuestsOption()}else{this.hideHideGuestsOption()}e(t)}),(t=>{e(t)}))}))}initAdditionalControls(t){this.DOM.accessibilityInput=this.DOM.content.querySelector(`#${t}_accessibility`);this.DOM.privateEventCheckbox=this.DOM.content.querySelector(`#${t}_private`);this.DOM.importantEventCheckbox=this.DOM.content.querySelector(`#${t}_important`);this.DOM.importantEventCheckboxContainer=this.DOM.importantEventCheckbox.closest(".calendar-info-panel-important");this.DOM.moreSettings=this.DOM.content.querySelector(`#${t}_more_outer_wrap`)}initColorControl(t){this.DOM.colorWrap=this.DOM.content.querySelector(`#${t}_color_selector_wrap`);this.colorSelector=new l.ColorSelector({wrap:this.DOM.colorWrap})}initCrmUfControl(t){const e=BX(`${t}-uf-crm-wrap`);if(!e){return}this.DOM.crmUfWrap=e;if(this.DOM.crmUfWrap){const t=this.getCurrentEntry();const e=this.DOM.crmUfWrap.appendChild(a.Dom.adjust(h.Util.getLoader(50),{style:{height:"40px",width:"40px"}}));this.DOM.saveBtn.disabled=true;setTimeout((()=>{this.BX.ajax.runAction("calendar.api.calendarajax.getCrmUserfield",{data:{event_id:t&&t.id?t.id:0}}).then((t=>{if(a.Type.isDomNode(this.DOM.crmUfWrap)){this.BX.html(this.DOM.crmUfWrap,t.data.html);this.DOM.saveBtn.disabled=false}}),(t=>{a.Dom.remove(e);this.DOM.saveBtn.disabled=false}))}),800)}}denySliderClose(){this.denyClose=true}allowSliderClose(){this.denyClose=false}checkDenyClose(){if(this.state===this.STATE.REQUEST){return true}if(!a.Type.isNull(this.mouseUpNodeCheck)){return!this.mouseUpNodeCheck}return this.denyClose}needToShowConfirmPopup(){return this.doShowConfirmPopup&&this.formDataChanged()}setCurrentEntry(t=null,i=null){const s=this.getCurrentSectionId();this.entry=e.EntryManager.getEntryInstance(t,i,{type:this.type,ownerId:this.ownerId});if(!h.Util.getCalendarContext()&&this.type==="group"){this.entry.setSectionId(s)}e.EntryManager.registerEntrySlider(this.entry,this)}getCurrentEntry(){return this.entry}getCurrentSection(){let t=false;const e=this.getCurrentSectionId();if(e&&this.sectionIndex[e]!==undefined&&this.sections[this.sectionIndex[e]]!==undefined){t=this.sections[this.sectionIndex[e]]}return t}getCurrentSectionId(){let t=0;const i=this.getCurrentEntry();if(i instanceof e.Entry&&this.sections[this.sectionIndex[i.sectionId]]){t=parseInt(i.sectionId)}if(!t){if(this.type==="location"){t=s.RoomsManager.getNewEntrySectionId()}else{if(!h.Util.getCalendarContext()&&this.type==="group"&&this.sections.length){t=this.getSectionIdByCurrentContext()}else{t=n.SectionManager.getNewEntrySectionId(this.type,this.ownerId)}}if(!this.sectionIndex[t]){t=null}}if(!t&&this.sections[0]){t=parseInt(this.sections[0].ID)}return t}pinField(t){const[e,i]=this.getPlaceholders();const s=i[t];const n=e[t];const o=s.offsetHeight;s.style.height=`${o}px`;setTimeout((()=>{a.Dom.addClass(s,"calendar-hide-field")}),0);n.style.height="0";if(t==="description"){setTimeout((()=>{if(!this.DOM.descriptionAdditionalWrap){this.DOM.descriptionAdditionalWrap=this.DOM.additionalBlock.querySelector(".calendar-info-panel-description")}if(this.DOM.descriptionAdditionalWrap){while(this.DOM.descriptionAdditionalWrap.firstChild){n.appendChild(this.DOM.descriptionAdditionalWrap.firstChild)}}n.style.height=`${o}px`}),200);setTimeout((()=>{a.Dom.removeClass(s,"calendar-hide-field");s.style.display="none";n.style.height="";this.pinnedFieldsIndex[t]=true;const e=window.BXHtmlEditor.Get(this.editorId);if(e){e.CheckAndReInit()}this.saveSettings();this.updateAdditionalBlockState()}),500)}else{setTimeout((()=>{while(s.firstChild){n.appendChild(s.firstChild)}n.style.height=`${o}px`}),200);setTimeout((()=>{a.Dom.removeClass(s,"calendar-hide-field");s.style.height="";n.style.height="";this.pinnedFieldsIndex[t]=true;this.saveSettings();this.updateAdditionalBlockState()}),300)}}unPinField(t){const[e,i]=this.getPlaceholders();const s=e[t];const n=i[t];const o=s.offsetHeight;s.style.height=`${o}px`;setTimeout((()=>{a.Dom.addClass(s,"calendar-hide-field")}),0);n.style.height="0";if(t==="description"){setTimeout((()=>{if(!this.DOM.descriptionAdditionalWrap){this.DOM.descriptionAdditionalWrap=this.DOM.additionalBlock.querySelector(".calendar-info-panel-description")}if(this.DOM.descriptionAdditionalWrap){while(s.firstChild){this.DOM.descriptionAdditionalWrap.appendChild(s.firstChild)}}n.style.display="";n.style.height=`${o}px`}),200);setTimeout((()=>{a.Dom.removeClass(s,"calendar-hide-field");s.style.height="";n.style.height="";this.pinnedFieldsIndex[t]=false;const e=window.BXHtmlEditor.Get(this.editorId);if(e){e.CheckAndReInit()}this.saveSettings();this.updateAdditionalBlockState()}),300)}else{setTimeout((()=>{while(s.firstChild){n.appendChild(s.firstChild)}n.style.height=`${o}px`}),200);setTimeout((()=>{a.Dom.removeClass(s,"calendar-hide-field");s.style.height="";n.style.height="";this.pinnedFieldsIndex[t]=false;this.saveSettings();this.updateAdditionalBlockState()}),300)}}fieldIsPinned(t){return this.pinnedFieldsIndex[t]}getPlaceholders(){if(!this.placeHolders){this.placeHolders={};this.placeHoldersAdditional={};let t;let e;let i=this.DOM.formWrap.querySelectorAll(".calendar-field-additional-placeholder");for(t=0;t<i.length;t++){e=i[t].getAttribute("data-bx-block-placeholer");if(e){this.placeHoldersAdditional[e]=i[t]}}i=this.DOM.formWrap.querySelectorAll(".calendar-field-placeholder");for(t=0;t<i.length;t++){e=i[t].getAttribute("data-bx-block-placeholer");if(e){this.placeHolders[e]=i[t]}}}return[this.placeHolders,this.placeHoldersAdditional]}getSettings(t){this.pinnedFieldsIndex={};let e;const i=[];for(e in t.pinnedFields){if(t.pinnedFields.hasOwnProperty(e)){i.push(t.pinnedFields[e]);this.pinnedFieldsIndex[t.pinnedFields[e]]=true}}t.pinnedFields=i;return t}saveSettings(){let t;const e=[];for(t in this.pinnedFieldsIndex){if(this.pinnedFieldsIndex.hasOwnProperty(t)&&this.pinnedFieldsIndex[t]){e.push(t)}}this.formSettings.pinnedFields=e;this.BX.userOptions.save("calendar",this.formType,"pinnedFields",e)}updateAdditionalBlockState(t){if(t===false){a.Dom.clean(this.DOM.pinnedNamesWrap);const t=[...this.DOM.additionalBlock.querySelectorAll(".calendar-field-additional-placeholder[data-bx-block-placeholer]")].filter((t=>t.innerText!==""&&t.style.display!=="none"));const e=t.map((t=>a.Dom.create("SPAN",{attrs:{"data-bx-field-id":t.getAttribute("data-bx-block-placeholer")},props:{className:"calendar-additional-alt-promo-text"},html:t.querySelector(".js-calendar-field-name").innerText})));this.DOM.pinnedNamesWrap.append(...e);this.bindAdditionalFieldButtons(e);if(e.length===0){a.Dom.addClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}else if(a.Dom.hasClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")){a.Dom.removeClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}this.checkLastItemBorder()}else{if(this.updateAdditionalBlockTimeout){clearTimeout(this.updateAdditionalBlockTimeout);this.updateAdditionalBlockTimeout=null}this.updateAdditionalBlockTimeout=setTimeout((()=>{this.updateAdditionalBlockState(false)}),300)}}bindAdditionalFieldButtons(t){for(const e of t){const t=e.getAttribute("data-bx-field-id");if(!this.canEdit()&&this.getFieldsEditableOnlyByPermission().includes(t)){e.remove();continue}a.Event.bind(e,"click",(e=>{const i=document.querySelector(`.calendar-openable-block [data-bx-block-placeholer=${t}]`);this.highlightField(i);if(this.isAdditionalBlockOpened()){e.stopPropagation()}}))}}getFieldsEditableOnlyByPermission(){return["description","private","crm"]}highlightField(t){a.Dom.addClass(t,"calendar-field-highlighted");const e=this.DOM.content.scrollTop+t.getBoundingClientRect().top;this.highlightFieldScrollAnimation=new BX.easing({duration:400,start:{scroll:this.DOM.content.scrollTop},finish:{scroll:e},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:t=>{this.DOM.content.scrollTop=t.scroll},complete:()=>{}});this.highlightFieldScrollAnimation.animate();clearTimeout(t.highlightTimeout);t.highlightTimeout=setTimeout((()=>BX.Dom.removeClass(t,"calendar-field-highlighted")),2500)}isAdditionalBlockOpened(){return a.Dom.hasClass(this.DOM.additionalSwitch,"opened")}checkLastItemBorder(){const t="no-border";let e;let i;i=this.DOM.mainBlock.querySelectorAll(".calendar-options-item-border");for(e=0;e<i.length;e++){if(e===i.length-1){a.Dom.addClass(i[e],t)}else{a.Dom.removeClass(i[e],t)}}i=this.DOM.additionalBlock.querySelectorAll(".calendar-options-item-border");for(e=0;e<i.length;e++){if(e===i.length-1){a.Dom.addClass(i[e],t)}else{a.Dom.removeClass(i[e],t)}}}handlePlannerSelectorChanges(t){if(t instanceof o.BaseEvent){const e=t.getData();this.dateTimeControl.setValue({from:e.dateFrom,to:e.dateTo});if(this.locationSelector){this.locationSelector.checkLocationAccessibility({from:e.dateFrom,to:e.dateTo,timezone:this.entry.getTimezoneFrom(),fullDay:e.fullDay,currentEventId:this.entry.id})}if(this.planner){const t=parseInt(e.dateFrom.getHours())+Math.floor(e.dateFrom.getMinutes()/60);const i=parseInt(e.dateTo.getHours())+Math.floor(e.dateTo.getMinutes()/60);if(t!==0&&t<=this.planner.shownScaleTimeFrom||i!==0&&i!==23&&i+1>=this.planner.shownScaleTimeTo){this.planner.updateSelector(e.dateFrom,e.dateTo,e.fullDay)}}}}handleExpandPlannerTimeline(t){if(t instanceof o.BaseEvent){const e=t.getData();if(e.reload){this.prevUserList=[];const t=this.dateTimeControl.getValue();this.loadPlannerData({entityList:this.getUserSelectorEntityList(),from:h.Util.formatDate(e.dateFrom),to:h.Util.formatDate(e.dateTo),timezone:t.timezoneFrom,location:this.locationSelector.getTextValue(),focusSelector:false})}}}getUserSelectorEntityList(){return this.selectorEntityList}setUserSelectorEntityList(t){this.selectorEntityList=t}refreshPlannerState(){const t=this.dateTimeControl.getValue();this.loadPlannerData({entityList:this.isOpenEvent?[]:this.getUserSelectorEntityList(),from:h.Util.formatDate(t.from.getTime()-h.Util.getDayLength()*3),to:h.Util.formatDate(t.to.getTime()+h.Util.getDayLength()*10),timezone:t.timezoneFrom,location:this.locationSelector.getTextValue()})}checkLocationForm(t){if(!this.isCollabUser&&t&&t instanceof o.BaseEvent){const e=t.getData();const i=e.usersCount;if(this.locationCapacity!==0){l.Location.setCurrentCapacity(this.locationCapacity);this.locationCapacity=0}let s=l.Location.getCurrentCapacity()||0;if(this.locationSelector.value.type===undefined&&s){s=0;l.Location.setCurrentCapacity(0)}if(s<i&&s!==0){this.locationSelector.addCapacityAlert()}else{this.locationSelector.removeCapacityAlert()}}}plannerIsShown(){return this.DOM.plannerWrap&&a.Dom.hasClass(this.DOM.plannerWrap,"calendar-edit-planner-wrap-shown")}keyHandler(t){if((t.ctrlKey||t.metaKey)&&!t.altKey&&t.keyCode===h.Util.getKeyCode("enter")&&this.checkTopSlider()&&!this.isAdditionalPopupShown()){if(this.busyUsersDialog&&this.busyUsersDialog.isShown()){return}this.save()}}isAdditionalPopupShown(){var t,e;return(t=this.DOM.locationRepeatBusyErrorPopup)==null?void 0:(e=t.getPopupWindow())==null?void 0:e.isShown()}checkTopSlider(){const t=h.Util.getBX().SidePanel.Instance.getTopSlider();return t&&t.options.type==="calendar:slider"}showError(t){let e="";if(a.Type.isArray(t)){t.forEach((t=>{if(t.code==="edit_entry_location_busy"||t.code==="edit_entry_location_busy_recurrence"){this.locationBusyAlert=h.Util.showFieldError(t.message,this.DOM.locationWrap,{clearTimeout:1e4});return}if(t.code==="edit_entry_location_repeat_busy"){this.showLocationRepeatBusyErrorPopup(t.message);return}e+=`${t.message}\n`}))}if(e!==""){alert(e)}}showLocationRepeatBusyErrorPopup(t){if(!this.DOM.locationRepeatBusyErrorPopup){this.DOM.locationRepeatBusyErrorPopup=e.EntryManager.getLocationRepeatBusyErrorPopup({message:t,onYesCallback:()=>{if(a.Type.isDomNode(this.locationBusyAlert)){a.Dom.remove(this.locationBusyAlert);this.locationBusyAlert=null}this.lastUsedSaveOptions.doCheckOccupancy="N";this.DOM.locationRepeatBusyErrorPopup.close();this.save(this.lastUsedSaveOptions);this.lastUsedSaveOptions={}},onCancelCallback:()=>{this.lastUsedSaveOptions={};this.DOM.locationRepeatBusyErrorPopup.close()},onPopupCloseCallback:()=>{delete this.DOM.locationRepeatBusyErrorPopup}});this.DOM.locationRepeatBusyErrorPopup.show()}}getFormDataChanges(t=[]){var e,i,s,n,o,r,h;if(!this.DOM.form){return[]}const d=this.entry;const c=[];if(!t.includes("name")&&d.name!==this.DOM.form.name.value){c.push("name")}if(!t.includes("description")&&d.getDescription()!==this.DOM.form.desc.value){c.push("description")}if(!t.includes("location")&&this.locationSelector.getTextLocation(l.Location.parseStringValue(this.entry.getLocation()))!==this.locationSelector.getTextLocation(l.Location.parseStringValue(this.locationSelector.getTextValue()))){c.push("location")}const u=this.dateTimeControl.getValue();if(!t.includes("date&time")&&(d.isFullDay()!==u.fullDay||u.from.toString()!==d.from.toString()||u.to.toString()!==d.to.toString())){c.push("date&time")}if(this.sectionSelectorEnabled&&!t.includes("section")&&Number(this.initialSectionId)!==Number(this.DOM.sectionInput.value)){c.push("section")}if(this.attendeesControlEnabled&&!t.includes("codes")&&this.getUserSelectorEntityList().map((t=>t.entityId+":"+t.id)).join("|")!==d.getAttendeesEntityList().map((t=>t.entityId+":"+t.id)).join("|")){c.push("codes")}if(!t.includes("color")){const t=(d.data.COLOR||this.getCurrentSection().COLOR).toLowerCase();if(t!==this.colorSelector.getValue().toLowerCase()){c.push("color")}}if(!t.includes("reminder")){const t=d.getReminders();if(a.Type.isArrayFilled(t)&&t.length!==this.reminderValues.length){c.push("reminder")}}if(this.wasRruleChanged()){c.push("rrule")}if(this.DOM.privateEventCheckbox&&this.DOM.privateEventCheckbox.checked!==d.isPrivate()){c.push("private")}if(this.DOM.importantEventCheckbox&&this.DOM.importantEventCheckbox.checked!==d.important){c.push("important")}if(this.DOM.form.tz_from.value!==this.initialTimezoneFrom){c.push("tz_from")}if(this.DOM.form.tz_to.value!==this.initialTimezoneTo){c.push("tz_to")}const m=d.data.UF_CRM_CAL_EVENT||[];const p=new FormData(this.DOM.form).getAll("UF_CRM_CAL_EVENT[]");if(JSON.stringify(m.sort())!==JSON.stringify(p.sort())){c.push("uf_crm")}if(this.DOM.form.meeting_notify&&d.data.MEETING&&this.DOM.form.meeting_notify.checked!==d.data.MEETING.NOTIFY){c.push("meeting_notify")}if(this.DOM.accessibilityInput&&this.DOM.accessibilityInput.value!==d.accessibility){c.push("accessibility")}const f=parseInt((e=this.DOM.form)==null?void 0:(i=e.max_attendees)==null?void 0:i.value,10)||0;const y=(s=d==null?void 0:(n=d.data)==null?void 0:(o=n.OPTIONS)==null?void 0:o.OPTIONS)!=null?s:null;const D=(r=(h=JSON.parse(y))==null?void 0:h.max_attendees)!=null?r:0;if(f!==D){c.push("max_attendees")}const g=this.entry.data.UF_WEBDAV_CAL_EVENT||[];const C=new FormData(this.DOM.form).getAll("UF_WEBDAV_CAL_EVENT[]").filter(Boolean);if(JSON.stringify(g.sort())!==JSON.stringify(C.sort())){c.push("UF_WEBDAV_CAL_EVENT[]")}return c}wasRruleChanged(){return JSON.stringify(this.getFormRrule())!==JSON.stringify(this.initialRrule)&&!this.entry.hasRecurrenceId()}getFormRrule(){var t;const e=new FormData(this.DOM.form);const i=e.get("rrule_endson");const s=(t=e.get("EVENT_RRULE[FREQ]"))!=null?t:"NONE";let n=parseInt(e.get("EVENT_RRULE[INTERVAL]"),10)||null;let o=null;let r=null;let a=null;if(i==="count"){const t=10;o=parseInt(e.get("EVENT_RRULE[COUNT]"),10)||t}if(i==="until"){r=e.get("EVENT_RRULE[UNTIL]")}if(s==="NONE"){n=o=r=null}if(s==="WEEKLY"){a=e.getAll("EVENT_RRULE[BYDAY][]")}return{FREQ:s,INTERVAL:n,COUNT:o,UNTIL:r,BYDAY:a}}checkCurrentUsersAccessibility(){return this.getFormDataChanges().includes("date&time")}formDataChanged(){return this.getFormDataChanges().length>0}getUserCodes(){const t=[];const e=this.DOM.attendeesWrap.querySelectorAll('input[name="EVENT_DESTINATION[]"]');for(const i of e){if(!t.includes(i.value)){t.push(i.value)}}return t}handlePull(t){var e,i,s,n;if(!t instanceof o.BaseEvent){return}const r=t.getData();const l=r[0];const h=a.Type.isObjectLike(r[1])?r[1]:{};switch(l){case"edit_event":case"delete_event":case"set_meeting_status":const t=a.Type.isArray(h==null?void 0:(e=h.fields)==null?void 0:e.ATTENDEES)?h.fields.ATTENDEES:[];const o=(h==null?void 0:(i=h.fields)==null?void 0:i.CAL_TYPE)==="user"?parseInt(h==null?void 0:(s=h.fields)==null?void 0:s.OWNER_ID):parseInt(h==null?void 0:(n=h.fields)==null?void 0:n.CREATED_BY);if(!t.includes(o)){t.push(o)}this.clearAccessibilityData(t);this.refreshPlannerState();break}}clearAccessibilityData(t){if(a.Type.isArray(t)&&t.length>0&&this.prevUserList.length>0){this.prevUserList=this.prevUserList.filter((e=>!t.includes(e)))}}getParticipantsSelectorEntityList(){if(this.participantsSelectorEntityList&&this.participantsSelectorEntityList.length>0){return this.participantsSelectorEntityList}let t=[{id:"user",options:{inviteEmployeeLink:this.canEdit(),inviteGuestLink:this.canEdit(),emailUsers:h.Util.isEventWithEmailGuestAllowed()&&this.canEdit(),analyticsSource:"calendar",lockGuestLink:!h.Util.isEventWithEmailGuestAllowed(),lockGuestLinkFeatureId:"calendar_events_with_email_guests"},filters:[{id:"calendar.attendeeFilter",options:{isSharingEvent:this.entry.isSharingEvent(),eventId:this.entry.id}}]},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}];if(this.isProjectFeatureEnabled){t.push({id:"project"})}if(this.attendeesPreselectedItems){let e=null;this.attendeesPreselectedItems.forEach((t=>{const i=t[0];const s=t[1];if(i==="project-roles"){e=s}}));if(e){t=[{id:"user"},{id:"project-roles",options:{projectId:e.split("_")[0]},dynamicLoad:true}]}}return t}isSyncSection(t){return t.EXTERNAL_TYPE==="icloud"||t.EXTERNAL_TYPE==="google"||t.EXTERNAL_TYPE==="office365"||t.connectionLinks&&t.connectionLinks.length>0}getSectionsForEditEvent(t,e){const i=[];const s=e.CAL_TYPE;i.push(e);t.forEach((t=>{if(!this.isSyncSection(t)&&t.CAL_TYPE===s){i.push(t)}}));this.sections=i;this.sectionIndex=[];if(a.Type.isArray(this.sections)){this.sections.forEach(((t,e)=>{this.sectionIndex[parseInt(t.ID)]=e}))}}unsetHiddenSection(t,e){const i=parseInt(t.ID);if(!e.sectionIsShown(i)){let t=e.getHiddenSections();t=t.filter((t=>t!==i));e.setHiddenSections(t);e.saveHiddenSections()}}isCreateForm(){return!this.isEditForm()}isEditForm(){return parseInt(this.entry.id)>0}isCollabContext(){const t=this.getCurrentSection();return t&&a.Type.isFunction(t.isCollab)?t.isCollab():t.IS_COLLAB}getSectionIdByCurrentContext(){const t=this.sections.find((t=>parseInt(t.OWNER_ID,10)===this.ownerId&&t.CAL_TYPE===this.type));return t&&parseInt(t.ID,10)}}t.EventEditForm=A})(this.BX.Calendar=this.BX.Calendar||{},BX.Calendar,BX.Calendar,BX.Calendar,BX.Calendar,BX.Event,BX.UI.EntitySelector,BX,BX.Calendar.Controls,BX.Calendar);
//# sourceMappingURL=eventeditform.bundle.map.js