(function(e){if(!BX.Sale)BX.Sale={};if(BX.Sale.Cashbox)return;BX.Sale.Cashbox={ajaxUrl:"/bitrix/admin/sale_cashbox_ajax.php",getRestrictionParamsHtml:function(t){if(!t.class)return;t.params=t.params||{};t.restrictionId=t.restrictionId||0;t.sort=t.sort||100;ShowWaitWindow();var a={action:"get_restriction_params_html",className:t.class,params:t.params,cashboxId:t.cashboxId,sort:t.sort,lang:t.lang,sessid:BX.bitrix_sessid()};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(a){CloseWaitWindow();if(a&&a.RESTRICTION_HTML&&!a.ERROR){var i=BX.processHTML(a.RESTRICTION_HTML);BX.Sale.Cashbox.showRestrictionParamsDialog(i["HTML"],t);e["cashboxGetRestrictionHtmlScriptsLoadingStarted"]=false;var r=function(t){if(!t)BX.removeCustomEvent("cashboxGetRestrictionHtmlScriptsReady",r);for(var a in i["SCRIPT"]){BX.evalGlobal(i["SCRIPT"][a]["JS"]);delete i["SCRIPT"][a];if(t&&e["cashboxGetRestrictionHtmlScriptsLoadingStarted"])return}};BX.addCustomEvent("cashboxGetRestrictionHtmlScriptsReady",r);r(true);BX.loadCSS(i["STYLE"])}else if(a&&a.ERROR){BX.debug("Error receiving restriction params html: "+a.ERROR)}else{BX.debug("Error receiving restriction params html!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error adding restriction!")}})},showRestrictionParamsDialog:function(e,t){var a=460,i=new BX.CDialog({content:'<form id="sale-cashbox-restriction-edit-form">'+e+"</form>",title:BX.message("SALE_RDL_RESTRICTION")+": "+t.title,width:a,height:500,resizable:true});i.ClearButtons();i.SetButtons([{title:BX.message("SALE_RDL_SAVE"),action:function(){var e=BX("sale-cashbox-restriction-edit-form"),a=BX.ajax.prepareForm(e),i=!!a&&a.data?a.data:{};BX.Sale.Cashbox.saveRestriction(t,i);this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);BX.addCustomEvent(i,"onWindowClose",function(e){e.DIV.parentNode.removeChild(e.DIV)});i.Show();i.adjustSizeEx()},saveRestriction:function(e,t){ShowWaitWindow();var a=t.RESTRICTION||{},i={action:"save_restriction",params:a,sort:t.SORT,className:e.class,cashboxId:e.cashboxId,restrictionId:e.restrictionId,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.Cashbox.insertAjaxRestrictionHtml(e.HTML)}else{alert(e.ERROR)}},onfailure:function(){CloseWaitWindow()}})},deleteRestriction:function(e,t){if(!e)return;ShowWaitWindow();var a={action:"delete_restriction",restrictionId:e,cashboxId:t,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.Cashbox.insertAjaxRestrictionHtml(e.HTML);if(e.ERROR)BX.debug("Error deleting restriction: "+e.ERROR)}else{BX.debug("Error deleting restriction!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error refreshing restriction!")}})},insertAjaxRestrictionHtml:function(e){var t=BX.processHTML(e),a=BX("sale-cashbox-restriction-container");if(!a)return;BX.loadCSS(t["STYLE"]);a.innerHTML=t["HTML"];for(var i in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][i]["JS"])},generateConnectionLink:function(){var e={action:"generate_link",sessid:BX.bitrix_sessid()};BX.showWait();BX.ajax({data:e,method:"POST",dataType:"json",url:this.ajaxUrl,onsuccess:BX.delegate(function(e){BX.closeWait();if(e){if(!e.ERROR){text='<div style="margin-bottom: 50px;">'+'<ul class="adm-cashbox-list2 adm-cashbox-inner">'+'<li style="margin-bottom: 20px;">'+BX.message("SALE_CASHBOX_WINDOW_STEP_1")+'<br> <b id="generated-link">'+e.LINK+"</b></li>"+"<li>"+BX.message("SALE_CASHBOX_WINDOW_STEP_2")+"</li>"+"</ul>"+"</div>";var t=new BX.CAdminDialog({content:text,title:BX.message("SALE_CASHBOX_WINDOW_TITLE"),resizable:false,draggable:false,height:"145",width:"516",buttons:[{title:top.BX.message("SALE_CASHBOX_COPY"),id:"copyCheckBtn",name:"copybtn",className:top.BX.browser.IsIE()&&top.BX.browser.IsDoctype()&&!top.BX.browser.IsIE10()?"":"adm-btn-save"},BX.CAdminDialog.btnCancel]});t.Show();var a=BX("copyCheckBtn");if(a)BX.clipboard.bindCopyClick(a,{text:e.LINK})}else{BX.debug(e.ERROR)}}},this),onfailure:function(){BX.debug("onfailure: generateConnectionLink")}})},connectToKKM:function(e){BX.ajax({data:{action:"generate_link",sessid:BX.bitrix_sessid()},method:"POST",dataType:"json",url:this.ajaxUrl,onsuccess:BX.delegate(function(t){BX.closeWait();if(t){if(!t.ERROR){var a=e.parentNode;BX.hide(a);var i=BX("container-instruction");i.style.display="block";BX("cashbox-url").innerHTML=t.LINK}else{BX.debug(t.ERROR)}}},this),onfailure:function(){BX.debug("onfailure: generateConnectionLink")}})},reloadSettings:function(){var e=BX("KKM_ID");e=e?e.value:"";BX.ajax({data:{action:"reload_settings",kkmId:e,handler:BX("HANDLER").value||"",sessid:BX.bitrix_sessid()},method:"POST",dataType:"json",url:this.ajaxUrl,onsuccess:BX.delegate(function(e){BX.closeWait();if(e&&e.hasOwnProperty("HTML"))BX("sale-cashbox-settings-container").innerHTML=e.HTML;if(e&&e.hasOwnProperty("MODEL_HTML")){BX("sale-cashbox-models-container").innerHTML=e.MODEL_HTML}else{BX("sale-cashbox-models-container").innerHTML=""}if(e.hasOwnProperty("GENERAL_REQUIRED_FIELDS")){var t=BX("edit1_edit_table");var a=BX.findChildren(t,{tag:"tr"},true);for(var i in a){if(a.hasOwnProperty(i)){var r=BX.findChild(a[i],{tag:"span"},true);if(r){var n=r.className;if(n&&n.indexOf("adm-required-field")>-1)r.className=""}var s=a[i].getAttribute("id");if(s)s=s.slice(3);if(e.GENERAL_REQUIRED_FIELDS.hasOwnProperty(s)){if(r){r.className="adm-required-field"}else{a[i].firstElementChild.innerHTML='<span class="adm-required-field">'+a[i].firstElementChild.innerHTML+"</span>"}}}}}},this),onfailure:function(){BX.debug("onfailure: reloadSettings")}})},reloadOfdSettings:function(){BX.ajax({data:{action:"reload_ofd_settings",handler:BX("OFD").value||"",sessid:BX.bitrix_sessid()},method:"POST",dataType:"json",url:this.ajaxUrl,onsuccess:BX.delegate(function(e){BX.closeWait();if(e&&e.hasOwnProperty("HTML"))BX("sale-cashbox-ofd-settings-container").innerHTML=e.HTML},this),onfailure:function(){BX.debug("onfailure: reloadOfdSettings")}})},showCreateCheckWindow:function(){var e=BX.create("form",{props:{name:"check_form_add",id:"check_form_add"}});var t=BX.create("div",{attrs:{className:"adm-info-message"},text:BX.message("CASHBOX_ADD_CHECK_TITLE")});e.appendChild(t);var a=BX.create("table",{props:{id:"check_add_control_table"},children:[BX.create("tr",{children:[BX.create("td",{text:BX.message("CASHBOX_ADD_CHECK_INPUT_ORDER")+":"}),BX.create("td",{children:[BX.create("input",{props:{name:"ORDER_ID",onchange:BX.delegate(function(){this.onChangeInputOrderId()},this)},attrs:{className:"sale-discount-bus-select",value:"",type:"text"}})]})]}),BX.create("tr",{props:{id:"check_entities_body"}}),BX.create("tbody",{props:{id:"check_info_block"}})]});e.appendChild(a);var i=new BX.CAdminDialog({title:BX.message("CASHBOX_CREATE_WINDOW_TITLE"),content:e,resizable:false,draggable:true,height:"300",width:"516",buttons:[{title:BX.message("JS_CORE_WINDOW_SAVE"),className:top.BX.browser.IsIE()&&top.BX.browser.IsDoctype()&&!top.BX.browser.IsIE10()?"":"adm-btn-save",action:BX.delegate(function(){var e=BX("check_form_add");var t={sessid:BX.bitrix_sessid(),formData:BX.ajax.prepareForm(e),action:"add_check"};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_cashbox_ajax.php",data:t,onsuccess:function(e){if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{i.Close();location.reload()}},onfailure:function(){BX.debug("Select params error")}})},this)},{title:top.BX.message("JS_CORE_WINDOW_CANCEL"),id:"cancelCheckBtn",name:"cancel"}]});BX.bind(BX("cancelCheckBtn"),"click",BX.delegate(function(){i.Close();i.DIV.parentNode.removeChild(i.DIV)}),this);i.Show()},onChangeInputOrderId:function(){var e=BX("check_form_add");var t={sessid:BX.bitrix_sessid(),formData:BX.ajax.prepareForm(e),action:"get_order_entities"};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_cashbox_ajax.php",data:t,onsuccess:BX.delegate(function(e){if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{var t,a,i;var r=BX.create("select",{props:{id:"ENTITY_CODE",name:"ENTITY_CODE",onchange:BX.delegate(function(){var e=BX("check_form_add");var t={sessid:BX.bitrix_sessid(),formData:BX.ajax.prepareForm(e),action:"get_data_for_check"};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_cashbox_ajax.php",data:t,onsuccess:BX.delegate(function(e){if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{var t=BX("check_info_block");t.innerHTML="";var a=this.constructCheckInfoBlock(e);for(i in a){if(a.hasOwnProperty(i))t.appendChild(a[i])}}},this),onfailure:function(){BX.debug("Select params error")}})},this)}});if(e.PAYMENTS){t=BX.create("optgroup",{attrs:{label:BX.message("CASHBOX_ADD_CHECK_OPTGROUP_PAYMENTS")}});for(i in e.PAYMENTS){if(e.PAYMENTS.hasOwnProperty(i)){a=BX.create("option",{text:BX.message("CASHBOX_ADD_CHECK_PAYMENT")+" "+e.PAYMENTS[i].ID,attrs:{value:e.PAYMENTS[i].CODE}});t.appendChild(a)}}r.appendChild(t)}if(e.SHIPMENTS){t=BX.create("optgroup",{attrs:{label:BX.message("CASHBOX_ADD_CHECK_OPTGROUP_SHIPMENTS")}});for(i in e.SHIPMENTS){if(e.SHIPMENTS.hasOwnProperty(i)){a=BX.create("option",{text:BX.message("CASHBOX_ADD_CHECK_SHIPMENT")+" "+e.SHIPMENTS[i].ID,attrs:{value:e.SHIPMENTS[i].CODE}});t.appendChild(a)}}r.appendChild(t)}var n=BX("check_info_block");n.innerHTML="";n=BX("check_entities_body");n.innerHTML="";var s=BX.create("td",{text:BX.message("CASHBOX_ADD_CHECK_ENTITIES")+": "});n.appendChild(s);s=BX.create("td",{children:[r]});n.appendChild(s);r.onchange()}},this),onfailure:function(){BX.debug("Select params error")}})},constructCheckInfoBlock:function(e){var t,a;var i=[];select=BX.create("select",{attrs:{id:"CHECK_TYPE"},props:{name:"CHECK_TYPE",onchange:BX.delegate(function(){var e=BX("related_entity_list");e.innerHTML="";BX.hide(e.parentNode);var i=BX("ENTITY_CODE").value;var r={sessid:BX.bitrix_sessid(),entityCode:i,checkType:BX("CHECK_TYPE").value,action:"get_related_entities"};BX.ajax({method:"post",dataType:"json",url:"/bitrix/admin/sale_cashbox_ajax.php",data:r,onsuccess:BX.delegate(function(e){if(e.ERROR&&e.ERROR.length>0){alert(e.ERROR)}else{var i=BX("related_entity_list");if(e.PAYMENTS){for(t in e.PAYMENTS){if(!e.PAYMENTS.hasOwnProperty(t))continue;a=this.createSinglePayment(e.PAYMENTS[t]);i.appendChild(a)}}if(e.SHIPMENTS){for(t in e.SHIPMENTS){if(!e.SHIPMENTS.hasOwnProperty(t))continue;a=this.createSingleShipment(e.SHIPMENTS[t],e.FFD_105_ENABLED);i.appendChild(a)}}var r=i.parentNode;if(!e.PAYMENTS&&!e.SHIPMENTS){BX.hide(r)}else{BX.show(r,"table-row")}}},this),onfailure:function(){BX.debug("Select params error")}})},this)}});for(t in e.CHECK_TYPES){if(!e.CHECK_TYPES.hasOwnProperty(t))continue;option=BX.create("option",{text:e.CHECK_TYPES[t].NAME,attrs:{value:e.CHECK_TYPES[t].ID}});select.appendChild(option)}var r=BX.create("tr",{children:[BX.create("td",{text:BX.message("CASHBOX_ADD_CHECK_TYPE_CHECKS")+": "}),BX.create("td",{children:[select]})]});i.push(r);var n=BX.create("td",{attrs:{id:"related_entity_list"}});if(e.PAYMENTS){for(t in e.PAYMENTS){if(!e.PAYMENTS.hasOwnProperty(t))continue;a=this.createSinglePayment(e.PAYMENTS[t]);n.appendChild(a)}}if(e.SHIPMENTS){for(t in e.SHIPMENTS){if(!e.SHIPMENTS.hasOwnProperty(t))continue;a=this.createSingleShipment(e.SHIPMENTS[t],e.FFD_105_ENABLED);n.appendChild(a)}}r=BX.create("tr",{children:[BX.create("td",{text:BX.message("CASHBOX_ADD_CHECK_ADDITIONAL_ENTITIES")+": "}),n]});i.push(r);return i},createSinglePayment:function(e){var t=BX.create("input",{props:{id:"payment_"+e.ID,name:"PAYMENTS["+e.ID+"][ID]",onclick:function(){var e=this.nextElementSibling;if(this.checked)e.style.color="";else e.style.color="#D2D1D1";var t=e.nextElementSibling;if(t)t.disabled=!this.checked}},attrs:{type:"checkbox",value:e.ID}});var a=BX.create("div",{children:[t,BX.create("label",{text:BX.message("CASHBOX_ADD_CHECK_PAYMENT")+" "+e.ID+": "+e.NAME+" ",attrs:{style:"color: #D2D1D1",for:"payment_"+e.ID}})]});if(e.PAYMENT_TYPES){var i=BX.create("select",{props:{name:"PAYMENTS["+e.ID+"][TYPE]",id:"payment_"+e.ID},attrs:{disabled:"disabled"}});for(j in e.PAYMENT_TYPES){if(!e.PAYMENT_TYPES.hasOwnProperty(j))continue;var r=BX.create("option",{text:e.PAYMENT_TYPES[j].NAME,attrs:{value:e.PAYMENT_TYPES[j].CODE}});i.appendChild(r)}a.appendChild(i)}return a},createSingleShipment:function(e,t){var a=BX.create("input",{props:{id:"shipment_"+e.ID,name:"SHIPMENTS["+e.ID+"][ID]",onclick:function(){var e=this.nextElementSibling;if(this.checked)e.style.color="";else e.style.color="#D2D1D1";if(!t){var a=this.parentNode.parentNode;var i=BX.findChildren(a,{tag:"input"},true);for(var r in i){if(i.hasOwnProperty(r)){if(i[r].id===this.id)continue;i[r].disabled=this.checked}}}}},attrs:{type:"checkbox",value:e.ID}});var i=BX.create("div",{children:[a,BX.create("label",{text:BX.message("CASHBOX_ADD_CHECK_SHIPMENT")+" "+e.ID+": "+e.NAME,attrs:{style:"color: #D2D1D1",for:"shipment_"+e.ID}})]});return i}}})(window);