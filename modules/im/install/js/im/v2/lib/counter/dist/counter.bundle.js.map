{"version":3,"file":"counter.bundle.js","sources":["../src/counter.js"],"sourcesContent":["import { EventEmitter, BaseEvent } from 'main.core.events';\nimport { Store } from 'ui.vue3.vuex';\n\nimport { Core } from 'im.v2.application.core';\nimport { DesktopManager } from 'im.v2.lib.desktop';\nimport { Logger } from 'im.v2.lib.logger';\nimport { EventType } from 'im.v2.const';\n\ntype CounterMap = {[chatId: string]: number};\n\ntype InitialCounters = {\n\tCHAT: CounterMap,\n\tLINES: CounterMap,\n\tCOLLAB: CounterMap,\n\tCOPILOT: CounterMap,\n\tCHANNEL_COMMENT: {\n\t\t[channelChatId: string]: {\n\t\t\t[commentChatId: string]: number,\n\t\t}\n\t},\n\tCHAT_MUTED: number[],\n\tCHAT_UNREAD: number[],\n\tCOLLAB_UNREAD: number[],\n\tTYPE: {\n\t\t'ALL': number,\n\t\t'CHAT': number,\n\t\t'NOTIFY': number,\n\t\t'LINES': number,\n\t\t'COLLAB': number,\n\t}\n};\n\nexport class CounterManager\n{\n\tstatic #instance: CounterManager;\n\n\t#store: Store;\n\n\tstatic getInstance(): CounterManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tCounterManager.getInstance();\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tconst { counters } = Core.getApplicationData();\n\t\tLogger.warn('CounterManager: counters', counters);\n\t\tthis.#init(counters);\n\t}\n\n\tremoveBrowserTitleCounter()\n\t{\n\t\tconst regexp = /^(?<counterWithWhitespace>\\(\\d+\\)\\s).*/;\n\t\tconst matchResult: ?RegExpMatchArray = document.title.match(regexp);\n\t\tif (!matchResult?.groups.counterWithWhitespace)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst counterPrefixLength = matchResult.groups.counterWithWhitespace;\n\t\tdocument.title = document.title.slice(counterPrefixLength);\n\t}\n\n\t#init(counters: InitialCounters)\n\t{\n\t\tconst preparedChatCounters = this.#prepareChatCounters(counters.CHAT, counters.CHAT_UNREAD);\n\t\tthis.#store.dispatch('counters/setUnloadedChatCounters', preparedChatCounters);\n\t\tthis.#store.dispatch('counters/setUnloadedLinesCounters', counters.LINES);\n\t\tthis.#store.dispatch('counters/setUnloadedCopilotCounters', counters.COPILOT);\n\t\tconst preparedCollabCounters = this.#prepareChatCounters(counters.COLLAB, counters.COLLAB_UNREAD);\n\t\tthis.#store.dispatch('counters/setUnloadedCollabCounters', preparedCollabCounters);\n\t\tthis.#store.dispatch('counters/setCommentCounters', counters.CHANNEL_COMMENT);\n\t\tthis.#store.dispatch('notifications/setCounter', counters.TYPE.NOTIFY);\n\n\t\tthis.#subscribeToCountersChange();\n\t\tthis.#sendChatCounterChangeEvent(counters.TYPE.CHAT);\n\t\tthis.#sendNotificationCounterChangeEvent(counters.TYPE.NOTIFY);\n\t\tthis.#sendLinesCounterChangeEvent(counters.TYPE.LINES);\n\t}\n\n\t#prepareChatCounters(counters: CounterMap, unreadCounters: number[]): CounterMap\n\t{\n\t\tconst resultCounters = { ...counters };\n\t\tunreadCounters.forEach((markedChatId) => {\n\t\t\tconst unreadChatHasCounter = Boolean(counters[markedChatId]);\n\t\t\tif (unreadChatHasCounter)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tresultCounters[markedChatId] = 1;\n\t\t});\n\n\t\treturn resultCounters;\n\t}\n\n\t#subscribeToCountersChange()\n\t{\n\t\tthis.#store.watch(notificationCounterWatch, (newValue: number) => {\n\t\t\tthis.#sendNotificationCounterChangeEvent(newValue);\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\n\t\tthis.#store.watch(chatCounterWatch, (newValue: number) => {\n\t\t\tthis.#sendChatCounterChangeEvent(newValue);\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\n\t\tthis.#store.watch(linesCounterWatch, (newValue: number) => {\n\t\t\tthis.#sendLinesCounterChangeEvent(newValue);\n\t\t\tthis.#onTotalCounterChange();\n\t\t});\n\t}\n\n\t#sendNotificationCounterChangeEvent(notificationsCounter: number)\n\t{\n\t\tconst event = new BaseEvent({ compatData: [notificationsCounter] });\n\t\tEventEmitter.emit(window, EventType.counter.onNotificationCounterChange, event);\n\t}\n\n\t#sendChatCounterChangeEvent(chatCounter: number)\n\t{\n\t\tconst event = new BaseEvent({ compatData: [chatCounter] });\n\t\tEventEmitter.emit(window, EventType.counter.onChatCounterChange, event);\n\t}\n\n\t#sendLinesCounterChangeEvent(linesCounter: number)\n\t{\n\t\tconst LINES_TYPE = 'LINES';\n\t\tconst event = new BaseEvent({ compatData: [linesCounter, LINES_TYPE] });\n\t\tEventEmitter.emit(window, EventType.counter.onLinesCounterChange, event);\n\t}\n\n\t#onTotalCounterChange()\n\t{\n\t\tconst notificationCounter = this.#store.getters['notifications/getCounter'];\n\t\tconst chatCounter = this.#store.getters['counters/getTotalChatCounter'];\n\t\tconst linesCounter = this.#store.getters['counters/getTotalLinesCounter'];\n\t\tconst totalCounter = notificationCounter + chatCounter + linesCounter;\n\n\t\tif (DesktopManager.getInstance().isDesktopActive())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#updateBrowserTitleCounter(totalCounter);\n\t}\n\n\t#updateBrowserTitleCounter(newCounter: number)\n\t{\n\t\tconst regexp = /^\\((?<currentCounter>\\d+)\\)\\s(?<text>.*)+/;\n\t\tconst matchResult: ?RegExpMatchArray = document.title.match(regexp);\n\t\tif (matchResult?.groups.currentCounter)\n\t\t{\n\t\t\tconst currentCounter = Number.parseInt(matchResult.groups.currentCounter, 10);\n\t\t\tif (newCounter !== currentCounter)\n\t\t\t{\n\t\t\t\tconst counterPrefix = newCounter > 0 ? `(${newCounter}) ` : '';\n\t\t\t\tdocument.title = `${counterPrefix}${matchResult.groups.text}`;\n\t\t\t}\n\t\t}\n\t\telse if (newCounter > 0)\n\t\t{\n\t\t\tdocument.title = `(${newCounter}) ${document.title}`;\n\t\t}\n\t}\n}\n\nconst notificationCounterWatch = (state, getters) => {\n\treturn getters['notifications/getCounter'];\n};\n\nconst chatCounterWatch = (state, getters) => {\n\treturn getters['counters/getTotalChatCounter'];\n};\n\nconst linesCounterWatch = (state, getters) => {\n\treturn getters['counters/getTotalLinesCounter'];\n};\n"],"names":["CounterManager","getInstance","init","constructor","Core","getStore","counters","getApplicationData","Logger","warn","removeBrowserTitleCounter","regexp","matchResult","document","title","match","groups","counterWithWhitespace","counterPrefixLength","slice","preparedChatCounters","CHAT","CHAT_UNREAD","dispatch","LINES","COPILOT","preparedCollabCounters","COLLAB","COLLAB_UNREAD","CHANNEL_COMMENT","TYPE","NOTIFY","unreadCounters","resultCounters","forEach","markedChatId","unreadChatHasCounter","Boolean","watch","notificationCounterWatch","newValue","chatCounterWatch","linesCounterWatch","notificationsCounter","event","BaseEvent","compatData","EventEmitter","emit","window","EventType","counter","onNotificationCounterChange","chatCounter","onChatCounterChange","linesCounter","LINES_TYPE","onLinesCounterChange","notificationCounter","getters","totalCounter","DesktopManager","isDesktopActive","newCounter","currentCounter","Number","parseInt","counterPrefix","text","state"],"mappings":"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"}