(function(e,t,i,n){"use strict";var r,a,s,o,l,c,d;function u(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=f(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var n=0;var r=function e(){};return{s:r,n:function t(){if(n>=e.length)return{done:true};return{done:false,value:e[n++]}},e:function e(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(s)throw o}}}}function f(e,t){if(!e)return;if(typeof e==="string")return p(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return p(e,t)}function p(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,n=new Array(t);i<t;i++){n[i]=e[i]}return n}function v(e,t){m(e,t);t.add(e)}function m(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function h(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var g=t.Reflection.namespace("BX.Bizproc");var b=function e(t){return JSON.stringify(t,(function(e,t){if(typeof t==="boolean"){return t?"1":"0"}return t}))};var T=new WeakSet;var y=new WeakSet;var I=new WeakSet;var C=new WeakSet;var N=function(){function e(i){babelHelpers.classCallCheck(this,e);v(this,C);v(this,I);v(this,y);v(this,T);babelHelpers.defineProperty(this,"constantPrefix","Constant__");babelHelpers.defineProperty(this,"parameterPrefix","Parameter__");if(t.Type.isPlainObject(i)){this.baseNode=i.baseNode;this.leftMenuNode=i.leftMenuNode;this.saveButtonNode=i.saveButtonNode;this.formNode=i.formNode;this.documentType=i.documentType;this.signedParameters=i.signedParameters;this.saveCallback=i.saveCallback}this.automationDesigner=BX.Bizproc.Automation.Designer.getInstance().component}babelHelpers.createClass(e,[{key:"init",value:function e(){var n=this;if(this.saveButtonNode){t.Event.bind(this.saveButtonNode,"click",this.saveHandler.bind(this))}if(this.baseNode&&this.leftMenuNode){this.initMenu()}if(this.formNode){this.scriptNameNode=this.formNode.elements.NAME;t.Event.bind(this.scriptNameNode,"blur",(function(){if(!t.Type.isStringFilled(n.scriptNameNode.value)){t.Dom.addClass(n.scriptNameNode.closest(".ui-ctl"),"ui-ctl-danger")}else{t.Dom.removeClass(n.scriptNameNode.closest(".ui-ctl"),"ui-ctl-danger")}}))}if(this.automationDesigner){i.EventEmitter.subscribe(this.automationDesigner,"onTemplateConstantAdd",(function(){if(n.configsMenuItem){n.configsMenuItem.addNoticeIcon()}}))}}},{key:"saveHandler",value:function e(){var i=this;var n=new FormData(this.formNode);var r={};var a=u(n.entries()),s;try{for(a.s();!(s=a.n()).done;){var o=s.value;r[o[0]]=o[1]}}catch(e){a.e(e)}finally{a.f()}if(!h(this,I,E).call(this,r.NAME)){t.Dom.removeClass(this.saveButtonNode,"ui-btn-wait");return false}var l=h(this,T,P).call(this);this.setTemplateValues(l);if(!h(this,C,B).call(this,l.getConstants(),l.collectUsages().Constant)){t.Dom.removeClass(this.saveButtonNode,"ui-btn-wait");return false}BX.ajax.runComponentAction("bitrix:bizproc.script.edit","saveScript",{analyticsLabel:r.ID>0?"bizprocScriptUpdate":"bizprocScriptAdd",data:{signedParameters:this.signedParameters,documentType:this.documentType,script:r,robotsTemplate:b(l.serialize())}}).then((function(e){if(e.status==="success"&&!t.Type.isArrayFilled(e.errors)){l.markModified(false)}if(t.Type.isFunction(i.saveCallback)){i.saveCallback(e)}}))}},{key:"initMenu",value:function e(){var i=this;Array.from(this.leftMenuNode.querySelectorAll('[data-role="menu-item"]')).forEach((function(e){t.Event.bind(e,"click",i.menuActivateHandler.bind(i,e.getAttribute("data-page")));if(e.getAttribute("data-page")==="configs"&&BX.UI.DropdownMenuItem.getItemByNode){i.configsMenuItem=BX.UI.DropdownMenuItem.getItemByNode(e)}}))}},{key:"menuActivateHandler",value:function e(i){var n=this;Array.from(this.baseNode.querySelectorAll("[data-section]")).forEach((function(e){if(e.getAttribute("data-section")===i){if(i==="configs"&&t.Dom.hasClass(e,"bizproc-script-edit-block-hidden")){n.showConfigsHandler(e)}else{n.setTemplateValues(h(n,T,P).call(n))}t.Dom.removeClass(e,"bizproc-script-edit-block-hidden")}else{t.Dom.addClass(e,"bizproc-script-edit-block-hidden")}}))}},{key:"showConfigsHandler",value:function e(i){var n=this;t.Dom.clean(i);var s=h(this,T,P).call(this);var o=s.getConstants();var l=s.getParameters();var c=[];s.robots.forEach((function(e){var t=n.renderRobotConfigBlock(e,o,l);if(t){c.push(t)}}));if(c.length){t.Dom.append(t.Tag.render(r||(r=babelHelpers.taggedTemplateLiteral(['<form data-role="constant-list" onsubmit="return false;">',"</form>"])),c),i)}else{return t.Dom.append(t.Tag.render(a||(a=babelHelpers.taggedTemplateLiteral(['<div class="ui-alert ui-alert-default ui-alert-xs ui-alert-icon-info">\n\t\t\t\t\t<span class="ui-alert-message">',"</span>\n\t\t\t\t</div>"])),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_SECTION_CONFIGS_EMPTY")),i)}}},{key:"renderRobotConfigBlock",value:function e(i,n,r){var a=this;var c=i.collectUsages();var d=[];if(c.Constant.size){var u=false;c.Constant.forEach((function(e){var i=n.find((function(t){return t.Id===e&&t.Type!=="file"}));if(i){if(!u){d.push(t.Tag.render(s||(s=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-script-edit-item">\n\t\t\t\t\t\t\t<div class="bizproc-script-edit-title">','</div>\n\t\t\t\t\t\t\t<div class="bizproc-script-edit-text">',"</div>\n\t\t\t\t\t\t</div>"])),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_CONSTANT_LABEL"),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_CONSTANT_DESCRIPTION")));u=true}d.push(a.renderPropertyBlock(i,a.constantPrefix))}}))}if(c.Parameter.size){var f=false;c.Parameter.forEach((function(e){var i=r.find((function(t){return t.Id===e&&t.Type!=="file"}));if(i){if(!f){d.push(t.Tag.render(o||(o=babelHelpers.taggedTemplateLiteral(['<div class="bizproc-script-edit-item">\n\t\t\t\t\t\t\t<div class="bizproc-script-edit-title">','</div>\n\t\t\t\t\t\t\t<div class="bizproc-script-edit-text">',"</div>\n\t\t\t\t\t\t</div>"])),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_PARAMETER_LABEL"),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_PARAMETER_DESCRIPTION")));f=true}d.push(a.renderPropertyBlock(i,a.parameterPrefix))}}))}if(!d.length){return null}return t.Tag.render(l||(l=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-slider-section">\n\t\t\t\t<div class="ui-slider-heading-4 ui-slider-heading-4--bizproc-icon">',"</div>\n\t\t\t\t","\n\t\t\t</div>"])),t.Text.encode(i.getTitle()),d)}},{key:"renderPropertyBlock",value:function e(i,n){var r=BX.Bizproc.FieldType.renderControlPublic(this.automationDesigner.document.getRawType(),i,n+i.Id,i.Default,false);return t.Tag.render(c||(c=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="bizproc-script-edit-item">\n\t\t\t\t<div class="bizproc-script-edit-subtitle">','</div>\n\t\t\t\t<div class="bizproc-script-edit-text">','</div>\n\t\t\t\t<a onclick="','" class="ui-link ui-link-secondary ui-link-dashed">','</a>\n\t\t\t\t<div class="bizproc-script-edit-field">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>"])),t.Text.encode(i.Name),t.Text.encode(i.Description),this.changePropertyDescription.bind(this,n,i),t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_BTN_CHANGE"),r)}},{key:"changePropertyDescription",value:function e(i,n,r){var a=this;var s=r.currentTarget;var o=s.previousElementSibling;t.Dom.hide(s);var l=t.Tag.render(d||(d=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input value="" type="text" class="ui-ctl-element">\n\t\t'])));l.value=n.Description||"";t.Dom.clean(o);t.Dom.append(l,o);l.focus();var c=function e(){var r=l.value.trim();n.Description=r;t.Dom.clean(o);o.textContent=r;t.Dom.show(s);var c=h(a,T,P).call(a);if(i===a.constantPrefix){c.updateConstant(n.Id,n)}else{c.updateParameter(n.Id,n)}};t.Event.bind(l,"blur",c);t.Event.bind(l,"keydown",(function(e){if(e.keyCode===13){t.Event.unbind(l,"blur",c);c()}}))}},{key:"setTemplateValues",value:function e(t){var i=this;var n=this.baseNode?this.baseNode.querySelector('[data-role="constant-list"]'):null;if(!n){return}var r=new FormData(n);t.getConstants().forEach((function(e){t.setConstantValue(e.Id,r.get(i.constantPrefix+e.Id))}));t.getParameters().forEach((function(e){t.setParameterValue(e.Id,r.get(i.parameterPrefix+e.Id))}))}}]);return e}();function P(){return this.automationDesigner.templateManager.templates[0]}function D(e){if(BX.UI.DropdownMenuItem.getItemByNode){var t=BX.UI.DropdownMenuItem.getItemByNode(this.leftMenuNode.querySelector('[data-page="'.concat(e,'"]')));this.menuActivateHandler(e);t&&t.setActiveHandler()}if(e==="general"){this.scriptNameNode.focus()}if(e!=="configs"){this.setTemplateValues(h(this,T,P).call(this))}}function E(e){if(!t.Type.isStringFilled(e)){n.UI.Notification.Center.notify({content:t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_VALIDATION_EMPTY_NAME")});h(this,y,D).call(this,"general");return false}return true}function B(e,i){var r=true;e.forEach((function(e){if(i.has(e.Id)&&!t.Type.isStringFilled(e.Default)){r=false}}));if(!r){n.UI.Notification.Center.notify({content:t.Loc.getMessage("BIZPROC_SCRIPT_EDIT_VALIDATION_EMPTY_CONFIGS")});h(this,y,D).call(this,"configs")}return r}g.ScriptEditComponent=N})(this.window=this.window||{},BX,BX.Event,BX);
//# sourceMappingURL=script.map.js