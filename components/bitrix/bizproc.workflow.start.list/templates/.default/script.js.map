{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Reflection, Type, Event, Text, Dom, Tag, Loc } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\nimport { Alert, AlertColor } from 'ui.alerts';\nimport { Starter } from 'bizproc.workflow.starter';\n\nimport 'sidepanel';\n\nconst namespace = Reflection.namespace('BX.Bizproc.Component');\n\nclass WorkflowStartList\n{\n\tgridId;\n\tcreateTemplateButton;\n\terrorsContainerDiv;\n\n\t#signedDocumentType: string;\n\t#signedDocumentId: string;\n\t#counters: Map = new Map();\n\n\tconstructor(options)\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.gridId = options.gridId;\n\t\tthis.createTemplateButton = options.createTemplateButton;\n\t\tthis.errorsContainerDiv = options.errorsContainerDiv;\n\n\t\tif (Type.isStringFilled(options.signedDocumentType))\n\t\t{\n\t\t\tthis.#signedDocumentType = options.signedDocumentType;\n\t\t}\n\n\t\tif (Type.isStringFilled(options.signedDocumentId))\n\t\t{\n\t\t\tthis.#signedDocumentId = options.signedDocumentId;\n\t\t}\n\t}\n\n\tinit()\n\t{\n\t\tif (this.createTemplateButton)\n\t\t{\n\t\t\tEvent.bind(this.createTemplateButton, 'click', event => this.createTemplate());\n\t\t}\n\n\t\tBX.UI.Hint.init(document);\n\n\t\tif (this.getGrid())\n\t\t{\n\t\t\tBX.Bizproc.Component.WorkflowStartList.colorPinnedRows(this.getGrid());\n\t\t}\n\n\t\tEventEmitter.subscribe('Grid::updated', this.#onAfterGridUpdated.bind(this));\n\t}\n\n\tcreateTemplate(): void\n\t{\n\t\talert('Create Template');\n\t}\n\n\teditTemplate(templateId): void\n\t{\n\t\talert('Edit Template ' + templateId);\n\t}\n\n\tstatic changePin(templateId, gridId, event) {\n\t\tconst eventData = event.getData();\n\t\tconst button = eventData.button;\n\n\t\tif (Dom.hasClass(button, BX.Grid.CellActionState.ACTIVE))\n\t\t{\n\t\t\tBX.Bizproc.Component.WorkflowStartList.action('unpin', templateId, gridId);\n\t\t\tDom.removeClass(button, BX.Grid.CellActionState.ACTIVE);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tBX.Bizproc.Component.WorkflowStartList.action('pin', templateId, gridId);\n\t\t\tDom.addClass(button, BX.Grid.CellActionState.ACTIVE);\n\t\t}\n\n\t\tconst grid = BX.Main.gridManager.getInstanceById(gridId);\n\t\tif (grid)\n\t\t{\n\t\t\tBX.Bizproc.Component.WorkflowStartList.colorPinnedRows(grid);\n\t\t}\n\t}\n\n\tstatic action(action, templateId, gridId): void\n\t{\n\t\tconst component = 'bitrix:bizproc.workflow.start.list';\n\n\t\tBX.ajax.runComponentAction(component, action, {\n\t\t\tmode: 'class',\n\t\t\tdata: {\n\t\t\t\ttemplateId,\n\t\t\t},\n\t\t}).then(\n\t\t\t(response) => {\n\t\t\t\tconst grid = BX.Main.gridManager.getInstanceById(gridId);\n\t\t\t\tif (grid)\n\t\t\t\t{\n\t\t\t\t\tgrid.reload();\n\t\t\t\t}\n\t\t\t},\n\t\t);\n\t}\n\n\tshowErrors(errors: Array<{message: string}>)\n\t{\n\t\tthis.errorsContainerDiv.style.margin = '10px';\n\n\t\terrors.forEach((error) => {\n\t\t\tconst alert = new Alert({\n\t\t\t\ttext: error.message,\n\t\t\t\tcolor: AlertColor.DANGER,\n\t\t\t\tcloseBtn: true,\n\t\t\t\tanimated: true,\n\t\t\t});\n\n\t\t\talert.renderTo(this.errorsContainerDiv);\n\t\t});\n\t}\n\n\treloadGrid()\n\t{\n\t\tconst grid = this.getGrid();\n\t\tif (grid)\n\t\t{\n\t\t\tgrid.reload();\n\t\t}\n\t}\n\n\tgetGrid(): ?BX.Main.grid\n\t{\n\t\tif (this.gridId)\n\t\t{\n\t\t\treturn BX.Main.gridManager && BX.Main.gridManager.getInstanceById(this.gridId);\n\t\t}\n\n\t\treturn null;\n\t}\n\n\tstartWorkflow(event: PointerEvent, templateId: number)\n\t{\n\t\tevent.preventDefault();\n\n\t\tconst id = Text.toNumber(templateId);\n\t\tif (id <= 0 || !this.#signedDocumentType || !this.#signedDocumentId)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst afterSuccessStart = () => {\n\t\t\tconst slider = BX.SidePanel.Instance.getSliderByWindow(window);\n\t\t\tif (slider)\n\t\t\t{\n\t\t\t\tslider.close();\n\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!this.#counters.has(templateId))\n\t\t\t{\n\t\t\t\tthis.#counters.set(templateId, 0);\n\t\t\t}\n\t\t\tthis.#counters.set(templateId, this.#counters.get(templateId) + 1);\n\n\t\t\tthis.getGrid()?.reload();\n\t\t};\n\n\t\tStarter.singleStart({\n\t\t\tsignedDocumentId: this.#signedDocumentId,\n\t\t\tsignedDocumentType: this.#signedDocumentType,\n\t\t\ttemplateId: id,\n\t\t}, afterSuccessStart);\n\t}\n\n\t#onAfterGridUpdated()\n\t{\n\t\tif (this.getGrid())\n\t\t{\n\t\t\tBX.UI.Hint.init(this.getGrid().getContainer());\n\t\t\tBX.Bizproc.Component.WorkflowStartList.colorPinnedRows(this.getGrid());\n\t\t}\n\n\t\tthis.#counters.forEach((value, key) => {\n\t\t\tconst counter = document.querySelector(`[data-role=\"template-${key}-counter\"]`);\n\t\t\tif (Type.isElementNode(counter))\n\t\t\t{\n\t\t\t\tDom.clean(counter);\n\t\t\t\tDom.append(this.#renderStartedByMeNow(key), counter);\n\t\t\t}\n\t\t});\n\t}\n\n\tstatic colorPinnedRows(grid) {\n\t\tgrid.getRows().getRows().forEach((row) => {\n\t\t\tconst node = row.getNode();\n\t\t\tif (Type.isElementNode(node.querySelector('.main-grid-cell-content-action-pin.main-grid-cell-content-action-active')))\n\t\t\t{\n\t\t\t\tDom.addClass(node, 'bizproc-workflow-start-list-item-pinned');\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tDom.removeClass(node, 'bizproc-workflow-start-list-item-pinned');\n\t\t\t}\n\t\t});\n\t}\n\n\t#renderStartedByMeNow(templateId: number): HTMLElement\n\t{\n\t\tlet message = Text.encode(Loc.getMessage(\n\t\t\t'BIZPROC_CMP_TMP_WORKKFLOW_START_LIST_START_COUNTER',\n\t\t\t{\n\t\t\t\t'#COUNTER#': this.#counters.get(templateId),\n\t\t\t},\n\t\t));\n\n\t\tmessage = message.replace('[bold]', '<span class=\"bizproc-workflow-start-list-column-start-counter\">');\n\t\tmessage = message.replace('[/bold]', '</span>');\n\n\t\treturn Tag.render`<div class=\"ui-typography-text-xs\">${message}</div>`;\n\t}\n}\n\nnamespace.WorkflowStartList = WorkflowStartList;\n"],"names":["namespace","Reflection","WorkflowStartList","options","Map","Type","isPlainObject","gridId","createTemplateButton","errorsContainerDiv","isStringFilled","signedDocumentType","signedDocumentId","Event","bind","event","createTemplate","BX","UI","Hint","init","document","getGrid","Bizproc","Component","colorPinnedRows","EventEmitter","subscribe","alert","templateId","errors","style","margin","forEach","error","Alert","text","message","color","AlertColor","DANGER","closeBtn","animated","renderTo","grid","reload","Main","gridManager","getInstanceById","preventDefault","id","Text","toNumber","afterSuccessStart","slider","SidePanel","Instance","getSliderByWindow","window","close","has","set","get","Starter","singleStart","eventData","getData","button","Dom","hasClass","Grid","CellActionState","ACTIVE","action","removeClass","addClass","component","ajax","runComponentAction","mode","data","then","response","getRows","row","node","getNode","isElementNode","querySelector","getContainer","value","key","counter","clean","append","encode","Loc","getMessage","replace","Tag","render"],"mappings":"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"}