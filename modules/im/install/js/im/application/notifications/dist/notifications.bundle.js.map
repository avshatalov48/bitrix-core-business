{"version":3,"file":"notifications.bundle.js","sources":["../src/notifications.js"],"sourcesContent":["/**\n * Bitrix Im\n * Core application\n *\n * @package bitrix\n * @subpackage im\n * @copyright 2001-2020 Bitrix\n */\nimport {Core} from \"im.application.core\";\nimport {VueVendorV2} from \"ui.vue\";\n\n// vue components\nimport 'im.component.notifications';\nimport { ImNotificationsPullHandler } from \"im.provider.pull\";\n\nexport class NotificationsApplication\n{\n\t/* region 01. Initialize */\n\n\tconstructor(params = {})\n\t{\n\t\tthis.inited = false;\n\t\tthis.initPromise = new BX.Promise;\n\n\t\tthis.params = params;\n\n\t\tthis.template = null;\n\t\tthis.rootNode = this.params.node || document.createElement('div');\n\t\tthis.legacyMode = this.params.mode === 'legacy';\n\t\tthis.initCounter = this.params.initCounter || null;\n\t\tthis.templateTemp = null;\n\n\t\tthis.eventBus = new VueVendorV2; // TODO remove this! change to Bitrix EventEmitter\n\n\t\tthis.initCore()\n\t\t\t.then(() => this.initParams())\n\t\t\t.then(() => this.initComponent(this.legacyMode))\n\t\t\t.then(() => this.initPullClient())\n\t\t\t.then(() => this.initPullHandlers())\n\t\t\t.then(() => this.initComplete())\n\n\t\t;\n\t}\n\n\tinitPullClient()\n\t{\n\t\tthis.pullClient = BX.PULL;\n\n\t\treturn new Promise((resolve, reject) => resolve());\n\t}\n\n\tinitPullHandlers()\n\t{\n\t\tthis.pullClient.subscribe(\n\t\t\tnew ImNotificationsPullHandler({\n\t\t\t\tstore: this.controller.getStore(),\n\t\t\t\tapplication: this,\n\t\t\t\tcontroller: this.controller,\n\t\t\t})\n\t\t);\n\n\t\treturn new Promise((resolve, reject) => resolve());\n\t}\n\n\tinitCore()\n\t{\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tCore.ready().then(controller => {\n\t\t\t\tthis.controller = controller;\n\t\t\t\tresolve();\n\t\t\t})\n\t\t});\n\t}\n\n\tinitParams()\n\t{\n\t\tif (this.initCounter)\n\t\t{\n\t\t\tthis.controller.getStore().dispatch('notifications/setCounter', {\n\t\t\t\tunreadTotal: this.initCounter\n\t\t\t});\n\t\t}\n\t\tthis.controller.getStore().subscribe(mutation => this.eventStoreInteraction(mutation));\n\n\t\treturn new Promise((resolve, reject) => resolve());\n\t}\n\n\tinitComponent(legacy)\n\t{\n\t\tif (legacy)\n\t\t{\n\t\t\treturn new Promise((resolve, reject) => resolve());\n\t\t}\n\n\t\tlet template;\n\t\tif (this.legacyMode)\n\t\t{\n\t\t\ttemplate = '<bx-im-component-notifications/>';\n\t\t}\n\t\telse\n\t\t{\n\t\t\ttemplate = `<div style=\"height: 400px; border: 1px solid #ccc;\">\n\t\t\t\t<bx-im-component-notifications/>\n\t\t\t</div>`\n\t\t}\n\n\t\treturn this.controller.createVue(this, {el: this.rootNode, template}).then(vue => {\n\t\t\tthis.template = vue;\n\t\t\tthis.template.$el.id = this.rootNode.substr(1);\n\t\t\treturn new Promise((resolve, reject) => resolve());\n\t\t});\n\t}\n\n\tinitComplete()\n\t{\n\t\tthis.inited = true;\n\t\tthis.initPromise.resolve(this);\n\t}\n\n\tready()\n\t{\n\t\tif (this.inited)\n\t\t{\n\t\t\tlet promise = new BX.Promise;\n\t\t\tpromise.resolve(this);\n\n\t\t\treturn promise;\n\t\t}\n\n\t\treturn this.initPromise;\n\t}\n\n\t/* endregion 01. Initialize */\n\n\t/* region 02. Event Bus */\n\temit(eventName, params = {})\n\t{\n\t\tthis.eventBus.$emit(eventName, params);\n\n\t\treturn true;\n\t}\n\n\tlisten(eventName, callback)\n\t{\n\t\tif (typeof callback !== 'function')\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.eventBus.$on(eventName, callback);\n\n\t\treturn true;\n\t}\n\t/* endregion 02. Event Bus */\n\n\thasVueInstance()\n\t{\n\t\treturn this.template !== null;\n\t}\n\n\tdestroyVueInstance()\n\t{\n\t\tthis.template.$destroy();\n\t\tthis.template = null;\n\t}\n\n\teventStoreInteraction(data)\n\t{\n\t\tif (data.type === 'notifications/setCounter')\n\t\t{\n\t\t\tif (parseInt(data.payload) >= 0)\n\t\t\t{\n\t\t\t\tBXIM.notify.updateNotifyNextCount(parseInt(data.payload), true);\n\t\t\t}\n\t\t}\n\t}\n}"],"names":["NotificationsApplication","params","inited","initPromise","BX","Promise","template","rootNode","node","document","createElement","legacyMode","mode","initCounter","templateTemp","eventBus","VueVendorV2","initCore","then","initParams","initComponent","initPullClient","initPullHandlers","initComplete","pullClient","PULL","resolve","reject","subscribe","ImNotificationsPullHandler","store","controller","getStore","application","Core","ready","dispatch","unreadTotal","mutation","eventStoreInteraction","legacy","createVue","el","vue","$el","id","substr","promise","eventName","$emit","callback","$on","$destroy","data","type","parseInt","payload","BXIM","notify","updateNotifyNextCount"],"mappings":"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"}