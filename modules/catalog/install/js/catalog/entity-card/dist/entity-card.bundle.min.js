this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};(function(e,t,i,n,r,a,s,o,l,d,u,c){"use strict";var h,p,g,f,b,m;var y=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);n.innerWrapper=null;return n}babelHelpers.createClass(t,[{key:"getContentWrapper",value:function e(){return this.innerWrapper}},{key:"layout",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["catalog-entity-editor-content-block-field-iblock-section"]});this.adjustWrapper();if(this.isNeedToDisplay()){this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(this._mode===BX.UI.EntityEditorMode.edit){this.drawEditMode()}else{this.drawViewMode()}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}}this.registerLayout(t);this._hasLayout=true}},{key:"drawEditMode",value:function e(){this.defaultInput=d.Tag.render(h||(h=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="','[]" value="0">'])),this.getName());this._wrapper.appendChild(this.defaultInput);this.innerWrapper=d.Tag.render(p||(p=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-content-block"></div>'])));this._wrapper.appendChild(this.innerWrapper);d.ajax.runComponentAction("bitrix:catalog.productcard.iblocksectionfield","lazyLoad",{mode:"ajax",data:{iblockId:this.getIblockId(),productId:this.getProductId(),selectedSectionIds:this.getValue()}}).then(this.renderFromResponse.bind(this))["catch"]((function(e){throw new Error(e.errors.join("\n"))}))}},{key:"renderFromResponse",value:function e(t){if(!this._wrapper){return}d.Runtime.html(this.innerWrapper,t.data.html,{callback:this.initEntitySelector.bind(this)})}},{key:"initEntitySelector",value:function e(){u.EventEmitter.subscribe(u.EventEmitter.GLOBAL_TARGET,"Item:onSelect",this.markAsChanged.bind(this));u.EventEmitter.subscribe(u.EventEmitter.GLOBAL_TARGET,"Item:onDeselect",this.markAsChanged.bind(this))}},{key:"changeDisplay",value:function e(t,i){if(!t){return}t.style.display=i?"":"none"}},{key:"markAsChanged",value:function e(i){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"markAsChanged",this).call(this);u.EventEmitter.emit(this.getEditor(),"IblockSectionField:onChange",[this].concat(babelHelpers.toConsumableArray(i.getData())))}},{key:"drawViewMode",value:function e(){if(this.hasNoSections()){this.innerWrapper=d.Tag.render(g||(g=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"])),d.Loc.getMessage("CATALOG_ENTITY_CARD_EMPTY_SECTION"));d.Dom.addClass(this._wrapper,"ui-entity-editor-content-block-click-empty")}else{var t=[];this.getSections().forEach((function(e){var i="";if(d.Type.isStringFilled(e.PICTURE)){i=d.Tag.render(f||(f=babelHelpers.taggedTemplateLiteral(['<span class="ui-tile-selector-item-picture" style="background-image: url(\'',"');\"></span>"])),d.Text.encode(e.PICTURE))}t.push(d.Tag.render(b||(b=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="ui-tile-selector-item ui-tile-selector-item-readonly-yes">\n\t\t\t\t\t\t','\n\t\t\t\t\t\t<span data-role="tile-item-name">',"</span>\n\t\t\t\t\t</span>\n\t\t\t\t"])),i,d.Text.encode(e.NAME)))}));this.innerWrapper=d.Tag.render(m||(m=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t\t<span class="ui-tile-selector-selector-wrap readonly">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>"])),t)}this._wrapper.appendChild(this.innerWrapper)}},{key:"getSections",value:function e(){return this._model.getField("IBLOCK_SECTION_DATA",{})}},{key:"getIblockId",value:function e(){return this._model.getField("IBLOCK_ID",0)}},{key:"getProductId",value:function e(){return this._model.getField("ID",0)}},{key:"hasNoSections",value:function e(){var t=this.getValue();return t.length===0||t.length===1&&(t.includes("0")||t.includes(0))}},{key:"doClearLayout",value:function e(t){if(this.defaultInput){d.Dom.clean(this.defaultInput);this.defaultInput=null}if(this.innerWrapper){d.Dom.clean(this.innerWrapper);this.innerWrapper=null}this._hasLayout=false}},{key:"getModeSwitchType",value:function e(t){var i=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){i|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return i}}]);return t}(BX.UI.EntityEditorField);var v,E,C,I,_,T,k,S,B,D,O,P,H,A,L,w,U,M;function X(e,t){R(e,t);t.add(e)}function R(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function N(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var G=new WeakSet;var F=new WeakSet;var x=new WeakSet;var j=new WeakSet;var Y=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));X(babelHelpers.assertThisInitialized(n),j);X(babelHelpers.assertThisInitialized(n),x);X(babelHelpers.assertThisInitialized(n),F);X(babelHelpers.assertThisInitialized(n),G);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"getValue",(function(){return BX.UI.EntityEditorBoolean.superclass.getValue.apply(this)}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"hasContentToDisplay",(function(){return true}));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"doPrepareContextMenuItems",(function(e){if(this.isShownSymbolicCode){e.push({value:"hide_symbolic_code",text:d.Loc.getMessage("CATALOG_ENTITY_CARD_HIDE_SYMBOLIC_CODE")})}else{e.push({value:"show_symbolic_code",text:d.Loc.getMessage("CATALOG_ENTITY_CARD_SHOW_SYMBOLIC_CODE")})}}));n.initialize(e,i);n.isShownSymbolicCode=n.getSchemeShowCodeState()==="true";n.allowToGenerateCode=n._editor.isNew();return n}babelHelpers.createClass(t,[{key:"getSchemeShowCodeState",value:function e(){return BX.prop.get(this.getSchemeElement()._options,"showCode")}},{key:"setSchemeShowCodeState",value:function e(t){this.getSchemeElement()._options["showCode"]=t}},{key:"processContextMenuCommand",value:function e(i,n){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"processContextMenuCommand",this).call(this,i,n);var r=document.getElementById("code_container");var a=document.getElementById("name_code_marker");if(n==="hide_symbolic_code"){this.isShownSymbolicCode=false;this.allowToGenerateCode=this._editor.isNew();if(this._mode===BX.UI.EntityEditorMode.edit){var s=document.getElementById("code_text");var o=document.getElementById("code_state_button");s.readOnly=this.allowToGenerateCode;if(this.allowToGenerateCode){s.className="ui-ctl-element ui-ctl-element-symbol-code-input-disabled";o.className="ui-ctl-before ui-ctl-icon-chain"}else{s.className="ui-ctl-element";o.className="ui-ctl-before ui-ctl-icon-unchain"}r.className="name-code-container name-code-container-hidden";d.Dom.removeClass(this._innerWrapper,"ui-entity-editor-content-block--code");d.Dom.addClass(this._innerWrapper,"ui-entity-editor-content-block--no-code");a.style.display="inline"}else{this.refreshLayout()}this.setSchemeShowCodeState(false);this._parent.processChildControlSchemeChange(this)}else if(n==="show_symbolic_code"){this.isShownSymbolicCode=true;if(this._mode===BX.UI.EntityEditorMode.edit){r.className="name-code-container";d.Dom.removeClass(this._innerWrapper,"ui-entity-editor-content-block--no-code");d.Dom.addClass(this._innerWrapper,"ui-entity-editor-content-block--code");a.style.display="none"}else{this.refreshLayout()}this.setSchemeShowCodeState(true);this._parent.processChildControlSchemeChange(this)}}},{key:"createTitleMarker",value:function e(){if(this._mode===BX.UI.EntityEditorMode.view){return null}var t=this.isShownSymbolicCode?"none":"inline";if(this._mode===BX.UI.EntityEditorMode.edit){return d.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(['<span id="name_code_marker" style="color: rgb(255, 0, 0); display: ',';">*</span>'])),t)}}},{key:"layout",value:function e(t){if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["ui-entity-editor-field-multitext"]});this.adjustWrapper();if(!this.isNeedToDisplay()){this.registerLayout(t);this._hasLayout=true;return}var i=this.getTitle();var n=this.getValue();this._inputValue=n;this._innerWrapper=null;if(this.isDragEnabled()){d.Dom.append(this.createDragButton(),this._wrapper)}d.Dom.append(this.createTitleNode(i),this._wrapper);if(this._mode===BX.UI.EntityEditorMode.edit){this._inputContainer=d.Tag.render(E||(E=babelHelpers.taggedTemplateLiteral(["<div></div>"])));for(var r in n){d.Dom.append(this.createSingleInput(n[r],r),this._inputContainer)}this._innerWrapper=d.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-content-block">',"</div>"])),this._inputContainer);if(this.isShownSymbolicCode){d.Dom.addClass(this._innerWrapper,"ui-entity-editor-content-block--code")}else{d.Dom.addClass(this._innerWrapper,"ui-entity-editor-content-block--no-code")}}else{this._innerWrapper=d.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block">',"</div>\n\t\t\t"])),this.getViewInnerLayout())}d.Dom.append(this._innerWrapper,this._wrapper);if(this.isContextMenuEnabled()){d.Dom.append(this.createContextMenuButton(),this._wrapper)}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true}},{key:"validate",value:function e(t){if(this._mode!==BX.UI.EntityEditorMode.edit){throw"BX.UI.EntityEditorMultiText. Invalid validation context"}if(!this.isEditable()){return true}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var i=false;if(this._inputContainer){var n=document.getElementById("name_text");if(BX.util.trim(n.value)===""){i=true;d.Dom.addClass(n.parentNode,"ui-ctl-danger")}else{d.Dom.removeClass(n.parentNode,"ui-ctl-danger")}}var r=!this.isRequired()||!i;if(!r){t.addError(BX.UI.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return r}},{key:"showError",value:function e(t,i){if(!this._errorContainer){this._errorContainer=d.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-field-error-text"></div>'])))}this._errorContainer.innerHTML=BX.util.htmlspecialchars(t);if(this._wrapper){d.Dom.append(this._errorContainer,this._wrapper)}this._hasError=true}},{key:"createSingleInput",value:function e(t,i){var n=d.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div id="','_container"></div>\n\t\t'])),i.toLowerCase());var r=d.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-ctl ui-ctl-w100 ui-ctl-textbox"></div>\n\t\t'])));var a;if(this.getLineCount()>1){a=d.Tag.render(S||(S=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<textarea\n\t\t\t\t\tclass="ui-ctl-element ui-entity-editor-field-textarea"\n\t\t\t\t\tname="','"\n\t\t\t\t\tid="','"\n\t\t\t\t\trows="','">',"</textarea>\n\t\t\t"])),i,i.toLowerCase()+"_text",this.getLineCount(),BX.util.htmlspecialchars(t)||"")}else{a=d.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input\n\t\t\t\t\tclass="ui-ctl-element"\n\t\t\t\t\tname="','"\n\t\t\t\t\tid="','"\n\t\t\t\t\ttype="text"\n\t\t\t\t\tvalue="','"/>\n\t\t\t'])),i,i.toLowerCase()+"_text",BX.util.htmlspecialchars(t)||"")}d.Event.bind(a,"input",N(this,F,z).bind(this,i));if(i==="CODE"){if(!this.isShownSymbolicCode){d.Dom.addClass(n,"name-code-container-hidden")}if(this.allowToGenerateCode===true){d.Dom.addClass(a,"ui-ctl-element-symbol-code-input-disabled");d.Dom.attr(a,"readonly",this.allowToGenerateCode)}d.Dom.addClass(r,"ui-ctl-ext-before-icon");d.Dom.addClass(n,"name-code-container");var s=this.allowToGenerateCode?"chain":"unchain";var o=d.Tag.render(D||(D=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button name="','" class="ui-ctl-before ui-ctl-icon-','" id="code_state_button"></button>\n\t\t\t'])),i,s);d.Event.bind(o,"click",N(this,j,q).bind(this));d.Dom.append(o,r)}var l=N(this,G,V).call(this,i);d.Dom.append(l,n);d.Dom.append(a,r);d.Dom.append(r,n);return n}},{key:"getViewInnerLayout",value:function e(){var t=d.Tag.render(O||(O=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block-text"></div>\n\t\t'])));var i=this.getValue();if(!this.isShownSymbolicCode){d.Dom.append(d.Tag.render(P||(P=babelHelpers.taggedTemplateLiteral(["<p>","</p>"])),BX.util.htmlspecialchars(i.NAME)),t);return t}d.Dom.append(d.Tag.render(H||(H=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-symbol-code-label">\n\t\t\t\t',"\n\t\t\t</div>\n\t\t"])),d.Loc.getMessage("CATALOG_ENTITY_CARD_NAME")),t);d.Dom.append(d.Tag.render(A||(A=babelHelpers.taggedTemplateLiteral(["<p>","</p>"])),BX.util.htmlspecialchars(i.NAME)),t);d.Dom.addClass(t,"ui-entity-editor-symbol-code");var n=i.CODE===""?d.Loc.getMessage("UI_ENTITY_EDITOR_FIELD_EMPTY"):i.CODE;var r=this.allowToGenerateCode?"ui-entity-editor-symbol-code-value-chain":"ui-entity-editor-symbol-code-value-unchain";d.Dom.append(d.Tag.render(L||(L=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-symbol-code-box">\n\t\t\t\t<div class="ui-entity-editor-symbol-code-label">\n\t\t\t\t\t','\n\t\t\t\t</div>\n\t\t\t\t<div class="ui-entity-editor-symbol-code-value ','">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),d.Loc.getMessage("CATALOG_ENTITY_CARD_SYMBOLIC_CODE"),r,BX.util.htmlspecialchars(n)),t);return t}}]);return t}(BX.UI.EntityEditorMultiText);function V(e){var t=d.Tag.render(w||(w=babelHelpers.taggedTemplateLiteral(['<label class="ui-entity-editor-block-title"></label>'])));var i;if(e==="CODE"){i=d.Tag.render(U||(U=babelHelpers.taggedTemplateLiteral(["<span>","</span>"])),d.Loc.getMessage("CATALOG_ENTITY_CARD_SYMBOLIC_CODE"));d.Dom.append(i,t);d.Dom.append(N(this,x,W).call(this),t)}else{i=d.Tag.render(M||(M=babelHelpers.taggedTemplateLiteral(["\n\t\t\t\t<span>\n\t\t\t\t\t",'\n\t\t\t\t\t<span style="color: rgb(255, 0, 0);">*</span>\n\t\t\t\t</span>\n\t\t\t'])),d.Loc.getMessage("CATALOG_ENTITY_CARD_NAME"));d.Dom.append(i,t)}return t}function z(e){this._changeHandler();if(this.allowToGenerateCode&&e==="NAME"){var t=document.getElementById("code_text");var i=document.getElementById("name_text");t.value=BX.translit(i.value,null)}}function W(){return BX.UI.Hint.createNode(d.Loc.getMessage("CATALOG_ENTITY_CARD_SYMBOLIC_CODE_HINT"))}function q(){var e=document.getElementById("code_text");var t=document.getElementById("name_text");var i=document.getElementById("code_state_button");this.allowToGenerateCode=!this.allowToGenerateCode;e.readOnly=this.allowToGenerateCode;if(this.allowToGenerateCode){e.className="ui-ctl-element ui-ctl-element-symbol-code-input-disabled";i.className="ui-ctl-before ui-ctl-icon-chain";e.value=BX.translit(t.value,null)}else{e.className="ui-ctl-element";i.className="ui-ctl-before ui-ctl-icon-unchain";var n=document.getElementById("name_text");var r=BX.translit(n.value,null);if(e.value!==r){this.markAsChanged()}e.value=r}}var K=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);u.EventEmitter.subscribe("BX.UI.EntityEditorControlFactory:onInitialize",(function(e){var i=e.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];r.methods["entityCard"]=t.factory.bind(t)}))}babelHelpers.createClass(e,[{key:"factory",value:function e(t,i,n){if(t==="iblock_section"){return new y(i,n)}else if(t==="name-code"){return new Y(i,n)}return null}}]);return e}();function Q(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Z(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Q(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Q(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var J="PROPERTY_";var $="properties";var ee=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"onChangeHandler",i.handleChange.bind(babelHelpers.assertThisInitialized(i)));i.initialize(e,n);i.isRequesting=false;i.clearServiceFields();u.EventEmitter.subscribe(i._editor,"IblockSectionField:onChange",i.onChangeHandler);return i}babelHelpers.createClass(t,[{key:"clearServiceFields",value:function e(){this.lastDataHash=null;this.initialElements=null;this.deletedControls={};this.deletedAvailableSchemes={}}},{key:"handleChange",value:function e(t){var i=this;var n=t.getData();n.shift();var r=JSON.stringify(n);if(this.lastDataHash===null||this.lastDataHash!==r){this.lastDataHash=r;clearTimeout(this.timeout);this.timeout=setTimeout((function(){i.refreshLinkedProperties(n)}),50)}}},{key:"refreshLinkedProperties",value:function e(t){var i=this;if(this.isRequesting){return}this.isRequesting=true;d.ajax.runComponentAction(this._editor._settings.ajaxData.COMPONENT_NAME,"refreshLinkedProperties",{mode:"class",signedParameters:this._editor._settings.ajaxData.SIGNED_PARAMETERS,data:{sectionIds:t}}).then((function(e){var t=i.getAllCurrentProperties();if(i.initialElements===null){i.initialElements=babelHelpers.toConsumableArray(t)}e.data.ENTITY_FIELDS.forEach((function(e){if(!t.includes(e.name)){i.addProperty(e,{layout:{forceDisplay:true},mode:BX.UI.EntityEditorMode.edit})}}));var n=e.data.ENTITY_FIELDS.map((function(e){return e.name}));t.forEach((function(e){if(!n.includes(e)){i.removeProperty(e)}}));i._editor.commitSchemeChanges();i.isRequesting=false}))["catch"]((function(e){i.isRequesting=false}))}},{key:"getAllCurrentProperties",value:function e(){var t=this._editor.getAllControls().filter((function(e){return e.getName().indexOf(J)===0})).map((function(e){return e.getName()}));var i=this._editor.getAvailableSchemeElements().filter((function(e){return e.getName().indexOf(J)===0})).map((function(e){return e.getName()}));return[].concat(babelHelpers.toConsumableArray(t),babelHelpers.toConsumableArray(i))}},{key:"addProperty",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(t.name in this.deletedControls){this.restoreDeletedProperty(this.deletedControls[t.name],i)}else if(t.name in this.deletedAvailableSchemes){this.restoreDeletedAvailableProperty(this.deletedAvailableSchemes[t.name],i)}else{this.createProperty(t,i)}}},{key:"restoreDeletedProperty",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=i.mode||t._mode;t._mode=n;t.getParent().addChild(t,Z(Z({},i),{},{enableSaving:false}));if(n===BX.UI.EntityEditorMode.edit){this._editor.registerActiveControl(t)}else if(n===BX.UI.EntityEditorMode.view){this._editor.unregisterActiveControl(t)}}},{key:"restoreDeletedAvailableProperty",value:function e(t){this._editor.addAvailableSchemeElement(t)}},{key:"createProperty",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=this._editor.getSchemeElementByName($);var r=BX.UI.EntitySchemeElement.create(t);n._elements.push(r);var a=i.mode||BX.UI.EntityEditorMode.edit;var s=this._editor.createControl(r.getType(),r.getName(),{schemeElement:r,model:this._model,parent:this,mode:a});if(!s){return}var o=this._editor.getControlById($);o.addChild(s,Z(Z({},i),{},{enableSaving:false}));return s}},{key:"removeProperty",value:function e(t){var i=this._editor.getControlByIdRecursive(t);if(i){this.deletedControls[i.getName()]=i;i.getParent().removeChild(i,{enableSaving:false});this._editor.removeAvailableSchemeElement(i.getSchemeElement());this._editor.unregisterActiveControl(i)}else{var n=this._editor.getAvailableSchemeElementByName(t);if(n){this.deletedAvailableSchemes[n.getName()]=n;this._editor.removeAvailableSchemeElement(n)}}}},{key:"rollback",value:function e(){var i=this;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this.initialElements===null){return}var n=this.getAllCurrentProperties();n.forEach((function(e){if(!i.initialElements.includes(e)){i.removeProperty(e)}}));this.initialElements.forEach((function(e){if(!n.includes(e)){i.addProperty({name:e},{layout:{forceDisplay:false},mode:BX.UI.EntityEditorMode.view})}}));this._editor.commitSchemeChanges();this.clearServiceFields()}}]);return t}(BX.UI.EntityEditorController);function te(e,t){ie(e,t);t.add(e)}function ie(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function ne(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var re=new WeakSet;var ae=new WeakSet;var se=new WeakSet;var oe=new WeakSet;var le=function(){function e(t){babelHelpers.classCallCheck(this,e);te(this,oe);te(this,se);te(this,ae);te(this,re);babelHelpers.defineProperty(this,"editedRowsIndexes",[]);this.gridId=t;u.EventEmitter.subscribe("onItemIsAdded",ne(this,re,de).bind(this));u.EventEmitter.subscribe("onFileIsDeleted",ne(this,ae,ue).bind(this))}babelHelpers.createClass(e,[{key:"getGrid",value:function e(){return BX.Main.gridManager.getInstanceById(this.gridId)}},{key:"saveEditedRows",value:function e(){var t=this;this.editedRowsIndexes=[];this.getGrid().getRows().getBodyChild().forEach((function(e){if(e.isEdit()){t.editedRowsIndexes.push(e.getNode().rowIndex)}}))}},{key:"loadEditedRows",value:function e(){var t=this.getGrid().getRows();this.editedRowsIndexes.forEach((function(e){var i=t.getByIndex(e);if(i){BX.fireEvent(i.getNode(),"click")}}))}},{key:"getEditedRowsFields",value:function e(){var t={};var i=function e(t,i,n,r){if(d.Type.isPlainObject(n)&&n.TYPE==="MONEY"){if(d.Type.isArray(r)){r.forEach((function(e){if(e.RAW_NAME===undefined&&e.NAME===i){t[i]=e.VALUE}}))}else{console.error("Error value type for `MONEY` column",r)}}else if(d.Type.isPlainObject(r)){var a;t[i]=(a=r.VALUE)!==null&&a!==void 0?a:""}else if(d.Type.isArray(r)){t[i]=[];r.forEach((function(e){if(d.Type.isPlainObject(e)){t[i].push(e.VALUE)}else{t[i].push(e)}}))}else{t[i]=r}};var n=this.getGrid().getRows();var r=n.getHeadFirstChild();var a=ne(this,oe,he).call(this);n.getBodyChild().filter((function(e){return e.isEdit()})).forEach((function(e){var n={};Array.prototype.forEach.call(e.getCells(),(function(t,s){var o=r.getCellNameByCellIndex(s);if(!o){return}if(a.length>0&&!a.includes(o)){return}var l=e.getCellEditorValue(t);var d=r.getCellEditDataByCellIndex(s);i(n,o,d,l)}));t[e.getId()]=n}));return t}}]);return e}();function de(e){var t=e.getCompatData()[0];var i=t instanceof File;var n=e.getCompatData()[2];if(n&&d.Type.isDomNode(n.fileInput)&&i){var r=this.getGrid().getContainer().contains(n.fileInput);if(r){ne(this,se,ce).call(this)}}}function ue(e){var t=e.getCompatData()[2];if(t&&d.Type.isDomNode(t.fileInput)){var i=this.getGrid().getContainer().contains(t.fileInput);if(i){ne(this,se,ce).call(this)}}}function ce(){BX.UI.Notification.Center.notify({id:"fileCloseNotification",blinkOnUpdate:false,content:d.Loc.getMessage("CATALOG_ENTITY_CARD_FILE_CLOSE_NOTIFICATION_2"),position:"top-right",width:"auto",autoHideDelay:5e3})}function he(){var e=this.getGrid().getParam("SUPPORTED_AJAX_FIELDS");if(d.Type.isArray(e)){return e}return[]}function pe(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function ge(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?pe(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):pe(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var fe=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"areaHeight",null);n.initialize(e,i);return n}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);u.EventEmitter.subscribe("Grid::thereEditedRows",this.markAsChangedHandler.bind(this));u.EventEmitter.subscribe("Grid::noEditedRows",this.checkEditorToolbar.bind(this));u.EventEmitter.subscribe("Grid::updated",this.onGridUpdated.bind(this));u.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequest.bind(this));u.EventEmitter.subscribe("onAjaxSuccess",this.ajaxSuccessHandler.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditorIncludedArea:onBeforeLoad",this.onBeforeIncludedAreaLoaded.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditorIncludedArea:onAfterLoad",this.onAfterIncludedAreaLoaded.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditor:onNothingChanged",this.onNothingChanged.bind(this));this.subscribeToFormSubmit();this.gridStore=new le(this.getGridId())}},{key:"onBeforeIncludedAreaLoaded",value:function e(t){if(d.Type.isNumber(this.areaHeight)){d.Dom.style(this.getVariationGridLoader(),"height",this.areaHeight+"px")}}},{key:"onAfterIncludedAreaLoaded",value:function e(t){d.Dom.style(this.getVariationGridLoader(),"height","");this.areaHeight=null}},{key:"onNothingChanged",value:function e(t){this.rollback()}},{key:"getVariationGridLoader",value:function e(){var t=this.getGridControl();if(t){var i=t.getWrapper();if(i){return i.querySelector(".ui-entity-editor-included-area-container-loader")}}return null}},{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);this.checkEditorToolbar();this.unsubscribeGridEvents();BX.Main.gridManager.destroy(this.getGridId())}},{key:"onAfterSave",value:function e(){if(this.isChanged()||this._editor.isChanged()){this.setGridControlCache(null);u.EventEmitter.emit("onAfterVariationGridSave",{gridId:this.getGridId()})}BX.Main.gridManager.destroy(this.getGridId());this.subscribeToFormSubmit();babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onAfterSave",this).call(this)}},{key:"setGridControlCache",value:function e(t){var i=this.getGridControl();if(i){i._loadedHtml=t}}},{key:"onBeforeSubmit",value:function e(){this.unsubscribeGridEvents()}},{key:"getVariationGridComponent",value:function e(){return d.Reflection.getClass("BX.Catalog.VariationGrid.Instance")}},{key:"unsubscribeGridEvents",value:function e(){var t,i;var n=this.getVariationGridComponent();if(n){n.destroy()}var r=(t=this.getGrid())===null||t===void 0?void 0:(i=t.getSettingsWindow())===null||i===void 0?void 0:i.getPopup();if(r){u.EventEmitter.emit(this.getGrid().getSettingsWindow().getPopup(),"onDestroy")}u.EventEmitter.unsubscribeAll("BX.Main.grid:paramsUpdated")}},{key:"ajaxSuccessHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];if(r.url.indexOf(this.getReloadUrl())===0){this.setGridControlCache(null)}}},{key:"subscribeToFormSubmit",value:function e(){u.EventEmitter.subscribe(this._editor._ajaxForm,"onBeforeSubmit",this.onBeforeSubmitForm.bind(this))}},{key:"markAsChangedHandler",value:function e(){if(!this._editor.isNew()){this.markAsChanged()}}},{key:"checkEditorToolbar",value:function e(){this._isChanged=false;if(this._editor.getActiveControlCount()>0){this._editor.showToolPanel()}else{this._editor.hideToolPanel()}if(this._editor._toolPanel){this._editor._toolPanel.clearErrors()}}},{key:"getGridControl",value:function e(){return this._editor.getControlById("variation_grid")}},{key:"onGridUpdated",value:function e(t){var i=this;var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,1),a=r[0];this.checkEditorToolbar();if(a.getId()===this.getGrid().getId()){setTimeout((function(){i.gridStore.loadEditedRows()}),0)}}},{key:"onBeforeGridRequest",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[0],a=n[1];if(!r||!r.parent||r.parent.getId()!==this.getGridId()){return}var s=a.url;if(s){var o=new d.Uri(s).getQueryParams();s=new d.Uri(this.getReloadUrl());if(o){for(var l in o){if(Object.hasOwnProperty.call(o,l)){s.setQueryParam(l,o[l])}}}s=s.toString()}else{s=this.getReloadUrl()}this.gridStore.saveEditedRows();a.sessid=BX.bitrix_sessid();a.method="POST";a.url=s;a.data=ge(ge({},a.data),{},{rows:this.gridStore.getEditedRowsFields(),signedParameters:this.getSignedParameters()});this.unsubscribeGridEvents()}},{key:"getReloadUrl",value:function e(){return this.getConfigStringParam("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getConfigStringParam("signedParameters","")}},{key:"getGridId",value:function e(){return this.getConfigStringParam("gridId","")}},{key:"getGrid",value:function e(){if(!d.Reflection.getClass("BX.Main.gridManager.getInstanceById")){return null}return BX.Main.gridManager.getInstanceById(this.getGridId())}},{key:"onBeforeSubmitForm",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];var a=this.getGrid();if(!a){return}var s=this.getGridId();var o=a.getRows().getEditSelectedValues();var l=a.getParam("COPY_ITEMS_MAP",{});for(var u in o){if(!o.hasOwnProperty(u)){continue}for(var c in o[u]){if(!o[u].hasOwnProperty(c)){continue}if(c.includes("SKU_GRID_CATALOG_GROUP")||c.includes("SKU_GRID_PURCHASING")){for(var h in o[u][c]){if(o[u][c].hasOwnProperty(h)){o[u][h]=o[u][c][h]}}}else if(c.includes("[EDIT_HTML]")){var p=c.replace("[EDIT_HTML]","");if(p.endsWith("_custom")){if("bxu_files[]"in o[u][c]){o[u][c].isFile=true;delete o[u][c]["bxu_files[]"]}if(o[u][c].isFile){for(var g in o[u][c]){if(o[u][c].hasOwnProperty(g)){var f=new RegExp(/([0-9A-Za-z_]+?(_n\d+)*)\[([A-Za-z_]+)\]/);if(f.test(g)){var b=void 0,m=void 0;var y=g.match(f);var v=babelHelpers.slicedToArray(y,4);b=v[1];m=v[3];if(b&&m){o[u][c][b]=o[u][c][b]||{};o[u][c][b][m]=o[u][c][g];delete o[u][c][g]}}}}}}o[u][p]=o[u][c];delete o[u][c]}}if(!d.Type.isNil(l[u])){o[u]["COPY_SKU_ID"]=l[u]}}if(!d.Type.isPlainObject(r.options)){r.options={}}if(!d.Type.isPlainObject(r.options.data)){r.options.data={}}r.options.data[s]=o;this.areaHeight=this.getGridControl().getWrapper().offsetHeight}}]);return t}(BX.UI.EntityEditorController);var be=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);u.EventEmitter.subscribe("onChangeVariationLink",n.markAsChanged.bind(babelHelpers.assertThisInitialized(n)));return n}babelHelpers.createClass(t,[{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this._isChanged){this._isChanged=false}}}]);return t}(BX.UI.EntityEditorController);var me=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);u.EventEmitter.subscribe("onAddGoogleMapPoint",n.markAsChanged.bind(babelHelpers.assertThisInitialized(n)));return n}babelHelpers.createClass(t,[{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this._isChanged){this._isChanged=false}}}]);return t}(BX.UI.EntityEditorController);var ye=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);u.EventEmitter.subscribe("onChangeEmployee",n.markAsChanged.bind(babelHelpers.assertThisInitialized(n)));return n}babelHelpers.createClass(t,[{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this._isChanged){this._isChanged=false}}}]);return t}(BX.UI.EntityEditorController);var ve=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);u.EventEmitter.subscribe("onChangeUser",n.markAsChanged.bind(babelHelpers.assertThisInitialized(n)));return n}babelHelpers.createClass(t,[{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this._isChanged){this._isChanged=false}}}]);return t}(BX.UI.EntityEditorController);var Ee=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);u.EventEmitter.subscribe("onChangeIblockElement",n.markAsChanged.bind(babelHelpers.assertThisInitialized(n)));return n}babelHelpers.createClass(t,[{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this._isChanged){this._isChanged=false}}}]);return t}(BX.UI.EntityEditorController);var Ce=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);return n}babelHelpers.createClass(t,[{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this._isChanged){this._isChanged=false}u.EventEmitter.unsubscribeAll("BX.Main.User.SelectorController::open")}},{key:"onBeforeSubmit",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onBeforeSubmit",this).call(this);u.EventEmitter.unsubscribeAll("BX.Main.User.SelectorController::open")}}]);return t}(BX.UI.EntityEditorController);function Ie(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function _e(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ie(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ie(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var Te=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"fieldAddHandler",n.handleFieldAdd.bind(babelHelpers.assertThisInitialized(n)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"fieldUpdateHandler",n.handleFieldUpdate.bind(babelHelpers.assertThisInitialized(n)));n.initialize(e,i);u.EventEmitter.subscribe(n._editor,"BX.UI.EntityEditor:onFieldCreate",n.fieldAddHandler);u.EventEmitter.subscribe(n._editor,"BX.UI.EntityEditor:onFieldModify",n.fieldUpdateHandler);return n}babelHelpers.createClass(t,[{key:"handleFieldAdd",value:function e(t){var i=this;var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,2),a=r[0],s=r[1];var o=this.getFieldsForm(s);d.ajax.runComponentAction(this._editor._settings.ajaxData.COMPONENT_NAME,"addProperty",{mode:"class",signedParameters:this._editor._settings.ajaxData.SIGNED_PARAMETERS,data:o}).then((function(e){var t=e.data.PROPERTY_FIELDS;if(!t){return}var n=e.data.ADDITIONAL_VALUES;if(n){var r=i._editor._model;for(var o=0,l=Object.entries(n);o<l.length;o++){var d=babelHelpers.slicedToArray(l[o],2),u=d[0],c=d[1];r.setField(u,c)}}var h=BX.UI.EntityEditorMode.view;if(a instanceof BX.UI.EntityEditorSection){h=a.getMode()}var p=i.createProperty(t,a.getName(),{layout:{notifyIfNotDisplayed:true,forceDisplay:s.showAlways},mode:h});p.toggleOptionFlag(s.showAlways);i._editor.saveSchemeChanges();i.isRequesting=false}))["catch"]((function(e){i.isRequesting=false}))}},{key:"handleFieldUpdate",value:function e(t){var i=this;var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,2),a=r[0],s=r[1];if(!(s.field instanceof BX.UI.EntityEditorControl)){return}var o=s.field;s.CODE=o.getId();var l=this.getFieldsForm(s);var u=o.getSchemeElement();u._isRequired=s.mandatory;d.ajax.runComponentAction(this._editor._settings.ajaxData.COMPONENT_NAME,"updateProperty",{mode:"class",signedParameters:this._editor._settings.ajaxData.SIGNED_PARAMETERS,data:l}).then((function(e){var t;var n=e===null||e===void 0?void 0:(t=e.data)===null||t===void 0?void 0:t.PROPERTY_FIELDS;if(o instanceof BX.UI.EntityEditorDatetime||o instanceof BX.UI.EntityEditorMultiDatetime){var r=o.getSchemeElement().getData();var l=n===null||n===void 0?void 0:n.data;if(l){r.enableTime=l.enableTime;r.dateViewFormat=l.dateViewFormat;o.refreshLayout()}}if(o instanceof BX.UI.EntityEditorCustom){o.refreshLayout()}var d=null;var u=null;if(s.multiple===true){if(o instanceof BX.UI.EntityEditorText){d="multitext"}else if(o instanceof BX.UI.EntityEditorList){d="multilist"}else if(o instanceof BX.UI.EntityEditorDatetime){d="multidatetime"}else if(o instanceof BX.UI.EntityEditorNumber){d="multinumber"}}else{if(o instanceof BX.UI.EntityEditorMultiList){d="list"}else if(o instanceof BX.UI.EntityEditorMultiDatetime){d="datetime"}else if(o instanceof BX.UI.EntityEditorMultiNumber){d="number"}else if(o instanceof BX.UI.EntityEditorMultiText){d="text"}}u=o.getSchemeElement();if((o instanceof BX.UI.EntityEditorList||o instanceof BX.UI.EntityEditorMultiList)&&n){u=BX.UI.EntitySchemeElement.create(n);d=n.type}if(d){var c=a.getChildIndex(o);var h=i._editor.createControl(d,s.CODE,{schemeElement:u,model:a._model,parent:a,mode:a.getMode()});a.addChild(h,{index:c,layout:{forceDisplay:true},enableSaving:false});o._schemeElement=null;a.removeChild(o,{enableSaving:false})}i.isRequesting=false}))["catch"]((function(e){i.isRequesting=false}))}},{key:"getFieldsForm",value:function e(t){var i=this;var n=new FormData;var r={NAME:t.label,MULTIPLE:t.multiple?"Y":"N",IS_REQUIRED:t.mandatory?"Y":"N",IS_PUBLIC:t.isPublic?"Y":"N",PROPERTY_TYPE:"S",CODE:t.CODE||""};switch(t.typeId){case"integer":case"double":r.PROPERTY_TYPE="N";break;case"list":case"multilist":r.PROPERTY_TYPE="L";(t.enumeration||[]).forEach((function(e,t){n.append(i.getFormFieldName("VALUES]["+t+"][SORT"),e.SORT);n.append(i.getFormFieldName("VALUES]["+t+"][VALUE"),e.VALUE);n.append(i.getFormFieldName("VALUES]["+t+"][ID"),e.ID)}));break;case"directory":r.USER_TYPE="directory";(t.enumeration||[]).forEach((function(e,t){n.append(i.getFormFieldName("VALUES]["+t+"][SORT"),e.SORT);n.append(i.getFormFieldName("VALUES]["+t+"][VALUE"),e.VALUE.value);n.append(i.getFormFieldName("VALUES]["+t+"][XML_ID"),e.XML_ID);n.append(i.getFormFieldName("VALUES]["+t+"][FILE_ID"),e.FILE_ID);n.append("FILES["+e.SORT+"]",e.VALUE.file)}));break;case"boolean":r.PROPERTY_TYPE="L";n.append(this.getFormFieldName("VALUES][0][VALUE"),"Y");r.LIST_TYPE="C";break;case"money":r.USER_TYPE="Money";break;case"address":r.USER_TYPE="map_google";break;case"datetime":case"multidatetime":r.USER_TYPE=t.enableTime===true?"DateTime":"Date";break;case"file":r.USER_TYPE="DiskFile";break;case"custom":r.USER_TYPE=t.userType;break}for(var a=0,s=Object.entries(r);a<s.length;a++){var o=babelHelpers.slicedToArray(s[a],2),l=o[0],d=o[1];n.append(this.getFormFieldName(l),d)}return n}},{key:"getFormFieldName",value:function e(t){return"fields["+t+"]"}},{key:"createProperty",value:function e(t,i){var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:{};var r=this._editor.getSchemeElementByName(i);if(!r){return}var a=BX.UI.EntitySchemeElement.create(t);r._elements.push(a);var s=n.mode||BX.UI.EntityEditorMode.edit;var o=this._editor.createControl(a.getType(),a.getName(),{schemeElement:a,model:this._model,parent:this,mode:s});if(!o){return}var l=this._editor.getControlById(i);l.addChild(o,_e(_e({},n),{},{enableSaving:false}));return o}}]);return t}(BX.UI.EntityEditorController);function ke(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function Se(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ke(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ke(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var Be=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"areaHeight",null);n.initialize(e,i);return n}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);u.EventEmitter.subscribe("Grid::thereEditedRows",this.markAsChangedHandler.bind(this));u.EventEmitter.subscribe("Grid::noEditedRows",this.checkEditorToolbar.bind(this));u.EventEmitter.subscribe("Grid::updated",this.onGridUpdated.bind(this));u.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequest.bind(this));u.EventEmitter.subscribe("onAjaxSuccess",this.ajaxSuccessHandler.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditorIncludedArea:onBeforeLoad",this.onBeforeIncludedAreaLoaded.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditorIncludedArea:onAfterLoad",this.onAfterIncludedAreaLoaded.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditor:onNothingChanged",this.onNothingChanged.bind(this));this.subscribeToFormSubmit();this.gridStore=new le(this.getGridId())}},{key:"onBeforeIncludedAreaLoaded",value:function e(t){if(d.Type.isNumber(this.areaHeight)){d.Dom.style(this.getProductServiceGridLoader(),"height",this.areaHeight+"px")}}},{key:"onAfterIncludedAreaLoaded",value:function e(t){d.Dom.style(this.getProductServiceGridLoader(),"height","");this.areaHeight=null}},{key:"onNothingChanged",value:function e(t){this.rollback()}},{key:"getProductServiceGridLoader",value:function e(){var t=this.getGridControl();if(t){var i=t.getWrapper();if(i){return i.querySelector(".ui-entity-editor-included-area-container-loader")}}return null}},{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);this.checkEditorToolbar();this.unsubscribeGridEvents();BX.Main.gridManager.destroy(this.getGridId())}},{key:"onAfterSave",value:function e(){if(this.isChanged()||this._editor.isChanged()){this.setGridControlCache(null);u.EventEmitter.emit("onAfterProducServiceGridSave",{gridId:this.getGridId()})}BX.Main.gridManager.destroy(this.getGridId());this.subscribeToFormSubmit();babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onAfterSave",this).call(this)}},{key:"setGridControlCache",value:function e(t){var i=this.getGridControl();if(i){i._loadedHtml=t}}},{key:"onBeforeSubmit",value:function e(){this.unsubscribeGridEvents()}},{key:"getVariationGridComponent",value:function e(){return d.Reflection.getClass("BX.Catalog.ProductServiceGrid.Instance")}},{key:"unsubscribeGridEvents",value:function e(){var t,i;var n=this.getVariationGridComponent();if(n){n.destroy()}var r=(t=this.getGrid())===null||t===void 0?void 0:(i=t.getSettingsWindow())===null||i===void 0?void 0:i.getPopup();if(r){u.EventEmitter.emit(this.getGrid().getSettingsWindow().getPopup(),"onDestroy")}u.EventEmitter.unsubscribeAll("BX.Main.grid:paramsUpdated")}},{key:"ajaxSuccessHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];if(r.url.indexOf(this.getReloadUrl())===0){this.setGridControlCache(null)}}},{key:"subscribeToFormSubmit",value:function e(){u.EventEmitter.subscribe(this._editor._ajaxForm,"onBeforeSubmit",this.onBeforeSubmitForm.bind(this))}},{key:"markAsChangedHandler",value:function e(){if(!this._editor.isNew()){this.markAsChanged()}}},{key:"checkEditorToolbar",value:function e(){this._isChanged=false;if(this._editor.getActiveControlCount()>0){this._editor.showToolPanel()}else{this._editor.hideToolPanel()}if(this._editor._toolPanel){this._editor._toolPanel.clearErrors()}}},{key:"getGridControl",value:function e(){return this._editor.getControlById("service_grid")}},{key:"onGridUpdated",value:function e(t){var i=this;var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,1),a=r[0];this.checkEditorToolbar();if(a.getId()===this.getGrid().getId()){setTimeout((function(){i.gridStore.loadEditedRows()}),0)}}},{key:"onBeforeGridRequest",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[0],a=n[1];if(!r||!r.parent||r.parent.getId()!==this.getGridId()){return}this.gridStore.saveEditedRows();a.sessid=BX.bitrix_sessid();a.method="POST";a.url=this.getReloadUrl();a.data=Se(Se({},a.data),{},{rows:this.gridStore.getEditedRowsFields(),signedParameters:this.getSignedParameters()});this.unsubscribeGridEvents()}},{key:"getReloadUrl",value:function e(){return this.getConfigStringParam("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getConfigStringParam("signedParameters","")}},{key:"getGridId",value:function e(){return this.getConfigStringParam("gridId","")}},{key:"getGrid",value:function e(){if(!d.Reflection.getClass("BX.Main.gridManager.getInstanceById")){return null}return BX.Main.gridManager.getInstanceById(this.getGridId())}},{key:"onBeforeSubmitForm",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];var a=this.getGrid();if(!a){return}var s=this.getGridId();var o=a.getRows().getEditSelectedValues();var l=a.getParam("COPY_ITEMS_MAP",{});for(var u in o){if(!o.hasOwnProperty(u)){continue}for(var c in o[u]){if(!o[u].hasOwnProperty(c)){continue}if(c.includes("SKU_GRID_CATALOG_GROUP")||c.includes("SKU_GRID_PURCHASING")){for(var h in o[u][c]){if(o[u][c].hasOwnProperty(h)){o[u][h]=o[u][c][h]}}}else if(c.includes("[EDIT_HTML]")){var p=c.replace("[EDIT_HTML]","");if(p.endsWith("_custom")){if("bxu_files[]"in o[u][c]){o[u][c].isFile=true;delete o[u][c]["bxu_files[]"]}if(o[u][c].isFile){for(var g in o[u][c]){if(o[u][c].hasOwnProperty(g)){var f=new RegExp(/([0-9A-Za-z_]+?(_n\d+)*)\[([A-Za-z_]+)\]/);if(f.test(g)){var b=void 0,m=void 0;var y=g.match(f);var v=babelHelpers.slicedToArray(y,4);b=v[1];m=v[3];if(b&&m){o[u][c][b]=o[u][c][b]||{};o[u][c][b][m]=o[u][c][g];delete o[u][c][g]}}}}}}o[u][p]=o[u][c];delete o[u][c]}}if(!d.Type.isNil(l[u])){o[u]["COPY_SKU_ID"]=l[u]}}if(!d.Type.isPlainObject(r.options)){r.options={}}if(!d.Type.isPlainObject(r.options.data)){r.options.data={}}r.options.data[s]=o;this.areaHeight=this.getGridControl().getWrapper().offsetHeight}}]);return t}(BX.UI.EntityEditorController);var De=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);u.EventEmitter.subscribe("BX.UI.EntityEditorControllerFactory:onInitialize",(function(e){var i=e.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];r.methods["entityCard"]=t.factory.bind(t)}))}babelHelpers.createClass(e,[{key:"factory",value:function e(t,i,n){if(t==="field_configurator"){return new Te(i,n)}if(t==="iblock_section"){return new ee(i,n)}if(t==="iblock_element"){return new Ee(i,n)}if(t==="variation_grid"){return new fe(i,n)}if(t==="variation_link"){return new be(i,n)}if(t==="google_map"){return new me(i,n)}if(t==="employee"){return new ye(i,n)}if(t==="user"){return new ve(i,n)}if(t==="binding_to_crm_element"){return new Ce(i,n)}if(t==="service_grid"){return new Be(i,n)}return null}}]);return e}();var Oe,Pe,He,Ae,Le;var we=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++){r[a]=arguments[a]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(r)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"fileChanged",false);return i}babelHelpers.createClass(t,[{key:"layout",value:function e(){if(this._hasLayout){return}this._wrapper=d.Tag.render(Oe||(Oe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100 ui-ctl-row"></div>\n\t\t\t'])));this._fileInput=d.Tag.render(Pe||(Pe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input class="input-image-hidden" value="','" type="file" accept="image/*">\n\t\t\t'])),BX.prop.getString(this._data,"FILE_ID",""));d.Event.bind(this._fileInput,"change",this.onFileLoaderChange.bind(this));var t=BX.prop.getString(this._data,"IMAGE_SRC","");this._wrapper.appendChild(d.Tag.render(He||(He=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="catalog-dictionary-item ','">\n\t\t\t\t<img src="','" alt="">\n\t\t\t\t',"\n\t\t\t</label>\n\t\t\t"])),t===""?"catalog-dictionary-item-empty":"",t,this._fileInput));var i=d.Text.encode(BX.prop.getString(this._data,"TEXT",""));this._labelInput=d.Tag.render(Ae||(Ae=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input \n\t\t\t\t\tclass="ui-ctl-element" \n\t\t\t\t\tvalue="','"\n\t\t\t\t\tplaceholder="','"\n\t\t\t\t>\n\t\t\t'])),i,BX.message("CATALOG_ENTITY_CARD_NEW_FIELD_ITEM_PLACEHOLDER"));this._wrapper.appendChild(this._labelInput);var n=d.Tag.render(Le||(Le=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-remove-block"></div>\n\t\t\t'])));d.Event.bind(n,"click",this.onDeleteButtonClick.bind(this));this._wrapper.appendChild(n);var r=BX.prop.getElementNode(this._settings,"anchor");if(r){this._container.insertBefore(this._wrapper,r)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true}},{key:"onFileLoaderChange",value:function e(t){var i=t.target;if(i.files&&i.files[0]){var n=new FileReader;n.onload=function(e){i.parentNode.querySelector("img").src=e.target.result};this.fileChanged=true;n.readAsDataURL(i.files[0]);i.parentNode.classList.remove("catalog-dictionary-item-empty")}}},{key:"isFileChanged",value:function e(){return this.fileChanged}},{key:"prepareData",value:function e(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";var i=this._fileInput&&this._fileInput.files&&this._fileInput.files[0]?this._fileInput.files[0]:{};var n={VALUE:{value:t,file:i},XML_ID:"",FILE_ID:""};var r=BX.prop.getString(this._data,"ID","");if(BX.type.isNotEmptyString(r)){n["XML_ID"]=r;n["FILE_ID"]=BX.prop.getString(this._data,"FILE_ID","")}return n}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityEditorUserFieldListItem);var Ue,Me,Xe,Re,Ne,Ge,Fe,xe,je;var Ye=function(e){babelHelpers.inherits(t,e);babelHelpers.createClass(t,null,[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);function t(){var e;babelHelpers.classCallCheck(this,t);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));e._enumItems=[];return e}babelHelpers.createClass(t,[{key:"layoutInternal",value:function e(){d.Dom.append(this.getInputContainer(),this._wrapper);if(this._typeId==="list"||this._typeId==="multilist"||this._typeId==="directory"){var t;d.Dom.append(d.Tag.render(Ue||(Ue=babelHelpers.taggedTemplateLiteral(['<hr class="ui-entity-editor-line">']))),this._wrapper);if(BX.prop.get((t=this._field)===null||t===void 0?void 0:t.getSchemeElement().getData(),"isConfigurable",null)!==false){d.Dom.append(this.getEnumerationContainer(),this._wrapper)}}d.Dom.append(this.getOptionContainer(),this._wrapper);d.Dom.append(this.getErrorContainer(),this._wrapper);d.Dom.append(d.Tag.render(Me||(Me=babelHelpers.taggedTemplateLiteral(['<hr class="ui-entity-editor-line">']))),this._wrapper);d.Dom.append(this.getButtonContainer(),this._wrapper)}},{key:"getOptionContainer",value:function e(){var t=this._field===null;this._optionWrapper=d.Tag.render(Xe||(Xe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t'])));if(this._typeId==="datetime"||this._typeId==="multidatetime"){this._isTimeEnabledCheckBox=this.getIsTimeEnabledCheckBox()}if(this._typeId!=="boolean"&&this._enableMandatoryControl){this._isRequiredCheckBox=this.getIsRequiredCheckBox()}if(this.isAllowedMultipleCheckBox()){this._isMultipleCheckBox=this.getMultipleCheckBox()}this._isPublic=this.getIsPublicCheckBox();this._showAlwaysCheckBox=this.createOption({caption:d.Loc.getMessage("UI_ENTITY_EDITOR_SHOW_ALWAYS"),helpUrl:"https://helpdesk.bitrix24.ru/open/7046149/",helpCode:"9627471"});this._showAlwaysCheckBox.checked=t?BX.prop.getBoolean(this._settings,"showAlways",true):this._field.checkOptionFlag(BX.UI.EntityEditorControlOptions.showAlways);if(!this.isAllowedShowAlwaysCheckBox()){d.Dom.style(this._showAlwaysCheckBox.closest("div.ui-ctl-checkbox"),"display","none")}return this._optionWrapper}},{key:"isAllowedMultipleCheckBox",value:function e(){var t,i,n,r,a,s,o,l;if(BX.prop.get(this===null||this===void 0?void 0:(t=this._field)===null||t===void 0?void 0:(i=t.getSchemeElement())===null||i===void 0?void 0:i._settings,"allowedMultiple",true)===false){return false}if(this._typeId==="boolean"){return false}var d=this===null||this===void 0?void 0:(n=this._field)===null||n===void 0?void 0:(r=n.getSchemeElement())===null||r===void 0?void 0:(a=r._settings)===null||a===void 0?void 0:a.isEnabledOfferTree;var u=this===null||this===void 0?void 0:(s=this._field)===null||s===void 0?void 0:(o=s.getSchemeElement())===null||o===void 0?void 0:(l=o._settings)===null||l===void 0?void 0:l.multiple;return!d||u}},{key:"isAllowedShowAlwaysCheckBox",value:function e(){return true}},{key:"getInputTitle",value:function e(){var t=this._editor.getUserFieldManager();return this._field?this._field.getTitle():t.getDefaultFieldLabel(this._typeId)}},{key:"getErrorContainer",value:function e(){this._errorContainer=d.Tag.render(Re||(Re=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t'])));return this._errorContainer}},{key:"getEnumerationContainer",value:function e(){var t=this;var i=d.Tag.render(Ne||(Ne=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t<span class="ui-entity-editor-block-title-text">',"</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"])),d.Loc.getMessage("UI_ENTITY_EDITOR_UF_ENUM_ITEMS"));this._enumItemContainer=d.Tag.render(Ge||(Ge=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t\t'])));d.Dom.append(this._enumItemContainer,i);var n=d.Tag.render(Fe||(Fe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-card-content-add-field">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"])),d.Loc.getMessage("UI_ENTITY_EDITOR_ADD"));d.Event.bind(n,"click",this.onEnumerationItemAddButtonClick.bind(this));d.Dom.append(d.Tag.render(xe||(xe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block-add-field">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"])),n),i);if(this._field){this._field.getItems().forEach((function(e){if(e.VALUE!==""){t.createEnumerationItem({VALUE:e.NAME,FILE_ID:e.IMAGE||null,IMAGE_SRC:e.IMAGE_SRC||"",TEXT:e.TEXT||"",ID:e.VALUE})}}))}var r=this.createEnumerationItem();this._draggable=new BX.UI.DragAndDrop.Draggable({container:this._enumItemContainer,draggable:".ui-ctl-row",dragElement:".ui-ctl-row-draggable",type:BX.UI.DragAndDrop.Draggable.CLONE});r.focus();this.initItemClickHandlers();return i}},{key:"onEnumerationItemAddButtonClick",value:function e(){this.unbindItemClickHandlers();this.createEnumerationItem().focus();this.bindLastItemClickHandler()}},{key:"onEnumerationItemClick",value:function e(){this.unbindItemClickHandlers();this.createEnumerationItem();this.bindLastItemClickHandler()}},{key:"initItemClickHandlers",value:function e(){this.unbindItemClickHandlers();this.bindLastItemClickHandler()}},{key:"unbindItemClickHandlers",value:function e(){this._enumItems.forEach((function(e){return d.Event.unbindAll(e._labelInput,"click")}))}},{key:"bindLastItemClickHandler",value:function e(){var t=this._enumItems[this._enumItems.length-1];if(t){d.Event.bindOnce(t._labelInput,"click",this.onEnumerationItemClick.bind(this))}}},{key:"createEnumerationItem",value:function e(t){var i=null;if(this._typeId==="directory"){i=we.create("",{configurator:this,container:this._enumItemContainer,data:t})}else{i=BX.UI.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemContainer,data:t})}this._enumItems.push(i);i.layout();return i}},{key:"removeEnumerationItem",value:function e(t){for(var i=0,n=this._enumItems.length;i<n;i++){if(this._enumItems[i]===t){this._enumItems[i].clearLayout();this._enumItems.splice(i,1);this.initItemClickHandlers();break}}}},{key:"prepareSaveParams",value:function e(i){var n=this;var r=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareSaveParams",this).call(this,this,arguments);if(this._typeId==="list"||this._typeId==="multilist"){r["enumeration"]=[];var a=[];this._enumItems.forEach((function(e){if(!(e instanceof BX.UI.EntityEditorUserFieldListItem)){return}var t=e.prepareData();if(!t){return}var i=BX.util.hashCode(t["VALUE"]);if(BX.util.in_array(i,a)){return}a.push(i);if(d.Type.isNil(t["ID"])){t["ID"]=d.Text.getRandom()}var s=-1;if(n._draggable){s=n._draggable.getElementIndex(e.getDraggableContainer())}s=s>=0?s:r["enumeration"].length;t["SORT"]=(d.Text.toNumber(s)+1)*100;r["enumeration"].push(t)}))}if(this._typeId==="directory"){r["enumeration"]=[];this._enumItems.forEach((function(e){if(!(e instanceof we)){return}var t=e.prepareData();if(!t){return}t["SORT"]=(r["enumeration"].length+1)*100;r["enumeration"].push(t)}))}else if(this._typeId==="datetime"||this._typeId==="multidatetime"){r["enableTime"]=this._isTimeEnabledCheckBox.checked}if(this._field){if(this._isMultipleCheckBox){r["multiple"]=this._isMultipleCheckBox.checked}}else{if(this._typeId==="boolean"){r["multiple"]=false}else if(this._isMultipleCheckBox){r["multiple"]=this._isMultipleCheckBox.checked}}if(this._isPublic){r["isPublic"]=this._isPublic.checked}if(this._typeId==="custom"){var s,o,l;r["userType"]=(s=this._field)===null||s===void 0?void 0:(o=s.getSchemeElement())===null||o===void 0?void 0:(l=o._settings)===null||l===void 0?void 0:l.settings["USER_TYPE"]}return r}},{key:"getMultipleCheckBox",value:function e(){var t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_MULTIPLE_FIELD")});if(this._field instanceof BX.UI.EntityEditorMultiText||this._field instanceof BX.UI.EntityEditorMultiNumber||this._field instanceof BX.UI.EntityEditorMultiList||this._field instanceof BX.UI.EntityEditorMultiDatetime||this._field instanceof BX.UI.EntityEditorMultiMoney||this._field instanceof BX.UI.EntityEditorCustom&&this._field.getSchemeElement()._settings.multiple){t.checked=true}return t}},{key:"onSaveButtonClick",value:function e(){var t,i;if(this._isLocked){return}if(this._mandatoryConfigurator){if(this._mandatoryConfigurator.isChanged()){this._mandatoryConfigurator.acceptChanges()}this._mandatoryConfigurator.close()}var n=this.prepareSaveParams();if(this._field instanceof BX.UI.EntityEditorCustom){this._field.getSchemeElement().mergeSettings({multiple:n.multiple});var r=["edit","view"];for(var a=0;a<r.length;a++){var s=BX.prop.getString(this._field.getSchemeElement().getData(),r[a]+"List",null);var o=BX.prop.getObject(this._field.getModel().getData(),s,null);if(o!==null){var l=n.multiple?o.MULTIPLE:o.SINGLE;var u=BX.prop.getString(this._field.getSchemeElement().getData(),r[a],null);if(BX.prop.getString(this._field.getModel().getData(),u,null)!==null){this._field.getModel().setField(u,l);this._field.getModel().setInitFieldValue(u,l);if(r[a]==="view"){if(l===""){d.Dom.clean(this._field.getContentWrapper());d.Dom.append(d.Tag.render(je||(je=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t\t\t\t\t\t<div class="ui-entity-editor-content-block-text">\n\t\t\t\t\t\t\t\t\t\t\t',"\t\t\t\t\t\t\t\n\t\t\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t\t\t"])),d.Loc.getMessage("UI_ENTITY_EDITOR_FIELD_EMPTY")),this._field.getContentWrapper())}else{this._field.getContentWrapper().innerHTML=l}}}}}}(t=this._field)===null||t===void 0?void 0:(i=t.getSchemeElement())===null||i===void 0?void 0:i.setDataParam("isPublic",n["isPublic"]);BX.onCustomEvent(this,"onSave",[this,n])}},{key:"getIsRequiredCheckBox",value:function e(){var t;if(this._mandatoryConfigurator){t=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"ui-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});t.checked=this._field&&this._field.isRequired()||this._mandatoryConfigurator.isCustomized();this._mandatoryConfigurator.setSwitchCheckBox(t);this._mandatoryConfigurator.setLabel(t.nextSibling);this._mandatoryConfigurator.setEnabled(t.checked);this._mandatoryConfigurator.adjust()}else{t=this.createOption({caption:d.Loc.getMessage("UI_ENTITY_EDITOR_UF_REQUIRED_FIELD")});t.checked=this._field&&this._field.isRequired()}return t}},{key:"getIsTimeEnabledCheckBox",value:function e(){var t=this.createOption({caption:d.Loc.getMessage("UI_ENTITY_EDITOR_UF_ENABLE_TIME")});t.checked=this._field&&this._field.isTimeEnabled();return t}},{key:"getIsPublicCheckBox",value:function e(){var t=this.createOption({caption:d.Loc.getMessage("CATALOG_ENTITY_EDITOR_IS_PUBLIC_PROPERTY")});if(!this._field){t.checked=true}else{t.checked=this._field.getSchemeElement()&&BX.prop.get(this._field.getSchemeElement().getData(),"isPublic",true)}return t}}]);return t}(BX.UI.EntityEditorFieldConfigurator);d.Reflection.namespace("BX.Catalog").IblockFieldConfigurator=Ye;var Ve=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"createFieldConfigurator",value:function e(t,i){if(!BX.type.isPlainObject(t)){throw"IblockFieldConfigurationManager: The 'params' argument must be object."}return this.getSimpleFieldConfigurator(t,i)}},{key:"getSimpleFieldConfigurator",value:function e(t,i){var n="";var r=BX.prop.get(t,"field",null);if(r){n=r.getType();r.setVisible(false);if(!BX.prop.get(r.getSchemeElement().getData(),"isProductProperty",false)){return this._fieldConfigurator=BX.UI.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null})}else if(BX.prop.get(r.getSchemeElement().getData(),"userType",false)){n=BX.prop.getString(r.getSchemeElement().getData(),"userType")}}else{n=BX.prop.get(t,"typeId",BX.UI.EntityUserFieldType.string)}this._fieldConfigurator=Ye.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null});return this._fieldConfigurator}},{key:"isCreationEnabled",value:function e(){var t,i;return((t=this._editor)===null||t===void 0?void 0:t.isSectionEditEnabled())&&!((i=this._editor)!==null&&i!==void 0&&i.isReadOnly())}},{key:"getCreationPageUrl",value:function e(t){return this.creationPageUrl}},{key:"openCreationPageUrl",value:function e(t){BX.SidePanel.Instance.open(this.getCreationPageUrl(t),{width:900,allowChangeHistory:false,cacheable:false})}},{key:"setCreationPageUrl",value:function e(t){return this.creationPageUrl=t}},{key:"getTypeInfos",value:function e(){var t=[];t.push({name:"string",title:BX.message("UI_ENTITY_EDITOR_UF_STRING_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_STRING_LEGEND")});t.push({name:"list",title:BX.message("UI_ENTITY_EDITOR_UF_ENUM_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_ENUM_LEGEND")});t.push({name:"datetime",title:BX.message("UI_ENTITY_EDITOR_UF_DATETIME_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_DATETIME_LEGEND")});t.push({name:"address",title:BX.message("UI_ENTITY_EDITOR_UF_ADDRESS_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_ADDRESS_LEGEND")});t.push({name:"money",title:BX.message("UI_ENTITY_EDITOR_UF_MONEY_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_MONEY_LEGEND")});t.push({name:"boolean",title:BX.message("UI_ENTITY_EDITOR_BOOLEAN_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_BOOLEAN_LEGEND")});t.push({name:"double",title:BX.message("UI_ENTITY_EDITOR_UF_DOUBLE_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_DOUBLE_LEGEND")});t.push({name:"directory",title:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_TITLE"),legend:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_LEGEND")});t.push({name:"custom",title:BX.message("UI_ENTITY_EDITOR_UF_CUSTOM_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_CUSTOM_LEGEND")});return t}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityConfigurationManager);var ze,We,qe,Ke,Qe;var Ze=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"appendEnumerationSettings",value:function e(){var t=this;if(this._typeId==="list"||this._typeId==="multilist"){d.Dom.append(d.Tag.render(ze||(ze=babelHelpers.taggedTemplateLiteral(['<hr class="ui-entity-editor-line">']))),this._wrapper);var i=d.Tag.render(We||(We=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t\t<span class="ui-entity-editor-block-title-text">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"])),BX.message("UI_ENTITY_EDITOR_UF_ENUM_ITEMS"));d.Dom.append(i,this._wrapper);this._enumItemContainer=d.Tag.render(qe||(qe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t\t\t'])));d.Dom.append(this._enumItemContainer,i);var n=d.Tag.render(Ke||(Ke=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-entity-card-content-add-field">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t"])),BX.message("UI_ENTITY_EDITOR_ADD"));d.Event.bind(n,"click",this.onEnumerationItemAddButtonClick.bind(this));d.Dom.append(d.Tag.render(Qe||(Qe=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-entity-editor-content-block-add-field">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t"])),n),i);if(this._field){this._field.getItems().forEach((function(e){if(e.VALUE!==""){t.createEnumerationItem({VALUE:e.NAME,ID:e.VALUE})}}))}this.createEnumerationItem();this.initItemFocusHandlers()}}},{key:"onEnumerationItemAddButtonClick",value:function e(){this.unbindItemFocusHandlers();this.createEnumerationItem().focus();this.bindLastItemFocusHandler()}},{key:"onEnumerationItemFocus",value:function e(){this.unbindItemFocusHandlers();this.createEnumerationItem();this.bindLastItemFocusHandler()}},{key:"initItemFocusHandlers",value:function e(){this.unbindItemFocusHandlers();this.bindLastItemFocusHandler()}},{key:"unbindItemFocusHandlers",value:function e(){this._enumItems.forEach((function(e){return d.Event.unbindAll(e._labelInput,"focus")}))}},{key:"bindLastItemFocusHandler",value:function e(){var t=this._enumItems[this._enumItems.length-1];if(t){d.Event.bindOnce(t._labelInput,"focus",this.onEnumerationItemFocus.bind(this))}}},{key:"createEnumerationItem",value:function e(t){var i=BX.UI.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemContainer,data:t});this._enumItems.push(i);i.layout();return i}},{key:"removeEnumerationItem",value:function e(t){for(var i=0,n=this._enumItems.length;i<n;i++){if(this._enumItems[i]===t){this._enumItems[i].clearLayout();this._enumItems.splice(i,1);this.initItemFocusHandlers();break}}}},{key:"prepareSaveParams",value:function e(i){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareSaveParams",this).call(this,this,arguments);if(this._typeId==="list"||this._typeId==="multilist"){n["enumeration"]=[];var r=[];this._enumItems.forEach((function(e){if(!(e instanceof BX.UI.EntityEditorUserFieldListItem)){return}var t=e.prepareData();if(!t){return}var i=BX.util.hashCode(t["VALUE"]);if(BX.util.in_array(i,r)){return}r.push(i);t["SORT"]=(n["enumeration"].length+1)*100;n["enumeration"].push(t)}))}else if(this._typeId==="datetime"||this._typeId==="multidatetime"){n["enableTime"]=this._isTimeEnabledCheckBox.checked}return n}},{key:"getMultipleCheckBox",value:function e(){var t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_MULTIPLE_FIELD")});if(this._field instanceof BX.UI.EntityEditorMultiText||this._field instanceof BX.UI.EntityEditorMultiNumber||this._field instanceof BX.UI.EntityEditorMultiList||this._field instanceof BX.UI.EntityEditorMultiDatetime){t.checked=true}return t}},{key:"getIsRequiredCheckBox",value:function e(){var t=null;if(this._typeId!=="boolean"){if(this._enableMandatoryControl){if(this._mandatoryConfigurator){t=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"ui-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});t.checked=this._field&&this._field.isRequired()||this._mandatoryConfigurator.isCustomized();this._mandatoryConfigurator.setSwitchCheckBox(t);this._mandatoryConfigurator.setLabel(t.nextSibling);this._mandatoryConfigurator.setEnabled(t.checked);this._mandatoryConfigurator.adjust()}else{t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_REQUIRED_FIELD")});t.checked=this._field&&this._field.isRequired()}}}return t}},{key:"getIsTimeEnabledCheckBox",value:function e(){var t=null;if(this._typeId==="datetime"||this._typeId==="multidatetime"){t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_ENABLE_TIME")});t.checked=this._field&&this._field.isTimeEnabled()}return t}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityEditorFieldConfigurator);var Je=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"createFieldConfigurator",value:function e(t,i){if(!d.Type.isPlainObject(t)){throw"GridFieldConfigurationManager: The 'params' argument must be object."}return this.getSimpleFieldConfigurator(t,i)}},{key:"getSimpleFieldConfigurator",value:function e(t,i){var n="";var r=BX.prop.get(t,"field",null);if(r){n=r.getType();r.setVisible(false);if(!BX.prop.get(r.getSchemeElement().getData(),"isProductProperty",false)){return this._fieldConfigurator=BX.UI.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null})}}else{n=BX.prop.get(t,"typeId",BX.UI.EntityUserFieldType.string)}this._fieldConfigurator=Ze.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null});return this._fieldConfigurator}},{key:"isSelectionEnabled",value:function e(){return false}},{key:"isCreationEnabled",value:function e(){return false}},{key:"hasExternalForm",value:function e(t){return true}},{key:"getCreationPageUrl",value:function e(t){var i=this.getTypeInfos().filter((function(e){return e.name===t}));if(i.length>0){return this.creationPageUrl.replace("#PROPERTY_TYPE#",t)}}},{key:"openCreationPageUrl",value:function e(t){this.openCreationPageSlider(this.getCreationPageUrl(t))}},{key:"openCreationPageSlider",value:function e(t){if(d.Type.isStringFilled(t)){BX.SidePanel.Instance.open(t,{width:550,allowChangeHistory:false,cacheable:false})}}},{key:"setCreationPageUrl",value:function e(t){return this.creationPageUrl=t}},{key:"getTypeInfos",value:function e(){return[{name:"list",title:BX.message("CATALOG_ENTITY_CARD_LIST_TITLE"),legend:BX.message("CATALOG_ENTITY_CARD_LIST_LEGEND")},{name:"directory",title:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_TITLE"),legend:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_LEGEND")}]}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityConfigurationManager);function $e(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function et(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?$e(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):$e(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var tt=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.id=d.Type.isStringFilled(t)?t:d.Text.getRandom();this.settings=d.Type.isObjectLike(i)?i:{};this.container=this.settings.container;if(!this.container){throw"Error: Could not find container."}this.serviceUrl=this.settings.serviceUrl||"";if(!d.Type.isStringFilled(this.serviceUrl)){throw"Error. Could not find service url."}this.tabId=this.settings.tabId||"";if(!d.Type.isStringFilled(this.tabId)){throw"Error: Could not find tab id."}this.params=d.Type.isObjectLike(this.settings.componentData)?this.settings.componentData:{};this.isRequestRunning=false;this.loaded=false}babelHelpers.createClass(e,[{key:"isLoaded",value:function e(){return this.loaded}},{key:"load",value:function e(){if(!this.isLoaded()){this.startRequest(et(et({},this.params),{TABID:this.tabId}))}}},{key:"startRequest",value:function e(t){if(this.isRequestRunning){return false}this.isRequestRunning=true;BX.ajax({url:this.serviceUrl,method:"POST",dataType:"html",data:{LOADERID:this.id,PARAMS:t},onsuccess:this.onRequestSuccess.bind(this),onfailure:this.onRequestFailure.bind(this)});return true}},{key:"onRequestSuccess",value:function e(t){this.isRequestRunning=false;this.container.innerHTML=t;this.loaded=true}},{key:"onRequestFailure",value:function e(){this.isRequestRunning=false;this.loaded=true}}]);return e}();function it(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function nt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?it(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):it(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var rt=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.id=d.Type.isStringFilled(t)?t:d.Text.getRandom();this.settings=d.Type.isObjectLike(i)?i:{};this.data=d.Type.isObjectLike(this.settings.data)?this.settings.data:{};this.manager=i.manager||null;this.container=this.settings.container;this.menuContainer=this.settings.menuContainer;this.active=d.Type.isBoolean(this.data.active)?this.data.active:false;this.enabled=d.Type.isBoolean(this.data.enabled)?this.data.enabled:true;d.Event.bind(this.menuContainer.querySelector("a.catalog-entity-section-tab-link"),"click",this.onMenuClick.bind(this));this.loader=null;if(d.Type.isObjectLike(this.data.loader)){this.loader=new tt(this.id,nt(nt({},this.data.loader),{tabId:this.id,container:this.container}))}}babelHelpers.createClass(e,[{key:"isEnabled",value:function e(){return this.enabled}},{key:"isActive",value:function e(){return this.active}},{key:"setActive",value:function e(t){t=!!t;if(this.isActive()===t){return}this.active=t;if(this.isActive()){this.showTab()}else{this.hideTab()}}},{key:"showTab",value:function e(){var t=this;d.Dom.addClass(this.container,"catalog-entity-section-tab-content-show");d.Dom.removeClass(this.container,"catalog-entity-section-tab-content-hide");d.Dom.addClass(this.menuContainer,"catalog-entity-section-tab-current");this.container.style.display="";this.container.style.position="absolute";this.container.style.top=0;this.container.style.left=0;this.container.style.width="100%";new BX.easing({duration:350,start:{opacity:0,translateX:100},finish:{opacity:100,translateX:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function e(i){t.container.style.opacity=i.opacity/100;t.container.style.transform="translateX("+i.translateX+"%)"},complete:function e(){d.Dom.removeClass(t.container,"catalog-entity-section-tab-content-show");t.container.style.cssText="";d.Event.EventEmitter.emit(window,"onEntityDetailsTabShow",[t])}}).animate()}},{key:"hideTab",value:function e(){var t=this;d.Dom.addClass(this.container,"catalog-entity-section-tab-content-hide");d.Dom.removeClass(this.container,"catalog-entity-section-tab-content-show");d.Dom.removeClass(this.menuContainer,"catalog-entity-section-tab-current");new BX.easing({duration:350,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function e(i){t.container.style.opacity=i.opacity/100},complete:function e(){t.container.style.display="none";t.container.style.transform="translateX(100%)";t.container.style.opacity=0}}).animate()}},{key:"onMenuClick",value:function e(t){if(this.isEnabled()){if(this.loader&&!this.loader.isLoaded()){this.loader.load()}this.manager.selectItem(this)}t.preventDefault()}}]);return e}();var at=function(){function e(t,i){var n=this;babelHelpers.classCallCheck(this,e);this.id=d.Type.isStringFilled(t)?t:d.Text.getRandom();this.settings=d.Type.isObjectLike(i)?i:{};this.container=this.settings.container;this.menuContainer=this.settings.menuContainer;this.items=[];if(d.Type.isArray(this.settings.data)){this.settings.data.forEach((function(e){n.items.push(new rt(e.id,{manager:n,data:e,container:n.container.querySelector('[data-tab-id="'+e.id+'"]'),menuContainer:n.menuContainer.querySelector('[data-tab-id="'+e.id+'"]')}))}))}u.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onOpenTab",(function(e){var t=e.data.tabId;var i=n.findItemById(t);if(i){n.selectItem(i)}}))}babelHelpers.createClass(e,[{key:"findItemById",value:function e(t){return this.items.find((function(e){return e.id===t}))||null}},{key:"selectItem",value:function e(t){u.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onSelectItem",{tabId:t.id});this.items.forEach((function(e){return e.setActive(e===t)}))}}]);return e}();var st;var ot=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);this.id=d.Type.isStringFilled(t)?t:d.Text.getRandom();this.entityId=d.Text.toInteger(i.entityId)||0;this.settings=i;this.container=document.getElementById(i.containerId);this.initializeTabManager();this.checkFadeOverlay()}babelHelpers.createClass(e,[{key:"initializeTabManager",value:function e(){return new at(this.id,{container:document.getElementById(this.settings.tabContainerId),menuContainer:document.getElementById(this.settings.tabMenuContainerId),data:this.settings.tabs||[]})}},{key:"checkFadeOverlay",value:function e(){if(this.entityId<=0){this.overlay=d.Tag.render(st||(st=babelHelpers.taggedTemplateLiteral(['<div class="catalog-entity-overlay"></div>'])));d.Dom.append(this.overlay,this.container);if(window===window.top){this.overlay.style.position="absolute";this.overlay.style.top=this.overlay.style.left=this.overlay.style.right="-15px"}}}}]);return e}();var lt,dt,ut,ct,ht,pt,gt;function ft(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,n)}return i}function bt(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?ft(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):ft(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}var mt=function(e){babelHelpers.inherits(t,e);function t(e){var i;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,n));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"stackWithOffset",null);i.cardSettings=n.cardSettings||[];i.hiddenFields=n.hiddenFields||[];i.feedbackUrl=n.feedbackUrl||"";i.variationGridId=n.variationGridId;i.productStoreGridId=n.productStoreGridId||null;i.settingsButtonId=n.settingsButtonId;i.createDocumentButtonId=n.createDocumentButtonId;i.createDocumentButtonMenuPopupItems=n.createDocumentButtonMenuPopupItems;i.componentName=n.componentName||null;i.componentSignedParams=n.componentSignedParams||null;i.variationGridComponentName=(n.variationGridComponentName||"BX.Catalog.VariationGrid")+".Instance";i.isSimpleProduct=n.isSimpleProduct||false;i.isWithOrdersMode=n.isWithOrdersMode||false;i.isInventoryManagementUsed=n.isInventoryManagementUsed||false;i.registerFieldsFactory();i.registerControllersFactory();i.registerEvents();i.bindCardSettingsButton();i.bindCreateDocumentButtonMenu();u.EventEmitter.subscribe("SidePanel.Slider:onMessage",i.onSliderMessage.bind(babelHelpers.assertThisInitialized(i)));u.EventEmitter.subscribe("BX.UI.EntityEditorSection:onLayout",i.onSectionLayout.bind(babelHelpers.assertThisInitialized(i)));u.EventEmitter.subscribe("Grid::updated",i.onGridUpdatedHandler.bind(babelHelpers.assertThisInitialized(i)));return i}babelHelpers.createClass(t,[{key:"getEntityType",value:function e(){return"Entity"}},{key:"getCardSetting",value:function e(t){return this.cardSettings.filter((function(e){return e.id===t}))[0]}},{key:"isCardSettingEnabled",value:function e(t){var i=this.getCardSetting(t);return i&&i.checked}},{key:"bindCardSettingsButton",value:function e(){var t=this.getSettingsButton();if(t){d.Event.bind(t.getContainer(),"click",this.showCardSettingsPopup.bind(this))}}},{key:"getSettingsButton",value:function e(){return BX.UI.ButtonManager.getByUniqid(this.settingsButtonId)}},{key:"registerFieldsFactory",value:function e(){return new K}},{key:"onGridUpdatedHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];if(r&&r.getId()===this.getVariationGridId()){this.updateSettingsCheckboxState()}}},{key:"onSectionLayout",value:function e(){}},{key:"getProductStoreGridId",value:function e(){return this.productStoreGridId}},{key:"getProductStoreGridComponent",value:function e(){return d.Reflection.getClass("BX.Catalog.ProductStoreGridManager.Instance")}},{key:"reloadProductStoreGrid",value:function e(){var t=this.getProductStoreGridComponent();if(t){if(this.getProductStoreGridId()&&this.getProductStoreGridId()===t.getGridId()){t.reloadGrid()}}}},{key:"getVariationGridComponent",value:function e(){return d.Reflection.getClass(this.variationGridComponentName)}},{key:"reloadVariationGrid",value:function e(){var t=this.getVariationGridComponent();if(t){t.reloadGrid()}}},{key:"getVariationGridId",value:function e(){return this.variationGridId}},{key:"getVariationGrid",value:function e(){if(!d.Reflection.getClass("BX.Main.gridManager.getInstanceById")){return null}return BX.Main.gridManager.getInstanceById(this.getVariationGridId())}},{key:"registerControllersFactory",value:function e(){return new De}},{key:"registerEvents",value:function e(){u.EventEmitter.subscribe("BX.UI.EntityConfigurationManager:onInitialize",this.onConfigurationManagerInit.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditor:onCancel",this.removeFileHiddenInputs.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditor:onInit",this.onEditorInitHandler.bind(this));u.EventEmitter.subscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorAjaxSubmit.bind(this));u.EventEmitter.subscribe("onEntityCreate",this.onEntityCreateHandler.bind(this));u.EventEmitter.subscribe("onEntityUpdate",this.onEntityUpdateHandler.bind(this));u.EventEmitter.subscribe("onAttachFiles",this.onAttachFilesHandler.bind(this));u.EventEmitter.subscribe("BX.Main.Popup:onClose",this.onFileEditorCloseHandler.bind(this));u.EventEmitter.subscribe("onAfterVariationGridSave",this.onAfterVariationGridSave.bind(this))}},{key:"onAfterVariationGridSave",value:function e(t){var i=t.getData();if(i.gridId===this.getVariationGridId()){this.reloadProductStoreGrid()}}},{key:"onAttachFilesHandler",value:function e(t){var i=this.getEditorInstance();if(!i){return}var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,3),a=r[2];if(a&&d.Type.isDomNode(a.fileInput)){var s=a.fileInput.closest("[data-cid]");if(d.Type.isDomNode(s)){var o=s.getAttribute("data-cid");var l=i.getControlByIdRecursive(o);if(l){l.markAsChanged()}}}}},{key:"onFileEditorCloseHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];if(r&&r.getId()==="popupFM"&&r.onApplyFlag){this.showNotification(d.Loc.getMessage("CATALOG_ENTITY_CARD_FILE_CLOSE_NOTIFICATION_2"),{id:"fileCloseNotification",blinkOnUpdate:false,autoHideDelay:5e3})}}},{key:"onEditorInitHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[0],a=n[1];if(r&&!a.entityId){var s=r.getControlByIdRecursive("NAME");if(s){requestAnimationFrame((function(){s.focus()}))}}}},{key:"getEditorInstance",value:function e(){if(d.Reflection.getClass("BX.UI.EntityEditor")){return BX.UI.EntityEditor.getDefault()}return null}},{key:"onEditorAjaxSubmit",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[0],a=n[1];var s=r["NAME-CODE"].NAME||"";this.changePageTitle(s);if(a.data){if(d.Type.isBoolean(a.data.IS_SIMPLE_PRODUCT)){this.isSimpleProduct=a.data.IS_SIMPLE_PRODUCT}}if(a.status==="success"){this.removeFileHiddenInputs()}}},{key:"onEntityCreateHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];this.postSliderMessage("onCreate",r)}},{key:"onEntityUpdateHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];this.postSliderMessage("onUpdate",r)}},{key:"postSliderMessage",value:function e(t,i){BX.SidePanel.Instance.postMessage(window,"Catalog.".concat(this.getEntityType(),"Card::").concat(t),i)}},{key:"changePageTitle",value:function e(t){var i=document.getElementById("pagetitle");if(d.Type.isDomNode(i)){i.innerText=t}document.title=t;if(BX.getClass("BX.SidePanel.Instance.updateBrowserTitle")){BX.SidePanel.Instance.updateBrowserTitle()}}},{key:"removeFileHiddenInputs",value:function e(){document.querySelectorAll('form>input[type="hidden"]').forEach((function(e){var t=e.getAttribute("name");var i=document.querySelector('form>input[name="'.concat(t,'_del"]'));if(i){d.Dom.remove(e);d.Dom.remove(i)}}))}},{key:"onConfigurationManagerInit",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];if(!r.type||r.type==="editor"){r.configurationFieldManager=this.initializeIblockFieldConfigurationManager(r)}if(r.id==="variation_grid"){r.configurationFieldManager=this.initializeVariationPropertyConfigurationManager(r)}if(r.id==="service_grid"){r.configurationFieldManager=this.initializeServicePropertyConfigurationManager(r)}}},{key:"initializeIblockFieldConfigurationManager",value:function e(t){var i=Ve.create(this.id,t);i.setCreationPageUrl(this.settings.creationPropertyUrl);return i}},{key:"initializeVariationPropertyConfigurationManager",value:function e(t){var i=Je.create(this.id,t);i.setCreationPageUrl(this.settings.creationVariationPropertyUrl);return i}},{key:"initializeServicePropertyConfigurationManager",value:function e(t){return Je.create(this.id,t)}},{key:"showNotification",value:function e(t,i){i=i||{};if(BX.GetWindowScrollPos().scrollTop<=10){i.stack=this.getStackWithOffset()}BX.UI.Notification.Center.notify(bt({content:t,position:"top-right",width:"auto",autoHideDelay:3e3},i))}},{key:"getStackWithOffset",value:function e(){if(this.stackWithOffset===null){this.stackWithOffset=new BX.UI.Notification.Stack(BX.mergeEx({},BX.UI.Notification.Center.getStackDefaults(),{id:"top-right-with-offset",position:"top-right-with-offset",offsetY:74}))}return this.stackWithOffset}},{key:"openFeedbackPanel",value:function e(){t.openFeedbackPanelStatic()}},{key:"bindCreateDocumentButtonMenu",value:function e(){var t=this.getCreateDocumentButtonMenu();if(t){d.Event.bind(t.getContainer(),"click",this.showCreateDocumentPopup.bind(this))}}},{key:"getCreateDocumentButtonMenu",value:function e(){var t=BX.UI.ButtonManager.getByUniqid(this.createDocumentButtonId);if(t){return BX.UI.ButtonManager.getByUniqid(this.createDocumentButtonId).getMenuButton()}return null}},{key:"getCreateDocumentPopup",value:function e(){if(!this.createDocumentPopup){this.createDocumentPopup=new l.Popup(this.id+"-create-document",this.getCreateDocumentButtonMenu().getContainer(),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:this.getCreateDocumentMenuContent()})}return this.createDocumentPopup}},{key:"showCreateDocumentPopup",value:function e(){this.getCreateDocumentPopup().show()}},{key:"getCreateDocumentMenuContent",value:function e(){var t=d.Tag.render(lt||(lt=babelHelpers.taggedTemplateLiteral(['<div class="menu-popup"></div>'])));var i=d.Tag.render(dt||(dt=babelHelpers.taggedTemplateLiteral(['<div class="menu-popup-items"></div>'])));t.appendChild(i);this.createDocumentButtonMenuPopupItems.forEach((function(e){i.appendChild(d.Tag.render(ut||(ut=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a class="menu-popup-item menu-popup-item-no-icon" href="','">\n\t\t\t\t\t<span class="menu-popup-item-text">',"</span>\n\t\t\t\t</a>\n\t\t\t"])),e.link,e.text))}));return t}},{key:"getCardSettingsPopup",value:function e(){if(!this.settingsPopup){this.settingsPopup=new l.Popup(this.id,this.getSettingsButton().getContainer(),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:this.prepareCardSettingsContent()})}return this.settingsPopup}},{key:"showCardSettingsPopup",value:function e(){this.getCardSettingsPopup().show()}},{key:"prepareCardSettingsContent",value:function e(){var t=this;var i=d.Tag.render(ct||(ct=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-entity-editor-popup-create-field-list'></div>\n\t\t"])));this.cardSettings.map((function(e){i.append(t.getSettingItem(e))}));return i}},{key:"getSettingItem",value:function e(t){var i=this;var n="";if(!t.disabledCheckbox){var r;n=d.Tag.render(ht||(ht=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="checkbox">\n\t\t\t'])));n.checked=t.checked;n.disabled=(r=t.disabled)!==null&&r!==void 0?r:false;n.dataset.settingId=t.id}var a=d.Type.isStringFilled(t.hint)?d.Tag.render(pt||(pt=babelHelpers.taggedTemplateLiteral(['<span class="catalog-entity-setting-hint" data-hint="','"></span>'])),t.hint):"";var s=d.Tag.render(gt||(gt=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<label class="ui-ctl-block ui-entity-editor-popup-create-field-item ui-ctl-w100">\n\t\t\t\t\t<div class="ui-ctl-w10" style="text-align: center">','</div>\n\t\t\t\t\t<div class="ui-ctl-w75">\n\t\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-title ','">',"",'</span>\n\t\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-desc">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t</label>\n\t\t\t"])),n,t.disabled?"catalog-entity-disabled-setting":"",t.title,a,t.desc);BX.UI.Hint.init(s);if(t.id==="SLIDER"){d.Event.bind(s,"change",(function(e){(new c.Slider).open(t.url,{}).then((function(){i.reloadGrid();i.getCardSettingsPopup().close()}))}))}else if(t.id==="SEO"){d.Event.bind(s,"click",(function(e){BX.SidePanel.Instance.open(t.url,{cacheable:false,allowChangeHistory:false,data:{ELEMENT_ID:i.entityId},width:1e3})}))}else{d.Event.bind(s,"change",this.setProductCardSetting.bind(this))}return s}},{key:"setProductCardSetting",value:function e(t){var i=this.getCardSetting(t.target.dataset.settingId);if(!i){return}var n=t.target.checked;if(i.action==="grid"){this.requestGridSettings(i,n)}else{this.requestCardSettings(i,n)}}},{key:"onSliderMessage",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];if(r.getEventId()==="Catalog.VariationCard::onCreate"||r.getEventId()==="Catalog.VariationCard::onUpdate"){this.reloadVariationGrid()}}},{key:"reloadGrid",value:function e(){document.location.reload()}},{key:"requestGridSettings",value:function e(t,i){var n=this;if(!this.getVariationGrid());var r=[];var a=this.getVariationGrid().getRows().getHeadFirstChild().getCells();Array.from(a).forEach((function(e){if("name"in e.dataset){r.push(e.dataset.name)}}));BX.ajax.runComponentAction(this.componentName,"setGridSetting",{mode:"class",data:{signedParameters:this.componentSignedParams,settingId:t.id,selected:i,currentHeaders:r}}).then((function(){var e=null;t.checked=i;n.reloadVariationGrid();n.postSliderMessage("onUpdate",{});n.getCardSettingsPopup().close();if(t.id==="WAREHOUSE"){n.reloadGrid();e=i?d.Loc.getMessage("CATALOG_ENTITY_CARD_WAREHOUSE_ENABLED"):d.Loc.getMessage("CATALOG_ENTITY_CARD_WAREHOUSE_DISABLED")}else{e=i?d.Loc.getMessage("CATALOG_ENTITY_CARD_SETTING_ENABLED"):d.Loc.getMessage("CATALOG_ENTITY_CARD_SETTING_DISABLED");e=e.replace("#NAME#",t.title)}n.showNotification(e,{category:"popup-settings"})}))}},{key:"requestCardSettings",value:function e(t,i){var n=this;BX.ajax.runComponentAction(this.componentName,"setCardSetting",{mode:"class",data:{signedParameters:this.componentSignedParams,settingId:t.id,selected:i}}).then((function(){t.checked=i;if(t.id==="CATALOG_PARAMETERS"){var e=n.getEditorInstance().getControlByIdRecursive("catalog_parameters");if(e){e.refreshLayout()}}n.getCardSettingsPopup().close();var r=i?d.Loc.getMessage("CATALOG_ENTITY_CARD_SETTING_ENABLED"):d.Loc.getMessage("CATALOG_ENTITY_CARD_SETTING_DISABLED");n.showNotification(r.replace("#NAME#",t.title),{category:"popup-settings"})}))}},{key:"updateSettingsCheckboxState",value:function e(){var t=this;var i=this.getCardSettingsPopup().getContentContainer();this.cardSettings.filter((function(e){var t;return e.action==="grid"&&d.Type.isArray((t=e.columns)===null||t===void 0?void 0:t.ITEMS)})).forEach((function(e){var n=true;e.columns.ITEMS.forEach((function(e){if(!t.getVariationGrid().getColumnHeaderCellByName(e)){n=false}}));var r=i.querySelector('input[data-setting-id="'+e.id+'"]');if(d.Type.isDomNode(r)){r.checked=n}}))}}],[{key:"openFeedbackPanelStatic",value:function e(){BX.UI.Feedback.Form.open({id:"catalog-product-card-feedback",forms:[{id:269,lang:"ru",sec:"mqerov",zones:["ru","by","kz"]},{id:347,lang:"en",sec:"lxfji8",zones:["en"]},{id:349,lang:"es",sec:"gdf9i1",zones:["es"]},{id:355,lang:"de",sec:"x8k56n",zones:["de"]},{id:357,lang:"ua",sec:"2z19xl",zones:["ua"]},{id:353,lang:"com.br",sec:"5cleqn",zones:["com.br"]}]})}}]);return t}(ot);e.EntityCard=mt;e.BaseCard=ot})(this.BX.Catalog.EntityCard=this.BX.Catalog.EntityCard||{},BX,BX,BX,BX,BX,BX,BX,BX.Main,BX,BX.Event,BX.Catalog.StoreUse);
//# sourceMappingURL=entity-card.bundle.map.js