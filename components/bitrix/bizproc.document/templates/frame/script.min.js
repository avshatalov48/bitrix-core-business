(function(){"use strict";BX.namespace("BX.Bizproc.DocumentComponent");var t=function(t,e){this.node=t;this.config=e};t.prototype={getNodes:function(t,e){var o=e||this.node;return o.querySelectorAll('[data-role="'+t+'"]')},getNode:function(t,e){return this.getNodes(t,e)[0]},createNodeFromTemplate:function(t){var e=this.getNode("templates");var o=e.querySelector('[data-template="'+t+'"]');if(o){var i=BX.clone(o);i.removeAttribute("data-template");return i}throw"Template not found"},init:function(){this.initEventsApplyButton();this.initStartButton();this.initCompletedListButton()},renderWorkflows:function(t){var e=this.getNode("workflows-list");BX.cleanNode(e);var o=false;for(var i=0;i<t.length;++i){e.appendChild(this.renderWorkflow(t[i]));if(!o&&t[i]["EVENTS"]&&t[i]["EVENTS"].length>0){o=true}}var n=this.getNode("events-apply-container");BX[o?"show":"hide"](n);var r=this.getNode("workflows-list-empty");BX[t.length<1?"show":"hide"](r)},renderCompletedWorkflows:function(t){var e=this.getNode("workflows-list-completed");for(var o=0;o<t.length;++o){e.appendChild(this.renderWorkflow(t[o]))}},prependCompletedWorkflows:function(t){var e=this.getNode("workflows-list-completed");t.forEach((function(t){BX.prepend(this.renderWorkflow(t),e)}),this)},renderWorkflow:function(t){var e,o=this.createNodeFromTemplate("workflow");o.setAttribute("data-workflow-id",t["ID"]);if(!t["WORKFLOW_STATUS"]){BX.addClass(o,o.getAttribute("data-class-finished"))}if(!t["WORKFLOW_STATUS"]||!this.config.canTerminate){var i=this.getNode("terminate-container",o);BX.remove(i)}if(!this.config.canKill||t["WORKFLOW_STATUS"]){var n=this.getNode("kill-container",o);BX.remove(n)}if(t["TASKS"]&&t["TASKS"].length>0){BX.addClass(o,o.getAttribute("data-class-tasks"));var r=this.getNode("tasks-container",o);for(e=0;e<t["TASKS"].length;++e){var s=t["TASKS"][e],l=BX.create("a",{props:{href:"#"},text:BX.util.htmlspecialcharsback(s["NAME"])});BX.bind(l,"click",this.onTaskLinkClick.bind(this,s));r.appendChild(BX.create("li",{children:[l]}))}}else{BX.remove(this.getNode("tasks-row",o))}if(t["EVENTS"]&&t["EVENTS"].length>0){var a=this.getNode("events-select",o);a.setAttribute("workflow-id",t["ID"]);for(e=0;e<t["EVENTS"].length;++e){a.appendChild(BX.create("option",{props:{value:t["EVENTS"][e]["NAME"]},text:t["EVENTS"][e]["TITLE"]}))}}else{BX.remove(this.getNode("events-row",o))}var d=this.getNode("workflow-name",o);d.textContent=t["TEMPLATE_NAME"];var f=this.getNode("workflow-modified",o);f.textContent=t["STATE_MODIFIED_FORMATTED"];var c=this.getNode("workflow-state",o);c.textContent=t["STATE_TITLE"]?t["STATE_TITLE"]:t["STATE_NAME"];this.initWorkflowNode(o);return o},initEventsApplyButton:function(){var t=this.getNode("events-apply-button");BX.bind(t,"click",this.onApplyEventsClick.bind(this))},initStartButton(){const t=this.getNode("start-button");if(t){BX.Event.bind(t,"click",this.onStartClick.bind(this))}},onAfterStartWorkflow(t){this.reloadWorkflows();if(!t||!BX.Type.isFunction(t.getData)||!BX.Type.isStringFilled(t.getData.workflowId)){return}this.callAction("get_completed_workflow",{offset:0,workflowId:t.getData().workflowId},(t=>{if(t.workflow){this.prependCompletedWorkflows([t.workflow])}}))},initCompletedListButton:function(){var t=this.getNode("btn-load-completed");if(t){BX.bind(t,"click",this.onLoadCompletedClick.bind(this,t))}},initWorkflowNode:function(t){var e=t.getAttribute("data-workflow-id");var o=this.getNode("kill",t);if(o){BX.bind(o,"click",this.onKillWorkflowClick.bind(this,e,t))}var i=this.getNode("terminate",t);if(i){BX.bind(i,"click",this.onTerminateWorkflowClick.bind(this,e,t))}var n=this.getNode("log",t);if(n){BX.bind(n,"click",this.onLogClick.bind(this,e))}},onKillWorkflowClick:function(t,e,o){o.preventDefault();var i=this;this.callAction("kill_workflow",{workflow_id:t},(function(t){BX.remove(e);if(t.workflows){i.renderWorkflows(t.workflows)}}))},onTerminateWorkflowClick:function(t,e,o){o.preventDefault();var i=this;this.callAction("terminate_workflow",{workflow_id:t},(function(t){if(t.workflows){i.renderWorkflows(t.workflows)}if(t.completedWorkflows){i.prependCompletedWorkflows(t.completedWorkflows)}}))},onApplyEventsClick:function(t){var e=this.getNode("form");var o=this.getNodes("events-select",e);var i=false,n={};for(var r=0;r<o.length;++r){var s=o[r].value;if(s!==""){n[o[r].getAttribute("workflow-id")]=s;i=true}}if(i){var l=this;this.callAction("send_events",{events:n},(function(t){if(t.workflows){l.renderWorkflows(t.workflows)}if(t.completedWorkflows){l.prependCompletedWorkflows(t.completedWorkflows)}}))}},onStartClick(){BX.Bizproc.Workflow.Starter.showTemplates({signedDocumentType:this.config.signedDocumentType,signedDocumentId:this.config.signedDocumentId},{callback:this.onAfterStartWorkflow.bind(this)})},onLoadCompletedClick:function(t,e){var o=this.getNode("workflows-list-completed");var i=o.children.length;this.callAction("get_completed_workflows",{offset:i},function(e){if(e.workflows&&e.workflows.length){t.textContent=t.getAttribute("data-label-more");this.renderCompletedWorkflows(e.workflows)}else{BX.UI.Dialogs.MessageBox.alert(BX.message("IBEL_BIZPROC_COMPLETED_WORKFLOWS_EMPTY"))}}.bind(this))},onTaskLinkClick:function(t,e){e.preventDefault();if(BX.Bizproc&&BX.Bizproc.showTaskPopup){BX.Bizproc.showTaskPopup(t["ID"],this.reloadWorkflows.bind(this))}},onLogClick:function(t,e){e.preventDefault();if(top.BX.Bitrix24&&top.BX.Bitrix24.Slider){top.BX.Bitrix24.Slider.open("/bitrix/components/bitrix/bizproc.log/slider.php?site_id="+BX.message("SITE_ID")+"&WORKFLOW_ID="+t)}else if(BX.Bizproc&&BX.Bizproc.showWorkflowLogPopup){BX.Bizproc.showWorkflowLogPopup(t,{title:BX.message("IBEL_BIZPROC_LOG_TITLE")})}},reloadWorkflows:function(){var t=this;this.callAction("get_workflows",{},(function(e){if(e.workflows){t.renderWorkflows(e.workflows)}}))},callAction:function(t,e,o){this.showWait();e["sessid"]=BX.bitrix_sessid();e["site"]=BX.message("SITE_ID");e["ajax_action"]=t;e["module_id"]=this.config.moduleId;e["entity"]=this.config.entity;e["document_type"]=this.config.documentType;e["document_id"]=this.config.documentId;var i=this;BX.ajax({method:"POST",dataType:"json",url:this.config.serviceUrl,data:e,onsuccess:function(t){if(t.success){o(t.data,t)}else{BX.UI.Dialogs.MessageBox.alert(t.errors.join("\n"))}i.hideWait()},onfailure:function(){i.hideWait()}})},showWait:function(){BX.addClass(this.node,"bizproc-document-wait")},hideWait:function(){BX.removeClass(this.node,"bizproc-document-wait")}};BX.Bizproc.DocumentComponent=t})();
//# sourceMappingURL=script.map.js