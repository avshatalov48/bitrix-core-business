{"version":3,"file":"core.bundle.js","sources":["../src/core.js"],"sourcesContent":["import { Extension, Loc } from 'main.core';\nimport { BitrixVue } from 'ui.vue3';\nimport { Builder, Store } from 'ui.vue3.vuex';\n\nimport 'pull.client';\nimport 'rest.client';\n\nimport 'im.v2.application.launch';\n\nimport {\n\tApplicationModel,\n\tMessagesModel,\n\tChatsModel,\n\tUsersModel,\n\tFilesModel,\n\tRecentModel,\n\tNotificationsModel,\n\tSidebarModel,\n\tMarketModel,\n\tCountersModel,\n} from 'im.v2.model';\nimport {\n\tBasePullHandler,\n\tRecentPullHandler,\n\tNotificationPullHandler,\n\tNotifierPullHandler,\n\tLinesPullHandler,\n\tOnlinePullHandler,\n} from 'im.v2.provider.pull';\nimport { Logger } from 'im.v2.lib.logger';\n\nimport type { RestClient } from 'rest.client';\n\nclass CoreApplication\n{\n\thost: string;\n\tuserId: number;\n\tsiteId: string;\n\tsiteDir: string;\n\tlanguageId: string;\n\tapplicationData: {[key]: any} = {};\n\n\t/* region 01. Initialize and store data */\n\tconstructor()\n\t{\n\t\tthis.inited = false;\n\t\tthis.initPromise = new Promise((resolve) => {\n\t\t\tthis.initPromiseResolver = resolve;\n\t\t});\n\n\t\tthis.offline = false;\n\n\t\tthis.vuexAdditionalModel = [];\n\n\t\tthis.store = null;\n\t\tthis.storeBuilder = null;\n\n\t\tthis.prepareVariables();\n\t\tthis.initRestClient();\n\t}\n\n\tstart()\n\t{\n\t\tthis.initStorage()\n\t\t\t.then(() => this.initPull())\n\t\t\t.then(() => this.initComplete())\n\t\t\t.catch((error) => {\n\t\t\t\tLogger.error('Core: error starting core application', error);\n\t\t\t})\n\t\t;\n\t}\n\n\tprepareVariables()\n\t{\n\t\tthis.localize = BX ? { ...BX.message } : {};\n\n\t\tthis.host = location.origin;\n\t\tthis.userId = Number.parseInt(Loc.getMessage('USER_ID'), 10) ?? 0;\n\t\tthis.siteId = Loc.getMessage('SITE_ID') ?? 's1';\n\t\tthis.siteDir = Loc.getMessage('SITE_DIR') ?? 's1';\n\t\tthis.languageId = Loc.getMessage('LANGUAGE_ID') ?? 'en';\n\t}\n\n\tinitRestClient()\n\t{\n\t\tthis.restInstance = BX.RestClient;\n\t\tthis.restClient = BX.rest;\n\t}\n\n\tinitStorage(): Promise\n\t{\n\t\tconst builder = Builder.init()\n\t\t\t.addModel(ApplicationModel.create())\n\t\t\t.addModel(MessagesModel.create())\n\t\t\t.addModel(ChatsModel.create())\n\t\t\t.addModel(FilesModel.create())\n\t\t\t.addModel(UsersModel.create())\n\t\t\t.addModel(RecentModel.create())\n\t\t\t.addModel(CountersModel.create())\n\t\t\t.addModel(NotificationsModel.create())\n\t\t\t.addModel(SidebarModel.create())\n\t\t\t.addModel(MarketModel.create())\n\t\t;\n\n\t\treturn builder.build().then((result) => {\n\t\t\tthis.store = result.store;\n\t\t\tthis.storeBuilder = result.builder;\n\n\t\t\treturn true;\n\t\t});\n\t}\n\n\tinitPull(): Promise\n\t{\n\t\tthis.pullInstance = BX.PullClient;\n\t\tthis.pullClient = BX.PULL;\n\t\tif (!this.pullClient)\n\t\t{\n\t\t\treturn Promise.reject(new Error('Core: error setting pull client'));\n\t\t}\n\n\t\tthis.pullClient.subscribe(new BasePullHandler());\n\t\tthis.pullClient.subscribe(new RecentPullHandler());\n\t\tthis.pullClient.subscribe(new NotificationPullHandler());\n\t\tthis.pullClient.subscribe(new NotifierPullHandler());\n\t\tthis.pullClient.subscribe(new LinesPullHandler());\n\t\tthis.pullClient.subscribe(new OnlinePullHandler());\n\n\t\tthis.pullClient.subscribe({\n\t\t\ttype: this.pullInstance.SubscriptionType.Status,\n\t\t\tcallback: this.onPullStatusChange.bind(this),\n\t\t});\n\n\t\treturn Promise.resolve();\n\t}\n\n\tinitComplete()\n\t{\n\t\tthis.inited = true;\n\t\tthis.initPromiseResolver(this);\n\t}\n\t/* endregion 01. Initialize and store data */\n\n\t/* region 02. Push & Pull */\n\tonPullStatusChange(data)\n\t{\n\t\tif (data.status === this.pullInstance.PullStatus.Online)\n\t\t{\n\t\t\tthis.offline = false;\n\t\t}\n\t\telse if (data.status === this.pullInstance.PullStatus.Offline)\n\t\t{\n\t\t\tthis.offline = true;\n\t\t}\n\t}\n\t/* endregion 02. Push & Pull */\n\n\t/* region 04. Template engine */\n\tcreateVue(application, config = {}): Promise\n\t{\n\t\tconst initConfig = {};\n\n\t\tif (config.el)\n\t\t{\n\t\t\tinitConfig.el = config.el;\n\t\t}\n\n\t\tif (config.template)\n\t\t{\n\t\t\tinitConfig.template = config.template;\n\t\t}\n\n\t\tif (config.name)\n\t\t{\n\t\t\tinitConfig.name = config.name;\n\t\t}\n\n\t\tif (config.components)\n\t\t{\n\t\t\tinitConfig.components = config.components;\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tinitConfig.created = function() {\n\t\t\t\tresolve(this);\n\t\t\t};\n\t\t\tconst bitrixVue = BitrixVue.createApp(initConfig);\n\t\t\tbitrixVue.config.errorHandler = function(err, vm, info) {\n\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\tconsole.error(err, info);\n\t\t\t};\n\n\t\t\tbitrixVue.config.warnHandler = function(warn, vm, trace) {\n\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\tconsole.warn(warn, trace);\n\t\t\t};\n\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\tapplication.bitrixVue = bitrixVue;\n\t\t\tbitrixVue.use(this.store).mount(initConfig.el);\n\t\t});\n\t}\n\t/* endregion 04. Template engine */\n\n\t/* region 05. Core methods */\n\tgetHost(): string\n\t{\n\t\treturn this.host;\n\t}\n\n\tgetUserId(): number\n\t{\n\t\treturn this.userId;\n\t}\n\n\tgetSiteId(): string\n\t{\n\t\treturn this.siteId;\n\t}\n\n\tgetLanguageId(): string\n\t{\n\t\treturn this.languageId;\n\t}\n\n\tgetStore(): Store\n\t{\n\t\treturn this.store;\n\t}\n\n\tgetRestClient(): RestClient\n\t{\n\t\treturn this.restClient;\n\t}\n\n\tgetPullClient(): Pull\n\t{\n\t\treturn this.pullClient;\n\t}\n\n\tsetApplicationData(data: {string: any})\n\t{\n\t\tthis.applicationData = { ...this.applicationData, ...data };\n\t}\n\n\tgetApplicationData(): {[key]: any}\n\t{\n\t\treturn this.applicationData;\n\t}\n\n\tisOnline(): boolean\n\t{\n\t\treturn !this.offline;\n\t}\n\n\tisCloud(): boolean\n\t{\n\t\tconst settings = Extension.getSettings('im.v2.application.core');\n\n\t\treturn settings.get('isCloud');\n\t}\n\n\tready(): Promise\n\t{\n\t\tif (this.inited)\n\t\t{\n\t\t\treturn Promise.resolve(this);\n\t\t}\n\n\t\tCore.start();\n\n\t\treturn this.initPromise;\n\t}\n\n\t/* endregion 05. Methods */\n}\n\nconst Core = new CoreApplication();\nexport { Core, CoreApplication };\n"],"names":["CoreApplication","constructor","applicationData","inited","initPromise","Promise","resolve","initPromiseResolver","offline","vuexAdditionalModel","store","storeBuilder","prepareVariables","initRestClient","start","initStorage","then","initPull","initComplete","catch","error","Logger","localize","BX","message","host","location","origin","userId","Number","parseInt","Loc","getMessage","siteId","siteDir","languageId","restInstance","RestClient","restClient","rest","builder","Builder","init","addModel","ApplicationModel","create","MessagesModel","ChatsModel","FilesModel","UsersModel","RecentModel","CountersModel","NotificationsModel","SidebarModel","MarketModel","build","result","pullInstance","PullClient","pullClient","PULL","reject","Error","subscribe","BasePullHandler","RecentPullHandler","NotificationPullHandler","NotifierPullHandler","LinesPullHandler","OnlinePullHandler","type","SubscriptionType","Status","callback","onPullStatusChange","bind","data","status","PullStatus","Online","Offline","createVue","application","config","initConfig","el","template","name","components","created","bitrixVue","BitrixVue","createApp","errorHandler","err","vm","info","console","warnHandler","warn","trace","use","mount","getHost","getUserId","getSiteId","getLanguageId","getStore","getRestClient","getPullClient","setApplicationData","getApplicationData","isOnline","isCloud","settings","Extension","getSettings","get","ready","Core"],"mappings":"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"}