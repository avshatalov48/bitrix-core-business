this.BX=this.BX||{};(function(e,s,t,i,a,o,n){"use strict";let c=e=>e,l,r,h,d;class D{constructor(e){this.sliderId="calendar:settings-slider";this.name="SettingsInterface";this.SLIDER_WIDTH=500;this.SLIDER_DURATION=80;this.DOM={};this.calendarContext=e.calendarContext;this.showPersonalSettings=e.showPersonalSettings;this.showGeneralSettings=e.showGeneralSettings;this.showAccessControl=e.showAccessControl!==false&&i.Type.isObjectLike(this.calendarContext.util.config.TYPE_ACCESS);this.settings=e.settings;this.BX=s.Util.getBX();this.hideMessageBinded=this.hideMessage.bind(this)}show(){this.BX.SidePanel.Instance.open(this.sliderId,{contentCallback:this.createContent.bind(this),width:this.SLIDER_WIDTH,animationDuration:this.SLIDER_DURATION,events:{onCloseByEsc:this.escHide.bind(this),onClose:this.hide.bind(this),onCloseComplete:this.destroy.bind(this),onLoad:this.onLoadSlider.bind(this)}})}escHide(e){if(e&&e.getSlider&&e.getSlider().getUrl()===this.sliderId&&this.denyClose){e.denyAction()}}close(){this.isOpenedState=false;BX.SidePanel.Instance.close()}isOpened(){return this.isOpenedState}hide(e){if(e&&e.getSlider&&e.getSlider().getUrl()===this.sliderId){if(this.denyClose){e.denyAction()}else{BX.removeCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this))}}}denySliderClose(){this.denyClose=true}allowSliderClose(){this.denyClose=false}destroy(e){if(e&&e.getSlider&&e.getSlider().getUrl()===this.sliderId){BX.SidePanel.Instance.destroy(this.sliderId);delete this.DOM.sectionListWrap}}createContent(e){return new Promise((s=>{top.BX.ajax.runAction("calendar.api.calendarajax.getSettingsSlider",{data:{showPersonalSettings:this.showPersonalSettings?"Y":"N",showGeneralSettings:this.showGeneralSettings?"Y":"N",showAccessControl:this.showAccessControl?"Y":"N",uid:this.uid}}).then((t=>{e.getData().set("sliderContent",t.data.html);const i=t.data.additionalParams;this.mailboxList=i.mailboxList;this.uid=i.uid;s(t.data.html)}))}))}onLoadSlider(e){const s=e.getSlider();this.DOM.content=s.layout.content;this.sliderId=s.getUrl();BX.html(s.layout.content,s.getData().get("sliderContent"));this.initControls();this.setControlsValue()}initControls(){this.DOM.buttonsWrap=this.DOM.content.querySelector(".calendar-form-buttons-fixed");BX.ZIndexManager.register(this.DOM.buttonsWrap);this.DOM.saveBtn=this.DOM.buttonsWrap.querySelector('[data-role="save_btn"]');this.DOM.closeBtn=this.DOM.buttonsWrap.querySelector('[data-role="close_btn"]');BX.Event.bind(this.DOM.saveBtn,"click",this.save.bind(this));BX.Event.bind(this.DOM.closeBtn,"click",this.close.bind(this));if(this.showPersonalSettings){this.DOM.denyBusyInvitation=this.DOM.content.querySelector('[data-role="deny_busy_invitation"]');this.DOM.showWeekNumbers=this.DOM.content.querySelector('[data-role="show_week_numbers"]');this.DOM.meetSectionSelect=this.DOM.content.querySelector('[data-role="meet_section"]');this.DOM.crmSelect=this.DOM.content.querySelector('[data-role="crm_section"]');this.DOM.showDeclined=this.DOM.content.querySelector('[data-role="show_declined"]');this.DOM.showTasks=this.DOM.content.querySelector('[data-role="show_tasks"]');this.DOM.syncTasks=this.DOM.content.querySelector('[data-role="sync_tasks"]');this.DOM.showCompletedTasks=this.DOM.content.querySelector('[data-role="show_completed_tasks"]');this.DOM.timezoneSelect=this.DOM.content.querySelector('[data-role="set_tz_sel"]');this.DOM.sendFromEmailSelect=this.DOM.content.querySelector('[data-role="send_from_email"]');if(this.BX.Type.isElementNode(this.DOM.sendFromEmailSelect)){this.emailSelectorControl=new t.EmailSelectorControl({selectNode:this.DOM.sendFromEmailSelect,allowAddNewEmail:true,mailboxList:this.mailboxList});this.DOM.emailHelpIcon=this.DOM.content.querySelector(".calendar-settings-question");if(this.DOM.emailHelpIcon&&BX.Helper){BX.Event.bind(this.DOM.emailHelpIcon,"click",(()=>{BX.Helper.show("redirect=detail&code=12070142")}));s.Util.initHintNode(this.DOM.emailHelpIcon)}this.emailSelectorControl.setValue(this.calendarContext.util.getUserOption("sendFromEmail"));this.DOM.emailWrap=this.DOM.content.querySelector(".calendar-settings-email-wrap");if(BX.Calendar.Util.isEventWithEmailGuestAllowed()){BX.Dom.removeClass(this.DOM.emailWrap,"lock");this.DOM.sendFromEmailSelect.disabled=false}else{BX.Dom.addClass(this.DOM.emailWrap,"lock");this.DOM.sendFromEmailSelect.disabled=true;BX.Event.bind(this.DOM.sendFromEmailSelect.parentNode,"click",(()=>{BX.UI.InfoHelper.show("limit_calendar_invitation_by_mail")}))}}}if(this.showGeneralSettings){this.DOM.workTimeStart=this.DOM.content.querySelector('[data-role="work_time_start"]');this.DOM.workTimeEnd=this.DOM.content.querySelector('[data-role="work_time_end"]');this.DOM.weekHolidays=this.DOM.content.querySelector('[data-role="week_holidays"]');this.DOM.yearHolidays=this.DOM.content.querySelector('[data-role="year_holidays"]');this.DOM.yearWorkdays=this.DOM.content.querySelector('[data-role="year_workdays"]')}if(this.showAccessControl){this.DOM.accessMessageWrap=this.DOM.content.querySelector('[data-role="type-access-message-card"]');this.DOM.accessOuterWrap=this.DOM.content.querySelector('[data-role="type-access-values-cont"]');this.DOM.accessHelpIcon=this.DOM.content.querySelector(".calendar-settings-access-hint");if(i.Type.isElementNode(this.DOM.accessHelpIcon)&&this.calendarContext.util.type==="location"){this.initMessageControl()}else if(i.Type.isElementNode(this.DOM.accessHelpIcon)){this.DOM.accessHelpIcon.remove()}if(i.Type.isElementNode(this.DOM.accessOuterWrap)){this.initAccessController()}}}initMessageControl(){const e=i.Tag.render(l||(l=c`
			<a class="ui-btn ui-btn-primary">${0}</a>
		`),i.Loc.getMessage("EC_LOCATION_SETTINGS_MORE_INFO"));i.Event.bind(e,"click",this.openHelpDesk);const s="";const t=i.Loc.getMessage("EC_LOCATION_SETTINGS_MESSAGE_DESCRIPTION");this.message=new n.MessageCard({id:"locationSettingsInfo",header:s,description:t,angle:false,hidden:true,actionElements:[e]});o.EventEmitter.subscribe(this.message,"onClose",this.hideMessageBinded);i.Event.bind(this.DOM.accessHelpIcon,"click",(()=>{this.onClickHint()}));if(this.DOM.accessMessageWrap){this.DOM.accessMessageWrap.appendChild(this.message.getLayout());if(!this.calendarContext.util.config.hideSettingsHintLocation){this.showMessage()}}}onClickHint(){if(!this.message){return}if(this.message.isShown()){this.hideMessage()}else{this.showMessage()}}setControlsValue(){if(this.showPersonalSettings){this.DOM.meetSectionSelect.options.length=0;const e=this.calendarContext.sectionManager.getSectionListForEdit();let s=parseInt(this.calendarContext.util.getUserOption("crmSection"));let t=parseInt(this.calendarContext.util.getUserOption("meetSection"));let i;let a;for(let o=0;o<e.length;o++){i=e[o];if(i.belongsToOwner()){if(!t){t=i.id}a=t===parseInt(i.id);this.DOM.meetSectionSelect.options.add(new Option(i.name,i.id,a,a));if(!s){s=i.id}a=s===parseInt(i.id);this.DOM.crmSelect.options.add(new Option(i.name,i.id,a,a))}}}if(this.DOM.showDeclined){this.DOM.showDeclined.checked=this.calendarContext.util.getUserOption("showDeclined")}var e=this.calendarContext.util.getUserOption("showTasks")==="Y";if(this.DOM.showTasks){this.DOM.showTasks.checked=e;BX.Event.bind(this.DOM.showTasks,"click",function(){if(this.DOM.showCompletedTasks){this.DOM.showCompletedTasks.disabled=!this.DOM.showTasks.checked;this.DOM.showCompletedTasks.checked=this.DOM.showCompletedTasks.checked&&this.DOM.showTasks.checked}if(this.DOM.syncTasks){this.DOM.syncTasks.disabled=!this.DOM.showTasks.checked;this.DOM.syncTasks.checked=this.DOM.syncTasks.checked&&this.DOM.showTasks.checked}}.bind(this))}if(this.DOM.showCompletedTasks){this.DOM.showCompletedTasks.checked=this.calendarContext.util.getUserOption("showCompletedTasks")==="Y"&&this.DOM.showTasks.checked;this.DOM.showCompletedTasks.disabled=!e}if(this.DOM.syncTasks){this.DOM.syncTasks.checked=this.calendarContext.util.getUserOption("syncTasks")==="Y"&&this.DOM.showTasks.checked;this.DOM.syncTasks.disabled=!e}if(this.DOM.denyBusyInvitation){this.DOM.denyBusyInvitation.checked=this.calendarContext.util.getUserOption("denyBusyInvitation")}if(this.DOM.showWeekNumbers){this.DOM.showWeekNumbers.checked=this.calendarContext.util.showWeekNumber()}if(this.DOM.timezoneSelect){this.DOM.timezoneSelect.value=this.calendarContext.util.getUserOption("timezoneName")||""}if(this.showGeneralSettings){this.DOM.workTimeStart.value=this.settings.work_time_start;this.DOM.workTimeEnd.value=this.settings.work_time_end;if(this.DOM.weekHolidays){for(let e=0;e<this.DOM.weekHolidays.options.length;e++){this.DOM.weekHolidays.options[e].selected=this.settings.week_holidays.includes(this.DOM.weekHolidays.options[e].value)}}this.DOM.yearHolidays.value=this.settings.year_holidays;this.DOM.yearWorkdays.value=this.settings.year_workdays}if(this.showAccessControl&&i.Type.isElementNode(this.DOM.accessOuterWrap)){const e=this.calendarContext.util.config.TYPE_ACCESS;for(let s in e){if(e.hasOwnProperty(s)){this.insertAccessRow(this.calendarContext.util.getAccessName(s),s,e[s])}}}}save(){const e=this.calendarContext.util.config.userSettings;if(this.DOM.showDeclined){e.showDeclined=this.DOM.showDeclined.checked?1:0}if(this.DOM.showWeekNumbers){e.showWeekNumbers=this.DOM.showWeekNumbers.checked?"Y":"N"}if(this.DOM.showTasks){e.showTasks=this.DOM.showTasks.checked?"Y":"N"}if(this.DOM.syncTasks){e.syncTasks=this.DOM.syncTasks.checked?"Y":"N"}if(this.DOM.showCompletedTasks){e.showCompletedTasks=this.DOM.showCompletedTasks.checked?"Y":"N"}if(this.DOM.meetSectionSelect){e.meetSection=this.DOM.meetSectionSelect.value}if(this.DOM.crmSelect){e.crmSection=this.DOM.crmSelect.value}if(this.DOM.denyBusyInvitation){e.denyBusyInvitation=this.DOM.denyBusyInvitation.checked?1:0}e.userTimezoneName=this.DOM.timezoneSelect?this.DOM.timezoneSelect.value:e.timezoneName;if(this.emailSelectorControl){e.sendFromEmail=this.emailSelectorControl.getValue()}const s={type:this.calendarContext.util.config.type,user_settings:e,user_timezone_name:e.userTimezoneName};if(this.showGeneralSettings&&this.DOM.workTimeStart){s.settings={work_time_start:this.DOM.workTimeStart.value,work_time_end:this.DOM.workTimeEnd.value,week_holidays:[],year_holidays:this.DOM.yearHolidays.value,year_workdays:this.DOM.yearWorkdays.value};for(let e=0;e<this.DOM.weekHolidays.options.length;e++){if(this.DOM.weekHolidays.options[e].selected){s.settings.week_holidays.push(this.DOM.weekHolidays.options[e].value)}}}if(this.showAccessControl){s.type_access=this.access}BX.ajax.runAction("calendar.api.calendarajax.saveSettings",{data:s}).then((()=>{BX.reload()}));this.close()}initAccessController(){var e,t,o,n,l;this.DOM.accessWrap=this.DOM.accessOuterWrap.appendChild(i.Tag.render(r||(r=c`
				<div class="calendar-list-slider-access-container shown">
					<div class="calendar-list-slider-access-inner-wrap">
						${0}
					</div>
					<div class="calendar-list-slider-new-calendar-options-container">
						${0}
					</div>
				</div>`),this.DOM.accessTable=i.Tag.render(h||(h=c`
							<table class="calendar-section-slider-access-table" />
						`)),this.DOM.accessButton=i.Tag.render(d||(d=c`
							<span class="calendar-list-slider-new-calendar-option-add">
								${0}
							</span>`),i.Loc.getMessage("EC_SEC_SLIDER_ACCESS_ADD"))));this.access={};this.accessControls={};this.accessTasks=(e=this.calendarContext)==null?void 0:(t=e.util)==null?void 0:t.getTypeAccessTasks();if((o=this.calendarContext)!=null&&(n=o.util)!=null&&(l=n.config)!=null&&l.accessNames){s.Util.setAccessNames(this.calendarContext.util.config.accessNames)}i.Event.bind(this.DOM.accessButton,"click",(()=>{this.entitySelectorDialog=new a.Dialog({targetNode:this.DOM.accessButton,context:"CALENDAR",preselectedItems:[],enableSearch:true,events:{"Item:onSelect":this.handleEntitySelectorChanges.bind(this),"Item:onDeselect":this.handleEntitySelectorChanges.bind(this)},popupOptions:{targetContainer:document.body},entities:[{id:"user"},{id:"project"},{id:"department",options:{selectMode:"usersAndDepartments"}},{id:"meta-user",options:{"all-users":true}}]});this.entitySelectorDialog.show();this.entitySelectorDialog.subscribe("onHide",this.allowSliderClose.bind(this));this.denySliderClose()}));i.Event.bind(this.DOM.accessWrap,"click",(e=>{const t=s.Util.findTargetNode(e.target||e.srcElement,this.DOM.outerWrap);if(i.Type.isElementNode(t)){if(t.getAttribute("data-bx-calendar-access-selector")!==null){const e=t.getAttribute("data-bx-calendar-access-selector");if(this.accessControls[e]){this.showAccessSelectorPopup({node:this.accessControls[e].removeIcon,setValueCallback:s=>{if(this.accessTasks[s]&&this.accessControls[e]){this.accessControls[e].valueNode.innerHTML=i.Text.encode(this.accessTasks[s].title);this.access[e]=s}}})}}else if(t.getAttribute("data-bx-calendar-access-remove")!==null){const e=t.getAttribute("data-bx-calendar-access-remove");if(this.accessControls[e]){i.Dom.remove(this.accessControls[e].rowNode);this.accessControls[e]=null;delete this.access[e]}}}}))}handleEntitySelectorChanges(){const e=this.entitySelectorDialog.getSelectedItems();this.entitySelectorDialog.hide();if(i.Type.isArray(e)){e.forEach((e=>{const t=e.title.text;const i=s.Util.convertEntityToAccessCode(e);s.Util.setAccessName(i,t);this.insertAccessRow(t,i)}))}i.Runtime.debounce((()=>{this.entitySelectorDialog.destroy()}),400)()}insertAccessRow(e,s,t){if(!this.accessControls[s]){if(t===undefined){for(let e in this.accessTasks){if(this.accessTasks.hasOwnProperty(e)&&this.accessTasks[e].name==="calendar_type_edit"){t=e;break}}}const a=i.Dom.adjust(this.DOM.accessTable.insertRow(-1),{props:{className:"calendar-section-slider-access-table-row"}});const o=i.Dom.adjust(a.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},html:'<span class="calendar-section-slider-access-title">'+i.Text.encode(e)+":</span>"});const n=i.Dom.adjust(a.insertCell(-1),{props:{className:"calendar-section-slider-access-table-cell"},attrs:{"data-bx-calendar-access-selector":s}});const c=n.appendChild(i.Dom.create("SPAN",{props:{className:"calendar-section-slider-access-container"}}));const l=c.appendChild(i.Dom.create("SPAN",{text:this.accessTasks[t]?this.accessTasks[t].title:"",props:{className:"calendar-section-slider-access-value"}}));const r=c.appendChild(i.Dom.create("SPAN",{props:{className:"calendar-section-slider-access-remove"},attrs:{"data-bx-calendar-access-remove":s}}));this.access[s]=t;this.accessControls[s]={rowNode:a,titleNode:o,valueNode:l,removeIcon:r}}}checkAccessTableHeight(){if(this.checkTableTimeout){this.checkTableTimeout=clearTimeout(this.checkTableTimeout)}this.checkTableTimeout=setTimeout((()=>{if(i.Dom.hasClass(this.DOM.accessWrap,"shown")){if(this.DOM.accessWrap.offsetHeight-this.DOM.accessTable.offsetHeight<36){this.DOM.accessWrap.style.maxHeight=parseInt(this.DOM.accessTable.offsetHeight)+100+"px"}}else{this.DOM.accessWrap.style.maxHeight=""}}),300)}showAccessSelectorPopup(e){if(this.accessPopupMenu&&this.accessPopupMenu.popupWindow&&this.accessPopupMenu.popupWindow.isShown()){return this.accessPopupMenu.close()}const t=this;const i=[];for(let s in this.accessTasks){if(this.accessTasks.hasOwnProperty(s)){i.push({text:this.accessTasks[s].title,onclick:function(s){return function(){e.setValueCallback(s);t.accessPopupMenu.close()}}(s)})}}this.accessPopupMenu=this.BX.PopupMenu.create("section-access-popup"+s.Util.randomInt(),e.node,i,{closeByEsc:true,autoHide:true,offsetTop:-5,offsetLeft:0,angle:true,cacheable:false,events:{onPopupClose:this.allowSliderClose.bind(this)}});this.accessPopupMenu.show();this.denySliderClose()}openHelpDesk(){let e=14326208;top.BX.Helper.show("redirect=detail&code="+e)}showMessage(){if(this.message){this.message.show();this.DOM.accessMessageWrap.style.maxHeight=300+"px";i.Dom.addClass(this.DOM.accessHelpIcon,"calendar-settings-message-arrow-target")}}hideMessage(){if(this.message){i.Dom.removeClass(this.DOM.accessHelpIcon,"calendar-settings-message-arrow-target");this.message.hide();this.DOM.accessMessageWrap.style.maxHeight=0;if(!this.calendarContext.util.config.hideSettingsHintLocation){BX.ajax.runAction("calendar.api.locationajax.hideSettingsHintLocation",{data:{value:true}}).then((()=>{}))}}}}e.SettingsInterface=D})(this.BX.Calendar=this.BX.Calendar||{},BX.Calendar,BX.Calendar.Controls,BX,BX.UI.EntitySelector,BX.Event,BX.UI);
//# sourceMappingURL=settingsinterface.bundle.map.js