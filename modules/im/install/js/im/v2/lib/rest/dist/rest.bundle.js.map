{"version":3,"file":"rest.bundle.js","sources":["../src/rest.js"],"sourcesContent":["import { ajax, Type, type JsonObject } from 'main.core';\nimport { EventEmitter } from 'main.core.events';\n\nimport { EventType } from 'im.v2.const';\nimport { Core } from 'im.v2.application.core';\n\ntype RunActionConfig = {\n\tdata?: JsonObject,\n\tanalyticsLabel?: JsonObject\n};\n\ntype RunActionResult = {\n\tstatus: 'success' | 'error',\n\tdata: any,\n\terrors: RunActionError[]\n};\n\nexport type RunActionError = {\n\tcode: number | string,\n\tcustomData: any,\n\tmessage: string\n};\n\ntype BatchQuery = {\n\t[method: string]: {[param: string]: any}\n}\n\nconst INVALID_AUTH_ERROR_CODE = 'invalid_authentication';\nlet retryAllowed = true;\n\nexport const runAction = (action: string, config: RunActionConfig = {}): Promise<RunActionResult> => {\n\tconst preparedConfig = { ...config, data: prepareRequestData(config.data) };\n\n\treturn new Promise((resolve, reject) => {\n\t\tajax.runAction(action, preparedConfig).then((response: RunActionResult) => {\n\t\t\tretryAllowed = true;\n\n\t\t\treturn resolve(response.data);\n\t\t}).catch((response: RunActionResult) => {\n\t\t\tif (needRetryRequest(response.errors))\n\t\t\t{\n\t\t\t\tretryAllowed = false;\n\n\t\t\t\treturn handleErrors(action, preparedConfig, response);\n\t\t\t}\n\n\t\t\treturn reject(response.errors);\n\t\t});\n\t});\n};\n\nconst handleErrors = async (action: string, config: RunActionConfig, response: RunActionResult) => {\n\tawait EventEmitter.emitAsync(EventType.request.onAuthError, { errors: response.errors });\n\n\treturn runAction(action, config);\n};\n\nconst needRetryRequest = (responseErrors: RunActionError[]): boolean => {\n\tif (!retryAllowed)\n\t{\n\t\treturn false;\n\t}\n\n\treturn responseErrors.some((error) => error.code === INVALID_AUTH_ERROR_CODE);\n};\n\nexport const callBatch = (query: BatchQuery): Promise<{[method: string]: any}> => {\n\tconst preparedQuery = {};\n\tconst methodsToCall = new Set();\n\tObject.entries(query).forEach(([method, params]) => {\n\t\tmethodsToCall.add(method);\n\t\tpreparedQuery[method] = [method, params];\n\t});\n\n\treturn new Promise((resolve, reject) => {\n\t\tCore.getRestClient().callBatch(preparedQuery, (result) => {\n\t\t\tconst data = {};\n\t\t\tfor (const method of methodsToCall)\n\t\t\t{\n\t\t\t\tconst methodResult: RestResult = result[method];\n\t\t\t\tif (methodResult.error())\n\t\t\t\t{\n\t\t\t\t\tconst { error: code, error_description: description } = methodResult.error().ex;\n\t\t\t\t\treject({ method, code, description });\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t\tdata[method] = methodResult.data();\n\t\t\t}\n\n\t\t\treturn resolve(data);\n\t\t});\n\t});\n};\n\nconst prepareRequestData = (data: JsonObject): JsonObject => {\n\tif (data instanceof FormData)\n\t{\n\t\treturn data;\n\t}\n\n\tif (!Type.isObjectLike(data))\n\t{\n\t\treturn {};\n\t}\n\n\tconst preparedData = {};\n\tfor (const [key, value] of Object.entries(data))\n\t{\n\t\tlet preparedValue = value;\n\t\tif (Type.isBoolean(value))\n\t\t{\n\t\t\tpreparedValue = value === true ? 'Y' : 'N';\n\t\t}\n\n\t\tpreparedData[key] = preparedValue;\n\t}\n\n\treturn preparedData;\n};\n"],"names":["INVALID_AUTH_ERROR_CODE","retryAllowed","runAction","action","config","preparedConfig","data","prepareRequestData","Promise","resolve","reject","ajax","then","response","catch","needRetryRequest","errors","handleErrors","EventEmitter","emitAsync","EventType","request","onAuthError","responseErrors","some","error","code","callBatch","query","preparedQuery","methodsToCall","Set","Object","entries","forEach","method","params","add","Core","getRestClient","result","methodResult","error_description","description","ex","FormData","Type","isObjectLike","preparedData","key","value","preparedValue","isBoolean"],"mappings":"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"}