this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(t,e,s,i,n,a,r,o,c,l,g,d,m,h,p){"use strict";const u={name:"MessageText",components:{MessageAvatar:a.MessageAvatar},props:{item:{type:Object,required:true}},computed:{AvatarSize:()=>a.AvatarSize,recentItem(){return this.item},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},user(){return this.$store.getters["users/get"](this.recentItem.dialogId,true)},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},showLastMessage(){return this.$store.getters["application/settings/get"](c.Settings.recent.showLastMessage)},hiddenMessageText(){return this.$Bitrix.Loc.getMessage("IM_LIST_RECENT_CHAT_TYPE_GROUP_V2")},isLastMessageAuthor(){if(!this.message){return false}return this.message.authorId===o.Core.getUserId()},lastMessageAuthorAvatar(){const t=this.$store.getters["chats/get"](this.message.authorId);if(!t){return""}return t.avatar},lastMessageAuthorAvatarStyle(){return{backgroundImage:`url('${this.lastMessageAuthorAvatar}')`}},messageText(){const t=n.Parser.purifyRecent(this.recentItem);if(!t){return this.hiddenMessageText}return t},formattedMessageText(){const t=27;return i.Utils.text.insertUnseenWhitespace(this.messageText,t)},preparedDraftContent(){const t=this.loc("IM_LIST_RECENT_MESSAGE_DRAFT_2");const e="#TEXT#".length;const s=t.slice(0,-e);const i=m.Text.encode(this.formattedDraftText);return`\n\t\t\t\t<span class="bx-im-list-copilot-item__message_draft-prefix">${s}</span>\n\t\t\t\t<span class="bx-im-list-copilot-item__message_text_content">${i}</span>\n\t\t\t`},formattedDraftText(){return n.Parser.purify({text:this.recentItem.draft.text,showIconIfEmptyText:false})}},methods:{loc(t,e={}){return this.$Bitrix.Loc.getMessage(t,e)}},template:`\n\t\t<div class="bx-im-list-copilot-item__message_container">\n\t\t\t<span class="bx-im-list-copilot-item__message_text">\n\t\t\t\t<span v-if="recentItem.draft.text && dialog.counter === 0" v-html="preparedDraftContent"></span>\n\t\t\t\t<span v-else-if="!showLastMessage">{{ hiddenMessageText }}</span>\n\t\t\t\t<template v-else>\n\t\t\t\t\t<span v-if="isLastMessageAuthor" class="bx-im-list-copilot-item__message_author-icon --self"></span>\n\t\t\t\t\t<MessageAvatar\n\t\t\t\t\t\tv-else-if="message.authorId"\n\t\t\t\t\t\t:messageId="message.id"\n\t\t\t\t\t\t:authorId="message.authorId"\n\t\t\t\t\t\t:size="AvatarSize.XXS"\n\t\t\t\t\t\tclass="bx-im-list-copilot-item__message_author-avatar"\n\t\t\t\t\t/>\n\t\t\t\t\t<span class="bx-im-list-copilot-item__message_text_content">{{ formattedMessageText }}</span>\n\t\t\t\t</template>\n\t\t\t</span>\n\t\t</div>\n\t`};const v={name:"CopilotItem",components:{ChatAvatar:a.ChatAvatar,ChatTitle:a.ChatTitle,MessageText:u},props:{item:{type:Object,required:true}},data(){return{}},computed:{AvatarSize:()=>a.AvatarSize,recentItem(){return this.item},formattedDate(){return this.formatDate(this.message.date)},formattedCounter(){return this.dialog.counter>99?"99+":this.dialog.counter.toString()},dialog(){return this.$store.getters["chats/get"](this.recentItem.dialogId,true)},message(){return this.$store.getters["recent/getMessage"](this.recentItem.dialogId)},layout(){return this.$store.getters["application/getLayout"]},isChatSelected(){if(this.layout.name!==c.Layout.copilot.name){return false}return this.layout.entityId===this.recentItem.dialogId},isChatMuted(){const t=this.dialog.muteList.find((t=>t===o.Core.getUserId()));return Boolean(t)},isSomeoneTyping(){return this.dialog.writingList.length>0},showLastMessage(){return this.$store.getters["application/settings/get"](c.Settings.recent.showLastMessage)},showPinnedIcon(){return this.recentItem.pinned&&this.dialog.counter===0&&!this.recentItem.unread},showCounter(){return this.dialog.counter>0},wrapClasses(){return{"--pinned":this.recentItem.pinned,"--selected":this.isChatSelected}},itemClasses(){return{"--no-text":!this.showLastMessage}}},methods:{formatDate(t){return r.DateFormatter.formatByTemplate(t,r.DateTemplate.recent)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div :data-id="recentItem.dialogId" :class="wrapClasses" class="bx-im-list-copilot-item__wrap">\n\t\t\t<div :class="itemClasses" class="bx-im-list-copilot-item__container">\n\t\t\t\t<div class="bx-im-list-copilot-item__avatar_container">\n\t\t\t\t\t<div class="bx-im-list-copilot-item__avatar_content">\n\t\t\t\t\t\t<ChatAvatar\n\t\t\t\t\t\t\t:avatarDialogId="recentItem.dialogId"\n\t\t\t\t\t\t\t:contextDialogId="recentItem.dialogId"\n\t\t\t\t\t\t\t:withSpecialTypes="false"\n\t\t\t\t\t\t\t:size="AvatarSize.XL"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<div v-if="isSomeoneTyping" class="bx-im-list-copilot-item__avatar_typing"></div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-list-copilot-item__content_container">\n\t\t\t\t\t<div class="bx-im-list-copilot-item__content_header">\n\t\t\t\t\t\t<ChatTitle :dialogId="recentItem.dialogId" :withMute="true" />\n\t\t\t\t\t\t<div class="bx-im-list-copilot-item__date">\n\t\t\t\t\t\t\t<span>{{ formattedDate }}</span>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-list-copilot-item__content_bottom">\n\t\t\t\t\t\t<MessageText :item="recentItem" />\n\t\t\t\t\t\t<div :class="{'--extended': dialog.counter > 99}" class="bx-im-list-copilot-item__counter_wrap">\n\t\t\t\t\t\t\t<div class="bx-im-list-copilot-item__counter_container">\n\t\t\t\t\t\t\t\t<div v-if="showPinnedIcon" class="bx-im-list-copilot-item__pinned-icon"></div>\n\t\t\t\t\t\t\t\t<div v-else-if="showCounter" :class="{'--muted': isChatMuted}" class="bx-im-list-copilot-item__counter_number">\n\t\t\t\t\t\t\t\t\t{{ formattedCounter }}\n\t\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t\t</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};class _ extends d.RecentService{getQueryParams(t){return{ONLY_COPILOT:"Y",LIMIT:this.itemsPerPage,LAST_MESSAGE_DATE:t?null:this.lastMessageDate,GET_ORIGINAL_TEXT:"Y",PARSE_TEXT:"Y"}}getModelSaveMethod(){return"recent/setCopilot"}getCollection(){return o.Core.getStore().getters["recent/getCopilotCollection"]}getExtractorOptions(){return{withBirthdays:false}}hideChat(t){g.Logger.warn("Im.CopilotRecentList: hide chat",t);const e=o.Core.getStore().getters["recent/get"](t);if(!e){return}o.Core.getStore().dispatch("recent/delete",{id:t});const s=o.Core.getStore().getters["application/isChatOpen"](t);if(s){l.LayoutManager.getInstance().clearCurrentLayoutEntityId();void l.LayoutManager.getInstance().deleteLastOpenedElementById(t)}o.Core.getRestClient().callMethod(c.RestMethod.imRecentHide,{DIALOG_ID:t}).catch((t=>{console.error("Im.CopilotRecentList: hide chat error",t)}))}}class I extends p.RecentMenu{getMenuItems(){return[this.getPinMessageItem(),this.getHideItem(),this.getLeaveItem()]}getOpenItem(){return{text:m.Loc.getMessage("IM_LIB_MENU_OPEN"),onclick:()=>{h.Messenger.openCopilot(this.context.dialogId);this.menuInstance.close()}}}getHideItem(){return{text:m.Loc.getMessage("IM_LIB_MENU_HIDE_MSGVER_1"),onclick:()=>{this.getRecentService().hideChat(this.context.dialogId);this.menuInstance.close()}}}getRecentService(){if(!this.service){this.service=new _}return this.service}}const M={name:"CopilotList",components:{CopilotItem:v,LoadingState:a.ListLoadingState},emits:["chatClick"],data(){return{isLoading:false,isLoadingNextPage:false}},computed:{collection(){return this.getRecentService().getCollection()},sortedItems(){return[...this.collection].sort(((t,e)=>{const s=this.$store.getters["recent/getSortDate"](t.dialogId);const i=this.$store.getters["recent/getSortDate"](e.dialogId);return i-s}))},pinnedItems(){return this.sortedItems.filter((t=>t.pinned===true))},generalItems(){return this.sortedItems.filter((t=>t.pinned===false))},isEmptyCollection(){return this.collection.length===0}},async created(){this.contextMenuManager=new I;this.isLoading=true;await this.getRecentService().loadFirstPage();this.isLoading=false;void e.CopilotDraftManager.getInstance().initDraftHistory()},beforeUnmount(){this.contextMenuManager.destroy()},methods:{async onScroll(t){this.contextMenuManager.close();if(!i.Utils.dom.isOneScreenRemaining(t.target)||!this.getRecentService().hasMoreItemsToLoad){return}this.isLoadingNextPage=true;await this.getRecentService().loadNextPage();this.isLoadingNextPage=false},onClick(t,e){this.$emit("chatClick",t.dialogId)},onRightClick(t,e){e.preventDefault();this.contextMenuManager.openMenu(t,e.currentTarget)},getRecentService(){if(!this.service){this.service=new _}return this.service},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-list-copilot__scope bx-im-list-copilot__container">\n\t\t\t<LoadingState v-if="isLoading && isEmptyCollection" />\n\t\t\t<div v-else @scroll="onScroll" class="bx-im-list-copilot__scroll-container">\n\t\t\t\t<div v-if="isEmptyCollection" class="bx-im-list-copilot__empty">\n\t\t\t\t\t<div class="bx-im-list-copilot__empty_icon"></div>\n\t\t\t\t\t<div class="bx-im-list-copilot__empty_text">{{ loc('IM_LIST_COPILOT_EMPTY') }}</div>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="pinnedItems.length > 0" class="bx-im-list-copilot__pinned_container">\n\t\t\t\t\t<CopilotItem\n\t\t\t\t\t\tv-for="item in pinnedItems"\n\t\t\t\t\t\t:key="item.dialogId"\n\t\t\t\t\t\t:item="item"\n\t\t\t\t\t\t@click="onClick(item, $event)"\n\t\t\t\t\t\t@click.right="onRightClick(item, $event)"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-list-copilot__general_container">\n\t\t\t\t\t<CopilotItem\n\t\t\t\t\t\tv-for="item in generalItems"\n\t\t\t\t\t\t:key="item.dialogId"\n\t\t\t\t\t\t:item="item"\n\t\t\t\t\t\t@click="onClick(item, $event)"\n\t\t\t\t\t\t@click.right="onRightClick(item, $event)"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<LoadingState v-if="isLoadingNextPage" />\n\t\t\t</div>\n\t\t</div>\n\t`};t.CopilotList=M})(this.BX.Messenger.v2.Component.List=this.BX.Messenger.v2.Component.List||{},BX.Messenger.v2.Lib,BX.Main,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=copilot-list.bundle.map.js