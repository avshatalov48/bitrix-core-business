this.BX=this.BX||{};this.BX.UI=this.BX.UI||{};this.BX.UI.BBCode=this.BX.UI.BBCode||{};(function(e,t,r,n,o,a,s,i){"use strict";function l(e,t=1){const r=[];for(let n=0;n<t;n++){r.push(e.createElement({name:"p"}))}return r}function c(e){return e.getType()!==n.BBCodeNode.ELEMENT_NODE||e.hasGroup("#inline")||e.hasGroup("#inlineBlock")}function d(e,t){const r=[];let n=null;let o=0;for(const a of e){if(t.isNewLine(a)){o++;continue}if(c(a)){if(n===null||o>=2){r.push(...l(t,o-2));n=t.createElement({name:"p"});r.push(n)}else if(o===1){n.appendChild(t.createNewLine())}n.appendChild(a)}else{if(o>2){r.push(...l(t,o-2))}r.push(a);n=null}o=0}if(r.length===0){return[t.createElement({name:"p"})]}return r}function u(e){const t=e.getScheme();const r=d(e.getChildren(),t);e.setChildren(r);return e}let m=e=>e,p;class g extends a.NodeFormatter{constructor(e={}){super({name:"#root",convert(){return document.createDocumentFragment()},before({node:e}){return u(e)},after({element:e,formatter:t}){const r=t.getContainerMode();if(r==="void"||r==="collapsed"){const t=i.Tag.render(p||(p=m`<div class="ui-typography-container --${0}"></div>`),r);t.appendChild(e);return t}return e},...e})}}function h(e,t){let r=e;while(r!==null&&r.getType()!==n.BBCodeNode.ROOT_NODE){if(t(r)){return r}r=r.getParent()}return null}var f=babelHelpers.classPrivateFieldLooseKey("smileyParser");class y extends a.NodeFormatter{constructor(e={}){super({name:"#text",convert({node:e}){const r=e.toString({encode:false});if(h(e,(e=>e.getName()==="code"))){return document.createTextNode(r)}const n=babelHelpers.classPrivateFieldLooseBase(this,f)[f].parse(r);if(n.length===0){return document.createTextNode(r)}const o=document.createDocumentFragment();let a=0;for(const e of n){if(a<e.start){const t=document.createTextNode(r.slice(a,e.start));o.appendChild(t)}const n=r.slice(e.start,e.end);const s=t.SmileyManager.get(n);if(s===null){o.appendChild(document.createTextNode(n))}else{o.appendChild(this.createImg(s))}a=e.end}if(a<r.length){const e=document.createTextNode(r.slice(a));o.appendChild(e)}return o},...e});Object.defineProperty(this,f,{writable:true,value:null});babelHelpers.classPrivateFieldLooseBase(this,f)[f]=new t.SmileyParser(t.SmileyManager.getAll())}createImg(e){const t=document.createElement("img");t.src=encodeURI(e.getImage());t.className="ui-typography-smiley";t.alt=e.getTyping();if(e.getWidth()>0&&e.getHeight()>0){t.width=e.getWidth();t.height=e.getHeight()}return t}}class N extends a.NodeFormatter{constructor(e={}){super({name:"#tab",convert({node:e}){if(e.getParent().getName()==="code"){return document.createTextNode(e.toString())}return document.createTextNode(" ")},...e})}}class b extends a.NodeFormatter{constructor(e={}){super({name:"#linebreak",convert({node:e}){return document.createElement("br")},...e})}}function F(e){const t=[...e];const r=t[0];const n=t[t.length-1];if(v(r)||T(r)&&r.isEmpty()){t.splice(0,1)}if(v(n)||T(n)&&n.isEmpty()){t.splice(-1,1)}return t}function v(e){return e&&e.getScheme().isNewLine(e)}function T(e){return e&&e.getName()==="p"}function x(e){const t=e.getScheme();const r=F(e.getChildren(),t);e.setChildren(r);if(r.length===0||!t.isNewLine(r.at(-1))&&/^\s*$/.test(e.getTextContent())){e.appendChild(t.createNewLine())}return e}class C extends a.NodeFormatter{constructor(e={}){super({name:"p",convert({node:e}){return i.Dom.create({tag:e.getName(),attrs:{className:"ui-typography-paragraph"}})},before({node:e}){return x(e)},...e})}}class L extends a.NodeFormatter{constructor(e={}){super({name:"b",convert({node:e}){return i.Dom.create({tag:"b",attrs:{...e.getAttributes(),className:"ui-typography-text-bold"}})},...e})}}class A extends a.NodeFormatter{constructor(e={}){super({name:"u",convert({node:e}){return i.Dom.create({tag:"u",attrs:{...e.getAttributes(),className:"ui-typography-text-underline"}})},...e})}}class S extends a.NodeFormatter{constructor(e={}){super({name:"i",convert({node:e}){return i.Dom.create({tag:"i",attrs:{...e.getAttributes(),className:"ui-typography-text-italic"}})},...e})}}class B extends a.NodeFormatter{constructor(e={}){super({name:"s",convert({node:e}){return i.Dom.create({tag:"s",attrs:{...e.getAttributes(),className:"ui-typography-text-strikethrough"}})},...e})}}class w extends a.NodeFormatter{constructor(e={}){super({name:"table",convert(){return i.Dom.create({tag:"table",attrs:{classname:"ui-typography-table"}})},...e})}}class D extends a.NodeFormatter{constructor(e={}){super({name:"th",convert(){return i.Dom.create({tag:"th",attrs:{classname:"ui-typography-table-cell ui-typography-table-cell-header"}})},before({node:e}){return u(e)},...e})}}class I extends a.NodeFormatter{constructor(e={}){super({name:"td",convert(){return i.Dom.create({tag:"td",attrs:{classname:"ui-typography-table-cell"}})},before({node:e}){return u(e)},...e})}}class P extends a.NodeFormatter{constructor(e={}){super({name:"tr",convert(){return i.Dom.create({tag:"tr",attrs:{classname:"ui-typography-table-row"}})},...e})}}class E extends a.NodeFormatter{constructor(e){super({name:"list",convert({node:e}){const t=e.getValue()==="1"?"ol":"ul";return i.Dom.create({tag:t,attrs:{...e.getAttributes(),className:`ui-typography-${t}`}})},...e})}}class M extends a.NodeFormatter{constructor(e){super({name:"*",convert({node:e}){return i.Dom.create({tag:"li",attrs:{...e.getAttributes(),className:"ui-typography-li"}})},...e})}}class k extends a.NodeFormatter{constructor(e={}){super({name:"quote",convert(){return i.Dom.create({tag:"blockquote",attrs:{className:"ui-typography-quote"}})},before({node:e}){return u(e)},...e})}}var H=babelHelpers.classPrivateFieldLooseKey("codeParser");class O extends a.NodeFormatter{constructor(e={}){super({name:"code",before({node:e}){return x(e)},convert({node:e}){const t=e.getTextContent();return i.Dom.create({tag:"code",attrs:{className:"ui-typography-code"},dataset:{decorator:true},children:V(babelHelpers.classPrivateFieldLooseBase(this,H)[H].parse(t))})},...e});Object.defineProperty(this,H,{writable:true,value:new r.CodeParser})}}function V(e){const t=[];e.forEach((e=>{const r=e.content.split(/([\t\n])/);const n=r.length;for(let o=0;o<n;o++){const n=r[o];if(n==="\n"||n==="\r\n"){t.push(document.createElement("br"))}else if(n==="\t"){t.push(document.createTextNode("\t"))}else if(n.length>0){const r=document.createElement("span");r.className=`ui-typography-token-${e.type}`;r.textContent=n;t.push(r)}}}));return t}class U extends a.NodeFormatter{constructor(e={}){super({name:"url",validate({node:e}){const t=U.fetchNodeValue(e);return!U.startsWithJavascriptScheme(t)},before({node:e,formatter:t}){if(t.isShortLinkEnabled()){const r=e.getChildren().some((e=>e.getName()==="img"));if(!r){const r=e.getScheme();const n=e.getPlainTextLength();const{shortLink:o}=t.getLinkSettings();if(n>o.maxLength){const t=U.fetchNodeValue(e);const n=r.createRoot({children:e.getChildren()});const[a,s]=n.split({offset:o.maxLength-o.lastFragmentLength});const i=s.getPlainTextLength();const l=e.clone();l.setValue(t);if(i>o.lastFragmentLength){l.appendChild(...a.getChildren(),r.createText("..."));const[,e]=s.split({offset:i-o.lastFragmentLength});l.appendChild(...e.getChildren());return l}l.setChildren([...a.getChildren(),r.createText("..."),...s.getChildren()]);return l}}}return e},convert({node:e,formatter:t}){const r=(()=>{const t=e.getValue();if(i.Type.isStringFilled(t)){return t}return e.getContent()})();const n=e.getAttributes();const{defaultTarget:o="_blank",attributes:a}=t.getLinkSettings();return i.Dom.create({tag:"a",attrs:{...n,...a,href:r,target:o,className:"ui-typography-link"}})},...e})}static fetchNodeValue(e){const t=e.getValue();if(i.Type.isStringFilled(t)){return t}return e.toPlainText()}static startsWithJavascriptScheme(e){if(i.Type.isStringFilled(e)){const t=/^[\u0000-\u001F ]*j[\t\n\r]*a[\t\n\r]*v[\t\n\r]*a[\t\n\r]*s[\t\n\r]*c[\t\n\r]*r[\t\n\r]*i[\t\n\r]*p[\t\n\r]*t[\t\n\r]*:/i;return t.test(e)}return false}}class j extends a.NodeFormatter{constructor(e={}){super({name:"spoiler",convert({node:e}){const t=e.getValue().trim();const r=i.Type.isStringFilled(t)?t:i.Loc.getMessage("HTML_FORMATTER_SPOILER_TITLE");return i.Dom.create({tag:"details",attrs:{className:"ui-typography-spoiler ui-icon-set__scope"},children:[i.Dom.create({tag:"summary",attrs:{className:"ui-typography-spoiler-title"},text:r})]})},before({node:e}){return u(e)},after({element:e}){const[t,...r]=e.children;e.appendChild(t);e.appendChild(i.Dom.create({tag:"div",attrs:{className:"ui-typography-spoiler-content"},dataset:{spoilerContent:"true"},children:[...r]}));return e},...e})}}class _ extends a.NodeFormatter{constructor(e){super({name:"user",convert({node:e,formatter:t}){var r;const n=t.getMentionSettings();if(i.Type.isStringFilled(n==null?void 0:(r=n.urlTemplate)==null?void 0:r.user)){const t=n.urlTemplate.user;const r=t.replaceAll("#ID#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"user",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"user",mentionId:e.getValue()}})},...e})}}class $ extends a.NodeFormatter{constructor(e={}){super({name:"department",convert({node:e,formatter:t}){var r;const n=t.getMentionSettings();if(i.Type.isStringFilled(n==null?void 0:(r=n.urlTemplate)==null?void 0:r.department)){const t=n.urlTemplate.department;const r=t.replaceAll("#ID#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"department",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"department",mentionId:e.getValue()}})},...e})}}class R extends a.NodeFormatter{constructor(e={}){super({name:"project",convert({node:e,formatter:t}){var r;const n=t.getMentionSettings();if(i.Type.isStringFilled(n==null?void 0:(r=n.urlTemplate)==null?void 0:r.project)){const t=n.urlTemplate.project;const r=t.replaceAll("#group_id#",e.getValue());return i.Dom.create({tag:"a",attrs:{href:r,className:"ui-typography-mention"},dataset:{mentionEntityId:"project",mentionId:e.getValue()}})}return i.Dom.create({tag:"span",attrs:{className:"ui-typography-mention"},dataset:{mentionEntityId:"project",mentionId:e.getValue()}})},...e})}}function X({src:e,width:t,height:r}){return i.Dom.create({tag:"span",attrs:{className:"ui-typography-image-container"},dataset:{decorator:true},children:[i.Dom.create({tag:"img",attrs:{src:e,className:"ui-typography-image",width:t,loading:"lazy"},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"},events:{error:e=>{const t=e.target;t.src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7";i.Dom.addClass(t.parentNode,"--error ui-icon-set__scope")}}})]})}function K(e){return/^(http:|https:|ftp:|\/)/i.test(e)}class z extends a.NodeFormatter{constructor(e={}){super({name:"img",convert({node:e}){const t=e.getContent().trim();let r=Number(e.getAttribute("width"));let n=Number(e.getAttribute("height"));r=i.Type.isNumber(r)&&r>0?Math.round(r):null;n=i.Type.isNumber(n)&&n>0?Math.round(n):null;if(K(t)){return X({src:t,width:r,height:n})}return document.createTextNode(e.toString())},...e})}}function W({url:e,width:t,height:r,type:n}){const o=i.Dom.create({tag:"video",attrs:{controls:true,className:"ui-typography-video-object",preload:"metadata",playsinline:true,src:e,width:t},dataset:{decorator:true},style:{aspectRatio:t>0&&r>0?`${t} / ${r}`:"auto"}});return i.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true},children:[o]})}const q=/[\u0000-\u0020\u00A0\u1680\u180E\u2000-\u2029\u205F\u3000]/g;const G=/^(?:(?:https?|ftps?|mailto):|[^a-z]|[+.a-z-]+(?:[^+.:a-z-]|$))/i;function J(e){if(!i.Type.isStringFilled(e)){return""}const t=e.replaceAll(q,"");return G.test(t)?t:""}function Q(e){return/^(http:|https:|\/)/i.test(e)}class Y extends a.NodeFormatter{constructor(e={}){super({name:"video",convert({node:e}){const t=J(e.getContent().trim());if(!Q(t)){return document.createTextNode(e.toString())}let r=Number(e.getAttribute("width"));let n=Number(e.getAttribute("height"));r=i.Type.isNumber(r)&&r>0?Math.round(r):560;n=i.Type.isNumber(n)&&n>0?Math.round(n):315;const a=/^https?:/.test(t)?t:`https://${t.replace(/^\/\//,"")}`;const s=new i.Uri(a);const l=o.VideoService.createByHost(s.getHost())!==null;if(l){const e=i.Dom.create({tag:"iframe",attrs:{src:t,className:"ui-typography-video-object",width:r,height:"auto",frameborder:0,allowfullscreen:true},style:{aspectRatio:`${r} / ${n}`}});return i.Dom.create({tag:"span",attrs:{className:"ui-typography-video-container"},dataset:{decorator:true},children:[e]})}return W({url:a,width:r,height:n})},...e})}}class Z extends a.NodeFormatter{constructor(e={}){const t=e.formatter;const r=t.getFileMode();super({name:r||"__unknown__",convert({node:e,data:t}){if(r===null){return e}const n=e.getAttribute("id");const o=()=>document.createTextNode(e.toString());if(!i.Type.isStringFilled(n)||r==="disk"&&!/^n?\d+$/i.test(n)||r==="file"&&!/^(\d+|[\da-f-]{36}\.[\da-f]{32,})$/i.test(n)){return o()}const a=t.files.find((e=>e.serverFileId.toString()===n.toString()));if(!a){return o()}if(a.isImage){let t=i.Text.toInteger(e.getAttribute("width"));let r=i.Text.toInteger(e.getAttribute("height"));t=i.Type.isNumber(t)&&t>0?Math.round(t):a.serverPreviewWidth;r=i.Type.isNumber(r)&&r>0?Math.round(r):a.serverPreviewHeight;return X({width:t,height:r,src:a.serverPreviewUrl})}if(a.isVideo){let t=Number(e.getAttribute("width"));let r=Number(e.getAttribute("height"));t=i.Type.isNumber(t)&&t>0?Math.round(t):600;r=i.Type.isNumber(r)&&r>0?Math.round(r):null;return W({url:a.downloadUrl,width:t,height:r})}return i.Dom.create({tag:"a",attrs:{href:a.downloadUrl,className:"ui-typography-link"},text:a.name||"unknown",dataset:{fileId:a.serverFileId,fileInfo:JSON.stringify(a)}})},...e})}}var ee=Object.freeze({RootNodeFormatter:g,TextNodeFormatter:y,TabNodeFormatter:N,LinebreakNodeFormatter:b,ParagraphNodeFormatter:C,BoldNodeFormatter:L,UnderlineNodeFormatter:A,ItalicNodeFormatter:S,StrikethroughNodeFormatter:B,TableNodeFormatter:w,TableHeadCellNodeFormatter:D,TableDataCellNodeFormatter:I,TableRowNodeFormatter:P,ListNodeFormatter:E,ListItemNodeFormatter:M,QuoteNodeFormatter:k,CodeNodeFormatter:O,LinkNodeFormatter:U,SpoilerNodeFormatter:j,UserNodeFormatter:_,DepartmentNodeFormatter:$,ProjectNodeFormatter:R,ImageNodeFormatter:z,VideoNodeFormatter:Y,FileNodeFormatter:Z});const te=i.Extension.getSettings("ui.bbcode.formatter.html-formatter");var re=babelHelpers.classPrivateFieldLooseKey("linkSettings");var ne=babelHelpers.classPrivateFieldLooseKey("mentionSettings");var oe=babelHelpers.classPrivateFieldLooseKey("fileMode");var ae=babelHelpers.classPrivateFieldLooseKey("containerMode");var se=babelHelpers.classPrivateFieldLooseKey("isVoidElement");class ie extends a.Formatter{constructor(e={}){super();Object.defineProperty(this,se,{value:le});Object.defineProperty(this,re,{writable:true,value:void 0});Object.defineProperty(this,ne,{writable:true,value:void 0});Object.defineProperty(this,oe,{writable:true,value:void 0});Object.defineProperty(this,ae,{writable:true,value:void 0});this.setLinkSettings({...te.linkSettings,...e.linkSettings});this.setMentionSettings({...te.mention,...e.mention});babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]=["file","disk"].includes(e.fileMode)?e.fileMode:null;const t=Object.values(ee).map((e=>new e({formatter:this})));this.setContainerMode(e.containerMode);this.setNodeFormatters(t);this.setNodeFormatters(e.formatters)}isShortLinkEnabled(){const{shortLink:e}=this.getLinkSettings();return i.Type.isPlainObject(e)&&e.enabled===true&&i.Type.isInteger(e.maxLength)}setLinkSettings(e){babelHelpers.classPrivateFieldLooseBase(this,re)[re]={...e}}getLinkSettings(){return babelHelpers.classPrivateFieldLooseBase(this,re)[re]}getFileMode(){return babelHelpers.classPrivateFieldLooseBase(this,oe)[oe]}setMentionSettings(e){babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]={...e}}getMentionSettings(){return babelHelpers.classPrivateFieldLooseBase(this,ne)[ne]}setContainerMode(e){babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]=e}getContainerMode(){return babelHelpers.classPrivateFieldLooseBase(this,ae)[ae]}isElement(e){if(e.nodeType===Node.DOCUMENT_FRAGMENT_NODE){return true}if(e.nodeType!==Node.ELEMENT_NODE||babelHelpers.classPrivateFieldLooseBase(this,se)[se](e)){return false}return i.Type.isUndefined(e.dataset.decorator)}getDefaultUnknownNodeCallback(e){return()=>new a.NodeFormatter({name:"unknown",before({node:e}){const t=e.getScheme();if(e.isVoid()){return t.createFragment({children:[t.createText(e.getOpeningTag())]})}return t.createFragment({children:[t.createText(e.getOpeningTag()),...e.getChildren(),t.createText(e.getClosingTag())]})},convert(){return document.createDocumentFragment()}})}}function le(e){return["img","br","hr","input"].includes(e.tagName.toLowerCase())}const ce={props:{bbcode:{type:String,required:false,default:""}},beforeCreate(){this.htmlFormatter=null},mounted(){this.format(this.bbcode)},unmounted(){this.htmlFormatter=null},watch:{bbcode(e){this.format(e)}},methods:{format(e){const t=this.getHtmlFormatter().format({source:e});const r=this.$refs.content;i.Dom.clean(r);r.appendChild(t)},getHtmlFormatter(){if(this.htmlFormatter!==null){return this.htmlFormatter}this.htmlFormatter=new ie;return this.htmlFormatter}},template:'<div class="ui-typography-container" ref="content"></div>'};e.HtmlFormatter=ie;e.HtmlFormatterComponent=ce})(this.BX.UI.BBCode.Formatter=this.BX.UI.BBCode.Formatter||{},BX.UI.Smiley,BX.UI.CodeParser,BX.UI.BBCode,BX.UI.VideoService,BX.UI.BBCode,window,BX);
//# sourceMappingURL=html-formatter.bundle.map.js