{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { Reflection, Dom, Tag, Type, Runtime, Text, Event} from 'main.core';\nimport { Util } from 'calendar.util';\nimport { EventEmitter } from 'main.core.events';\n\nclass NextEventList\n{\n\tDOM = {};\n\n\tconstructor(options = {})\n\t{\n\t\tthis.maxEntryAmount = options.maxEntryAmount || 5;\n\t\tif (options && options.entries)\n\t\t{\n\t\t\tthis.renderList(options.entries);\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.displayEventList();\n\t\t}\n\n\t\tthis.displayEventListDebounce = Runtime.debounce(this.displayEventList, 3000, this);\n\n\t\tEvent.bind(document, 'visibilitychange', this.checkDisplayEventList.bind(this));\n\t\tEventEmitter.subscribe('SidePanel.Slider:onCloseComplete', this.checkDisplayEventList.bind(this));\n\n\t\tEventEmitter.subscribe('onPullEvent-calendar', this.displayEventListDebounce);\n\t}\n\n\tcheckDisplayEventList()\n\t{\n\t\tif (this.needReload)\n\t\t{\n\t\t\tthis.displayEventListDebounce();\n\t\t}\n\t}\n\n\tdisplayEventList()\n\t{\n\t\tif (this.isDisplayingNow())\n\t\t{\n\t\t\tthis.showLoader();\n\t\t\tthis.getEventList()\n\t\t\t\t.then((entryList) => {\n\t\t\t\t\tthis.hideLoader();\n\t\t\t\t\tthis.renderList(entryList);\n\t\t\t\t});\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.needReload = true;\n\t\t}\n\t}\n\n\tgetEventList()\n\t{\n\t\treturn new Promise((resolve) => {\n\t\t\tBX.ajax.runAction('calendar.api.calendarentryajax.getnearestevents', {\n\t\t\t\tdata: {\n\t\t\t\t\townerId: this.ownerId,\n\t\t\t\t\ttype: this.type,\n\t\t\t\t\tfutureDaysAmount: 60,\n\t\t\t\t\tmaxEntryAmount: this.maxEntryAmount\n\t\t\t\t}\n\t\t\t})\n\t\t\t.then((response) => {\n\t\t\t\tresolve(response?.data?.entries);\n\t\t\t});\n\t\t});\n\t}\n\n\tshowWidget()\n\t{\n\t\tthis.getOuterWrap().style.display = '';\n\t}\n\n\thideWidget()\n\t{\n\t\tthis.getOuterWrap().style.display = 'none';\n\t}\n\n\tshowLoader()\n\t{\n\t\tthis.hideLoader();\n\t\tthis.DOM.loader = this.getEventListWrap()\n\t\t\t.appendChild(Util.getLoader(40, 'next-events-loader'));\n\t}\n\n\thideLoader()\n\t{\n\t\tif(Type.isDomNode(this.DOM.loader))\n\t\t{\n\t\t\tDom.remove(this.DOM.loader);\n\t\t}\n\t}\n\n\trenderList(entryList = [])\n\t{\n\t\tif (!Type.isArray(entryList))\n\t\t{\n\t\t\tentryList = [];\n\t\t}\n\n\t\tentryList = entryList.slice(0, this.maxEntryAmount);\n\n\t\tDom.clean(this.getEventListWrap());\n\n\t\tconst wrap = this.getEventListWrap();\n\t\tentryList.forEach((entry, i) => {\n\t\t\tif (i === 0)\n\t\t\t{\n\t\t\t\tthis.setReloadTimeout(entry);\n\t\t\t}\n\n\t\t\twrap.appendChild(this.renderEntry(entry));\n\t\t});\n\n\t\tif (entryList.length)\n\t\t{\n\t\t\tthis.showWidget();\n\t\t}\n\t\telse\n\t\t{\n\t\t\tthis.hideWidget();\n\t\t}\n\n\t\tthis.needReload = false;\n\t}\n\n\trenderEntry(entry)\n\t{\n\t\tconst fromDate = BX.Calendar.Util.parseDate(entry['DATE_FROM']);\n\n\t\treturn Tag.render`\n\t\t\t<a href=\"${Text.encode(entry['~URL'])}\" class=\"sidebar-widget-item\">\n\t\t\t\t<span class=\"calendar-item-date\">${entry['~FROM_TO_HTML']}</span>\n\t\t\t\t<span class=\"calendar-item-text\">\n\t\t\t\t\t<span class=\"calendar-item-link\">${Text.encode(entry['NAME'])}</span>\n\t\t\t\t</span>\n\t\t\t\t<span class=\"calendar-item-icon\">\n\t\t\t\t\t<span class=\"calendar-item-icon-day\">${Text.encode(entry['~WEEK_DAY'])}</span>\n\t\t\t\t\t<span class=\"calendar-item-icon-date\">${fromDate.getDate()}</span>\n\t\t\t\t</span>\n\t\t\t</a>\n\t\t`;\n\t}\n\n\tgetOuterWrap()\n\t{\n\t\tif (!this.DOM.outerWrap)\n\t\t{\n\t\t\tthis.DOM.outerWrap = document.querySelector('.sidebar-widget.sidebar-widget-calendar');\n\t\t}\n\t\treturn this.DOM.outerWrap;\n\t}\n\n\tgetEventListWrap()\n\t{\n\t\tif (!this.DOM.listWrap)\n\t\t{\n\t\t\tthis.DOM.listWrap = this.getOuterWrap().querySelector('.calendar-events-wrap');\n\t\t}\n\t\treturn this.DOM.listWrap;\n\t}\n\n\tsetReloadTimeout(entry)\n\t{\n\t\tif (this.reloadTimeout)\n\t\t{\n\t\t\tclearTimeout(this.reloadTimeout);\n\t\t\tthis.reloadTimeout = null;\n\t\t}\n\n\t\tconst finishEventDate = BX.Calendar.Util.parseDate(entry['DATE_TO']);\n\t\tif (Type.isDate(finishEventDate))\n\t\t{\n\t\t\tconst currentDate = new Date();\n\t\t\tconst offset = Math.min(\n\t\t\t\tMath.max(\n\t\t\t\t\tfinishEventDate.getTime() - currentDate.getTime() + 60000,\n\t\t\t\t\t60000),\n\t\t\t\t86400000\n\t\t\t);\n\n\t\t\tthis.reloadTimeout = setTimeout(this.displayEventList.bind(this), offset);\n\t\t}\n\t}\n\n\tisDisplayingNow()\n\t{\n\t\treturn !document.hidden && !BX.SidePanel.Instance.getOpenSliders().length;\n\t}\n}\n\nReflection.namespace('BX.Calendar').NextEventList = NextEventList;"],"names":["NextEventList","options","maxEntryAmount","entries","renderList","displayEventList","displayEventListDebounce","Runtime","debounce","Event","bind","document","checkDisplayEventList","EventEmitter","subscribe","needReload","isDisplayingNow","showLoader","getEventList","then","entryList","hideLoader","Promise","resolve","BX","ajax","runAction","data","ownerId","type","futureDaysAmount","response","getOuterWrap","style","display","DOM","loader","getEventListWrap","appendChild","Util","getLoader","Type","isDomNode","Dom","remove","isArray","slice","clean","wrap","forEach","entry","i","setReloadTimeout","renderEntry","length","showWidget","hideWidget","fromDate","Calendar","parseDate","Tag","render","Text","encode","getDate","outerWrap","querySelector","listWrap","reloadTimeout","clearTimeout","finishEventDate","isDate","currentDate","Date","offset","Math","min","max","getTime","setTimeout","hidden","SidePanel","Instance","getOpenSliders","Reflection","namespace"],"mappings":"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"}