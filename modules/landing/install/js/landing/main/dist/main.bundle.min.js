this.BX=this.BX||{};(function(e,n,t,o,a,i,r){"use strict";function s(e){return!!e&&!!e.querySelector(".block-wrapper")}function l(e){return!!e&&!!e.querySelector('button[data-id="insert_first_block"]')}function c(e,t){return new Promise(function(o){var a=function a(i){if(!t||i.animationName===t){o(i);n.Event.bind(e,"animationend",a)}};n.Event.bind(e,"animationend",a)})}function d(e){if(n.Type.isNil(e)){return true}if(n.Type.isArrayLike(e)){return!e.length}if(n.Type.isObject(e)){return Object.keys(e).length<=0}return true}function u(){var e=babelHelpers.taggedTemplateLiteral(["",""]);u=function n(){return e};return e}var k="ru";var f="by";var h="kz";var g="la";var B="de";var m="br";var b="ua";BX.Landing.getMode=function(){return"edit"};var v=function(e){babelHelpers.inherits(v,e);babelHelpers.createClass(v,null,[{key:"getMode",value:function e(){return"edit"}},{key:"createInstance",value:function e(n){var t=BX.Landing.PageObject.getRootWindow();t.BX.Landing.Main.instance=new BX.Landing.Main(n)}},{key:"getInstance",value:function e(){var n=BX.Landing.PageObject.getRootWindow();n.BX.Reflection.namespace("BX.Landing.Main");if(n.BX.Landing.Main.instance){return n.BX.Landing.Main.instance}n.BX.Landing.Main.instance=new v(-1);return n.BX.Landing.Main.instance}}]);function v(e){var o;babelHelpers.classCallCheck(this,v);o=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(v).call(this));o.setEventNamespace("BX.Landing.Main");var a=t.Env.getInstance().getOptions();o.id=e;o.options=Object.freeze(a);o.blocksPanel=null;o.currentBlock=null;o.loadedDeps={};o.cache=new n.Cache.MemoryCache;o.onSliderFormLoaded=o.onSliderFormLoaded.bind(babelHelpers.assertThisInitialized(o));o.onBlockDelete=o.onBlockDelete.bind(babelHelpers.assertThisInitialized(o));BX.addCustomEvent("Landing.Block:onAfterDelete",o.onBlockDelete);o.adjustEmptyAreas();if(o.options.blocks){if(!o.blocksPanel){o.blocksPanel=o.createBlocksPanel();o.onBlocksListCategoryChange(o.options.default_section);o.blocksPanel.layout.hidden=true;n.Dom.append(o.blocksPanel.layout,document.body)}o.blocksPanel.content.hidden=false}BX.Landing.UI.Panel.StatusPanel.setLastModified(a.lastModified);BX.Landing.UI.Panel.StatusPanel.getInstance().show();return o}babelHelpers.createClass(v,[{key:"hideBlocksPanel",value:function e(){if(this.blocksPanel){return this.blocksPanel.hide()}return Promise.resolve()}},{key:"getLayoutAreas",value:function e(){return this.cache.remember("layoutAreas",function(){return[].concat(babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-header")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-sidebar")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-main")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-footer")))})}},{key:"createInsertBlockButton",value:function e(n){var t=new BX.Landing.UI.Button.Plus("insert_first_block",{text:o.Loc.getMessage("ACTION_BUTTON_CREATE")});t.on("click",this.showBlocksPanel.bind(this,null,n,t));t.on("mouseover",this.onCreateButtonMouseover.bind(this,n,t));t.on("mouseout",this.onCreateButtonMouseout.bind(this,n,t));return t}},{key:"onCreateButtonMouseover",value:function e(t,a){if(n.Dom.hasClass(t,"landing-header")||n.Dom.hasClass(t,"landing-footer")){var i=this.getLayoutAreas();if(i.length>1){var r=o.Loc.getMessage("ACTION_BUTTON_CREATE");if(n.Dom.hasClass(t,"landing-main")){a.setText("".concat(r," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_MAIN")))}if(n.Dom.hasClass(t,"landing-header")){a.setText("".concat(r," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_HEADER")))}if(n.Dom.hasClass(t,"landing-sidebar")){a.setText("".concat(r," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_SIDEBAR")))}if(n.Dom.hasClass(t,"landing-footer")){a.setText("".concat(r," ").concat(o.Loc.getMessage("LANDING_ADD_BLOCK_TO_FOOTER")))}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout(function(){n.Dom.addClass(t,"landing-area-highlight");i.filter(function(e){return e!==t}).forEach(function(e){n.Dom.addClass(e,"landing-area-fade")})},400)}}}},{key:"onCreateButtonMouseout",value:function e(t,a){clearTimeout(this.fadeTimeout);if(n.Dom.hasClass(t,"landing-header")||n.Dom.hasClass(t,"landing-footer")){var i=this.getLayoutAreas();if(i.length>1){a.setText(o.Loc.getMessage("ACTION_BUTTON_CREATE"));i.forEach(function(e){n.Dom.removeClass(e,"landing-area-highlight");n.Dom.removeClass(e,"landing-area-fade")})}}}},{key:"initEmptyArea",value:function e(t){if(t){t.innerHTML="";n.Dom.append(this.createInsertBlockButton(t).layout,t);n.Dom.addClass(t,"landing-empty")}}},{key:"destroyEmptyArea",value:function e(t){if(t){var o=t.querySelector('button[data-id="insert_first_block"]');if(o){n.Dom.remove(o)}n.Dom.removeClass(t,"landing-empty")}}},{key:"adjustEmptyAreas",value:function e(){this.getLayoutAreas().filter(function(e){return s(e)&&l(e)}).forEach(this.destroyEmptyArea,this);this.getLayoutAreas().filter(function(e){return!s(e)&&!l(e)}).forEach(this.initEmptyArea,this);var t=document.body.querySelector("main.landing-edit-mode");var o=!this.getLayoutAreas().some(s);if(t){if(o){n.Dom.addClass(t,"landing-empty");return}n.Dom.removeClass(t,"landing-empty")}}},{key:"enableControls",value:function e(){n.Dom.removeClass(document.body,"landing-ui-hide-controls")}},{key:"disableControls",value:function e(){n.Dom.addClass(document.body,"landing-ui-hide-controls")}},{key:"isControlsEnabled",value:function e(){return!n.Dom.hasClass(document.body,"landing-ui-hide-controls")}},{key:"appendBlock",value:function e(t,o){var a=n.Tag.render(u(),t.content);a.id="block".concat(t.id);if(!o){n.Dom.addClass(a,"landing-ui-show");c(a,"showBlock").then(function(){n.Dom.removeClass(a,"landing-ui-show")})}this.insertToBlocksFlow(a);return a}},{key:"showBlocksPanel",value:function e(n,t,o){this.currentBlock=n;this.currentArea=t;this.blocksPanel.show();this.disableAddBlockButtons();if(!!t&&!!o){this.onCreateButtonMouseout(t,o)}}},{key:"disableAddBlockButtons",value:function e(){r.PageObject.getBlocks().forEach(function(e){var n=e.panels.get("create_action");if(n){var t=n.buttons.get("insert_after");if(t){t.disable()}}})}},{key:"enableAddBlockButtons",value:function e(){r.PageObject.getBlocks().forEach(function(e){var n=e.panels.get("create_action");if(n){var t=n.buttons.get("insert_after");if(t){t.enable()}}})}},{key:"createBlocksPanel",value:function e(){var n=this;var t=this.options.blocks;var i=Object.keys(t);var r=new a.Content("blocks_panel",{title:o.Loc.getMessage("LANDING_CONTENT_BLOCKS_TITLE"),className:"landing-ui-panel-block-list",scrollAnimation:true});r.subscribe("onCancel",function(){n.enableAddBlockButtons()});i.forEach(function(e){var o=!d(t[e].items);var a=e==="popular";var i=t[e].separator;if(o&&!a||i){r.appendSidebarButton(n.createBlockPanelSidebarButton(e,t[e]))}});r.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("feedback_button",{className:"landing-ui-button-sidebar-feedback",text:o.Loc.getMessage("LANDING_BLOCKS_LIST_FEEDBACK_BUTTON"),onClick:this.showFeedbackForm.bind(this)}));return r}},{key:"showSliderFeedbackForm",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!this.sliderFeedbackInited){this.sliderFeedbackInited=true;this.sliderFeedback=new a.Content("slider_feedback",{title:o.Loc.getMessage("LANDING_PANEL_FEEDBACK_TITLE"),className:"landing-ui-panel-feedback"});n.Dom.append(this.sliderFeedback.layout,document.body);this.sliderFormLoader=new BX.Loader({target:this.sliderFeedback.content});this.sliderFormLoader.show();this.initFeedbackForm()}i.bitrix24=this.options.server_name;i.siteId=this.options.site_id;i.siteUrl=this.options.url;i.siteTemplate=this.options.xml_id;i.productType=this.options.productType||"Undefined";i.typeproduct=function(){if(t.options.params.type==="GROUP"){return"KNOWLEDGE_GROUP"}return t.options.params.type}();var r=this.getFeedbackFormOptions();window.b24formFeedBack({id:r.id,lang:r.lang,sec:r.sec,type:"slider_inline",node:this.sliderFeedback.content,handlers:{load:this.onSliderFormLoaded.bind(this)},presets:n.Type.isPlainObject(i)?i:{}});this.sliderFeedback.show()}},{key:"getFeedbackFormOptions",value:function e(){var n=o.Loc.getMessage("LANGUAGE_ID");var t={id:"16",sec:"3h483y",lang:"en"};switch(n){case k:case f:case h:t={id:"8",sec:"x80yjw",lang:"ru"};break;case g:t={id:"14",sec:"wu561i",lang:"la"};break;case B:t={id:"10",sec:"eraz2q",lang:"de"};break;case m:t={id:"12",sec:"r6wvge",lang:"br"};break;case b:t={id:"18",sec:"d9e09o",lang:"ua"};break}return t}},{key:"onSliderFormLoaded",value:function e(){this.sliderFormLoader.hide()}},{key:"showFeedbackForm",value:function e(){this.showSliderFeedbackForm({target:"blocksList"})}},{key:"initFeedbackForm",value:function e(){(function(e,n,t,o){e.Bitrix24FormObject=o;e[o]=e[o]||function(){arguments[0].ref=t;(e[o].forms=e[o].forms||[]).push(arguments[0])};if(e[o].forms)return;var a=n.createElement("script");var i=1*new Date;a.async=1;a.src="".concat(t,"?").concat(i);var r=n.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r)})(window,document,"https://landing.bitrix24.ru/bitrix/js/crm/form_loader.js","b24formFeedBack")}},{key:"createBlockPanelSidebarButton",value:function e(n,t){return new BX.Landing.UI.Button.SidebarButton(n,{text:t.name,child:!t.separator,className:t.new?"landing-ui-new-section":"",onClick:this.onBlocksListCategoryChange.bind(this,n)})}},{key:"onBlocksListCategoryChange",value:function e(n){var t=this;this.blocksPanel.content.hidden=false;this.blocksPanel.sidebarButtons.forEach(function(e){var t=e.id===n?"add":"remove";e.layout.classList[t]("landing-ui-active")});this.blocksPanel.content.innerHTML="";if(n==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.options.blocks.last.items)}this.lastBlocks=babelHelpers.toConsumableArray(new Set(this.lastBlocks));this.lastBlocks.forEach(function(e){var n=t.getBlockFromRepository(e);t.blocksPanel.appendCard(t.createBlockCard(e,n))});return}Object.keys(this.options.blocks[n].items).forEach(function(e){var o=t.options.blocks[n].items[e];t.blocksPanel.appendCard(t.createBlockCard(e,o))});if(this.blocksPanel.content.scrollTop){requestAnimationFrame(function(){t.blocksPanel.content.scrollTop=0})}}},{key:"getBlockFromRepository",value:function e(n){var t=this.options.blocks;var o=Object.keys(t);var a=o.find(function(e){return n in t[e].items});if(a){return t[a].items[n]}}},{key:"onCopyBlock",value:function e(n){window.localStorage.landingBlockId=n.id;window.localStorage.landingBlockName=n.manifest.block.name;window.localStorage.landingBlockAction="copy";try{window.localStorage.requiredUserAction=JSON.stringify(n.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}}},{key:"onCutBlock",value:function e(t){window.localStorage.landingBlockId=t.id;window.localStorage.landingBlockName=t.manifest.block.name;window.localStorage.landingBlockAction="cut";try{window.localStorage.requiredUserAction=JSON.stringify(t.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}BX.Landing.PageObject.getBlocks().remove(t);n.Dom.remove(t.node);BX.onCustomEvent("Landing.Block:onAfterDelete",[t])}},{key:"onPasteBlock",value:function e(n){var t=this;if(window.localStorage.landingBlockId){var o="Landing::copyBlock";if(window.localStorage.landingBlockAction==="cut"){o="Landing::moveBlock"}var a={};a[o]={action:o,data:{lid:n.lid||BX.Landing.Main.getInstance().id,block:window.localStorage.landingBlockId,params:{AFTER_ID:n.id,RETURN_CONTENT:"Y"}}};BX.Landing.Backend.getInstance().batch(o,a,{action:o}).then(function(e){t.currentBlock=n;return t.addBlock(e[o].result.content)})}}},{key:"addBlock",value:function e(t,o,a){if(this.lastBlocks){this.lastBlocks.unshift(t.manifest.code)}var i=this;var r=this.appendBlock(t,a);return this.loadBlockDeps(t).then(function(e){if(!n.Type.isBoolean(o)||o===false){var a=null;var s=null;if(i.currentBlock){a=i.currentBlock.lid;s=i.currentBlock.id}if(i.currentArea){a=n.Dom.attr(i.currentArea,"data-landing");s=n.Dom.attr(i.currentArea,"data-site")}BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:e.id,selector:"#block".concat(e.id),command:"addBlock",undo:"",redo:{currentBlock:s,lid:a,code:e.manifest.code}}))}i.currentBlock=null;i.currentArea=null;var l=parseInt(t.id);var c=BX.Landing.PageObject.getBlocks().get(l);if(c){n.Dom.remove(c.node);BX.Landing.PageObject.getBlocks().remove(c)}void new BX.Landing.Block(r,{id:l,requiredUserAction:t.requiredUserAction,manifest:t.manifest,access:t.access,active:n.Text.toBoolean(t.active),anchor:t.anchor,dynamicParams:t.dynamicParams});return i.runBlockScripts(t).then(function(){return r})}).catch(function(e){console.warn(e)})}},{key:"onAddBlock",value:function e(t,o,a){var i=this;var r=n.Text.toNumber(o);this.hideBlocksPanel();return this.showBlockLoader().then(this.loadBlock(t,r)).then(function(e){return new Promise(function(n){setTimeout(function(){n(e)},500)})}).then(function(e){var n=i.addBlock(e,a);i.adjustEmptyAreas();void i.hideBlockLoader();i.enableAddBlockButtons();return n})}},{key:"insertToBlocksFlow",value:function e(t){var o=this.currentBlock&&this.currentBlock.node&&this.currentBlock.node.parentNode;if(o){n.Dom.insertAfter(t,this.currentBlock.node);return}n.Dom.prepend(t,this.currentArea)}},{key:"getBlockLoader",value:function e(){if(!this.blockLoader){this.blockLoader=new BX.Loader({size:60});this.blockLoaderContainer=n.Dom.create("div",{props:{className:"landing-block-loader-container"},children:[this.blockLoader.layout]})}return this.blockLoaderContainer}},{key:"showBlockLoader",value:function e(){this.insertToBlocksFlow(this.getBlockLoader());this.blockLoader.show();return Promise.resolve()}},{key:"hideBlockLoader",value:function e(){n.Dom.remove(this.getBlockLoader());this.blockLoader=null;return Promise.resolve()}},{key:"loadBlockDeps",value:function e(n){var t=this;var o=BX.processHTML(n.content_ext);if(BX.type.isArray(o.SCRIPT)){o.SCRIPT=o.SCRIPT.filter(function(e){return!e.isInternal})}var a=0;var i=n.js.length+o.SCRIPT.length+o.STYLE.length+n.css.length;var r=null;if(!this.loadedDeps[n.manifest.code]&&i>0){r=new Promise(function(e){function r(){a+=1;if(a===i){e(n)}}if(i>a){o.SCRIPT.forEach(function(e){if(!e.isInternal){BX.loadScript(e.JS,r)}});o.STYLE.forEach(function(e){BX.loadScript(e,r)});n.css.forEach(function(e){BX.loadScript(e,r)});n.js.forEach(function(e){BX.loadScript(e,r)})}else{r()}t.loadedDeps[n.manifest.code]=true})}else{r=Promise.resolve(n)}return r}},{key:"runBlockScripts",value:function e(n){return new Promise(function(e){var t=BX.processHTML(n.content).SCRIPT;if(t.length){BX.ajax.processScripts(t,undefined,function(){e(n)})}else{e(n)}})}},{key:"loadBlock",value:function e(t,o){var a=this;return function(){var e=a.id;var i=a.options.site_id;if(a.currentBlock){e=a.currentBlock.lid;i=a.currentBlock.siteId}if(a.currentArea){e=n.Dom.attr(a.currentArea,"data-landing");i=n.Dom.attr(a.currentArea,"data-site")}var r={lid:e,siteId:i};var s={ACTIVE:"Y",CODE:t,AFTER_ID:a.currentBlock?a.currentBlock.id:0,RETURN_CONTENT:"Y"};if(!o){r.fields=s;return BX.Landing.Backend.getInstance().action("Landing::addBlock",r,{code:t})}r={undeleete:{action:"Landing::markUndeletedBlock",data:{lid:e,block:o}},getContent:{action:"Block::getContent",data:{block:o,lid:e,fields:s,editMode:1}}};return BX.Landing.Backend.getInstance().batch("Landing::addBlock",r,{code:t}).then(function(e){e.getContent.result.id=o;return e.getContent.result})}}},{key:"createBlockCard",value:function e(n,t,o){return new BX.Landing.UI.Card.BlockPreviewCard({title:t.name,image:t.preview,code:n,mode:o,isNew:t.new===true,onClick:this.onAddBlock.bind(this,n)})}},{key:"onBlockDelete",value:function e(n){if(!n.parent.querySelector(".block-wrapper")){this.adjustEmptyAreas()}}},{key:"showOverlay",value:function e(){var t=document.querySelector("main.landing-edit-mode");if(t){n.Dom.addClass(t,"landing-ui-overlay")}}},{key:"hideOverlay",value:function e(){var t=document.querySelector("main.landing-edit-mode");if(t){n.Dom.removeClass(t,"landing-ui-overlay")}}},{key:"reloadSlider",value:function e(n){return i.SliderHacks.reloadSlider(n,window.parent)}}]);return v}(n.Event.EventEmitter);babelHelpers.defineProperty(v,"TYPE_PAGE","PAGE");babelHelpers.defineProperty(v,"TYPE_STORE","STORE");e.Main=v})(this.BX.Landing=this.BX.Landing||{},BX,BX.Landing,BX.Landing,BX.Landing.UI.Panel,BX.Landing,BX.Landing);
//# sourceMappingURL=main.bundle.map.js