this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};this.BX.Catalog.Store=this.BX.Catalog.Store||{};(function(e,t,i,r,n,a,s,o,l,u,d,c,h,g){"use strict";l=l&&l.hasOwnProperty("default")?l["default"]:l;var v;var f=function(){function e(t){babelHelpers.classCallCheck(this,e);this.editor=t}babelHelpers.createClass(e,[{key:"load",value:function e(t,i){if(!this.hintPopup){this.hintPopup=new r.Popup("ui-hint-popup-"+this.editor.getId(),null,{darkMode:true,closeIcon:true,animation:"fading-slide"})}this.hintPopup.setBindElement(t);this.hintPopup.adjustPosition();this.hintPopup.setContent(d.Tag.render(v||(v=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-hint-content'>","</div>\n\t\t"])),d.Text.encode(i)));return this.hintPopup}},{key:"show",value:function e(){if(this.hintPopup){this.hintPopup.show()}}},{key:"close",value:function e(){if(this.hintPopup){this.hintPopup.close()}}}]);return e}();function p(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function E(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?p(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):p(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function y(e,t,i){b(e,t);t.set(e,i)}function b(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var S=new WeakMap;var P=function(){function e(t){babelHelpers.classCallCheck(this,e);y(this,S,{writable:true,value:{basePrice:0,finalPrice:0,extra:null,extraType:e.EXTRA_TYPE_PERCENTAGE}});babelHelpers.classPrivateFieldSet(this,S,E(E({},babelHelpers.classPrivateFieldGet(this,S)),t))}babelHelpers.createClass(e,[{key:"getBasePrice",value:function e(){return babelHelpers.classPrivateFieldGet(this,S).basePrice}},{key:"getFinalPrice",value:function e(){return babelHelpers.classPrivateFieldGet(this,S).finalPrice}},{key:"getExtra",value:function e(){return babelHelpers.classPrivateFieldGet(this,S).extra}},{key:"getExtraType",value:function e(){return babelHelpers.classPrivateFieldGet(this,S).extraType}},{key:"calculateBasePrice",value:function t(i){babelHelpers.classPrivateFieldGet(this,S).basePrice=i;babelHelpers.classPrivateFieldGet(this,S).extra=d.Text.toNumber(babelHelpers.classPrivateFieldGet(this,S).extra);if(babelHelpers.classPrivateFieldGet(this,S).extraType===e.EXTRA_TYPE_MONETARY){babelHelpers.classPrivateFieldGet(this,S).finalPrice=babelHelpers.classPrivateFieldGet(this,S).basePrice+babelHelpers.classPrivateFieldGet(this,S).extra}else{babelHelpers.classPrivateFieldGet(this,S).finalPrice=babelHelpers.classPrivateFieldGet(this,S).basePrice*(1+babelHelpers.classPrivateFieldGet(this,S).extra/100)}return this}},{key:"calculateFinalPrice",value:function t(i){babelHelpers.classPrivateFieldGet(this,S).finalPrice=i;var r=d.Text.toNumber(babelHelpers.classPrivateFieldGet(this,S).basePrice);if(r<=0){babelHelpers.classPrivateFieldGet(this,S).extraType=e.EXTRA_TYPE_MONETARY}if(babelHelpers.classPrivateFieldGet(this,S).extraType===e.EXTRA_TYPE_MONETARY){babelHelpers.classPrivateFieldGet(this,S).extra=babelHelpers.classPrivateFieldGet(this,S).finalPrice-r}else{babelHelpers.classPrivateFieldGet(this,S).extra=(babelHelpers.classPrivateFieldGet(this,S).finalPrice/r-1)*100}return this}},{key:"calculateExtra",value:function e(t){babelHelpers.classPrivateFieldGet(this,S).extra=t;if(d.Type.isNil(t)){return this}return this.calculateBasePrice(babelHelpers.classPrivateFieldGet(this,S).basePrice)}},{key:"calculateExtraType",value:function t(i){if(i!==e.EXTRA_TYPE_MONETARY){i=e.EXTRA_TYPE_PERCENTAGE}babelHelpers.classPrivateFieldGet(this,S).extraType=i;return this.calculateFinalPrice(babelHelpers.classPrivateFieldGet(this,S).finalPrice)}}]);return e}();babelHelpers.defineProperty(P,"EXTRA_TYPE_PERCENTAGE",1);babelHelpers.defineProperty(P,"EXTRA_TYPE_MONETARY",2);var T;var m=function(){function e(t){babelHelpers.classCallCheck(this,e);this.text=t.text||d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_ACCESS_DENIED_TEXT");this.hint=t.hint;this.isReadOnly=t.isReadOnly===true}babelHelpers.createClass(e,[{key:"renderTo",value:function e(t){var i=this.isReadOnly?"ui-ctl-no-border catalog-document-product-list-access-denied-readonly":"ui-ctl-disabled catalog-document-product-list-access-denied";var r=d.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['\n\t\t<div\n\t\t\tclass="ui-ctl ui-ctl-w100 ui-ctl-before-icon ui-ctl-after-icon ','"\n\t\t\tdata-hint="','"\n\t\t\tdata-hint-no-icon\n\t\t>\n\t\t\t<div class="ui-ctl-before catalog-document-product-list-access-denied-lock"></div>\n\t\t\t<div class="ui-ctl-after catalog-document-product-list-access-denied-hint"></div>\n\t\t\t<div class="ui-ctl-element">',"</div>\n\t\t</div>\n\t\t"])),i,this.hint,this.text);t.innerHTML="";t.appendChild(r);BX.UI.Hint.createInstance({popupParameters:{angle:{offset:100}}}).init()}}]);return e}();var C,I,A;function R(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=_(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var r=0;var n=function e(){};return{s:n,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(s)throw o}}}}function _(e,t){if(!e)return;if(typeof e==="string")return F(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return F(e,t)}function F(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function k(e,t){O(e,t);t.add(e)}function O(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function N(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var D="EDIT";var w="SET";var M=new WeakSet;var H=new WeakSet;var B=new WeakSet;var U=new WeakSet;var L=new WeakSet;var G=new WeakSet;var x=new WeakSet;var V=new WeakSet;var X=new WeakSet;var W=new WeakSet;var q=new WeakSet;var j=new WeakSet;var Y=new WeakSet;var Q=new WeakSet;var K=new WeakSet;var z=new WeakSet;var $=new WeakSet;var Z=new WeakSet;var J=new WeakSet;var ee=new WeakSet;var te=new WeakSet;var ie=new WeakSet;var re=new WeakSet;var ne=new WeakSet;var ae=new WeakSet;var se=new WeakSet;var oe=function(){function e(t,i,r,n){babelHelpers.classCallCheck(this,e);k(this,se);k(this,ae);k(this,ne);k(this,re);k(this,ie);k(this,te);k(this,ee);k(this,J);k(this,Z);k(this,$);k(this,z);k(this,K);k(this,Q);k(this,Y);k(this,j);k(this,q);k(this,W);k(this,X);k(this,V);k(this,x);k(this,G);k(this,L);k(this,U);k(this,B);k(this,H);k(this,M);babelHelpers.defineProperty(this,"fields",{});babelHelpers.defineProperty(this,"storeSelectors",[]);babelHelpers.defineProperty(this,"externalActions",[]);babelHelpers.defineProperty(this,"cache",new d.Cache.MemoryCache);babelHelpers.defineProperty(this,"modeChanges",{EDIT:D,SET:w});babelHelpers.defineProperty(this,"validatingFields",new Map);this.setId(t);this.setSettings(r);this.setEditor(n);this.setModel(i,r);this.initFields(i);N(this,H,ue).call(this);N(this,U,ce).call(this);N(this,B,de).call(this);N(this,G,he).call(this,this.getSettingValue("storeHeaderMap",{}));N(this,M,le).call(this);N(this,ne,ke).call(this);requestAnimationFrame(this.initHandlers.bind(this))}babelHelpers.createClass(e,[{key:"getNode",value:function e(){var t=this;return this.cache.remember("node",(function(){var e=t.getField("ID",0);return t.getEditorContainer().querySelector('[data-id="'.concat(e,'"]'))}))}},{key:"getSelector",value:function e(){return this.mainSelector}},{key:"getBarcodeSelector",value:function e(){return this.barcodeSelector}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=d.Type.isPlainObject(t)?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"setEditor",value:function e(t){this.editor=t}},{key:"getEditor",value:function e(){return this.editor}},{key:"getEditorContainer",value:function e(){return this.getEditor().getContainer()}},{key:"getHintPopup",value:function e(){return this.getEditor().getHintPopup()}},{key:"initHandlers",value:function e(){var t=this.getEditor();this.getNode().querySelectorAll("input").forEach((function(e){d.Event.bind(e,"input",t.changeProductFieldHandler);d.Event.bind(e,"change",t.changeProductFieldHandler);d.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}));d.Event.bind(e,"blur",t.blurProductFieldHandler)}));this.getNode().querySelectorAll("select").forEach((function(e){d.Event.bind(e,"change",t.changeProductFieldHandler);d.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}},{key:"initHandlersForSelectors",value:function e(){var t=this;var i=this.getEditor();var r=["MAIN_INFO","BARCODE_INFO"];var n=this.getSettingValue("storeHeaderMap",{});r=[].concat(babelHelpers.toConsumableArray(r),babelHelpers.toConsumableArray(Object.keys(n)));r.forEach((function(e){t.getNode().querySelectorAll('[data-name="'.concat(e,'"] input[type="text"]')).forEach((function(e){d.Event.bind(e,"input",i.changeProductFieldHandler);d.Event.bind(e,"change",i.changeProductFieldHandler);d.Event.bind(e,"mousedown",(function(e){return e.stopPropagation()}))}))}))}},{key:"layoutBarcode",value:function e(){var t=this.getNode().querySelector('[data-name="BARCODE_INFO"]');if(this.barcodeSelector&&t){t.innerHTML="";if(N(this,ie,_e).call(this)){this.barcodeSelector.renderTo(t)}}}},{key:"layoutStoreSelector",value:function e(t){var i=this;Object.keys(t).forEach((function(e){var t="".concat(i.getId(),"_").concat(e);i.storeSelectors.forEach((function(r){if(r.getId()===t){var n=i.getNode().querySelector('[data-name="'.concat(e,'"]'));if(n){n.innerHTML="";if(N(i,te,Re).call(i)){r.renderTo(n)}}}}))}))}},{key:"setRowNumber",value:function e(t){this.getNode().querySelectorAll(".main-grid-row-number").forEach((function(e){e.textContent="".concat(t,".")}))}},{key:"getFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i;if(d.Type.isArrayFilled(t)){i={};var r=R(t),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;i[a]=this.getField(a)}}catch(e){r.e(e)}finally{r.f()}}else{i=d.Runtime.clone(this.fields)}var s=N(this,V,ve).call(this);for(var o in s){if(Object.hasOwnProperty.call(s,o)&&Object.hasOwnProperty.call(i,o)){i[o]=s[o]}}return i}},{key:"initFields",value:function e(t){this.getModel().initFields(t,false);this.setFields(t)}},{key:"setFields",value:function e(t){for(var i in t){if(t.hasOwnProperty(i)){this.setField(i,t[i])}}}},{key:"getField",value:function e(t,i){if(t!=="REAL_VALUES"){var r=N(this,V,ve).call(this);if(r&&Object.hasOwnProperty.call(r,t)){return r[t]}}return this.fields.hasOwnProperty(t)?this.fields[t]:i}},{key:"setField",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:true;this.fields[t]=i;if(r){this.getModel().setField(t,i)}}},{key:"getUiFieldId",value:function e(t){return"".concat(this.getId(),"_").concat(t)}},{key:"getBasePrice",value:function e(){return this.getField("BASE_PRICE",0)}},{key:"getAmount",value:function e(){return this.getField("AMOUNT",1)}},{key:"isPriceNetto",value:function e(){return this.getEditor().isTaxAllowed()&&!this.isTaxIncluded()}},{key:"getPrice",value:function e(){return this.getField("PRICE",0)}},{key:"getPriceExclusive",value:function e(){return this.getField("PRICE_EXCLUSIVE",0)}},{key:"getPriceNetto",value:function e(){return this.getField("PRICE_NETTO",0)}},{key:"getPriceBrutto",value:function e(){return this.getField("PRICE_BRUTTO",0)}},{key:"getQuantity",value:function e(){return this.getField("QUANTITY",0)}},{key:"getTaxIncluded",value:function e(){return this.getField("TAX_INCLUDED","N")}},{key:"isTaxIncluded",value:function e(){return this.getTaxIncluded()==="Y"}},{key:"getTaxRate",value:function e(){return this.getField("TAX_RATE",0)}},{key:"getVatRate",value:function e(){return this.getField("TAX_RATE",0)/100}},{key:"getTaxSum",value:function e(){return this.isTaxIncluded()?this.getPrice()*this.getQuantity()*(1-1/(1+this.getVatRate())):this.getPriceExclusive()*this.getQuantity()*this.getVatRate()}},{key:"updateFieldByEvent",value:function e(t,i){var r=i.target;var n=r.type==="checkbox"?r.checked:r.value;var a=i.type==="input"||i.type==="change"?D:w;this.updateField(t,n,a)}},{key:"updateDropdownField",value:function e(t,i){this.updateField(t,i,D)}},{key:"updateField",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:w;this.resetExternalActions();this.updateFieldValue(t,i,r);this.executeExternalActions()}},{key:"updateFieldValue",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:w;switch(t){case"SKU_ID":this.changeProductId(i);break;case"BASE_PRICE":this.changeBasePrice(i,r);break;case"PURCHASING_PRICE":this.changePurchasingPrice(i,r);break;case"AMOUNT":this.changeAmount(i,r);break;case"MEASURE_CODE":this.changeMeasureCode(i,r);break;case"BARCODE":this.changeBarcode(i,r);break;case"STORE_FROM":case"STORE_TO":this.changeStore(i,t);break;case"STORE_FROM_TITLE":case"STORE_TO_TITLE":this.changeStoreName(i,t);break;case"NAME":case"MAIN_INFO":this.changeProductName(i,r);break;case"SORT":this.changeSort(i,r);break;case"COMMENT":this.changeComment(i,r);break;case"TAX_RATE_FORMATTED":case"TAX_INCLUDED_FORMATTED":this.updateUiField(t,i);break}}},{key:"updateFieldByName",value:function e(t,i){switch(t){case"TAX_INCLUDED":this.setTaxIncluded(i);break}}},{key:"changeProductId",value:function e(t){var i=this.parseInt(t);this.setProductId(i)}},{key:"handleCopyAction",value:function e(t,i){var r;(r=this.getEditor())===null||r===void 0?void 0:r.copyRow(this);var n=i.getMenuWindow();if(n){n.destroy()}}},{key:"handleDeleteAction",value:function e(t,i){var r;(r=this.getEditor())===null||r===void 0?void 0:r.deleteRow(this);var n=i.getMenuWindow();if(n){n.destroy()}this.unsubscribeEvents();N(this,j,ye).call(this)}},{key:"unsubscribeEvents",value:function e(){this.getBarcodeSelector().unsubscribeEvents()}},{key:"handleSelectExtraPriceType",value:function e(t,i){this.changeExtraType(i.type,D);var r=i.getMenuWindow();if(r){r.destroy()}}},{key:"changeExtraType",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;var r="%";if(t===P.EXTRA_TYPE_MONETARY){r=this.getEditor().getCurrencyText()}else{t=P.EXTRA_TYPE_PERCENTAGE}if(t===this.getField("BASE_PRICE_EXTRA_RATE")){return}if(i===D){var n=N(this,X,fe).call(this).calculateExtraType(t);this.changeExtra(n.getExtra());this.changeBasePrice(n.getFinalPrice())}var a=this.getNode().querySelector('[data-name="BASE_PRICE_EXTRA_RATE"]');if(d.Type.isDomNode(a)){a.innerHTML=r}this.setField("BASE_PRICE_EXTRA_RATE",t)}},{key:"changeExtra",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;var r=d.Type.isNil(t)||t===""?null:this.parseFloat(t,this.getPricePrecision());this.setField("BASE_PRICE_EXTRA",r);if(r===null){return}if(i===D){var n=N(this,X,fe).call(this).calculateExtra(r);this.changeBasePrice(n.getFinalPrice())}else{var a=this.getNode().querySelector('[data-name="BASE_PRICE_EXTRA"]');if(d.Type.isDomNode(a)){a.value=r}}}},{key:"changeBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;var r=this.parseFloat(t,this.getPricePrecision());this.setBasePrice(r,i)}},{key:"changePurchasingPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;if(N(this,ae,Oe).call(this)){return}var r=this.parseFloat(t,this.getPricePrecision());this.setPurchasingPrice(r,i)}},{key:"changeAmount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;var r=this.parseFloat(t,this.getQuantityPrecision());this.setAmount(r,i)}},{key:"changeMeasureCode",value:function e(t){var i=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;this.getEditor().getMeasures().filter((function(e){return e.CODE===t})).forEach((function(e){return i.setMeasure(e,r)}))}},{key:"changeBarcode",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;var r=t.toString();var n=this.getField("BARCODE")!==r;if(n&&i===w){this.setField("BARCODE",r);this.setField("DOC_BARCODE",r);this.addActionProductChange()}else if(i===D){this.setField("DOC_BARCODE",r);this.addActionProductChange()}}},{key:"changeStore",value:function e(t,i){var r=d.Text.toNumber(t);var n=this.getField(i)!==r;if(n){this.setField(i,r);this.setStoreAmount(t,i);this.layoutStoreSelector(this.getSettingValue("storeHeaderMap",{}));this.addActionProductChange();if(this.getEditor().getSettingValue("isCalculableStorePurchasingPrice")){this.debouncedPurchasingPriceCalculation()}}}},{key:"changeStoreName",value:function e(t,i){var r=t.toString();this.setField(i,r);this.addActionProductChange()}},{key:"changeProductName",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;var r=t.toString();var n=this.getField("NAME")!==r;if(n&&i===w){this.setField("NAME",r);this.addActionProductChange()}}},{key:"changeSort",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;var r=this.parseInt(t);if(i===w){this.setField("SORT",r)}var n=this.getField("SORT")!==r;if(n){this.addActionProductChange()}}},{key:"changeComment",value:function e(t){var i=d.Type.isNil(t)?"":t.toString().trim();if(i!==this.getField("COMMENT")){this.setField("COMMENT",i);this.addActionProductChange()}}},{key:"refreshFieldsLayout",value:function e(){var t,i,r;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];for(var a in this.fields){if(this.fields.hasOwnProperty(a)&&!n.includes(a)){this.updateUiField(a,this.fields[a])}}this.updateUiMeasure(this.getField("MEASURE_CODE"),this.getField("MEASURE_NAME"));(t=this.getSelector())===null||t===void 0?void 0:t.reloadFileInput();(i=this.getSelector())===null||i===void 0?void 0:i.layout();(r=this.getBarcodeSelector())===null||r===void 0?void 0:r.layout();this.updateUiStoreValues()}},{key:"setModel",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};var i="catalog_document_grid_".concat(this.getId());if(i){var r=u.ProductModel.getById(i);if(r){this.model=r}}if(!(this.model instanceof u.ProductModel)){this.model=new u.ProductModel({id:i,currency:this.getEditor().getCurrencyId(),iblockId:t.IBLOCK_ID,basePriceId:t.BASE_PRICE_ID,skuTree:d.Type.isStringFilled(t.SKU_TREE)?JSON.parse(t.SKU_TREE):null,storeMap:t.STORE_AMOUNT_MAP,fields:t});if(d.Type.isObject(t.IMAGE_INFO)){this.model.getImageCollection().setPreview(t.IMAGE_INFO.preview);this.model.getImageCollection().setEditInput(t.IMAGE_INFO.input);this.model.getImageCollection().setMorePhotoValues(t.IMAGE_INFO.values)}if(!d.Type.isNil(t.DETAIL_URL)){this.model.setDetailPath(t.DETAIL_URL)}}n.EventEmitter.subscribe(this.model,"onErrorsChange",d.Runtime.debounce(N(this,j,ye),500,this));n.EventEmitter.subscribe(this.model,"onChangeStoreData",this.updateUiStoreValues.bind(this))}},{key:"getModel",value:function e(){return this.model}},{key:"setProductId",value:function e(t){var i=this.getField("PRODUCT_ID")!==t;if(i){this.setField("PRODUCT_ID",t);this.setField("SKU_ID",t);this.updateUiStoreValues();this.addActionProductChange();this.addActionUpdateTotal();N(this,se,Ne).call(this)}}},{key:"setBasePrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;t=Math.max(t,0);if(i===w){this.updateUiField("BASE_PRICE",t.toFixed(this.getPricePrecision()))}this.setField("BASE_PRICE",t);this.addActionProductChange();this.addActionUpdateTotal();var r=N(this,W,pe).call(this).calculateBasePrice(t);this.setFields(r);this.updateRowTotalPrice()}},{key:"updateRowTotalPrice",value:function e(){var t=this.getEditor().getSettingValue("totalCalculationSumField","PURCHASING_PRICE");var i=this.getAmount()*this.getField(t,0);i=Math.max(i,0);this.setField("TOTAL_PRICE",i);this.updateUiField("TOTAL_PRICE",i.toFixed(this.getPricePrecision()))}},{key:"updateProductStoreValues",value:function e(){var t=this;this.storeSelectors.forEach((function(e){e.setProductId(t.getModel().getSkuId())}))}},{key:"updateUiStoreValues",value:function e(){var t=this;var i=this.getSettingValue("storeHeaderMap",{});Object.keys(i).forEach((function(e){var r=i[e];var n=t.getField(r);if(r==="STORE_FROM"){var a=t.model.getStoreCollection().getStoreAmount(n);if(a<=0){var s=t.model.getStoreCollection().getMaxFilledStore();var l=o.StoreSelector.getById("".concat(t.getId(),"_").concat(e));if(s.AMOUNT>a&&l){l.onStoreSelect(s.STORE_ID,s.STORE_TITLE);n=s.STORE_ID}}}t.setStoreAmount(n,r)}));this.layoutStoreSelector(this.getSettingValue("storeHeaderMap",{}))}},{key:"setStoreAmount",value:function e(t,i){var r=this;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:w;if(!this.model.getStoreCollection().isInited()){return}if(n===w){var a;var s={_AMOUNT:function e(){return r.model.getStoreCollection().getStoreAmount(t)},_RESERVED:function e(){return r.model.getStoreCollection().getStoreReserved(t)},_AVAILABLE_AMOUNT:function e(){return r.model.getStoreCollection().getStoreAvailableAmount(t)}};for(var o in s){if(Object.hasOwnProperty.call(s,o)){var l=N(this,ee,Ae).call(this,i+o);if(l){l.innerHTML="";if(N(this,te,Re).call(this)){a=s[o]()||0;var u="".concat(a," ").concat(d.Text.encode(this.getField("MEASURE_NAME")));var c=u;if(o==="_AVAILABLE_AMOUNT"){c=a>0?u:'<span class="text--danger">'.concat(u,"</span>")}l.innerHTML=c}}}}}}},{key:"setPurchasingPrice",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;if(N(this,ae,Oe).call(this)){return}t=Math.max(t,0);if(i===w){this.updateUiField("PURCHASING_PRICE",t.toFixed(this.getPricePrecision()))}this.setField("PURCHASING_PRICE",t);this.addActionProductChange();this.addActionUpdateTotal();this.updateRowTotalPrice()}},{key:"setAmount",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;if(i===w){this.updateUiInputField("AMOUNT",t)}var r=this.getField("AMOUNT")!==t;if(r){this.setField("AMOUNT",t);this.addActionProductChange();this.addActionUpdateTotal();var n=N(this,W,pe).call(this).calculateQuantity(t);this.setFields(n);this.updateRowTotalPrice();if(this.getEditor().getSettingValue("isCalculableStorePurchasingPrice")){this.debouncedPurchasingPriceCalculation()}}}},{key:"calculateStoreCostPrice",value:function e(){var t=this;if(this.isEmptyRow()){return}d.ajax.runComponentAction(this.editor.getComponentName(),"calculateStoreCostPrice",{mode:"class",signedParameters:this.editor.getSignedParameters(),data:{productId:this.getField("SKU_ID"),quantity:this.getField("AMOUNT"),storeId:this.getField("STORE_FROM"),currency:this.editor.getCurrencyId()}}).then((function(e){t.setPurchasingPrice(e.data)}))}},{key:"setMeasure",value:function e(t){var i=this;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:w;if(this.model.isEmpty()){this.setField("MEASURE_CODE",t.CODE);this.setField("MEASURE_NAME",t.SYMBOL);this.updateUiMeasure(t.CODE,t.SYMBOL);return}if(r===D){this.getModel().showSaveNotifier("measureChanger_".concat(this.getId()),{title:d.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_MEASURE_CHANGED_QUERY"),declineCancelTitle:d.Loc.getMessage("CATALOG_PRODUCT_MODEL_SAVING_NOTIFICATION_DECLINE_SAVE"),events:{onSave:function e(){i.setField("MEASURE_CODE",t.CODE);i.setField("MEASURE_NAME",t.SYMBOL);i.updateUiMeasure(i.getField("MEASURE_CODE"),i.getField("MEASURE_NAME"));i.getModel().save(["MEASURE_CODE","MEASURE_NAME"])},onCancel:function e(){i.updateUiMeasure(i.getField("MEASURE_CODE"),i.getField("MEASURE_NAME"))}}})}else{this.updateUiMeasure(t.CODE,t.SYMBOL)}this.addActionProductChange()}},{key:"getInputByFieldName",value:function e(t){var i=this.getUiFieldId(t);var r=document.getElementById(i);if(!d.Type.isElementNode(r)){r=this.getNode().querySelector('[name="'.concat(i,'"]'))}return r}},{key:"getInputWrapperByFieldName",value:function e(t){var i=this.getInputByFieldName(t);if(d.Type.isElementNode(i)){return d.Type.isElementNode(i.parentNode)?i.parentNode:i}return undefined}},{key:"updateUiInputField",value:function e(t,i){var r=this.getInputByFieldName(t);if(d.Type.isElementNode(r)){r.value=i}}},{key:"updateUiCheckboxField",value:function e(t,i){var r=this.getInputByFieldName(t);if(d.Type.isElementNode(r)){r.checked=i==="Y"}}},{key:"getMoneyFieldDropdownApi",value:function e(t){if(!d.Reflection.getClass("BX.Main.dropdownManager")){return null}return BX.Main.dropdownManager.getById("".concat(this.getId(),"_").concat(t,"_control"))}},{key:"updateMoneyFieldUiWithDropdownApi",value:function e(t,i){if(t.getValue()===i){return}if(t.menu){t.menu.destroy()}var r=t.menu.itemsContainer.querySelector('[data-value="'.concat(i,'"]'));var n=r&&t.getMenuItem(r);if(n){t.refresh(n);t.selectItem(n)}}},{key:"updateUiMoneyField",value:function e(t,i,r){var n=this.getInputByFieldName(t);if(!d.Type.isElementNode(n)){return}n.dataset.value=i;var a=n.querySelector("span.main-dropdown-inner");if(!d.Type.isElementNode(a)){return}a.innerHTML=r}},{key:"updateUiMeasure",value:function e(t,i){this.updateUiMoneyField("MEASURE_CODE",t,d.Text.encode(i));this.updateUiStoreValues()}},{key:"updateUiHtmlField",value:function e(t,i){var r=this.getNode().querySelector('[data-name="'.concat(t,'"]'));if(d.Type.isElementNode(r)){r.innerHTML=i}}},{key:"updateUiCurrencyFields",value:function e(){var t=this;var i=this.getEditor().getCurrencyText();var r="".concat(this.getEditor().getCurrencyId());var n=["BASE_PRICE_CURRENCY","PURCHASING_PRICE_CURRENCY"];n.forEach((function(e){var n=[];n.push({NAME:i,VALUE:r});d.Dom.attr(t.getInputByFieldName(e),"data-items",n);t.updateUiMoneyField(e,r,i)}))}},{key:"updateUiField",value:function e(t,i){var r=this.getUiFieldName(t);if(!r){return}var n=this.getUiFieldType(t);if(!n){return}switch(n){case"input":this.updateUiInputField(r,i);break;case"money":i=BX.util.number_format(i,this.getPricePrecision(),".","");this.updateUiInputField(r,i);break;case"money_html":i=a.CurrencyCore.currencyFormat(i,this.getEditor().getCurrencyId(),true);this.updateUiHtmlField(r,i);break;case"tax":this.updateUiHtmlField(r,i);break}}},{key:"getUiFieldName",value:function e(t){var i=null;switch(t){case"AMOUNT":case"MEASURE_CODE":case"BASE_PRICE":case"PURCHASING_PRICE":case"TOTAL_PRICE":i=t;break;case"TAX_RATE_FORMATTED":i="TAX_RATE";break;case"TAX_INCLUDED_FORMATTED":i="TAX_INCLUDED";break}return i}},{key:"getUiFieldType",value:function e(t){var i=["BASE_PRICE","PURCHASING_PRICE","TOTAL_PRICE"];if(i.includes(t)){var r,n;var a=(r=this.getEditor())===null||r===void 0?void 0:r.getColumnInfo(t);if((a===null||a===void 0?void 0:(n=a.editable)===null||n===void 0?void 0:n.TYPE)==="MONEY"){return"money"}return"money_html"}if(t==="AMOUNT"){return"input"}var s=["TAX_RATE_FORMATTED","TAX_INCLUDED_FORMATTED"];if(s.includes(t)){return"tax"}return null}},{key:"parseInt",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;return this.getEditor().parseInt(t,i)}},{key:"parseFloat",value:function e(t,i){var r=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;return this.getEditor().parseFloat(t,i,r)}},{key:"getPricePrecision",value:function e(){return this.getEditor().getPricePrecision()}},{key:"getQuantityPrecision",value:function e(){return this.getEditor().getQuantityPrecision()}},{key:"getCommonPrecision",value:function e(){return this.getEditor().getCommonPrecision()}},{key:"resetExternalActions",value:function e(){this.externalActions.length=0}},{key:"addExternalAction",value:function e(t){this.externalActions.push(t)}},{key:"addActionProductChange",value:function e(){this.addExternalAction({type:this.getEditor().actions.productChange,id:this.getId()})}},{key:"addActionUpdateTotal",value:function e(){this.addExternalAction({type:this.getEditor().actions.updateTotal})}},{key:"executeExternalActions",value:function e(){if(this.externalActions.length===0){return}this.getEditor().executeActions(this.externalActions);this.resetExternalActions()}},{key:"isEmptyRow",value:function e(){return!d.Type.isStringFilled(this.getField("NAME","").trim())&&this.model.isEmpty()&&this.getBasePrice()<=0}},{key:"validate",value:function e(){var t=[];if(!N(this,J,Ie).call(this,this.getAmount())){N(this,Z,Ce).call(this,"AMOUNT",N(this,J,Ie));t.push(d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_INVALID_AMOUNT_2"))}return t}}]);return e}();function le(){var e=this;if(this.getEditor().isReadOnly()||this.getField("EDITABLE")===false){return}this.debouncedPurchasingPriceCalculation=d.Runtime.debounce(this.calculateStoreCostPrice,500,this);var t=this.getNode().querySelector(".main-grid-cell-action .main-grid-cell-content");if(d.Type.isDomNode(t)){var i=d.Tag.render(C||(C=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="#"\n\t\t\t\t\tclass="main-grid-row-action-button"\n\t\t\t\t></a>\n\t\t\t'])));d.Event.bind(i,"click",(function(t){var n=[{text:d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_COPY_ACTION"),onclick:e.handleCopyAction.bind(e)},{text:d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_DELETE_ACTION"),onclick:e.handleDeleteAction.bind(e)}];r.PopupMenu.show({id:"".concat(e.getId(),"_actions_popup"),bindElement:i,items:n});t.preventDefault();t.stopPropagation()}));d.Dom.append(i,t)}}function ue(){var e={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:this.getSettingValue("isAllowedCreationProduct",true),ENABLE_IMAGE_INPUT:true,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:true,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:true,ENABLE_EMPTY_PRODUCT_ERROR:true,RESTRICTED_PRODUCT_TYPES:this.getEditor().getRestrictedProductTypes(),URL_BUILDER_CONTEXT:this.editor.getSettingValue("productUrlBuilderContext")},mode:s.ProductSelector.MODE_EDIT};this.mainSelector=new s.ProductSelector("catalog_document_grid_".concat(this.getId()),e);var t=this.getNode().querySelector('[data-name="MAIN_INFO"]');if(t){var i=t.querySelector(".main-grid-row-number");if(!d.Type.isDomNode(i)){d.Dom.append(d.Tag.render(I||(I=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-number"></div>']))),t)}var r=t.querySelector(".main-grid-row-product-selector");if(!d.Type.isDomNode(r)){r=d.Tag.render(A||(A=babelHelpers.taggedTemplateLiteral(['<div class="main-grid-row-product-selector"></div>'])));d.Dom.append(r,t)}this.mainSelector.renderTo(r)}n.EventEmitter.subscribe(this.mainSelector,"onBeforeCreate",N(this,Y,be).bind(this))}function de(){var e=["COMMENT"];for(var t=0,i=e;t<i.length;t++){var r=i[t];var n=this.getNode().querySelector('[name="'.concat(r,'"]'));if(n){var a=this.getField(r);n.value=d.Type.isNil(a)?"":a}}}function ce(){var e={iblockId:this.model.getIblockId(),basePriceId:this.model.getBasePriceId(),currency:this.model.getCurrency(),model:this.model,inputFieldName:"BARCODE",type:s.ProductSelector.INPUT_FIELD_BARCODE,config:{ENABLE_SEARCH:true,IS_ALLOWED_CREATION_PRODUCT:this.getSettingValue("isAllowedCreationProduct",true),ENABLE_INFO_SPOTLIGHT:this.editor.getSettingValue("showBarcodeSpotlightInfo",true),ENABLE_BARCODE_QR_AUTH:this.editor.getSettingValue("showBarcodeQrAuth",true),IS_INSTALLED_MOBILE_APP:this.editor.getSettingValue("isInstalledMobileApp",null),ENABLE_IMAGE_INPUT:false,ROLLBACK_INPUT_AFTER_CANCEL:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:this.getId(),ENABLE_SKU_SELECTION:false,ENABLE_SKU_TREE:false,ENABLE_EMPTY_PRODUCT_ERROR:false,RESTRICTED_PRODUCT_TYPES:this.getEditor().getRestrictedProductTypes()},mode:s.ProductSelector.MODE_EDIT,scannerToken:this.getEditor().scannerToken};this.barcodeSelector=new s.ProductSelector("catalog_document_grid_".concat(this.getId(),"_barcode"),e);n.EventEmitter.subscribe(this.barcodeSelector,"onBeforeCreate",N(this,Y,be).bind(this));n.EventEmitter.subscribe(this.barcodeSelector,"onSpotlightClose",N(this,Q,Se).bind(this));n.EventEmitter.subscribe(this.barcodeSelector,"onBarcodeQrClose",N(this,K,Pe).bind(this));n.EventEmitter.subscribe(this.barcodeSelector,"onBarcodeScannerInstallChecked",N(this,z,Te).bind(this));n.EventEmitter.subscribe(this.barcodeSelector,"onBarcodeChange",N(this,$,me).bind(this));this.layoutBarcode()}function he(e){var t=this;Object.keys(e).forEach((function(i){var r={inputFieldId:e[i],inputFieldTitle:"".concat(e[i],"_TITLE"),isDisabledEmpty:true,config:{ENABLE_SEARCH:true,ENABLE_INPUT_DETAIL_LINK:false,ROW_ID:t.getId()},mode:o.StoreSelector.MODE_EDIT,model:t.model};var a=new o.StoreSelector("".concat(t.getId(),"_").concat(i),r);n.EventEmitter.subscribe(a,"onChange",d.Runtime.debounce(N(t,x,ge).bind(t),500,t));n.EventEmitter.subscribe(a,"onClear",d.Runtime.debounce(N(t,x,ge).bind(t),500,t));t.storeSelectors.push(a)}));this.layoutStoreSelector(e)}function ge(e){var t=this;var i=e.getData();i.fields.forEach((function(e){t.updateField(e.NAME,e.VALUE)}))}function ve(){if(this.realValues){return this.realValues}try{var e=this.getField("REAL_VALUES");if(e){var t=JSON.parse(atob(e));if(d.Type.isPlainObject(t)){this.realValues=t}}}catch(e){console.error("Cannot parse REAL_VALUE: ".concat(e.getMessage()))}return this.realValues}function fe(){var e=d.Type.isNumber(this.getModel().getField("BASE_PRICE_EXTRA"))?this.getModel().getField("BASE_PRICE_EXTRA"):null;return new P({basePrice:d.Text.toNumber(this.getModel().getField("PURCHASING_PRICE")),finalPrice:d.Text.toNumber(this.getModel().getField("BASE_PRICE")),extra:e,extraType:d.Text.toNumber(this.getModel().getField("BASE_PRICE_EXTRA_RATE"))})}function pe(){return this.getModel().getCalculator().setFields(N(this,q,Ee).call(this)).setSettings(this.getEditor().getSettings())}function Ee(){return{PRICE:this.getPrice(),BASE_PRICE:this.getBasePrice(),PRICE_EXCLUSIVE:this.getPriceExclusive(),PRICE_NETTO:this.getPriceNetto(),PRICE_BRUTTO:this.getPriceBrutto(),QUANTITY:this.getQuantity(),TAX_INCLUDED:this.getTaxIncluded(),TAX_RATE:this.getTaxRate()}}function ye(){var e=this.getModel().getErrorCollection().getErrors();for(var t in e){if(t===s.ProductSelector.ErrorCodes.NOT_SELECTED_PRODUCT||t===o.StoreSelector.ErrorCodes.NOT_SELECTED_STORE){this.getSelector().layoutErrors()}}this.getEditor().handleProductErrorsChange()}function be(e){var t=e.getData(),i=t.model;i.setField("BARCODE",this.barcodeSelector.getNameInputFilledValue());i.setField("NAME",this.mainSelector.getNameInputFilledValue())}function Se(e){this.editor.closeBarcodeSpotlights()}function Pe(e){this.editor.closeBarcodeQrAuths()}function Te(e){this.editor.enableSendBarcodeMobilePush()}function me(e){var t=e.getData(),i=t.value;this.changeBarcode(i,D)}function Ce(e,t){var i=this;var r=this.getInputByFieldName(e);var n=this.getInputWrapperByFieldName(e);if(t(r.valueAsNumber)||this.validatingFields.get(e)){return}this.validatingFields.set(e,true);n.classList.add("main-grid-editor-cell-danger");var a=function a(s){if(t(s.target.valueAsNumber)){i.validatingFields.set(e,false);d.Event.unbind(r,"blur",a);n.classList.remove("main-grid-editor-cell-danger")}};d.Event.bind(r,"blur",a)}function Ie(e){return e>0}function Ae(e){return this.getNode().querySelector('[data-name="'.concat(e,'"]'))}function Re(){return!this.getModel().isService()}function _e(){return!this.getModel().isService()}function Fe(){return this.getField("ACCESS_DENIED")===true}function ke(){var e=this;if(!N(this,re,Fe).call(this)){N(this,se,Ne).call(this);return}var t=this.getEditor().getSettingValue("hiddenFields");var i=this.getEditor().getGridColumnIndexes();t.forEach((function(t){var r=i[t];if(r===undefined){return}var n=e.getNode().querySelector(".main-grid-cell:nth-child(".concat(r+1,") .main-grid-cell-content"));if(d.Type.isElementNode(n)){n.innerHTML=""}}));var r=i.AMOUNT;if(r){var n=this.getNode().querySelector(".main-grid-cell:nth-child(".concat(r+1,") .main-grid-cell-content"));if(n){var a=new m({hint:d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_ACCESS_DENIED_STORE_HINT"),isReadOnly:this.getEditor().isReadOnly()});a.renderTo(n)}}}function Oe(){return this.getField("ACCESS_DENIED_TO_PURCHASING_PRICE")===true}function Ne(){if(!N(this,ae,Oe).call(this)){return}var e=this.getEditor().getGridColumnIndexes();var t=e.PURCHASING_PRICE;if(t){var i=this.getNode().querySelector(".main-grid-cell:nth-child(".concat(t+1,")"));if(i){var r=i.querySelector(".main-grid-editor-container");if(r){r.remove()}var n=i.querySelector(".main-grid-cell-content");if(n){var a=new m({hint:d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_ACCESS_DENIED_PURCHASING_PRICE_HINT"),isReadOnly:this.getEditor().isReadOnly()});a.renderTo(n);n.style.display="block"}}}}var De=function(){function e(t){babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"_settings",{});this._settings=t?t:{};this.eventHandlers={}}babelHelpers.createClass(e,[{key:"registerEventHandler",value:function e(t,i){if(!this.eventHandlers[t])this.eventHandlers[t]=[];this.eventHandlers[t].push(i);BX.addCustomEvent(this,t,i)}},{key:"fireEvent",value:function e(t,i){BX.onCustomEvent(this,t,i)}},{key:"unregisterEventHandlers",value:function e(t){if(this.eventHandlers[t]){for(var i=0;i<this.eventHandlers[t].length;i++){BX.removeCustomEvent(this,t,this.eventHandlers[t][i])}delete this.eventHandlers[t]}}}]);return e}();var we,Me,He,Be;function Ue(e,t){Ge(e,t);t.add(e)}function Le(e,t,i){Ge(e,t);t.set(e,i)}function Ge(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function xe(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Ve=new WeakMap;var Xe=new WeakMap;var We=new WeakMap;var qe=new WeakMap;var je=new WeakSet;var Ye=new WeakSet;var Qe=new WeakSet;var Ke=new WeakSet;var ze=new WeakSet;var $e=new WeakSet;var Ze=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var r=arguments.length>2?arguments[2]:undefined;babelHelpers.classCallCheck(this,e);Ue(this,$e);Ue(this,ze);Ue(this,Ke);Ue(this,Qe);Ue(this,Ye);Ue(this,je);Le(this,Ve,{writable:true,value:void 0});Le(this,Xe,{writable:true,value:void 0});Le(this,We,{writable:true,value:void 0});Le(this,qe,{writable:true,value:new d.Cache.MemoryCache});babelHelpers.classPrivateFieldSet(this,Ve,t);babelHelpers.classPrivateFieldSet(this,Xe,i);babelHelpers.classPrivateFieldSet(this,We,r)}babelHelpers.createClass(e,[{key:"show",value:function e(){this.getPopup().show()}},{key:"getPopup",value:function e(){var t=this;return babelHelpers.classPrivateFieldGet(this,qe).remember("settings-popup",(function(){return new r.Popup(babelHelpers.classPrivateFieldGet(t,We).getId()+"_"+Math.random()*100,babelHelpers.classPrivateFieldGet(t,Ve),{autoHide:true,draggable:false,offsetLeft:0,offsetTop:0,angle:{position:"top",offset:43},noAllPaddings:true,bindOptions:{forceBindPosition:true},closeByEsc:true,content:xe(t,Ye,et).call(t)})}))}},{key:"updateCheckboxState",value:function e(){var t=this;var i=this.getPopup().getContentContainer();babelHelpers.classPrivateFieldGet(this,Xe).filter((function(e){return e.action==="grid"&&d.Type.isArray(e.columns)})).forEach((function(e){var r=true;e.columns.forEach((function(e){if(!babelHelpers.classPrivateFieldGet(t,We).getGrid().getColumnHeaderCellByName(e)){r=false}}));var n=i.querySelector('input[data-setting-id="'+e.id+'"]');if(d.Type.isDomNode(n)){n.checked=r}}))}}]);return e}();function Je(e){return babelHelpers.classPrivateFieldGet(this,Xe).filter((function(t){return t.id===e}))[0]}function et(){var e=this;var t=d.Tag.render(we||(we=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div class='ui-entity-editor-popup-create-field-list'></div>\n\t\t"])));babelHelpers.classPrivateFieldGet(this,Xe).forEach((function(i){t.append(xe(e,Qe,tt).call(e,i))}));return t}function tt(e){var t=d.Tag.render(Me||(Me=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<input type="checkbox">\n\t\t'])));t.checked=e.checked;t.dataset.settingId=e.id;var i=d.Type.isStringFilled(e.desc)?d.Tag.render(He||(He=babelHelpers.taggedTemplateLiteral(['<span class="ui-entity-editor-popup-create-field-item-desc">',"</span>"])),e.desc):"";var r=d.Tag.render(Be||(Be=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="ui-ctl-block ui-entity-editor-popup-create-field-item ui-ctl-w100">\n\t\t\t\t<div class="ui-ctl-w10" style="text-align: center">','</div>\n\t\t\t\t<div class="ui-ctl-w75">\n\t\t\t\t\t<span class="ui-entity-editor-popup-create-field-item-title">',"</span>\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t</label>\n\t\t"])),t,e.title,i);d.Event.bind(r,"change",xe(this,Ke,it).bind(this));return r}function it(e){var t=xe(this,je,Je).call(this,e.target.dataset.settingId);if(!t){return}var i=e.target.checked;xe(this,ze,rt).call(this,t,i)}function rt(e,t){var i=this;var r=[];var n=babelHelpers.classPrivateFieldGet(this,We).getGrid().getRows().getHeadFirstChild().getCells();Array.from(n).forEach((function(e){if("name"in e.dataset){r.push(e.dataset.name)}}));d.ajax.runComponentAction(babelHelpers.classPrivateFieldGet(this,We).getComponentName(),"setGridSetting",{mode:"class",data:{signedParameters:babelHelpers.classPrivateFieldGet(this,We).getSignedParameters(),settingId:e.id,selected:t,currentHeaders:r}}).then((function(){e.checked=t;if(e.id==="ADD_NEW_ROW_TOP"){var r=t?"top":"bottom";babelHelpers.classPrivateFieldGet(i,We).setSettingValue("newRowPosition",r);var n=babelHelpers.classPrivateFieldGet(i,We).changeActivePanelButtons(r);var a=n.querySelector('[data-role="product-list-settings-button"]');i.getPopup().setBindElement(a)}else{babelHelpers.classPrivateFieldGet(i,We).reloadGrid()}i.getPopup().close();var s=t?d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_SETTING_ENABLED"):d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_SETTING_DISABLED");xe(i,$e,nt).call(i,s.replace("#NAME#",e.title),{category:"popup-settings"})}))}function nt(e,t){t=t||{};BX.UI.Notification.Center.notify({content:e,stack:t.stack||null,position:"top-right",width:"auto",category:t.category||null,autoHideDelay:t.autoHideDelay||3e3})}function at(e,t){ot(e,t);t.add(e)}function st(e,t,i){ot(e,t);t.set(e,i)}function ot(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function lt(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var ut=new WeakMap;var dt=new WeakMap;var ct=new WeakSet;var ht=new WeakSet;var gt=new WeakSet;var vt=new WeakSet;var ft=new WeakSet;var pt=new WeakSet;var Et=function(){function e(t,i){babelHelpers.classCallCheck(this,e);at(this,pt);at(this,ft);at(this,vt);at(this,gt);at(this,ht);at(this,ct);babelHelpers.defineProperty(this,"fieldHintIsBusy",false);babelHelpers.defineProperty(this,"activeHintGuide",null);st(this,ut,{writable:true,value:void 0});st(this,dt,{writable:true,value:void 0});babelHelpers.classPrivateFieldSet(this,dt,t);babelHelpers.classPrivateFieldSet(this,ut,i)}babelHelpers.createClass(e,[{key:"processFieldTour",value:function e(t,i,r){var n=this;var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];if(this.fieldHintIsBusy){return}this.fieldHintIsBusy=true;i.events={onClose:function e(){r();n.fieldHintIsBusy=false;n.activeHintGuide=null}};if(lt(this,gt,St).call(this,t)){var s=lt(this,pt,mt).call(this,t,i);lt(this,ft,Tt).call(this,(function(){s.close()}))}else{var o=babelHelpers.classPrivateFieldGet(this,ut).call(this).getContainer();var l=o.querySelector(".main-grid-ear-left");var u=o.querySelector(".main-grid-ear-right");var d=t.getClientRects()[0].x;var c=o.getClientRects()[0].x;var h=null;if(d>c){h=lt(this,vt,Pt).call(this,u)}else{h=lt(this,vt,Pt).call(this,l)}lt(this,ct,yt).call(this,t,(function(){h.close();var e=lt(n,pt,mt).call(n,t,i);lt(n,ft,Tt).call(n,(function(){e.close()}))}),[],a)}}},{key:"getActiveHint",value:function e(){if(!this.fieldHintIsBusy){return null}else if(this.activeHintGuide instanceof h.Guide){return this.activeHintGuide}return null}}]);return e}();function yt(e,t){var i,r=this;var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:[];var a=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];var s=(i=lt(this,ht,bt)).call.apply(i,[this,e].concat(babelHelpers.toConsumableArray(a)));var o=function e(i){var a;if((a=lt(r,gt,St)).call.apply(a,[r].concat(babelHelpers.toConsumableArray(s)))){d.Event.unbind(babelHelpers.classPrivateFieldGet(r,ut).call(r).getScrollContainer(),"scroll",e);d.Event.unbind(window,"resize",e);t.apply(void 0,babelHelpers.toConsumableArray(n))}};d.Event.bind(babelHelpers.classPrivateFieldGet(this,ut).call(this).getScrollContainer(),"scroll",o);d.Event.bind(window,"resize",o)}function bt(e){var t,i;var r=[];for(var n=arguments.length,a=new Array(n>1?n-1:0),s=1;s<n;s++){a[s-1]=arguments[s]}for(var o=0,l=a;o<l.length;o++){var u=l[o];r.push({node:u,nodeRect:u.getClientRects()[0]})}var d={node:e,nodeRect:e.getClientRects()[0]};r.push(d);r.sort((function(e,t){var i=e.nodeRect.x;var r=t.nodeRect.x;if(i<r){return-1}else if(i>r){return 1}else{return 0}}));var c=(t=babelHelpers.classPrivateFieldGet(this,ut).call(this))===null||t===void 0?void 0:(i=t.getContainer().getClientRects())===null||i===void 0?void 0:i[0];function h(e,t){return Math.abs(e-t)<c.width}while(r.length>1&&!h(r[0].nodeRect.x,r[r.length-1].nodeRect.x)){var g=r[0];var v=r[r.length-1];if(g===d){r.pop()}else if(v===d){r.shift()}else{var f=d.nodeRect.x-g.nodeRect.x;var p=v.nodeRect.x-d.nodeRect.x;if(f>=p){r.shift()}else{r.pop()}}}return r.map((function(e){return e.node}))}function St(){var e,t;var i=(e=babelHelpers.classPrivateFieldGet(this,ut).call(this))===null||e===void 0?void 0:(t=e.getContainer().getClientRects())===null||t===void 0?void 0:t[0];if(i===undefined){return false}var r=i.x;var n=i.x+i.width;for(var a=arguments.length,s=new Array(a),o=0;o<a;o++){s[o]=arguments[o]}for(var l=0,u=s;l<u.length;l++){var d;var c=u[l];var h=(d=c.getClientRects())===null||d===void 0?void 0:d[0];if(h===undefined){return false}var g=h.x;var v=h.x+h.width;if(g<r||v>n){return false}}return true}function Pt(e){var t=new BX.SpotLight({id:"arrow_spotlight",targetElement:e,autoSave:true,targetVertex:"middle-center",zIndex:200});t.show();t.container.style.pointerEvents="none";return t}function Tt(e){var t=this;var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:[];var r=babelHelpers.classPrivateFieldGet(this,ut).call(this).getContainer();var n=r.querySelector(".main-grid-ear-left");var a=r.querySelector(".main-grid-ear-right");r.style.pointerEvents="none";n.style.pointerEvents="none";a.style.pointerEvents="none";var s=function s(o){r.style.pointerEvents="auto";n.style.pointerEvents="auto";a.style.pointerEvents="auto";d.Event.unbind(babelHelpers.classPrivateFieldGet(t,dt),"click",s);e.apply(void 0,babelHelpers.toConsumableArray(i))};setTimeout((function(){d.Event.bind(babelHelpers.classPrivateFieldGet(t,dt),"click",s)}),500)}function mt(e,t){var i=new h.Guide({steps:[Object.assign({target:e},t)],onEvents:true});this.activeHintGuide=i;i.showNextStep();return i}function Ct(e,t){var i=Object.keys(e);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);t&&(r=r.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),i.push.apply(i,r)}return i}function It(e){for(var t=1;t<arguments.length;t++){var i=null!=arguments[t]?arguments[t]:{};t%2?Ct(Object(i),!0).forEach((function(t){babelHelpers.defineProperty(e,t,i[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(i)):Ct(Object(i)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(i,t))}))}return e}function At(e,t){var i=typeof Symbol!=="undefined"&&e[Symbol.iterator]||e["@@iterator"];if(!i){if(Array.isArray(e)||(i=Rt(e))||t&&e&&typeof e.length==="number"){if(i)e=i;var r=0;var n=function e(){};return{s:n,n:function t(){if(r>=e.length)return{done:true};return{done:false,value:e[r++]}},e:function e(t){throw t},f:n}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a=true,s=false,o;return{s:function t(){i=i.call(e)},n:function e(){var t=i.next();a=t.done;return t},e:function e(t){s=true;o=t},f:function e(){try{if(!a&&i["return"]!=null)i["return"]()}finally{if(s)throw o}}}}function Rt(e,t){if(!e)return;if(typeof e==="string")return _t(e,t);var i=Object.prototype.toString.call(e).slice(8,-1);if(i==="Object"&&e.constructor)i=e.constructor.name;if(i==="Map"||i==="Set")return Array.from(e);if(i==="Arguments"||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(i))return _t(e,t)}function _t(e,t){if(t==null||t>e.length)t=e.length;for(var i=0,r=new Array(t);i<t;i++)r[i]=e[i];return r}function Ft(e,t){Ot(e,t);t.add(e)}function kt(e,t,i){Ot(e,t);t.set(e,i)}function Ot(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Nt(e,t,i){Dt(e,t);return i}function Dt(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function wt(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var Mt="template_0";var Ht=2;var Bt=function e(t){if(!d.Type.isPlainObject(t)){return false}for(var i in t){return false}return true};var Ut=new WeakMap;var Lt=new WeakSet;var Gt=new WeakSet;var xt=new WeakSet;var Vt=function(){function e(t){babelHelpers.classCallCheck(this,e);Ft(this,xt);Ft(this,Gt);Ft(this,Lt);babelHelpers.defineProperty(this,"products",[]);babelHelpers.defineProperty(this,"productsWasInitiated",false);babelHelpers.defineProperty(this,"cache",new d.Cache.MemoryCache);kt(this,Ut,{writable:true,value:void 0});babelHelpers.defineProperty(this,"actions",{productChange:"productChange",productListChanged:"productListChanged",updateListField:"listField",updateTotal:"total"});babelHelpers.defineProperty(this,"updateFieldForList",null);babelHelpers.defineProperty(this,"productRowAddHandler",this.handleProductRowAdd.bind(this));babelHelpers.defineProperty(this,"productRowCreateHandler",this.handleProductRowCreate.bind(this));babelHelpers.defineProperty(this,"showBarcodeSettingsPopupHandler",this.handleShowBarcodeSettingsPopup.bind(this));babelHelpers.defineProperty(this,"showSettingsPopupHandler",this.handleShowSettingsPopup.bind(this));babelHelpers.defineProperty(this,"onSaveHandler",this.handleOnSave.bind(this));babelHelpers.defineProperty(this,"onEditorSubmit",this.handleEditorSubmit.bind(this));babelHelpers.defineProperty(this,"onFocusToProductList",this.handleProductListFocus.bind(this));babelHelpers.defineProperty(this,"onBeforeGridRequestHandler",this.handleOnBeforeGridRequest.bind(this));babelHelpers.defineProperty(this,"onGridUpdatedHandler",this.handleOnGridUpdated.bind(this));babelHelpers.defineProperty(this,"onGridRowMovedHandler",this.handleOnGridRowMoved.bind(this));babelHelpers.defineProperty(this,"onBeforeProductChangeHandler",this.handleOnBeforeProductChange.bind(this));babelHelpers.defineProperty(this,"onProductChangeHandler",this.handleOnProductChange.bind(this));babelHelpers.defineProperty(this,"onProductClearHandler",this.handleOnProductClear.bind(this));babelHelpers.defineProperty(this,"dropdownChangeHandler",this.handleDropdownChange.bind(this));babelHelpers.defineProperty(this,"onScanEmitHandler",this.handleMobileScanEvent.bind(this));babelHelpers.defineProperty(this,"changeProductFieldHandler",this.handleFieldChange.bind(this));babelHelpers.defineProperty(this,"blurProductFieldHandler",this.handleFieldBlur.bind(this));babelHelpers.defineProperty(this,"updateTotalDataDelayedHandler",d.Runtime.debounce(this.updateTotalDataDelayed,100,this));this.setId(t)}babelHelpers.createClass(e,[{key:"init",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.setSettings(i);this.scannerToken=(t=this.scannerToken)!==null&&t!==void 0?t:d.Text.getRandom(16);if(this.canEdit()){this.addFirstRowIfEmpty();this.enableEdit()}this.initForm();this.initProducts();this.initGridData();this.paintColumns();babelHelpers.classPrivateFieldSet(this,Ut,new Et(this.getContainer(),this.getGrid.bind(this)));n.EventEmitter.emit("DocumentProductListController",[this]);wt(this,Lt,Xt).call(this);this.subscribeDomEvents();this.subscribeCustomEvents();this.getContainer().querySelectorAll(".catalog-document-product-list-add-block").forEach((function(e){BX.UI.Hint.init(e)}))}},{key:"subscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(d.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){if(t.getSettingValue("isOnecInventoryManagementRestricted")===true){d.Dom.addClass(e,"ui-btn-icon-lock")}d.Event.bind(e,"click",t.productRowAddHandler)}));if(this.getSettingValue("enabledCreateProductButton",true)){i.querySelectorAll('[data-role="product-list-create-button"]').forEach((function(e){d.Event.bind(e,"click",t.productRowCreateHandler)}))}i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){d.Event.bind(e,"click",t.showSettingsPopupHandler)}));i.querySelectorAll('[data-role="product-list-barcode-settings-button"]').forEach((function(e){d.Event.bind(e,"click",t.showBarcodeSettingsPopupHandler)}))}}},{key:"unsubscribeDomEvents",value:function e(){var t=this;var i=this.getContainer();if(d.Type.isElementNode(i)){i.querySelectorAll('[data-role="product-list-select-button"]').forEach((function(e){d.Event.unbind(e,"click",t.productSelectionPopupHandler)}));i.querySelectorAll('[data-role="product-list-add-button"]').forEach((function(e){d.Event.unbind(e,"click",t.productRowCreateHandler)}));i.querySelectorAll('[data-role="product-list-barcode-settings-button"]').forEach((function(e){d.Event.unbind(e,"click",t.productRowAddHandler)}));i.querySelectorAll('[data-role="product-list-settings-button"]').forEach((function(e){d.Event.unbind(e,"click",t.showSettingsPopupHandler)}))}}},{key:"subscribeCustomEvents",value:function e(){n.EventEmitter.subscribe("BX.UI.EntityEditor:onSave",this.onSaveHandler);n.EventEmitter.subscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit);n.EventEmitter.subscribe("onFocusToProductList",this.onFocusToProductList);n.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);n.EventEmitter.subscribe("Grid::updated",this.onGridUpdatedHandler);n.EventEmitter.subscribe("Grid::rowMoved",this.onGridRowMovedHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);n.EventEmitter.subscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);n.EventEmitter.subscribe("Dropdown::change",this.dropdownChangeHandler);n.EventEmitter.subscribe("BarcodeScanner::onScanEmit",this.onScanEmitHandler)}},{key:"unsubscribeCustomEvents",value:function e(){n.EventEmitter.unsubscribe("BX.UI.EntityEditor:onSave",this.onSaveHandler);n.EventEmitter.unsubscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorSubmit);n.EventEmitter.unsubscribe("onFocusToProductList",this.onFocusToProductList);n.EventEmitter.unsubscribe("Grid::beforeRequest",this.onBeforeGridRequestHandler);n.EventEmitter.unsubscribe("Grid::updated",this.onGridUpdatedHandler);n.EventEmitter.unsubscribe("Grid::rowMoved",this.onGridRowMovedHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onBeforeChange",this.onBeforeProductChangeHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onChange",this.onProductChangeHandler);n.EventEmitter.unsubscribe("BX.Catalog.ProductSelector:onClear",this.onProductClearHandler);n.EventEmitter.unsubscribe("Dropdown::change",this.dropdownChangeHandler);n.EventEmitter.unsubscribe("BarcodeScanner::onScanEmit",this.onScanEmitHandler)}},{key:"handleMobileScanEvent",value:function e(t){var i,r;var n=t.getData();if(this.scannerToken!==n.id||!d.Type.isStringFilled(n.barcode)){return}var a=At(this.products),s;try{for(a.s();!(s=a.n()).done;){var o,l;var u=s.value;if(((o=u.getBarcodeSelector())===null||o===void 0?void 0:(l=o.searchInput)===null||l===void 0?void 0:l.getNameInput())===document.activeElement){var c;(c=u.getBarcodeSelector().searchInput)===null||c===void 0?void 0:c.applyScannerData(n.barcode);return}}}catch(e){a.e(e)}finally{a.f()}var h=At(this.products),g;try{for(h.s();!(g=h.n()).done;){var v,f,p,E;var y=g.value;if(((v=y.getBarcodeSelector())===null||v===void 0?void 0:(f=v.searchInput)===null||f===void 0?void 0:f.getNameInput().value)===""&&((p=y.getSelector())===null||p===void 0?void 0:(E=p.searchInput)===null||E===void 0?void 0:E.getNameInput().value)===""){var b;(b=y.getBarcodeSelector().searchInput)===null||b===void 0?void 0:b.applyScannerData(n.barcode);return}}}catch(e){h.e(e)}finally{h.f()}var S=this.addProductRow();(i=this.getProductById(S))===null||i===void 0?void 0:(r=i.getBarcodeSelector().searchInput)===null||r===void 0?void 0:r.applyScannerData(n.barcode)}},{key:"selectProductInRow",value:function e(t,i){var r=this;if(!d.Type.isStringFilled(t)||d.Text.toNumber(i)<=0){return}requestAnimationFrame((function(){var e;(e=r.getProductSelector(t))===null||e===void 0?void 0:e.onProductSelect(i)}))}},{key:"handleOnSave",value:function e(t){var i=u.ProductModel.getLastActiveSaveNotification();if(i){i.close()}var r=[];this.products.forEach((function(e){var t={fields:It({},e.fields),rowId:e.fields.ROW_ID};r.push(t)}));this.setSettingValue("items",r)}},{key:"handleEditorSubmit",value:function e(t){}},{key:"handleProductListFocus",value:function e(t){if(this.isReadOnly()){return}var i=false;var r=At(this.products),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;if(a.isEmptyRow()){i=true;this.focusProductSelector(a.fields["ROW_ID"]);break}}}catch(e){r.e(e)}finally{r.f()}if(!i){this.handleProductRowAdd()}}},{key:"onInnerCancel",value:function e(){this.reloadGrid(false)}},{key:"changeActivePanelButtons",value:function e(t){var i=this.getContainer();var r=i.querySelector(".catalog-document-product-list-add-block-"+t);if(d.Type.isDomNode(r)){d.Dom.removeClass(r,"catalog-document-product-list-add-block-hidden");d.Dom.addClass(r,"catalog-document-product-list-add-block-active")}var n=t==="top"?"bottom":"top";var a=i.querySelector(".catalog-document-product-list-add-block-"+n);if(d.Type.isDomNode(a)){d.Dom.addClass(a,"catalog-document-product-list-add-block-hidden");d.Dom.removeClass(a,"catalog-document-product-list-add-block-active")}return r}},{key:"reloadGrid",value:function e(){var t=this;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var r=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;if(r===null){r=!i}this.getGrid().reloadTable("POST",{useProductsFromRequest:i},(function(){return t.actionUpdateTotalData({isInternalChanging:r})}))}},{key:"handleOnBeforeGridRequest",value:function t(i){var r=this;var a=i.getCompatData(),s=babelHelpers.slicedToArray(a,2),o=s[0],l=s[1];if(!o||!o.parent||o.parent.getId()!==this.getGridId()){return}var u=!("useProductsFromRequest"in l.data);var d=u?true:l.data.useProductsFromRequest;l.url=this.getReloadUrl();l.method="POST";l.sessid=BX.bitrix_sessid();l.data=It(It({},l.data),{},{useProductsFromRequest:d,signedParameters:this.getSignedParameters(),products:d?this.getProductsFields(Nt(e,e,qt).call(e)):null});var c=false;if(l.data["action_button_"+l.gridId]==="delete"){c=true}this.clearEditor();if(u){n.EventEmitter.subscribeOnce("Grid::updated",(function(e){var t=e.getCompatData(),i=babelHelpers.slicedToArray(t,1),n=i[0];if(!n||n.getId()!==r.getGridId()){return}r.actionUpdateTotalData({isInternalChanging:false});if(c){r.executeActions([{type:r.actions.productListChanged}])}}))}}},{key:"handleOnGridUpdated",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,1),n=r[0];if(!n||n.getId()!==this.getGridId()){return}this.getSettingsPopup().updateCheckboxState()}},{key:"handleOnGridRowMoved",value:function e(t){var i=t.getCompatData(),r=babelHelpers.slicedToArray(i,3),n=r[0],a=r[2];if(!a||a.getId()!==this.getGridId()){return}var s=this.resortProductsByIds(n);if(s){this.refreshSortFields();this.numerateRows();this.executeActions([{type:this.actions.productListChanged}])}}},{key:"initPageEventsManager",value:function e(){var t=this.getSettingValue("componentId");this.pageEventsManager=new De({id:t})}},{key:"getPageEventsManager",value:function e(){if(!this.pageEventsManager){this.initPageEventsManager()}return this.pageEventsManager}},{key:"canEdit",value:function e(){return this.getSettingValue("allowEdit",false)===true}},{key:"enableEdit",value:function e(){var t=this.getGrid().getRows().getRows();t.forEach((function(e){if(!e.isHeadChild()&&!e.isTemplate()&&!Bt(e.getEditData())){e.edit()}}))}},{key:"addFirstRowIfEmpty",value:function e(){var t=this;if(this.getGrid().getRows().getCountDisplayed()===0){this.setSettingValue("taxIncluded",null);this.setSettingValue("taxIncludedFormatted",null);requestAnimationFrame((function(){return t.addProductRow()}))}}},{key:"clearEditor",value:function e(){this.unsubscribeProductsEvents();this.products=[];this.productsWasInitiated=false;this.destroySettingsPopup();this.unsubscribeDomEvents();this.unsubscribeCustomEvents();d.Event.unbindAll(this.container)}},{key:"wasProductsInitiated",value:function e(){return this.productsWasInitiated}},{key:"unsubscribeProductsEvents",value:function e(){this.products.forEach((function(e){var t=e.getSelector();if(t){t.unsubscribeEvents()}var i=e.getBarcodeSelector();if(i){i.unsubscribeEvents()}}))}},{key:"destroy",value:function e(){this.setForm(null);this.clearController();this.clearEditor()}},{key:"setController",value:function e(t){if(this.controller===t){return}if(this.controller){this.controller.clearProductList()}this.controller=t}},{key:"clearController",value:function e(){this.controller=null}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"getSettings",value:function e(){return this.settings}},{key:"setSettings",value:function e(t){this.settings=t?t:{}}},{key:"getSettingValue",value:function e(t,i){return this.settings.hasOwnProperty(t)?this.settings[t]:i}},{key:"setSettingValue",value:function e(t,i){this.settings[t]=i}},{key:"getComponentName",value:function e(){return this.getSettingValue("componentName","")}},{key:"getReloadUrl",value:function e(){return this.getSettingValue("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getSettingValue("signedParameters","")}},{key:"getContainerId",value:function e(){return this.getSettingValue("containerId","")}},{key:"getGridId",value:function e(){return this.getSettingValue("gridId","")}},{key:"getLanguageId",value:function e(){return this.getSettingValue("languageId","")}},{key:"getSiteId",value:function e(){return this.getSettingValue("siteId","")}},{key:"getCatalogId",value:function e(){return this.getSettingValue("catalogId",0)}},{key:"isReadOnly",value:function e(){return this.getSettingValue("readOnly",true)}},{key:"setReadOnly",value:function e(t){this.setSettingValue("readOnly",t)}},{key:"getCurrencyId",value:function e(){return this.getSettingValue("currencyId","")}},{key:"setCurrencyId",value:function e(t){this.setSettingValue("currencyId",t);return a.CurrencyCore.loadCurrencyFormat(t)}},{key:"isSalesOrdersDocument",value:function e(){var t=["REALIZATION","W"];return t.includes(this.settings.documentType)}},{key:"changeCurrencyId",value:function e(t){var i=this;var r=this.getCurrencyId();if(r===t){return}this.setCurrencyId(t).then((function(){var e=[];i.products.forEach((function(i){i.getModel().setOption("currency",t);e.push({fields:i.getFields(),id:i.getId()})}));if(e.length>0){d.ajax.runComponentAction(i.getComponentName(),"calculateProductPrices",{mode:"class",signedParameters:i.getSignedParameters(),data:{products:e,currencyId:t,oldCurrencyId:r}}).then(i.onCalculatePricesResponse.bind(i))}var n=i.getGridEditData();var a=n[Mt];a["CURRENCY"]=i.getCurrencyId();var s=["BASE_PRICE","PURCHASING_PRICE"];s.forEach((function(e){if(a[e]&&a[e]["CURRENCY"]){a[e]["CURRENCY"]["VALUE"]=i.getCurrencyId()}}));i.setGridEditData(n)}))}},{key:"onCalculatePricesResponse",value:function e(t){var i=t.data;this.products.forEach((function(e){if(d.Type.isObject(i[e.getId()])){e.updateField("BASE_PRICE",i[e.getId()]["BASE_PRICE"]);e.updateField("PURCHASING_PRICE",i[e.getId()]["PURCHASING_PRICE"]);e.updateUiCurrencyFields()}}));this.updateTotalDataDelayed();this.updateTotalUiCurrency()}},{key:"updateTotalUiCurrency",value:function e(){var t=this;var i=BX(this.getSettingValue("totalBlockContainerId",null));if(d.Type.isElementNode(i)){var r=["totalCost"];i.querySelectorAll(".catalog-document-product-list-result-grid-total").forEach((function(e){for(var i=0,n=r;i<n.length;i++){var s=n[i];var o=e.querySelector('[data-total="'+s+'"]');if(o){e.innerHTML=a.CurrencyCore.getPriceControl(o,t.getCurrencyId())}}}))}}},{key:"getCurrencyText",value:function e(){var t=this.getCurrencyId();if(!d.Type.isStringFilled(t)){return""}var i=a.CurrencyCore.getCurrencyFormat(t);return i&&i.FORMAT_STRING.replace(/(^|[^&])#/,"$1").trim()||""}},{key:"getDataFieldName",value:function e(){return this.getSettingValue("dataFieldName","")}},{key:"getDataSettingsFieldName",value:function e(){var t=this.getDataFieldName();return d.Type.isStringFilled(t)?t+"_SETTINGS":""}},{key:"getPricePrecision",value:function e(){return this.getSettingValue("pricePrecision",Ht)}},{key:"getQuantityPrecision",value:function e(){return this.getSettingValue("quantityPrecision",Ht)}},{key:"getCommonPrecision",value:function e(){return this.getSettingValue("commonPrecision",Ht)}},{key:"getMeasures",value:function e(){return this.getSettingValue("measures",[])}},{key:"getDefaultMeasure",value:function e(){return this.getSettingValue("defaultMeasure",{})}},{key:"getRowIdPrefix",value:function e(){return this.getSettingValue("rowIdPrefix","catalog_entity_product_list_")}},{key:"parseInt",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:0;var i;var r=d.Type.isNumber(e);var n=d.Type.isStringFilled(e);if(!r&&!n){return t}if(n){e=e.replace(/^\s+|\s+$/g,"");var a=e.indexOf("-")===0;i=parseInt(e.replace(/[^\d]/g,""),10);if(isNaN(i)){i=t}else{if(a){i=-i}}}else{i=parseInt(e,10);if(isNaN(i)){i=t}}return i}))},{key:"parseFloat",value:function(e){function t(t){return e.apply(this,arguments)}t.toString=function(){return e.toString()};return t}((function(e){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Ht;var i=arguments.length>2&&arguments[2]!==undefined?arguments[2]:0;var r;var n=d.Type.isNumber(e);var a=d.Type.isStringFilled(e);if(!n&&!a){return i}if(a){e=e.replace(/^\s+|\s+$/g,"");var s=e.indexOf(".");var o=e.indexOf(",");var l=e.indexOf("-")===0;if(s<0&&o>=0){var u=e.substr(0,o);var c=e.length-o-1;if(c>0){u+="."+e.substr(o+1,c)}e=u}e=e.replace(/[^\d.]+/g,"");r=parseFloat(e);if(isNaN(r)){r=i}if(l){r=-r}}else{r=parseFloat(e)}if(t>=0){r=this.round(r,t)}return r}))},{key:"round",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:Ht;var r=Math.pow(10,i);return Math.round(t*r)/r}},{key:"getContainer",value:function e(){var t=this;return this.cache.remember("container",(function(){return document.getElementById(t.getContainerId())}))}},{key:"initForm",value:function e(){var t=this.getSettingValue("formId","");var i=d.Type.isStringFilled(t)?BX("form_"+t):null;if(d.Type.isElementNode(i)){this.setForm(i)}}},{key:"isExistForm",value:function e(){return d.Type.isElementNode(this.getForm())}},{key:"getForm",value:function e(){return this.form}},{key:"setForm",value:function e(t){this.form=t}},{key:"initFormFields",value:function e(){var t=this.getForm();if(d.Type.isElementNode(t)){var i=this.getDataField();if(!d.Type.isElementNode(i)){this.initDataField()}var r=this.getDataSettingsField();if(!d.Type.isElementNode(r)){this.initDataSettingsField()}}}},{key:"initFormField",value:function e(t){var i=this.getForm();if(d.Type.isElementNode(i)&&d.Type.isStringFilled(t)){i.appendChild(d.Dom.create("input",{attrs:{type:"hidden",name:t}}))}}},{key:"removeFormFields",value:function e(){var t=this.getDataField();if(d.Type.isElementNode(t)){d.Dom.remove(t)}var i=this.getDataSettingsField();if(d.Type.isElementNode(i)){d.Dom.remove(i)}}},{key:"initDataField",value:function e(){this.initFormField(this.getDataFieldName())}},{key:"initDataSettingsField",value:function e(){this.initFormField(this.getDataSettingsFieldName())}},{key:"getFormField",value:function e(t){var i=this.getForm();if(d.Type.isElementNode(i)&&d.Type.isStringFilled(t)){return i.querySelector('input[name="'+t+'"]')}return null}},{key:"getDataField",value:function e(){return this.getFormField(this.getDataFieldName())}},{key:"getDataSettingsField",value:function e(){return this.getFormField(this.getDataSettingsFieldName())}},{key:"getProductCount",value:function e(){return this.products.filter((function(e){return!e.isEmptyRow()})).length}},{key:"initProducts",value:function e(){var t=this.getSettingValue("items",[]);var i=At(t),r;try{for(i.s();!(r=i.n()).done;){var n=r.value;var a=It({},n.fields);this.products.push(new oe(n.rowId,a,this.getSettingValue("rowSettings",{}),this))}}catch(e){i.e(e)}finally{i.f()}this.numerateRows();this.productsWasInitiated=true;this.updateTotalDataDelayed()}},{key:"numerateRows",value:function e(){this.products.forEach((function(e,t){e.setRowNumber(t+1)}))}},{key:"getGrid",value:function e(){var t=this;return this.cache.remember("grid",(function(){var e=t.getGridId();if(!d.Reflection.getClass("BX.Main.gridManager.getInstanceById")){throw Error("Cannot find grid with '".concat(e,"' id."))}return BX.Main.gridManager.getInstanceById(e)}))}},{key:"getGridColumnIndexes",value:function e(){var t=this;return this.cache.remember("getGridColumnIndexes",(function(){var e={};var i=t.getGrid().getHead().querySelectorAll(".main-grid-cell-head");for(var r=0;r<i.length;r++){var n=i[r];var a=n.dataset.name;if(a){e[a]=r}}return e}))}},{key:"initGridData",value:function e(){var t=this.getSettingValue("templateGridEditData",null);if(t){this.setGridEditData(t)}}},{key:"paintColumns",value:function e(){var t=this.getSettingValue("paintedColumns",null);var i=this.getGrid();if(i&&d.Type.isArray(t)){t.forEach((function(e){var t=i.getRows().getRows();t.forEach((function(t){var i=t.getCellById(e);if(i){d.Dom.addClass(i,"main-grid-cell-light-blue-background")}}))}))}}},{key:"getGridEditData",value:function e(){return this.getGrid().arParams.EDITABLE_DATA}},{key:"getColumnInfo",value:function e(t){var i,r;return((i=this.getGrid())===null||i===void 0?void 0:(r=i.arParams)===null||r===void 0?void 0:r.COLUMNS_ALL[t])||{}}},{key:"setGridEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA=t}},{key:"setOriginalTemplateEditData",value:function e(t){this.getGrid().arParams.EDITABLE_DATA[Mt]=t}},{key:"handleProductErrorsChange",value:function e(){if(wt(this,Gt,Wt).call(this)){this.controller.disableSaveButton()}else{this.controller.enableSaveButton()}}},{key:"handleFieldChange",value:function e(t){var i=t.target.closest("tr");if(i&&i.hasAttribute("data-id")){var r=this.getProductById(i.getAttribute("data-id"));if(r){var n=t.target.getAttribute("data-name");if(!d.Type.isStringFilled(n)){var a=t.target.closest("td");n=this.getFieldCodeByGridCell(i,a)}if(n){r.updateFieldByEvent(n,t)}}}}},{key:"handleFieldBlur",value:function e(t){var i=t.target.closest("tr");var r=t.target.value;var n=t.target.getAttribute("data-name");if(!d.Type.isStringFilled(n)){var a=t.target.closest("td");n=this.getFieldCodeByGridCell(i,a)}if(this.isSalesOrdersDocument()&&n==="AMOUNT"&&r<=0){t.target.value=1;this.handleFieldChange(t);BX.UI.Notification.Center.notify({width:"auto",content:d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_INVALID_AMOUNT_REALIZATION")})}}},{key:"handleDropdownChange",value:function e(t){var i=t.getData(),r=babelHelpers.slicedToArray(i,5),n=r[0],a=r[4];var s=new RegExp(this.getRowIdPrefix()+"([A-Za-z0-9]+)_(\\w+)_control","i");var o=n.match(s);if(o){var l=babelHelpers.slicedToArray(o,3),u=l[1],d=l[2];var c=this.getProductById(u);if(c){c.updateDropdownField(d,a)}}}},{key:"getProductById",value:function e(t){var i=this.getRowIdPrefix()+t;return this.getProductByRowId(i)}},{key:"getProductByRowId",value:function e(t){return this.products.find((function(e){return e.getId()===t}))}},{key:"getFieldCodeByGridCell",value:function e(t,i){if(!d.Type.isDomNode(t)||!d.Type.isDomNode(i)){return null}var r=this.getGrid();if(r){var n=r.getRows().getHeadFirstChild();var a=babelHelpers.toConsumableArray(t.cells).indexOf(i);return n.getCellNameByCellIndex(a)}return null}},{key:"addProductRow",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:null;var i=this.createGridProductRow();var r=i.getId();if(t){var n;var a=(n=this.getGrid().getRows().getById(t.getField("ID")))===null||n===void 0?void 0:n.getNode();if(a){a.parentNode.insertBefore(i.getNode(),a.nextSibling)}}this.initializeNewProductRow(r,t);this.getGrid().bindOnRowEvents();return r}},{key:"handleProductRowAdd",value:function e(){if(this.getSettingValue("isOnecInventoryManagementRestricted")===true){t.OneCPlanRestrictionSlider.show();return}var i=this.addProductRow();this.focusProductSelector(i)}},{key:"handleProductRowCreate",value:function e(){}},{key:"handleShowBarcodeSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"handleShowSettingsPopup",value:function e(){this.getSettingsPopup().show()}},{key:"destroySettingsPopup",value:function e(){if(this.cache.has("settings-popup")){this.cache.get("settings-popup").getPopup().destroy();this.cache["delete"]("settings-popup")}}},{key:"getSettingsPopup",value:function e(){var t=this;return this.cache.remember("settings-popup",(function(){return new Ze(t.getContainer().querySelector('.catalog-document-product-list-add-block-active [data-role="product-list-settings-button"]'),t.getSettingValue("popupSettings",[]),t)}))}},{key:"getHintPopup",value:function e(){var t=this;return this.cache.remember("hint-popup",(function(){return new f(t)}))}},{key:"createGridProductRow",value:function e(){var t=d.Text.getRandom();var i=this.redefineTemplateEditData(t);var r=this.getGrid();var a;if(this.getSettingValue("newRowPosition")==="bottom"){a=r.appendRowEditor()}else{a=r.prependRowEditor()}var s=a.getNode();if(d.Type.isDomNode(s)){s.setAttribute("data-id",t);a.makeCountable()}if(i){this.setOriginalTemplateEditData(i)}n.EventEmitter.emit("Grid::thereEditedRows",[]);r.adjustRows();r.updateCounterDisplayed();r.updateCounterSelected();return a}},{key:"handleDeleteRow",value:function e(t,i){i.preventDefault();var r=this.getProductByRowId(t);if(r){this.deleteRow(t)}}},{key:"redefineTemplateEditData",value:function e(t){var i=this.getGridEditData();var r=i[Mt];var n=this.prepareCustomEditData(r,t);this.setOriginalTemplateEditData(It(It({},r),n));return r}},{key:"prepareCustomEditData",value:function e(t,i){var r={};var n=this.getSettingValue("templateIdMask","");for(var a in t){if(t.hasOwnProperty(a)){if(d.Type.isStringFilled(t[a])&&t[a].indexOf(n)>=0){r[a]=t[a].replace(new RegExp(n,"g"),i)}else if(d.Type.isPlainObject(t[a])){r[a]=this.prepareCustomEditData(t[a],i)}else{r[a]=t[a]}}}return r}},{key:"initializeNewProductRow",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:null;var r={};if(i!==null){r=Object.assign(r,i===null||i===void 0?void 0:i.getFields())}else{r=It(It({},this.getSettingValue("templateItemFields",{})),{CURRENCY:this.getCurrencyId()})}if(d.Type.isNil(i)&&this.products.length>0){var n=this.getSettingValue("newRowPosition")==="bottom"?this.products[this.products.length-1]:this.products[0];var a=this.getSettingValue("stores",{});var s=n.getSettingValue("storeHeaderMap",{});Object.values(s).forEach((function(e){var t=n.getField(e);if(d.Type.isNil(a[t])){return}r[e]=n.getField(e);var i=e+"_TITLE";r[i]=n.getField(i)}))}var o=this.getRowIdPrefix()+t;r.ID=t;r.ROW_ID=t;if(d.Type.isObject(r.IMAGE_INFO)){delete r.IMAGE_INFO.input}var l=new oe(o,r,this.getSettingValue("rowSettings",{}),this);if(i instanceof oe){this.products.splice(1+this.products.indexOf(i),0,l);l.refreshFieldsLayout()}else if(this.getSettingValue("newRowPosition")==="bottom"){this.products.push(l)}else{this.products.unshift(l)}this.refreshSortFields();this.numerateRows();l.updateUiCurrencyFields();this.updateTotalUiCurrency();return l}},{key:"getProductSelector",value:function e(t){return this.getProductById(t).getSelector()}},{key:"focusProductSelector",value:function e(t){var i=this;requestAnimationFrame((function(){var e;(e=i.getProductSelector(t))===null||e===void 0?void 0:e.searchInDialog().focusName()}))}},{key:"handleOnBeforeProductChange",value:function e(t){var i=t.getData();var r=this.getProductByRowId(i.rowId);if(r){this.getGrid().tableFade();r.resetExternalActions()}}},{key:"handleOnProductChange",value:function e(t){var i=t.getData();var r=this.getProductByRowId(i.rowId);if(r&&i.fields){var n,a;delete i.fields.ID;var s=this.getSettingValue("taxIncludedFromFirstItem",null);var o=this.getSettingValue("taxIncludedFromFirstItemFormatted",null);var l=s?s:this.getSettingValue("taxIncluded",null);var u=o?o:this.getSettingValue("taxIncludedFormatted",null);if(l&&u){if(i.fields["TAX_INCLUDED"]==="Y"&&i.fields["TAX_INCLUDED"]!==l){i.fields["BASE_PRICE"]=i.fields["BASE_PRICE"]/(1+i.fields["TAX_RATE"]/100)}i.fields["TAX_INCLUDED"]=l;i.fields["TAX_INCLUDED_FORMATTED"]=u}else{this.setSettingValue("taxIncluded",i.fields.TAX_INCLUDED);this.setSettingValue("taxIncludedFormatted",i.fields.TAX_INCLUDED_FORMATTED)}r.setFields(i.fields);Object.keys(i.fields).forEach((function(e){r.updateFieldValue(e,i.fields[e])}));r.setField("IS_NEW",i.isNew?"Y":"N");(n=r.getSelector())===null||n===void 0?void 0:n.layout();(a=r.getBarcodeSelector())===null||a===void 0?void 0:a.layout();r.updateProductStoreValues();r.initHandlersForSelectors();r.layoutStoreSelector(r.getSettingValue("storeHeaderMap",{}));r.layoutBarcode();r.executeExternalActions();if(this.isSalesOrdersDocument()){r.changeAmount(r.getAmount()>0?r.getAmount():1)}this.getGrid().tableUnfade()}else{this.getGrid().tableUnfade()}}},{key:"handleOnProductClear",value:function e(t){var i=t.getData(),r=i.selectorId,n=i.rowId;var a=this.getProductByRowId(n);if(a&&a.getSelector().getId()===r){var s;a.initHandlersForSelectors();a.setMeasure(this.getDefaultMeasure());a.changePurchasingPrice(0);a.changeBasePrice(0);a.changeAmount(0);a.updateUiStoreValues();a.updateProductStoreValues();a.changeBarcode("");(s=a.getBarcodeSelector())===null||s===void 0?void 0:s.setConfig("ENABLE_SEARCH",true).layout();a.executeExternalActions()}if(this.getProductCount()===1){this.setSettingValue("taxIncluded",null);this.setSettingValue("taxIncludedFormatted",null)}}},{key:"compileProductData",value:function e(){if(!this.isExistForm()){return}this.initFormFields();var t=this.getDataField();var i=this.getDataSettingsField();this.cleanProductRows();if(d.Type.isElementNode(t)&&d.Type.isElementNode(i)){t.value=this.prepareProductDataValue()}}},{key:"prepareProductDataValue",value:function t(){var i="";if(this.getProductCount()){var r=[];this.products.forEach((function(t){var i=t.getFields(Nt(e,e,qt).call(e));if(!/^[0-9]+$/.test(i["ID"])){i["ID"]=0}i["CUSTOMIZED"]="Y";r.push(i)}));i=JSON.stringify(r)}return i}},{key:"executeActions",value:function e(t){if(!d.Type.isArrayFilled(t)){return}var i=At(t),r;try{for(i.s();!(r=i.n()).done;){var n=r.value;if(!d.Type.isPlainObject(n)||!d.Type.isStringFilled(n.type)){continue}switch(n.type){case this.actions.productChange:this.actionSendProductChange(n);break;case this.actions.productListChanged:this.actionSendProductListChanged();break;case this.actions.updateTotal:this.actionUpdateTotalData();break}}}catch(e){i.e(e)}finally{i.f()}}},{key:"actionSendProductChange",value:function e(t){if(!d.Type.isStringFilled(t.id)){return}var i=this.getProductByRowId(t.id);if(!i){return}if(this.controller){this.controller.productChange()}}},{key:"actionSendProductListChanged",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;if(this.controller){this.controller.productChange(t)}}},{key:"actionUpdateListField",value:function e(t){if(!d.Type.isStringFilled(t.field)||!("value"in t)){return}this.updateFieldForList=t.field;var i=At(this.products),r;try{for(i.s();!(r=i.n()).done;){var n=r.value;n.updateFieldByName(t.field,t.value)}}catch(e){i.e(e)}finally{i.f()}this.updateFieldForList=null}},{key:"actionUpdateTotalData",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};this.updateTotalDataDelayedHandler(t)}},{key:"updateTotalDataDelayed",value:function e(){var t=0;var i=0;var r=this.getSettingValue("totalCalculationSumField","PURCHASING_PRICE");var n=this.getSettingValue("totalCalculationSumTaxField","TAX_SUM");this.products.forEach((function(e){t+=d.Text.toNumber(e.getField(r))*d.Text.toNumber(e.getField("AMOUNT"));i+=d.Text.toNumber(e.getField(n))}));var a=t-i;this.setTotalData({totalCost:t,totalBeforeTax:a,totalTax:i})}},{key:"getProductsFields",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:[];var i=[];var r=At(this.products),n;try{for(r.s();!(n=r.n()).done;){var a=n.value;i.push(a.getFields(t))}}catch(e){r.e(e)}finally{r.f()}return i}},{key:"setTotalData",value:function e(t){var i;var r=BX(this.getSettingValue("totalBlockContainerId",null));if(d.Type.isElementNode(r)){var n=this.getCurrencyId();var s=["totalCost","totalBeforeTax","totalTax"];for(var o=0,l=s;o<l.length;o++){var u=l[o];var c=r.querySelector('[data-total="'+u+'"]');if(d.Type.isElementNode(c)&&u in t){c.innerHTML=a.CurrencyCore.currencyFormat(t[u],n,false)}}}(i=this.controller)===null||i===void 0?void 0:i.setTotal(t)}},{key:"ajaxResultCommonCheck",value:function e(t){if(!d.Type.isPlainObject(t)){return false}if(!d.Type.isStringFilled(t.status)){return false}if(t.status!=="success"){return false}if(!d.Type.isPlainObject(t.data)){return false}if(!d.Type.isStringFilled(t.data.action)){return false}if(!("result"in t.data)){return false}return true}},{key:"deleteRow",value:function e(t){var i=this.getGrid().getRows().getById(t.getField("ID"));if(i){d.Dom.remove(i.getNode());this.getGrid().getRows().reset()}var r=this.products.indexOf(t);if(r>-1){this.products.splice(r,1);this.refreshSortFields();this.numerateRows()}n.EventEmitter.emit("Grid::thereEditedRows",[]);this.addFirstRowIfEmpty();this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"copyRow",value:function e(t){this.addProductRow(t);this.refreshSortFields();this.numerateRows();n.EventEmitter.emit("Grid::thereEditedRows",[]);this.executeActions([{type:this.actions.productListChanged},{type:this.actions.updateTotal}])}},{key:"cleanProductRows",value:function e(){var t=this;this.products.filter((function(e){return e.isEmptyRow()})).forEach((function(e){return t.deleteRow(e)}))}},{key:"resortProductsByIds",value:function e(t){var i=false;if(d.Type.isArrayFilled(t)){this.products.sort((function(e,r){if(t.indexOf(e.getField("ID"))>t.indexOf(r.getField("ID"))){return 1}i=true;return-1}))}return i}},{key:"refreshSortFields",value:function e(){this.products.forEach((function(e,t){return e.setField("SORT",(t+1)*10,false)}))}},{key:"handleOnTabShow",value:function e(){n.EventEmitter.emit("onDemandRecalculateWrapper",[this])}},{key:"closeBarcodeSpotlights",value:function e(){this.products.forEach((function(e){var t;(t=e.getBarcodeSelector())===null||t===void 0?void 0:t.removeSpotlight()}));this.setSettingValue("showBarcodeSpotlightInfo",false)}},{key:"closeBarcodeQrAuths",value:function e(){this.products.forEach((function(e){var t;(t=e.getBarcodeSelector())===null||t===void 0?void 0:t.removeQrAuth()}));this.setSettingValue("showBarcodeQrAuth",false)}},{key:"enableSendBarcodeMobilePush",value:function e(){this.products.forEach((function(e){var t;(t=e.getBarcodeSelector())===null||t===void 0?void 0:t.setConfig("IS_INSTALLED_MOBILE_APP",true)}));this.setSettingValue("isInstalledMobileApp",true)}},{key:"validate",value:function e(){if(this.getProductCount()===0){return[d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_IS_EMPTY")]}var t=[];this.products.forEach((function(e){t=t.concat(e.validate())}));return t}},{key:"showFieldTourHint",value:function e(t,i,r){var n=arguments.length>3&&arguments[3]!==undefined?arguments[3]:[];var a=arguments.length>4&&arguments[4]!==undefined?arguments[4]:"";if(this.products.length>0){var s=this.products[0].getNode();if(this.getProductByRowId(a)){s=this.getProductByRowId(a).getNode()}var o=[];var l=At(n),u;try{for(l.s();!(u=l.n()).done;){var d=u.value;var c=s.querySelector('[data-name="'.concat(d,'"]'));if(c!==null){o.push(c)}}}catch(e){l.e(e)}finally{l.f()}var h=s.querySelector('[data-name="'.concat(t,'"]'));if(h!==null){babelHelpers.classPrivateFieldGet(this,Ut).processFieldTour(h,i,r,o)}}}},{key:"getActiveHint",value:function e(){return babelHelpers.classPrivateFieldGet(this,Ut).getActiveHint()}},{key:"getRestrictedProductTypes",value:function e(){return this.getSettingValue("restrictedProductTypes",[])}},{key:"processApplyActionButtonClick",value:function e(t){if(t==="STORE_FROM_INFO"||t==="STORE_TO_INFO"){wt(this,xt,jt).call(this,t)}}}]);return e}();function Xt(){this.getGrid()._clickOnRowActionsButton=function(){}}function Wt(){return this.products.filter((function(e){return e.getModel().getErrorCollection().hasErrors()})).length>0}function qt(){return["ID","SKU_ID","AMOUNT","PURCHASING_PRICE","BASE_PRICE","BASE_PRICE_EXTRA","BASE_PRICE_EXTRA_RATE","COMMENT","DOC_BARCODE","BARCODE","STORE_TO","STORE_FROM","BASE_PRICE_ID","BASKET_ID","DOC_ID","ELEMENT_ID","IBLOCK_ID","MEASURE_CODE","MEASURE_NAME","NAME","OFFERS_IBLOCK_ID","PARENT_PRODUCT_ID","PRODUCT_ID","ROW_ID","STORE_FROM_AMOUNT","STORE_FROM_AVAILABLE_AMOUNT","STORE_FROM_RESERVED","STORE_FROM_TITLE","STORE_TO_AMOUNT","STORE_TO_AVAILABLE_AMOUNT","STORE_TO_RESERVED","STORE_TO_TITLE","TOTAL_PRICE","TYPE","PRICE","TAX_RATE","TAX_INCLUDED","TAX_SUM"]}function jt(e){var t,i=this;var r=(t=this.getGrid())===null||t===void 0?void 0:t.getActionsPanel();var n=r===null||r===void 0?void 0:r.getValues();var a=n[e];if(!n||d.Type.isUndefined(a)){return}var s=this.getGrid().getRows().getSelected();if(s.length===0){return}var l=this.getSettingValue("stores",{});var u=l[a];if(!d.Type.isNil(u)){var c=(u===null||u===void 0?void 0:u.TITLE)||"";s.forEach((function(t){var r=i.products.find((function(e){return e.getField("ID")===t.getId()}));if(r){var n=o.StoreSelector.getById(r.getId()+"_"+e);if(n){n.onStoreSelect(a,c)}}}));var h="M";var v=this.settings.documentType!==h?"CATALOG_DOCUMENT_PRODUCT_LIST_ACTION_STORE_CHANGED_HINT":"CATALOG_DOCUMENT_PRODUCT_LIST_ACTION_"+e+"_CHANGED_HINT";g.UI.Notification.Center.notify({content:d.Loc.getMessage(v,{"#STORE_NAME#":d.Text.encode(c)}),autoHide:true,autoHideDelay:4e3})}var f=r.getDropdowns().find((function(e){return e.id==="actionListId_control"}));if(f){r.removeItemsRelativeCurrent(f.parentNode);d.Dom.attr(f,"data-value",null);var p=f.querySelector(".main-dropdown-inner");if(p){p.innerText=d.Loc.getMessage("CATALOG_DOCUMENT_PRODUCT_LIST_ACTION_DEFAULT")}}}e.Editor=Vt;e.PageEventsManager=De})(this.BX.Catalog.Store.ProductList=this.BX.Catalog.Store.ProductList||{},BX.Catalog,BX.Catalog,BX.Main,BX.Event,BX.Currency,BX.Catalog,BX.Catalog,BX.Catalog.DocumentCard,BX.Catalog,BX,BX,BX.UI.Tour,BX);
//# sourceMappingURL=script.map.js