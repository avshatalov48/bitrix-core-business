{"version":3,"file":"permission.bundle.js","sources":["../src/const/action-config.js","../src/permission.js"],"sourcesContent":["import { UserRole, ActionByRole } from 'im.v2.const';\n\nexport const MinimalRoleForAction = {\n\t[ActionByRole.readMessage]: UserRole.member,\n\t[ActionByRole.setReaction]: UserRole.member,\n\t[ActionByRole.openMessageMenu]: UserRole.member,\n\t[ActionByRole.openAvatarMenu]: UserRole.member,\n\t[ActionByRole.openSidebarMenu]: UserRole.member,\n\t[ActionByRole.subscribeToComments]: UserRole.member,\n\n\t[ActionByRole.openComments]: UserRole.guest,\n\t[ActionByRole.openSidebar]: UserRole.guest,\n};\n","import { Type } from 'main.core';\n\nimport { Core } from 'im.v2.application.core';\nimport { Logger } from 'im.v2.lib.logger';\nimport { ChatType, ActionByRole, ChatActionGroup, UserRole, UserType, ActionByUserType } from 'im.v2.const';\n\nimport { MinimalRoleForAction } from './const/action-config';\n\nimport type { ImModelChat } from 'im.v2.model';\n\ntype ChatTypeItem = $Keys<typeof ChatType>;\ntype ActionTypeItem = $Keys<typeof ActionByRole>;\ntype ActionByUserTypeItem = $Keys<typeof ActionByUserType>;\ntype ActionGroupItem = $Keys<typeof ChatActionGroup>;\ntype RoleItem = $Keys<typeof UserRole>;\ntype UserTypeItem = $Keys<typeof UserType>;\n\ntype RawPermissions = {\n\tbyChatType: PermissionsByChatType,\n\tbyUserType: PermissionsByUserType,\n\tactionGroups: PermissionsActionGroups,\n\tactionGroupsDefaults: PermissionsGroupDefaults,\n};\n\ntype PermissionsByRole = {\n\t[operation: ActionTypeItem]: RoleItem,\n};\n\ntype PermissionsByChatType = {\n\t[chatType: ChatTypeItem | 'default']: {\n\t\t[operation: ActionTypeItem]: RoleItem,\n\t}\n};\n\ntype PermissionsByUserType = {\n\t[userType: UserTypeItem]: {\n\t\t[operation: ActionByUserTypeItem]: boolean,\n\t}\n};\n\ntype PermissionsGroupDefaults = {\n\t[chatType: ChatTypeItem]: {\n\t\t[group: ActionGroupItem]: RoleItem,\n\t}\n};\n\ntype PermissionsActionGroups = {\n\t[group: ActionGroupItem]: RoleItem,\n};\n\nconst DEFAULT_TYPE = 'default';\n\nexport class PermissionManager\n{\n\tstatic #instance: PermissionManager;\n\n\t#rolePermissions: PermissionsByRole = {};\n\t#chatTypePermissions: PermissionsByChatType = {};\n\t#userTypePermissions: PermissionsByUserType = {};\n\t#actionGroups: PermissionsActionGroups = {};\n\t#actionGroupsDefaultRoles: PermissionsGroupDefaults = {};\n\n\tstatic getInstance(): PermissionManager\n\t{\n\t\tif (!this.#instance)\n\t\t{\n\t\t\tthis.#instance = new this();\n\t\t}\n\n\t\treturn this.#instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tPermissionManager.getInstance();\n\t}\n\n\tconstructor()\n\t{\n\t\tconst { permissions } = Core.getApplicationData();\n\t\tLogger.warn('PermissionManager: permission from server', permissions);\n\t\tthis.#init(permissions);\n\t}\n\n\tcanPerformActionByRole(actionType: ActionTypeItem, dialogId: string): boolean\n\t{\n\t\treturn this.#canPerformActionByRole(actionType, dialogId)\n\t\t\t&& this.#canPerformActionByChatType(actionType, dialogId)\n\t\t\t&& this.#canPerformActionByChatSettings(actionType, dialogId);\n\t}\n\n\tcanPerformActionByUserType(actionType: ActionByUserTypeItem): boolean\n\t{\n\t\tconst externalUserType = this.#getUserType(Core.getUserId());\n\t\tconst userPermissions = this.#userTypePermissions[externalUserType];\n\t\tif (!actionType || !userPermissions)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst action = ActionByUserType[actionType];\n\n\t\treturn userPermissions[action] ?? true;\n\t}\n\n\tgetDefaultRolesForActionGroups(chatType?: ChatTypeItem): Object<ActionGroupItem, RoleItem>\n\t{\n\t\tif (!this.#actionGroupsDefaultRoles[chatType])\n\t\t{\n\t\t\treturn this.#actionGroupsDefaultRoles[DEFAULT_TYPE];\n\t\t}\n\n\t\treturn this.#actionGroupsDefaultRoles[chatType];\n\t}\n\n\t#init(rawPermissions: RawPermissions)\n\t{\n\t\tthis.#rolePermissions = MinimalRoleForAction;\n\t\tif (!rawPermissions)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tconst { byChatType, byUserType, actionGroups, actionGroupsDefaults } = rawPermissions;\n\t\tthis.#chatTypePermissions = this.#prepareChatTypePermissions(byChatType);\n\t\tthis.#userTypePermissions = byUserType;\n\t\tthis.#actionGroups = actionGroups;\n\t\tthis.#actionGroupsDefaultRoles = actionGroupsDefaults;\n\t}\n\n\t#canPerformActionByRole(actionType, dialogId): boolean\n\t{\n\t\tconst { role: userRole }: ImModelChat = this.#getDialog(dialogId);\n\t\tif (Type.isUndefined(this.#rolePermissions[actionType]))\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst minimalRole = this.#rolePermissions[actionType];\n\n\t\treturn this.#checkMinimalRole(minimalRole, userRole);\n\t}\n\n\t#canPerformActionByChatType(rawActionType: ActionTypeItem, dialogId: string): boolean\n\t{\n\t\tlet actionType = rawActionType;\n\t\tconst dialog: ImModelChat = this.#getDialog(dialogId);\n\t\tconst { role: userRole, ownerId } = dialog;\n\t\tlet { type: chatType } = dialog;\n\n\t\tif (Type.isUndefined(this.#chatTypePermissions[chatType]))\n\t\t{\n\t\t\tchatType = DEFAULT_TYPE;\n\t\t}\n\n\t\tactionType = this.#handleKickAndLeaveActionType(actionType, ownerId);\n\n\t\tif (Type.isUndefined(this.#chatTypePermissions[chatType]?.[actionType]))\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst minimalRole = this.#chatTypePermissions[chatType][actionType];\n\n\t\treturn this.#checkMinimalRole(minimalRole, userRole);\n\t}\n\n\t#canPerformActionByChatSettings(actionType: ActionTypeItem, dialogId: string): boolean\n\t{\n\t\tconst { role: userRole, type: chatType, permissions: chatPermissions } = this.#getDialog(dialogId);\n\t\tif (chatType === ChatType.user)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tconst actionGroup = this.#getGroupByAction(actionType);\n\t\tif (!actionGroup)\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\tlet minimalRoleForGroup = chatPermissions[actionGroup];\n\t\tif (!minimalRoleForGroup)\n\t\t{\n\t\t\tminimalRoleForGroup = UserRole.member;\n\t\t}\n\n\t\treturn this.#checkMinimalRole(minimalRoleForGroup, userRole);\n\t}\n\n\t#getGroupByAction(actionType: ActionTypeItem): ?ActionGroupItem\n\t{\n\t\tconst searchResult = Object.entries(this.#actionGroups).find(([_, groupActions]) => {\n\t\t\treturn groupActions.includes(actionType);\n\t\t});\n\n\t\tif (!searchResult)\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tconst [groupName] = searchResult;\n\n\t\treturn groupName;\n\t}\n\n\t#prepareChatTypePermissions(permissionsByChatType: PermissionsByChatType): PermissionsByChatType\n\t{\n\t\tconst preparedPermissions = { ...permissionsByChatType };\n\n\t\tconst SERVER_USER_CHAT_TYPE = 'private';\n\t\tpreparedPermissions[ChatType.user] = preparedPermissions[SERVER_USER_CHAT_TYPE];\n\n\t\treturn preparedPermissions;\n\t}\n\n\t#checkMinimalRole(minimalRole: RoleItem, roleToCheck: RoleItem): boolean\n\t{\n\t\tif (minimalRole === UserRole.none)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst roleWeights = {};\n\t\tObject.values(UserRole).forEach((role, index) => {\n\t\t\troleWeights[role] = index;\n\t\t});\n\n\t\treturn roleWeights[roleToCheck] >= roleWeights[minimalRole];\n\t}\n\n\t#getDialog(dialogId: string): ImModelChat\n\t{\n\t\treturn Core.getStore().getters['chats/get'](dialogId, true);\n\t}\n\n\t#getUserType(userId: number): $Values<typeof UserType>\n\t{\n\t\treturn Core.getStore().getters['users/get'](userId, true).type;\n\t}\n\n\t#handleKickAndLeaveActionType(actionType, ownerId): ActionTypeItem\n\t{\n\t\tconst isOwner = ownerId === Core.getUserId();\n\t\t// for kick check if users can leave this type of chat\n\t\tif (actionType === ActionByRole.kick)\n\t\t{\n\t\t\treturn ActionByRole.leave;\n\t\t}\n\n\t\tif (actionType === ActionByRole.leave && isOwner)\n\t\t{\n\t\t\treturn ActionByRole.leaveOwner;\n\t\t}\n\n\t\treturn actionType;\n\t}\n}\n"],"names":["MinimalRoleForAction","ActionByRole","readMessage","UserRole","member","setReaction","openMessageMenu","openAvatarMenu","openSidebarMenu","subscribeToComments","openComments","guest","openSidebar","DEFAULT_TYPE","PermissionManager","getInstance","init","constructor","permissions","Core","getApplicationData","Logger","warn","canPerformActionByRole","actionType","dialogId","canPerformActionByUserType","externalUserType","getUserId","userPermissions","action","ActionByUserType","getDefaultRolesForActionGroups","chatType","rawPermissions","byChatType","byUserType","actionGroups","actionGroupsDefaults","role","userRole","Type","isUndefined","minimalRole","rawActionType","dialog","ownerId","type","chatPermissions","ChatType","user","actionGroup","minimalRoleForGroup","searchResult","Object","entries","find","_","groupActions","includes","groupName","permissionsByChatType","preparedPermissions","SERVER_USER_CHAT_TYPE","roleToCheck","none","roleWeights","values","forEach","index","getStore","getters","userId","isOwner","kick","leave","leaveOwner"],"mappings":"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"}