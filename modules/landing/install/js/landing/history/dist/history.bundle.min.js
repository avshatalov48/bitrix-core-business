this.BX=this.BX||{};(function(e,n,t,r,i,a){"use strict";var o="resolved";var s="pending";var c={landing:"L",designerBlock:"D"};var d=BX.Landing.Utils,u=d.scrollTo,l=d.highlight;var m=function e(n){return BX.Landing.PageObject.getInstance().blocks().then((function(t){var r=t.get(n.block);if(!r){return Promise.reject()}r.forceInit();var i=r.nodes.getBySelector(n.selector);if(!i){return Promise.reject()}return u(i.node).then(l.bind(null,i.node,e.useRangeRect)).then((function(){return i.setValue(n.params.value,false,true)}))}))};m.useRangeRect=true;var h=m;var f=m;var g=m;var v=m;v.useRangeRect=false;var p=v;var y=m;y.useRangeRect=false;var b=BX.Landing.Utils,k=b.scrollTo,B=b.highlight;function P(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);if(!t){return Promise.reject()}t.forceInit();var r=t.nodes.getBySelector(e.selector);if(!r){return Promise.reject()}return k(r.node).then((function(){return B(r.node)})).then((function(){if(r.onChangeTag){r.onChangeTag(e.params.value,true)}return true}))}))}var w=BX.Landing.Utils,C=w.scrollTo,I=w.highlight;function L(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();return C(t.node).then(I.bind(null,t.node)).then((function(){return t[e.params.direction](true)}))}))}var X=BX.Landing.Utils,H=X.scrollTo,T=X.highlight;function j(e){return i.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.params.currentBlock);return new Promise((function(e){if(t){t.forceInit()}e()})).then((function(){var n=BX.Landing.Main.getInstance();n.currentBlock=t;return i.PageObject.getInstance().view().then((function(t){n.currentArea=t.contentDocument.body.querySelector('[data-landing="'.concat(e.params.lid,'"]'));n.insertBefore=e.params.insertBefore;return n.onAddBlock(e.params.code,e.block,true).then((function(e){return H(e).then(T.bind(null,e,false,false))}))}))}))}))}var S=BX.Landing.Utils,E=S.scrollTo,O=S.highlight;function U(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();return E(t.node).then((function(){O(t.node);return t.deleteBlock(true)}))}))}var R=BX.Landing.Utils,A=R.scrollTo,N=R.highlight;function W(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);if(t){t.forceInit()}if(!t){return Promise.reject()}var r=t.node.querySelector(e.params.selector).parentNode;return A(r).then((function(){return t.addCard({index:e.params.position,container:r,content:e.params.content,selector:e.params.selector},true).then((function(){var n=e.params.selector+"@"+e.params.position;var r=t.cards.getBySelector(n);if(!r){return Promise.reject()}return N(r.node)}))}))}))["catch"]((function(e){console.log("Error in history action addCard",e)}))}var D=BX.Landing.Utils,F=D.scrollTo,M=D.highlight;function x(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();if(!t){return Promise.reject()}var r=e.params.selector+"@"+(e.params.position+1);var i=t.cards.getBySelector(r);if(!i){return Promise.reject()}return F(i.node).then(M.bind(null,i.node)).then((function(){return t.removeCard(r,true)}))}))}function q(e){var n=this;return new Promise((function(t,r){var i=e.params.tags||{};top.BX.onCustomEvent(n,"Landing:onHistoryAddNode",[i]);t()}))}function V(e){var n=this;return new Promise((function(t,r){var i=e.params.tags||{};top.BX.onCustomEvent(n,"Landing:onHistoryRemoveNode",[i]);t()}))}var z=BX.Landing.Utils,G=z.scrollTo,J=z.slice;function K(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);if(!t){return Promise.reject()}t.forceInit();t.initStyles();return t})).then((function(e){return G(e.node).then((function(){return e}))})).then((function(n){var t=J(n.node.querySelectorAll(e.selector));if(e.params.isWrapper){t=[n.content];e.selector+=" > :first-child"}t.forEach((function(n,t){if(e.params.position>=0&&e.params.position!==t){return}n.className=e.params.value.className;if(e.params.value.style&&e.params.value.style!==""){n.style=e.params.value.style}else{n.removeAttribute("style")}}));return n})).then((function(n){var t=n.forms.find((function(n){return n.selector===e.selector||n.relativeSelector===e.selector}));if(t){t.fields.forEach((function(e){e.reset();e.onFrameLoad()}))}var r=n.styles.find((function(n){return n.selector===e.selector||n.relativeSelector===e.selector}));if(r){if(e.params.affect&&e.params.affect.length>0){r.setAffects(e.params.affect)}n.onStyleInputWithDebounce({node:r.node,data:r.getValue()},true)}}))}var Q=BX.Landing.Utils,Y=Q.scrollTo,Z=Q.highlight;function $(e){return i.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);return new Promise((function(e,n){if(t){t.forceInit();e(t)}else{n()}})).then((function(n){return Y(n.node).then((function(){return n.applyAttributeChanges(babelHelpers.defineProperty({},e.params.selector,{attrs:babelHelpers.defineProperty({},e.params.attribute,e.params.value)}))})).then(Z.bind(null,n.node,false,false))}))}))}var _=function e(n){babelHelpers.classCallCheck(this,e);this.block=n.block;this.selector=n.selector;this.command=t.Type.isStringFilled(n.command)?n.command:"#invalidCommand";this.params=n.params};var ee=BX.Landing.Utils,ne=ee.scrollTo,te=ee.highlight;var re=function e(n){return BX.Landing.PageObject.getInstance().blocks().then((function(e){var t=e.get(n.block);if(!t){return Promise.reject()}t.forceInit();if(!t.node){return Promise.reject()}return ne(t.node).then((function(){return t.applyAttributeChanges(babelHelpers.defineProperty({},n.params.selector,{attrs:n.params.value}),true)})).then(t.reload.bind(t)).then(te.bind(null,t.node,false,false))}))};var ie=BX.Landing.Utils,ae=ie.scrollTo,oe=ie.highlight;function se(e){return BX.Landing.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.block);t.forceInit();return ae(t.node).then((function(){void oe(t.node);return t.updateContent(e.params.content,true)}))}))}var ce=BX.Landing.Utils,de=ce.scrollTo,ue=ce.highlight;function le(e){var n=null;var t={};e.params.forEach((function(e){if(!n&&e.params.block){n=e.params.block}if(e.command==="editText"||e.command==="editImage"||e.command==="editEmbed"||e.command==="editMap"||e.command==="editIcon"||e.command==="editLink"){t[e.params.selector]=e.params.value}if(e.command==="updateDynamic"){t.dynamicParams=e.params.dynamicParams;t.dynamicState=e.params.dynamicState}if(e.command==="changeAnchor"){t.settings={id:e.params.value}}}));return BX.Landing.PageObject.getInstance().blocks().then((function(e){var r=e.get(n);if(r){r.forceInit();return de(r.node).then((function(){void ue(r.node);if(Object.keys(t).length>0){r.updateBlockState(t,true)}}))}}))}var me=BX.Landing.Utils,he=me.scrollTo,fe=me.highlight;function ge(e){return new Promise((function(e,n){top.window.location.reload();e()}))}var ve=BX.Landing.Utils,pe=ve.scrollTo,ye=ve.highlight;function be(e){return i.PageObject.getInstance().blocks().then((function(n){var t=n.get(e.params.currentBlock);return new Promise((function(e,n){if(t){t.forceInit();e(t)}else{n()}})).then((function(e){pe(e).then(ye.bind(null,e,false,false))}))}))}var ke=function e(n){babelHelpers.classCallCheck(this,e);this.id=t.Type.isStringFilled(n.id)?n.id:"#invalidCommand";this.command=t.Type.isFunction(n.command)?n.command:function(){};this.onBeforeCommand=t.Type.isFunction(n.onBeforeCommand)?n.onBeforeCommand:function(){return Promise.resolve()}};var Be;function Pe(e){e.registerCommand(new ke({id:"editText",command:h}));e.registerCommand(new ke({id:"editImage",command:v}));e.registerCommand(new ke({id:"editEmbed",command:f}));e.registerCommand(new ke({id:"editMap",command:g}));e.registerCommand(new ke({id:"editIcon",command:p}));e.registerCommand(new ke({id:"editLink",command:y}));e.registerCommand(new ke({id:"cnangeNodeName",command:P}));e.registerCommand(new ke({id:"sortBlock",command:L}));e.registerCommand(new ke({id:"addBlock",command:j}));e.registerCommand(new ke({id:"removeBlock",command:U}));e.registerCommand(new ke({id:"updateStyle",command:K}));e.registerCommand(new ke({id:"addCard",command:W}));e.registerCommand(new ke({id:"removeCard",command:x}));e.registerCommand(new ke({id:"addNode",command:q}));e.registerCommand(new ke({id:"removeNode",command:V}));e.registerCommand(new ke({id:"updateContent",command:se}));e.registerCommand(new ke({id:"replaceLanding",command:ge,onBeforeCommand:function e(){return t.Runtime.loadExtension("main.loader").then((function(){var e=BX.Landing.PageObject.getEditorWindow();if(e){var n=t.Tag.render(Be||(Be=babelHelpers.taggedTemplateLiteral(['<div class="landing-ui-modal"></div>'])));t.Dom.append(n,e.document.body);var r=new BX.Loader({target:n});r.show()}return Promise.resolve()}))}}));e.registerCommand(new ke({id:"changeAnchor",command:be}));e.registerCommand(new ke({id:"editAttributes",command:$}));e.registerCommand(new ke({id:"editComponent",command:re}));e.registerCommand(new ke({id:"multiply",command:le}));return Promise.resolve(e)}var we=new Worker("/bitrix/js/landing/history/src/worker/json-parse-worker.js");function Ce(e){return new Promise((function(n){we.postMessage(e);we.addEventListener("message",(function(e){n(e.data)}))}))}var Ie=new Worker("/bitrix/js/landing/history/src/worker/json-stringify-worker.js");function Le(e){return new Promise((function(n){Ie.postMessage(e);Ie.addEventListener("message",(function(e){n(e.data)}))}))}function Xe(e,n){return Ce(window.localStorage.history).then((function(e){return t.Type.isPlainObject(e)?e:{}})).then((function(n){if(e in n){delete n[e]}return n})).then(Le).then((function(e){window.localStorage.history=e;return n}))}function He(e){e.stack=null;e.commandState=o;return Promise.resolve(e)}function Te(e){var n=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(n.window,"BX.Landing.History:update",[e]);return Promise.resolve(e)}function je(e){var n=BX.Landing.PageObject.getRootWindow();BX.onCustomEvent(n.window,"BX.Landing.History:init",[e]);return Promise.resolve(e)}function Se(e,n){Ee(e,n);n.add(e)}function Ee(e,n){if(n.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function Oe(e,n,t){if(!n.has(e)){throw new TypeError("attempted to get private field on non-instance")}return t}var Ue=new WeakSet;var Re=new WeakSet;var Ae=new WeakSet;var Ne=new WeakSet;var We=new WeakSet;var De=function(){function e(n){var t=arguments.length>1&&arguments[1]!==undefined?arguments[1]:c.landing;babelHelpers.classCallCheck(this,e);Se(this,We);Se(this,Ne);Se(this,Ae);Se(this,Re);Se(this,Ue);babelHelpers.defineProperty(this,"items",[]);babelHelpers.defineProperty(this,"entitySteps",{});this.mainEntityId=n;this.entityType=t}babelHelpers.createClass(e,[{key:"init",value:function e(){return Oe(this,Ue,Fe).call(this).then(Oe(this,Ne,qe).bind(this))}},{key:"reload",value:function e(){this.items=[];this.step=0;return Oe(this,Ue,Fe).call(this)}},{key:"setTypeDesignerBlock",value:function e(n){this.mainEntityId=n;this.entityType=c.designerBlock;return this.reload()}},{key:"getCommandName",value:function e(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var t=n?this.step:this.step+1;t--;return this.items[t]?this.items[t].command:null}},{key:"getCommandEntityId",value:function e(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var t=n?this.step:this.step+1;t--;return this.items[t]?this.items[t].entityId:null}},{key:"canUndo",value:function e(){return this.step>0&&this.step<=this.items.length}},{key:"canRedo",value:function e(){return this.step>=0&&this.step<this.items.length}},{key:"offset",value:function e(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;var t=n?this.step-1:this.step+1;if(t>=0&&t<=this.items.length){this.step=t}return Promise.resolve()}},{key:"push",value:function e(){var n=this;return new Promise((function(e){setTimeout((function(){if(n.step<n.items.length){n.items=n.items.slice(0,n.step-1)}n.step++;n.items.push(n.items[n.step-1]);return n.reload().then(e)}),500)}))}}]);return e}();function Fe(){var e=this;return BX.Landing.Backend.getInstance().action(Oe(this,Re,Me).call(this),Oe(this,Ae,xe).call(this)).then((function(n){var r=t.Type.isArray(n.stack)?n.stack:[];r.forEach((function(n){if(n.entityId&&t.Type.isNumber(n.entityId)&&n.command&&t.Type.isString(n.command)){e.items.push({entityId:n.entityId,command:n.command});if(n.current&&n.current===true){e.entitySteps[n.entityId]=e.items.length}}}));var i=t.Text.toNumber(n.step);e.step=Math.min(e.items.length,i);e.step=Math.max(0,e.step)}))["catch"]((function(e){console.error("History load error",e);return history}))}function Me(){if(this.entityType===c.designerBlock){return"History::getForDesignerBlock"}return"History::getForLanding"}function xe(){if(this.entityType===c.designerBlock){return{blockId:this.mainEntityId}}return{lid:this.mainEntityId}}function qe(){var e=this;var n=this.items[this.step-1];if(n&&this.entityType===c.landing&&Oe(this,We,Ve).call(this)){var t=[];this.items.forEach((function(r,i){var a=i+1;if(a>=e.step){return}if(r.entityId!==n.entityId&&e.entitySteps[r.entityId]<a){t.push(r.entityId)}}));if(t.length>0){var i=r.Backend.getInstance();var a=[];t.forEach((function(e){a.push(i.action("History::clearFutureForLanding",{landingId:e}))}));return Promise.all(a).then(this.reload.bind(this))}}return Promise.resolve()}function Ve(){return Object.keys(this.entitySteps).length>1}var ze=function(e){babelHelpers.inherits(n,e);function n(){var e;babelHelpers.classCallCheck(this,n);e=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));e.layout.classList.add("landing-ui-highlight-animation");e.animationDuration=300;return e}babelHelpers.createClass(n,[{key:"show",value:function e(n,t){var r=this;BX.Landing.UI.Highlight.prototype.show.call(this,n,t);return new Promise((function(e){setTimeout(e,r.animationDuration);r.hide()}))}}],[{key:"getInstance",value:function e(){var t=i.PageObject.getRootWindow();if(!t.BX.Landing.History.Highlight.instance){t.BX.Landing.History.Highlight.instance=new n}return t.BX.Landing.History.Highlight.instance}}]);return n}(a.Highlight);var Ge=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"stack",null);babelHelpers.defineProperty(this,"commands",{});babelHelpers.defineProperty(this,"commandState",o);babelHelpers.defineProperty(this,"entityType",c.landing);try{this.entityId=n.Main.getInstance().id}catch(e){this.entityId=-1}this.stack=new De(this.entityId);this.stack.init().then((function(){return Pe(t)})).then(je)}babelHelpers.createClass(e,[{key:"setTypeDesignerBlock",value:function e(n){var t=this;this.entityType=c.designerBlock;this.entityId=n;return this.stack.setTypeDesignerBlock(n).then((function(){return t}))}},{key:"getEntityId",value:function e(){return this.entityId}},{key:"beforeUndo",value:function e(){var n=this.stack.getCommandName();if(n&&this.commands[n]){var t=this.commands[n];return t.onBeforeCommand()}return Promise.resolve()}},{key:"beforeRedo",value:function e(){var n=this.stack.getCommandName(false);if(n&&this.commands[n]){var t=this.commands[n];return t.onBeforeCommand()}return Promise.resolve()}},{key:"undo",value:function e(){var n=this;if(this.canUndo()){this.commandState=s;return this.beforeUndo().then((function(){return r.Backend.getInstance().action(n.getBackendActionName(true),n.getBackendActionParams(true))})).then((function(e){if(e){var t=e.params;var r=new _({block:t.block,selector:t.selector,command:e.command,params:t});return n.runCommand(r)}return Promise.reject()})).then((function(){return n.offset()})).then(Te)}return Promise.resolve(this)}},{key:"redo",value:function e(){var n=this;if(this.canRedo()){this.commandState=s;return this.beforeRedo().then((function(){return r.Backend.getInstance().action(n.getBackendActionName(false),n.getBackendActionParams(false))})).then((function(e){if(e){var t=e.params;var r=new _({block:t.block,selector:t.selector,command:e.command,params:t});return n.runCommand(r)}return Promise.reject()})).then((function(){return n.offset(false)})).then(Te)}return Promise.resolve(this)}},{key:"getBackendActionName",value:function e(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(this.entityType===c.designerBlock){return n?"History::undoDesignerBlock":"History::redoDesignerBlock"}return n?"History::undoLanding":"History::redoLanding"}},{key:"getBackendActionParams",value:function e(){var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(this.entityType===c.designerBlock){return{blockId:this.entityId}}return{lid:this.stack.getCommandEntityId(n)}}},{key:"runCommand",value:function e(n){var t=this;if(n){var r=this.commands[n.command];if(r){this.commandState=s;return r.command(n).then((function(){t.commandState=o;return t}))["catch"]((function(e){console.error("History error in command ".concat(r.id,"."),e);t.commandState=o;return t}))}}}},{key:"offset",value:function e(){var n=this;var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:true;if(this.commandState===s){return Promise.resolve(this)}return this.stack.offset(t).then((function(){return n}))}},{key:"canUndo",value:function e(){return this.commandState!==s&&this.stack.canUndo()}},{key:"canRedo",value:function e(){return this.commandState!==s&&this.stack.canRedo()}},{key:"push",value:function e(){var n=this;return this.stack.push().then((function(){return Te(n)}))}},{key:"registerCommand",value:function e(n){if(n instanceof ke){this.commands[n.id]=n}}},{key:"removePageHistory",value:function e(n){return Xe(n,this).then((function(e){var t;try{t=BX.Landing.Main.getInstance().id}catch(e){t=-1}if(t===n){return He(e)}return Promise.reject()})).then(Te)["catch"]((function(){}))}}],[{key:"getInstance",value:function e(){var n=i.PageObject.getRootWindow();if(!n.BX.Landing.History.instance){n.BX.Landing.History.instance=new BX.Landing.History}return n.BX.Landing.History.instance}}]);return e}();babelHelpers.defineProperty(Ge,"Command",ke);babelHelpers.defineProperty(Ge,"Entry",_);babelHelpers.defineProperty(Ge,"Highlight",ze);e.History=Ge})(this.BX.Landing=this.BX.Landing||{},BX.Landing,BX,BX.Landing,BX.Landing,BX.Landing.UI);
//# sourceMappingURL=history.bundle.map.js