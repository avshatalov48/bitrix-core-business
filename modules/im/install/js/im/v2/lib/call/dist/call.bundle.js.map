{"version":3,"file":"call.bundle.js","sources":["../src/classes/beta-call-service.js","../src/functions/open-call-user-selector.js","../src/call.js"],"sourcesContent":["import { runAction } from 'im.v2.lib.rest';\nimport { RestMethod } from 'im.v2.const';\n\nexport class BetaCallService\n{\n\tstatic createRoom(chatId: number)\n\t{\n\t\trunAction(RestMethod.imCallBetaCreateRoom, {\n\t\t\tdata: { chatId },\n\t\t});\n\t}\n}\n","import { Tag, Loc } from 'main.core';\nimport { Dialog, type Item } from 'ui.entity-selector';\nimport 'ui.buttons';\n\nimport { Core } from 'im.v2.application.core';\n\nexport const openCallUserSelector = (params) => {\n\tconst handleAddCLick = () => {\n\t\tconst selectedItems = dialog.getSelectedItems();\n\n\t\tconst preparedItems = prepareUser(selectedItems);\n\n\t\tparams.onSelect({ users: preparedItems });\n\t};\n\n\tconst handleCancelCLick = () => {\n\t\tdialog.hide();\n\t};\n\n\tconst dialog = new Dialog({\n\t\ttargetNode: params.bindElement,\n\t\twidth: 400,\n\t\tenableSearch: true,\n\t\tdropdownMode: true,\n\t\tcontext: 'IM_CHAT_SEARCH',\n\t\tentities: [{\n\t\t\tid: 'user',\n\t\t\tdynamicLoad: true,\n\t\t\titemOptions: {\n\t\t\t\tdefault: {\n\t\t\t\t\tlinkTitle: '',\n\t\t\t\t\tlink: '',\n\t\t\t\t},\n\t\t\t},\n\t\t\toptions: {\n\t\t\t\tinviteEmployeeLink: false,\n\t\t\t\t'!userId': Core.getUserId(),\n\t\t\t},\n\t\t\tfilters: [\n\t\t\t\t{\n\t\t\t\t\tid: 'im.userDataFilter',\n\t\t\t\t},\n\t\t\t],\n\t\t}],\n\t\tfooter: getFooter(handleAddCLick, handleCancelCLick),\n\t});\n\tdialog.show();\n\n\treturn Promise.resolve({\n\t\tclose: () => {\n\t\t\tdialog.hide();\n\t\t},\n\t});\n};\n\nconst prepareUser = (users) => {\n\treturn users.map((user: Item) => {\n\t\treturn {\n\t\t\tid: user.id,\n\t\t\tname: user.title.text,\n\t\t\tavatar: user.avatar,\n\t\t\tavatar_hr: user.avatar,\n\t\t\tgender: user.customData.get('imUser').GENDER,\n\t\t};\n\t});\n};\n\nconst getFooter = (handleAddCLick, handleCancelCLick) => {\n\tconst addButtonTitle = Loc.getMessage('IM_LIB_CALL_ADD_BUTTON');\n\tconst cancelButtonTitle = Loc.getMessage('IM_LIB_CALL_CANCEL_BUTTON');\n\n\treturn Tag.render`\n\t\t<button class=\"ui-btn ui-btn-xs ui-btn-primary\" onclick=\"${handleAddCLick}\">${addButtonTitle}</button>\n\t\t<button class=\"ui-btn ui-btn-xs ui-btn-light-border\" onclick=\"${handleCancelCLick}\">${cancelButtonTitle}</button>\n\t`;\n};\n","import { Extension } from 'main.core';\nimport { EventEmitter, BaseEvent } from 'main.core.events';\nimport { Store } from 'ui.vue3.vuex';\nimport { Controller, State as CallState } from 'call.core';\n\nimport { Messenger } from 'im.public';\nimport { Core } from 'im.v2.application.core';\nimport { MessengerSlider } from 'im.v2.lib.slider';\nimport { ChatType, RecentCallStatus, Layout, EventType, UserType } from 'im.v2.const';\nimport { Logger } from 'im.v2.lib.logger';\nimport { PromoManager } from 'im.v2.lib.promo';\nimport { SoundNotificationManager } from 'im.v2.lib.sound-notification';\n\nimport { BetaCallService } from './classes/beta-call-service';\nimport { openCallUserSelector } from './functions/open-call-user-selector';\n\nimport 'im_call_compatible';\n\nimport type { ImModelChat, ImModelUser } from 'im.v2.model';\n\nexport class CallManager\n{\n\tstatic instance: CallManager;\n\tstatic viewContainerClass: string = 'bx-im-messenger__call_container';\n\n\t#controller: Controller;\n\t#store: Store;\n\n\tstatic getInstance(): CallManager\n\t{\n\t\tif (!this.instance)\n\t\t{\n\t\t\tthis.instance = new this();\n\t\t}\n\n\t\treturn this.instance;\n\t}\n\n\tstatic init()\n\t{\n\t\tCallManager.getInstance();\n\t}\n\n\tconstructor()\n\t{\n\t\tthis.#store = Core.getStore();\n\t\tif (this.isAvailable())\n\t\t{\n\t\t\tthis.#controller = this.#getController();\n\t\t}\n\n\t\tthis.#subscribeToEvents();\n\t}\n\n\tisAvailable(): Boolean\n\t{\n\t\tconst { callInstalled } = Extension.getSettings('im.v2.lib.call');\n\n\t\treturn callInstalled === true;\n\t}\n\n\tcreateBetaCallRoom(chatId: number)\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tBetaCallService.createRoom(chatId);\n\t}\n\n\tstartCall(dialogId: string, withVideo: boolean = true)\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tLogger.warn('CallManager: startCall', dialogId, withVideo);\n\t\tif (this.#isUser(dialogId))\n\t\t{\n\t\t\tthis.#prepareUserCall(dialogId);\n\t\t}\n\t\tthis.#controller.startCall(dialogId, withVideo);\n\t}\n\n\tjoinCall(callId: string, withVideo: boolean = true)\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tLogger.warn('CallManager: joinCall', callId, withVideo);\n\t\tthis.#controller.joinCall(callId, withVideo);\n\t}\n\n\tleaveCurrentCall()\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tLogger.warn('CallManager: leaveCurrentCall');\n\t\tthis.#controller.leaveCurrentCall();\n\t}\n\n\tonJoinFromRecentItem()\n\t{\n\t\tthis.#controller.closeCallNotification();\n\t}\n\n\tdeleteRecentCall(dialogId: string)\n\t{\n\t\tthis.#store.dispatch('recent/calls/deleteActiveCall', {\n\t\t\tdialogId,\n\t\t});\n\t}\n\n\tfoldCurrentCall()\n\t{\n\t\tif (!this.isAvailable() || !this.#controller.hasActiveCall() || !this.#controller.hasVisibleCall())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#controller.fold();\n\t}\n\n\tunfoldCurrentCall()\n\t{\n\t\tif (!this.isAvailable() || !this.#controller.hasActiveCall())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#controller.unfold();\n\t}\n\n\tgetCurrentCallDialogId(): string\n\t{\n\t\tif (!this.isAvailable() || !this.#controller.hasActiveCall())\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\treturn this.#controller?.currentCall?.associatedEntity.id;\n\t}\n\n\tgetCurrentCall(): boolean\n\t{\n\t\tif (!this.isAvailable() || !this.#controller.hasActiveCall())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.#controller.currentCall;\n\t}\n\n\thasCurrentCall(): boolean\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.#controller.hasActiveCall();\n\t}\n\n\thasCurrentScreenSharing(): boolean\n\t{\n\t\tif (!this.isAvailable() || !this.#controller.hasActiveCall())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.#controller.currentCall.isScreenSharingStarted();\n\t}\n\n\thasVisibleCall(): boolean\n\t{\n\t\tif (!this.isAvailable() || !this.#controller.hasActiveCall())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn this.#controller.hasVisibleCall();\n\t}\n\n\tstartTest()\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#controller.test();\n\t}\n\n\ttoggleDebugFlag(debug)\n\t{\n\t\tif (!this.#controller)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#controller.debug = debug;\n\t}\n\n\tchatCanBeCalled(dialogId: string): boolean\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst callSupported = this.#checkCallSupport(dialogId);\n\t\tconst hasCurrentCall = this.#store.getters['recent/calls/hasActiveCall'](dialogId);\n\n\t\treturn callSupported && !hasCurrentCall;\n\t}\n\n\thasActiveCurrentCall(dialogId: string): boolean\n\t{\n\t\treturn this.#store.getters['recent/calls/hasActiveCall'](dialogId)\n\t\t\t&& this.getCurrentCallDialogId() === dialogId;\n\t}\n\n\thasActiveAnotherCall(dialogId: string): boolean\n\t{\n\t\treturn this.#store.getters['recent/calls/hasActiveCall']()\n\t\t\t&& !this.hasActiveCurrentCall(dialogId);\n\t}\n\n\tgetCallUserLimit(): number\n\t{\n\t\treturn BX.Call.Util.getUserLimit();\n\t}\n\n\tisChatUserLimitExceeded(dialogId: string): boolean\n\t{\n\t\treturn this.#getChatUserCounter(dialogId) > this.getCallUserLimit();\n\t}\n\n\t#getController(): Controller\n\t{\n\t\treturn new Controller({\n\t\t\tinit: true,\n\t\t\tlanguage: Core.getLanguageId(),\n\t\t\tmessengerFacade: {\n\t\t\t\tgetDefaultZIndex: () => MessengerSlider.getInstance().getZIndex(),\n\t\t\t\tisMessengerOpen: () => MessengerSlider.getInstance().isOpened(),\n\t\t\t\tisSliderFocused: () => MessengerSlider.getInstance().isFocused(),\n\t\t\t\tisThemeDark: () => false,\n\t\t\t\topenMessenger: (dialogId) => {\n\t\t\t\t\treturn Messenger.openChat(dialogId);\n\t\t\t\t},\n\t\t\t\topenHistory: (dialogId) => {\n\t\t\t\t\treturn Messenger.openChat(dialogId);\n\t\t\t\t},\n\t\t\t\topenSettings: () => {\n\t\t\t\t\treturn Messenger.openSettings();\n\t\t\t\t},\n\t\t\t\topenHelpArticle: () => {}, // TODO\n\t\t\t\tgetContainer: () => document.querySelector(`.${CallManager.viewContainerClass}`),\n\t\t\t\tgetMessageCount: () => this.#store.getters['counters/getTotalChatCounter'],\n\t\t\t\tgetCurrentDialogId: () => this.#getCurrentDialogId(),\n\t\t\t\tisPromoRequired: (promoCode: string) => {\n\t\t\t\t\treturn PromoManager.getInstance().needToShow(promoCode);\n\t\t\t\t},\n\t\t\t\trepeatSound: (soundType, timeout, force) => {\n\t\t\t\t\tSoundNotificationManager.getInstance().playLoop(soundType, timeout, force);\n\t\t\t\t},\n\t\t\t\tstopRepeatSound: (soundType) => {\n\t\t\t\t\tSoundNotificationManager.getInstance().stop(soundType);\n\t\t\t\t},\n\t\t\t\tshowUserSelector: openCallUserSelector,\n\t\t\t},\n\t\t\tevents: {\n\t\t\t\t[Controller.Events.onPromoViewed]: (event) => {\n\t\t\t\t\tconst { code } = event.getData();\n\t\t\t\t\tPromoManager.getInstance().markAsWatched(code);\n\t\t\t\t},\n\t\t\t\t[Controller.Events.onOpenVideoConference]: (event) => {\n\t\t\t\t\tconst { dialogId: chatId } = event.getData();\n\t\t\t\t\tconst dialog: ImModelChat = Core.getStore().getters['chats/get'](`chat${chatId}`, true);\n\n\t\t\t\t\treturn Messenger.openConference({ code: dialog.public?.code });\n\t\t\t\t},\n\t\t\t},\n\t\t});\n\t}\n\n\t// region call events\n\t#subscribeToEvents()\n\t{\n\t\tEventEmitter.subscribe(EventType.layout.onOpenChat, this.#onOpenChat.bind(this));\n\t\tEventEmitter.subscribe(EventType.layout.onOpenNotifications, this.foldCurrentCall.bind(this));\n\t\tEventEmitter.subscribe(EventType.call.onJoinFromRecentItem, this.onJoinFromRecentItem.bind(this));\n\n\t\tEventEmitter.subscribe('CallEvents::callCreated', this.#onCallCreated.bind(this));\n\t}\n\n\t#onCallCreated(event)\n\t{\n\t\tconst { call } = event.getData()[0];\n\t\tconst isNewCall = !this.#store.getters['recent/calls/getCallByDialog'](call.associatedEntity.id);\n\n\t\tconst state = (\n\t\t\tcall.state === CallState.Connected || call.state === CallState.Proceeding\n\t\t\t\t? RecentCallStatus.joined\n\t\t\t\t: RecentCallStatus.waiting\n\t\t);\n\n\t\tif (isNewCall)\n\t\t{\n\t\t\tcall.addEventListener(BX.Call.Event.onJoin, this.#onCallJoin.bind(this));\n\t\t\tcall.addEventListener(BX.Call.Event.onLeave, this.#onCallLeave.bind(this));\n\t\t\tcall.addEventListener(BX.Call.Event.onDestroy, this.#onCallDestroy.bind(this));\n\t\t\tthis.#store.dispatch('recent/calls/addActiveCall', {\n\t\t\t\tdialogId: call.associatedEntity.id,\n\t\t\t\tname: call.associatedEntity.name,\n\t\t\t\tcall,\n\t\t\t\tstate,\n\t\t\t});\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#store.dispatch('recent/calls/updateActiveCall', {\n\t\t\tdialogId: call.associatedEntity.id,\n\t\t\tfields: {\n\t\t\t\tname: call.associatedEntity.name,\n\t\t\t\tstate,\n\t\t\t\tcall,\n\t\t\t},\n\t\t});\n\t}\n\n\t#onCallJoin(event)\n\t{\n\t\tthis.#store.dispatch('recent/calls/updateActiveCall', {\n\t\t\tdialogId: event.call.associatedEntity.id,\n\t\t\tfields: {\n\t\t\t\tstate: RecentCallStatus.joined,\n\t\t\t},\n\t\t});\n\t}\n\n\t#onCallLeave(event)\n\t{\n\t\tthis.#store.dispatch('recent/calls/updateActiveCall', {\n\t\t\tdialogId: event.call.associatedEntity.id,\n\t\t\tfields: {\n\t\t\t\tstate: RecentCallStatus.waiting,\n\t\t\t},\n\t\t});\n\t}\n\n\t#onCallDestroy(event)\n\t{\n\t\tconst dialogId = event.call.associatedEntity.id;\n\t\tconst currentCall = this.#store.getters['recent/calls/getCallByDialog'](dialogId);\n\n\t\tif (currentCall?.call.id === event.call.id)\n\t\t{\n\t\t\tthis.#store.dispatch('recent/calls/deleteActiveCall', {\n\t\t\t\tdialogId,\n\t\t\t});\n\t\t}\n\t}\n\n\t#onOpenChat(event: BaseEvent<{dialogId: string}>)\n\t{\n\t\tconst callDialogId = this.getCurrentCallDialogId();\n\t\tconst openedChat = event.getData().dialogId;\n\t\tif (callDialogId === openedChat)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.foldCurrentCall();\n\t}\n\n\tisConference(dialogId: string): boolean\n\t{\n\t\tconst dialog: ImModelChat = this.#store.getters['chats/get'](dialogId);\n\n\t\treturn dialog.type === ChatType.videoconf;\n\t}\n\n\t#checkCallSupport(dialogId: string): boolean\n\t{\n\t\tif (!this.#pushServerIsActive() || !BX.Call.Util.isWebRTCSupported())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tconst userId = Number.parseInt(dialogId, 10);\n\n\t\treturn userId > 0 ? this.#checkUserCallSupport(userId) : this.#checkChatCallSupport(dialogId);\n\t}\n\n\t#checkUserCallSupport(userId: number): boolean\n\t{\n\t\tconst user = this.#store.getters['users/get'](userId);\n\t\tconst isBot = user.type === UserType.bot;\n\n\t\treturn (\n\t\t\tuser\n\t\t\t&& user.status !== 'guest'\n\t\t\t&& !isBot\n\t\t\t&& !user.network\n\t\t\t&& user.id !== Core.getUserId()\n\t\t\t&& Boolean(user.lastActivityDate)\n\t\t);\n\t}\n\n\t#checkChatCallSupport(dialogId: string): boolean\n\t{\n\t\tconst userCounter = this.#getChatUserCounter(dialogId);\n\n\t\treturn (userCounter > 1 || this.isConference(dialogId)) && userCounter <= this.getCallUserLimit();\n\t}\n\n\t#pushServerIsActive(): boolean\n\t{\n\t\treturn true;\n\t}\n\n\t#getCurrentDialogId(): string\n\t{\n\t\tconst layout = this.#store.getters['application/getLayout'];\n\t\tif (layout.name !== Layout.chat.name)\n\t\t{\n\t\t\treturn '';\n\t\t}\n\n\t\treturn layout.entityId;\n\t}\n\n\t#isUser(dialogId: string): boolean\n\t{\n\t\tconst dialog: ImModelChat = this.#store.getters['chats/get'](dialogId);\n\n\t\treturn dialog?.type === ChatType.user;\n\t}\n\n\t#prepareUserCall(dialogId: string)\n\t{\n\t\tif (!this.isAvailable())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tconst currentUserId = Core.getUserId();\n\t\tconst currentUser: ImModelUser = Core.getStore().getters['users/get'](currentUserId);\n\t\tconst currentCompanion: ImModelUser = Core.getStore().getters['users/get'](dialogId);\n\n\t\tthis.#controller.prepareUserCall({\n\t\t\tdialogId,\n\t\t\tuser: currentCompanion.id,\n\t\t\tuserData: {\n\t\t\t\t[currentUserId]: currentUser,\n\t\t\t\t[currentCompanion.id]: currentCompanion,\n\t\t\t},\n\t\t});\n\t}\n\n\t#getChatUserCounter(dialogId: string): number\n\t{\n\t\tconst { userCounter } = this.#store.getters['chats/get'](dialogId, true);\n\n\t\treturn userCounter;\n\t}\n\t// endregion call events\n}\n"],"names":["BetaCallService","createRoom","chatId","runAction","RestMethod","imCallBetaCreateRoom","data","openCallUserSelector","params","handleAddCLick","selectedItems","dialog","getSelectedItems","preparedItems","prepareUser","onSelect","users","handleCancelCLick","hide","Dialog","targetNode","bindElement","width","enableSearch","dropdownMode","context","entities","id","dynamicLoad","itemOptions","default","linkTitle","link","options","inviteEmployeeLink","Core","getUserId","filters","footer","getFooter","show","Promise","resolve","close","map","user","name","title","text","avatar","avatar_hr","gender","customData","get","GENDER","addButtonTitle","Loc","getMessage","cancelButtonTitle","Tag","render","CallManager","getInstance","instance","init","constructor","getStore","isAvailable","callInstalled","Extension","getSettings","createBetaCallRoom","startCall","dialogId","withVideo","Logger","warn","joinCall","callId","leaveCurrentCall","onJoinFromRecentItem","closeCallNotification","deleteRecentCall","dispatch","foldCurrentCall","hasActiveCall","hasVisibleCall","fold","unfoldCurrentCall","unfold","getCurrentCallDialogId","currentCall","associatedEntity","getCurrentCall","hasCurrentCall","hasCurrentScreenSharing","isScreenSharingStarted","startTest","test","toggleDebugFlag","debug","chatCanBeCalled","callSupported","getters","hasActiveCurrentCall","hasActiveAnotherCall","getCallUserLimit","BX","Call","Util","getUserLimit","isChatUserLimitExceeded","isConference","type","ChatType","videoconf","Controller","language","getLanguageId","messengerFacade","getDefaultZIndex","MessengerSlider","getZIndex","isMessengerOpen","isOpened","isSliderFocused","isFocused","isThemeDark","openMessenger","Messenger","openChat","openHistory","openSettings","openHelpArticle","getContainer","document","querySelector","viewContainerClass","getMessageCount","getCurrentDialogId","isPromoRequired","promoCode","PromoManager","needToShow","repeatSound","soundType","timeout","force","SoundNotificationManager","playLoop","stopRepeatSound","stop","showUserSelector","events","Events","onPromoViewed","event","code","getData","markAsWatched","onOpenVideoConference","openConference","public","EventEmitter","subscribe","EventType","layout","onOpenChat","bind","onOpenNotifications","call","isNewCall","state","CallState","Connected","Proceeding","RecentCallStatus","joined","waiting","addEventListener","Event","onJoin","onLeave","onDestroy","fields","callDialogId","openedChat","isWebRTCSupported","userId","Number","parseInt","isBot","UserType","bot","status","network","Boolean","lastActivityDate","userCounter","Layout","chat","entityId","currentUserId","currentUser","currentCompanion","prepareUserCall","userData"],"mappings":"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"}