(function(e){"use strict";(function(){BX.namespace("BX.Mail.Client.Message.List");BX.Mail.Client.Message.List=function(e){this.gridId=e.gridId;this.mailboxId=e.mailboxId;this.canMarkSpam=e.canMarkSpam;this.canDelete=e.canDelete;this.moveBtnMailIdPrefix=e.moveBtnMailIdPrefix;this.connectedMailboxesLicenseInfo=e.connectedMailboxesLicenseInfo;this.ERROR_CODE_CAN_NOT_DELETE=e.ERROR_CODE_CAN_NOT_DELETE;this.ERROR_CODE_CAN_NOT_MARK_SPAM=e.ERROR_CODE_CAN_NOT_MARK_SPAM;this.disabledClassName="js-disabled";this.userInterfaceManager=new BX.Mail.Client.Message.List.UserInterfaceManager(e);this.userInterfaceManager.reloadGrid=this.reloadGrid.bind(this);this.userInterfaceManager.resetGridSelection=this.resetGridSelection.bind(this);this.userInterfaceManager.isSelectedRowsHaveClass=this.isSelectedRowsHaveClass.bind(this);this.userInterfaceManager.getGridInstance=this.getGridInstance.bind(this);this.cache={};this.addEventHandlers();BX.Mail.Client.Message.List[e.id]=this};BX.Mail.Client.Message.List.prototype={addEventHandlers:function e(){BX.ajax.UpdatePageData=function(){};BX.addCustomEvent("onSubMenuShow",function(){var e=this.getMenuWindow().getPopupWindow().getPopupContainer();var t=null;if(e){t=BX.data(e,"grid-row-id")}BX.data(this.getSubMenu().getPopupWindow().getPopupContainer(),"grid-row-id",this.gridRowId||t)});BX.Event.EventEmitter.subscribe("BX.Main.Menu.Item:onmouseenter",function(e){var t=e.target;if(!t.dataset||!t.getMenuWindow()){return}var n=t.getMenuWindow();var i=n.getMenuItems();var s=t.dataset.path;var a=t.dataset.dirMd5;var r=t.dataset.hasChild;if(!r){return}for(var o=0;o<i.length;o++){var d=i[o];if(d.getId()===s){var l=d.hasSubMenu();if(l){d.showSubMenu();var u=d.getSubMenu();if(u){var c=u.getMenuItems();var g=false;for(var h=0;h<c.length;h++){var f=c[h];if(f.getId()==="loading"){g=true}}}if(!g){return}}this.loadLevelMenu(d,a)}}}.bind(this));var t=document.querySelectorAll(".ical-event-control-menu");for(var n=0;n<t.length;n++){t[n].addEventListener("click",this.showICalMenuDropdown.bind(this))}BX.bindDelegate(document.body,"click",{className:"ical-event-control-button"},this.onClickICalButton.bind(this))},loadLevelMenu:function e(t,n){var i=this.getCache(t.getId());var s=BX.Main.PopupManager.getPopupById("menu-popup-popup-submenu-"+t.getId());if(s){s.destroy()}if(i){t.destroySubMenu();t.addSubMenu(i);t.showSubMenu();return}var a={id:"loading",text:BX.message("MAIL_CLIENT_BUTTON_LOADING"),disabled:true};t.destroySubMenu();t.addSubMenu([a]);t.showSubMenu();BX.ajax.runComponentAction("bitrix:mail.client.config.dirs","level",{mode:"class",data:{mailboxId:this.mailboxId,dir:{path:t.getId(),dirMd5:n}}}).then(function(e){var n=e.data.dirs;var i=[];for(var s=0;s<n.length;s++){var a=/(HasChildren)/i.test(n[s].FLAGS);var r={id:n[s].PATH,text:n[s].NAME,dataset:{path:n[s].PATH,dirMd5:n[s].DIR_MD5,isDisabled:n[s].IS_DISABLED,hasChild:a},items:a?[{id:"loading",text:BX.message("MAIL_CLIENT_BUTTON_LOADING"),disabled:true}]:[]};i.push(r)}this.setCache(t.getId(),i);var o=BX.Main.PopupManager.getPopupById("menu-popup-popup-submenu-"+t.getId());var d=t.getMenuWindow().getPopupWindow().isShown();if(o){o.destroy()}if(d){t.destroySubMenu();t.addSubMenu(i);t.showSubMenu()}}.bind(this),function(e){}.bind(this))},showLicensePopup:function e(t){B24.licenseInfoPopup.show(t,BX.message("MAIL_MAILBOX_LICENSE_CONNECTED_MAILBOXES_LIMIT_TITLE"),this.connectedMailboxesLicenseInfo)},onCrmClick:function e(t){var n=this.getGridInstance().getRows().getSelected();var i=t?this.getGridInstance().getRows().getById(t):n[0];if(!(i&&i.node)){return}var s=this.userInterfaceManager.isAddToCrmActionAvailable(i.node);var a=i.node.querySelector("[data-message-id]");if(!(a.dataset&&a.dataset.messageId)){return}this.resetGridSelection();if(s){if(babelHelpers.typeof(this.isAddingToCrmInProgress)!=="object"){this.isAddingToCrmInProgress={}}if(this.isAddingToCrmInProgress[t]===true){return}this.isAddingToCrmInProgress[t]=true;BX.ajax.runComponentAction("bitrix:mail.client","createCrmActivity",{mode:"ajax",data:{messageId:a.dataset.messageId},analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings([i])}}).then(function(e,t){this.isAddingToCrmInProgress[e]=false;this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_ADDED_TO_CRM"));this.userInterfaceManager.onBindingCreated()}.bind(this,t),function(e){this.isAddingToCrmInProgress[t]=false;if(e.errors&&e.errors.length>0){this.notify(e.errors.map(function(e){return e.message}).join("<br>"),5e3)}else{this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_ADD_TO_CRM_ERROR"))}}.bind(this))}else{BX.ajax.runComponentAction("bitrix:mail.client","removeCrmActivity",{mode:"ajax",data:{messageId:a.dataset.messageId},analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings([i])}}).then(function(e){this.userInterfaceManager.onCrmBindingDeleted(e.dataset.messageId);this.notify(BX.message("MAIL_MESSAGE_LIST_NOTIFY_EXCLUDED_FROM_CRM"))}.bind(this,a))}},onViewClick:function e(t){if(t===undefined&&this.getGridInstance().getRows().getSelectedIds().length===0){return}BX.SidePanel.Instance.open("/mail/message/"+t,{width:1080,loader:"view-mail-loader"})},onDeleteClick:function e(t){var n=this.getGridInstance().getRows().getSelected();if(t===undefined&&n.length===0){return}if(!this.canDelete){this.showDirsSlider();return}var i={analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings(t?[this.getGridInstance().getRows().getById(t)]:n)},onSuccess:function e(){this.reloadGrid({})}};if(t!==undefined){i.ids=[t]}if(this.userInterfaceManager.isCurrentFolderTrash){var s=this.getConfirmDeletePopup(i);s.show()}else{this.runAction("delete",i)}},onMoveToFolderClick:function e(t){var n=t.currentTarget.dataset;var i=null;var s=BX.findParent(t.currentTarget,{className:"popup-window"});if(s){i=BX.data(s,"grid-row-id")}var a=JSON.parse(n.isDisabled);var r=n.path;if(i===null&&this.getGridInstance().getRows().getSelectedIds().length===0||a){return}var o=this.getGridInstance().getRows().getSelected();var d=i?[i]:this.getGridInstance().getRows().getSelectedIds();d=this.filterRowsByClassName(this.disabledClassName,d,true);if(!d.length){return}this.resetGridSelection();this.runAction("moveToFolder",{ids:d,params:{folder:r},analyticsLabel:{groupCount:o.length,bindings:this.getRowsBindings(i?[this.getGridInstance().getRows().getById(i)]:o)}})},onReadClick:function e(t){var n=this.getGridInstance().getRows().getSelected();if(t===undefined&&n.length===0){return}var i="all"==t||this.isSelectedRowsHaveClass("mail-msg-list-cell-unseen",t)?"markAsSeen":"markAsUnseen";var s=this.filterRowsByClassName("mail-msg-list-cell-unseen",t,i!=="markAsSeen");s=this.filterRowsByClassName(this.disabledClassName,s,true);if(!s.length){return}var a=function e(){this.userInterfaceManager.onMessagesRead(s,{action:i});if(i==="markAsSeen"){var a=s.length;if("all"==t){a=Math.max(this.userInterfaceManager.getQuickFilterUnseenCounter(),a)}this.userInterfaceManager.updateUnreadCounters(-a)}else{this.userInterfaceManager.updateUnreadCounters(s.length)}this.resetGridSelection();if("all"==t){s["for_all"]=this.mailboxId+"-"+this.userInterfaceManager.getCurrentFolder()}this.runAction(i,{ids:s,keepRows:true,successParams:i,analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings(t?[this.getGridInstance().getRows().getById(t)]:n)},onSuccess:false});return true};if("all"==t){BX.UI.Dialogs.MessageBox.show({title:BX.message("MAIL_MESSAGE_LIST_CONFIRM_TITLE"),message:BX.message("MAIL_MESSAGE_LIST_CONFIRM_READ_ALL"),onYes:a.bind(this),buttons:BX.UI.Dialogs.MessageBoxButtons.YES_CANCEL})}else{a.apply(this)}},onSpamClick:function e(t){var n=this.getGridInstance().getRows().getSelected();if(t===undefined&&n.length===0){return}if(!this.canMarkSpam){this.showDirsSlider();return}var i=this.isSelectedRowsHaveClass("js-spam",t)?"restoreFromSpam":"markAsSpam";var s=this.filterRowsByClassName("js-spam",t,i!=="restoreFromSpam");s=this.filterRowsByClassName(this.disabledClassName,s,true);if(!s.length){return}var a={analyticsLabel:{groupCount:n.length,bindings:this.getRowsBindings(t?[this.getGridInstance().getRows().getById(t)]:n)},onSuccess:function e(){this.reloadGrid({})}};if(t!==undefined){a.ids=[t]}this.runAction(i,a)},getConfirmDeletePopup:function e(t){return new BX.UI.Dialogs.MessageBox({title:BX.message("MAIL_MESSAGE_LIST_CONFIRM_TITLE"),message:BX.message("MAIL_MESSAGE_LIST_CONFIRM_DELETE"),buttons:[new BX.UI.Button({color:BX.UI.Button.Color.DANGER,text:BX.message("MAIL_MESSAGE_LIST_CONFIRM_DELETE_BTN"),onclick:function(e){this.runAction("delete",t);e.getContext().close()}.bind(this)}),new BX.UI.CancelButton({onclick:function e(t){t.getContext().close()}})]})},resetGridSelection:function e(){this.getGridInstance().getRows().unselectAll();this.getGridInstance().adjustCheckAllCheckboxes();BX.onCustomEvent("Grid::updated")},isSelectedRowsHaveClass:function e(t,n){var i=this.getGridInstance().getRows().getSelectedIds();var s=i.length?i:n?[n]:[];for(var a=0;a<s.length;a++){var r=this.getGridInstance().getRows().getById(s[a]);if(r&&r.node){var o=r.node.getElementsByClassName(t);if(o&&o.length){return true}}}return false},filterRowsByClassName:function e(t,n,i){var s=[];if("all"==n){s=this.getGridInstance().getRows().getBodyChild().map(function(e){return e.getId()})}else if(Array.isArray(n)){s=n}else{var a=this.getGridInstance().getRows().getSelectedIds();s=a.length?a:n?[n]:[]}var r=[];for(var o=s.length-1;o>=0;o--){var d=this.getGridInstance().getRows().getById(s[o]);if(d&&d.node){var l=d.node.getElementsByClassName(t);if(!i&&l&&l.length){r.push(s[o])}else if(i&&!(l&&l.length)){r.push(s[o])}}}return r},notify:function e(t,n){top.BX.UI.Notification.Center.notify({autoHideDelay:n>0?n:2e3,content:t?t:BX.message("MAIL_MESSAGE_LIST_NOTIFY_SUCCESS")})},runAction:function e(t,n){n=n?n:{};var i=this.getGridInstance().getRows().getSelectedIds();if(n.ids){i=n.ids}if(!i.length&&!i.for_all){return}if(!n.keepRows){this.getGridInstance().tableFade()}var s={ids:i};if(n.params){var a=Object.keys(Object(n.params));for(var r=0,o=a.length;r<o;r++){var d=a[r];var l=Object.getOwnPropertyDescriptor(n.params,d);if(l!==undefined&&l.enumerable){s[d]=n.params[d]}}}BX.ajax.runComponentAction("bitrix:mail.client",t,{mode:"ajax",data:s,analyticsLabel:n.analyticsLabel}).then(function(e){if(n.onSuccess===false){return}if(n.onSuccess&&typeof n.onSuccess==="function"){n.onSuccess.bind(this,i,n.successParams)();return}this.onSuccessRequest(e,t)}.bind(this),function(e){n.onError&&typeof n.onError==="function"?n.onError().bind(this,e):this.onErrorRequest(e)}.bind(this))},onErrorRequest:function e(t){var n={};this.checkErrorRights(t.errors);n.errorMessage=t.errors[0].message;this.reloadGrid(n)},checkErrorRights:function e(t){for(var n=0;n<t.length;n++){if(t[n].code===this.ERROR_CODE_CAN_NOT_DELETE){this.canDelete=false}if(t[n].code===this.ERROR_CODE_CAN_NOT_MARK_SPAM){this.canMarkSpam=false}}},onSuccessRequest:function e(t,n){this.notify();this.reloadGrid({})},reloadGrid:function e(t){var n=this.getGridInstance();if(n){t.apply_filter="Y";n.reloadTable("POST",t)}},showDirsSlider:function e(){var t=BX.util.add_url_param("/mail/config/dirs",{mailboxId:this.mailboxId});BX.SidePanel.Instance.open(t,{width:640,cacheable:false,allowChangeHistory:false});this.canDelete=true;this.canMarkSpam=true},onDisabledGroupActionClick:function e(){},onUnreadCounterClick:function e(){this.userInterfaceManager.onUnreadCounterClick()},getCurrentFolder:function e(){return this.userInterfaceManager.getCurrentFolder()},onDirsMenuItemClick:function e(t){if(BX.data(t,"is-disabled")=="true"){return}var n=this.userInterfaceManager.getFilterInstance();var i=n.getApi();i.setFields({DIR:BX.data(t,"path")});i.apply();this.userInterfaceManager.closeMailboxMenu()},getGridInstance:function e(){return BX.Main.gridManager.getById(this.gridId).instance},getRowsBindings:function e(t){return BX.util.array_unique(Array.prototype.concat.apply([],t.map(function(e){if(!e||!e.node){return null}return Array.prototype.map.call(e.node.querySelectorAll('[class^="js-bind-"] [data-type]'),function(e){return e.dataset.type})})))},getCache:function e(t){if(!t){return}return this.cache[t]?this.cache[t]:null},setCache:function e(t,n){return this.cache[t]=n},showICalMenuDropdown:function e(t){t.stopPropagation();t.preventDefault();var n=t.currentTarget.dataset.menu;if(!n){return}this.iCalMenuDropdown=BX.Main.MenuManager.create({id:"mail-client-message-list-ical-dropdown-menu",autoHide:true,closeByEsc:true,items:JSON.parse(n),zIndex:7001,maxHeight:400,maxWidth:200,angle:{position:"top",offset:40},events:{onPopupClose:function(){this.removeICalMenuDropdown()}.bind(this)}});this.iCalMenuDropdown.popupWindow.setBindElement(t.currentTarget);this.iCalMenuDropdown.show()},removeICalMenuDropdown:function e(){if(this.iCalMenuDropdown){BX.Main.MenuManager.destroy(this.iCalMenuDropdown.id)}},onClickICalButton:function e(t){t.stopPropagation();t.preventDefault();var n=t.target.dataset.messageid||t.target.parentNode.dataset.messageid;var i=t.target.dataset.action||t.target.parentNode.dataset.action;var s=t.target;s.classList.add("ui-btn-wait");this.removeICalMenuDropdown();this.sendICal(n,i).then(function(){s.classList.remove("ui-btn-wait");this.notify(BX.message(i==="cancelled"?"MAIL_MESSAGE_ICAL_NOTIFY_REJECT":"MAIL_MESSAGE_ICAL_NOTIFY_ACCEPT"))}.bind(this)).catch(function(){s.classList.remove("ui-btn-wait");this.notify(BX.message("MAIL_MESSAGE_ICAL_NOTIFY_ERROR"))}.bind(this))},sendICal:function e(t,n){return new Promise(function(e,i){BX.ajax.runComponentAction("bitrix:mail.client","ical",{mode:"ajax",data:{messageId:t,action:n}}).then(function(){e()}.bind(this),function(){i()}.bind(this))})}}})()})(this.window=this.window||{});
//# sourceMappingURL=script.map.js