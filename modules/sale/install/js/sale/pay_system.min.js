(function(e){if(!BX.Sale)BX.Sale={};if(BX.Sale.PaySystem)return;BX.Sale.PaySystem={ajaxUrl:"sale_pay_system_ajax.php",setLHEClass:function(e){BX.ready((function(){var t=BX(e);if(t)BX.addClass(t,"adm-sale-lhe-frame-dlvrs-dscr")}))},getRestrictionParamsHtml:function(t){if(!t.class)return;t.params=t.params||{};t.restrictionId=t.restrictionId||0;t.sort=t.sort||100;ShowWaitWindow();var i={action:"get_restriction_params_html",className:t.class,params:t.params,paySystemId:t.paySystemId,sort:t.sort,lang:t.lang,sessid:BX.bitrix_sessid()};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(i){CloseWaitWindow();if(i&&i.RESTRICTION_HTML&&!i.ERROR){var a=BX.processHTML(i.RESTRICTION_HTML);BX.Sale.PaySystem.showRestrictionParamsDialog(a["HTML"],t);e["paySystemGetRestrictionHtmlScriptsLoadingStarted"]=false;var r=function(t){if(!t)BX.removeCustomEvent("paySystemGetRestrictionHtmlScriptsReady",r);for(var i in a["SCRIPT"]){BX.evalGlobal(a["SCRIPT"][i]["JS"]);delete a["SCRIPT"][i];if(t&&e["paySystemGetRestrictionHtmlScriptsLoadingStarted"])return}};BX.addCustomEvent("paySystemGetRestrictionHtmlScriptsReady",r);r(true);BX.loadCSS(a["STYLE"])}else if(i&&i.ERROR){BX.debug("Error receiving restriction params html: "+i.ERROR)}else{BX.debug("Error receiving restriction params html!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error adding restriction!")}})},showRestrictionParamsDialog:function(e,t){var i=t.class=="\\Bitrix\\Sale\\PaySystem\\Restrictions\\ByLocation"?1030:420,a=new BX.CDialog({content:'<form id="sale-paysystem-restriction-edit-form">'+e+"</form>",title:BX.message("SALE_RDL_RESTRICTION")+" "+t.title,width:i,height:500,resizable:true});a.ClearButtons();a.SetButtons([{title:BX.message("SALE_RDL_SAVE"),action:function(){var e=BX("sale-paysystem-restriction-edit-form"),i=BX.ajax.prepareForm(e),a=!!i&&i.data?i.data:{};BX.Sale.PaySystem.saveRestriction(t,a);this.parentWindow.Close()}},BX.CDialog.prototype.btnCancel]);BX.addCustomEvent(a,"onWindowClose",(function(e){e.DIV.parentNode.removeChild(e.DIV)}));a.Show();a.adjustSizeEx()},saveRestriction:function(e,t){ShowWaitWindow();var i=t.RESTRICTION||{},a={action:"save_restriction",params:i,sort:t.SORT,className:e.class,paySystemId:e.paySystemId,restrictionId:e.restrictionId,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(e){CloseWaitWindow();if(e){if(e.HTML){BX.Sale.PaySystem.insertAjaxRestrictionHtml(e.HTML)}if(e.ERROR){alert(e.ERROR)}}},onfailure:function(){CloseWaitWindow()}})},deleteRestriction:function(e,t){if(!e)return;ShowWaitWindow();var i={action:"delete_restriction",restrictionId:e,paySystemId:t,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:i,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.HTML)BX.Sale.PaySystem.insertAjaxRestrictionHtml(e.HTML);if(e.ERROR)BX.debug("Error deleting restriction: "+e.ERROR)}else{BX.debug("Error deleting restriction!")}},onfailure:function(){CloseWaitWindow();BX.debug("Error refreshing restriction!")}})},insertAjaxRestrictionHtml:function(e){var t=BX.processHTML(e),i=BX("sale-paysystem-restriction-container");if(!i)return;BX.loadCSS(t["STYLE"]);i.innerHTML=t["HTML"];for(var a in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][a]["JS"])},getHandlerOptions:function(e){var t=e.value,i;if(t==="")return;if(BX("PS_MODE")){i=BX("PS_MODE").value}ShowWaitWindow();var a={action:"getHandlerDescription",handler:t,paySystemId:BX("ID").value,sessid:BX.bitrix_sessid(),lang:BX.message("LANGUAGE_ID")};if(i!==undefined){a.PS_MODE=i}BX.ajax({timeout:30,method:"POST",dataType:"json",url:this.ajaxUrl,data:a,onsuccess:function(e){CloseWaitWindow();if(e&&!e.ERROR){if(e.BUS_VAL){var t=BX.processHTML(e.BUS_VAL);var i=BX("paysystem-business-value-settings");if(!i)return;BX.loadCSS(t["STYLE"]);i.innerHTML=t["HTML"];for(var a in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][a]["JS"])}var r=BX("pay_system_tariff");if(e.TARIF){t=BX.processHTML(e.TARIF);if(!r)return;BX.loadCSS(t["STYLE"]);r.innerHTML=t["HTML"];for(a in t["SCRIPT"])BX.evalGlobal(t["SCRIPT"][a]["JS"]);BX.Sale.PaySystem.initTariffLoad()}else{r.innerHTML=""}var n=BX("pay_system_ps_mode");var s=BX("ACTION_FILE").value==="orderdocument";if(e.PAYMENT_MODE||s){var o=BX.create("tr",{props:{width:"40%"}});o.setAttribute("valign","top");var l=BX.create("td",{props:{width:"40%"}});BX.addClass(l,"adm-detail-content-cell-l");l.innerHTML=e.PAYMENT_MODE_TITLE+":";var d=BX.create("td",{props:{width:"60%"}});BX.addClass(d,"adm-detail-content-cell-r");if(e.PAYMENT_MODE){d.innerHTML=e.PAYMENT_MODE}if(s){var c=BX.create("span",{text:BX.message("SALE_TEMPLATE_DOCUMENT_ADD"),attrs:{class:"bx-button-add-template",style:"margin-left: 5px"}});BX.bind(c,"click",(function(){BX.SidePanel.Instance.open(e.ORDER_DOC_ADD_LINK,{width:930,events:{onCloseComplete:function(){BX.Sale.PaySystem.getHandlerOptions(BX("ACTION_FILE"))}}})}));d.appendChild(c)}o.appendChild(l);o.appendChild(d);n.innerHTML="";n.appendChild(o)}else{n.innerHTML=""}var p=BX("pay_system_ps_description");if(p)p.innerHTML="";if(e.DESCRIPTION){var m=BX.create("tr",{children:[BX.create("td",{props:{width:"40%",className:"adm-detail-content-cell-l"}}),BX.create("td",{props:{width:"60%",className:"adm-detail-content-cell-r"},html:e.DESCRIPTION})]});p.appendChild(m)}if(e.NAME!==undefined)BX("NAME").value=e.NAME;if(e.PSA_NAME!==undefined)BX("PSA_NAME").value=e.PSA_NAME;if(e.SORT)BX("SORT").value=e.SORT;var B=BX("ID").value;var f=BX("LOGOTIP");var u=BX.findParent(f,{tag:"div"});var X=BX.findChild(u.parentNode,{tag:"img"});if(e.LOGOTIP){if(e.LOGOTIP.NAME)f.previousElementSibling.innerHTML=e.LOGOTIP.NAME;if(X){if(e.LOGOTIP.PATH)X.src=e.LOGOTIP.PATH}else{X=BX.create("img",{attrs:{src:e.LOGOTIP.PATH}});X.style.maxHeight="55px";BX.insertAfter(X,u);BX.insertAfter(BX.create("br"),u)}}else if(B<=0){if(X)BX.remove(X);f.previousElementSibling.innerHTML=BX.message("JSADM_FILE")}this.updateVerificationBlock(e.DOMAIN_VERIFICATION)}else{BX.debug(e.ERROR)}}.bind(this),onfailure:function(){CloseWaitWindow();var e=BX("pay_system_ps_description");if(e)e.innerHTML="";var t=BX("pay_system_ps_mode");if(t)t.innerHTML="";BX.debug("Error")}})},toggleNextSiblings:function(e,t,i){if(!e.nextElementSibling)return false;var a=e.nextElementSibling;for(var r=0;r<t;r++){if(a.style.display=="none"&&!i)a.style.display="";else a.style.display="none";if(a.nextElementSibling)a=a.nextElementSibling;else break}return true},deleteObjectAndNextSiblings:function(e,t,i){if(!e)return false;var a;var r=e;if(i&&i>0){for(a=0;a<i;a++){if(r.parentNode)r=r.parentNode;else return false}}var n=false;var s=r;for(a=0;a<=t;a++){if(s.nextElementSibling)n=s.nextElementSibling;s.parentNode.removeChild(s);if(n)s=n;else break}return true},initTariffLoad:function(){var t;var i=BX("tabControl_layout");if(i){var a=e.parent.BX.findChildren(i,{tag:"tr",class:"ps-admin-hide"},true);for(t in a)BX.Sale.PaySystem.toggleNextSiblings(a[t],4,true)}e.parent.BX.onCustomEvent("onAdminTabsChange")},updateVerificationBlock:function(e){var t=BX("pay_system_validation_domain");t.style.display=e.NEED_VERIFICATION?"":"none";if(e.NEED_VERIFICATION){var i=BX("domain-verification-link");i.setAttribute("onclick","BX.Sale.PaySystem.openVerificationForm('"+e.FORM_LINK+"')")}},openVerificationForm:function(e){BX.SidePanel.Instance.open(e,{width:750})},addRestrictionProductSection:function(e,t,i){t=BX.util.htmlspecialcharsback(t);t=t.replace(/&#039;/g,"'").replace(/&nbsp;/g," ");var a=BX(i+"-"+e);if(a){return}var r=this;var n=BX.create("tr",{props:{id:i+"-"+e,className:"adm-s-product-category-restriction-delcat"},children:[BX.create("td",{children:[BX.create("span",{html:" - "+BX.util.htmlspecialchars(t)}),BX.create("input",{props:{type:"hidden",name:"RESTRICTION[CATEGORIES][]",value:e}})]}),BX.create("td",{props:{align:"right"},children:[BX.create("text",{html:"&nbsp;"}),BX.create("a",{props:{href:"javascript:void(0);",className:"adm-s-bus-morelinkqhsw"},text:BX.message("SALE_PRODUCT_CATEGORY_INP_DELETE"),events:{click:function(){r.deleteRestrictionProductSection(e,i)}}})]})]});BX(i+"-content").appendChild(n)},deleteRestrictionProductSection:function(e,t){var i=BX(t+"-"+e);if(i){i.parentNode.removeChild(i)}},addRestrictionByConcreteProduct:function(e,t,i){i=BX.util.htmlspecialcharsback(i);i=i.replace(/&#039;/g,"'").replace(/&nbsp;/g," ");var a=BX(e+"-"+t);if(a){return}var r=this;var n=BX.create("tr",{props:{id:e+"-"+t,className:"adm-s-concrete-product-restriction-delprod"},children:[BX.create("td",{children:[BX.create("span",{text:" - "+BX.util.htmlspecialchars(i)}),BX.create("input",{props:{type:"hidden",name:"RESTRICTION[PRODUCTS][]",value:t}})]}),BX.create("td",{props:{align:"right"},children:[BX.create("text",{html:"&nbsp;"}),BX.create("a",{props:{href:"javascript:void(0);",className:"adm-s-bus-morelinkqhsw"},text:BX.message("SALE_CONCRETE_PRODUCT_INP_DELETE"),events:{click:function(){r.deleteRestrictionByConcreteProduct(e,t)}}})]})]});BX(e+"-content").appendChild(n)},deleteRestrictionByConcreteProduct:function(e,t){var i=BX(e+"-"+t);if(i){i.parentNode.removeChild(i)}}}})(window);
//# sourceMappingURL=pay_system.map.js