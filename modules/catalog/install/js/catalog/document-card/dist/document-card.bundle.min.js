this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};(function(e,t,n,i,a,r,o,s,l){"use strict";var c=function(e){babelHelpers.inherits(t,e);function t(e,i){var a;babelHelpers.classCallCheck(this,t);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(a),"getCurrencyId",(function(){return this._currencyId}));a.initialize(e,i);a._setProductListHandler=a.handleSetProductList.bind(babelHelpers.assertThisInitialized(a));a._tabShowHandler=a.onTabShow.bind(babelHelpers.assertThisInitialized(a));a._editorControlChangeHandler=a.onEditorControlChange.bind(babelHelpers.assertThisInitialized(a));a._currencyId=a._model.getField("CURRENCY","");n.EventEmitter.subscribe(a._editor,"onControlChanged",a.onEditorControlChange.bind(babelHelpers.assertThisInitialized(a)));n.EventEmitter.subscribe("DocumentProductListController",a._setProductListHandler);n.EventEmitter.subscribe("onEntityDetailsTabShow",a._tabShowHandler);n.EventEmitter.subscribe("BX.UI.EntityEditorList:onItemSelect",(function(e){var t=babelHelpers.slicedToArray(e.data,2),n=t[0],i=t[1];if((n===null||n===void 0?void 0:n.getId())==="TOTAL_WITH_CURRENCY"){a.changeCurrency(i.item.value)}}));return a}babelHelpers.createClass(t,[{key:"handleSetProductList",value:function e(t){var i=t.getData()[0];this.setProductList(i);n.EventEmitter.unsubscribe("DocumentProductListController",this._setProductListHandler)}},{key:"reinitializeProductList",value:function e(){if(this.productList){this.productList.reloadGrid(false)}}},{key:"onTabShow",value:function e(t){var i=t.getData(),a=babelHelpers.slicedToArray(i,1),r=a[0];if(r.id==="tab_products"&&this.productList){this.productList.handleOnTabShow();n.EventEmitter.unsubscribe("onEntityDetailsTabShow",this._tabShowHandler);n.EventEmitter.emit("onDocumentProductListTabShow",this)}}},{key:"innerCancel",value:function e(){this.rollback();if(this.productList){this.productList.onInnerCancel()}this._currencyId=this._model.getField("CURRENCY");if(this.productList){this.productList.changeCurrencyId(this._currencyId);this.productList.updateTotalUiCurrency()}this._isChanged=false}},{key:"setProductList",value:function e(t){if(this.productList===t){return}if(this.productList){this.productList.destroy()}this.productList=t;if(this.productList){this.productList.setController(this);this.productList.setForm(this._editor.getFormElement());if(this.productList.getCurrencyId()!==this.getCurrencyId()){this.productList.changeCurrencyId(this.getCurrencyId())}this._prevProductCount=this._curProductCount=this.productList.getProductCount()}}},{key:"onAfterSave",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onAfterSave",this).call(this);if(this.productList){this.productList.removeFormFields()}this._editor._toolPanel.showViewModeButtons()}},{key:"productChange",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:false;i=(t=i)!==null&&t!==void 0?t:false;this.markAsChanged();if(i){this.disableSaveButton()}n.EventEmitter.emit("onDocumentProductChange",this.productList.getProductsFields())}},{key:"onBeforeSubmit",value:function e(){if(this.productList&&(this.isChanged()||this._editor.isNew())){this.productList.compileProductData()}}},{key:"enableSaveButton",value:function e(){var t;if((t=this._editor)!==null&&t!==void 0&&t._toolPanel){this._editor._toolPanel.enableSaveButton()}}},{key:"disableSaveButton",value:function e(){var t;if((t=this._editor)!==null&&t!==void 0&&t._toolPanel){this._editor._toolPanel.disableSaveButton()}}},{key:"onEditorControlChange",value:function e(t){var n=t.getData(),i=babelHelpers.slicedToArray(n,2),a=i[0],r=i[1];if(a instanceof BX.UI.EntityEditorMoney&&(r===null||r===void 0?void 0:r.fieldName)==="CURRENCY"){this.changeCurrency(r.fieldValue)}}},{key:"changeCurrency",value:function e(t){this._currencyId=t;if(this.productList&&this._currencyId){this.productList.changeCurrencyId(this._currencyId);this.markAsChanged()}}},{key:"setTotal",value:function e(t){this._model.setField("FORMATTED_TOTAL",BX.Currency.currencyFormat(t.totalCost,this.getCurrencyId(),false));this._model.setField("FORMATTED_TOTAL_WITH_CURRENCY",BX.Currency.currencyFormat(t.totalCost,this.getCurrencyId(),true));this._model.setField("TOTAL",t.totalCost);var n=this._editor.getControlById("TOTAL_WITH_CURRENCY");if(n instanceof BX.UI.EntityEditorMoney){n.refreshLayout()}}},{key:"validateProductList",value:function e(){var t=this.productList.validate();if(t.length>0){this._editor._toolPanel.addError(t[0]);n.EventEmitter.emit("onProductsCheckFailed",t);return false}return true}}]);return t}(BX.UI.EntityEditorController);function d(e,t){u(e,t);t.add(e)}function u(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function p(e,t,n){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return n}var v=new WeakSet;var h=new WeakSet;var b=function(e){babelHelpers.inherits(t,e);function t(e,n){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));d(babelHelpers.assertThisInitialized(i),h);d(babelHelpers.assertThisInitialized(i),v);i.initialize(e,n);i._model.lockField("TOTAL");return i}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){p(this,v,f).call(this)}},{key:"onAfterSave",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onAfterSave",this).call(this);window.top.BX.onCustomEvent("DocumentCard:onDocumentCardSave");var n=BX.SidePanel.Instance.getOpenSliders();n.forEach((function(e){var t,n;if((t=e.getWindow())!==null&&t!==void 0&&(n=t.BX.Catalog)!==null&&n!==void 0&&n.DocumentGridManager){e.getWindow().BX.onCustomEvent("DocumentCard:onDocumentCardSave")}}))}}]);return t}(BX.UI.EntityEditorController);function f(){p(this,h,C).call(this)}function C(){n.EventEmitter.subscribe("BX.UI.EntityEditorProductRowSummary:onDetailProductListLinkClick",(function(){n.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}));n.EventEmitter.subscribe("BX.UI.EntityEditorProductRowSummary:onAddNewRowInProductList",(function(){n.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"});setTimeout((function(){n.EventEmitter.emit("onFocusToProductList")}),500)}))}var y=function(){function e(t){var i=this;babelHelpers.classCallCheck(this,e);n.EventEmitter.subscribe(t,(function(e){var t=e.getCompatData(),n=babelHelpers.slicedToArray(t,2),a=n[1];a.methods["entityCard"]=i.factory.bind(i)}))}babelHelpers.createClass(e,[{key:"factory",value:function e(t,n,i){if(t==="document_card"){return new b(n,i)}if(t==="catalog_store_document_product_list"){return new c(n,i)}return null}}]);return e}();var m=function(e){babelHelpers.inherits(t,e);function t(e,n){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.initialize(e,n);return i}babelHelpers.createClass(t,[{key:"isCaptionEditable",value:function e(){return true}},{key:"getCaption",value:function e(){var t=this.getField("TITLE");return BX.type.isString(t)?t:""}},{key:"setCaption",value:function e(t){this.setField("TITLE",t)}},{key:"prepareCaptionData",value:function e(t){t["TITLE"]=this.getField("TITLE","")}}]);return t}(BX.UI.EntityModel);var g=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);n.EventEmitter.subscribe("BX.UI.EntityEditorModelFactory:onInitialize",(function(e){var n=e.getCompatData(),i=babelHelpers.slicedToArray(n,2),a=i[1];a.methods["store_document"]=t.factory.bind(t)}))}babelHelpers.createClass(e,[{key:"factory",value:function e(t,n,i){if(t==="store_document"){return new m(n,i)}return null}}]);return e}();var E=function(e){babelHelpers.inherits(t,e);function t(e,n){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.initialize(e,n);i._loader=null;i._productsContainer=null;i._previousData=[];i._itemCount=0;i._totalCount=0;i._moreButton=null;i._moreButtonRow=null;i._totalsRow=null;i._moreButtonClickHandler=BX.delegate(i._onMoreButtonClick,babelHelpers.assertThisInitialized(i));i._visibleItemsLimit=5;return i}babelHelpers.createClass(t,[{key:"layout",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this._hasLayout){return}this.ensureWrapperCreated({});this.adjustWrapper();var n=this.getValue();if(!BX.type.isPlainObject(n)){return}var i=this.getTitle();var a=BX.prop.getArray(n,"items",[]);this._totalCount=BX.prop.getInteger(n,"count",0);this._itemCount=a.length;var r=this._itemCount;var o=this._visibleItemsLimit;var s=0;if(r>o){s=this._totalCount-o;r=o}if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));this._productsContainer=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-list"}});for(var l=0;l<r;l++){this.addProductRow(a[l])}this._moreButton=null;if(s>0){this.addMoreButton(s)}this.addTotalRow(n["total"]);this._wrapper.appendChild(BX.create("div",{props:{className:"catalog-entity-widget-content-block-products"},children:[this._productsContainer]}));if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(t);this._hasLayout=true}},{key:"addMoreButton",value:function e(t){var n=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-item"}});this._moreButtonRow=n;this._productsContainer.appendChild(n);var i=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-item-name"}});n.appendChild(i);this._moreButton=BX.create("span",{attrs:{className:"catalog-entity-widget-content-block-products-show-more"},events:{click:this._moreButtonClickHandler},text:l.Loc.getMessage("DOCUMENT_PRODUCTS_NOT_SHOWN",{"#COUNT#":t.toString()})});i.appendChild(this._moreButton);n.appendChild(BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-price"}}))}},{key:"addTotalRow",value:function e(t){var n=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-item"}});this._totalsRow=n;this._productsContainer.appendChild(n);var a=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-item-name"},html:l.Loc.getMessage("DOCUMENT_PRODUCTS_TOTAL")});n.appendChild(a);var r=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-price"},html:i.CurrencyCore.currencyFormat(t.amount,t.currency,true)});n.appendChild(r)}},{key:"addAddProductButton",value:function e(){var t=BX.create("a",{props:{href:"#"}});t.text=l.Loc.getMessage("DOCUMENT_PRODUCTS_ADD_PRODUCT");t.onclick=function(){n.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})};var i=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-add-products"},children:[t]});this._productsContainer.appendChild(i)}},{key:"_onMoreButtonClick",value:function e(t){n.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}},{key:"doClearLayout",value:function e(){this._productsContainer=null;this._moreButton=null;this._moreButtonRow=null;this._totalsRow=null}},{key:"addProductRow",value:function e(t){var n=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-item"}});this._productsContainer.appendChild(n);var i=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-item-name"}});i.innerHTML=BX.util.htmlspecialchars(t["PRODUCT_NAME"]);n.appendChild(i);var a=BX.create("div",{props:{className:"catalog-entity-widget-content-block-products-price"}});n.appendChild(a);a.appendChild(BX.create("div",{attrs:{className:"catalog-entity-widget-content-block-products-price-value"},html:t["SUM"]}))}}]);return t}(BX.UI.EntityEditorField);var T,_,B,k;var I=function(e){babelHelpers.inherits(t,e);function t(e,n){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));i.initialize(e,n);i._input=null;i.innerWrapper=null;i.currentContractorName="";i.viewModeDisplay=null;return i}babelHelpers.createClass(t,[{key:"getContentWrapper",value:function e(){return this.innerWrapper}},{key:"layout",value:function e(){var t=this;var n=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this._hasLayout){return}this.ensureWrapperCreated({});this.adjustWrapper();var i=this.getTitle();if(this.isDragEnabled()){this._wrapper.appendChild(this.createDragButton())}this._wrapper.appendChild(this.createTitleNode(i));var r=this.getName();var o=this.getValue();var s=this._schemeElement.getData();if(!this.currentContractorName){this.currentContractorName=this.getContractorNameFromModel()}this._input=l.Tag.render(T||(T=babelHelpers.taggedTemplateLiteral(['<input name="','" type="hidden" value="','"/>'])),r,o);this._wrapper.appendChild(this._input);this.innerWrapper=l.Tag.render(_||(_=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-content-block"></div>'])));this._wrapper.appendChild(this.innerWrapper);if(this._mode===BX.UI.EntityEditorMode.edit){var c=[];if(o){c.push({id:o,entityId:"contractor",title:this.currentContractorName})}var d=new a.TagSelector({items:c,placeholder:l.Loc.getMessage("DOCUMENT_CONTRACTOR_FIELD_PLACEHOLDER"),textBoxWidth:"100%",multiple:false,dialogOptions:{context:"catalog_document_contractors",entities:[{id:"contractor",dynamicLoad:true,dynamicSearch:true}],searchOptions:{allowCreateItem:true,footerOptions:{label:l.Loc.getMessage("DOCUMENT_ADD_CONTRACTOR")}},events:{"Item:onSelect":function e(n){t._input.value=n.data.item.getId();if(t.viewModeDisplay){t.currentContractorName=n.data.item.getTitle();t.viewModeDisplay.innerHTML=BX.util.htmlspecialchars(t.currentContractorName)}t._changeHandler()},"Search:onItemCreateAsync":this.createContractor.bind(this),"Item:onDeselect":function e(n){t._input.value="";t._changeHandler()}}}});d.renderTo(this.innerWrapper);if(BX.UI.EntityEditorModeOptions.check(this._modeOptions,BX.UI.EntityEditorModeOptions.individual)){d.getDialog().show()}}else{if(this.hasContentToDisplay()){this.viewModeDisplay=l.Tag.render(B||(B=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-content-block-text">',"</div>"])),BX.util.htmlspecialchars(this.currentContractorName))}else{this.viewModeDisplay=l.Tag.render(k||(k=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-content-block-text">',"</div>"])),l.Loc.getMessage("DOCUMENT_CONTRACTOR_NOT_FILLED"))}this.innerWrapper.appendChild(this.viewModeDisplay)}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}if(this.isDragEnabled()){this.initializeDragDropAbilities()}this.registerLayout(n);this._hasLayout=true}},{key:"validate",value:function e(t){if(!(this._mode===BX.UI.EntityEditorMode.edit&&this._input)){throw"BX.Catalog.DocumentCard.Contractor. Invalid validation context"}this.clearError();if(this.hasValidators()){return this.executeValidators(t)}var n=!(this.isRequired()||this.isRequiredByAttribute())||BX.util.trim(this._input.value)!=="";if(!n){t.addError(BX.UI.EntityValidationError.create({field:this}));this.showRequiredFieldError(this._input)}return n}},{key:"hasValue",value:function e(){if(this.getValue()==="0"){return false}return babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"hasValue",this).call(this)}},{key:"getModeSwitchType",value:function e(t){var n=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){n|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return n}},{key:"createContractor",value:function e(t){var n=t.getData(),i=n.searchQuery;var a=i.getQuery();return new Promise((function(e,n){var r=t.getTarget();var o={companyName:a};r.showLoader();l.ajax.runAction("catalog.contractor.createContractor",{data:{fields:o}}).then((function(t){r.hideLoader();var n=r.addItem({id:t.data.id,entityId:"contractor",title:i.getQuery(),tabs:r.getRecentTab().getId()});if(n){n.select()}r.hide();e()}))["catch"]((function(){r.hideLoader();BX.UI.Notification.Center.notify({content:l.Loc.getMessage("DOCUMENT_ADD_CONTRACTOR_ERROR")});r.hide();n()}))}))}},{key:"getContractorNameFromModel",value:function e(){return this._model.getSchemeField(this._schemeElement,"contractorName","")}},{key:"rollback",value:function e(){this.currentContractorName=this.getContractorNameFromModel()}}]);return t}(BX.UI.EntityEditorField);var w=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);n.EventEmitter.subscribe("BX.UI.EntityEditorControlFactory:onInitialize",(function(e){var n=e.getCompatData(),i=babelHelpers.slicedToArray(n,2),a=i[1];a.methods["documentCard"]=t.factory.bind(t)}))}babelHelpers.createClass(e,[{key:"factory",value:function e(t,n,i){if(t==="contractor"){return new I(n,i)}return null}}]);return e}();function S(e,t,n){O(e,t);P(n,"get");return L(e,n)}function L(e,t){if(t.get){return t.get.call(e)}return t.value}function D(e,t,n,i){O(e,t);P(n,"set");M(e,n,i);return i}function P(e,t){if(e===undefined){throw new TypeError("attempted to "+t+" private static field before its declaration")}}function O(e,t){if(e!==t){throw new TypeError("Private static access of wrong provenance")}}function M(e,t,n){if(t.set){t.set.call(e,n)}else{if(!t.writable){throw new TypeError("attempted to set read only private field")}t.value=n}}var X=function(e){babelHelpers.inherits(t,e);function t(e,n){var i;babelHelpers.classCallCheck(this,t);i=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this,e,n));i.documentType=n.documentType;i.isDocumentConducted=n.documentStatus==="Y";i.componentName=n.componentName;i.signedParameters=n.signedParameters;i.isConductLocked=n.isConductLocked;i.masterSliderUrl=n.masterSliderUrl;i.isInventoryManagementDisabled=n.isInventoryManagementDisabled;i.inventoryManagementFeatureCode=n.inventoryManagementFeatureCode;i.editorName=n.includeCrmEntityEditor?"BX.Crm.EntityEditor":"BX.UI.EntityEditor";i.inventoryManagementSource=n.inventoryManagementSource;i.activeTabId="main";i.isTabAnalyticsSent=false;i.setSliderText();i.addCopyLinkPopup();i.subscribeToEvents();if(n.documentTypeSelector){i.initDocumentTypeSelector()}D(t,t,N,babelHelpers.assertThisInitialized(i));BX.UI.SidePanel.Wrapper.setParam("closeAfterSave",true);i.showNotificationOnClose=false;return i}babelHelpers.createClass(t,[{key:"initDocumentTypeSelector",value:function e(){var t=this;var n=this.settings.documentTypeSelector;var i=this.settings.documentTypeSelectorTypes;if(!n||!i){return}var a=[];i.forEach((function(e){a.push({text:l.Loc.getMessage("DOC_TYPE_SHORT_"+e),onclick:function n(i){var a=BX.SidePanel.Instance.getTopSlider();if(a){a.url=BX.Uri.addParam(a.getUrl(),{DOCUMENT_TYPE:e});a.url=BX.Uri.removeParam(a.url,["firstTime","focusedTab"]);if(t.activeTabId!=="main"){a.url=BX.Uri.addParam(a.getUrl(),{focusedTab:t.activeTabId})}if(e==="A"||e==="S"){a.requestMethod="post";a.requestParams={preloadedFields:{DOCUMENT_FIELDS:t.getDocumentFieldsForTypeSwitching(),PRODUCTS:t.getProductsForTypeSwitching()}}}a.setFrameSrc()}}})}));var o=r.MenuManager.create({id:"document-type-selector",bindElement:n,items:a});n.addEventListener("click",(function(e){e.preventDefault();o.show()}))}},{key:"getDocumentFieldsForTypeSwitching",value:function e(){var t={};var n=this.getEditorInstance();if(!n){return t}var i=n.getFormElement();var a=new FormData(i);var r=Object.fromEntries(a);var o=["TITLE","CURRENCY","TOTAL"];o.forEach((function(e){var n;t[e]=(n=r[e])!==null&&n!==void 0?n:""}));return t}},{key:"getProductsForTypeSwitching",value:function e(){var t=[];if(!l.Reflection.getClass("BX.Catalog.Store.ProductList.Instance")){return t}var n=["ID","STORE_TO",{ELEMENT_ID:"SKU_ID"},"AMOUNT","PURCHASING_PRICE","BASE_PRICE","BASE_PRICE_EXTRA","BASE_PRICE_EXTRA_RATE"];BX.Catalog.Store.ProductList.Instance.getProductsFields().forEach((function(e){var i={};n.forEach((function(t){if(l.Type.isObject(t)){var n;var a=Object.keys(t)[0];var r=t[a];i[a]=(n=e[r])!==null&&n!==void 0?n:""}else{var o;i[t]=(o=e[t])!==null&&o!==void 0?o:""}}));t.push(i)}));return t}},{key:"openMasterSlider",value:function e(){var t=this;(new o.Slider).open(this.masterSliderUrl,{data:{openGridOnDone:false},events:{onCloseComplete:function e(n){var i=n.getSlider();if(!i){return}if(i.getData().get("isInventoryManagementEnabled")){t.isConductLocked=false;BX.SidePanel.Instance.getOpenSliders().forEach((function(e){var t,n;if((t=e.getWindow())!==null&&t!==void 0&&(n=t.BX.Catalog)!==null&&n!==void 0&&n.DocumentGridManager){e.allowChangeHistory=false;e.getWindow().location.reload()}}))}}}})}},{key:"adjustToolPanel",value:function e(){return}},{key:"focusOnTab",value:function e(t){n.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:t})}},{key:"setViewModeButtons",value:function e(t){t._toolPanel.showViewModeButtons()}},{key:"setEditModeButtons",value:function e(t){t._toolPanel.showEditModeButtons()}},{key:"getEditorInstance",value:function e(){var t=l.Reflection.getClass(this.editorName);if(t){return t.getDefault()}return null}},{key:"subscribeToEvents",value:function e(){this.subscribeToUserSelectorEvent();this.subscribeToValidationFailedEvent();this.subscribeToOnSaveEvent();this.subscribeToTabOpenEvent();this.subscribeToDirectActionEvent();this.subscribeToEntityCreateEvent();this.subscribeToBeforeEntityRedirectEvent()}},{key:"subscribeToUserSelectorEvent",value:function e(){var t=this;if(this.editorName!=="BX.UI.EntityEditor"){return}n.EventEmitter.subscribe("BX.UI.EntityEditorUser:openSelector",(function(e){var n=e.data[1];var i=new a.Dialog({targetNode:n.anchor,enableSearch:true,multiple:false,context:"CATALOG_DOCUMENT",entities:[{id:"user"},{id:"department"}],events:{"Item:onSelect":function e(a){var r=n.id;var o=a.data.item;var s={entityId:o.id,avatar:o.avatar,name:l.Text.encode(o.title.text)};if(t.entityId>0){var c={};c[r]=o.id;BX.ajax.runComponentAction(t.componentName,"save",{mode:"class",signedParameters:t.signedParameters,data:{fields:c}}).then((function(e){n.callback(i,s)}))}else{n.callback(i,s)}}}});i.show()}))}},{key:"subscribeToValidationFailedEvent",value:function e(){n.EventEmitter.subscribe(this.editorName+":onFailedValidation",(function(e){n.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"main"})}));n.EventEmitter.subscribe("onProductsCheckFailed",(function(e){n.EventEmitter.emit("BX.Catalog.EntityCard.TabManager:onOpenTab",{tabId:"tab_products"})}))}},{key:"subscribeToOnSaveEvent",value:function e(){var t=this;n.EventEmitter.subscribe(this.editorName+":onSave",(function(e){var n;var i=e.data[0];var a=(n=e.data[1])===null||n===void 0?void 0:n.actionId;if(i&&i._ajaxForm){var r;(r=i._toolPanel)===null||r===void 0?void 0:r.clearErrors();if(t.isInventoryManagementDisabled&&t.inventoryManagementFeatureCode){var o;e.data[1].cancel=true;(o=e.data[0]._toolPanel)===null||o===void 0?void 0:o.setLocked(false);top.BX.UI.InfoHelper.show(t.inventoryManagementFeatureCode);return}if(a==="SAVE_AND_CONDUCT"){if(t.isConductLocked){var s;e.data[1].cancel=true;(s=e.data[0]._toolPanel)===null||s===void 0?void 0:s.setLocked(false);t.openMasterSlider();return}if(!t.validateControllers(i.getControllers())){var l;e.data[1].cancel=true;(l=i._toolPanel)===null||l===void 0?void 0:l.setLocked(false);return}if(e.data[1].cancel){return}}var c=i._ajaxForms[a];if(c){c.addUrlParams({documentType:t.documentType,isNewDocument:t.entityId<=0?"Y":"N",inventoryManagementSource:t.inventoryManagementSource})}}}))}},{key:"subscribeToTabOpenEvent",value:function e(){var t=this;n.EventEmitter.subscribe("BX.Catalog.EntityCard.TabManager:onSelectItem",(function(e){var n=e.data.tabId;if(n==="tab_products"&&!t.isTabAnalyticsSent){t.sendAnalyticsData({tab:"products",isNewDocument:t.entityId<=0?"Y":"N",documentType:t.documentType,inventoryManagementSource:t.inventoryManagementSource});t.isTabAnalyticsSent=true}if(n){t.activeTabId=n}}))}},{key:"subscribeToDirectActionEvent",value:function e(){var t=this;n.EventEmitter.subscribe(this.editorName+":onDirectAction",(function(e){var n,i;var a=e.data[0];if(t.isInventoryManagementDisabled&&t.inventoryManagementFeatureCode){var r;e.data[1].cancel=true;(r=e.data[0]._toolPanel)===null||r===void 0?void 0:r.setLocked(false);top.BX.UI.InfoHelper.show(t.inventoryManagementFeatureCode);return}if(((n=e.data[1])===null||n===void 0?void 0:n.actionId)==="CONDUCT"){var o;(o=a._toolPanel)===null||o===void 0?void 0:o.clearErrors();if(t.isConductLocked){var s;e.data[1].cancel=true;(s=e.data[0]._toolPanel)===null||s===void 0?void 0:s.setLocked(false);t.openMasterSlider();return}if(!t.validateControllers(a.getControllers())){var l;e.data[1].cancel=true;(l=a._toolPanel)===null||l===void 0?void 0:l.setLocked(false);return}e.data[0]._ajaxForms["CONDUCT"].addUrlParams({documentType:t.documentType,inventoryManagementSource:t.inventoryManagementSource})}if(((i=e.data[1])===null||i===void 0?void 0:i.actionId)==="CANCEL_CONDUCT"){e.data[0]._ajaxForms["CANCEL_CONDUCT"].addUrlParams({documentType:t.documentType,inventoryManagementSource:t.inventoryManagementSource})}}))}},{key:"subscribeToEntityCreateEvent",value:function e(){n.EventEmitter.subscribe("onEntityCreate",(function(e){var t;window.top.BX.onCustomEvent("DocumentCard:onEntityCreate");BX.SidePanel.Instance.getOpenSliders().forEach((function(e){var t,n;if((t=e.getWindow())!==null&&t!==void 0&&(n=t.BX.Catalog)!==null&&n!==void 0&&n.DocumentGridManager){e.getWindow().BX.onCustomEvent("DocumentCard:onEntityCreate")}}));var n=e===null||e===void 0?void 0:(t=e.data[0])===null||t===void 0?void 0:t.sender;if(n){n._toolPanel.disableSaveButton();n.hideToolPanel()}}))}},{key:"subscribeToBeforeEntityRedirectEvent",value:function e(){var t=this;n.EventEmitter.subscribe("beforeEntityRedirect",(function(e){var n;window.top.BX.onCustomEvent("DocumentCard:onBeforeEntityRedirect");BX.SidePanel.Instance.getOpenSliders().forEach((function(e){e.getWindow().BX.onCustomEvent("DocumentCard:onBeforeEntityRedirect")}));var i=e===null||e===void 0?void 0:(n=e.data[0])===null||n===void 0?void 0:n.sender;if(i){var a;i._toolPanel.disableSaveButton();i.hideToolPanel();t.showNotificationOnClose=(e===null||e===void 0?void 0:(a=e.data[0])===null||a===void 0?void 0:a.showNotificationOnClose)==="Y";if(t.showNotificationOnClose){var r=e.data[0].redirectUrl;if(!r){return}r=BX.Uri.removeParam(r,"closeOnSave");window.top.BX.UI.Notification.Center.notify({content:l.Loc.getMessage("DOCUMENT_CONDUCT_SUCCESSFUL"),actions:[{title:l.Loc.getMessage("DOCUMENT_CONDUCT_SUCCESSFUL_VIEW"),href:r,events:{click:function e(t,n,i){n.close()}}}]})}}}))}},{key:"validateControllers",value:function e(t){var n=true;if(t instanceof Array){t.forEach((function(e){if(e instanceof c){if(!e.validateProductList()){n=false}}}))}else{n=false}return n}},{key:"sendAnalyticsData",value:function e(t){BX.ajax.runAction("catalog.analytics.sendAnalyticsLabel",{analyticsLabel:t})}},{key:"addCopyLinkPopup",value:function e(){var t=this;var n=document.getElementById(this.settings.copyLinkButtonId);if(!n){return}n.onclick=function(){t.copyDocumentLinkToClipboard()}}},{key:"copyDocumentLinkToClipboard",value:function e(){var t=BX.util.remove_url_param(window.location.href,["IFRAME","IFRAME_TYPE"]);if(!BX.clipboard.copy(t)){return}var n=new BX.PopupWindow("catalog_copy_document_url_to_clipboard",document.getElementById(this.settings.copyLinkButtonId),{content:l.Loc.getMessage("DOCUMENT_LINK_COPIED"),darkMode:true,autoHide:true,zIndex:1e3,angle:true,bindOptions:{position:"top"}});n.show();setTimeout((function(){n.close()}),1500)}},{key:"setSliderText",value:function e(){var t=BX.SidePanel.Instance.getTopSlider();if(t){t.getLabel().setText(l.Loc.getMessage("SLIDER_LABEL_"+this.documentType))}}},{key:"disableSaveAndConductButton",value:function e(){if(!this.conductAndSaveButton){return}this.conductAndSaveButton.disabled=true;BX.addClass(this.conductAndSaveButton,"ui-btn-disabled")}},{key:"enableSaveAndConductButton",value:function e(){if(!this.conductAndSaveButton){return}this.conductAndSaveButton.disabled=false;BX.removeClass(this.conductAndSaveButton,"ui-btn-disabled")}}],[{key:"getInstance",value:function e(){return S(t,t,N)}},{key:"registerFieldFactory",value:function e(){D(t,t,H,new w)}},{key:"registerModelFactory",value:function e(){D(t,t,U,new g)}},{key:"registerDocumentControllersFactory",value:function e(n){D(t,t,A,new y(n))}}]);return t}(t.BaseCard);var N={writable:true,value:void 0};var H={writable:true,value:void 0};var U={writable:true,value:void 0};var A={writable:true,value:void 0};var R;var F=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"render",value:function e(t,n){var i=l.Loc.getMessage("FEEDBACK_BUTTON_TITLE");var a=l.Tag.render(R||(R=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<button class="ui-btn ui-btn-light-border ui-btn-themes" title="','">\n\t\t\t\t<span class="ui-btn-text">\n\t\t\t\t\t',"\n\t\t\t\t</span>\n\t\t\t</button>\n\t\t"])),i,i);if(n){a.style.zIndex=140;a.style.backgroundColor="#fff"}a.addEventListener("click",(function(){BX.Catalog.DocumentCard.Slider.openFeedbackForm()}));t.appendChild(a);return a}}]);return e}();function x(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function j(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?x(Object(n),!0).forEach((function(t){babelHelpers.defineProperty(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):x(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}var W=function(){function e(){babelHelpers.classCallCheck(this,e)}babelHelpers.createClass(e,null,[{key:"openFeedbackForm",value:function t(){var n=new l.Uri("/bitrix/components/bitrix/catalog.feedback/slider.php");n.setQueryParams({feedback_type:"feedback"});return e.open(n.toString(),{width:735})}},{key:"openIntegrationRequestForm",value:function t(n){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(n&&l.Type.isFunction(n.preventDefault)){n.preventDefault()}if(!l.Type.isPlainObject(i)){i={}}var a=new l.Uri("/bitrix/components/bitrix/catalog.feedback/slider.php");a.setQueryParams({feedback_type:"integration_request"});a.setQueryParams(i);return e.open(a.toString(),{width:735})}},{key:"open",value:function e(t,n){if(!l.Type.isPlainObject(n)){n={}}n=j(j({},{cacheable:false,allowChangeHistory:false,events:{}}),n);return new Promise((function(e){if(l.Type.isString(t)&&t.length>1){n.events.onClose=function(t){e(t.getSlider())};BX.SidePanel.Instance.open(t,n)}else{e()}}))}}]);return e}();e.DocumentCard=X;e.ProductListController=c;e.FeedbackButton=F;e.Slider=W})(this.BX.Catalog.DocumentCard=this.BX.Catalog.DocumentCard||{},BX.Catalog.EntityCard,BX.Event,BX.Currency,BX.UI.EntitySelector,BX.Main,BX.Catalog.StoreUse,BX,BX);
//# sourceMappingURL=document-card.bundle.map.js