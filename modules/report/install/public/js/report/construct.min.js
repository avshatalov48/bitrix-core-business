var GLOBAL_BX_REPORT_USING_CHARTS=false;function OnTaskIntervalChange(e){var t=BX.findNextSibling(e,{tag:"span",className:"filter-date-interval"});var r=BX.findNextSibling(e,{tag:"span",className:"filter-day-interval"});BX.removeClass(t,"filter-date-interval-after filter-date-interval-before");BX.removeClass(r,"filter-day-interval-selected");if(e.value=="interval")BX.addClass(t,"filter-date-interval-after filter-date-interval-before");else if(e.value=="before")BX.addClass(t,"filter-date-interval-before");else if(e.value=="after")BX.addClass(t,"filter-date-interval-after");else if(e.value=="days")BX.addClass(r,"filter-day-interval-selected")}function initIntervalFilter(){BX.ready(function(){BX.prompt=function(e,t){BX.bind(e,"focus",function(){if(e.value==t){e.value="";e.style.color="#000000"}});BX.bind(e,"blur",function(){if(e.value==""){e.value=t;e.style.color="#999999"}});BX.fireEvent(e,"blur")};BX.prompt(BX("reports-new-title"),BX.message("REPORT_DEFAULT_TITLE"));BX.bind(BX("filter-date-interval-calendar-from"),"click",function(e){if(!e)e=window.event;var t=new Date;var r=Math.round(t/1e3)-t.getTimezoneOffset()*60;BX.calendar({node:this,field:BX("REPORT_INTERVAL_F_DATE_FROM"),bTime:false});BX.PreventDefault(e)});BX.bind(BX("filter-date-interval-calendar-to"),"click",function(e){if(!e)e=window.event;var t=new Date;var r=Math.round(t/1e3)-t.getTimezoneOffset()*60;BX.calendar({node:this,field:BX("REPORT_INTERVAL_F_DATE_TO"),bTime:false});BX.PreventDefault(e)});OnTaskIntervalChange(BX("task-interval-filter"))})}function show_add_filcol_popup(e,t){var r=e;if(e==null){r=this}var l=Math.random();var i=BX.PopupWindowManager.create("reports-add_col-popup"+l,r,{content:t,offsetTop:2,closeIcon:{},offsetLeft:-7});i.show();var a=BX.findChildren(t,{tagName:"span",className:"reports-add-popup-arrow"},true);if(a){for(var n=0;n<a.length;n++){BX.bind(a[n].parentNode,"click",open_close)}}}var LAST_FILCOL_CALLED=null;function show_add_col_popup(e,t){var r=e,l;if(e==null){r=this}var i=Math.random();var a=BX.PopupWindowManager.create("reports-add_col-popup"+i,r,{content:t,offsetTop:2,closeIcon:{},offsetLeft:-7,buttons:[new BX.PopupWindowButton({text:BX.message("REPORT_ADD"),className:"popup-window-button-accept",events:{click:function(){var e=BX.findChildren(t,{tag:"input",attr:{type:"checkbox"},property:"checked"},true);for(var r in e){if(!e.hasOwnProperty(r))continue;var l=e[r];addSelectColumn(l);l.checked=false;BX.toggleClass(l.parentNode.parentNode,"reports-add-popup-checked")}this.popupWindow.close(BX.MSLEFT)}}}),new BX.PopupWindowButtonLink({text:BX.message("REPORT_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){var e=BX.findChildren(t,{tag:"input",attr:{type:"checkbox"},property:"checked"},true);for(var r in e){if(!e.hasOwnProperty(r))continue;var l=e[r];l.checked=false;BX.toggleClass(l.parentNode.parentNode,"reports-add-popup-checked")}this.popupWindow.close()}}})]});a.show();var n=BX.findChildren(t,{tagName:"span",className:"reports-add-popup-checkbox-block"},true);for(l=0;l<n.length;l++){BX.bind(n[l].parentNode,"click",check_uncheck)}var o=BX.findChildren(t,{tagName:"span",className:"reports-add-popup-arrow"},true);if(o){for(l=0;l<o.length;l++){BX.bind(o[l].parentNode,"click",open_close)}}}function check_uncheck(){var e=BX.findChild(this,{tagName:"input",className:"reports-add-popup-checkbox"},true,false);if(!BX.hasClass(this,"reports-add-popup-checked")&&e.checked){e.checked=true;BX.toggleClass(this,"reports-add-popup-checked");return false}BX.toggleClass(this,"reports-add-popup-checked");e.checked=BX.toggle(e.checked,[true,false])}function open_close(){BX.toggleClass(this,"reports-add-popup-arrow-open");var e=BX.findNextSibling(this,{tagName:"div"});if(BX.hasClass(e,"reports-add-popup-it-children"))BX.toggleClass(e,"reports-child-opened")}function addSelectColumn(e,t,r,l,i,a){if(!e){return}var n;if(l!=null){n=l;if(l>GLOBAL_REPORT_SELECT_COLUMN_COUNT){GLOBAL_REPORT_SELECT_COLUMN_COUNT=l}}else{n=GLOBAL_REPORT_SELECT_COLUMN_COUNT}var o=BX.clone(BX("reports-forming-column-example"),true);var s=BX("reports-add-columns-block");var d=BX("reports-add-column-block");o.style.display="";o.setAttribute("id","");BX.addClass(o,"reports-forming-column");var c=BX.findChild(o,{className:"reports-add-col-tit-text"},true);c.innerHTML=BX.util.htmlspecialchars(e.title);if(parseInt(e.getAttribute("isUF"))===1)BX.addClass(c,"uf");var p;p=BX.findChild(o,{attr:{name:"report_select_columns[%s][name]"}},true);p.name=p.name.replace("%s",n);p.value=e.name;p.title=e.title;p=BX.findChild(o,{attr:{name:"report_select_columns[%s][alias]"}},true);p.name=p.name.replace("%s",n);if(r&&r.length>0){p.value=r;p.parentNode.style.display="inline-block"}var u=parseInt(e.getAttribute("isMultiple"))===1;if(u){p=BX.create("SELECT")}else{p=BX.clone(BX("report-select-calc-"+e.name)||BX("report-select-calc-"+e.getAttribute("fieldType")),true)}p.id="";p.name="report_select_columns["+n+"][calc]";BX.addClass(p,"reports-add-col-select");BX.addClass(p,"reports-add-col-select-calc");var f,v;f=BX.findChild(o,{className:"reports-add-col-title"});v=BX.findChild(f,{className:"reports-add-col-input"});if(t>""){BX.findChild(o,{tag:"input",attr:{type:"checkbox"}},true).checked=true;p.style.display="inline-block";p.disabled=false;setSelectValue(p,t)}f.insertBefore(p,v);if(p.options.length<1){BX.findChild(o,{tag:"input",attr:{type:"checkbox"}},true).disabled=true}var B=BX.findChild(BX.findChild(o,{tag:"span",className:"reports-grouping-checkbox"}),{tag:"input",attr:{type:"checkbox"}});if(B){B.name="report_select_columns["+n+"][grouping]";if(!!i){B.checked=true;GLOBAL_REPORT_GROUPING_COLUMNS_COUNT++}}var h=BX.findChild(BX.findChild(o,{tag:"span",className:"reports-grouping-subtotal-checkbox"}),{tag:"input",attr:{type:"checkbox"}});if(h){h.name="report_select_columns["+n+"][grouping_subtotal]";if(!!a)h.checked=true}var m=BX.clone(BX.findChild(BX("report-select-prcnt-examples"),{className:"reports-add-col-select-prcnt"}));var X=BX.clone(BX.findChild(BX("report-select-prcnt-examples"),{className:"reports-add-col-select-prcnt-by"}));m.name="report_select_columns["+n+"][prcnt]";X.name="report_select_columns["+n+"][prcnt]";f=BX.findChild(o,{className:"reports-add-col-title"});v=BX.findChild(f,{className:"reports-add-col-input"});f.insertBefore(m,v);f.insertBefore(X,v);BX.bind(m,"change",function(e){var t=this.parentNode;var r=BX.findChild(t,{className:"reports-add-col-select-prcnt-by"});if(this.value=="self_column"){r.disabled=true;r.style.display="none"}else{r.disabled=false;r.style.display="inline-block"}rebuildPercentView();rebuildSortSelect()});BX.bind(X,"change",function(e){rebuildSortSelect()});BX.bind(BX.findChild(o,{className:"reports-add-col-button-up"},true),"click",function(e){var t=this.parentNode.parentNode.parentNode;var r=BX.findChildren(t,{className:"reports-forming-column"});var l=this.parentNode.parentNode;var i=null;for(var a in r){if(!r.hasOwnProperty(a))continue;if(r[a]==l){var n=r[a];if(i!=null){t.insertBefore(n,i)}}i=r[a]}rebuildPercentView();rebuildSortSelect()});BX.bind(BX.findChild(o,{className:"reports-add-col-button-down"},true),"click",function(e){var t=this.parentNode.parentNode;var r=BX.findNextSibling(t,{className:t.getAttribute("class")});if(r){BX.fireEvent(BX.findChild(r,{className:"reports-add-col-button-up"},true),"click")}rebuildPercentView();rebuildSortSelect();return false});BX.bind(BX.findChild(o,{className:"reports-add-col-tit-prcnt"},true),"click",function(e){var t=BX.hasClass(this,"reports-add-col-tit-prcnt-close");var r=BX.findChild(o,{className:"reports-add-col-select-prcnt"},true);var l=BX.findChild(o,{className:"reports-add-col-select-prcnt-by"},true);if(t){disablePrcntView(o)}else{if(isColumnPercentable(o)){r.style.display="inline-block";r.disabled=false;BX.addClass(this,"reports-add-col-tit-prcnt-close");BX.removeClass(this,"reports-add-col-tit-prcnt");if(r.value!="self_column"){l.style.display="inline-block";l.disabled=false}rebuildPercentView(true)}else{alert(BX.message("REPORT_PRCNT_VIEW_IS_NOT_AVAILABLE"))}}rebuildSortSelect();return false});BX.bind(BX.findChild(o,{className:"reports-add-col-tit-remove"},true),"click",function(e){var t=this.parentNode.parentNode;var r=BX.findChild(BX.findChild(o,{tag:"span",className:"reports-grouping-checkbox"}),{tag:"input",attr:{type:"checkbox"}});BX.remove(t);rebuildPercentView();rebuildSortSelect();if(r){if(r.checked){if(--GLOBAL_REPORT_GROUPING_COLUMNS_COUNT===0)enableReportLimit(true)}}return false});BX.bind(BX.findChild(o,{className:"reports-add-col-tit-edit"},true),"click",function(e){var t=this.parentNode.parentNode;var r=BX.findChild(t,{tag:"input",attr:{type:"text"}},true);r.parentNode.style.display="inline-block";BX.focus(r);return false});BX.bind(BX.findChild(o,{tag:"input",attr:{type:"text"}},true),"blur",hideAliasInput);BX.bind(BX.findChild(o,{tag:"input",attr:{type:"text"}},true),"change",hideAliasInput);var b=BX.findChild(o,{tag:"span",className:"reports-add-col-checkbox"},true);BX.bind(BX.findChild(b,{tag:"input",attr:{type:"checkbox"}},true),"click",function(e){var t=this.parentNode.parentNode;var r=BX.findChild(t,{className:"reports-add-col-select-calc"},true);r.style.display=this.checked?"inline-block":"none";r.disabled=this.checked?false:true;rebuildPercentView();rebuildSortSelect()});BX.bind(BX.findChild(o,{className:"reports-add-col-select-calc"},true),"change",function(e){rebuildPercentView();rebuildSortSelect()});if(B){BX.bind(B,"click",function(e){if(B.checked){if(++GLOBAL_REPORT_GROUPING_COLUMNS_COUNT===1)enableReportLimit(false)}else{if(--GLOBAL_REPORT_GROUPING_COLUMNS_COUNT===0)enableReportLimit(true)}})}s.insertBefore(o,d);rebuildPercentView();rebuildSortSelect();GLOBAL_REPORT_SELECT_COLUMN_COUNT++}function hideAliasInput(e){if(BX.util.trim(this.value)==""){this.value="";BX.hide(this.parentNode)}rebuildPercentView();rebuildSortSelect()}function rebuildSortSelect(){var e=BX("reports-sort-select");var t=e.value;var r=null,l;var i=[];var a=[];while(e.options.length>0){e.remove(0)}if(GLOBAL_BX_REPORT_USING_CHARTS){var n=BX("report-chart-config");i=chartGetYColTypes();if(n){r=BX.findChildren(n,{tag:"select",className:"report-chart-select-col"},true);for(l in r){if(r.hasOwnProperty(l)){a[l]=r[l].value;while(r[l].options.length>0)r[l].remove(0)}}}}var o=[];var s=BX.findChildren(BX("reports-add-columns-block"),{tag:"input",attr:{type:"hidden"}},true);var d=0;for(l in s){if(!s.hasOwnProperty(l))continue;if(s[l].value!=""){var c=s[l].parentNode;var p=s[l].name.match(/report_select_columns\[(\d+)\]\[name\]/);var u=p[1];var f,v;f=null;v=parseSelectColumnInfo(c);if(GLOBAL_BX_REPORT_USING_CHARTS){f=getFullColumnTitle(c);var B,h,m,X;var b=BX("report-chart-type");if(r){for(var C in r){if(!r.hasOwnProperty(C))continue;if(d===0)r[C].selectedIndex=0;B=new Option(f,u);m=v.column_type;B.setAttribute("data_type",v.column_type);X=true;if(b){X=false;h=b.value;if(i[h])X=!v.ismultiple&&i[h].indexOf(v.column_type)>=0}if(r[C].name==="chart_x"||X){try{r[C].add(B,null)}catch(e){r[C].add(B)}if(a[C]==u){r[C].selectedIndex=r[C].options.length-1}}}}d++}var N=["file","employee","crm_status","iblock_section","iblock_element","crm"];if(v.calc_enabled&&v.calc=="GROUP_CONCAT"||v.isuf&&(v.ismultiple||N.indexOf(v.column_type)>=0)){continue}if(f===null)f=getFullColumnTitle(c);var g=new Option(f,u);try{e.add(g,null)}catch(t){e.add(g)}if(t==u){e.selectedIndex=e.options.length-1}}}rebuildReportPreviewTable()}function rebuildFilterResultColumns(){BX("report-filter-result-columns-cont").innerHTML="";var e=BX.findChildren(BX("reports-add-columns-block"),{tag:"input",attr:{type:"hidden"}},true);var t={},r=null,l;for(l in e){if(!e.hasOwnProperty(l))continue;if(e[l].value!=""){var i=e[l].parentNode;r=parseSelectColumnInfo(i);if(r.prcnt){r.data_type="float"}else if(r.calc=="COUNT_DISTINCT"){r.data_type="integer"}else if(r.calc=="GROUP_CONCAT"){continue}t[r.num]=r;var a='<div class="reports-add-popup-item">'+'<span class="reports-add-pop-left-bord"></span>'+'<span class="reports-add-popup-checkbox-block">'+'<input class="reports-add-popup-checkbox" type="checkbox" fieldtype="'+r.data_type+'" '+'title="'+r.title+'" name="__COLUMN__'+r.num+'">'+"</span>"+'<span class="reports-add-popup-it-text">'+r.title+"</span>"+"</div>";BX("report-filter-result-columns-cont").innerHTML+=a}}var n=BX.findChildren(BX("report-filter-result-columns-cont"),{className:"reports-add-popup-it-text"},true);for(l in n){if(n.hasOwnProperty(l))BX.bind(n[l],"click",fillFilterColumnEvent)}var o=BX.findChildren(BX("reports-filter-columns-container"),{attr:{fielddefinition:/__COLUMN__\d+/}},true);for(l in o){if(!o.hasOwnProperty(l))continue;var s=o[l].parentNode.parentNode;var d=o[l].getAttribute("fielddefinition").match(/\d+/)[0];r=t[d];var c=o[l].getAttribute("fieldType");if(!r||c!=r.data_type){var p=BX.findChild(s,{className:"reports-filter-del-item"},true);BX.fireEvent(p,"click")}else{o[l].title=r.title;o[l].innerHTML=r.title}}}function rebuildHtmlSelect(e,t){var r=e.value;while(e.options.length>0){e.remove(0)}var l,i;for(l in t){if(!t.hasOwnProperty(l))continue;i=new Option(t[l],l);try{e.add(i,null)}catch(t){e.add(i)}if(r==l){e.selectedIndex=e.options.length-1}}}function getFullColumnTitle(e){var t="";var r=BX.findChild(e,{tag:"input",attr:{type:"hidden"},name:/report_select_columns\[\d+\]\[name\]/});var l=/\[(\d+)\]/.exec(r.name);var i=l[1];var a=BX.findChild(e,{attr:{name:"report_select_columns["+i+"][alias]"}},true);if(a.value!=""){t=a.value}else{t=r.title;var n=null;var o=BX.findChild(e,{tag:"span",className:"reports-add-col-checkbox"},true);if(o){n=BX.findChild(o,{tag:"input",attr:{type:"checkbox"},property:"checked"},true)}if(n!=null){var s=BX.findChild(e,{className:"reports-add-col-select-calc"},true);if(s.value!=""){t+=" ("+s.options[s.selectedIndex].text+")"}}var d=BX.findChild(e,{className:"reports-add-col-select-prcnt"},true);if(d.disabled==false){if(d.value=="self_column"){t+=" (%)"}else{var c=BX.findChild(e,{className:"reports-add-col-select-prcnt-by"},true);if(c.selectedIndex>=0){var p=c.options[c.selectedIndex].innerHTML;t+=" ("+BX.message("REPORT_PRCNT_BUTTON_TITLE")+" "+p+")"}}}}return t}function parseSelectColumnType(e){var t,r,l;var i,a,n,o;var s,d,c;l=null;t=BX.findChild(e,{tag:"input",attr:{type:"hidden"},name:/report_select_columns\[\d+\]\[name\]/});r=BX.findChild(BX("reports-add_col-popup-cont"),{attr:{type:"checkbox",name:t.value}},true);l=r.getAttribute("fieldType");i=BX.findChild(e,{className:"reports-checkbox",attr:{type:"checkbox"}},true);a=i.checked;n=BX.findChild(e,{className:"reports-add-col-select-calc"},true);o=null;if(n.value!="")o=n.value;s=BX.findChild(e,{className:"reports-add-col-select-prcnt"},true);c=null;if(s.disabled==false){if(s.value=="self_column")c=s.value;else{d=BX.findChild(e,{className:"reports-add-col-select-prcnt-by"},true);if(d.selectedIndex>=0)c=d.value}}if(c)l="float";else if(a){if(o=="COUNT_DISTINCT")l="integer";else if(o=="GROUP_CONCAT")l="string";else if(l=="boolean"){if(o=="MIN"||o=="AVG"||o=="MAX"||o=="SUM"||o=="COUNT_DISTINCT"){l="integer"}}}return l}function parseSelectColumnInfo(e){var t={num:null,name:null,title:null,data_type:null,calc_enabled:null,calc:null,prcnt:null,column_type:null,isgrc:null,isuf:null,ufid:null,ismultiple:null,ufname:null};var r=BX.findChild(e,{tag:"input",attr:{type:"hidden"},name:/report_select_columns\[\d+\]\[name\]/});var l=/\[(\d+)\]/.exec(r.name);t.num=l[1];t.name=r.value;var i=BX.findChild(BX("reports-add_col-popup-cont"),{attr:{type:"checkbox",name:t.name}},true);t.column_type=t.data_type=i.getAttribute("fieldType");t.title=getFullColumnTitle(e);var a=BX.findChild(e,{tag:"input",attr:{type:"checkbox"},property:"checked"},true);if(a!=null){var n=BX.findChild(e,{className:"reports-add-col-select-calc"},true);if(n.value!=""){t.calc=n.value}t.calc_enabled=a.checked}var o=BX.findChild(e,{className:"reports-add-col-select-prcnt"},true);if(o.disabled==false){if(o.value=="self_column"){t.prcnt=o.value}else{var s=BX.findChild(e,{className:"reports-add-col-select-prcnt-by"},true);if(s.selectedIndex>=0){t.prcnt=s.value}}}if(t.prcnt){t.column_type="float"}else if(t.calc_enabled){if(t.calc=="COUNT_DISTINCT"){t.column_type="integer"}else if(t.calc=="GROUP_CONCAT"){t.column_type="string"}else if(t.column_type=="boolean"){if(t.calc=="MIN"||t.calc=="AVG"||t.calc=="MAX"||t.calc=="SUM"||t.calc=="COUNT_DISTINCT"){t.column_type="integer"}}}t.isuf=parseInt(i.getAttribute("isuf"))===1;if(t.isuf){t.ufid=i.getAttribute("ufid");t.ismultiple=parseInt(i.getAttribute("ismultiple"))===1;t.ufname=i.getAttribute("ufname")}return t}function isColumnPercentable(e){var t=BX.findChild(e,{attr:{name:/report_select_columns\[\d+\]\[name\]/}}).value;var r=BX.findChild(BX("reports-add_col-popup-cont"),{attr:{type:"checkbox",name:t}},true);var l=r.getAttribute("fieldType");var i=parseInt(r.getAttribute("isUF"))===1;var a=parseInt(r.getAttribute("isMultiple"))===1;var n=null;var o=BX.findChild(e,{className:"reports-add-col-select-calc"},true);if(!o.disabled){n=o.value}if(n=="GROUP_CONCAT"){return false}else{return(l=="integer"||l=="float")&&(!i||!a)||l=="boolean"&&n!=null||n=="COUNT_DISTINCT"}}function rebuildPercentView(e){var t=BX.findChildren(BX("reports-add-columns-block"),{className:"reports-forming-column"});var r,l,i;var a={length:0};var n={};var o;for(r in t){if(!t.hasOwnProperty(r))continue;l=t[r];if(isColumnPercentable(l)){o=BX.findChild(l,{className:"reports-add-col-select-prcnt"},true);if(!o.disabled&&o.value=="self_column"){continue}var s=BX.findChild(l,{attr:{name:/report_select_columns\[\d+\]\[name\]/}});var d=/\[(\d+)\]/.exec(s.name);var c=d[1];var p=getFullColumnTitle(l);a[c]=p;a.length++;n[r]=c}}for(r in t){if(!t.hasOwnProperty(r))continue;l=t[r];i=BX.findChild(l,{className:"reports-add-col-tit-prcnt-close"},true);if(!i){continue}if(!isColumnPercentable(l)){disablePrcntView(l);continue}o=BX.findChild(l,{className:"reports-add-col-select-prcnt"},true);var u=BX.findChild(l,{className:"reports-add-col-select-prcnt-by"},true);var f=o.value;if(a.length<2){o.options[1].disabled=true;u.style.display="none";u.disabled=true;rebuildHtmlSelect(u,[])}else{o.options[1].disabled=false;if(f!="self_column"){u.style.display="inline-block";u.disabled=false}}var v=BX.findChild(l,{className:"reports-add-col-select-calc"},true);if(v.disabled||!v.disabled&&(v.value=="SUM"||v.value=="COUNT_DISTINCT")){o.options[0].disabled=false}else{o.options[0].disabled=true}if(o.options[0].disabled&&o.options[1].disabled){disablePrcntView(l);if(e){alert(BX.message("REPORT_PRCNT_VIEW_IS_NOT_AVAILABLE"))}return}if(f=="self_column"){if(o.options[0].disabled){setSelectValue(o,"other_field");disablePrcntView(l)}}else{if(a.length<2){setSelectValue(o,"self_column");disablePrcntView(l)}else{var B=u.value;var h=BX.clone(a);delete h[n[r]];delete h["length"];rebuildHtmlSelect(u,h);var m=u.value;if(B!=""&&B!=m){setSelectValue(o,"self_column");disablePrcntView(l)}}}}}function disablePrcntView(e){var t=BX.findChild(e,{className:"reports-add-col-tit-prcnt"},true)||BX.findChild(e,{className:"reports-add-col-tit-prcnt-close"},true);var r=BX.hasClass(t,"reports-add-col-tit-prcnt-close");var l=BX.findChild(e,{className:"reports-add-col-select-prcnt"},true);var i=BX.findChild(e,{className:"reports-add-col-select-prcnt-by"},true);BX.removeClass(t,"reports-add-col-tit-prcnt-close");BX.addClass(t,"reports-add-col-tit-prcnt");l.style.display="none";l.disabled=true;i.style.display="none";i.disabled=true}function rebuildReportPreviewTable(){var e=BX.findChild(BX("reports-preview-table-report"),{tag:"table"},true);var t=BX("reports-sort-select").options;var r=BX.create("TABLE");r.cellSpacing=0;BX.addClass(r,"reports-list-table");var l=r.createTHead().insertRow(-1);var i,a,n;for(i=0;i<t.length;i++){a=t[i].innerHTML;n=BX.create("TH");if(i==0){BX.addClass(n,"reports-first-column");BX.addClass(n,"reports-head-cell-top")}else if(i==t.length-1){BX.addClass(n,"reports-last-column")}n.innerHTML='<div class="reports-head-cell">'+'<span class="reports-head-cell-title">'+a+"</span></div>";l.appendChild(n)}e.parentNode.replaceChild(r,e)}function setSelectValue(e,t){var r,l;var i=false;var a=!!e.getAttribute("multiple");if(!(t instanceof Array))t=[t];for(r=0;r<e.options.length;r++){for(l in t){if(!t.hasOwnProperty(l))continue;if(e.options[r].value==t[l]){if(!i){i=true;e.selectedIndex=r}e.options[r].selected=true;break}}if(!a&&i)break}}function setPrcntView(e,t){var r=BX.findChild(BX("reports-add-columns-block"),{attr:{name:"report_select_columns["+e+"][name]"}},true).parentNode;if(t!=null&&t!=""){var l=BX.findChild(r,{className:"reports-add-col-tit-prcnt"},true);BX.addClass(l,"reports-add-col-tit-prcnt-close");BX.removeClass(l,"reports-add-col-tit-prcnt");var i=BX.findChild(r,{className:"reports-add-col-select-prcnt"},true);i.style.display="inline-block";i.disabled=false;if(t!="self_column"){var a=BX.findChild(r,{className:"reports-add-col-select-prcnt-by"},true);a.style.display="inline-block";a.disabled=false;setSelectValue(i,"other_field");rebuildPercentView();setSelectValue(a,t)}rebuildSortSelect()}}function initSelectColumnButton(){BX.ready(function(){BX.bind(BX("reports-add-select-column-button"),"click",function(){show_add_col_popup(this,BX("reports-add_col-popup-cont"))})})}function addFilterColumn(e,t){var r=BX.clone(BX("reports-filter-item-example"),true);r.style.display="";r.setAttribute("id","");BX.addClass(r,"reports-filter-item");var l=e.getAttribute("level")-0+1;if(l>2){BX.addClass(r,"reports-filter-sub-lev");BX.addClass(r,"reports-filter-"+(l-1)+"-lev")}if(l==2){var i=BX.findChildren(BX("reports-filter-columns-container"));if(i){BX.show(BX("reports-filter-base-andor-selector"))}}var a=BX.findChild(r,{className:"reports-filter-item-name"},true);BX.bind(a,"click",function(e){show_add_filcol_popup(this,BX("reports-add_filcol-popup-cont"));LAST_FILCOL_CALLED=this});var n=BX.findChild(r,{className:"reports-filter-add-item"},true);BX.bind(n,"click",function(e){var t=this.parentNode.parentNode;if(t.parentNode.getAttribute("level")=="1"){BX.show(BX("reports-filter-base-andor-selector"))}var r=t.parentNode;addFilterColumn(r,t)});var o=BX.findChild(r,{className:"reports-filter-del-item"},true);BX.bind(o,"click",function(e){var t=this.parentNode.parentNode;if(t.parentNode.getAttribute("level")=="1"&&t.parentNode.childNodes.length==1){addFilterColumn(BX("reports-filter-columns-container"))}if(t.parentNode.getAttribute("level")=="1"&&t.parentNode.childNodes.length==2){BX.hide(BX("reports-filter-base-andor-selector"))}var r=BX.findChildren(t.parentNode,{tag:"div",className:"reports-filter-item"}).length;if(t.parentNode.getAttribute("level")!="1"&&r==1){var l=BX.findChild(t.parentNode,{className:"reports-filter-del-item"},true);BX.fireEvent(l,"click");return false}BX.remove(t)});var s=BX.findChild(r,{className:"reports-filter-and-or"},true);if(l>4){BX.addClass(s,"reports-filter-and-or-disable")}else{BX.bind(s,"click",function(e){var t=this.parentNode.parentNode;if(t.parentNode.getAttribute("level")=="1"){BX.show(BX("reports-filter-base-andor-selector"))}addFilterAndor(t,2)})}if(t==null){e.appendChild(r)}else{BX.insertAfter(e,r,t)}return r}function addFilterAndor(e,t){var r=BX.clone(BX("reports-filter-andor-container-example"),true);var l=e?e.parentNode:BX("reports-filter-columns-container");var i=l.getAttribute("level")-0+1;if(i>4){alert("too much");return false}r.style.display="";r.setAttribute("id","");r.setAttribute("level",i);if(i>2){BX.addClass(r,"reports-filter-sub-lev");BX.addClass(r,"reports-filter-"+(i-1)+"-lev")}if(i==2){BX.show(BX("reports-filter-base-andor-selector"))}var a=BX.findChild(r,{className:"reports-filter-add-item"},true);BX.bind(a,"click",function(e){var t=this.parentNode.parentNode.parentNode;var r=t.parentNode;addFilterColumn(r,t)});var n=BX.findChild(r,{className:"reports-filter-del-item"},true);BX.bind(n,"click",function(e){var t=this.parentNode.parentNode;var r=t.parentNode;if(r.parentNode.getAttribute("level")=="1"&&r.parentNode.childNodes.length==1){return false}if(r.parentNode.getAttribute("level")=="1"&&r.parentNode.childNodes.length==2){BX.hide(BX("reports-filter-base-andor-selector"))}BX.remove(r)});var o=BX.findChild(r,{className:"reports-filter-and-or"},true);if(i>3){BX.addClass(o,"reports-filter-and-or-disable")}else{BX.bind(o,"click",function(e){var t=this.parentNode.parentNode.parentNode;addFilterAndor(t,2)})}var s=BX.findChild(r,{tag:"select"},true);BX.bind(s,"change",function(){BX.findNextSibling(this,{className:"reports-limit-res-select-lable-or"}).style.display=this.value=="OR"?"inline-block":"none";BX.findNextSibling(this,{className:"reports-limit-res-select-lable-and"}).style.display=this.value=="AND"?"inline-block":"none"});s.setAttribute("filterId",GLOBAL_REPORT_FILTER_COUNT++);BX.insertAfter(l,r,e);var d;for(d=0;d<t;d++){addFilterColumn(a.parentNode.parentNode.parentNode,a.parentNode.parentNode)}return r}function baseSelectorChangeEvent(e,t){var r=t||this;BX("reports-filter-base-andor-selector-text-or").style.display=r.value=="OR"?"inline-block":"none";BX("reports-filter-base-andor-selector-text-and").style.display=r.value=="AND"?"inline-block":"none"}function restoreSubFilter(e,t){var r=GLOBAL_PRE_FILTERS;var l=e||BX("reports-filter-columns-container");var i=e?BX.findChild(l,{className:"reports-filter-andor-item"}):BX("reports-filter-base-andor-selector");setSelectValue(BX.findChild(i,{tag:"select"}),t["LOGIC"]);var a=null;var n=null;var o;for(o in t){if(!t.hasOwnProperty(o))continue;if(o=="LOGIC"){continue}var s=t[o];if(s.type=="field"){n=addFilterColumn(l);var d=BX.findChild(BX("reports-add_filcol-popup-cont"),{attr:{type:"checkbox",name:s.name}},true);var c=BX.findChild(d.parentNode.parentNode,{className:"reports-add-popup-it-text"},true);var p=BX.findChild(n,{className:"reports-filter-item-name"},true);LAST_FILCOL_CALLED=p;fillFilterColumnEvent(null,c);var u=BX.findChild(n,{attr:{name:"compare"}});setSelectValue(u,s.compare);var f=BX.findChild(n,{attr:{name:"value"}},true);if(f){if(f.getAttribute("type")=="hidden"){f=f.parentNode}switch(f.nodeName.toLowerCase()){case"input":f.value=s.value;break;case"select":setSelectValue(f,s.value);break;default:if(f.getAttribute("callback")!=null){var v=f.getAttribute("callback");var B=v+"_LAST_CALLER";var h=v+"Catch";var m=BX.findChild(f,{attr:"caller"},true);window[B]=m;window[h](s.value)}}}else{var X,b,C,N,g,_;if(BX.hasClass(n,"reports-filter-item")){X=BX.findChild(n,{className:"reports-dashed"},true);b=null;C=X&&parseInt(X.getAttribute("isUF"))===1;if(C){N=X.getAttribute("ufId");g=X.getAttribute("ufName");_=parseInt(X.getAttribute("ufSelectorIndex"));if(N&&g){if(BX.Report&&BX.Report.FilterFieldSelectorManager)b=BX.Report.FilterFieldSelectorManager.getSelector(N,g);if(b)b.setFilterValue(_,s.value)}}}}BX.findChild(n,{attr:{name:"changeable"}},true).checked=!!parseInt(s.changeable);a=n}else if(s.type=="filter"){n=addFilterAndor(a);restoreSubFilter(n,r[s.name]);a=n}}}function startSubFilterRestore(){if(GLOBAL_PRE_FILTERS!=null){var e=GLOBAL_PRE_FILTERS;restoreSubFilter(null,e[0])}else{addFilterColumn(BX("reports-filter-columns-container"))}}function setReportLimit(e,t){var r=BX("report-filter-limit-checkbox");var l=BX("report-filter-limit-input");if(arguments.length>0){r.checked=!!e;if(arguments.length===2)l.value=parseInt(t)}if(r.checked){l.disabled=false;l.style.backgroundColor="#ffffff"}else{l.disabled=true;l.style.backgroundColor="#eeeeee"}}function enableReportLimit(e){var t=BX("report-filter-limit-checkbox");var r=BX("report-filter-limit-input");t.disabled=!e;r.disabled=!e}function initFilterControls(){BX.ready(function(){BX.insertAfter=function(e,t,r){var l=null;var i=false;for(var a=0;a<=e.childNodes.length;a++){if(i){l=e.childNodes[a];break}if(e.childNodes[a]==r){i=true}}if(l!=null){e.insertBefore(t,l)}else if(i){e.appendChild(t)}return t};BX("reports-filter-columns-container").setAttribute("level",1);var e=BX.findChild(BX("reports-filter-base-andor-selector"),{tag:"select"},true);BX.bind(e,"change",baseSelectorChangeEvent);BX.bind(BX("report-filter-limit-checkbox"),"click",function(e){setReportLimit();BX.focus(BX("report-filter-limit-input"))})})}function createHiddenInput(e,t){return BX.create("input",{props:{type:"hidden",name:e,value:t}})}function parseFilterElems(e,t,r){var l=BX.findChildren(e,{tag:"div"});var i=0;var a=null,n=null;var o,s,d,c,p;var u,f,v;for(u in l){if(!l.hasOwnProperty(u))continue;f={};if(BX.hasClass(l[u],"reports-filter-item")){f.type="field";n=BX.findChild(l[u],{className:"reports-dashed"},true);f.name=n.getAttribute("fieldDefinition");if(f.name==null){continue}c=null;o=parseInt(n.getAttribute("isUF"))===1;if(o){s=n.getAttribute("ufId");d=n.getAttribute("ufName");p=parseInt(n.getAttribute("ufSelectorIndex"));if(s&&d){if(BX.Report&&BX.Report.FilterFieldSelectorManager)c=BX.Report.FilterFieldSelectorManager.getSelector(s,d)}}v=BX.findChild(l[u],{attr:{name:"compare"}},true);if(!v){continue}f.compare=v.value;a=BX.findChild(l[u],{attr:{name:"value"}},true);if(a){if(a.tagName==="SELECT"&&a.getAttribute("multiple")==="multiple"){var B=a.options;var h=[];var m=0;for(var X=0;X<B.length;X++){if(B[X].selected)h[m++]=B[X].value}f.value=h.length>0?h:""}else f.value=a.value}else if(c){f.value=c.getFilterValue(p)}f.changeable=BX.findChild(l[u],{attr:{name:"changeable"}},true).checked?"1":"0"}else if(BX.hasClass(l[u],"reports-filter-andor-container")){f.type="filter";f.name=BX.findChild(l[u],{tag:"select"},true).getAttribute("filterId");t[f.name]={};var b=BX.findChild(l[u],{className:"reports-filter-andor-item"});t[f.name]["logic"]=BX.findChild(b,{tag:"select"}).value;parseFilterElems(l[u],t,f.name)}else{continue}t[r][i++]=f}}function initSaveButton(){BX.ready(function(){BX.bind(BX("report-save-button"),"click",function(e){BX.PreventDefault(e);var t={};var r=BX("reports-filter-columns-container");t[0]={};t[0]["logic"]=BX.findChild(BX("reports-filter-base-andor-selector"),{tag:"select"}).value;parseFilterElems(r,t,0);var l=BX("task-filter-form");var i,a,n,o;var s,d,c,p;for(i in t){if(!t.hasOwnProperty(i))continue;s=i;d=t[i];for(a in d){if(!d.hasOwnProperty(a))continue;c=d[a];if(a=="logic"){l.appendChild(createHiddenInput("filters["+i+"]["+a+"]",c))}else{for(n in c){if(!c.hasOwnProperty(n))continue;if(c[n]instanceof Array){p=c[n];for(o in p){if(p.hasOwnProperty(o)){l.appendChild(createHiddenInput("filters["+i+"]["+a+"]["+n+"]["+o+"]",p[o]))}}}else l.appendChild(createHiddenInput("filters["+i+"]["+a+"]["+n+"]",c[n]))}}}}BX("task-filter-form").submit()})})}function fillFilterColumnEvent(e,t){var r=t||this;var l,i,a,n;var o=BX.findChild(r.parentNode,{tag:"input",attr:{type:"checkbox"}},true);l=parseInt(o.getAttribute("isUF"))===1;i=o.getAttribute("fieldType");if(l){a=o.getAttribute("ufId");n=o.getAttribute("ufName")}var s=BX.findChild(LAST_FILCOL_CALLED,{className:"reports-dashed"});s.innerHTML=BX.util.htmlspecialchars(o.title);s.title=o.title;s.setAttribute("fieldDefinition",o.name);s.setAttribute("fieldType",i);if(l&&a){s.setAttribute("isUF","1");s.setAttribute("ufId",a);s.setAttribute("ufName",n)}var d=LAST_FILCOL_CALLED.parentNode;var c=BX.findChildren(d,{className:"reports-filter-column-helper"});for(var p in c){if(c.hasOwnProperty(p))BX.remove(c[p])}var u=BX.clone(BX("report-filter-compare-"+o.name)||BX("report-filter-compare-"+o.getAttribute("fieldType")),true);if(!u){return}u.id="";u.name="compare";BX.addClass(u,"reports-filter-column-helper");var f=BX.findChild(d,{className:"reports-filter-butt-wrap"});d.insertBefore(u,f);var v=null;var B=true;if(l&&i==="enum"){v=BX.clone(BX.findChild(BX("report-filter-value-control-examples-ufenums"),{attr:{name:"report-filter-value-control-"+a+"_"+n}}),true)}else if(l&&(i==="crm"||i==="crm_status"||i==="iblock_element"||i==="iblock_section")){var h=null;if(BX.Report&&BX.Report.FilterFieldSelectorManager)h=BX.Report.FilterFieldSelectorManager.getSelector(a,n);if(h){v=h.makeFilterField(d,f);if(v){B=false;var m=v.getAttribute("ufSelectorIndex");if(m.length>0)s.setAttribute("ufSelectorIndex",m)}}}if(!v){v=BX.clone(BX.findChild(BX("report-filter-value-control-examples-custom"),{attr:{name:"report-filter-value-control-"+o.name}})||BX.findChild(BX("report-filter-value-control-examples-custom"),{attr:{name:"report-filter-value-control-"+i}})||BX.findChild(BX("report-filter-value-control-examples"),{attr:{name:"report-filter-value-control-"+i}}),true)}BX.addClass(v,"reports-filter-column-helper");if(v.getAttribute("callback")!=null){var X=v.getAttribute("callback");window[X](v)}if(o.getAttribute("fieldType")=="datetime"){var b=BX.findChild(v,{tag:"img"});BX.bind(b,"click",function(e){if(!e)e=window.event;var t=BX.findChild(this.parentNode,{attr:{name:"value"}});var r=new Date;var l=Math.round(r/1e3)-r.getTimezoneOffset()*60;BX.calendar({node:this,field:t,bTime:false});BX.PreventDefault(e)})}if(B)d.insertBefore(v,f);var C=BX.findParent(r,{callback:function(e){return e.id.substr(0,21)=="reports-add_col-popup"}});var N=BX.findChild(C,{className:"popup-window-close-icon"});try{BX.fireEvent(N,"click")}catch(e){}}function initFilterPopupItems(){BX.ready(function(){var e=BX.findChildren(BX("reports-add_filcol-popup-cont"),{className:"reports-add-popup-it-text"},true);var t,r,l=true;for(var i in e){if(!e.hasOwnProperty(i))continue;if(BX.hasClass(e[i].parentNode,"reports-add-popup-it-node")){continue}l=true;t=BX.findChild(e[i].parentNode,{tag:"input",attr:{type:"checkbox"}},true);if(t){r=BX.clone(BX("report-filter-compare-"+t.name)||BX("report-filter-compare-"+t.getAttribute("fieldType")),true);if(r){l=false;BX.bind(e[i],"click",fillFilterColumnEvent)}}if(l){e[i].parentNode.style.display="none"}}})}function initReportControls(){initIntervalFilter();initSelectColumnButton();initFilterControls();initSaveButton();initFilterPopupItems()}