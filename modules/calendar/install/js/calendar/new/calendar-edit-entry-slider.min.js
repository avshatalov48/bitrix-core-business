(function(e){function t(e){this.calendar=e;this.sliderId="calendar:edit-entry-slider";this.zIndex=3100;this.DOM={};this.denyClose=false;this.formSettings={pinnedFields:{}}}t.prototype={show:function(e){this.id="calendar_slider_"+Math.round(Math.random()*1e6);this.editorId=this.id+"_entry_slider_editor";this.entry=e.entry||this.getNewEntry(e.entry||e.newEntryData);this.tryLocation=e.tryLocation||false;this.formType=e.formType||"slider_main";this.formSettings=this.getSettings();BX.SidePanel.Instance.open(this.sliderId,{contentCallback:BX.delegate(this.createContent,this)});BX.bind(document,"keydown",BX.proxy(this.keyHandler,this));BX.addCustomEvent("SidePanel.Slider:onClose",BX.proxy(this.hide,this));BX.addCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.bind(document,"click",BX.proxy(this.calendar.util.applyHacksForPopupzIndex,this.calendar.util));this.calendar.disableKeyHandler();setTimeout(BX.delegate(function(){this.calendar.disableKeyHandler()},this),300);this.opened=true},createContent:function(t){var i=new BX.Promise;BX.ajax.get(this.calendar.util.getActionUrl(),{action:"get_edit_slider",event_id:this.entry.id,unique_id:this.id,form_type:this.formType,sessid:BX.bitrix_sessid(),bx_event_calendar_request:"Y",reqId:Math.round(Math.random()*1e6)},BX.delegate(function(s){if(BX.type.isFunction(t.isOpen)&&t.isOpen()||t.isOpen===true){i.fulfill(BX.util.trim(s));this.initControls()}else{if(e["BXHtmlEditor"]){var a=e["BXHtmlEditor"].Get(this.editorId);if(a){a.Destroy()}}}},this));return i},close:function(){BX.SidePanel.Instance.close()},hide:function(e){if(e&&e.getSliderPage&&e.getSliderPage().getUrl()===this.sliderId){if(this.checkDenyClose()){e.denyAction()}else{BX.removeCustomEvent("SidePanel.Slider::onClose",BX.proxy(this.hide,this));if(this.attendeesSelector)this.attendeesSelector.closeAll()}}},destroy:function(t){if(t&&t.getSliderPage&&t.getSliderPage().getUrl()===this.sliderId){if(e.LHEPostForm&&e.LHEPostForm.unsetHandler&&LHEPostForm.getHandler(this.editorId)){e.LHEPostForm.unsetHandler(this.editorId)}BX.onCustomEvent("OnCalendarPlannerDoUninstall",[{plannerId:this.plannerId}]);BX.removeCustomEvent("OnDestinationAddNewItem",BX.proxy(this.checkPlannerState,this));BX.removeCustomEvent("OnDestinationUnselect",BX.proxy(this.checkPlannerState,this));BX.removeCustomEvent("OnCalendarPlannerSelectorChanged",BX.proxy(this.onCalendarPlannerSelectorChanged,this));BX.removeCustomEvent("SidePanel.Slider:onCloseComplete",BX.proxy(this.destroy,this));BX.SidePanel.Instance.destroy(this.sliderId);if(this.attendeesSelector)this.attendeesSelector.closeAll();this.calendar.enableKeyHandler();BX.unbind(document,"click",BX.proxy(this.calendar.util.applyHacksForPopupzIndex,this.calendar.util));this.opened=false}},isOpened:function(){return this.opened},denySliderClose:function(){this.denyClose=true},allowSliderClose:function(){this.denyClose=false},checkDenyClose:function(){if(BX(this.id+"_time_from_div")&&BX(this.id+"_time_from_div").style.display!="none")return true;if(BX(this.id+"_time_to_div")&&BX(this.id+"_time_to_div").style.display!="none")return true;return this.denyClose},initControls:function(){this.DOM.title=BX(this.id+"_title");this.DOM.formWrap=BX(this.id+"_form_wrap");this.DOM.form=BX(this.id+"_form");this.DOM.importanceCheckbox=BX(this.id+"_important");this.DOM.entryName=BX.adjust(BX(this.id+"_entry_name"),{events:{click:t}});this.DOM.privateCheckbox=BX(this.id+"_private");BX.bind(BX(this.id+"_save"),"click",BX.proxy(this.save,this));BX.bind(BX(this.id+"_close"),"click",BX.proxy(this.close,this));BX(this.id+"_save_cmd").innerHTML=BX.browser.IsMac()?"(Cmd+Enter)":"(Ctrl+Enter)";this.initDateTimeControl();this.initReminderControl();this.initSectionSelector();this.initEditorControl();this.initLocationControl();this.initRepeatRuleControl();this.initAttendeesControl();this.initColorControl();if(this.calendar.util.isMeetingsEnabled()&&this.entry.accessibility){BX(this.id+"_accessibility").value=this.entry.accessibility}if(this.entry.important){BX(this.id+"_important").checked=this.entry.important}if(this.calendar.util.isPrivateEventsEnabled()&&this.entry.private){BX(this.id+"_private").checked=this.entry.private}this.DOM.mainBlock=BX(this.id+"_main_block_wrap");this.DOM.additionalBlockWrap=BX(this.id+"_additional_block_wrap");this.DOM.additionalBlock=BX(this.id+"_additional_block");this.DOM.pinnedNamesWrap=BX(this.id+"_additional_pinned_names");this.DOM.additionalSwitch=BX.adjust(BX(this.id+"_additional_switch"),{events:{click:BX.proxy(function(){if(BX.hasClass(this.DOM.additionalSwitch,"opened")){this.hideAdditionalBlock()}else{this.showAdditionalBlock()}},this)}});BX.bind(this.DOM.formWrap,"click",BX.delegate(function(e){var t=e.target||e.srcElement;if(t&&t.getAttribute&&t.getAttribute("data-bx-fixfield")){var i=t.getAttribute("data-bx-fixfield");if(!this.fieldIsPinned(i)){this.pinField(i)}else{this.unPinField(i)}}},this));this.DOM.entryName.value=this.entry.name;setTimeout(BX.delegate(function(){this.DOM.entryName.focus();this.DOM.entryName.select()},this),500);this.checkLastItemBorder();var e=this;function t(){e.DOM.entryName.select();BX.unbind(e.DOM.entryName,"click",t)}},initDateTimeControl:function(){var e=this;this.DOM.dateTimeWrap=BX(this.id+"_datetime_container");this.DOM.fromDate=BX.adjust(BX(this.id+"_date_from"),{events:{click:t,change:i}});this.DOM.toDate=BX.adjust(BX(this.id+"_date_to"),{events:{click:t,change:s}});this.DOM.fromTime=BX.adjust(BX(this.id+"_time_from"),{events:{click:function(){e.showClock("time_from")},change:a}});this.DOM.toTime=BX.adjust(BX(this.id+"_time_to"),{events:{click:function(){e.showClock("time_to")}},change:n});this.DOM.fullDay=BX.adjust(BX(this.id+"_date_full_day"),{events:{click:BX.proxy(this.switchFullDay,this)}});this.DOM.defTimezoneWrap=BX(this.id+"_timezone_default_wrap");this.DOM.defTimezone=BX(this.id+"_timezone_default");this.DOM.fromTz=BX.adjust(BX(this.id+"_timezone_from"),{events:{change:r}});this.DOM.toTz=BX.adjust(BX(this.id+"_timezone_to"),{events:{click:o}});this.DOM.tzButton=BX.adjust(BX(this.id+"_timezone_btn"),{events:{click:BX.proxy(this.switchTimezone,this)}});this.DOM.tzOuterCont=BX(this.id+"_timezone_wrap");this.DOM.tzCont=BX(this.id+"_timezone_inner_wrap");BX(this.id+"_timezone_hint").title=BX.message("EC_EVENT_TZ_HINT");BX(this.id+"_timezone_default_hint").title=BX.message("EC_EVENT_TZ_DEF_HINT");BX.bind(this.DOM.fromTz,"change",BX.delegate(function(){if(this.linkFromToTz)this.DOM.toTz.value=this.DOM.fromTz.value;this.linkFromToDefaultTz=false},this));BX.bind(this.DOM.toTz,"change",BX.delegate(function(){this.linkFromToTz=false;this.linkFromToDefaultTz=false},this));BX.bind(this.DOM.defTimezone,"change",BX.delegate(function(){this.calendar.util.setUserOption("timezoneName",this.DOM.defTimezone.value);if(this.linkFromToDefaultTz)this.DOM.fromTz.value=this.DOM.toTz.value=this.DOM.defTimezone.value},this));this.linkFromToTz=this.DOM.fromTz.value==this.DOM.toTz.value;this.linkFromToDefaultTz=this.DOM.fromTz.value==this.DOM.toTz.value&&this.DOM.fromTz.value==this.DOM.defTimezone.value;BX.addCustomEvent("onJCClockInit",function(t){if(t.inputId==e.id+"_time_from"||t.inputId==e.id+"_time_to"){JCClock.setOptions({popupHeight:250})}});function t(){BX.calendar({node:this.parentNode,field:this,bTime:false});e.denySliderClose();if(BX.calendar.get().popup)BX.removeCustomEvent(BX.calendar.get().popup,"onPopupClose",BX.proxy(e.allowSliderClose,e));BX.addCustomEvent(BX.calendar.get().popup,"onPopupClose",BX.proxy(e.allowSliderClose,e))}function i(){if(e._fromDateValue){var t=e.calendar.util.parseTime(e.DOM.fromTime.value),i=e.calendar.util.parseTime(e.DOM.toTime.value),s=BX.parseDate(e.DOM.fromDate.value),a=BX.parseDate(e.DOM.toDate.value);if(e.DOM.fullDay.checked&&e._fromDateValue){e._fromDateValue.setHours(0,0,0)}else{if(s&&t){s.setHours(t.h,t.m,0)}if(a&&i){a.setHours(i.h,i.m,0)}}if(s&&e._fromDateValue){a=new Date(s.getTime()+(a.getTime()-e._fromDateValue.getTime()||36e5));if(a){e.DOM.toDate.value=e.calendar.util.formatDate(a)}}}e._fromDateValue=s;e.refreshPlannerState()}function s(){e.refreshPlannerState()}function a(){var t=e.calendar.util.parseTime(e.DOM.fromTime.value),i=e.calendar.util.parseTime(e.DOM.toTime.value),s=BX.parseDate(e.DOM.fromDate.value),a=BX.parseDate(e.DOM.toDate.value);if(s&&t)s.setHours(t.h,t.m,0);if(a&&i)a.setHours(i.h,i.m,0);if(e._fromDateValue){var n=new Date(e.calendar.util.getTimeEx(s)+e.calendar.util.getTimeEx(a)-e.calendar.util.getTimeEx(e._fromDateValue));e.DOM.toTime.value=e.calendar.util.formatTime(n);e.DOM.toDate.value=e.calendar.util.formatDate(n)}e._fromDateValue=s;e.refreshPlannerState()}function n(){e.refreshPlannerState()}function r(){if(e.linkFromToTz)e.DOM.toTz.value=e.DOM.fromTz.value;e.linkFromToDefaultTz=false;e.refreshPlannerState()}function o(){e.linkFromToTz=false;e.linkFromToDefaultTz=false;e.refreshPlannerState()}if(this.calendar.util.getUserOption("timezoneName")){this.DOM.defTimezone.value=this.calendar.util.getUserOption("timezoneName")||this.calendar.util.getUserOption("timezoneDefaultName")}else{this.DOM.defTimezoneWrap.style.display="";this.DOM.defTimezone.value=this.calendar.util.getUserOption("timezoneDefaultName")||"";if(this.DOM.defTimezone.value){this.calendar.util.setUserOption("timezoneName",this.DOM.defTimezone.value)}}this.DOM.fullDay.checked=this.entry.fullDay;this.switchFullDay();var l,d;if(this.entry.id){l=BX.parseDate(this.entry.data.DATE_FROM);d=new Date(l.getTime()+(this.entry.data.DT_LENGTH-(this.entry.fullDay?1:0))*1e3)}else{l=this.entry.from;d=this.entry.to}this.DOM.fromDate.value=this.calendar.util.formatDate(l);this.DOM.fromTime.value=this.calendar.util.formatTime(l.getHours(),l.getMinutes());this.DOM.toDate.value=this.calendar.util.formatDate(d);this.DOM.toTime.value=this.calendar.util.formatTime(d.getHours(),d.getMinutes());this._fromDateValue=this.entry.from;this.DOM.fromTz.value=this.entry.data&&this.entry.data.TZ_FROM?this.entry.data.TZ_FROM:this.DOM.defTimezone.value;this.DOM.toTz.value=this.entry.data&&this.entry.data.TZ_TO?this.entry.data.TZ_TO:this.DOM.defTimezone.value},showClock:function(e){top["bxShowClock_"+this.id+"_"+e]();setTimeout(BX.delegate(function(){if(BX(this.id+"_"+e+"_div")){BX.addClass(BX(this.id+"_"+e+"_div"),"calendar-clock-wrap")}},this),50)},switchFullDay:function(e){e=this.DOM.fullDay.checked;if(e&&this.calendar.util.getUserOption("timezoneName")&&(this.DOM.fromTz.value==""||this.DOM.toTz.value=="")){this.DOM.fromTz.value=this.DOM.toTz.value=this.DOM.defTimezone.value=this.calendar.util.getUserOption("timezoneName")}if(e){BX.addClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}else{BX.removeClass(this.DOM.dateTimeWrap,"calendar-options-item-datetime-hide-time")}this.refreshPlannerState()},switchTimezone:function(){if(BX.hasClass(this.DOM.tzCont,"calendar-options-timezone-collapse")){BX.addClass(this.DOM.tzCont,"calendar-options-timezone-expand");BX.removeClass(this.DOM.tzCont,"calendar-options-timezone-collapse")}else{BX.addClass(this.DOM.tzCont,"calendar-options-timezone-collapse");BX.removeClass(this.DOM.tzCont,"calendar-options-timezone-expand")}},initReminderControl:function(){var t=this;this.reminderValues=[];this.DOM.reminderValuesWrap=BX(this.id+"_reminder_values_wrap");this.DOM.reminderInputsWrap=BX(this.id+"_reminder_inputs_wrap");this.DOM.reminderAddButton=BX(this.id+"_reminder_add_button");var i=[15];if(this.entry&&this.entry.remind){i=this.entry.remind}else if(this.entry.getReminders){i=this.entry.getReminders()}this.reminder=new e.BXEventCalendar.ReminderSelector({id:"reminder-slider-"+this.calendar.id,selectedValues:i,values:this.calendar.util.getRemindersList(),valuesContainerNode:this.DOM.reminderValuesWrap,addButtonNode:this.DOM.reminderAddButton,zIndex:this.zIndex,changeCallack:function(e){t.reminderValues=e;BX.cleanNode(t.DOM.reminderInputsWrap);t.reminderValues.forEach(function(e){t.DOM.reminderInputsWrap.appendChild(BX.create("INPUT",{props:{name:"reminder[]",type:"hidden"},attrs:{value:e}}))})},showPopupCallBack:function(){t.denySliderClose()},hidePopupCallBack:function(){t.allowSliderClose()}})},initSectionSelector:function(){this.DOM.sectionWrap=BX(this.id+"_section_wrap");this.DOM.sectionInput=BX(this.id+"_section");var e=this.entry.section;if(!e&&this.entry.sectionId)e=this.calendar.sectionController.getSection(this.entry.sectionId);this.DOM.sectionInput.value=e.id;this.DOM.sectionSelect=this.DOM.sectionWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field calendar-field-select"}}));this.DOM.sectionSelectInner=this.DOM.sectionSelect.appendChild(BX.create("DIV",{props:{className:"calendar-field-select-icon"},style:{backgroundColor:e.color}}));this.DOM.sectionSelectInnerText=this.DOM.sectionSelect.appendChild(BX.create("SPAN",{text:e.name}));BX.bind(this.DOM.sectionSelect,"click",s);var t=this,i=this.calendar.sectionController.getSectionListForEdit();function s(){if(t.sectionMenu&&t.sectionMenu.popupWindow&&t.sectionMenu.popupWindow.isShown()){return t.sectionMenu.close()}var e,s=[],a;for(e=0;e<i.length;e++){s.push({id:"bx-calendar-section-"+i[e].id,text:BX.util.htmlspecialchars(i[e].name),color:i[e].color,className:"calendar-add-popup-section-menu-item",onclick:function(e){return function(){var i=t.calendar.sectionController.getSection(e);t.calendar.util.setUserOption("lastUsedSection",i.id);t.DOM.sectionInput.value=i.id;t.DOM.sectionSelectInner.style.backgroundColor=i.color;t.setColor(i.color);t.DOM.sectionSelectInnerText.innerHTML=BX.util.htmlspecialchars(i.name);t.sectionMenu.close()}}(i[e].id)})}t.sectionMenu=BX.PopupMenu.create("sectionMenuSlider"+t.calendar.id,t.DOM.sectionSelect,s,{closeByEsc:true,autoHide:true,zIndex:t.zIndex,offsetTop:0,offsetLeft:0});t.sectionMenu.popupWindow.contentContainer.style.maxHeight="300px";t.sectionMenu.popupWindow.setWidth(t.DOM.sectionSelect.offsetWidth-2);t.sectionMenu.show();for(e=0;e<t.sectionMenu.menuItems.length;e++){if(t.sectionMenu.menuItems[e].layout.item){a=t.sectionMenu.menuItems[e].layout.item.querySelector(".menu-popup-item-icon");if(a){a.style.backgroundColor=t.sectionMenu.menuItems[e].color}}}BX.addClass(t.DOM.sectionSelect,"active");BX.addCustomEvent(t.sectionMenu.popupWindow,"onPopupClose",function(){BX.removeClass(t.DOM.sectionSelect,"active");BX.PopupMenu.destroy("sectionMenuSlider"+t.calendar.id)})}},initEditorControl:function(){if(!e["BXHtmlEditor"]){return setTimeout(BX.delegate(this.initEditorControl,this),100)}var t=this,i=e["BXHtmlEditor"].Get(this.editorId);if(i&&i.IsShown()){s(i)}else{BX.addCustomEvent(e["BXHtmlEditor"],"OnEditorCreated",function(e){if(e.id==t.editorId){s(e)}})}function s(e){if(e.toolbar.controls&&e.toolbar.controls.spoiler){BX.remove(e.toolbar.controls.spoiler.pCont)}}if(this.entry&&this.entry.data&&this.entry.data.DESCRIPTION)this.descriptionValue=this.entry.data.DESCRIPTION;else if(this.DOM.form&&this.DOM.form.desc&&this.DOM.form.desc.value)this.descriptionValue=this.DOM.form.desc.value;else this.descriptionValue=""},initLocationControl:function(){this.locationSelector=new e.BXEventCalendar.LocationSelector(this.calendar.id+"-slider-location",{inputName:"location_text",wrapNode:BX(this.id+"_location_wrap"),onChangeCallback:BX.proxy(this.checkPlannerState,this),value:this.tryLocation?this.tryLocation:this.entry.location},this.calendar)},initRepeatRuleControl:function(){this.DOM.rruleWrap=BX(this.id+"_rrule_wrap");this.DOM.endsonDateInput=BX(this.id+"_endson_date_input");this.DOM.endsonDateRadio=BX(this.id+"_endson_date");this.DOM.rruleType=BX.adjust(BX(this.id+"_rrule_type"),{events:{change:BX.delegate(function(){this.DOM.rruleWrap.className="calendar-rrule-type-"+this.DOM.rruleType.value.toLowerCase()},this)}});BX.bind(this.DOM.endsonDateInput,"click",BX.proxy(function(){this.DOM.endsonDateRadio.checked="checked";BX.calendar({node:this.DOM.endsonDateInput,field:this.DOM.endsonDateInput,bTime:false});BX.focus(this.DOM.endsonDateInput)},this));if(this.entry&&this.entry.isRecursive&&this.entry.isRecursive()){var e=this.entry.getRrule();this.DOM.rruleType.value=e.FREQ;this.DOM.rruleWrap.className="calendar-rrule-type-"+e.FREQ.toLowerCase();BX(this.id+"_rrule_count").value=e.INTERVAL;if(e.COUNT){BX(this.id+"_endson_count").checked="checked";BX(this.id+"event-endson-count-input").value=e.COUNT}else if(e["~UNTIL"]){BX(this.id+"_endson_date").checked="checked";BX(this.id+"_endson_date_input").value=e["~UNTIL"]}else{BX(this.id+"_endson_never").checked="checked"}if(e.BYDAY&&typeof e.BYDAY=="object"){for(var t in e.BYDAY){if(e.BYDAY.hasOwnProperty(t)){BX(this.id+"_rrule_byday_"+t).checked="checked"}}}}},initAttendeesControl:function(){if(!this.calendar.util.isMeetingsEnabled()){BX.remove(this.DOM.formWrap.querySelector(".calendar-options-item-destination"));BX.remove(this.DOM.formWrap.querySelector(".calendar-options-item-planner"));return}this.DOM.attendeesWrap=BX(this.id+"_attendees_wrap");this.attendees=this.entry.attendees||[this.calendar.currentUser];this.attendeesIndex={};this.attendees.forEach(function(e){this.attendeesIndex[e]=true},this);this.attendeesCodes=this.entry.getAttendeesCodes?this.entry.getAttendeesCodes():this.entry.attendeesCodes||false;this.attendeesSelector=new e.BXEventCalendar.DestinationSelector(this.calendar.id+"-slider-destination",{calendar:this.calendar,wrapNode:this.DOM.attendeesWrap,itemsSelected:this.attendeesCodes||this.calendar.util.getSocnetDestinationConfig("itemsSelected")});this.DOM.plannerWrap=BX(this.id+"_planner_wrap");this.DOM.attendeesTitle=BX(this.id+"_attendees_title_wrap");this.plannerId=this.id+"_slider_planner";BX.addCustomEvent("OnDestinationAddNewItem",BX.proxy(this.checkPlannerState,this));BX.addCustomEvent("OnDestinationUnselect",BX.proxy(this.checkPlannerState,this));BX.addCustomEvent("OnCalendarPlannerSelectorChanged",BX.proxy(this.onCalendarPlannerSelectorChanged,this));this.checkPlannerState();BX.addCustomEvent("OnCalendarPlannerUpdated",BX.proxy(this.onCalendarPlannerUpdatedHandler,this));this.DOM.moreOuterWrap=BX(this.id+"_more_outer_wrap");if(this.DOM.form.allow_invite){if(this.entry.data)this.DOM.form.allow_invite.checked=this.entry.data.MEETING&&this.entry.data.MEETING.ALLOW_INVITE;else this.DOM.form.allow_invite.checked=this.entry.allowInvite}if(this.DOM.form.meeting_notify){if(this.entry.data)this.DOM.form.meeting_notify.checked=this.entry.data.MEETING&&this.entry.data.MEETING.NOTIFY;else this.DOM.form.meeting_notify.checked=this.entry.meetingNotify}},initColorControl:function(){var e=this;this.DOM.colorSelectorWrap=BX(this.id+"_color_selector_wrap");BX.bind(this.DOM.colorSelectorWrap,"click",i);this.defaultColors=this.calendar.util.getDefaultColors();this.colors=[];this.activeColor=this.entry.color;if(!this.activeColor&&this.entry.section){this.activeColor=this.entry.section.color}for(var t=0;t<this.defaultColors.length;t++){this.colors.push({color:this.defaultColors[t],node:this.DOM.colorSelectorWrap.appendChild(BX.create("LI",{props:{className:"calendar-field-colorpicker-color-item"},attrs:{"data-bx-calendar-color":this.defaultColors[t]},style:{backgroundColor:this.defaultColors[t]},html:'<span class="calendar-field-colorpicker-color"></span>'}))})}this.customColorNode=this.DOM.colorSelectorWrap.appendChild(BX.create("LI",{props:{className:"calendar-field-colorpicker-color-item"},style:{backgroundColor:"transparent",width:0},html:'<span class="calendar-field-colorpicker-color"></span>'}));this.otherColorLink=this.DOM.colorSelectorWrap.appendChild(BX.create("LI",{props:{className:"calendar-field-colorpicker-color-item-more"},html:'<span class="calendar-field-colorpicker-color-item-more-link">'+BX.message("EC_COLOR")+"</span>",events:{click:BX.delegate(function(){if(!this.colorPicker){this.colorPicker=new BX.ColorPicker({bindElement:this.otherColorLink,onColorSelected:BX.proxy(this.setColor,this),popupOptions:{zIndex:this.zIndex,events:{onPopupClose:function(){}}}})}this.colorPicker.open()},this)}}));function i(t){var i=e.calendar.util.findTargetNode(t.target||t.srcElement,this.outerWrap);if(i&&i.getAttribute){var s=i.getAttribute("data-bx-calendar-color");if(s!==null){if(e.activeColorNode){BX.removeClass(e.activeColorNode,"active")}e.activeColorNode=i;e.activeColor=s;BX.addClass(e.activeColorNode,"active")}}}this.setColor(this.activeColor)},setColor:function(e){this.activeColor=e;if(this.activeColorNode){BX.removeClass(this.activeColorNode,"active")}if(!BX.util.in_array(this.activeColor,this.defaultColors)&&this.activeColor){this.customColorNode.style.backgroundColor=this.activeColor;this.customColorNode.style.width="";this.activeColorNode=this.customColorNode;BX.addClass(this.activeColorNode,"active")}for(i=0;i<this.colors.length;i++){if(this.colors[i].color==this.activeColor){this.activeColorNode=this.colors[i].node;BX.addClass(this.activeColorNode,"active");break}}},checkLocationAccessibility:function(e,t,i){var s=true;i=i!==false;if(i){if(this.checkLocationAccessibilityTimeout){this.checkLocationAccessibilityTimeout=clearTimeout(this.checkLocationAccessibilityTimeout)}this.checkLocationAccessibilityTimeout=setTimeout(BX.proxy(function(){this.checkLocationAccessibility(false,false,false)},this),500);return s}if(!e||!t){var a=this.calendar.util.parseTime(this.DOM.fromTime.value),n=this.calendar.util.parseTime(this.DOM.toTime.value);e=BX.parseDate(this.DOM.fromDate.value);t=BX.parseDate(this.DOM.toDate.value);if(e&&a){e.setHours(a.h,a.m,0)}if(t&&n){t.setHours(n.h,n.m,0)}}var r=false,o=this.locationSelector.getValue();if(this.planner&&o.type=="calendar"){r=this.planner.entries.find(function(e){return e.type=="room"&&e.roomId==o.value})}else if(this.planner&&o.type=="mr"){r=this.planner.entries.find(function(e){return e.type=="room"&&e.id=="MR_"+o.value})}if(r&&!this.planner.checkEntryTimePeriod(r,e,t)){BX.addClass(this.locationSelector.DOM.input,"calendar-error");if(this.locationErrorNode){this.locationErrorNode=BX.remove(this.locationErrorNode)}this.locationErrorNode=this.locationSelector.DOM.wrapNode.parentNode.appendChild(BX.create("div",{props:{className:"calendar-content-error-text"},text:BX.message("EC_LOCATION_RESERVE_ERROR")}));s=false}else{BX.removeClass(this.locationSelector.DOM.input,"calendar-error");if(this.locationErrorNode){this.locationErrorNode=BX.remove(this.locationErrorNode)}s=true}return s},save:function(t){t=t||{};var i=this.calendar.util.getActionUrl(),s=Math.round(Math.random()*1e6);i+=i.indexOf("?")==-1?"?":"&";i+="action=edit_event&bx_event_calendar_request=Y&sessid="+BX.bitrix_sessid()+"&reqId="+s;i+="&markAction="+(this.entry.id?"editEvent":"newEvent");i+="&markType="+this.calendar.util.type;i+="&markRrule="+this.DOM.rruleType.value;i+="&markMeeting="+(this.isMeeting()?"Y":"N");i+="&markCrm="+(this.isCrm()?"Y":"N");this.DOM.form.action=i;var a=this.calendar.util.parseTime(this.DOM.fromTime.value),n=this.calendar.util.parseTime(this.DOM.toTime.value),r=BX.parseDate(this.DOM.fromDate.value),o=BX.parseDate(this.DOM.toDate.value);if(r&&a)r.setHours(a.h,a.m,0);if(o&&n)o.setHours(n.h,n.m,0);this.fromDate=r;this.toDate=o;BX(this.id+"_time_from_real").value=BX.date.format(this.calendar.util.TIME_FORMAT,r.getTime()/1e3);BX(this.id+"_time_to_real").value=BX.date.format(this.calendar.util.TIME_FORMAT,o.getTime()/1e3);if(t.recurentEventEditMode){BX(this.id+"_event_current_date_from").value=this.calendar.util.formatDate(this.entry.from);BX(this.id+"_event_rec_edit_mode").value=t.recurentEventEditMode}else{BX(this.id+"_event_current_date_from").value="";BX(this.id+"_event_rec_edit_mode").value=""}if(t.checkBusyUsers!==false){var l=this.getBusyUserList();if(l&&l.length>0){if(!this.busyUsersDialog)this.busyUsersDialog=new e.BXEventCalendar.BusyUsersDialog(this.calendar);this.busyUsersDialog.show({users:l,saveCallback:BX.delegate(function(){var e,i=[];for(e=0;e<l.length;e++){i.push(l[e].id)}BX(this.id+"_exclude_users").value=i.join(",");t.checkBusyUsers=false;this.save(t)},this)});return}}BX(this.id+"_location_new").value=this.locationSelector.getTextValue();if(this.locationSelector.getTextValue().substr(0,5)=="ECMR_"&&this.DOM.rruleType.value!=="NONE"){alert(BX.message("EC_RESERVE_PERIOD_WARN"));return false}if(BX(this.id+"_location_new").value&&this.planner&&!this.checkLocationAccessibility(r,o,false)){return false}BX(this.id+"_id").value=this.entry.id||0;if(this.entry.id&&this.entry.isRecursive()&&!t.confirmed&&this.checkForSignificantChanges()){this.calendar.entryController.showConfirmEditDialog({params:t,callback:BX.delegate(this.save,this)});return false}var d=this.calendar.sectionController.getSection(this.DOM.sectionInput.value);if(d){d.show();if(d.color.toLowerCase()!=this.activeColor.toLowerCase()){BX(this.id+"_color").value=this.activeColor}}BX.ajax.submitAjax(this.DOM.form,{dataType:"json",method:"POST",onsuccess:BX.delegate(function(e){if(t.recurentEventEditMode){this.calendar.reload()}else{if(e){this.calendar.entryController.handleEntriesList(e.entries);this.calendar.getView().displayEntries()}}},this)});this.close()},getBusyUserList:function(){var e,t=[];if(this.plannerData){for(e in this.plannerData.entries){if(this.plannerData.entries.hasOwnProperty(e)&&this.plannerData.entries[e].id&&this.plannerData.entries[e].status!="h"&&this.plannerData.entries[e].strictStatus&&!this.plannerData.entries[e].currentStatus){t.push(this.plannerData.entries[e])}}}return t},checkForSignificantChanges:function(){var e=false;if(!e&&this.entry.name!==this.DOM.form.name.value)e=true;if(!e&&this.descriptionValue!==this.DOM.form.desc.value)e=true;if(!e&&this.entry.data.LOCATION!==this.DOM.form.location_text.value)e=true;if(!e&&this.entry.isFullDay()!=this.DOM.form.skip_time.checked)e=true;if(!e){var t=BX.parseDate(this.entry.data.DATE_FROM),i=new Date(t.getTime()+(this.entry.data.DT_LENGTH-(this.entry.isFullDay()?1:0))*1e3);if(Math.abs(t.getTime()-this.fromDate.getTime())>1e3||Math.abs(i.getTime()-this.toDate.getTime())>1e3)e=true;if(!e&&!this.entry.isFullDay()&&(this.entry.data.TZ_FROM!=this.DOM.form.tz_from.value||this.entry.data.TZ_TO!=this.DOM.form.tz_to.value)){e=true}}if(!e&&this.plannerData&&false){var s,a={},n=0;if(this.oEvent.IS_MEETING&&this.oEvent["~ATTENDEES"]){for(s in this.oEvent["~ATTENDEES"]){if(this.oEvent["~ATTENDEES"].hasOwnProperty(s)&&this.oEvent["~ATTENDEES"][s]["USER_ID"]){a[this.oEvent["~ATTENDEES"][s]["USER_ID"]]=true;n++}}}for(s in this.plannerData.entries){if(this.plannerData.entries.hasOwnProperty(s)&&this.plannerData.entries[s].type=="user"&&this.plannerData.entries[s].id){if(a[this.plannerData.entries[s].id]){a[this.plannerData.entries[s].id]="+"}else{e=true;break}}}if(!e&&a){for(s in a){if(a.hasOwnProperty(s)&&a[s]!=="+"){e=true;break}}}}return e},onCalendarPlannerSelectorChanged:function(e){if(e.plannerId==this.plannerId){if(!this.planner){this.planner=e.planner}this.DOM.fromDate.value=this.calendar.util.formatDate(e.dateFrom);this.DOM.fromTime.value=this.calendar.util.formatTime(e.dateFrom);this.DOM.toDate.value=this.calendar.util.formatDate(e.dateTo);this.DOM.toTime.value=this.calendar.util.formatTime(e.dateTo);this.checkLocationAccessibility()}},onCalendarPlannerUpdatedHandler:function(e,t){if(!this.planner){this.planner=e;this.checkLocationAccessibility()}},checkPlannerState:function(){if(!this.calendar.util.isMeetingsEnabled()){return}var e=this,t=BX.parseDate(this.DOM.fromDate.value),i=BX.parseDate(e.DOM.toDate.value),s={codes:this.attendeesSelector.getCodes(),from:this.calendar.util.formatDate(t.getTime()-this.calendar.util.dayLength*3),to:this.calendar.util.formatDate(i.getTime()+this.calendar.util.dayLength*10),location:this.locationSelector.getTextValue(),focusSelector:true};this.attendeesCodes=this.attendeesSelector.getAttendeesCodes();this.updatePlanner(s);this.checkLocationAccessibility()},updatePlanner:function(e){if(!this.calendar.util.isMeetingsEnabled()){return}if(!e){e={}}var t=this;var i=this.calendar.util.parseLocation(this.entry.location);this.calendar.request({data:{action:"update_planner",codes:e.codes||[],cur_event_id:this.entry.id||0,date_from:e.dateFrom||e.from||"",date_to:e.dateTo||e.to||"",timezone:this.DOM.fromTz.value?this.DOM.fromTz.value:this.calendar.util.getUserOption("timezoneName"),location:e.location||"",roomEventId:i?i.room_event_id||i.mrevid||false:false,entries:e.entrieIds||false,add_cur_user_to_list:this.calendar.util.userIsOwner()?"Y":"N"},handler:function(i){var s,a=[],n={},r=false,o=!!(e.entries||i.entries&&i.entries.length>0);for(s=0;s<i.entries.length;s++){if(i.entries[s].type=="user"){a.push({id:i.entries[s].id,name:i.entries[s].name,avatar:i.entries[s].avatar,smallAvatar:i.entries[s].smallAvatar||i.entries[s].avatar,url:i.entries[s].url});n[i.entries[s].id]=true;if(!t.attendeesIndex[i.entries[s].id])r=true}}if(!r){for(var l in t.attendeesIndex){if(t.attendeesIndex.hasOwnProperty(l)&&!n[l]){r=true;break}}}if(o){var d={};if(e.entries){i.entries=e.entries;d.scaleFrom=e.from;d.scaleTo=e.to}d.loadedDataFrom=e.from;d.loadedDataTo=e.to;d.data={entries:i.entries,accessibility:i.accessibility};d.focusSelector=e.focusSelector==undefined?false:e.focusSelector;t.refreshPlannerState(d)}}})},refreshPlannerState:function(e){if(!e||typeof e!=="object")e={};this.plannerData=e.data;var t=BX.parseDate(this.DOM.fromDate.value),s=BX.parseDate(this.DOM.toDate.value),a=this.calendar.util.parseTime(this.DOM.fromTime.value),n=this.calendar.util.parseTime(this.DOM.toTime.value),r=this.DOM.fullDay.checked,o={},l,d;if(!r){if(t&&a)t.setHours(a.h,a.m,0);if(s&&n)s.setHours(n.h,n.m,0)}if(e.focusSelector==undefined)e.focusSelector=true;if(t&&s&&t.getTime&&s.getTime&&t.getTime()<=s.getTime()){BX.addClass(this.DOM.plannerWrap,"calendar-edit-planner-wrap-shown");if(!this.plannerIsShown()&&e.show){e.focusSelector=true}if(r){l=new Date(t.getTime());l=e.scaleFrom||new Date(l.getTime()-this.calendar.util.dayLength*3);d=e.scaleTo||new Date(l.getTime()+this.calendar.util.dayLength*10);o.scaleType="1day";o.scaleDateFrom=l;o.scaleDateTo=d;o.adjustCellWidth=false}else{o.changeFromFullDay={scaleType:"1hour",timelineCellWidth:40};o.shownScaleTimeFrom=parseInt(this.calendar.util.getWorkTime().start);o.shownScaleTimeTo=parseInt(this.calendar.util.getWorkTime().end)}o.entriesListWidth=this.DOM.attendeesTitle.offsetWidth+16;o.width=this.DOM.plannerWrap.offsetWidth;if(this.DOM.moreOuterWrap){this.DOM.moreOuterWrap.style.paddingLeft=o.entriesListWidth+"px"}var h=false;if(this.DOM.rruleType.value!=="NONE"&&false){h={FREQ:this.RepeatSelect.value,INTERVAL:this.RepeatCount.value,UNTIL:this.RepeatDiapTo.value};if(h.UNTIL==EC_MESS.NoLimits)h.UNTIL="";if(h.FREQ=="WEEKLY"){h.WEEK_DAYS=[];for(i=0;i<7;i++){if(this.RepeatWeekDaysCh[i].checked){h.WEEK_DAYS.push(this.RepeatWeekDaysCh[i].value)}}if(!h.WEEK_DAYS.length){h=false}}}BX.onCustomEvent("OnCalendarPlannerDoUpdate",[{plannerId:this.plannerId,config:o,focusSelector:e.focusSelector,selector:{from:t,to:s,fullDay:r,RRULE:h,animation:true,updateScaleLimits:true},data:e.data||false,loadedDataFrom:e.loadedDataFrom,loadedDataTo:e.loadedDataTo,show:true}])}},plannerIsShown:function(){return this.DOM.plannerWrap&&BX.hasClass(this.DOM.plannerWrap,"calendar-edit-planner-wrap-shown")},RepeatSelectOnChange:function(e){var t,i,s;e=e.toUpperCase();if(e=="NONE"){}else{this.RepeatPhrase2.innerHTML=EC_MESS.DeDot;if(e=="WEEKLY"){this.RepeatPhrase1.innerHTML=EC_MESS.EveryF;this.RepeatPhrase2.innerHTML+=EC_MESS.WeekP;this.RepeatWeekDays.style.display=e=="WEEKLY"?"inline-block":"none";i={};if(!this.RepeatWeekDaysCh){this.RepeatWeekDaysCh=[];for(t=0;t<7;t++)this.RepeatWeekDaysCh[t]=BX(this.id+"bxec_week_day_"+t)}if(this.oEvent&&this.oEvent.ID&&this.oEvent.RRULE&&this.oEvent.RRULE.BYDAY){i=this.oEvent.RRULE.BYDAY}else{s=BX.parseDate(this.pFromDate.value);if(!s)s=bxGetDateFromTS(this.oEvent.DT_FROM_TS);if(s)i[this.oEC.GetWeekDayByInd(s.getDay())]=true}for(t=0;t<7;t++)this.RepeatWeekDaysCh[t].checked=!!i[this.RepeatWeekDaysCh[t].value]}else{if(e=="YEARLY")this.RepeatPhrase1.innerHTML=EC_MESS.EveryN;else this.RepeatPhrase1.innerHTML=EC_MESS.EveryM;if(e=="DAILY")this.RepeatPhrase2.innerHTML+=EC_MESS.DayP;else if(e=="MONTHLY")this.RepeatPhrase2.innerHTML+=EC_MESS.MonthP;else if(e=="YEARLY")this.RepeatPhrase2.innerHTML+=EC_MESS.YearP;this.RepeatWeekDays.style.display="none"}var a=this.oEvent&&this.oEC.Event.IsRecursive(this.oEvent);this.RepeatCount.value=!this.oEvent.ID||!a?1:this.oEvent.RRULE.INTERVAL;if(!this.oEvent.ID||!a){this.RepeatEndsOnNever.checked=true}else{if(this.oEvent.RRULE&&this.oEvent.RRULE.COUNT>0){this.RepeatCountInp.value=parseInt(this.oEvent.RRULE.COUNT);this.RepeatEndsOnCount.checked=true}else if(this.oEvent.RRULE&&this.oEvent.RRULE["~UNTIL"]){this.RepeatDiapTo.value=this.oEvent.RRULE["~UNTIL"];this.RepeatEndsOnUntil.checked=true}else{this.RepeatEndsOnNever.checked=true}this.EndsOnChange()}}},getNewEntry:function(e){if(!e)e={};var t=this.calendar.entryController.getTimeForNewEntry(new Date);return{from:e.from||t.from,to:e.to||t.to,fullDay:false,name:e.name||this.calendar.entryController.getDefaultEntryName(),section:e.section?this.calendar.sectionController.getSection(e.section):this.calendar.sectionController.getCurrentSection(),remind:e.remind||[this.calendar.util.getUserOption("defaultReminder",15)],location:e.locationValue||"",attendeesList:e.attendees||[],attendees:e.attendees,attendeesCodes:e.attendeesCodes,attendeesCodesList:e.attendeesCodesList,meetingNotify:e.meetingNotify,allowInvite:e.allowInvite}},fieldIsPinned:function(e){return this.pinnedFieldsIndex[e]},collectPlaceholders:function(e){this.placeHolders={};this.placeHoldersAdditional={};var t,i,s=this.DOM.formWrap.querySelectorAll(".calendar-field-additional-placeholder");for(t=0;t<s.length;t++){i=s[t].getAttribute("data-bx-block-placeholer");if(i){this.placeHoldersAdditional[i]=s[t]}}s=this.DOM.formWrap.querySelectorAll(".calendar-field-placeholder");for(t=0;t<s.length;t++){i=s[t].getAttribute("data-bx-block-placeholer");if(i){this.placeHolders[i]=s[t]}}},pinField:function(t){if(!this.placeHolders){this.collectPlaceholders()}var i=this,s=this.placeHoldersAdditional[t],a=this.placeHolders[t],n=s.offsetHeight;s.style.height=n+"px";setTimeout(function(){BX.addClass(s,"calendar-hide-field")},0);a.style.height="0";if(t=="description"){setTimeout(function(){var e=BX(i.id+"_description_additional_wrap");if(e){while(e.firstChild){a.appendChild(e.firstChild)}}a.style.height=n+"px"},200);setTimeout(function(){BX.removeClass(s,"calendar-hide-field");s.style.display="none";a.style.height="";i.pinnedFieldsIndex[t]=true;var n=e["BXHtmlEditor"].Get(i.editorId);if(n){n.CheckAndReInit()}i.saveSettings();i.updateAdditionalBlockState()},300)}else{setTimeout(function(){while(s.firstChild){a.appendChild(s.firstChild)}a.style.height=n+"px"},200);setTimeout(function(){BX.removeClass(s,"calendar-hide-field");s.style.height="";a.style.height="";i.pinnedFieldsIndex[t]=true;i.saveSettings();i.updateAdditionalBlockState()},300)}},unPinField:function(t){if(!this.placeHolders){this.collectPlaceholders()}var i=this,s=this.placeHoldersAdditional[t],a=this.placeHolders[t],n=a.offsetHeight;a.style.height=n+"px";setTimeout(function(){BX.addClass(a,"calendar-hide-field")},0);s.style.height="0";if(t=="description"){setTimeout(function(){var e=BX(i.id+"_description_additional_wrap");if(e){while(a.firstChild){e.appendChild(a.firstChild)}}s.style.display="";s.style.height=n+"px"},200);setTimeout(function(){BX.removeClass(a,"calendar-hide-field");a.style.height="";s.style.height="";i.pinnedFieldsIndex[t]=false;var n=e["BXHtmlEditor"].Get(i.editorId);if(n){n.CheckAndReInit()}i.saveSettings();i.updateAdditionalBlockState()},300)}else{setTimeout(function(){while(a.firstChild){s.appendChild(a.firstChild)}s.style.height=n+"px"},200);setTimeout(function(){BX.removeClass(a,"calendar-hide-field");a.style.height="";s.style.height="";i.pinnedFieldsIndex[t]=false;i.saveSettings();i.updateAdditionalBlockState()},300)}},getSettings:function(){this.pinnedFieldsIndex={};var e,t=[],i=this.calendar.util.getFormSettings(this.formType);for(e in i.pinnedFields){if(i.pinnedFields.hasOwnProperty(e)){t.push(i.pinnedFields[e]);this.pinnedFieldsIndex[i.pinnedFields[e]]=true}}i.pinnedFields=t;return i},saveSettings:function(){var e,t=[];for(e in this.pinnedFieldsIndex){if(this.pinnedFieldsIndex.hasOwnProperty(e)&&this.pinnedFieldsIndex[e]){t.push(e)}}this.formSettings.pinnedFields=t;this.calendar.util.saveFormSettings(this.formType,this.formSettings)},updateAdditionalBlockState:function(){setTimeout(BX.delegate(function(){var e,t=this.DOM.additionalBlock.getElementsByClassName("js-calendar-field-name");BX.cleanNode(this.DOM.pinnedNamesWrap);for(e=0;e<t.length;e++){this.DOM.pinnedNamesWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-additional-alt-promo-text"},html:t[e].innerHTML}))}if(!t.length){BX.addClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}else if(BX.hasClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")){BX.removeClass(this.DOM.additionalBlockWrap,"calendar-additional-block-hidden")}this.checkLastItemBorder()},this),300)},showAdditionalBlock:function(){BX.addClass(this.DOM.additionalSwitch,"opened");BX.removeClass(this.DOM.additionalBlock,"invisible")},hideAdditionalBlock:function(){BX.removeClass(this.DOM.additionalSwitch,"opened");BX.addClass(this.DOM.additionalBlock,"invisible")},keyHandler:function(e){if((e.ctrlKey||e.metaKey)&&!e.altKey&&e.keyCode==this.calendar.util.KEY_CODES["enter"]){this.save()}},checkLastItemBorder:function(){var e="no-border",t,i;i=this.DOM.mainBlock.querySelectorAll(".calendar-options-item-border");for(t=0;t<i.length;t++){if(t==i.length-1){BX.addClass(i[t],e)}else{BX.removeClass(i[t],e)}}i=this.DOM.additionalBlock.querySelectorAll(".calendar-options-item-border");for(t=0;t<i.length;t++){if(t==i.length-1){BX.addClass(i[t],e)}else{BX.removeClass(i[t],e)}}},isMeeting:function(){var e,t=0;if(this.attendeesCodes){for(e in this.attendeesCodes){if(this.attendeesCodes.hasOwnProperty(e)){if(this.attendeesCodes[e]!="users"||t>0){return true}t++}}}return false},isCrm:function(){return this.DOM.form["UF_CRM_CAL_EVENT[]"]&&(this.DOM.form["UF_CRM_CAL_EVENT[]"].length>1||this.DOM.form["UF_CRM_CAL_EVENT[]"].value)}};if(e.BXEventCalendar){e.BXEventCalendar.EditEntrySlider=t}else{BX.addCustomEvent(e,"onBXEventCalendarInit",function(){e.BXEventCalendar.EditEntrySlider=t})}})(window);