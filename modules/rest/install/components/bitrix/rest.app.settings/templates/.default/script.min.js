this.BX=this.BX||{};(function(e,t,s,a,l){"use strict";var i;function r(e,t,s){n(e,t);t.set(e,s)}function n(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}var o=new WeakMap;var b=new WeakMap;var c=new WeakMap;var d=new WeakMap;var v=new WeakMap;var u=new WeakMap;var p=new WeakMap;var h=function(e){babelHelpers.inherits(n,e);function n(e){var a;babelHelpers.classCallCheck(this,n);a=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(n).call(this));r(babelHelpers.assertThisInitialized(a),o,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),b,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),c,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),d,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),v,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),u,{writable:true,value:void 0});r(babelHelpers.assertThisInitialized(a),p,{writable:true,value:void 0});if(!(e.formConstructor instanceof l.FormConstructor)){throw new Error('"formConstructor" is required parameters')}babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),c,null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),v,t.Type.isElementNode(e.wrapper)?e.wrapper:null);a.setFormConstructor(e.formConstructor);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),b,t.Type.isStringFilled(e.handler)?e.handler:null);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),d,t.Type.isStringFilled(e.clientId)?e.clientId:null);a.setRedirect(e.redirect);babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),u,new s.Loader({target:babelHelpers.classPrivateFieldGet(babelHelpers.assertThisInitialized(a),v)}));babelHelpers.classPrivateFieldSet(babelHelpers.assertThisInitialized(a),p,t.Tag.render(i||(i=babelHelpers.taggedTemplateLiteral(['<div class="rest-app-settings-overlay"></div>']))));return a}babelHelpers.createClass(n,[{key:"setRedirect",value:function e(s){var a=new RegExp("^(?:/|https?://"+location.host+")","g");if(t.Type.isStringFilled(s)&&!!s.match(a)){babelHelpers.classPrivateFieldSet(this,c,s)}}},{key:"show",value:function e(){if(t.Type.isNil(babelHelpers.classPrivateFieldGet(this,v))){throw new Error('Property "wrapper" is undefined')}babelHelpers.classPrivateFieldGet(this,o).renderTo(babelHelpers.classPrivateFieldGet(this,v));BX.UI.ButtonPanel.show()}},{key:"subscribeEvents",value:function e(){var t=this;if(!(babelHelpers.classPrivateFieldGet(this,o)instanceof l.FormConstructor)){return}a.EventEmitter.subscribe(a.EventEmitter.GLOBAL_TARGET,"button-click",(function(e){var s=babelHelpers.slicedToArray(e.data,1),a=s[0];if(a.TYPE==="save"){var l={clientId:babelHelpers.classPrivateFieldGet(t,d),settings:babelHelpers.classPrivateFieldGet(t,o).getFormData(),handler:babelHelpers.classPrivateFieldGet(t,b)};t.save(l)}}));babelHelpers.classPrivateFieldGet(this,o).subscribe("onFieldChange",(function(){t.reload()}))}},{key:"unsubscribeEvents",value:function e(){if(!(babelHelpers.classPrivateFieldGet(this,o)instanceof l.FormConstructor)){return}a.EventEmitter.unsubscribeAll(a.EventEmitter.GLOBAL_TARGET,"button-click");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onSave");babelHelpers.classPrivateFieldGet(this,o).unsubscribeAll("onFieldChange")}},{key:"setFormConstructor",value:function e(t){this.unsubscribeEvents();babelHelpers.classPrivateFieldSet(this,o,t);this.subscribeEvents()}},{key:"reload",value:function e(){var s=this;t.Dom.append(babelHelpers.classPrivateFieldGet(this,p),babelHelpers.classPrivateFieldGet(this,v));babelHelpers.classPrivateFieldGet(this,u).show();if(t.Type.isNil(babelHelpers.classPrivateFieldGet(this,d))){console.log('Property "clientId" is undefined');return}t.ajax.runComponentAction("bitrix:rest.app.settings","reload",{mode:"class",data:{clientId:babelHelpers.classPrivateFieldGet(this,d),settings:babelHelpers.classPrivateFieldGet(this,o).getFormData()}}).then((function(e){var a=e.data;s.setFormConstructor(new l.FormConstructor({steps:a.STEPS}));babelHelpers.classPrivateFieldSet(s,b,t.Type.isStringFilled(a.HANDLER)?a.HANDLER:babelHelpers.classPrivateFieldGet(s,b));babelHelpers.classPrivateFieldSet(s,d,t.Type.isStringFilled(a.CLIENT_ID)?a.CLIENT_ID:babelHelpers.classPrivateFieldGet(s,d));s.setRedirect(a.REDIRECT);s.show();babelHelpers.classPrivateFieldGet(s,u).hide();t.Dom.remove(babelHelpers.classPrivateFieldGet(s,p))}))["catch"]((function(e){console.log(e.errors);babelHelpers.classPrivateFieldGet(s,o).showTextInBalloon(t.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}))}},{key:"isReadySave",value:function e(){var t=true;babelHelpers.classPrivateFieldGet(this,o).getFields().forEach((function(e){if(!e.isReadySave()){t=false}}));return t}},{key:"save",value:function e(s){var a=this;t.ajax.runAction("rest.einvoice.save",{mode:"class",data:s}).then((function(){if(t.Type.isNil(babelHelpers.classPrivateFieldGet(a,c))){top.BX.SidePanel.Instance.close()}else{top.document.location.href=babelHelpers.classPrivateFieldGet(a,c)}var e=BX.UI.ButtonPanel.getContainer().querySelector(".ui-btn-wait");t.Dom.removeClass(e,"ui-btn-wait")}))["catch"]((function(e){var s=e.errors;var l=n.formatErrors(s),i=l.fieldErrors,r=l.otherErrors;babelHelpers.classPrivateFieldGet(a,o).showFieldErrors(i);if(t.Type.isArrayFilled(r)){babelHelpers.classPrivateFieldGet(a,o).showTextInBalloon(t.Loc.getMessage("REST_APP_SETTINGS_ERROR"))}var b=BX.UI.ButtonPanel.getContainer().querySelector(".ui-btn-wait");if(b){t.Dom.removeClass(b,"ui-btn-wait")}}))}}],[{key:"formatErrors",value:function e(s){var a={};var l=[];s.forEach((function(e){var s;if(t.Type.isStringFilled((s=e.customData)===null||s===void 0?void 0:s.fieldName)){var i,r,n;Array.isArray(a[(i=e.customData)===null||i===void 0?void 0:i.fieldName])?a[(r=e.customData)===null||r===void 0?void 0:r.fieldName].push(e.message):a[(n=e.customData)===null||n===void 0?void 0:n.fieldName]=[e.message]}else{l.push(e.message)}}));return{fieldErrors:a,otherErrors:l}}}]);return n}(a.EventEmitter);e.AppSettings=h})(this.BX.Rest=this.BX.Rest||{},BX,BX,BX.Event,BX.Rest);
//# sourceMappingURL=script.map.js