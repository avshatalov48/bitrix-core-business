this.BX=this.BX||{};(function(e,t,i,n,r,a,l){"use strict";var s=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);this.id=t||l.Text.getRandom();this.config=i||{};this.errors={};this.setMorePhotoValues(i.morePhoto);this.setFields(i.fields)}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"getProductId",value:function e(){return this.id}},{key:"isSaveable",value:function e(){return false}},{key:"setSaveable",value:function e(t){this.config.saveProductFields=t}},{key:"isNew",value:function e(){return this.getConfig("isNew",false)}},{key:"getConfig",value:function e(t,i){return BX.prop.get(this.config,t,i)}},{key:"getFields",value:function e(){return this.fields}},{key:"getField",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:"";return BX.prop.get(this.fields,t,i)}},{key:"setFields",value:function e(t){this.fields=l.Type.isObject(t)?t:{}}},{key:"getErrors",value:function e(){return this.errors}},{key:"setError",value:function e(t,i){this.errors[t]=i}},{key:"clearErrors",value:function e(t,i){this.errors={}}},{key:"hasErrors",value:function e(){return Object.keys(this.errors).length>0}},{key:"isEnableFileSaving",value:function e(){return false}},{key:"getMorePhotoValues",value:function e(){return this.morePhoto}},{key:"setMorePhotoValues",value:function e(t){this.morePhoto=l.Type.isPlainObject(t)?t:{}}},{key:"removeMorePhotoItem",value:function e(t){return false}},{key:"addMorePhotoItem",value:function e(t,i){this.morePhoto[t]=i}},{key:"setFileType",value:function e(t){this.config.fileType=t||""}},{key:"getDetailPath",value:function e(){return""}},{key:"setDetailPath",value:function e(t){this.config.DETAIL_PATH=t||""}}]);return e}();function o(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-selector-search-footer-box">\n\t\t\t\t<div class="ui-selector-search-footer-box">\n\t\t\t\t\t<div class="tariff-lock"></div>\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t\t<div>\n\t\t\t\t\t","\n\t\t\t\t</div>\t\t\t\t\n\t\t\t</div>\n\t\t"]);o=function t(){return e};return e}function u(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<a class="ui-btn ui-btn-sm ui-btn-primary ui-btn-hover ui-btn-round">\n\t\t\t\t',"\n\t\t\t</a>\n\t\t"]);u=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(["\n\t\t\t<div>","</div>\n\t\t"]);c=function t(){return e};return e}var d=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getContent",value:function e(){var t=l.Tag.render(c(),l.Loc.getMessage("CATALOG_SELECTOR_LIMITED_PRODUCT_CREATION"));var i=l.Tag.render(u(),l.Loc.getMessage("CATALOG_SELECTOR_LICENSE_EXPLODE"));l.Event.bind(i,"click",function(){BX.UI.InfoHelper.show("limit_shop_products")});return l.Tag.render(o(),t,i)}}]);return t}(i.DefaultFooter);function h(){var e=babelHelpers.taggedTemplateLiteral(["",""]);h=function t(){return e};return e}function g(){var e=babelHelpers.taggedTemplateLiteral(["",""]);g=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['<div class="ui-ctl ui-ctl-w100 ui-ctl-after-icon"></div>']);p=function t(){return e};return e}function f(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-search"\n\t\t\t\t\tonclick="','"\n\t\t\t\t></button>\n\t\t\t']);f=function t(){return e};return e}function v(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a\n\t\t\t\t\thref="','"\n\t\t\t\t\ttarget="_blank"\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-forward"\n\t\t\t\t></button>\n\t\t\t']);v=function t(){return e};return e}function b(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<button\n\t\t\t\t\tclass="ui-ctl-after ui-ctl-icon-clear" \n\t\t\t\t\tonclick="','"\n\t\t\t\t></button>\n\t\t\t']);b=function t(){return e};return e}function I(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input\n\t\t\t\t \ttype="hidden" \n\t\t\t\t\tname="','" \n\t\t\t\t\tvalue="','"\n\t\t\t\t>\n\t\t\t']);I=function t(){return e};return e}function m(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input type="text" \n\t\t\t\t\tclass="ui-ctl-element ui-ctl-textbox" \n\t\t\t\t\tautocomplete="off"\n\t\t\t\t\tvalue="','"\n\t\t\t\t\tplaceholder="','"\n\t\t\t\t\tonchange="','"\n\t\t\t\t>\n\t\t\t']);m=function t(){return e};return e}function E(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-ctl-tag">',"</div>\n\t\t"]);E=function t(){return e};return e}function y(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100">\n\t\t\t\t\t',"\n\t\t\t\t\t","\n\t\t\t\t\t","\n\t\t\t\t</div>\n\t\t\t"]);y=function t(){return e};return e}var T=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"cache",new l.Cache.MemoryCache);this.id=t||l.Text.getRandom();this.selector=i.selector;if(!(this.selector instanceof a.ProductSelector)){throw new Error("Product selector instance not found.")}this.model=i.model||{};this.isEnabledSearch=i.isSearchEnabled;this.isEnabledDetailLink=i.isEnabledDetailLink;this.isEnabledEmptyProductError=i.isEnabledEmptyProductError;this.inputName=i.inputName||""}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"getField",value:function e(t){return this.model.getField(t)}},{key:"getValue",value:function e(){return this.getField(this.inputName)}},{key:"isSearchEnabled",value:function e(){return this.isEnabledSearch}},{key:"toggleIcon",value:function e(t,i){if(l.Type.isDomNode(t)){l.Dom.style(t,"display",i)}}},{key:"getNameBlock",value:function e(){var t=this;return this.cache.remember("nameBlock",function(){return l.Tag.render(y(),t.getNameTag(),t.getNameInput(),t.getHiddenNameInput())})}},{key:"getNameTag",value:function e(){if(!this.model.isNew()){return""}return l.Tag.render(E(),l.Loc.getMessage("CATALOG_SELECTOR_NEW_TAG_TITLE"))}},{key:"getNameInput",value:function e(){var t=this;return this.cache.remember("nameInput",function(){return l.Tag.render(m(),l.Text.encode(t.getValue()),l.Text.encode(t.getPlaceholder()),t.handleNameInputHiddenChange.bind(t))})}},{key:"getHiddenNameInput",value:function e(){var t=this;return this.cache.remember("hiddenNameInput",function(){return l.Tag.render(I(),l.Text.encode(t.inputName),l.Text.encode(t.getValue()))})}},{key:"handleNameInputHiddenChange",value:function e(t){this.getHiddenNameInput().value=t.target.value}},{key:"getClearIcon",value:function e(){var t=this;return this.cache.remember("closeIcon",function(){return l.Tag.render(b(),t.handleClearIconClick.bind(t))})}},{key:"getArrowIcon",value:function e(){var t=this;return this.cache.remember("arrowIcon",function(){return l.Tag.render(v(),t.model.getDetailPath())})}},{key:"getSearchIcon",value:function e(){var t=this;return this.cache.remember("searchIcon",function(){return l.Tag.render(f(),t.handleSearchIconClick.bind(t))})}},{key:"layout",value:function e(){var t=l.Tag.render(p());if(!l.Type.isStringFilled(this.getValue())){this.toggleIcon(this.getClearIcon(),"none")}t.appendChild(this.getClearIcon());if(this.showDetailLink()&&l.Type.isStringFilled(this.getValue())){this.toggleIcon(this.getClearIcon(),"none");this.toggleIcon(this.getArrowIcon(),"block");t.appendChild(this.getArrowIcon())}if(this.isSearchEnabled()){var i=l.Type.isStringFilled(this.getValue())?"none":"block";this.toggleIcon(this.getSearchIcon(),i);t.appendChild(this.getSearchIcon());l.Event.bind(this.getNameInput(),"click",this.handleShowSearchDialog.bind(this));l.Event.bind(this.getNameInput(),"input",this.handleShowSearchDialog.bind(this));l.Event.bind(this.getNameInput(),"blur",this.handleNameInputBlur.bind(this));l.Event.bind(this.getNameInput(),"keydown",this.handleNameInputKeyDown.bind(this))}l.Event.bind(this.getNameInput(),"click",this.handleIconsSwitchingOnNameInput.bind(this));l.Event.bind(this.getNameInput(),"input",this.handleIconsSwitchingOnNameInput.bind(this));if(this.selector&&this.selector.isSaveable()){l.Event.bind(this.getNameInput(),"change",this.handleNameInputChange.bind(this))}t.appendChild(this.getNameBlock());return t}},{key:"showDetailLink",value:function e(){return this.isEnabledDetailLink}},{key:"getDialog",value:function e(){var t=this;return this.cache.remember("dialog",function(){var e={id:t.id,height:300,context:"catalog-products",targetNode:t.getNameInput(),enableSearch:false,multiple:false,dropdownMode:true,searchTabOptions:{stub:true,stubOptions:{title:l.Tag.message(g(),"CATALOG_SELECTOR_IS_EMPTY_TITLE"),subtitle:l.Tag.message(h(),"CATALOG_SELECTOR_IS_EMPTY_SUBTITLE"),arrow:true}},events:{"Item:onSelect":t.onProductSelect.bind(t),"Search:onItemCreateAsync":t.createProduct.bind(t)},entities:[{id:"product",options:{iblockId:t.selector.getIblockId(),basePriceId:t.selector.getBasePriceId()}}]};var n=l.Extension.getSettings("catalog.product-selector");if(l.Type.isObject(n.get("limitInfo"))){e.footer=d}else{e.searchOptions={allowCreateItem:true}}return new i.Dialog(e)})}},{key:"handleNameInputKeyDown",value:function e(t){var i=this.getDialog();if(t.key==="Enter"&&i.getActiveTab()===i.getSearchTab()){t.preventDefault();if(l.Browser.isMac()&&t.metaKey||t.ctrlKey){i.getSearchTab().getFooter().createItem()}}}},{key:"handleIconsSwitchingOnNameInput",value:function e(t){this.toggleIcon(this.getArrowIcon(),"none");if(l.Type.isStringFilled(t.target.value)){this.toggleIcon(this.getClearIcon(),"block");this.toggleIcon(this.getSearchIcon(),"none")}else{this.toggleIcon(this.getClearIcon(),"none");this.toggleIcon(this.getSearchIcon(),"block")}}},{key:"handleClearIconClick",value:function e(t){if(this.selector.isProductSearchEnabled()&&!this.selector.isEmptyModel()){this.selector.clearState();this.selector.clearLayout();this.selector.layout();this.selector.searchInDialog()}else{this.getNameInput().value="";this.toggleIcon(this.getClearIcon(),"none")}this.selector.focusName();this.selector.emit("onClear",{selectorId:this.selector.getId(),rowId:this.selector.getRowId()});t.stopPropagation();t.preventDefault()}},{key:"handleNameInputChange",value:function e(t){var i=t.target.value;r.EventEmitter.emit("ProductList::onChangeFields",{rowId:this.selector.getRowId(),fields:{NAME:i}})}},{key:"focusName",value:function e(){var t=this;requestAnimationFrame(function(){return t.getNameInput().focus()})}},{key:"searchInDialog",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(!this.selector.isProductSearchEnabled()){return}var i=this.getDialog();if(i){i.show();i.search(t)}}},{key:"handleShowSearchDialog",value:function e(t){if(this.selector.isEmptyModel()||this.selector.isSimpleModel()){this.selector.searchInDialog(t.target.value)}}},{key:"handleNameInputBlur",value:function e(t){var i=this;setTimeout(function(){i.toggleIcon(i.getClearIcon(),"none");if(i.showDetailLink()&&l.Type.isStringFilled(i.getValue())){i.toggleIcon(i.getSearchIcon(),"none");i.toggleIcon(i.getArrowIcon(),"block")}else{i.toggleIcon(i.getArrowIcon(),"none");i.toggleIcon(i.getSearchIcon(),"block")}},200);if(this.isSearchEnabled()&&this.isEnabledEmptyProductError){setTimeout(function(){if(i.selector.isEmptyModel()){i.model.setError("NOT_SELECTED_PRODUCT",l.Loc.getMessage("CATALOG_SELECTOR_SELECTED_PRODUCT_TITLE"));i.selector.layoutErrors()}},200)}}},{key:"handleSearchIconClick",value:function e(t){this.selector.searchInDialog();this.selector.focusName();t.stopPropagation();t.preventDefault()}},{key:"resetModel",value:function e(t){var i=this.selector.getModel().getFields();var n=this.selector.createModel({isSimpleModel:true});this.selector.setModel(n);i["NAME"]=t;this.selector.getModel().setFields(i)}},{key:"onProductSelect",value:function e(t){var i=t.getData().item;i.getDialog().getTargetNode().value=i.getTitle();this.toggleIcon(this.getSearchIcon(),"none");this.resetModel(i.getTitle());this.selector.clearLayout();this.selector.layout();if(this.selector){this.selector.onProductSelect(i.getId(),{saveProductFields:i.getCustomData().get("saveProductFields"),isNew:i.getCustomData().get("isNew")})}i.getDialog().hide()}},{key:"createProduct",value:function e(t){var i=this;var n=t.getData(),r=n.searchQuery;this.resetModel(r.getQuery());return new Promise(function(e,n){var a=t.getTarget();var s={NAME:r.getQuery(),IBLOCK_ID:i.selector.getIblockId()};var o=i.selector.getModel().getField("PRICE",null);if(!l.Type.isNil(o)){s["PRICE"]=o}var u=i.selector.getModel().getField("CURRENCY",null);if(l.Type.isStringFilled(u)){s["CURRENCY"]=u}a.showLoader();l.ajax.runAction("catalog.productSelector.createProduct",{json:{fields:s}}).then(function(t){a.hideLoader();var i=a.addItem({id:t.data.id,entityId:"product",title:r.getQuery(),tabs:a.getRecentTab().getId(),customData:{saveProductFields:true,isNew:true}});if(i){i.select()}a.hide();e()}).catch(function(){a.hide();n()})})}},{key:"getPlaceholder",value:function e(){return this.isSearchEnabled()&&this.selector.isEmptyModel()?l.Loc.getMessage("CATALOG_SELECTOR_BEFORE_SEARCH_TITLE"):l.Loc.getMessage("CATALOG_SELECTOR_VIEW_NAME_TITLE")}}]);return e}();function C(){var e=babelHelpers.taggedTemplateLiteral(["<div></div>"]);C=function t(){return e};return e}var k=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);this.id=t||l.Text.getRandom();this.selector=i.selector||null;if(!(this.selector instanceof a.ProductSelector)){throw new Error("Product selector instance not found.")}this.config=i.config||{};this.setView(i.view);if(l.Type.isStringFilled(i.inputHtml)){this.setInputHtml(i.inputHtml)}else{this.restoreDefaultInputHtml()}this.enableSaving=i.enableSaving;this.uploaderFieldMap={}}babelHelpers.createClass(e,[{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"setView",value:function e(t){this.view=l.Type.isStringFilled(t)?t:""}},{key:"setInputHtml",value:function e(t){this.inputHtml=l.Type.isStringFilled(t)?t:""}},{key:"restoreDefaultInputHtml",value:function e(){this.inputHtml="\n\t\t\t<div class='ui-image-input-container ui-image-input-img--disabled'>\n\t\t\t\t<div class='adm-fileinput-wrapper '>\n\t\t\t\t\t<div class='adm-fileinput-area mode-pict adm-fileinput-drag-area'></div>\n\t\t\t\t</div>\n\t\t\t</div>\n"}},{key:"isViewMode",value:function e(){return this.selector&&this.selector.isViewMode()}},{key:"isEnabledLiveSaving",value:function e(){return this.enableSaving}},{key:"layout",value:function e(){var t=l.Tag.render(C());l.Runtime.html(t,this.isViewMode()?this.view:this.inputHtml);return t}}]);return e}();var S=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}return t}(s);var P=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"isSaveable",value:function e(){return this.getConfig("saveProductFields",false)}},{key:"isEnableFileSaving",value:function e(){return true}},{key:"getDetailPath",value:function e(){return this.getConfig("DETAIL_PATH","")}},{key:"removeMorePhotoItem",value:function e(t){for(var i in this.morePhoto){var n=this.morePhoto[i];if(!l.Type.isObject(n)){n=l.Text.toInteger(n)}if(l.Type.isNumber(n)&&n===l.Text.toInteger(t)||l.Type.isObject(n)&&n.fileId===t){delete this.morePhoto[i];return true}}return false}},{key:"setMorePhotoValues",value:function e(i){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"setMorePhotoValues",this).call(this,i);if(this.isEnabledEmptyImageError()&&this.morePhoto.length===0){this.setError("EMPTY_IMAGE",l.Loc.getMessage("CATALOG_SELECTOR_EMPTY_IMAGE_ERROR"))}}},{key:"isEnabledEmptyImageError",value:function e(){return this.getConfig("ENABLE_EMPTY_IMAGES_ERROR",false)}}]);return t}(s);var H=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getProductId",value:function e(){return this.getConfig("productId")}}]);return t}(P);var N=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"getName",value:function e(){return this.getConfig("NAME","")}}]);return t}(s);function L(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-field-input"></div>']);L=function t(){return e};return e}function M(){var e=babelHelpers.taggedTemplateLiteral(['<span title="','">',"</span>"]);M=function t(){return e};return e}function w(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<a href="','" title="','">',"</a>\n\t\t\t"]);w=function t(){return e};return e}function D(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-error-item">',"</div>"]);D=function t(){return e};return e}function _(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-error"></div>']);_=function t(){return e};return e}function R(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-img"></div>']);R=function t(){return e};return e}function A(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-product-field-inner"></div>']);A=function t(){return e};return e}var O=new Map;var F=function(e){babelHelpers.inherits(i,e);babelHelpers.createClass(i,null,[{key:"getById",value:function e(t){return O.get(t)||null}}]);function i(e){var t;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,i);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(i).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"mode",i.MODE_EDIT);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"cache",new l.Cache.MemoryCache);babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"variationChangeHandler",t.handleVariationChange.bind(babelHelpers.assertThisInitialized(t)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"onSaveImageHandler",t.onSaveImage.bind(babelHelpers.assertThisInitialized(t)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(t),"onChangeFieldsHandler",l.Runtime.debounce(t.onChangeFields,500,babelHelpers.assertThisInitialized(t)));t.setEventNamespace("BX.Catalog.ProductSelector");t.id=e||l.Text.getRandom();n.inputFieldName=n.inputFieldName||"NAME";t.options=n||{};t.iblockId=l.Text.toNumber(n.iblockId);t.basePriceId=l.Text.toNumber(n.basePriceId);t.setMode(n.mode);t.model=t.createModel(n);t.model.setFields(n.fields);t.model.setMorePhotoValues(n.morePhotoValues);t.model.setDetailPath(t.getConfig("DETAIL_PATH"));if(t.isSimpleModel()&&t.isEnabledEmptyProductError()){t.model.setError("NOT_SELECTED_PRODUCT",l.Loc.getMessage("CATALOG_SELECTOR_SELECTED_PRODUCT_TITLE"))}t.skuTree=n.skuTree||null;t.setFileType(n.fileType);t.layout();r.EventEmitter.subscribe("ProductList::onChangeFields",t.onChangeFieldsHandler);r.EventEmitter.subscribe("Catalog.ImageInput::save",t.onSaveImageHandler);O.set(t.id,babelHelpers.assertThisInitialized(t));return t}babelHelpers.createClass(i,[{key:"createModel",value:function e(){var t;var i=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(i.isSimpleModel){return new N}var n=l.Text.toInteger(i.productId)||0;if(n<=0){return new S}var r=(i===null||i===void 0?void 0:(t=i.config)===null||t===void 0?void 0:t.MODEL_CONFIG)||{};var a=l.Text.toInteger(i.skuId)||0;if(a>0&&a!==n){return new H(a,babelHelpers.objectSpread({},r,{productId:n}))}return new P(n,r)}},{key:"setModel",value:function e(t){this.model=t}},{key:"getModel",value:function e(){return this.model}},{key:"isEmptyModel",value:function e(){return this.getModel()instanceof S}},{key:"isSimpleModel",value:function e(){return this.getModel()instanceof N}},{key:"setMode",value:function e(t){if(!l.Type.isNil(t)){this.mode=t===i.MODE_VIEW?i.MODE_VIEW:i.MODE_EDIT}}},{key:"setFileType",value:function e(t){this.fileType=t===i.SKU_TYPE?i.SKU_TYPE:i.PRODUCT_TYPE}},{key:"isViewMode",value:function e(){return this.mode===i.MODE_VIEW}},{key:"isSaveable",value:function e(){return!this.isViewMode()&&this.model.isSaveable()}},{key:"getId",value:function e(){return this.id}},{key:"getIblockId",value:function e(){return this.iblockId}},{key:"getBasePriceId",value:function e(){return this.basePriceId}},{key:"getConfig",value:function e(t,i){return BX.prop.get(this.options.config,t,i)}},{key:"getRowId",value:function e(){return this.getConfig("ROW_ID")}},{key:"getFileInput",value:function e(){if(!this.fileInput){this.fileInput=new k(this.options.fileInputId,{selector:this,view:this.options.fileView,inputHtml:this.options.fileInput,enableSaving:this.getConfig("ENABLE_IMAGE_CHANGE_SAVING",false)})}return this.fileInput}},{key:"isProductFileType",value:function e(){return this.fileType===i.PRODUCT_TYPE}},{key:"isProductSearchEnabled",value:function e(){return this.getConfig("ENABLE_SEARCH",false)&&this.getIblockId()>0}},{key:"isImageFieldEnabled",value:function e(){return this.getConfig("ENABLE_IMAGE_INPUT",true)!==false}},{key:"isEnabledEmptyProductError",value:function e(){return this.getConfig("ENABLE_EMPTY_PRODUCT_ERROR",false)}},{key:"isEnabledChangesRendering",value:function e(){return this.getConfig("ENABLE_CHANGES_RENDERING",true)}},{key:"isInputDetailLinkEnabled",value:function e(){return this.getConfig("ENABLE_INPUT_DETAIL_LINK",false)&&l.Type.isStringFilled(this.model.getDetailPath())}},{key:"getWrapper",value:function e(){if(!this.wrapper){this.wrapper=document.getElementById(this.id)}return this.wrapper}},{key:"renderTo",value:function e(t){this.clearLayout();this.wrapper=t;this.layout()}},{key:"layout",value:function e(){var t=this;var i=this.getWrapper();if(!i){return}this.defineWrapperClass(i);var n=l.Tag.render(A());i.appendChild(n);n.appendChild(this.layoutNameBlock());if(this.isImageFieldEnabled()){if(!l.Reflection.getClass("BX.UI.ImageInput")){l.ajax.runAction("catalog.productSelector.getFileInput",{json:{iblockId:this.iblockId}}).then(function(){t.layoutImage()})}else{this.layoutImage()}n.appendChild(this.getImageContainer())}else{l.Dom.addClass(i,"catalog-product-field-no-image")}i.appendChild(this.getErrorContainer());this.layoutErrors();this.layoutSkuTree();this.subscribeToVariationChange()}},{key:"focusName",value:function e(){if(this.searchInput){this.searchInput.focusName()}return this}},{key:"searchInDialog",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:"";if(this.searchInput){this.searchInput.searchInDialog(t)}return this}},{key:"getImageContainer",value:function e(){return this.cache.remember("imageContainer",function(){return l.Tag.render(R())})}},{key:"getErrorContainer",value:function e(){return this.cache.remember("errorContainer",function(){return l.Tag.render(_())})}},{key:"layoutErrors",value:function e(){this.getErrorContainer().innerHTML="";if(!this.model.hasErrors()){return}var t=this.model.getErrors();for(var i in t){this.getErrorContainer().appendChild(l.Tag.render(D(),t[i]))}if(this.searchInput){l.Dom.addClass(this.searchInput.getNameBlock(),"ui-ctl-danger")}}},{key:"layoutImage",value:function e(){this.getImageContainer().innerHTML="";this.getImageContainer().appendChild(this.getFileInput().layout());this.refreshImageSelectorId=null}},{key:"clearState",value:function e(){this.model=this.createModel();this.fileInput.restoreDefaultInputHtml();this.skuTree=null;this.skuTreeInstance=null;this.refreshImageSelectorId=null}},{key:"clearLayout",value:function e(){var t=this.getWrapper();if(t){l.Event.unbindAll(t);t.innerHTML=""}this.unsubscribeToVariationChange()}},{key:"unsubscribeEvents",value:function e(){this.unsubscribeToVariationChange();r.EventEmitter.unsubscribe("Catalog.ImageInput::save",this.onSaveImageHandler);r.EventEmitter.unsubscribe("ProductList::onChangeFields",this.onChangeFieldsHandler)}},{key:"defineWrapperClass",value:function e(t){if(this.isViewMode()){l.Dom.addClass(t,"catalog-product-view");l.Dom.removeClass(t,"catalog-product-edit")}else{l.Dom.addClass(t,"catalog-product-edit");l.Dom.removeClass(t,"catalog-product-view")}}},{key:"getNameBlockView",value:function e(){var t=l.Text.encode(this.model.getField("NAME"));var i=l.Loc.getMessage("CATALOG_SELECTOR_VIEW_NAME_TITLE");if(this.getModel().getDetailPath()){return l.Tag.render(w(),this.getModel().getDetailPath(),i,t)}return l.Tag.render(M(),i,t)}},{key:"layoutNameBlock",value:function e(){var t=l.Tag.render(L());if(this.isViewMode()){t.appendChild(this.getNameBlockView())}else{this.searchInput=new T(this.id,{selector:this,model:this.getModel(),inputName:this.options.inputFieldName,isSearchEnabled:this.isProductSearchEnabled(),isEnabledEmptyProductError:this.isEnabledEmptyProductError(),iblockId:this.getIblockId(),basePriceId:this.getBasePriceId(),isEnabledDetailLink:this.isInputDetailLinkEnabled()});t.appendChild(this.searchInput.layout())}return t}},{key:"updateSkuTree",value:function e(t){this.skuTree=t;this.skuTreeInstance=null}},{key:"getSkuTreeInstance",value:function e(){if(this.skuTree&&!this.skuTreeInstance){this.skuTreeInstance=new t.SkuTree({skuTree:this.skuTree,selectable:this.getConfig("ENABLE_SKU_SELECTION",true),hideUnselected:this.getConfig("HIDE_UNSELECTED_ITEMS",false)})}return this.skuTreeInstance}},{key:"layoutSkuTree",value:function e(){var t=this.getSkuTreeInstance();var i=this.getWrapper();if(t&&i){var n=t.layout();i.appendChild(n)}}},{key:"subscribeToVariationChange",value:function e(){var t=this.getSkuTreeInstance();if(t){t.subscribe("SkuProperty::onChange",this.variationChangeHandler)}}},{key:"unsubscribeToVariationChange",value:function e(){var t=this.getSkuTreeInstance();if(t){t.unsubscribe("SkuProperty::onChange",this.variationChangeHandler)}}},{key:"handleVariationChange",value:function e(t){var i=this;var n=t.getData(),r=babelHelpers.slicedToArray(n,1),a=r[0];var s=l.Text.toNumber(a.PARENT_PRODUCT_ID);var o=l.Text.toNumber(a.ID);if(s<=0||o<=0){return}this.model.setSaveable(false);this.emit("onBeforeChange",{selectorId:this.getId(),rowId:this.getRowId()});l.ajax.runAction("catalog.productSelector.getSelectedSku",{json:{variationId:o,options:{priceId:this.basePriceId,urlBuilder:this.getConfig("URL_BUILDER_CONTEXT")}}}).then(function(e){return i.processResponse(e,babelHelpers.objectSpread({},i.options.config))})}},{key:"onChangeFields",value:function e(t){var i=t.getData();if(!this.isSaveable()||i.rowId!==this.getRowId()){return}if(!l.Type.isNil(i.productId)&&i.productId!==this.getModel().getProductId()){return}var n=i.fields;var r=l.Text.toNumber(n.PRICE);if(r>0&&l.Type.isStringFilled(n.CURRENCY)){n.PRICES={};n.PRICES[this.getBasePriceId()]={PRICE:r,CURRENCY:n.CURRENCY}}this.updateProduct(n)}},{key:"updateProduct",value:function e(t){if(!l.Type.isPlainObject(t)){return}if(this.getModel().getId()<=0||this.getIblockId()<=0){return}l.ajax.runAction("catalog.productSelector.updateProduct",{json:{id:this.getModel().getId(),iblockId:this.getIblockId(),updateFields:t}})}},{key:"onSaveImage",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,3),r=n[1],a=n[2];if(this.isEmptyModel()||this.isSimpleModel()||r!==this.getFileInput().getId()){return}this.getFileInput().setId(a.data.id);this.getFileInput().setInputHtml(a.data.input);this.getFileInput().setView(a.data.preview);this.getModel().setMorePhotoValues(a.data.values);if(this.isImageFieldEnabled()){this.layoutImage()}}},{key:"onProductSelect",value:function e(t,i){this.emit("onBeforeChange",{selectorId:this.getId(),rowId:this.getRowId()});this.productSelectAjaxAction(t,i)}},{key:"productSelectAjaxAction",value:function e(t){var i=this;var n=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{saveProductFields:false,isNew:false};l.ajax.runAction("catalog.productSelector.getProduct",{json:{productId:t,options:{priceId:this.basePriceId,urlBuilder:this.getConfig("URL_BUILDER_CONTEXT")}}}).then(function(e){return i.processResponse(e,babelHelpers.objectSpread({},i.options.config,n),true)})}},{key:"processResponse",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=arguments.length>2&&arguments[2]!==undefined?arguments[2]:false;var r=(t===null||t===void 0?void 0:t.data)||null;if(r){this.changeSelectedElement(r,i)}else if(n){this.clearState()}else{this.productSelectAjaxAction(this.getModel().getProductId())}this.unsubscribeToVariationChange();if(this.isEnabledChangesRendering()){this.clearLayout();this.layout()}var a=(r===null||r===void 0?void 0:r.fields)||null;this.emit("onChange",{selectorId:this.id,rowId:this.getRowId(),isNew:i.isNew||false,fields:a})}},{key:"changeSelectedElement",value:function e(t,i){var n=l.Text.toInteger(t.productId);var r=this.getModel().getId()!==n;if(r){var a=l.Text.toInteger(t.skuId);if(a>0&&a!==n){i.productId=n;this.model=new H(a,i)}else{this.model=new P(n,i)}}this.getModel().setFields(t.fields);var s={id:"",input:"",preview:"",values:[]};if(l.Type.isObject(t.image)){s.id=t.image.id;s.input=t.image.input;s.preview=t.image.preview;s.values=t.image.values;this.getModel().setFileType(t.fileType)}this.getFileInput().setId(s.id);this.getFileInput().setInputHtml(s.input);this.getFileInput().setView(s.preview);this.getModel().setMorePhotoValues(s.values);if(t.detailUrl){this.getModel().setDetailPath(t.detailUrl)}if(l.Type.isObject(t.skuTree)){this.updateSkuTree(t.skuTree)}}}]);return i}(r.EventEmitter);babelHelpers.defineProperty(F,"MODE_VIEW","view");babelHelpers.defineProperty(F,"MODE_EDIT","edit");babelHelpers.defineProperty(F,"PRODUCT_TYPE","product");babelHelpers.defineProperty(F,"SKU_TYPE","sku");e.ProductSelector=F})(this.BX.Catalog=this.BX.Catalog||{},BX.Catalog.SkuTree,BX.UI.EntitySelector,BX,BX.Event,BX.Catalog,BX);
//# sourceMappingURL=product-selector.bundle.map.js