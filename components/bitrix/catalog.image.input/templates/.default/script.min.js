(function(e,t,i){"use strict";function a(e,t){n(e,t);t.add(e)}function n(e,t){if(t.has(e)){throw new TypeError("Cannot initialize the same private elements twice on an object")}}function s(e,t,i){if(!t.has(e)){throw new TypeError("attempted to get private field on non-instance")}return i}var l=new WeakSet;var r=function(){babelHelpers.createClass(e,null,[{key:"getById",value:function t(i){return e.imageInputInstances.get(i)||null}}]);function e(n){var s=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);a(this,l);babelHelpers.defineProperty(this,"onUploaderIsInitedHandler",this.handleOnUploaderIsInited.bind(this));babelHelpers.defineProperty(this,"values",new Map);babelHelpers.defineProperty(this,"newValues",new Map);this.id=n;this.wrapper=BX(n);if(!this.wrapper){return}this.productId=s.productId;this.skuId=s.skuId;this.iblockId=s.iblockId;this.saveable=s.saveable;this.inputId=s.inputId;this.ajaxStatus=e.WAIT_STATUS;if(s.hideAddButton===true){var r=this.wrapper.querySelector('[data-role="image-add-button"]');if(t.Type.isDomNode(r)){r.style.display="none"}}if(t.Type.isObject(s.values)){for(var u in s.values){if(!s.values.hasOwnProperty(u)){continue}this.values.set(u,s.values[u])}}if(this.isSaveable()){i.EventEmitter.subscribe("onUploaderIsInited",this.onUploaderIsInitedHandler)}e.imageInputInstances.set(this.id,this)}babelHelpers.createClass(e,[{key:"isSaveable",value:function e(){return this.saveable===true}},{key:"handleOnUploaderIsInited",value:function e(a){var n=a.getCompatData(),s=babelHelpers.slicedToArray(n,2),l=s[0],r=s[1];if(t.Type.isStringFilled(this.inputId)&&this.inputId===l){this.uploaderFieldMap=new Map;i.EventEmitter.subscribe(r,"onFileIsDeleted",this.onFileDelete.bind(this));i.EventEmitter.subscribe(r,"onFileIsUploaded",this.onFileUpload.bind(this));i.EventEmitter.subscribe(r,"onDone",this.onDone.bind(this));i.EventEmitter.subscribe(r,"onQueueIsChanged",this.onQueueIsChanged.bind(this))}}},{key:"unsubscribeEvents",value:function e(){if(this.isSaveable()){i.EventEmitter.unsubscribe("onUploaderIsInited",this.onUploaderIsInitedHandler)}}},{key:"unsubscribeImageInputEvents",value:function e(){if(t.Reflection.getClass("BX.UI.ImageInput")){var i=BX.UI.ImageInput.getById(this.inputId);if(i){i.unsubscribeEvents()}}}},{key:"getId",value:function e(){return this.id}},{key:"setId",value:function e(t){this.id=t}},{key:"onFileDelete",value:function e(i){var a=i.getCompatData(),n=babelHelpers.slicedToArray(a,4),s=n[3];var l=s.input_name;if(t.Type.isNil(l)){return null}this.values["delete"](l);if(this.isSaveable()){this.save()}}},{key:"onQueueIsChanged",value:function e(i){var a=i.getCompatData(),n=babelHelpers.slicedToArray(a,4),s=n[1],l=n[2],r=n[3];var u=r.file;if(s==="add"&&"input_name"in u&&t.Type.isNil(this.uploaderFieldMap.get(l))){this.uploaderFieldMap.set(l,u["input_name"])}}},{key:"onDone",value:function e(){if(this.newValues.size>0&&this.isSaveable()){this.save()}this.newValues.clear()}},{key:"onFileUpload",value:function e(i){var a=i.getCompatData(),n=babelHelpers.slicedToArray(a,3),r=n[0],o=n[2];if(!this.isSaveable()||!t.Type.isObject(o)||!("file"in o)||!("files"in o.file)||!("default"in o.file.files)){return}s(this,l,u).call(this,{tool:"catalog",category:"product_selector",event:"image_upload"});var d=o["file"]["files"]["default"];var p={fileId:r,data:{name:d.name,type:d.type,tmp_name:d.path,size:d.size,error:null}};var c=this.uploaderFieldMap.get(r)||r;this.values.set(c,p);this.newValues.set(c,p)}},{key:"save",value:function e(){var a=this;if(this.submitFileTimeOut){clearTimeout(this.submitFileTimeOut)}var n=t.Text.getRandom(20);this.refreshImageSelectorId=n;this.submitFileTimeOut=setTimeout((function(){var e={};a.values.forEach((function(t,i){e[i]=t}));t.ajax.runAction("catalog.productSelector.saveMorePhoto",{json:{productId:a.productId,variationId:a.skuId,iblockId:a.iblockId,imageValues:e}}).then((function(e){var s;if(!a.refreshImageSelectorId===n){return}a.values.clear();if(t.Type.isObject((s=e.data)===null||s===void 0?void 0:s.values)){for(var l in e.data.values){if(!e.data.values.hasOwnProperty(l)){continue}a.values.set(l,e.data.values[l])}}t.Runtime.html(a.wrapper,e.data.input);i.EventEmitter.emit("Catalog.ImageInput::save",[a.id,a.inputId,e])}))}),500)}}]);return e}();function u(e){t.Runtime.loadExtension("ui.analytics").then((function(t){var i=t.sendData;i(e)}))["catch"]((function(){console.error("catalog.image.input: can't load ui.analytics")}))}babelHelpers.defineProperty(r,"imageInputInstances",new Map);babelHelpers.defineProperty(r,"PROCESS_STATUS","PROCESS");babelHelpers.defineProperty(r,"WAIT_STATUS","WAIT");t.Reflection.namespace("BX.Catalog").ImageInput=r})(this.window=this.window||{},BX,BX.Event);
//# sourceMappingURL=script.map.js