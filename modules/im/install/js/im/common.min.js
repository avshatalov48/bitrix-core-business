(function(e){if(e.BX.MessengerCommon)return;var s=e.BX;var t=function(){this.BXIM={};this.sendBotCommand=false;this.sendBotCommandBlock={};this.tryCheckConnect={};this.externalLink={}};t.prototype.setBxIm=function(e){this.BXIM=e};t.prototype.isIntranet=function(){return this.BXIM.bitrixIntranet};t.prototype.isPage=function(){return typeof s.MessengerWindow!="undefined"};t.prototype.isPopupPage=function(){return typeof s.MessengerWindow!="undefined"&&this.BXIM.context=="POPUP-FULLSCREEN"&&this.BXIM.bitrixIntranet};t.prototype.isDesktop=function(){return typeof s.desktop!="undefined"&&s.desktop.apiReady};t.prototype.getDefaultZIndex=function(){var e=1e3;if(typeof s.SidePanel!=="undefined"&&s.SidePanel.Instance.isOpen()){var t=s.SidePanel.Instance.getTopSlider();if(t){e=t.getZindex()-s.PopupWindow.getOption("popupZindex")}}return e};t.prototype.isSliderEnable=function(){return typeof s.SidePanel!=="undefined"};t.prototype.isSliderSupport=function(){return this.isSliderEnable()&&(!this.isDesktop()||this.isDesktop()&&s.desktop.enableInVersion(44))};t.prototype.isSliderBindingsEnable=function(){return this.isSliderSupport()&&typeof s.SidePanel.Instance.isAnchorBinding!=="undefined"};t.prototype.isMobile=function(){return this.BXIM.mobileVersion};t.prototype.hideLinesKeyboard=function(){if(this.textPanelShowed){this.textPanelShowed=false;BXMobileApp.UI.Page.TextPanel.hide()}};t.prototype.isSessionBlocked=function(e){var t=s.MessengerCommon.linesGetSession(this.BXIM.messenger.chat[e]);if(t&&t.blockDate!==0&&new Date(t.blockDate*1e3)<new Date){return true}return false};t.prototype.isMobileNative=function(){return false};t.prototype.isLinesOperator=function(){return this.BXIM.isLinesOperator};t.prototype.isBot=function(e){return typeof this.BXIM.messenger.bot[e]!="undefined"};t.prototype.isChatId=function(e){return/^(chat|sg|crm)[0-9]{1,}/i.test(e)};t.prototype.isDialogId=function(e){return/^([0-9]{1,}|(chat|sg|crm)[0-9]{1,})/i.test(e)};t.prototype.applyViewCommonUsers=function(e){if(typeof e==="boolean"){this.BXIM.settings.viewCommonUsers=e}if(!this.BXIM.init){return true}if(!this.BXIM.settings.viewCommonUsers){this.BXIM.messenger.recent=this.BXIM.messenger.recent.filter((function(e){return!(e.invited||e.options.default_user_record)}));this.recentListBirthdayApply();this.recentListRedraw();return true}this.BXIM.messenger.recentLoadMore=true;this.recentListRedraw();s.rest.callBatch({recent:["im.recent.list",{SKIP_NOTIFICATION:"Y",SKIP_OPENLINES:s.MessengerCommon.isLinesOperator()?"Y":"N"}],counters:["im.counters.get",{JSON:"Y"}]},function(e){if(e.counters.error()){s.UI.Notification.Center.notify({content:s.message("IM_CONNECT_ERROR"),autoHideDelay:4e3});return false}this.recentListApply(e.recent.data(),e.counters.data());this.recentListRedraw();if(this.BXIM.messenger.checkRecentNeedLoad()){this.BXIM.messenger.recentListLoadMore()}}.bind(this));return true};t.prototype.applyBirthdaySettings=function(e){if(typeof e==="boolean"){this.BXIM.settings.viewBirthday=e}if(!this.BXIM.init){return true}this.recentListBirthdayApply();this.recentListRedraw();return true};t.prototype.isBirthdayEnable=function(){if(this.BXIM.messenger.birthdayEnable==="none"){return false}if(!this.BXIM.settings.viewBirthday){return false}return true};t.prototype.isBirthday=function(e,s){if(!this.isBirthdayEnable()){return false}if(this.BXIM.messenger.birthdayEnable==="department"&&s&&!this.BXIM.messenger.birthdayUsers[s]){return false}var t=new Date;var r=("0"+t.getDate().toString()).substr(-2)+"-"+("0"+(t.getMonth()+1).toString()).substr(-2);return e==r};t.prototype.getDebugInfo=function(){return{context:this.BXIM.context,design:this.BXIM.design,isDesktop:this.isDesktop()?"Y":"N",isPage:this.isPage()?"Y":"N",isMobile:this.isMobile()?"Y":"N",vInitedCall:s.localStorage.get("vInitedCall")?"Y":"N",desktopStatus:this.BXIM.desktopStatus?"Y":"N",hasActiveCall:s.MessengerCalls&&s.MessengerCalls.hasActiveCall()?"Y":"N",hasActiveCallTab:this.BXIM.callController&&this.BXIM.callController.hasActiveCall()?"Y":"N",appVersion:navigator.appVersion}};t.prototype.checkInternetConnection=function(e,t,r,i){if(typeof e!="function"){e=function(){if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("online",false)}}}if(typeof t!="function")t=function(){};if(typeof r!="number")r=1;if(!i&&r>1)i=+new Date;if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}s.ajax({url:"//www.bitrixsoft.com/200.ok."+ +new Date,method:"GET",dataType:"html",skipAuthCheck:true,skipBxHeader:true,timeout:1,onsuccess:function(a){if(a=="OK"){console.log("Checking internet connection... success!");delete s.MessengerCommon.tryCheckConnect[i];e()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("offline")}console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{if(typeof BXIM!="undefined"){BXIM.messenger.connectionStatus("connecting")}clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout((function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)}),5e3)}}},onfailure:function(){console.log("Checking internet connection... failure!");if(r==1){delete s.MessengerCommon.tryCheckConnect[i];t()}else{clearTimeout(s.MessengerCommon.tryCheckConnect[i]);s.MessengerCommon.tryCheckConnect[i]=setTimeout((function(){s.MessengerCommon.checkInternetConnection(e,t,r-1,i)}),5e3)}}});return true};t.prototype.pinDialog=function(e,t){this.recentListElementPin(e,t);s.rest.callMethod("im.recent.pin",{DIALOG_ID:e,ACTION:t?"Y":"N"})};t.prototype.muteMessageChat=function(e,t,r){var i=0;if(e.toString().substr(0,4)=="chat"){i=e.toString().substr(4);if(!this.BXIM.messenger.chat[i])return false}else{i=this.BXIM.messenger.userChat[e];if(!i)return false}r=r!=false;if(!this.BXIM.messenger.userChatBlockStatus[i])this.BXIM.messenger.userChatBlockStatus[i]={};if(typeof t=="undefined"){if(typeof this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=="undefined"){t=true}else{t=!this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]}}else{t=Boolean(t)}this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]=t;if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].mute_list){this.BXIM.messenger.chat[i].mute_list[this.BXIM.userId]=t}this.userListRedraw();this.BXIM.messenger.dialogStatusRedraw();this.BXIM.messenger.updateMessageCount();var a=this.BXIM.messenger.userChatBlockStatus[i][this.BXIM.userId]?"Y":"N";if(r){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_MUTE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.chat.mute",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+i),data:{timMuteAction:a}}),method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_MUTE:"Y",CHAT_ID:i,MUTE:a,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}};t.prototype.MobileActionEqual=function(e){if(!this.isMobile())return true;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return true}return false};t.prototype.MobileActionNotEqual=function(e){if(!this.isMobile())return false;for(var s=0;s<arguments.length;s++){if(arguments[s]==this.BXIM.mobileAction)return false}return true};t.prototype.isScrollMax=function(s,t){if(!s)return true;t=typeof t=="number"?t:0;if(this.isMobile()){var r=e.orientation==0?screen.height-125:screen.width-113;return document.body.scrollHeight-r-r/2<=s.scrollTop}else{return s.scrollHeight-s.offsetHeight-t<=s.scrollTop}};t.prototype.isScrollMin=function(e){if(!e)return false;return 0==e.scrollTop};t.prototype.enableScroll=function(e,t,r){if(!e)return false;if(this.BXIM.messenger.isBodyScroll)return false;if(this.isMobile()){return true}r=r!==false;t=400;if(!(r&&this.isScrollMax(e,t))){return false}var i=this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab]&&this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]?s("im-message-"+this.BXIM.messenger.unreadMessage[this.BXIM.messenger.currentTab][0]):null;if(i){var a=i.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling?i.parentNode.parentNode.parentNode.parentNode.parentNode.previousElementSibling:i.parentNode.parentNode.parentNode.parentNode.parentNode;var n=this.isElementVisibleOnScreen(a,e,true);if(!n.top||n.coords.top>0&&n.coords.top<150||n.coords.top<0){return false}}return true};t.prototype.preventDefault=function(t){t=t||e.event;if(t.stopPropagation)t.stopPropagation();else t.cancelBubble=true;if(typeof BXIM!="undefined"&&BXIM.messenger&&BXIM.messenger.closeMenuPopup)BXIM.messenger.closeMenuPopup();if(typeof s!="undefined"&&s.calendar&&s.calendar.get().popup)s.calendar.get().popup.close()};t.prototype.countObject=function(e){var s=0;for(var t in e){if(e.hasOwnProperty(t)){s++}}return s};t.prototype.isElementCoordsBelow=function(e,s,t,r){if(this.isMobile()){return true}if(!s||typeof s.getElementsByClassName=="undefined"){return false}t=t?t:0;var i=this.getElementCoords(e,s);i.bottom=i.top+e.offsetHeight;var a=i.top>=t;var n=i.bottom>t;if(r){return{top:a,bottom:n,coords:i}}else{return a||n}};t.prototype.isElementVisibleOnScreen=function(e,s,t){if(this.isMobile()){return BitrixMobile.Utils.isElementVisibleOnScreen(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var r=this.getElementCoords(e,s);r.bottom=r.top+e.offsetHeight;var i=s.scrollTop;var a=i+s.clientHeight;var n=r.top>=0&&r.top<a;var o=r.bottom>0&&r.bottom<s.clientHeight;if(t){return{result:n||o,top:n,bottom:o,coords:r}}else{return n||o}};t.prototype.getElementCoords=function(e,s){if(this.isMobile()){return BitrixMobile.Utils.getElementCoords(e)}if(!s||typeof s.getElementsByClassName=="undefined"){return false}var t=e.getBoundingClientRect();var r=s.getBoundingClientRect();return{originTop:t.top,originLeft:t.left,top:t.top-r.top,left:t.left-r.left}};t.prototype.getDateFormatType=function(e){e=e?e.toString().toUpperCase():"DEFAULT";var t=[];if(e=="MESSAGE_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_M_MESSAGE_TITLE_FORMAT_DATE"))]]}else if(e=="MESSAGE"){t=[["",s.message("IM_M_MESSAGE_FORMAT_TIME")]]}else if(e=="RECENT_TITLE"){t=[["tommorow","today"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else if(e=="RECENT_OL_TITLE"){t=[["tommorow","tommorow"],["today","today"],["yesterday","yesterday"],["",s.Main.Date.convertBitrixFormat(s.message("IM_CL_RESENT_FORMAT_DATE"))]]}else{t=[["tommorow","tommorow, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["today","today, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["yesterday","yesterday, "+s.message("IM_M_MESSAGE_FORMAT_TIME")],["",s.Main.Date.convertBitrixFormat(s.message("FORMAT_DATETIME"))]]}return t};t.prototype.formatDate=function(e,t){if(typeof t=="undefined"){t=this.getDateFormatType("DEFAULT")}if(!s.type.isDate(e)){if(typeof e=="string"){e=new Date(e)}console.log(e,t);console.trace();return""}return s.Main.Date.format(t,Math.round(e.getTime()/1e3)+parseInt(s.message("SERVER_TZ_OFFSET"))+parseInt(s.message("USER_TZ_OFFSET")),Math.round((new Date).getTime()/1e3)+parseInt(s.message("SERVER_TZ_OFFSET"))+parseInt(s.message("USER_TZ_OFFSET")),true)};t.prototype.getNowDate=function(e){var s=new Date;if(e===true){s=new Date(s.getFullYear(),s.getMonth(),s.getDate(),0,0,0)}return s};t.prototype.replaceDateText=function(e,s,t){if(!t.DATE_TEXT||!t.DATE_TS){return s}var r=[];s=s.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,(function(e){var s=r.length;r.push(e);return"####REPLACEMENT_TEXT_"+s+"####"}));s=s.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,(function(e){var s=r.length;r.push(e);return"####REPLACEMENT_TEXT_"+s+"####"}));s=s.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,(function(e){var s=r.length;r.push(e);return"####REPLACEMENT_TEXT_"+s+"####"}));t.DATE_TEXT.forEach(function(r,i){if(!r){return true}var a=t.DATE_TS[i]||+new Date;s=s.split(r).join('<span class="bx-messenger-ajax bx-messenger-ajax-black" data-entity="date" data-messageId="'+e+'" data-ts="'+a+'">'+r+"</span>")}.bind(this));if(r.length>0){do{for(var i=0;i<r.length;i++){s=s.replace("####REPLACEMENT_TEXT_"+i+"####",r[i])}}while(s.indexOf("####REPLACEMENT_TEXT_")>-1)}return s};t.prototype.formatUrl=function(e){if(this.isMobile()&&this.BXIM.webComponent&&currentDomain){if(e&&e.indexOf("/")===0){e=currentDomain+e}}return encodeURI(e)};t.prototype.isBlankAvatar=function(e){return!e||e.toString().indexOf(this.BXIM.pathToBlankImage)>=0};t.prototype.getDefaultAvatar=function(e){return"/bitrix/js/im/images/default-avatar-"+e+".png"};t.prototype.getAvatarStyle=function(e,t){t=!!t;if(s.MessengerCommon.isBlankAvatar(e.avatar)){avatarStyle="background-color: "+e.color}else{avatarStyle="background: url('"+e.avatar+"'); background-size: cover;"}if(!t){avatarStyle='style="'+avatarStyle+'"'}return avatarStyle};t.prototype.hideErrorImage=function(e,t){if(t){s.remove(e.parentNode);return true}var r=e.src;if(e.parentNode&&e.parentNode.parentNode){e.parentNode.parentNode.className="bx-messenger-message";e.parentNode.parentNode.innerHTML=s.create("a",{attrs:{href:r,target:"_blank"},text:decodeURI(r)}).outerHTML}return true};t.prototype.prepareText=function(e,t,r,i,a,n){if(!e){return e}var o=e;t=t==true;r=r==true;i=i==true;a=false;o=s.util.trim(o);if(t){o=s.util.htmlspecialchars(o)}if(o.indexOf("/me")==0){o=o.substr(4);o="<i>"+o+"</i>"}else if(o.indexOf("/loud")==0){o=o.substr(6);o="<b>"+o+"</b>"}o=this.decodeBbCode(o);if(t){o=o.replace(/\n/gi,"<br />")}if(r){o=o.replace(/------------------------------------------------------<br \/>(.*?)\[(.*?)\](?: #(?:(?:chat)?\d+|\d+:\d+)\/\d+)?<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,(function(e,s,t,r,i,a){return(a>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap"><div class="bx-messenger-content-quote-name">'+s+' <span class="bx-messenger-content-quote-time">'+t+"</span></div>"+r+"</div></div><br />"}));o=o.replace(/------------------------------------------------------<br \/>(.*?)------------------------------------------------------(<br \/>)?/g,(function(e,s,t,r,i){return(i>0?"<br>":"")+'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">'+s+"</div></div><br />"}))}var l="&gt;&gt;";if(r&&o.indexOf(l)>=0){var m=false;var h=o.split("<br />");for(var g=0;g<h.length;g++){if(h[g].substring(0,l.length)==l){h[g]=h[g].replace(l,'<div class="bx-messenger-content-quote"><span class="bx-messenger-content-quote-icon"></span><div class="bx-messenger-content-quote-wrap">');while(++g<h.length&&h[g].substring(0,l.length)==l){h[g]=h[g].replace(l,"")}h[g-1]+="</div></div>";m=true}}o=h.join("<br />")}o=o.replace(/( ){4}/gi,"\t");o=o.replace(/\t/gi,"&nbsp;&nbsp;&nbsp;&nbsp;");if(i){var p=false;o=o.replace(/(.)?((https|http):\/\/([\S]+)\.(jpg|jpeg|png|gif|webp)(\?[\S]+)?)/gi,(function(e,t,r){if(t&&![">","]"].includes(t)||!r.match(/(\.(jpg|jpeg|png|gif|webp)\?|\.(jpg|jpeg|png|gif|webp)$)/i)||r.toLowerCase().indexOf("/docs/pub/")>0||r.toLowerCase().indexOf("logout=yes")>0){return e}else if(s.MessengerCommon.isMobile()){p=true;return(t?t:"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" class="bx-messenger-file-image-text" onclick="BXIM.messenger.openPhotoGallery(this.src);" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span>'}else{p=true;var i=typeof this.BXIM.messenger.getChatId!="undefined"?this.BXIM.messenger.getChatId():this.BXIM.messenger.currentTab;return(t?t:"")+'<span class="bx-messenger-file-image"><span class="bx-messenger-file-image-src"><img src="'+r+'" data-viewer="null" data-viewer-group-by="'+i+'" data-title="'+s.util.jsencode(r)+'" class="bx-messenger-file-image-text" onerror="BX.MessengerCommon.hideErrorImage(this)"></span></span>'}}));if(p){o=o.replace(/<\/span>(\n?)<\/a>(\n?)<br(\s\/?)>/gi,"</span></a>").replace(/<\/span>(\n?)(\n?)<br(\s\/?)>/gi,"</span>")}}if(this.BXIM.settings.enableBigSmile){var c=false;o=o.replace(/^(\s*<img\s+src=[^>]+?data-code=[^>]+?data-definition="UHD"[^>]+?style="width:)(\d+)(px[^>]+?height:)(\d+)(px[^>]+?class="bx-smile"\s*\/?>\s*)$/,(function e(s,t,r,i,a,n){c=true;return t+parseInt(r,10)*1.6+i+parseInt(a,10)*1.6+n}));if(n&&c){n.oneSmileInMessage=true}}if(o.substr(-6)=="<br />"){o=o.substr(0,o.length-6)}o=o.replace(/<br><br \/>/gi,"<br />");o=o.replace(/<br \/><br>/gi,"<br />");return o};t.prototype.trimText=function(e){return s.util.trim(e)};t.prototype.purifyText=function(e,t){e=e?e.toString():"";if(e){e=this.trimText(e);if(e.indexOf("/me")==0){e=e.substr(4)}else if(e.indexOf("/loud")==0){e=e.substr(6)}if(e.substr(-6)=="<br />"){e=e.substr(0,e.length-6)}e=e.replace(/<br><br \/>/gi,"<br />");e=e.replace(/<br \/><br>/gi,"<br />");e=e.replace(/\[CODE\]\n?([\0-\uFFFF]*?)\[\/CODE\]/gis,(function(e,t){return"["+s.message("IM_M_CODE_BLOCK")+"] "}));e=e.replace(/\[PUT(?:=(?:.+?))?\](?:.+?)?\[\/PUT]/gi,(function(e){return e.replace(/\[PUT(?:=(.+))?\](.+?)?\[\/PUT]/gi,(function(e,s,t){return t?t:s}))}));e=e.replace(/\[SEND(?:=(?:.+?))?\](?:.+?)?\[\/SEND]/gi,(function(e){return e.replace(/\[SEND(?:=(.+))?\](.+?)?\[\/SEND]/gi,(function(e,s,t){return t?t:s}))}));e=this.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,s)=>s));e=this.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,s)=>s));e=this.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,s)=>s));e=this.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,s)=>s));e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,((e,s,t)=>t?t:s));e=e.replace(/\[url(?:=(.+))?](.*?)\[\/url]/gis,((e,s,t)=>t?t:s));e=e.replace(/\[RATING=([1-5]{1})\]/gi,(function(e,t){return"["+s.message("IM_F_RATING")+"] "}));e=e.replace(/\[ATTACH=([0-9]{1,})\]/gi,(function(e,t){return"["+s.message("IM_F_ATTACH")+"] "}));e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER\]/gi,"$3");e=e.replace(/\[CHAT=([0-9]{1,})\](.*?)\[\/CHAT\]/gi,"$2");e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,s,t,r)=>r));e=e.replace(/\[CALL=(.*?)](.*?)\[\/CALL\]/gi,"$2");e=e.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,"$2");e=e.replace(/\[size=(\d+)](.*?)\[\/size]/gis,"$2");e=e.replace(/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,"$2");e=e.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");e=e.replace(/<span.*?title="([^"]*)".*?>.*?<\/span>/gi,"($1)");e=e.replace(/<img.*?title="([^"]*)".*?>/gi,"($1)");e=e.replace(/\[ATTACH=([0-9]{1,})\]/gi,(function(e,t,r){return t==1e4?"":"["+s.message("IM_F_ATTACH")+"] "}));e=e.replace(/<s>([^"]*)<\/s>/gi," ");e=e.replace(/\[s\]([^"]*)\[\/s\]/gi," ");e=e.replace(/\[icon\=([^\]]*)\]/gi,function(e){var t=e.match(/title\=(.*[^\s\]])/i);if(t&&t[1]){t=t[1];if(t.indexOf("width=")>-1){t=t.substr(0,t.indexOf("width="))}if(t.indexOf("height=")>-1){t=t.substr(0,t.indexOf("height="))}if(t.indexOf("size=")>-1){t=t.substr(0,t.indexOf("size="))}if(t){t="("+this.trimText(t)+")"}}else{t="("+s.message("IM_M_ICON")+")"}return t}.bind(this));e=e.split("<br />").map((function(e){return e.replace(/(>>).+/gi," ["+s.message("IM_M_QUOTE_BLOCK")+"] ")})).join(" ").replace(/<\/?[^>]+>/gi,"").replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim," ["+s.message("IM_M_QUOTE_BLOCK")+"] ").replace(/-{54}(.*?)-{54}/gs,"["+s.message("IM_M_QUOTE_BLOCK")+"]");e=this.trimText(e)}if(t&&t.ATTACH&&t.ATTACH.length>0){const r=[];let i=false;t.ATTACH.forEach((e=>{if(e.DESCRIPTION==="SKIP_MESSAGE"){i=true}else if(e.DESCRIPTION){r.push(this.purifyText(e.DESCRIPTION))}}));if(!i){e=e+(e?" ":"")+(r.length>0?r.join(" "):"["+s.message("IM_F_ATTACH")+"]")}}if(e.length<=0){if(t&&(t.WITH_FILE||t.FILE_ID&&t.FILE_ID.length>0)){e="["+s.message("IM_F_FILE")+"]"}else if(t&&t.WITH_ATTACH){e="["+s.message("IM_F_ATTACH")+"]"}else{e=s.message("IM_M_DELETED")}}return e};t.prototype.decodeBbCode=function(e,t,r){if(!e){return e}e=e.toString();t=typeof t==="undefined"?false:t;r=typeof r==="undefined"?false:r===true;if(r){e=s.util.htmlspecialchars(e)}var i=[];e=e.replace(/\[PUT(?:=(.+?))?\](.+?)?\[\/PUT\]/gi,(function(e){var s=i.length;i.push(e);return"####REPLACEMENT_PUT_"+s+"####"}));var a=[];e=e.replace(/\[SEND(?:=(.+?))?\](.+?)?\[\/SEND\]/gi,(function(e){var s=a.length;a.push(e);return"####REPLACEMENT_SEND_"+s+"####"}));var n=[];e=e.replace(/\[CODE\]\n?([\0-\uFFFF]*?)\[\/CODE\]/gis,(function(e,s){var t=n.length;n.push(s);return"####REPLACEMENT_CODE_"+t+"####"}));e=e.replace(/\[url(?:=([^\[\]]+))?](.*?)\[\/url]/gis,(function(e,t,r){t=s.util.htmlspecialcharsback(t?t:r);try{var i=new URL(t,location.origin+location.pathname)}catch(s){return e}var a=["http:","https:","ftp:","file:","tel:","callto:","mailto:","skype:","viber:"];if(a.indexOf(i.protocol)<=-1){return e}var n=document.createElement("a");n.href=i.href;n.target="_blank";n.text=s.util.htmlspecialcharsback(r);return n.outerHTML}));e=e.replace(/\[url(?:=(.+?[^[\]]))?](.*?)\[\/url]/gis,((e,t,r)=>{t=s.util.htmlspecialcharsback(t?t:r);try{var i=new URL(t,location.origin+location.pathname)}catch(s){return e}var a=["http:","https:","ftp:","file:","tel:","callto:","mailto:","skype:","viber:"];if(a.indexOf(i.protocol)<=-1){return e}i=i.href;if(!i.slice(i.lastIndexOf("[")).includes("]")){if(r.startsWith("]")){i=`${i}]`;r=r.slice(1)}else if(r.startsWith("=")){const e=s.Text.decode(r.slice(1,r.lastIndexOf("]")));i=`${i}]=${e}`;r=r.slice(r.lastIndexOf("]")+1)}}return s.Dom.create({tag:"a",attrs:{href:i,target:"_blank"},html:r}).outerHTML}));e=e.replace(/\[BR\]/gi,"<br/>");e=this.recursiveReplace(e,/\[b]([^[]*(?:\[(?!b]|\/b])[^[]*)*)\[\/b]/gi,((e,s)=>"<b>"+s+"</b>"));e=this.recursiveReplace(e,/\[u]([^[]*(?:\[(?!u]|\/u])[^[]*)*)\[\/u]/gi,((e,s)=>"<u>"+s+"</u>"));e=this.recursiveReplace(e,/\[i]([^[]*(?:\[(?!i]|\/i])[^[]*)*)\[\/i]/gi,((e,s)=>"<i>"+s+"</i>"));e=this.recursiveReplace(e,/\[s]([^[]*(?:\[(?!s]|\/s])[^[]*)*)\[\/s]/gi,((e,s)=>"<s>"+s+"</s>"));e=e.replace(/\[size=(\d+)(?:pt|px)?](.*?)\[\/size]/gis,((e,t,r)=>{t=Number.parseInt(t,10);if(t<=8){t=8}else if(t>=30){t=30}return s.Dom.create({tag:"span",style:{fontSize:t+"px"},html:r}).outerHTML}));e=e.replace(/\[color=#([0-9a-f]{3}|[0-9a-f]{6})](.*?)\[\/color]/gis,((e,t,r)=>s.Dom.create({tag:"span",style:{color:"#"+t},html:r}).outerHTML));e=e.replace(/\[LIKE\]/gi,'<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>');e=e.replace(/\[DISLIKE\]/gi,'<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>');e=e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER\]/gi,s.delegate((function(e,s,r,i){var a="";if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="livechat")return i;s=parseInt(s);if(!t&&i&&s>0)a='<span class="bx-messenger-ajax '+(s==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+s+'">'+i+"</span>";else a=i;return a}),this));e=e.replace(/\[CHAT=(imol\|)?([0-9]{1,})\](.*?)\[\/CHAT\]/gi,(function(e,s,r,i){var a="";r=parseInt(r);if(!t&&i&&r>0&&typeof BXIM!="undefined"){if(s){a='<span class="bx-messenger-ajax" data-entity="openlines" data-sessionId="'+r+'">'+i+"</span>"}else{a='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+r+'">'+i+"</span>"}}else{a=i}return a}));e=e.replace(/\[context=(chat\d+|\d+:\d+)\/(\d+)](.*?)\[\/context]/gis,((e,s,t,r)=>r));e=e.replace(/\[PCH=([0-9]{1,})\](.*?)\[\/PCH\]/gi,(function(e,s,r){var i="";s=parseInt(s);if(!t&&r&&s>0)i='<span class="bx-messenger-ajax" data-entity="phoneCallHistory" data-historyId="'+s+'">'+r+"</span>";else i=r;return i}));e=e.replace(/\[CALL(?:=(.+?))?\](.+?)?\[\/CALL\]/gi,(function(e,r,i){var a="";i=i?i:r;r=r?r:i;if(!t&&i)a='<span class="bx-messenger-command" data-entity="call" data-command="'+s.util.htmlspecialchars(r)+'">'+i+"</span>";else a=i;return a}));var o=0;if(this.BXIM.settings.enableBigSmile){o=s.util.trim(e.replace(/\[icon\=([^\]]*)\]/gi,"")).length}e=e.replace(/\[icon\=([^\]]*)\]/gi,s.delegate((function(e){var t=e.match(/icon\=(\S+[^\s.,> )\];\'\"!?])/i);if(t&&t[1]){t=t[1]}else{return""}var r={src:t,border:0};var i=e.match(/size\=(\d+)/i);if(i&&i[1]){r["width"]=i[1];r["height"]=i[1]}else{var a=e.match(/width\=(\d+)/i);if(a&&a[1]){r["width"]=a[1]}var n=e.match(/height\=(\d+)/i);if(n&&n[1]){r["height"]=n[1]}if(r["width"]&&!r["height"]){r["height"]=r["width"]}else if(r["height"]&&!r["width"]){r["width"]=r["height"]}else if(r["height"]&&r["width"]){}else{r["width"]=20;r["height"]=20}}r["width"]=r["width"]>100?100:r["width"];r["height"]=r["height"]>100?100:r["height"];if(this.BXIM.settings.enableBigSmile&&o==0&&r["width"]==r["height"]&&r["width"]==20){r["width"]=40;r["height"]=40}var l=e.match(/title\=(.*[^\s\]])/i);if(l&&l[1]){l=l[1];if(l.indexOf("width=")>-1){l=l.substr(0,l.indexOf("width="))}if(l.indexOf("height=")>-1){l=l.substr(0,l.indexOf("height="))}if(l.indexOf("size=")>-1){l=l.substr(0,l.indexOf("size="))}if(l){l=s.util.trim(l);r["title"]=l;r["alt"]=l}}else{r["title"]=s.message("IM_M_ICON");r["alt"]=r["title"]}return s.create("img",{attrs:r,props:{className:"bx-smile bx-icon"}}).outerHTML}),this));e=e.replace(/\[RATING\=([1-5]{1})\]/gi,s.delegate((function(e,s){return this.linesVoteHeadNodes(0,s,false).outerHTML}),this));const l=s.Reflection.getClass("BX.Messenger.v2.Lib.Parser");if(l){e=l.decodeSmileForLegacyCore(e,{enableBigSmile:this.BXIM.settings.enableBigSmile})}if(a.length>0){for(var m=0;m<a.length;m++){e=e.replace("####REPLACEMENT_SEND_"+m+"####",a[m])}}e=e.replace(/\[SEND(?:=(?:.+?))?\](?:.+?)?\[\/SEND]/gi,(function(e){return e.replace(/\[SEND(?:=(.+))?\](.+?)?\[\/SEND]/gi,(function(e,r,i){var a="";i=i?i:r;r=(r?r:i).replace("<br />","\n");if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);r=r.split("####REPLACEMENT_PUT_").join("####REPLACEMENT_SP_");a='<span class="bx-messenger-command" data-entity="send" title="'+s.message("IM_BB_SEND")+'">'+i+"</span>";a+='<span class="bx-messenger-command-data">'+r+"</span>"}else{a=i}return a}))}));if(i.length>0){for(var m=0;m<i.length;m++){e=e.replace("####REPLACEMENT_PUT_"+m+"####",i[m])}}e=e.replace(/\[PUT(?:=(?:.+?))?\](?:.+?)?\[\/PUT]/gi,(function(e){return e.replace(/\[PUT(?:=(.+))?\](.+?)?\[\/PUT]/gi,(function(e,r,i){var a="";i=i?i:r;r=(r?r:i).replace("<br />","\n");if(!t&&i){i=i.replace(/<([\w]+)[^>]*>(.*?)<\/\1>/i,"$2",i);i=i.replace(/\[([\w]+)[^\]]*\](.*?)\[\/\1\]/i,"$2",i);a='<span class="bx-messenger-command" data-entity="put" title="'+s.message("IM_BB_PUT")+'">'+i+"</span>";a+='<span class="bx-messenger-command-data">'+r+"</span>"}else{a=i}return a}))}));if(n.length>0){for(var m=0;m<n.length;m++){e=e.replace("####REPLACEMENT_CODE_"+m+"####",!t?'<div class="bx-messenger-code">'+n[m]+"</div>":n[m])}}if(a.length>0){do{for(var m=0;m<a.length;m++){e=e.replace("####REPLACEMENT_SEND_"+m+"####",a[m])}}while(e.indexOf("####REPLACEMENT_SEND_")>-1)}e=e.split("####REPLACEMENT_SP_").join("####REPLACEMENT_PUT_");if(i.length>0){do{for(var m=0;m<i.length;m++){e=e.replace("####REPLACEMENT_PUT_"+m+"####",i[m])}}while(e.indexOf("####REPLACEMENT_PUT_")>-1)}return e};t.prototype.recursiveReplace=function(e,t,r){if(!s.Type.isStringFilled(e)){return e}let i=0;let a=true;do{a=false;i++;e=e.replace(t,((...e)=>{a=true;return r(...e)}))}while(a&&i<=10);return e};t.prototype.openLink=function(s,t){t=t||"_blank";e.open(s,t,"",true);return true;return true};t.prototype.clipboardCopy=function(e,t){document.execCommand(t==true?"cut":"copy");var r=s.create("textarea",{style:{position:"absolute",opacity:0,top:-1e3,left:-1e3}});document.body.insertBefore(r,document.body.firstChild);r.focus();document.execCommand("paste");var i=r.value;var a=null;if(typeof e=="function"){a=e(r.value)}else if(typeof e!="undefined"){a=e.toString()}if(a){i=r.value=a;r.selectionStart=0;document.execCommand("copy")}s.remove(r);return i};t.prototype.clipboardCut=function(){return this.clipboardCopy(null,true)};t.prototype.prepareTextBack=function(e,t){var r=e;t=t===true;r=s.util.htmlspecialcharsback(r);r=r.replace(/<(\/*)([buis]+)>/gi,"[$1$2]");r=r.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1");r=r.replace(/<a.*?href="([^"]*)".*?>.*?<\/a>/gi,"$1");if(!t){r=r.replace(/\[CODE\]\n?([\0-\uFFFF]*?)(<br\/?>)?\[\/CODE\]/gis,"["+s.message("IM_M_CODE_BLOCK")+"]");r=r.replace(/------------------------------------------------------(.*?)------------------------------------------------------/gim,"["+s.message("IM_M_QUOTE_BLOCK")+"]")}r=r.split("&nbsp;&nbsp;&nbsp;&nbsp;").join("\t");r=r.split("&nbsp;").join(" ");r=r.split("<br />").join("\n");return r};t.prototype.addMentionList=function(e,s,t){if(!e||!s)return false;if(!this.BXIM.messenger.mentionList[e])this.BXIM.messenger.mentionList[e]={};this.BXIM.messenger.mentionList[e][s]=t};t.prototype.prepareMention=function(e,t){if(!this.BXIM.messenger.mentionList[e])return t;for(var r in this.BXIM.messenger.mentionList[e]){var i=this.BXIM.messenger.mentionList[e][r];if(!i){continue}if(i.toString().substr(0,4)=="chat"){t=t.split(r).join("[CHAT="+i.toString().substr(4)+"]"+r+"[/CHAT]")}else{t=t.split(r).join("[USER="+i+"]"+r+"[/USER]")}}if(!s.browser.IsIE11()){try{t=t.replace(RegExp("-{54}\n(.*?)\n-{54}","gs"),(function(e){return e.replace(/\[USER=([0-9]+)( REPLACE)?](.*?)\[\/USER\]/gi,"$3")}))}catch(e){}}this.clearMentionList(e);return t};t.prototype.clearMentionList=function(e){delete this.BXIM.messenger.mentionList[e]};t.prototype.getRecipientByChatId=function(e){var s=0;if(this.BXIM.messenger.chat[e]){s="chat"+e}else{for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}}return s};t.prototype.getUserIdByChatId=function(e){var s=0;for(var t in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[t]==e){s=t;break}}return s};t.prototype.getUserParam=function(e,t){e=typeof e=="undefined"?this.BXIM.userId:e;t=typeof t=="boolean"?t:false;if(e&&(e.toString().substr(0,4)=="chat"||e.toString().substr(0,2)=="sg"||e.toString().substr(0,3)=="crm")){var r=e.toString().substr(0,4)=="chat"?e.toString().substr(4):e;if(t||!(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].id)){this.BXIM.messenger.chat[r]={id:r,name:s.message("IM_M_LOAD_USER"),owner:0,work_position:"",avatar:this.BXIM.pathToBlankImage,type:"chat",color:"#556574",mute_list:{},fake:true,date_create:false};if(t){this.BXIM.messenger.chat[r].fake=false}}return this.BXIM.messenger.chat[r]}else{if(t||!(this.BXIM.messenger.users[e]&&this.BXIM.messenger.users[e].id)){var i=parseInt(e)?this.BXIM.path.profileTemplate.replace("#user_id#",e):"";this.BXIM.messenger.users[e]={id:e,avatar:this.BXIM.pathToBlankImage,name:s.message("IM_M_LOAD_USER"),profile:i,status:"guest",work_position:"",extranet:false,network:false,color:"#556574",fake:true,last_activity_date:false,mobile_last_date:false,absent:false,idle:false};this.BXIM.messenger.hrphoto[e]="/bitrix/js/im/images/hidef-avatar-v3.png";if(t){this.BXIM.messenger.users[e].fake=false}}return this.BXIM.messenger.users[e]}};t.prototype.userInChat=function(e,s){if(!this.BXIM.messenger.userInChat[e])return false;if(typeof s=="undefined"){s=this.BXIM.userId}else{s=parseInt(s)}var t=false;if(this.BXIM.messenger.userInChat[e].indexOf(s.toString())>-1||this.BXIM.messenger.userInChat[e].indexOf(parseInt(s))>-1){t=true}return t};t.prototype.onOnlineStatusCallback=function(e,s,t,r,i){console.log("Run callback for",i,e,s,t,r)};t.prototype.getUserStatus=function(e,t){t=t!==false;var r=this.getOnlineData(e);var i="offline";var a="";var n="";var o="";if(!e){i="guest";a=s.message("IM_STATUS_GUEST")}else if(e.network){i="network";a=s.message("IM_STATUS_NETWORK");if(e.bot&&this.BXIM.messenger.bot[e.id]&&this.BXIM.messenger.bot[e.id].type=="support24"){i="support24"}}else if(e.bot){i="bot";a=s.message("IM_STATUS_BOT")}else if(e.connector){i=e.status=="offline"?"lines":"lines-online";a=s.message("IM_CL_USER_LINES")}else if(e.status=="guest"){i="guest";a=s.message("IM_STATUS_GUEST")}else if(this.getCurrentUser()==e.id){i=e.status?e.status.toString():"online";a=i?s.message("IM_STATUS_"+i.toUpperCase()):""}else if(!r.isOnline){i="offline";a=s.message("IM_STATUS_OFFLINE")}else if(this.getUserMobileStatus(e)){i="mobile";a=s.message("IM_STATUS_MOBILE")}else if(this.getUserIdleStatus(e,r)){i=e.status==="break"?"break-idle":"idle";a=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else{i=e.status?e.status.toString():"offline";a=s.message("IM_STATUS_"+i.toUpperCase())}if(e&&this.isBirthday(e.birthday,e.id)&&(e.status=="online"||!r.isOnline)){n=i;o=a;i="birthday";if(r.isOnline){a=s.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}else{a=s.message("IM_STATUS_OFFLINE")}}else if(e&&e.absent){n=i;o=a;i="vacation";if(r.isOnline){a=s.message("IM_STATUS_ONLINE")}else{a=s.message("IM_STATUS_VACATION")}}return t?i:{status:i,statusText:a,originStatus:n?n:i,originStatusText:o?o:a}};t.prototype.getOnlineData=function(e){var t={};if(e){if(e.id==this.getCurrentUser()){e.last_activity_date=new Date;e.mobile_last_date=false;e.idle=false}t=s.user.getOnlineStatus(e.last_activity_date)}return t};t.prototype.getUserIdle=function(e){if(!e){return""}var s="";if(e.idle){var t=((new Date).getTime()-e.idle.getTime())/1e3>=3600?"Hdiff":"idiff";s=this.formatDate(e.idle,[["s60","sdiff"],["i60","idiff"],["H24","Hdiff"],["","ddiff"]])}return s};t.prototype.getUserMobileStatus=function(e){if(!e)return false;return e.mobile_last_date&&new Date-e.mobile_last_date<parseInt(s.message("LIMIT_ONLINE"))*1e3&&e.last_activity_date-e.mobile_last_date<300*1e3};t.prototype.getUserIdleStatus=function(e,t){if(!e)return"";t=t?t:s.user.getOnlineStatus(e.last_activity_date);return e.idle&&t.isOnline};t.prototype.getUserPosition=function(e,t){t=t===true;if(!e)return"";var r="";if(t&&e.last_activity_date&&!(e.bot||e.network)){r=this.getUserLastDate(e);if(r){return r}}if(e.work_position){r=e.work_position}else if(e.extranet||e.network){r=s.message("IM_CL_USER_EXTRANET")}else if(e.bot){r=s.message("IM_CL_BOT")}else{r=this.isIntranet()?s.message("IM_CL_USER"):s.message("IM_CL_USER_B24")}return r};t.prototype.getUserLastDate=function(e){if(!e){return""}var t="";var r={};if(e.bot||e.network){t=""}else if(e.absent&&!this.getUserMobileStatus(e)){r=this.getOnlineData(e);t=s.message("IM_STATUS_VACATION_TITLE").replace("#DATE#",s.Main.Date.format(s.Main.Date.convertBitrixFormat(s.message("FORMAT_DATE")),e.absent.getTime()/1e3));if(r.isOnline&&e.idle){t=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(r.isOnline&&!r.lastSeenText){t=s.message("IM_STATUS_ONLINE")+". "+t}else if(r.lastSeenText){t=s.message("IM_LS_"+(e.gender=="F"?"F":"M")).replace("#POSITION#",t).replace("#LAST_SEEN#",r.lastSeenText)}}else if(e.last_activity_date){r=this.getOnlineData(e);if(r.isOnline&&e.idle&&!this.getUserMobileStatus(e)){t=s.message("IM_STATUS_AWAY_TITLE").replace("#TIME#",this.getUserIdle(e))}else if(r.isOnline&&!r.lastSeenText){if(this.isMobile()&&this.getUserMobileStatus(e)){t=s.message("IM_STATUS_MOBILE")}else{t=s.message("IM_STATUS_ONLINE")}}else if(r.lastSeenText){t=s.message("IM_LS_SHORT_"+(e.gender=="F"?"F":"M")).replace("#LAST_SEEN#",r.lastSeenText)}}return t};t.prototype.isIntranet=function(){return this.BXIM.bitrixIntranet};t.prototype.getCurrentUser=function(){return this.BXIM.userId};t.prototype.getDialogId=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){return this.BXIM.messenger.currentTab}return parseInt(this.BXIM.messenger.currentTab)};t.prototype.getLogTrackingParams=function(e){if(typeof e!=="object"||!e){e={}}var t=e.name||"tracking";var r=e.data||[];var i=e.dialog||null;var a=e.message||null;var n=e.files||null;var o=[];t=encodeURIComponent(t);if(r&&!s.type.isArray(r)&&typeof r==="object"){var l=[];for(var m in r){if(r.hasOwnProperty(m)){l.push(encodeURIComponent(m)+"="+encodeURIComponent(r[m]))}}r=l}else if(!s.type.isArray(r)){r=[]}if(i){o.push("timType="+i.type);if(i.type==="lines"){o.push("timLinesType="+i.entityId.split("|")[0])}}if(n){var h="file";if(s.type.isArray(n)&&n[0]){h=n[0].type}else{h=n.type}o.push("timMessageType="+h)}else if(a){o.push("timMessageType=text")}if(navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("bitrixmobile")>-1){o.push("timDevice=bitrixMobile")}else if(navigator.userAgent&&navigator.userAgent.toLowerCase().indexOf("bitrixdesktop")>-1){o.push("timDevice=bitrixDesktop")}else if(navigator.userAgent.toLowerCase().indexOf("iphone")>-1||navigator.userAgent.toLowerCase().indexOf("ipad")>-1||navigator.userAgent.toLowerCase().indexOf("android")>-1){o.push("timDevice=mobile")}else{o.push("timDevice=web")}return t+(r.length?"&"+r.join("&"):"")+(o.length?"&"+o.join("&"):"")};t.prototype.getDialogDataForTracking=function(e){var s={type:"private",entityId:"",entityTypeId:""};if(e.toString().indexOf("chat")===0){s.type="chat";var t=e.toString().substr(4);if(this.BXIM.messenger.chat[t]){s.type=this.BXIM.messenger.chat[t].type;s.entityTypeId=this.BXIM.messenger.chat[t].entity_type_id;s.entityId=this.BXIM.messenger.chat[t].entity_id}}return s};t.prototype.getChatUsers=function(){if(this.BXIM.messenger.currentTab.toString().substr(0,4)!="chat"){return[].push(parseInt(this.BXIM.messenger.currentTab))}var e=this.BXIM.messenger.currentTab.toString().substr(4);var s=[];if(this.BXIM.messenger.userInChat[e]){s=this.BXIM.messenger.userInChat[e].map((function(e){return parseInt(e)}))}return s};t.prototype.setColor=function(e,t){if(!this.BXIM.init&&this.isDesktop()){s.desktop.onCustomEvent("bxSaveColor",[{color:e,chatId:t}]);return false}if(typeof e!="string"){return false}else{e=e.toUpperCase()}if(typeof t!="undefined"){if(typeof this.BXIM.messenger.chat[t]=="undefined"){return false}}else{t=0;if(this.BXIM.userColor==e){return false}}s.ajax({url:this.BXIM.pathToAjax+"?SET_COLOR&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_SET_COLOR:"Y",COLOR:e,CHAT_ID:t,sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){if(e.ERROR==""){if(parseInt(e.CHAT_ID)==0){this.BXIM.userColor=e.COLOR;if(this.isPage()){setTimeout((function(){s.MessengerWindow.setUserInfo(s.MessengerCommon.getUserParam())}),500)}}}}),this)})};t.prototype.checkRestriction=function(e,s){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return false;var t=this.BXIM.messenger.chat[e].entity_type;if(typeof this.BXIM.messenger.userChatOptions[t]=="undefined"||typeof this.BXIM.messenger.userChatOptions[t][s]=="undefined")return false;if(!this.BXIM.messenger.userChatOptions[t][s])return true;return false};t.prototype.getEntityTypePath=function(e){if(!this.BXIM.messenger.chat[e])return null;if(!this.BXIM.messenger.chat[e].entity_type)return null;var t=this.BXIM.messenger.chat[e].entity_type;if(t=="CRM"&&this.BXIM.bitrixCrm){var r=this.BXIM.messenger.chat[e].entity_id.toString().split("|");if(!this.BXIM.path.crm[r[0]]){return null}return{PATH:this.BXIM.path.crm[r[0]].replace("#ID#",r[1]),TITLE:s.message("IM_M_OL_GOTO_CRM")}}else{if(typeof this.BXIM.messenger.userChatOptions[t]=="undefined")return null;if(!this.BXIM.messenger.userChatOptions[t]["PATH"])return null;return{PATH:this.BXIM.messenger.userChatOptions[t]["PATH"].replace("#ID#",this.BXIM.messenger.chat[e].entity_id),TITLE:this.BXIM.messenger.userChatOptions[t]["PATH_TITLE"]}}};t.prototype.renameChat=function(e,t){e=parseInt(e);if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"||!t||e<=0)return false;t=s.util.trim(t);if(t.length<=0||this.BXIM.messenger.chat[e].name==s.util.htmlspecialchars(t))return false;var r=this.BXIM.messenger.chat[e].name;this.BXIM.messenger.chat[e].name=s.util.htmlspecialchars(t);s.ajax({url:this.BXIM.pathToAjax+"?CHAT_RENAME&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_RENAME:"Y",CHAT_ID:e,CHAT_TITLE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(s){if(s.ERROR){if(this.BXIM.messenger.popupMessengerPanelChatTitle){this.BXIM.messenger.popupMessengerPanelChatTitle.innerHTML=r}this.BXIM.messenger.chat[e].name=r}}),this)});return true};t.prototype.userListRedraw=function(e){if(this.isMobile()){if(!this.MobileActionEqual("RECENT")){return false}}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.contactListSearchText!=null&&this.BXIM.messenger.contactListSearchText.length==0){this.recentListRedraw(e);if(this.BXIM.messenger.checkRecentNeedLoad&&this.BXIM.messenger.checkRecentNeedLoad()){this.BXIM.messenger.recentListLoadMore()}}else if(this.BXIM.messenger.chatList){this.chatListRedraw(e)}else{this.contactListRedraw(e)}};t.prototype.contactListRedraw=function(e){if(this.BXIM.messenger.popupMessenger==null)return false;e=e||{};if(!this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.contactList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.linesList=false;if(this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}}if(this.BXIM.messenger.contactListSearchText.length>0){if(s.MessengerProxy){s.MessengerProxy.sendOpenSearchEvent(this.BXIM.messenger.contactListSearchText)}}else{if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};t.prototype.contactListPrepareSearch=function(e,t,r,i){if(!t)return false;if(this.BXIM.messenger.openLinesFlag&&(e=="popupChatDialogContactListElements"&&this.BXIM.messenger.popupChatDialogDestType=="CHAT_EXTEND"||e=="popupTransferDialogContactListElements")){i.viewOffline=true;i.viewOnlyIntranet=true;i.viewChat=false;i.viewOfflineWithPhones=false}var a={listName:e,groupOpen:true,viewSelf:e=="contactList",viewOffline:true,viewGroup:true,viewChat:true,viewBot:true,viewTransferViQueue:false,viewTransferOlQueue:false,viewOpenChat:true,viewOfflineWithPhones:false,showUserLastActivityDate:undefined,extra:false,searchText:r,callback:{empty:function(){}}};if(i!=false){for(var n in i){if(n=="timeout"||n=="params")continue;a[n]=i[n]}}var o=i.timeout?i.timeout:0;if(o>0){clearTimeout(this.BXIM.messenger.redrawContactListTimeout[e]);this.BXIM.messenger.redrawContactListTimeout[e]=setTimeout(s.delegate((function(){t.innerHTML="";t.appendChild(this.contactListPrepare(a));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}),this),o)}else{t.innerHTML="";t.appendChild(this.contactListPrepare(a));if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}}};t.prototype.contactListPrepare=function(e){e=typeof e=="object"?e:{};return this.chatListPrepare(e)};t.prototype.contactListClickItem=function(e){this.BXIM.messenger.closeMenuPopup();var t=s.proxy_context.getAttribute("data-userId");if(t.toString().substr(0,9)=="structure"){var r=t.toString().substr(9);var i=this.BXIM.messenger.groups[r].name.split(" / ")[0];this.BXIM.messenger.popupContactListSearchInput.value=i;this.BXIM.messenger.contactListSearchText=t;this.contactListPrepareSearch("contactList",this.BXIM.messenger.popupContactListElementsWrap,this.BXIM.messenger.contactListSearchText,{});return s.PreventDefault(e)}if(this.BXIM.messenger.contactList){s.MessengerCommon.recentListElementToTop(s.proxy_context.getAttribute("data-userId"))}if(this.isMobile()||!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText="";s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.linesList=false;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad;this.userListRedraw()}if(this.isMobile()){this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"),s.proxy_context)}else{this.BXIM.messenger.openMessenger(s.proxy_context.getAttribute("data-userId"));if(this.BXIM.callController&&this.BXIM.callController.hasActiveCall()){this.BXIM.callController.fold()}}};t.prototype.contactListGetFromServer=function(t){if(this.BXIM.messenger.contactListLoad)return false;if(!s.type.isFunction(t))t=s.DoNothing;this.BXIM.messenger.contactListLoad=true;s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CONTACT_LIST:"Y",IM_AJAX_CALL:"Y",DESKTOP:this.isDesktop()?"Y":"N",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR==""){for(var i in r.USERS){r.USERS[i].last_activity_date=r.USERS[i].last_activity_date?new Date(r.USERS[i].last_activity_date):false;r.USERS[i].mobile_last_date=r.USERS[i].mobile_last_date?new Date(r.USERS[i].mobile_last_date):false;r.USERS[i].idle=r.USERS[i].idle?new Date(r.USERS[i].idle):false;r.USERS[i].absent=r.USERS[i].absent?new Date(r.USERS[i].absent):false;this.BXIM.messenger.users[i]=r.USERS[i]}for(var i in r.GROUPS)this.BXIM.messenger.groups[i]=r.GROUPS[i];for(var i in r.CHATS){if(this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].fake)r.CHATS[i].fake=true;else if(!this.BXIM.messenger.chat[i])r.CHATS[i].fake=true;r.CHATS[i].date_create=new Date(r.CHATS[i].date_create);this.BXIM.messenger.chat[i]=r.CHATS[i]}for(var i in r.PHONES){this.BXIM.messenger.phones[i]={};for(var a in r.PHONES[i]){this.BXIM.messenger.phones[i][a]=s.util.htmlspecialcharsback(r.PHONES[i][a])}}for(var i in r.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=r.USER_IN_GROUP[i]}else{for(var a=0;a<r.USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.userInGroup[i].users.push(r.USER_IN_GROUP[i].users[a]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}this.userListRedraw();if(!this.isMobile()){this.BXIM.messenger.dialogStatusRedraw();if(this.BXIM.messenger.popupChatDialogContactListElements!=null){this.contactListPrepareSearch("popupChatDialogContactListElements",this.BXIM.messenger.popupChatDialogContactListElements,this.BXIM.messenger.popupChatDialogContactListSearch.value,{viewOffline:true,viewChat:false,viewOpenChat:this.BXIM.messenger.popupChatDialogContactListElementsType=="MENTION"})}if(this.BXIM.webrtc.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.webrtc.popupTransferDialogContactListElements,this.BXIM.webrtc.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewOnlyIntranet:true,viewOfflineWithPhones:true})}if(this.BXIM.messenger.popupTransferDialogContactListElements!=null){this.contactListPrepareSearch("popupTransferDialogContactListElements",this.BXIM.messenger.popupTransferDialogContactListElements,this.BXIM.messenger.popupTransferDialogContactListSearch.value,{viewChat:false,viewOpenChat:false,viewOffline:false,viewBot:false,viewTransferOlQueue:true,viewOnlyIntranet:true,viewOfflineWithPhones:false})}}t()}else{this.BXIM.messenger.contactListLoad=false;if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate(this.contactListGetFromServer,this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate(this.contactListGetFromServer,this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.messenger.contactListLoad=false}),this)})};t.prototype.contactListRealSearch=function(e,t){if(!this.BXIM.messenger.realSearch)return false;this.contactListRealSearchText=e;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);this.BXIM.messenger.contactListSearchTimeout=setTimeout(s.delegate((function(){if(this.contactListRealSearchText.length<3){this.BXIM.messenger.realSearchFound=true;return false}s.ajax({url:this.BXIM.pathToAjax+"?CONTACT_LIST_SEARCH&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_CONTACT_LIST_SEARCH:"Y",SEARCH:this.contactListRealSearchText,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};for(var s in e.USERS){if(this.BXIM.messenger.users[s]){continue}e.USERS[s].last_activity_date=e.USERS[s].last_activity_date?new Date(e.USERS[s].last_activity_date):false;e.USERS[s].mobile_last_date=e.USERS[s].mobile_last_date?new Date(e.USERS[s].mobile_last_date):false;e.USERS[s].idle=e.USERS[s].idle?new Date(e.USERS[s].idle):false;e.USERS[s].absent=e.USERS[s].absent?new Date(e.USERS[s].absent):false;this.BXIM.messenger.users[s]=e.USERS[s];this.BXIM.messenger.userInGroup["search"]["users"].push(s);if(e.USERS[s].bot&&e.USERS[s].network){this.BXIM.messenger.bot[s]={type:"network"};this.BXIM.messenger.users[s].extranet=false}}if(typeof t!="undefined"){t()}else if(this.BXIM.messenger.contactList){this.contactListRedraw({FORCE:true})}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.realSearchFound=true}),this)})}),this),1500)};t.prototype.contactListSearchClear=function(e){if(!this.BXIM.messenger.popupContactListSearchInput)return;clearTimeout(this.BXIM.messenger.contactListSearchTimeout);clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad;this.BXIM.messenger.realSearchFound=true;if(s.MessengerProxy&&this.BXIM.newSearchEnabled){s.MessengerProxy.sendCloseSearchEvent();if(s.MessengerWindow&&s.MessengerWindow.currentTab==="im-ol"){this.BXIM.messenger.hideNewRecent()}}this.BXIM.messenger.popupContactListSearchInput.value="";this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5);s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.linesList=false;this.BXIM.messenger.contactList=false;this.BXIM.messenger.contactListShowed={};this.BXIM.messenger.userInGroup["search"]={id:"search",users:[]};this.userListRedraw()};t.prototype.contactListSearch=function(e){if(e.keyCode==16||e.keyCode==18||e.keyCode==20||e.keyCode==244||e.keyCode==91)return false;if(e.keyCode==37||e.keyCode==39)return true;if(this.BXIM.messenger.popupContactListSearchInput.value!=this.BXIM.messenger.contactListSearchLastText||this.BXIM.messenger.popupContactListSearchInput.value==""){}else if(e.keyCode==224||e.keyCode==18||e.keyCode==17){return true}if(e.keyCode==38||e.keyCode==40){return true}if(this.isMobile()){this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.linesList=false;this.BXIM.messenger.contactList=true;if(!app.enableInVersion(10)){setTimeout((function(){document.body.scrollTop=0}),100)}}else{if(e.keyCode==27){if(s.MessengerProxy&&this.BXIM.newSearchEnabled){s.MessengerProxy.sendCloseSearchEvent()}if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true}if(this.BXIM.messenger.contactListSearchText<=0&&!this.BXIM.messenger.chatList){this.BXIM.messenger.popupContactListSearchInput.value="";if(!this.isMobile()&&this.BXIM.messenger.popupMessenger&&!this.BXIM.messenger.desktop.ready()&&this.BXIM.callController&&!this.BXIM.callController.hasActiveCall()){this.BXIM.messenger.popupMessenger.destroy();return true}}else{this.contactListSearchClear();this.BXIM.messenger.popupMessengerTextarea.focus();return true}}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=false;this.BXIM.messenger.linesList=false;this.BXIM.messenger.contactList=true}if(s.MessengerProxy&&this.BXIM.newSearchEnabled&&e.keyCode===13){s.MessengerProxy.sendUpdateSearchEvent(this.BXIM.messenger.popupContactListSearchInput.value,e.keyCode);this.BXIM.messenger.showNewRecent()}if(this.BXIM.messenger.popupContactListSearchInput.value==this.BXIM.messenger.contactListSearchLastText){return true}this.BXIM.messenger.contactListSearchText=s.util.trim(this.BXIM.messenger.popupContactListSearchInput.value);this.BXIM.messenger.contactListSearchLastText=this.BXIM.messenger.contactListSearchText;if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=this.BXIM.messenger.contactListSearchText.length<3}if(!this.isMobile()){s.localStorage.set("mns",this.BXIM.messenger.contactListSearchText,5)}if(this.BXIM.messenger.contactListSearchText==""){if(this.BXIM.messenger.realSearch){this.BXIM.messenger.realSearchFound=true;this.BXIM.messenger.realSearch=!this.BXIM.options.contactListLoad}this.BXIM.messenger.chatList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.linesList=false;this.BXIM.messenger.contactList=false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}else{s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}if(!s.MessengerWindow||!s.MessengerProxy||!this.BXIM.newSearchEnabled||s.MessengerWindow.currentTab=="im-ol"){this.userListRedraw()}};t.prototype.handleInputEvent=function(e){if(s.MessengerProxy&&this.BXIM.newSearchEnabled){s.MessengerProxy.sendUpdateSearchEvent(this.BXIM.messenger.popupContactListSearchInput.value,e.keyCode);this.BXIM.messenger.showNewRecent()}};t.prototype.recentListRedraw=function(e){if(this.debug()){console.warn("---------------");console.time("recentList draw")}clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.MobileActionNotEqual("RECENT")){return false}if(this.BXIM.messenger.recentList&&this.BXIM.messenger.popupMessenger){if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false;this.BXIM.messenger.chatList=false;this.BXIM.messenger.contactList=false;this.BXIM.messenger.recentList=true;this.BXIM.messenger.linesList=this.isPage()&&s.MessengerWindow.currentTab=="im-ol"}if(this.BXIM.messenger.popupContactListActive){s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-normal");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active bx-messenger-box-contact-hover");this.BXIM.messenger.popupContactListActive=false;this.BXIM.messenger.popupContactListHovered=false;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation)}if(this.BXIM.messenger.contactListSearchText==null||this.BXIM.messenger.contactListSearchText.length>0){this.BXIM.messenger.contactListSearchText="";this.BXIM.messenger.popupContactListSearchInput.value=""}if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}if(this.debug()){console.time("recentList checkSum")}var t=null;if(this.isPage()&&s.MessengerWindow.currentTab=="im-ol"){s.addClass(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-recent-lines-wrap");s.addClass(this.BXIM.messenger.popupContactListElements,"bx-messenger-recent-lines-container");s.removeClass(this.BXIM.messenger.popupContactListElements,"bx-messenger-recent-container");t=this.linesListPrepare(e)}else if(this.isPage()&&s.MessengerWindow.currentTab=="im"){s.addClass(this.BXIM.messenger.popupContactListElements,"bx-messenger-recent-container");s.removeClass(this.BXIM.messenger.popupContactListElements,"bx-messenger-recent-lines-container");t=this.recentListPrepare(e)}if(this.debug()){console.timeEnd("recentList checkSum")}if(this.isPage()&&s.MessengerWindow.currentTab=="im-ol"){var r=this.getRecentListCheckSum(this.BXIM.messenger.popupContactListElementsWrap);var i=this.getRecentListCheckSum(t);if(s.browser.IsIE11()||i!=r){this.BXIM.messenger.popupContactListElementsWrap.innerHTML="";this.BXIM.messenger.popupContactListElementsWrap.appendChild(t)}this.BXIM.messenger.hideNewRecent();return}else{this.BXIM.messenger.showNewRecent()}if(this.debug()){console.log("recentList update","done")}}if(this.debug()){console.timeEnd("recentList draw")}};t.prototype.debug=function(e){if(typeof e==="undefined"){return s.localStorage.get("im-debug")==1}s.localStorage.set("im-debug",e?1:0,86400)};t.prototype.getRecentListCheckSum=function(e,t){t=(t||0)+1;var r="";var i=null;for(var a in e.children){if(!e.children.hasOwnProperty(a)){continue}i=e.children[a];if(t==1){r+=i.textContent}if(i.classList.contains("bx-messenger-cl-avatar-img")){r+=i.style.background}r+=i.className;r+=this.getRecentListCheckSum(i,t)}if(t==1){r=s.md5(r)}return r};t.prototype.recentListPrepare=function(e){e=typeof e=="object"?e:{};var t=document.createDocumentFragment();var r={pinned:{name:s.message("IM_RECENT_PINNED"),elements:[]},general:{name:"",elements:[]}};this.BXIM.messenger.recent.forEach(function(s){if(s.type==="chat"){if(s.lines&&this.isLinesOperator()){return true}}else if(e.showOnlyChat){return true}if(s.pinned){r.pinned.elements.push(s)}else{r.general.elements.push(s)}return true}.bind(this));r.pinned.elements.sort((function(e,s){return s.message.date.getTime()-e.message.date.getTime()}));r.general.elements.sort((function(e,s){return s.message.date.getTime()-e.message.date.getTime()}));var i=false;if(s.MessengerCalls){s.MessengerCalls.get().forEach((function(e){if(!i){i=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group bx-messenger-recent-group-calls"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},html:s.message("IM_RECENT_CALLS")})]}))}var r=s.MessengerCalls.drawElement(e);if(r){t.appendChild(r)}}))}["pinned","general"].forEach(function(e){if(r[e].elements.length<=0){return true}if(r[e].name){t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group bx-messenger-recent-group-"+e},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},text:r[e].name})]}))}var i={};r[e].elements.forEach(function(r){var a={};if(r.type==="user"){a=this.BXIM.messenger.users[r.id];if(!a||!a.active&&r.counter==0){return true}}else if(r.type==="chat"){a=this.BXIM.messenger.chat[r.id.substr(4)]}if(!a||typeof a.name=="undefined"){return true}if(e!=="pinned"){r.dateFormatted=this.formatDate(r.message.date,this.getDateFormatType("RECENT_TITLE"));if(!i[r.dateFormatted]){i[r.dateFormatted]=true;t.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},text:r.dateFormatted})]}))}}var n=this.drawContactListElement({id:r.id,data:a,lines:r.lines,counter:r.counter,invited:r.invited,message:r.message,pinned:r.pinned,unread:r.unread});if(n){t.appendChild(n)}}.bind(this))}.bind(this));if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}))}else if(this.BXIM.messenger.recentLoadMore){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},children:[s.create("div",{props:{className:"bx-messenger-content-item-progress"}}),s.create("span",{props:{className:"bx-messenger-cl-item-load-text"},text:s.message("IM_CL_LOAD")})]}))}return t};t.prototype.linesListPrepare=function(){var e=document.createDocumentFragment();var t={new:{name:s.message("IM_OL_SECTION_NEW"),elements:[]},work:{name:s.message("IM_OL_SECTION_WORK"),elements:[]},answered:{name:s.message("IM_OL_SECTION_ANSWERED"),elements:[]}};this.BXIM.messenger.recent.filter((function(e){return e.lines})).forEach((function(e){if(e.lines.status<10){t.new.elements.push(e)}else if(e.lines.status<40){t.work.elements.push(e)}else{t.answered.elements.push(e)}}));t.new.elements.sort((function(e,s){return e.lines.id-s.lines.id}));t.work.elements.sort((function(e,s){return e.lines.id-s.lines.id}));t.answered.elements.sort((function(e,s){return s.message.date-e.message.date}));["new","work","answered"].forEach(function(r){if(t[r].elements.length<=0){return true}e.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title bx-messenger-recent-category-title bx-messenger-recent-category-title-"+r},text:t[r].name})]}));var i={};t[r].elements.forEach(function(t){var a=this.BXIM.messenger.chat[t.id.substr(4)];if(!a||typeof a.name=="undefined"){return true}var n=r==="answered"?t.message.date:t.lines.date_create;if(!n){console.error("Date create is not found",t)}t.dateFormatted=this.formatDate(n,this.getDateFormatType("RECENT_TITLE"));if(!i[t.dateFormatted]){i[t.dateFormatted]=true;e.appendChild(s.create("div",{props:{className:"bx-messenger-recent-group"},children:[s.create("span",{props:{className:"bx-messenger-recent-group-title"},text:t.dateFormatted})]}))}var o=this.drawContactListElement({id:t.id,data:a,lines:t.lines,counter:t.counter,invited:t.invited,message:t.message,pinned:t.pinned});if(o){e.appendChild(o)}}.bind(this))}.bind(this));if(this.BXIM.messenger.linesListLoad&&e.childNodes.length<=0){e.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_EMPTY_OL_TEXT_2")}))}else if(!this.BXIM.messenger.linesListLoad){e.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},children:[s.create("div",{props:{className:"bx-messenger-content-item-progress"}}),s.create("span",{props:{className:"bx-messenger-cl-item-load-text"},text:s.message("IM_CL_LOAD")})]}))}return e};t.prototype.recentListGetItem=function(e){return this.BXIM.messenger.recent.find((function(s){return s.id==e}))};t.prototype.recentListAddItem=function(e){if(this.isMobile()||!e.id){return false}var t=this.BXIM.messenger.recent.find((function(s){return s.id==e.id}));if(t){if(!e.date_update){e.date_update=new Date}s.util.objectMerge(t,e)}else{if(!e.title){var r=this.getUserParam(e.id);if(r){e.title=r.name}}var i={id:0,chat_id:0,counter:0,date_update:new Date,message:{id:0,text:undefined,date:new Date,author_id:0,status:"delivered",attach:false,file:false},options:[],pinned:false,invited:false,title:"",type:e.id.toString().substr(0,4)==="chat"?"chat":"user",unread:false};if(typeof e.chat_id==="undefined"&&e.id.toString().startsWith("chat")){e.chat_id=parseInt(e.id.toString().substr(4))}this.BXIM.messenger.recent.unshift(s.util.objectMerge(i,e))}return true};t.prototype.recentListUpdateItem=function(e){if(this.isMobile()||!e.id){return false}var t=this.BXIM.messenger.recent.find((function(s){return s.id==e.id}));if(t){if(!e.date_update){e.date_update=new Date}s.util.objectMerge(t,e)}};t.prototype.inRecentList=function(e){if(!e){return false}return!!this.BXIM.messenger.recent.find((function(s){return s.id==e}))};t.prototype.recentListHide=function(e,t){if(!e)return false;this.BXIM.messenger.recent=this.BXIM.messenger.recent.filter((function(s){return s.id!=e}));if(this.BXIM.messenger.recentList){this.recentListRedraw()}if(!this.isMobile()){s.localStorage.set("mrlr",e,5)}if(this.BXIM.messenger.birthdayRecent[e]){s.localStorage.set("mbdh-"+e,true,86400);delete this.BXIM.messenger.birthdayRecent[e]}t=t!=false;if(t){if(s.MessengerProxy){s.MessengerProxy.sendHideChatEvent(e)}s.ajax({url:this.BXIM.pathToAjax+"?RECENT_HIDE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_RECENT_HIDE:"Y",DIALOG_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}})}this.readMessage(e,t,false);if(e.toString().substr(0,4)=="chat"){if(this.isMobile()){app.onCustomEvent("onPullClearWatch",{id:"IM_PUBLIC_"+e.substr(4)})}else{s.PULL.clearWatch("IM_PUBLIC_"+e.substr(4))}}delete this.BXIM.messenger.showMessage[e];delete this.BXIM.messenger.history[e];if(this.BXIM.messenger.currentTab==e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.extraOpen(s.create("div",{attrs:{style:"padding-top: 300px"},props:{className:"bx-messenger-box-empty"},html:s.message("IM_M_EMPTY")}))}};t.prototype.recentListElementUpdate=function(e,s,t){var r=this.BXIM.messenger.recent.find((function(s){return s.id==e}));if(!r){return false}if(r.message.id!=s){return false}r.message.text=t;return true};t.prototype.recentListElementToTop=function(e){var t=this.BXIM.messenger.recent.find((function(s){return s.id==e}));if(t){t.message.date=new Date}else{var r=this.getUserParam(e);if(!r){return false}this.recentListAddItem({id:e,title:r.name})}if(this.BXIM.messenger.recentList||s.MessengerExternalList&&s.MessengerExternalList.isAvailable()){this.recentListRedraw()}if(!this.isMobile()){s.localStorage.set("mrlr",e,5)}};t.prototype.recentListElementPin=function(e,s){var t=this.BXIM.messenger.recent.find((function(s){return s.id==e}));if(!t){return true}if(t.pinned==s){return true}t.pinned=!!s;this.recentListRedraw();return true};t.prototype.recentListElementStatusChange=function(e,s){var t=this.BXIM.messenger.recent.find((function(s){return s.id==e}));if(!t||!t.message){return true}if(t.message.status==s){return true}t.message.status=s;this.recentListRedraw();return true};t.prototype.recentListElementStatusError=function(e,s){var t=this.BXIM.messenger.recent.find((function(s){return s.id==e}));if(!t||!t.message){return true}if(t.message.status=="error"){return true}if(t.message.id!=s){return true}t.message.status="error";this.recentListRedraw();return true};t.prototype.recentListElementFormat=function(e){e.date_update=new Date(e.date_update);if(typeof e.lines!=="undefined"){e.lines.date_create=new Date(e.lines.date_create)}if(typeof e.message!=="undefined"){e.message.text=s.util.htmlspecialchars(e.message.text);e.message.date=new Date(e.message.date)}if(typeof e.user!=="undefined"){if(e.user.id>0){e.user.name=s.util.htmlspecialchars(e.user.name);e.user.first_name=s.util.htmlspecialchars(e.user.first_name);e.user.last_name=s.util.htmlspecialchars(e.user.last_name);e.user.work_position=s.util.htmlspecialchars(e.user.work_position);e.user.external_auth_id=s.util.htmlspecialchars(e.user.external_auth_id);e.user.status=s.util.htmlspecialchars(e.user.status);e.user.absent=e.user.absent?new Date(e.user.absent):false;e.user.idle=e.user.idle?new Date(e.user.idle):false;e.user.last_activity_date=e.user.last_activity_date?new Date(e.user.last_activity_date):false;e.user.mobile_last_date=e.user.mobile_last_date?new Date(e.user.mobile_last_date):false;e.user.profile=this.BXIM.path.profileTemplate.replace("#user_id#",e.user.id);this.BXIM.messenger.users[e.user.id]=e.user}delete e.user}if(typeof e.chat!=="undefined"){if(e.chat.id>0){e.chat.name=s.util.htmlspecialchars(e.chat.name);e.chat.entity_data_1=s.util.htmlspecialchars(e.chat.entity_data_1);e.chat.entity_data_2=s.util.htmlspecialchars(e.chat.entity_data_2);e.chat.entity_data_3=s.util.htmlspecialchars(e.chat.entity_data_3);e.chat.entity_id=s.util.htmlspecialchars(e.chat.entity_id);e.chat.entity_type=s.util.htmlspecialchars(e.chat.entity_type);e.chat.date_create=new Date(e.chat.date_create);this.BXIM.messenger.chat[e.chat.id]=e.chat}delete e.chat}delete e.avatar;return e};t.prototype.recentListApply=function(e,s){this.BXIM.messenger.recentLoadMore=!!e.hasMore;this.BXIM.messenger.recentLastMessageUpdateDate=e.items.length>0?e.items.slice(-1)[0].message.date:"";this.BXIM.messenger.recent=e.items.filter(function(e){if(e.id==="notify"){return false}e=this.recentListElementFormat(e);return true}.bind(this));if(s){this.recentListCounterApply(s)}this.recentListBirthdayApply();this.BXIM.messenger.updateMessageCount()};t.prototype.recentListUpdate=function(e,s,t){t=t||"update";var r=false;if(e.length>0){var i={};e.forEach(function(e){this.BXIM.messenger.redrawTab[e.id]=true;if(this.BXIM.messenger.showMessage[e.id]&&this.BXIM.messenger.showMessage[e.id].length>30){this.BXIM.messenger.showMessage[e.id]=this.BXIM.messenger.showMessage[e.id].slice(-30)}e=this.recentListElementFormat(e);i[e.id]=e.date_update}.bind(this));this.BXIM.messenger.recent=this.BXIM.messenger.recent.filter(function(e){if(typeof i[e.id]!=="undefined"&&i[e.id]>e.date_update&&this.BXIM.messenger.currentTab==e.id){r=true}return typeof i[e.id]==="undefined"}.bind(this)).concat(e)}if(s){this.recentListCounterApply(s)}this.recentListBirthdayApply();if(this.BXIM.dialogOpen&&r){if(t==="close"){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}else if(!this.BXIM.callController||!this.BXIM.callController.hasActiveCall()){this.BXIM.messenger.openMessenger()}}this.BXIM.messenger.updateMessageCount()};t.prototype.recentListCounterApply=function(e){this.BXIM.dialogDetailCounter=e.dialog;if(e.dialogUnread){e.dialogUnread.forEach(function(e){this.BXIM.dialogDetailCounter[e]=1}.bind(this))}if(e.chatUnread){e.chatUnread.forEach(function(e){this.BXIM.dialogDetailCounter["chat"+e]=1}.bind(this))}for(var s in e.chat){if(e.chat.hasOwnProperty(s)){this.BXIM.dialogDetailCounter["chat"+s]=e.chat[s]}}for(var s in e.lines){if(e.lines.hasOwnProperty(s)){this.BXIM.linesDetailCounter["chat"+s]=e.lines[s]}}this.BXIM.messenger.recent.forEach(function(e){if(e.lines){if(typeof this.BXIM.linesDetailCounter[e.id]!=="undefined"){if(e.counter!=this.BXIM.linesDetailCounter[e.id]){e.counter=this.BXIM.linesDetailCounter[e.id]}delete this.BXIM.linesDetailCounter[e.id]}}else{if(typeof this.BXIM.dialogDetailCounter[e.id]!=="undefined"){if(e.counter!=this.BXIM.dialogDetailCounter[e.id]){e.counter=this.BXIM.dialogDetailCounter[e.id]}delete this.BXIM.dialogDetailCounter[e.id]}}}.bind(this));this.BXIM.mailCount=e.type.mail;this.BXIM.notifyCount=e.type.notify;this.BXIM.messageCount=e.type.dialog+e.type.chat;this.BXIM.linesCount=e.type.lines};t.prototype.recentListBirthdayApply=function(){if(this.BXIM.messenger.birthdayEnable==="none"){return false}if(!this.BXIM.settings.viewBirthday){for(var e in this.BXIM.messenger.birthdayRecent){if(!this.BXIM.messenger.birthdayRecent.hasOwnProperty(e)){continue}var t=this.BXIM.messenger.birthdayRecent[e];if(t==="new"){this.BXIM.messenger.recent=this.BXIM.messenger.recent.filter((function(s){return s.id!=e}))}else if(t!="skip"){var r=this.BXIM.messenger.recent.find((function(s){return s.id==e&&s.message.id==="birthday"+e}));if(r){r.message=this.BXIM.messenger.birthdayRecent[e]}}if(typeof this.BXIM.messenger.showMessage[e]!=="undefined"){this.BXIM.messenger.showMessage[e]=this.BXIM.messenger.showMessage[e].filter((function(e){return!e.toString().startsWith("birthday")}))}delete this.BXIM.messenger.birthdayRecent[e]}return true}if(typeof this.BXIM.messenger.showMessage[e]!=="undefined"){this.BXIM.messenger.showMessage[e]=this.BXIM.messenger.showMessage[e].filter((function(e){return!e.toString().startsWith("birthday")}))}var i=s.Main.Date.format("d-m");var a=[];var n={};for(var e in this.BXIM.messenger.users){if(!this.BXIM.messenger.users.hasOwnProperty(e)){continue}if(e==this.BXIM.userId){continue}if(this.BXIM.messenger.birthdayEnable==="all"){if(this.BXIM.messenger.users[e].birthday===i){a.push(e);n[e]=true}else if(this.BXIM.messenger.birthdayUsers[e]){a.push(e);n[e]=true}}else if(this.BXIM.messenger.birthdayUsers[e]){a.push(e);n[e]=true}}a.forEach(function(e){var t=s.MessengerCommon.getNowDate(true);var r="birthday"+e;this.BXIM.messenger.message[r]={id:r,senderId:0,recipientId:e,date:t,text:s.message("IM_M_BIRTHDAY_MESSAGE").replace("#USER_NAME#",'<span class="bx-messenger-birthday-icon"></span><strong>'+this.BXIM.messenger.users[e].name+"</strong>"),textOriginal:s.message("IM_M_BIRTHDAY_MESSAGE").replace("#USER_NAME#",this.BXIM.messenger.users[e].name)};if(!this.BXIM.messenger.showMessage[e]){this.BXIM.messenger.showMessage[e]=[r]}else{var i=this.BXIM.messenger.showMessage[e].find((function(e){return e==r}));if(!i){this.BXIM.messenger.showMessage[e].push(r);this.BXIM.messenger.showMessage[e].sort(function(e,s){return this.BXIM.messenger.message[s].date.getTime()-this.BXIM.messenger.message[e].date.getTime()}.bind(this))}}var i=this.BXIM.messenger.recent.find((function(s){return s.id==e}));if(i){if(i.message.date.getTime()<t.getTime()){this.BXIM.messenger.birthdayRecent[e]=i.message;i.message={id:r,date:t,author_id:i.id,status:"delivered",text:s.message("IM_M_BIRTHDAY_MESSAGE_SHORT"),attach:false,file:false}}else if(i.message.date.getTime()!=t.getTime()){this.BXIM.messenger.birthdayRecent[e]="skip"}}else if(!s.localStorage.get("mbdh-"+e,true,86400)){this.BXIM.messenger.birthdayRecent[e]="new";s.MessengerCommon.recentListAddItem({id:e,message:{id:r,date:t,text:s.message("IM_M_BIRTHDAY_MESSAGE_SHORT")}})}}.bind(this));return true};t.prototype.recentListGetSortIndex=function(){var e={};var s=0;this.BXIM.messenger.recent.sort((function(e,s){return s.message.date.getTime()-e.message.date.getTime()}));for(var t=0;t<this.BXIM.messenger.recent.length;t++){s=this.BXIM.messenger.recent.length-t;e[this.BXIM.messenger.recent[t].id]=s}return e};t.prototype.getCounter=function(e){var s=this.recentListGetItem(e);return s?s.counter:0};t.prototype.getVideoconfLink=function(e){if(!e||!this.BXIM.messenger.chat[e.substr(4)]||!this.BXIM.messenger.chat[e.substr(4)].public){return null}return this.BXIM.messenger.chat[e.substr(4)].public.link};t.prototype.getVideoconfLinkByCode=function(e){if(!e){return null}return location.origin.replace("http://","https://")+"/video/"+e};t.prototype.drawContactListElement=function(e){if(!e||!e.id)return null;e.userIsChat=e.id.toString().substr(0,4)=="chat";e.userIsQueue=e.id.toString().substr(0,5)=="queue";e.userIsStructure=e.id.toString().substr(0,9)=="structure";e.extraClass=e.extraClass||"";e.showUserLastActivityDate=typeof e.showUserLastActivityDate==="boolean"?e.showUserLastActivityDate:!this.BXIM.messenger.recentList;e.showLastMessage=e.showLastMessage===false?false:true;e.showCounter=e.showCounter===false?false:true;e.data=e.data?e.data:{};e.counter=e.counter?e.counter:0;e.unread=e.unread||false;e.message=e.message||null;if(!e.userIsChat&&this.BXIM.userId==e.data.id&&e.data.extranet){return null}var t="";var r="";var i="";var a="";if(e.showCounter){if(e.counter){r="bx-messenger-cl-status-new-message";i='<span class="bx-messenger-cl-count-digit">'+(e.counter<100?e.counter:"99+")+"</span>"}else if(e.unread){r="bx-messenger-cl-status-new-message";i='<span class="bx-messenger-cl-count-digit"></span>'}if(this.countWriting(e.id)){a="bx-messenger-cl-status-writing"}if(e.userIsChat&&this.BXIM.messenger.chat[e.id.substr(4)]&&this.BXIM.messenger.chat[e.id.substr(4)].mute_list&&this.BXIM.messenger.chat[e.id.substr(4)].mute_list[this.BXIM.userId]){r+=" bx-messenger-cl-status-muted"}}var n="";var o=this.BXIM.messenger.users[this.BXIM.userId].color;if(!(e.userIsQueue||e.userIsStructure)){n=e.data.avatar;o=e.data.color}if(!n){n=this.BXIM.pathToBlankImage}var l="";var m=false;var h=false;var g=!e.userIsChat&&e.invited&&!e.data.last_activity_date;if(this.BXIM.settings.viewLastMessage&&e.showLastMessage&&e.id){if(e.message){if(g&&!e.message.id){l='<span class="bx-messenger-cl-user-invited">'+s.message("IM_USER_INVITED")+"</span>";h=true}else if(e.message.id!=0){l=this.purifyText(e.message.text,{WITH_ATTACH:e.message.attach,WITH_FILE:e.message.file})}}if(l&&e.message&&e.message.author_id&&e.id!=this.BXIM.userId){if(e.message.author_id==this.BXIM.userId){l='<span class="bx-messenger-cl-user-reply"></span>'+l}else if(e.userIsChat&&this.BXIM.messenger.users[e.message.author_id]&&!this.BXIM.messenger.users[e.message.author_id].connector){var p=this.BXIM.messenger.users[e.message.author_id];var c="";var d="";if(this.isBlankAvatar(p.avatar)){c="bx-messenger-cl-user-reply-avatar-default"}else{d="background-image: url('"+p.avatar+"')"}l='<span class="bx-messenger-cl-user-reply-avatar '+c+'" title="'+p.name+'" style="'+d+'"></span>'+l}}}if(!l){if(e.userIsChat){if(e.data.type=="call"){l=s.message("IM_CL_PHONE")}else if(e.data.type=="lines"){l=s.message("IM_CL_LINES")}else if(e.data.type=="open"){l=s.message("IM_CL_OPEN_CHAT_NEW")}else{l=s.message("IM_CL_CHAT_NEW")}}else if(e.userIsQueue){if(e.data.type=="olQueue"){l=s.message("IM_CL_OL_QUEUE")}else if(e.data.type=="viQueue"){l=s.message("IM_CL_VI_QUEUE")}}else if(e.userIsStructure){l=s.message("IM_CL_STRUCTURE")}else{l=this.getUserPosition(this.BXIM.messenger.users[e.id],e.showUserLastActivityDate)}}if(e.userIsChat){if(e.data.type=="lines"){var I=this.linesGetSession(this.BXIM.messenger.chat[e.id.substr(4)]);m=I.crm=="Y";t+=" bx-messenger-cl-avatar-"+this.linesGetSource(this.BXIM.messenger.chat[e.id.substr(4)])}else if(e.data.entity_type=="CRM"){m=true;t+=" bx-messenger-cl-avatar-type-crm"}else{t=" bx-messenger-cl-item-chat-"+e.data.type}}else if(e.userIsQueue){if(e.data.type=="olQueue"){t=" bx-messenger-cl-avatar-lines"}else if(e.data.type=="viQueue"){t=" bx-messenger-cl-avatar-call"}}else if(e.userIsStructure){t=" bx-messenger-cl-avatar-structure"}var u=!g&&this.isBlankAvatar(n)?o:"";var M=e.userIsChat&&u?"bx-messenger-cl-avatar-status-hide":"";var f=e.data.name;if(!e.userIsChat&&!e.userIsQueue&&!e.userIsStructure&&this.BXIM.userId==e.data.id){f=f+" (<b><i>"+s.message("IM_YOU")+"</i></b>)"}var B="";var X="bx-messenger-cl-item  bx-messenger-cl-id-"+(e.userIsChat?"chat":"")+(e.userIsQueue?"queue":"")+e.data.id;if(e.userIsChat){B="bx-messenger-cl-avatar-"+e.data.type+" "+(this.BXIM.messenger.generalChatId==e.data.id?" bx-messenger-cl-item-chat-general":"");X+=" bx-messenger-cl-item-chat "+r+" "+a+" "+t+" "+(this.BXIM.messenger.generalChatId==e.data.id?"bx-messenger-cl-item-chat-general":"")}else if(e.userIsQueue){X+=t}else if(e.userIsStructure){X+=t}else if(g){X+=" bx-messenger-cl-item-user-invited";if(h){X+=" bx-messenger-cl-item-user-invited-text"}}else{X+=" bx-messenger-cl-avatar-user bx-messenger-cl-status-"+this.getUserStatus(this.BXIM.messenger.users[e.data.id])+" "+r+" "+a}X+=" "+e.extraClass;if(!i&&e.message&&e.message.status&&e.message.author_id==this.BXIM.userId&&e.id!=this.BXIM.userId){X+=" bx-messenger-cl-item-message-status-"+e.message.status}if(!i&&e.pinned){X+=" bx-messenger-cl-item-pinned"}var b="";if(e.userIsChat){if(e.data.type=="lines"&&e.lines){b=e.lines.status}else{b=e.data.type}}else{b=this.getUserStatus(this.BXIM.messenger.users[e.data.id])}var d="";if(s.MessengerCommon.isBlankAvatar(n)){d='style="background-color: '+u+'"'}else{d="style=\"background: url('"+n+"'); background-size: cover;\""}return s.create("span",{props:{className:X},attrs:{"data-userId":e.id,"data-name":s.util.htmlspecialcharsback(e.data.name),"data-status":b,"data-avatar":n,"data-userIsChat":e.userIsChat,"data-isPinned":e.pinned,"data-userIsQueue":e.userIsQueue},html:'<span class="bx-messenger-cl-count">'+i+"</span>"+'<span title="'+e.data.name+'" class="bx-messenger-cl-avatar '+B+" "+M+'">'+'<span class="bx-messenger-cl-avatar-img'+(this.isBlankAvatar(n)?" bx-messenger-cl-avatar-img-default":"")+'" '+d+"></span>"+(m?'<span class="bx-messenger-cl-crm"></span>':"")+(!e.userIsQueue&&!e.userIsStructure?'<span class="bx-messenger-cl-status"></span>':"")+"</span>"+'<span class="bx-messenger-cl-user">'+'<div class="bx-messenger-cl-user-title'+(e.data.extranet&&e.data.type!="lines"?" bx-messenger-user-extranet":"")+'" title="'+e.data.name+'">'+f+"</div>"+'<div class="bx-messenger-cl-user-desc">'+l+"</div>"+"</span>"})};t.prototype.chatListRedraw=function(e){if(this.MobileActionNotEqual("RECENT")||this.BXIM.messenger.popupMessenger==null)return false;s.addClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-active");s.removeClass(this.BXIM.messenger.popupContactListWrap,"bx-messenger-box-contact-hover bx-messenger-box-contact-normal");this.BXIM.messenger.popupContactListActive=true;this.BXIM.messenger.popupContactListHovered=true;clearTimeout(this.BXIM.messenger.popupContactListWrapAnimation);if(!this.isMobile()){if(this.BXIM.messenger.popupMessenger==null)return false}this.BXIM.messenger.chatList=true;this.BXIM.messenger.recentList=false;this.BXIM.messenger.linesList=false;this.BXIM.messenger.contactList=false;clearTimeout(this.BXIM.messenger.redrawChatListTimeout);clearTimeout(this.BXIM.messenger.redrawRecentListTimeout);if(this.BXIM.messenger.redrawContactListTimeout["contactList"])clearTimeout(this.BXIM.messenger.redrawContactListTimeout["contactList"]);if(!this.isMobile()&&this.BXIM.messenger.popupPopupMenu!=null&&this.BXIM.messenger.popupPopupMenu.uniquePopupId.replace("bx-messenger-popup-","")=="contactList"){this.BXIM.messenger.popupPopupMenu.close()}this.BXIM.messenger.showNewRecent();if(s.MessengerProxy){s.MessengerProxy.sendOpenSearchEvent(this.BXIM.messenger.contactListSearchText)}if(this.isMobile()){BitrixMobile.LazyLoad.showImages()}};t.prototype.chatListPrepare=function(e){var t=document.createDocumentFragment();var r={};e=typeof e=="object"?e:{};var i=typeof e.listName!="undefined"?e.listName:"contactList";var a=typeof e.searchText!="undefined"?e.searchText:this.BXIM.messenger.contactListSearchText;var n=!(a!=null&&a.length==0);var o=n&&a.substr(0,9)=="structure"?a.substr(9):0;var l=this.BXIM.messenger.realSearch&&!this.BXIM.messenger.realSearchFound;var m=typeof e.viewOnlyIntranet!="undefined"?e.viewOnlyIntranet:false;var h=typeof e.extra!="undefined"?e.extra:true;var g=typeof e.viewOffline!="undefined"?e.viewOffline:n;var p=typeof e.viewOfflineWithPhones!="undefined"?e.viewOfflineWithPhones:false;var c=typeof e.viewChat!="undefined"?e.viewChat:true;var d=typeof e.viewOpenChat!="undefined"?e.viewOpenChat:true;var I=typeof e.viewSelf!="undefined"?e.viewSelf:true;var u=typeof e.viewTransferViQueue!="undefined"?e.viewTransferViQueue:false;var M=typeof e.viewTransferOlQueue!="undefined"?e.viewTransferOlQueue:false;var f=typeof e.viewBot!="undefined"?e.viewBot:true;var B=typeof e.callback!="undefined"?e.callback:{};var X=n&&a.length>=3&&this.BXIM.messenger.realSearchAvailable&&!this.BXIM.messenger.realSearch&&!m;var b=i=="contactList"||i=="popupChatDialogContactListElements"&&(this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_ADD"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_EXTEND"||this.BXIM.messenger.popupChatDialogContactListElementsType=="CHAT_CREATE"&&this.BXIM.messenger.chatCreateType!="private");var E=i=="contactList";var C=typeof e.showUserLastActivityDate==="boolean"?e.showUserLastActivityDate:!this.BXIM.messenger.recentList;if(typeof B.empty!="function"){B.empty=function(){}}if(!this.BXIM.messenger.contactListLoad){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-load"},children:[s.create("div",{props:{className:"bx-messenger-content-item-progress"}}),s.create("span",{props:{className:"bx-messenger-cl-item-load-text"},text:s.message("IM_CL_LOAD")})]}));this.contactListGetFromServer();return t}if(this.isMobile()){BitrixMobile.LazyLoad.clearImages()}var _=this.BXIM.messenger.popupContactListElementsSize;var S=46;var T=29;var v=26;var y=0;var A=n?5:3;var L=[];if(M){L.push({id:"olQueue",name:s.message("IM_CTL_CHAT_OL_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}else if(u){L.push({id:"viQueue",name:s.message("IM_CTL_CHAT_VI_QUEUE"),title:"",more:s.message("IM_CL_MORE_QUEUE")})}var x=this.BXIM.messenger.users;if(n&&o){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE_NEW"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_PRIVATE_NEW")});x={};if(this.BXIM.messenger.userInGroup[o]){for(var N=0;N<this.BXIM.messenger.userInGroup[o].users.length;N++){x[this.BXIM.messenger.userInGroup[o].users[N]]=this.BXIM.messenger.users[this.BXIM.messenger.userInGroup[o].users[N]]}}}else if(n){L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE_NEW"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_PRIVATE_NEW")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN_NEW"),title:s.message("IM_CL_CREATE_OPEN_NEW"),more:s.message("IM_CL_MORE_OPEN_NEW"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT_NEW"),title:s.message("IM_CL_CREATE_CHAT_NEW"),more:s.message("IM_CL_MORE_CHAT_NEW")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_EXTRANET_NEW")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CL_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!b});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET_NEW")})}else{L.push({id:"open",name:s.message("IM_CTL_CHAT_OPEN_NEW"),title:s.message("IM_CL_CREATE_OPEN_NEW"),more:s.message("IM_CL_MORE_OPEN_NEW"),skip:!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet});L.push({id:"chat",name:s.message("IM_CTL_CHAT_CHAT_NEW"),title:s.message("IM_CL_CREATE_CHAT_NEW"),more:s.message("IM_CL_MORE_CHAT_NEW")});L.push({id:"lines",name:s.message("IM_CTL_CHAT_LINES"),title:"",more:s.message("IM_CL_MORE_LINES")});L.push({id:"call",name:s.message("IM_CTL_CHAT_CALL"),title:"",more:s.message("IM_CL_MORE_CALL"),skip:!this.BXIM.webrtc.phoneEnabled});L.push({id:"private",name:s.message("IM_CTL_CHAT_PRIVATE_NEW"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_PRIVATE_NEW")});L.push({id:"bot",name:s.message("IM_CTL_CHAT_BOT"),title:"",more:s.message("IM_CL_MORE_BOT")});L.push({id:"ol",name:s.message("IM_CTL_CHAT_OL"),title:"",more:s.message("IM_CTL_CHAT_OL"),skip:this.BXIM.userExtranet});L.push({id:"extranet",name:s.message("IM_CTL_CHAT_EXTRANET"),title:s.message("IM_CL_CREATE_PRIVATE_NEW"),more:s.message("IM_CL_MORE_EXTRANET_NEW")});L.push({id:"structure",name:this.BXIM.bitrixIntranet?s.message("IM_CTL_CHAT_STRUCTURE"):s.message("IM_CTL_CHAT_GROUP"),title:"",more:this.BXIM.bitrixIntranet?s.message("IM_CL_MORE_STRUCTURE"):s.message("IM_CL_MORE_GROUP"),skip:!b});L.push({id:"blocked",name:s.message("IM_CTL_CHAT_BLOCKED"),title:"",more:s.message("IM_CL_MORE_EXTRANET_NEW")})}for(var N=0;N<L.length;N++){if(L[N].skip)continue;y++}var R=_-T*y;var w=parseInt(R/S);var D=Math.max(parseInt(R/y/S),A);var O=0;var k=0;for(var N=0;N<L.length;N++){L[N].countElement=0;if(L[N].skip)continue;L[N].countElement=D}var P=[];if(n){a=a+"";if(!this.isMobile()&&this.BXIM.language=="ru"&&s.correctText){var U=s.correctText(a);if(U!=a){a=a+" "+U}}P=a.split(" ")}var H=this.recentListGetSortIndex();var G={};var F=[];for(var N=0;N<L.length;N++){G[N]=[];if(L[N].id=="private"||L[N].id=="extranet"||L[N].id=="blocked"||L[N].id=="bot"||L[N].id=="ol"){if(!f&&L[N].id=="bot")L[N].skip=true;if(m&&L[N].id=="extranet")L[N].skip=true;if(!c&&L[N].id=="ol")L[N].skip=true;if(L[N].skip)continue;for(var V in x){if(!x.hasOwnProperty(V))continue;if(!I&&V==this.BXIM.userId)continue;if(this.BXIM.messenger.users[V].external_auth_id==="imconnector"||this.BXIM.messenger.users[V].external_auth_id==="call"){continue}if(typeof this.BXIM.messenger.users[V].active!="undefined"&&!this.BXIM.messenger.users[V].active)continue;if(!g){var W=this.getUserStatus(this.BXIM.messenger.users[V]);if(p&&this.userHasPhone(V)){}else if(W=="offline"){continue}}var j=this.BXIM.messenger.userChat[V];if(L[N].id=="blocked"){if(!this.BXIM.messenger.userChatBlockStatus[j]||!this.BXIM.messenger.userChatBlockStatus[j][this.BXIM.userId]){continue}}else{if(this.BXIM.messenger.userChatBlockStatus[j]&&this.BXIM.messenger.userChatBlockStatus[j][this.BXIM.userId]){continue}}if(L[N].id=="extranet"){if(!this.BXIM.messenger.users[V].extranet)continue}else{if(this.BXIM.messenger.users[V].extranet)continue}if(L[N].id=="ol"){if(!this.BXIM.messenger.users[V].bot){continue}if(this.BXIM.bitrix24&&this.BXIM.messenger.bot[V]&&this.BXIM.messenger.bot[V].code=="network_cloud"){continue}if(!this.BXIM.messenger.bot[V]||this.BXIM.messenger.bot[V].type!="network"&&this.BXIM.messenger.bot[V].type!="support24"){continue}}else if(L[N].id=="bot"){if(!this.BXIM.messenger.users[V].bot||!this.BXIM.messenger.bot[V])continue;if(this.BXIM.messenger.bot[V]&&this.BXIM.messenger.bot[V].type=="network")continue;if(this.BXIM.messenger.popupChatDialogDestType=="CALL_INVITE_USER"){continue}if(this.BXIM.messenger.openChatFlag){var Y=this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)];if(Y&&Y.entity_type!="LINES"&&this.BXIM.messenger.bot[V].type=="openline"){continue}else if(Y&&Y.entity_type=="LINES"&&!this.BXIM.messenger.bot[V].openline){continue}else if(this.BXIM.messenger.bot[V].type=="network"||this.BXIM.messenger.bot[V].type=="support24"){continue}}else{if(this.BXIM.messenger.bot[V].type=="network"||this.BXIM.messenger.bot[V].type=="support24"||this.BXIM.messenger.bot[V].type=="openline"){continue}}}else{if(this.BXIM.messenger.users[V].bot)continue}if(n&&o){}else if(n){var K=this.BXIM.messenger.users[V];if(!K){continue}var J=K.name.toString().toLowerCase()+(K.search_mark?" "+K.search_mark:"");var q=K.work_position?(" "+K.work_position).toLowerCase():"";var Q=true;if(!H[V]){H[V]=0}for(var z=0;z<P.length;z++){if(J.indexOf(P[z].toString().toLowerCase())>=0){H[V]+=100+P[z].length;Q=false}if(q.indexOf(P[z].toString().toLowerCase())>=0){H[V]+=50+P[z].length;Q=false}}if(Q){continue}}if(L[N].id=="bot"){G[N].push(this.BXIM.messenger.users[V])}else if(L[N].id=="ol"){G[N].push(this.BXIM.messenger.users[V])}else{G[N].push(this.BXIM.messenger.users[V])}}if(L[N].id=="bot"){G[N].sort(s.delegate((function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(this.BXIM.messenger.bot[e.id]&&this.BXIM.messenger.bot[e.id]["code"]=="marta"){t=1e7}if(this.BXIM.messenger.bot[s.id]&&this.BXIM.messenger.bot[s.id]["code"]=="marta"){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}}),this))}else if(n){G[N].sort((function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(t>r){return-1}else if(t<r){return 1}else{return 0}}))}else{G[N].sort((function(e,s){var t=H[e.id]?H[e.id]:0;var r=H[s.id]?H[s.id]:0;if(BXIM&&e.id==BXIM.userId){t=1e7}if(BXIM&&s.id==BXIM.userId){r=1e7}if(t>r){return-1}else if(t<r){return 1}else{return 0}}))}}else if(L[N].id=="chat"||L[N].id=="open"||L[N].id=="call"||L[N].id=="lines"){if(!c&&L[N].id!="open")L[N].skip=true;if(!d&&L[N].id=="open")L[N].skip=true;if(L[N].skip)continue;for(var j in this.BXIM.messenger.chat){if(!this.BXIM.messenger.chat.hasOwnProperty(j)){continue}if(this.BXIM.messenger.chat[j].type=="chat"||this.BXIM.messenger.chat[j].type=="open"||this.BXIM.messenger.chat[j].type=="call"||this.BXIM.messenger.chat[j].type=="lines"){if(this.BXIM.messenger.chat[j].type!=L[N].id){continue}}else if(L[N].id!="chat"){continue}if(this.BXIM.messenger.generalChatId==j&&(!this.BXIM.messenger.openChatEnable||this.BXIM.userExtranet)){continue}if(n){var $=true;for(var z=0;z<P.length;z++){if(this.BXIM.messenger.chat[j].name.toString().toLowerCase().indexOf(P[z].toString().toLowerCase())>=0){$=false;break}}if($){continue}}G[N].push(this.BXIM.messenger.chat[j])}G[N].sort(s.delegate((function(e,s){var t=H["chat"+e.id]?H["chat"+e.id]:0;var r=H["chat"+s.id]?H["chat"+s.id]:0;if(this.BXIM.messenger.generalChatId==e.id){t=1e7}else if(this.BXIM.messenger.userChatBlockStatus[e.id]&&this.BXIM.messenger.userChatBlockStatus[e.id][this.BXIM.userId]){t=-1}if(this.BXIM.messenger.generalChatId==s.id){r=1e7}else if(this.BXIM.messenger.userChatBlockStatus[r.id]&&this.BXIM.messenger.userChatBlockStatus[r.id][this.BXIM.userId]){r=-1}if(t>r){return-1}else if(t>r){return-1}else if(t<r){return 1}else{return 0}}),this))}else if(L[N].id=="olQueue"){if(!this.BXIM.messenger.openlines)continue;if(!this.BXIM.messenger.openlines.queue)continue;this.BXIM.messenger.openlines.queue.sort((function(e,s){if(e.transfer_count>s.transfer_count){return-1}else if(e.transfer_count<s.transfer_count){return 1}else{if(e.id>s.id){return 1}else if(e.id<s.id){return-1}else{return 0}}}));for(var Z=0;Z<this.BXIM.messenger.openlines.queue.length;Z++){if(n){var ee=true;for(var z=0;z<P.length;z++){if(this.BXIM.messenger.openlines.queue[Z].name.toString().toLowerCase().indexOf(P[z].toString().toLowerCase())>=0){ee=false;break}}if(ee){continue}}G[N].push(s.clone(this.BXIM.messenger.openlines.queue[Z]))}}else if(L[N].id=="structure"){if(L[N].skip){continue}for(var se in this.BXIM.messenger.groups){if(!this.BXIM.messenger.userInGroup[se]||this.BXIM.messenger.userInGroup[se].length<=0)continue;if(i=="popupChatDialogContactListElements"&&this.BXIM.messenger.userInGroup[se].length>200)continue;if(!E&&se.toString().substr(0,2)=="SG")continue;if(n){var ee=true;for(var z=0;z<P.length;z++){if(this.BXIM.messenger.groups[se].name.toString().toLowerCase().indexOf(P[z].toString().toLowerCase())>=0){ee=false;break}}if(ee){continue}}G[N].push(this.BXIM.messenger.groups[se])}G[N].sort(s.delegate((function(e,s){var t=e.id;var r=s.id;if(this.BXIM.messenger.userInGroup[t]&&this.BXIM.messenger.userInGroup[t].users.indexOf(this.BXIM.userId.toString())>-1){t=-1}if(this.BXIM.messenger.userInGroup[r]&&this.BXIM.messenger.userInGroup[r].users.indexOf(this.BXIM.userId.toString())>-1){r=-1}if(t>r){return 1}else if(t<r){return-1}else{return 0}}),this))}if(L[N].countElement>G[N].length){O+=G[N].length;k+=L[N].countElement-G[N].length}else{F.push(N);O+=L[N].countElement}}if(O<w){var te=0;var re=F.length;for(var N=0;N<k;N++){if(F[te]&&L[F[te]]){L[F[te]].countElement=L[F[te]].countElement+1}te=te==re-1?0:te+1}}for(var N=0;N<L.length;N++){if(L[N].skip)continue;if(n&&G[N].length<=0){if(!X||L[N].id!="extranet"){continue}}if(G[N].length<=0&&!(L[N].id=="private"||L[N].id=="open"||L[N].id=="chat"||X&&L[N].id=="extranet"))continue;t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-group"},children:[!h||L[N].id=="lines"||L[N].id=="call"||L[N].id=="blocked"||L[N].id=="bot"||L[N].id=="ol"?null:s.create("span",{attrs:{"data-type":L[N].id},props:{title:L[N].title,className:"bx-messenger-chatlist-group-add"}}),s.create("span",{props:{className:"bx-messenger-chatlist-group-title"},html:L[N].name})]}));if(G[N].length<=0){if(X&&L[N].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:this.BXIM.bitrixIntranet?s.message("IM_SEARCH_B24"):s.message("IM_SEARCH_SITE")})]}))}continue}var ie=[];var ae=1;for(var ne=0;ne<G[N].length;ne++){var oe=ae<=L[N].countElement;ae++;if(L[N].id=="private"||L[N].id=="extranet"||L[N].id=="bot"||L[N].id=="ol"){var K=G[N][ne];var le=this.drawContactListElement({id:K.id,data:K,showUserLastActivityDate:L[N].id=="bot"?false:C,showLastMessage:false,showCounter:h,extraClass:oe?"":"bx-messenger-hide"});if(le){ie.push(le)}}else if(L[N].id=="chat"||L[N].id=="open"||L[N].id=="call"||L[N].id=="lines"){var me=G[N][ne];var le=this.drawContactListElement({id:"chat"+me.id,data:me,showLastMessage:false,showCounter:h,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"});if(le){ie.push(le)}}else if(L[N].id=="olQueue"||L[N].id=="viQueue"){var he=G[N][ne];he.type=L[N].id;var le=this.drawContactListElement({id:"queue"+he.id,data:he,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"});if(le){ie.push(le)}}else if(L[N].id=="structure"){var ge=G[N][ne];var le=this.drawContactListElement({id:"structure"+ge.id,data:ge,showLastMessage:false,showCounter:false,extraClass:oe?"bx-messenger-chatlist-chat":"bx-messenger-chatlist-chat bx-messenger-hide"});if(le){ie.push(le)}}}if(L[N].countElement<G[N].length){ie.push(s.create("div",{props:{className:"bx-messenger-chatlist-more-wrap"},children:[s.create("span",{attrs:{"data-id":L[N].id,"data-text":s.message("IM_CL_MORE").replace("#COUNT#",G[N].length-L[N].countElement),"data-title":L[N].more},props:{title:L[N].more,className:"bx-messenger-chatlist-more"},html:this.BXIM.messenger.contactListShowed[L[N].id]?s.message("IM_CL_HIDE"):s.message("IM_CL_MORE").replace("#COUNT#",G[N].length-L[N].countElement)})]}))}if(ie.length>0){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-category"+(this.BXIM.messenger.contactListShowed[L[N].id]?" bx-messenger-chatlist-show-all":"")},children:ie}));if(X&&L[N].id=="extranet"){t.appendChild(s.create("div",{props:{className:"bx-messenger-chatlist-search-button-wrap"},children:[s.create("span",{props:{className:"bx-messenger-chatlist-search-button"},html:s.message("IM_SEARCH_B24")})]}))}}}if(l){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-search"},html:s.message("IM_M_CL_SEARCH")}))}else if(t.childNodes.length<=0){t.appendChild(s.create("div",{props:{className:"bx-messenger-cl-item-empty"},html:s.message("IM_M_CL_EMPTY")}));B.empty()}return t};t.prototype.userInviteResend=function(e){if(!this.BXIM.canInvite){var t=this.recentListGetItem(e);if(t&&t.invited&&t.invited.originator_id!=this.BXIM.userId){return false}}s.ajax.runAction("intranet.controller.invite.reinvite",{data:{params:{userId:e}}}).then((function(e){s.UI.Notification.Center.notify({content:s.message("IM_USER_INVITE_RESEND_DONE"),autoHideDelay:2e3})}),(function(e){if(e.status=="error"&&e.errors.length>0){var t=e.errors.map((function(e){return e.message})).join(". ");s.UI.Notification.Center.notify({content:t,autoHideDelay:4e3});return true}s.UI.Notification.Center.notify({content:s.message("IM_CONNECT_ERROR"),autoHideDelay:4e3})}))};t.prototype.userInviteCancel=function(e){if(!this.BXIM.canInvite){var t=this.recentListGetItem(e);if(t&&t.invited&&t.invited.originator_id!=this.BXIM.userId){return false}}var r=this.recentListGetItem(e);var i=this.BXIM.messenger.users[e];if(r){this.recentListHide(e,false)}if(i){delete this.BXIM.messenger.users[e];if(!this.BXIM.messenger.recentList){this.userListRedraw()}}s.ajax.runAction("intranet.controller.invite.deleteinvitation",{data:{params:{userId:e}}}).then(function(e){s.UI.Notification.Center.notify({content:s.message("IM_USER_INVITE_CANCEL_DONE"),autoHideDelay:2e3})}.bind(this),function(e){if(i){this.BXIM.messenger.users[i.id]=i}if(r){this.recentListAddItem(r)}this.userListRedraw();if(e.status=="error"&&e.errors.length>0){var t=e.errors.map((function(e){return e.message})).join(". ");s.UI.Notification.Center.notify({content:t,autoHideDelay:4e3});return true}s.UI.Notification.Center.notify({content:s.message("IM_CONNECT_ERROR"),autoHideDelay:4e3})}.bind(this));return true};t.prototype.userHasPhone=function(e){return this.BXIM.messenger.users.hasOwnProperty(e)&&this.BXIM.messenger.users[e].phone_device||this.BXIM.messenger.phones.hasOwnProperty(e)&&(this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_MOBILE")||this.BXIM.messenger.phones[e].hasOwnProperty("PERSONAL_PHONE")||this.BXIM.messenger.phones[e].hasOwnProperty("WORK_PHONE"))};t.prototype.userChangeStatus=function(e){var t;if(s.type.isArray(e)){t=e}else{t=[e]}var r=false;var i=false;t.forEach(function(e){if(typeof this.BXIM.messenger.users[e.id]=="undefined"){return}var s=this.BXIM.messenger.users[e.id];if(!r&&this.BXIM.messenger.recent.findIndex((function(s){return s.id==e.id}))>-1){if(s.status!==e.status){r=true}if(!r&&typeof e.idle!=="undefined"){var t=s.idle?s.idle.getTime():0;var a=e.idle?new Date(e.idle).getTime():0;if(t!==a){r=true}}if(!r&&typeof e.mobile_last_date!=="undefined"){var n=s.mobile_last_date?s.mobile_last_date.getTime():0;var o=e.mobile_last_date?new Date(e.mobile_last_date).getTime():0;if(n!==o){r=true}}}if(r&&this.BXIM.messenger.currentTab.toString()==e.id.toString()){i=true}if(typeof e.status!=="undefined"){s.status=e.status}if(typeof e.color!=="undefined"){s.color=e.color}if(typeof e.idle!=="undefined"){s.idle=e.idle?new Date(e.idle):false}if(typeof e.mobile_last_date!=="undefined"){s.mobile_last_date=e.mobile_last_date?new Date(e.mobile_last_date):false}if(typeof e.last_activity_date!=="undefined"){s.last_activity_date=e.last_activity_date?new Date(e.last_activity_date):false}}.bind(this));if(i){this.BXIM.messenger.dialogStatusRedraw()}return true};t.prototype.prepareCommandList=function(e){e=typeof e=="string"?e:"";var t=s.clone(this.BXIM.messenger.command);var r=[];var i=[];for(var a=0;a<t.length;a++){if(this.BXIM.messenger.openChatFlag){if(s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),t[a].bot_id)){r.push(t[a])}else{i.push(t[a])}}else{if(this.BXIM.messenger.currentTab==parseInt(t[a].bot_id)){r.push(t[a])}else{i.push(t[a])}}}for(var a=0;a<i.length;a++){r.push(i[a])}var n=[];var o="";for(var a=0;a<r.length;a++){if(e==""||r[a].command.indexOf(e)===1){if(r[a].command=="/>>"){r[a].command=">>"}if(this.BXIM.messenger.openLinesFlag&&(r[a].command=="/me"||r[a].command=="/loud")){continue}if(this.BXIM.userExtranet&&!r[a].extranet){continue}if(!r[a].common){if(this.BXIM.messenger.openChatFlag){if(!s.MessengerCommon.userInChat(this.BXIM.messenger.currentTab.toString().substr(4),r[a].bot_id)){continue}}else if(this.BXIM.messenger.currentTab!=parseInt(r[a].bot_id)){continue}}if(r[a].context!=""){if(r[a].context=="chat"){if(!this.BXIM.messenger.openChatFlag){continue}}else if(r[a].context=="user"){if(this.BXIM.messenger.openChatFlag){continue}}else if(e==""){continue}}if(o!=r[a].category){o=r[a].category;n.push({type:"category",title:o})}r[a].type="item";n.push(r[a])}}return n};t.prototype.convertMessage=function(e){if(typeof e.textOriginal!=="undefined"){return e}e.textOriginal=e.text;e.text=s.MessengerCommon.prepareText(e.text,true,true,true);return e};t.prototype.drawMessage=function(t,r,i,a){if(typeof r!="object"||this.BXIM.messenger.popupMessenger==null)return false;r=this.convertMessage(r);var n=this.BXIM.messenger.popupMessengerBodyWrap;var o="default";var l=false;var m=true;var h=true;if(typeof t=="object"){l=true;o=t.placeholderName||"custom";n=t.placeholder;m=t.showKeyboard==false?false:true;h=t.showReply==false?false:true}else if(t!=this.BXIM.messenger.currentTab||t==0||!this.MobileActionEqual("DIALOG")){return false}if(r.dropDuplicate){var g=s.findChildByClassName(n,"bx-messenger-content-item-id-"+r.id);if(g){s.remove(g)}r.dropDuplicate=false}a=a==true;i=a?false:i;if(typeof r.params!="object"){r.params={}}var p=false;var c=false;var d=r.params&&r.params.IS_EDITED=="Y";var I=r.params&&r.params.IS_DELETED=="Y";var u=I?s.message("IM_M_DELETED"):r.text;var M=r.id.toString().indexOf("temp")==0;var f=M&&r.retry;var B=r.senderId==0;var X=this.BXIM.ppServerStatus;var b=r.params&&r.params.MENU&&r.params.MENU!="N";u=this.replaceDateText(r.id,u,r.params);if(l){p=r.chatId&&this.BXIM.messenger.chat[r.chatId]?true:false;c=p&&r.chatId==this.BXIM.messenger.generalChatId;if(p&&this.BXIM.messenger.chat[r.chatId].type=="call"){X=false}else if(p&&this.BXIM.messenger.chat[r.chatId].type=="lines"){var E=this.linesGetSource(this.BXIM.messenger.chat[r.chatId]);if(!(E=="livechat")){X=false}}else if(!p&&this.BXIM.messenger.bot[r.recipientId]&&(this.BXIM.messenger.bot[r.recipientId].type=="network"||this.BXIM.messenger.bot[r.recipientId].type=="support24")){X=false}}else{if(r.senderId==this.BXIM.userId){if(this.BXIM.messenger.message[r.id]&&this.BXIM.messenger.message[r.id].recipientId==this.BXIM.messenger.currentTab){this.BXIM.messenger.popupMessengerLastMessage=r.id}}this.BXIM.messenger.openChatFlag=this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat";p=this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="chat"||this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="open");c=p&&r.chatId==this.BXIM.messenger.generalChatId;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){X=false}else if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="lines"){var E=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]);if(!(E=="livechat")){X=false}}else if(!this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type=="network"||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type=="support24")){X=false}}var C=X&&typeof r.params.LIKE=="object"&&r.params.LIKE.length>0?r.params.LIKE.length:"";var _=X&&typeof r.params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,r.params.LIKE);var S=this.diskDrawFiles(r.chatId,r.params.FILE_ID);if(S.length>0){var T=u!=""||r.params.ATTACH;S=s.create("div",{props:{className:"bx-messenger-file-box"+(T?" bx-messenger-file-box-with-message":"")},children:S})}else{S=null}var v=h?this.drawMessageReply(r.id):null;var y=null;var A=[];if(r.params.ATTACH){for(var L=0;L<r.params.ATTACH.length;L++){A[L]=r.params.ATTACH[L]}var x=/\[ATTACH=([0-9]{1,})\]/gm;var N=[];while((N=x.exec(u))!==null){for(var L=0;L<A.length;L++){if(r.params.ATTACH[L].ID==N[1]){y=s.create("div",{props:{className:"bx-messenger-attach-box"},children:s.MessengerCommon.drawAttach(r.id,r.chatId,[A[L]])});u=u.replace("[ATTACH="+N[1]+"]",y.innerHTML);delete A[L]}}}}if(r.params.LINK_ACTIVE&&r.params.LINK_ACTIVE.length>0&&!r.params.LINK_ACTIVE.map((function(e){return parseInt(e)})).includes(this.BXIM.userId)){u=u.replace(/<a.*?href="([^"]*)".*?>(.*?)<\/a>/gi,"$2")}var R="";if(r.params.CLASS){R=r.params.CLASS}var w=null;if(r.params.IMOL_SID&&parseInt(r.params.IMOL_SID)>0){w=s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",r.params.IMOL_SID)})}if(r.params.IMOL_FORM&&this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var D=r.params.IMOL_FORM.toString().substr(-6)=="-delay";var O=D?r.params.IMOL_FORM.substr(0,r.params.IMOL_FORM.lastIndexOf("-delay")):r.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<r.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=O){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=r.id;this.BXIM.messenger.popupMessengerLiveChatDelayedForm=D?O:null;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate((function(){this.BXIM.messenger.linesLivechatFormShow(O)}),this),D?3e4:5e3)}}y=s.MessengerCommon.drawAttach(r.id,r.chatId,A);if(y.length>0){y=s.create("div",{props:{className:"bx-messenger-attach-box"},children:y})}else{y=null}var k=this.drawKeyboard(r.recipientId,r.id,m&&r.params.KEYBOARD?r.params.KEYBOARD:null);var P=false;if(!S&&!y&&u.length<=0){P=true}if(r.system&&r.system=="Y"){B=true;r.senderId=0}var U=false;var H=this.BXIM.messenger.users[r.senderId];if(!B&&(typeof H=="undefined"||H.id<=0)){U=true;P=true}if(r.params&&H&&H.id>0&&(r.params.AVATAR||r.params.NAME||r.params.USER_ID)){H=s.clone(H);if(r.params.AVATAR){H.avatar=r.params.AVATAR}if(r.params.NAME){H.name=r.params.NAME;H.first_name=r.params.NAME.split(" ")[0]}r=s.clone(r);if(parseInt(r.params.USER_ID)){r.senderId="network"+r.params.USER_ID}}var G=this.linesVoteDraw(r.id);if(G){u=G;r.system="Y"}else{R=R.replace("bx-messenger-content-item-vote","");var F=this.linesVoteResultDraw(r.id,u);if(F){u=F}}if(!l){if(!this.BXIM.messenger.history[t])this.BXIM.messenger.history[t]=[];if(parseInt(r.id)>0&&this.BXIM.messenger.history[t].indexOf(r.id.toString())==-1)this.BXIM.messenger.history[t].push(r.id);var V=0;if(!U){var W=false;if(this.BXIM.messenger.unreadMessage[t]&&s.util.in_array(r.id,this.BXIM.messenger.unreadMessage[t]))W=true}}var j=false;var Y=null;if(a){Y=n.firstChild;if(Y){if(s.hasClass(Y,"bx-messenger-content-empty")||s.hasClass(Y,"bx-messenger-content-load")){s.remove(Y)}else if(s.hasClass(Y,"bx-messenger-content-group")){Y=Y.nextSibling}}}else{Y=n.lastChild;if(Y&&(s.hasClass(Y,"bx-messenger-content-empty")||s.hasClass(Y,"bx-messenger-content-load"))){s.remove(Y)}else if(Y&&s.hasClass(Y,"bx-messenger-content-item-notify")){if(r.senderId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(Y);j=false;Y=n.lastChild}else{j=true;Y=n.lastChild.previousSibling}}}if(!U){var K=this.formatDate(r.date,this.getDateFormatType("MESSAGE_TITLE"));var J=typeof s.translit!="undefined"?s.translit(K):K;if(typeof this.messageGroup!="object"){this.messageGroup={}}if(typeof this.messageGroup[o]!="object"){this.messageGroup[o]={}}if(!this.messageGroup[o][J]){this.messageGroup[o][J]=true;var q=[];if(this.BXIM.desktop&&this.isPage()){q=[s.create("a",{attrs:{name:"bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-link"}}),s.create("a",{attrs:{id:"bx-im-go-"+J,href:"#bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:K})]}else{q=[s.create("a",{attrs:{name:"bx-im-go-"+r.date},props:{className:"bx-messenger-content-group-link"}}),s.create("div",{attrs:{id:"bx-im-go-"+J},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:K})]}var Q=s.create("div",{props:{className:"bx-messenger-content-group"+(K==s.message("FD_TODAY")?" bx-messenger-content-group-today":"")},children:q});if(a){n.insertBefore(Q,n.firstChild);Y=Q.nextSibling}else{if(j&&Y.nextElementSibling){n.insertBefore(Q,Y.nextElementSibling);Y=Q}else{n.appendChild(Q)}}}}var z=false;var $=false;var Z=null;if(typeof u=="string"){if(u.length>0){var ee=u.replace(/<img.*?data-code="([^"]*)".*?>/gi,"$1").replace(/<\/?[^>]+>/gi," ").replace(/(https|http):\/\/([\S]+)\.(jpg|jpeg|png|gif|webp)(\?[\S]+)?/gi,(function(e){return""})).trim();if(!ee){z=true}}if(this.BXIM.settings.enableRichLink&&r.params.URL_ONLY=="Y"&&r.params.URL_ID&&r.params.URL_ID.length>0&&r.params.ATTACH&&r.params.ATTACH.length>0){$=true}parsedText=!M?u:this.prepareText(u,false,true,true,!this.BXIM.messenger.openChatFlag||r.senderId==this.BXIM.userId?false:this.BXIM.messenger.users[this.BXIM.userId].name,se);var se={oneSmileInMessage:false};Z=s.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+r.id},html:parsedText});var te=se.oneSmileInMessage}else{Z=s.create("span",{props:{className:"bx-messenger-message"},attrs:{id:"im-message-"+r.id},children:[u]});var te=false}var re=r.params.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile;if(!P){if(Y)V=Y.getAttribute("data-messageId");if(B){var ie=s.create("div",{attrs:{"data-type":"system","data-senderId":"0","data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-notice "+R},children:[w,s.create("span",{props:{className:"bx-messenger-content-item-content"+(te?" bx-messenger-content-item-content-transparent":"")+(z?" bx-messenger-content-item-content-without-padding":"")+($&&!I?" bx-messenger-content-item-content-rich-link":"")+(I||d?" bx-messenger-message-edited":"")+(re?" bx-messenger-content-item-content-large-font":"")},children:[!c?[]:s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(_?" bx-messenger-content-item-liked":"")+(C<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:C>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:C})],events:this.isMobile()?{click:s.delegate((function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)}),this)}:{}}),typeof H=="undefined"||H.id<=0?[]:s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("span",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(H.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{style:this.isBlankAvatar(H.avatar)?"background-color: "+H.color:"background: url('"+this.formatUrl(H.avatar)+"'); background-size: cover;"}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(H.name)},html:H.first_name?H.first_name:H.name.split(" ")[0]}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(I?" bx-messenger-message-deleted":" ")},children:[S,Z,y]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[s.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(r.date,this.getDateFormatType("MESSAGE"))}),r.params.BETA!="Y"?null:s.create("span",{props:{className:"bx-messenger-content-item-beta"},attrs:{title:s.message("IM_BETA")},html:"<beta>&beta;</beta>"})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),k,v]});if(r.system&&r.system=="Y"&&W)s.addClass(ie,"bx-messenger-content-item-new")}else if(r.senderId==this.BXIM.userId){var ie=s.create("div",{attrs:{"data-type":"self","data-senderId":r.senderId,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-1 "+R},children:[w,s.create("span",{props:{className:"bx-messenger-content-item-content"+(te?" bx-messenger-content-item-content-transparent":"")+(z?" bx-messenger-content-item-content-without-padding":"")+($&&!I?" bx-messenger-content-item-content-rich-link":"")+(I||d?" bx-messenger-message-edited":"")+(re?" bx-messenger-content-item-content-large-font":"")},children:[s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(_?" bx-messenger-content-item-liked":"")+(C<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:C>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:C})],events:this.isMobile()?{click:s.delegate((function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)}),this)}:{}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("span",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(H.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{style:this.isBlankAvatar(H.avatar)?"background-color: "+H.color:"background: url('"+this.formatUrl(H.avatar)+"'); background-size: cover;"}}),this.BXIM.messenger.openChatFlag?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(H.name)},html:H.first_name?H.first_name:H.name.split(" ")[0]}):null]})]}),f?s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[s.create("span",{attrs:{title:s.message("IM_M_RETRY"),"data-messageid":r.id,"data-chat":parseInt(r.recipientId)>0?"Y":"N"},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]}):s.create("span",{props:{className:"bx-messenger-content-item-status"},children:M?[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(I?" bx-messenger-message-deleted":" ")},children:[S,Z,y]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!X||this.isMobile()?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(_?" bx-messenger-content-item-liked":"")+(C<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{html:"&nbsp;"}),s.create("span",{attrs:{title:C>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:C}),s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]}),s.create("span",{props:{className:"bx-messenger-content-item-date"},html:f?s.message("IM_M_NOT_DELIVERED"):this.formatDate(r.date,this.getDateFormatType("MESSAGE"))}),r.params.BETA!="Y"?null:s.create("span",{props:{className:"bx-messenger-content-item-beta"},attrs:{title:s.message("IM_BETA")},html:"<beta>&beta;</beta>"})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),k,v]})}else{var ie=s.create("div",{attrs:{"data-type":"other","data-senderId":r.senderId,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item bx-messenger-content-item-id-"+r.id+" bx-messenger-content-item-2"+(W?" bx-messenger-content-item-new":"")+" "+R},children:[w,s.create("span",{props:{className:"bx-messenger-content-item-content"+(te?" bx-messenger-content-item-content-transparent":"")+(z?" bx-messenger-content-item-content-without-padding":"")+($&&!I?" bx-messenger-content-item-content-rich-link":"")+(I||d?" bx-messenger-message-edited":"")+(re?" bx-messenger-content-item-content-large-font":"")},children:[s.create("span",{attrs:{title:(b?s.message("IM_M_MENU_APP_EXISTS")+" ":"")+s.message("IM_M_OPEN_EXTRA_TITLE").replace("#SHORTCUT#",s.browser.IsMac()?"CMD":"CTRL")},props:{className:"bx-messenger-content-item-menu"}}),!this.isMobile()||!X?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(_?" bx-messenger-content-item-liked":"")+(C<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:""}),s.create("span",{attrs:{title:C>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:C})],events:this.isMobile()?{click:s.delegate((function(e){this.BXIM.messageLike(r.id);return s.PreventDefault(e)}),this)}:{}}),s.create("span",{attrs:{title:s.util.htmlspecialcharsback(H.name)},props:{className:"bx-messenger-content-item-avatar bx-messenger-content-item-avatar-button"},children:[s.create("span",{props:{className:"bx-messenger-content-item-arrow"}}),s.create("span",{props:{className:"bx-messenger-content-item-avatar-block"},children:[s.create("span",{props:{className:"bx-messenger-content-item-avatar-img"+(s.MessengerCommon.isBlankAvatar(H.avatar)?" bx-messenger-content-item-avatar-img-default":"")},attrs:{style:this.isBlankAvatar(H.avatar)?"background-color: "+H.color:"background: url('"+this.formatUrl(H.avatar)+"'); background-size: cover;"}}),this.BXIM.messenger.openChatFlag||H.bot?s.create("span",{props:{className:"bx-messenger-content-item-avatar-name"},attrs:{title:s.util.htmlspecialcharsback(H.name)},html:H.first_name?H.first_name:H.name.split(" ")[0]}):null]})]}),s.create("span",{props:{className:"bx-messenger-content-item-status"},children:[]}),s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-wrap"+(a?" bx-messenger-content-item-text-wrap-append":"")+(I?" bx-messenger-message-deleted":" ")},children:[S,Z,y]})]}),s.create("span",{props:{className:"bx-messenger-content-item-params"},children:[!X||this.isMobile()?null:s.create("span",{props:{className:"bx-messenger-content-item-like"+(_?" bx-messenger-content-item-liked":"")+(C<=0?" bx-messenger-content-like-digit-off":"")},children:[s.create("span",{html:"&nbsp;"}),s.create("span",{attrs:{title:C>0?s.message("IM_MESSAGE_LIKE_LIST"):""},props:{className:"bx-messenger-content-like-digit"},html:C}),s.create("span",{attrs:{"data-messageId":r.id},props:{className:"bx-messenger-content-like-button"},html:s.message("IM_MESSAGE_LIKE")})]}),s.create("span",{props:{className:"bx-messenger-content-item-date"},html:this.formatDate(r.date,this.getDateFormatType("MESSAGE"))}),r.params.BETA!="Y"?null:s.create("span",{props:{className:"bx-messenger-content-item-beta"},attrs:{title:s.message("IM_BETA")},html:"<beta>&beta;</beta>"})]}),s.create("span",{props:{className:"bx-messenger-clear"}})]})]}),k,v]})}}else if(U){ie=s.create("div",{attrs:{id:"im-message-"+r.id,"data-messageDate":r.date,"data-messageId":r.id,"data-blockmessageid":r.id},props:{className:"bx-messenger-content-item-text-wrap bx-messenger-item-skipped"}})}if(ie&&(!P||U)){var ae=null;if(Y&&Y.getAttribute("data-senderId")!=r.senderId){ae=s.create("div",{props:{className:"bx-messenger-item-delimiter"}})}if(a){n.insertBefore(ie,Y);if(ae){n.insertBefore(ae,Y)}}else if(j&&Y&&Y.nextElementSibling){n.insertBefore(ie,Y.nextElementSibling);if(ae){n.insertBefore(ae,Y.nextElementSibling)}}else{if(ae){n.appendChild(ae)}n.appendChild(ie)}}if(!l&&!U&&i!==false&&this.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate((function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll}),this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}if(r.params.SENDING=="Y"||r.params.IS_DELIVERED=="N"){this.drawProgessMessage(r.id)}return V};t.prototype.drawMessageReply=function(e){var t=null;if(!(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.CHAT_ID>0)){return t}var r=this.BXIM.messenger.message[e].params.CHAT_ID;var i=this.BXIM.messenger.message[e].chatId;var a=this.BXIM.messenger.message[e].params.CHAT_LAST_DATE?new Date(this.BXIM.messenger.message[e].params.CHAT_LAST_DATE):"";var n=this.BXIM.messenger.message[e].params.CHAT_MESSAGE||0;t=s.create("div",{props:{className:"bx-messenger-content-reply"},attrs:{id:"im-message-content-reply-"+e,"data-messageId":e,"data-chatid":r},children:[s.create("span",{props:{className:"bx-messenger-content-reply-block"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-comment"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-answer"},events:{click:s.delegate((function(){this.joinParentChat(s.proxy_context.getAttribute("data-messageId"),s.proxy_context.getAttribute("data-chatId"))}),this)},attrs:{"data-messageId":e,"data-chatId":r},html:n+" "+s.Loc.getMessagePlural("IM_R_COMMENT",parseInt(n))}),s.create("span",{props:{className:"bx-messenger-content-reply-date"},html:a?", "+this.formatDate(a):""})]}),s.create("div",{props:{className:"bx-messenger-content-reply-clear"}})]}),s.create("span",{props:{className:"bx-messenger-content-reply-join"},children:[s.create("span",{props:{className:"bx-messenger-content-reply-join-button"},html:s.message("IM_M_OPEN"),events:{click:s.delegate((function(){this.joinParentChat(s.proxy_context.getAttribute("data-messageId"),s.proxy_context.getAttribute("data-chatId"))}),this)},attrs:{"data-messageId":e,"data-chatId":r}})]}),s.create("div",{props:{className:"bx-messenger-content-reply-clear"}})]});return t};t.prototype.joinParentChat=function(e,t){if(!e||!t)return false;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]){this.BXIM.messenger.blockJoinChat[t]=false;this.BXIM.messenger.openMessenger("chat"+t)}else{this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?PARENT_CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_PARENT_CHAT_JOIN:"Y",CHAT_ID:t,MESSAGE_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[t]=false;this.BXIM.messenger.openMessenger("chat"+t)}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[t]=false}),this)})}};t.prototype.openReplyDialog=function(e){if(this.isMobile()){alert(s.message("IM_AV_NEXT_VERSION"));return false}this.BXIM.messenger.openMessengerPanel();this.BXIM.messenger.popupMessengerBodyPanelTitleName.innerHTML=s.message("IM_R_DIALOG_TITLE");var t=this.drawMessageReply(e);if(t){this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML="";this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.appendChild(t)}else{this.BXIM.messenger.popupMessengerBodyPanelTitleDesc.innerHTML=s.message("IM_R_COMMENT_ZERO")}this.BXIM.messenger.popupMessengerBodyPanelWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyPanelWrap,{children:[this.BXIM.messenger.popupMessengerBodyPanelWrapMessage=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message"}}),this.BXIM.messenger.popupMessengerBodyPanelWrapMessages=s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-list"}}),s.create("div",{props:{className:"bx-messenger-body-panel-wrap-message-textarea"},children:[this.popupMessengerTextareaPlace=s.create("div",{props:{className:"bx-messenger-textarea-place"},children:[s.create("div",{props:{className:"bx-messenger-textarea-send"},children:[s.create("a",{attrs:{href:"#send"},props:{className:"bx-messenger-textarea-send-button"},events:{click:s.delegate(this.sendMessage,this)}})]}),this.popupMessengerBodyPanelSmileButton=s.create("div",{attrs:{title:s.message("IM_SMILE_MENU")},props:{className:"bx-messenger-textarea-smile"},events:{click:s.delegate((function(e){this.openSmileMenu();return s.PreventDefault(e)}),this)}}),s.create("div",{props:{className:"bx-messenger-textarea"},children:[this.popupMessengerPanelTextarea=s.create("textarea",{props:{value:"",className:"bx-messenger-textarea-input"}}),this.popupMessengerPanelTextareaPlaceholder=s.create("div",{props:{className:"bx-messenger-textarea-placeholder"},html:s.message("IM_M_TA_TEXT")})]}),s.create("div",{props:{className:"bx-messenger-textarea-clear"}})]})]})]});if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["reply"]={};this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessage,placeholderName:"reply",showKeyboard:false,showReply:false},this.BXIM.messenger.message[e]);if(t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_LOAD_COMMENT")+"</span></div>"}else{this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_R_NO_COMMENT")+"</span></div>"}this.messageGroup["replyMessages"]={};if(t){setTimeout(s.delegate((function(){if(!this.BXIM.messenger.message[e]||this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.CHAT_ID<=0){return false}var t="chat"+this.BXIM.messenger.message[e].params.CHAT_ID;this.loadLastMessage(t,s.delegate((function(e,t,r){if(!t){this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML='<div class="bx-messenger-content-empty"><span class="bx-messenger-content-load-text">'+s.message("IM_F_ERROR")+"</span></div>";return false}this.BXIM.messenger.popupMessengerBodyPanelWrapMessages.innerHTML="";var i=s.util.shuffle(this.BXIM.messenger.showMessage[e]);for(var a=0;a<i.length;a++){this.drawMessage({placeholder:this.BXIM.messenger.popupMessengerBodyPanelWrapMessages,placeholderName:"replyMessages",showKeyboard:false,showReply:false},this.BXIM.messenger.message[i[a]])}}),this))}),this),1e3)}return true};t.prototype.checkProgessMessage=function(){for(messageId in this.BXIM.messenger.popupMessengerSendingTimeout){if(!this.BXIM.messenger.message[messageId]||!this.BXIM.messenger.message[messageId].params||!this.BXIM.messenger.message[messageId].params.SENDING_TS){delete this.BXIM.messenger.popupMessengerSendingTimeout[messageId]}else if(typeof this.BXIM.messenger.message[messageId].params.FILE_ID!=="undefined"&&this.BXIM.messenger.message[messageId].params.FILE_ID.length>0&&parseInt(this.BXIM.messenger.message[messageId].params.SENDING_TS)+3600<(new Date).getTime()/1e3){this.drawProgessMessage(messageId)}else if(parseInt(this.BXIM.messenger.message[messageId].params.SENDING_TS)+300<(new Date).getTime()/1e3){this.drawProgessMessage(messageId)}}};t.prototype.drawProgessMessage=function(e,t){var r=s("im-message-"+e);if(!r)return false;s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.MessengerTimer.start("progressMessage",e,1e3,(function(e){var t=s("im-message-"+e);if(!t)return false;s.addClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start")}));r.parentNode.parentNode.parentNode.previousSibling.innerHTML="";var i=true;var a=this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params;var n=this.BXIM.messenger.message[e].params.IS_DELIVERED=="N";var o=this.BXIM.messenger.message[e].params.SENDING=="Y"&&typeof this.BXIM.messenger.message[e].params.SENDING_TS!=="undefined";var l=typeof this.BXIM.messenger.message[e].params.FILE_ID==="object"&&this.BXIM.messenger.message[e].params.FILE_ID.length>0;if(a&&(n||o&&(l&&parseInt(this.BXIM.messenger.message[e].params.SENDING_TS)+3600<(new Date).getTime()/1e3||!l&&parseInt(this.BXIM.messenger.message[e].params.SENDING_TS)+300<(new Date).getTime()/1e3))){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];this.BXIM.messenger.message[e].params.IS_DELIVERED="N";this.BXIM.messenger.message[e].params.SENDING="N";this.BXIM.messenger.message[e].params.SENDING_TS=0;i=false;var m=s.findChildByClassName(r.parentNode.parentNode.parentNode,"bx-messenger-content-item-date");if(m)m.innerHTML=s.message("IM_M_NOT_DELIVERED")}if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.SENDING=="Y"){this.BXIM.messenger.popupMessengerSendingTimeout[e]=this.BXIM.messenger.message[e].params.SENDING_TS}if(!i){if(this.BXIM.messenger.message[e]){s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");s.MessengerCommon.recentListElementStatusError(this.BXIM.messenger.message[e].recipientId,e);s.MessengerTimer.stop("progressMessage",e,true)}}else if(typeof t=="object"||t===true){if(this.BXIM.messenger.message[e]){this.BXIM.messenger.errorMessage[this.BXIM.messenger.currentTab]=true;s.addClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");s.MessengerCommon.recentListElementStatusError(this.BXIM.messenger.message[e].recipientId,e);s.MessengerTimer.stop("progressMessage",e,true);t.chat=t.chat?t.chat:parseInt(this.BXIM.messenger.message[e].recipientId)>0?"Y":"N";s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{attrs:{title:t.title?t.title:"","data-messageid":e,"data-chat":t.chat},props:{className:"bx-messenger-content-item-error"},children:[s.create("span",{props:{className:"bx-messenger-content-item-error-icon"}})]})]})}else{s.MessengerTimer.stop("progressMessage",e,true);s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");s.removeClass(r.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error")}}else{s.adjust(r.parentNode.parentNode.parentNode.previousSibling,{children:[s.create("span",{props:{className:"bx-messenger-content-item-progress"}})]})}return true};t.prototype.clearProgessMessage=function(e){delete this.BXIM.messenger.popupMessengerSendingTimeout[e];var t=s("im-message-"+e);if(!t)return false;if(this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&(this.BXIM.messenger.message[e].params.SENDING=="Y"||this.BXIM.messenger.message[e].params.IS_DELIVERED=="N")){return false}s.MessengerTimer.stop("progressMessage",e,true);s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress");s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-start");s.removeClass(t.parentNode.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-progress-error");t.parentNode.parentNode.parentNode.previousSibling.innerHTML="";return true};t.prototype.startWriting=function(e,t,r){if(t==this.BXIM.userId){this.BXIM.messenger.writingList[e]=true;this.drawWriting(e);clearTimeout(this.BXIM.messenger.writingListTimeout[e]);this.BXIM.messenger.writingListTimeout[e]=setTimeout(s.delegate((function(){this.endWriting(e)}),this),29500)}else{if(!this.BXIM.messenger.writingList[t])this.BXIM.messenger.writingList[t]={};if(!this.BXIM.messenger.writingListTimeout[t])this.BXIM.messenger.writingListTimeout[t]={};this.BXIM.messenger.writingList[t][e]=true;this.drawWriting(e,t);clearTimeout(this.BXIM.messenger.writingListTimeout[t][e]);this.BXIM.messenger.writingListTimeout[t][e]=setTimeout(s.delegate((function(){this.endWriting(e,t)}),this),29500)}};t.prototype.drawWriting=function(t,r,i){i=typeof i=="undefined"?true:i;if(r==this.BXIM.userId)return false;if(!r||r.toString().substr(0,4)!=="chat"){r=""}if(this.BXIM.messenger.popupMessenger!=null&&this.MobileActionEqual("RECENT","DIALOG")){if(this.BXIM.messenger.writingList[t]||r&&this.countWriting(r)>0){if(s.MessengerExternalList){var a=s.MessengerExternalList.getElement(r?r:t,true);if(a){for(var n=0;n<a.length;n++)s.addClass(a[n],"bx-messenger-cl-status-writing")}}var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.addClass(a[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==t||r&&this.BXIM.messenger.currentTab==r)){if(r){var o=[];for(var n in this.BXIM.messenger.writingList[r]){if(this.BXIM.messenger.writingList[r].hasOwnProperty(n)&&this.BXIM.messenger.users[n]){o.push(this.BXIM.messenger.users[n].name)}}this.drawNotifyMessage(r,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",o.join(", ")))}else{if(!this.isMobile()){this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-writing"}this.drawNotifyMessage(t,"writing",s.message("IM_M_WRITING").replace("#USER_NAME#",this.BXIM.messenger.users[t].name))}}}else if(!this.BXIM.messenger.writingList[t]||r&&this.countWriting(r)==0){var a=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.removeClass(a[n],"bx-messenger-cl-status-writing")}var a=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+(r?r:t));if(a){for(var n=0;n<a.length;n++)s.removeClass(a[n],"bx-messenger-cl-status-writing")}if(this.MobileActionEqual("DIALOG")&&(this.BXIM.messenger.currentTab==t||this.BXIM.messenger.currentTab==r)){if(!r){if(!this.isMobile())this.BXIM.messenger.popupMessengerPanelAvatar.parentNode.className="bx-messenger-panel-avatar bx-messenger-panel-avatar-status-"+this.getUserStatus(this.BXIM.messenger.users[t])}var l=this.BXIM.messenger.popupMessengerBodyWrap?this.BXIM.messenger.popupMessengerBodyWrap.lastChild:null;if(l&&s.hasClass(l,"bx-messenger-content-item-notify")&&this.BXIM.messenger.popupMessengerBody){if(!r&&this.BXIM.messenger.readedList[t]){this.drawReadMessage(t,this.BXIM.messenger.readedList[t].messageId,this.BXIM.messenger.readedList[t].date,false)}else if(r&&this.BXIM.messenger.readedList[r]){this.drawReadMessageChat(r,false)}else if(s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate((function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll}),this),complete:s.delegate((function(){s.remove(l)}),this)})).animate()}else if(i){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight;s.remove(l)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollTop-l.offsetHeight;s.remove(l)}}}}}};t.prototype.endWriting=function(e,s,t){t=typeof t=="undefined"?true:t;if(s.toString().substr(0,4)=="chat"){if(this.BXIM.messenger.writingListTimeout[s]&&this.BXIM.messenger.writingListTimeout[s][e])clearTimeout(this.BXIM.messenger.writingListTimeout[s][e]);if(this.BXIM.messenger.writingList[s]&&this.BXIM.messenger.writingList[s][e])delete this.BXIM.messenger.writingList[s][e]}else{clearTimeout(this.BXIM.messenger.writingListTimeout[e]);delete this.BXIM.messenger.writingList[e]}this.drawWriting(e,s,t)};t.prototype.sendWriting=function(t){if(!this.BXIM.ppServerStatus||t=="create"||t==this.BXIM.userId)return false;if(!this.BXIM.messenger.writingSendList[t]){clearTimeout(this.BXIM.messenger.writingSendListTimeout[t]);this.BXIM.messenger.writingSendList[t]=true;var r="N";if(t.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[t.toString().substr(4)]){r="Y"}s.ajax({url:this.BXIM.pathToAjax+"?START_WRITING&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_START_WRITING:"Y",DIALOG_ID:t,OL_SILENT:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR=="AUTHORIZE_ERROR"&&this.isDesktop()&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR])}}}),this)});this.BXIM.messenger.writingSendListTimeout[t]=setTimeout(s.delegate((function(){this.endSendWriting(t)}),this),3e4)}};t.prototype.endSendWriting=function(e){clearTimeout(this.BXIM.messenger.writingSendListTimeout[e]);this.BXIM.messenger.writingSendList[e]=false};t.prototype.countWriting=function(e){var s=0;if(this.BXIM.messenger.writingList[e]){if(typeof this.BXIM.messenger.writingList[e]=="object"){for(var t in this.BXIM.messenger.writingList[e]){if(this.BXIM.messenger.writingList[e].hasOwnProperty(t)){s++}}}else{s=1}}return s};t.prototype.leaveFromChat=function(e,t){if(!this.BXIM.messenger.chat[e])return false;t=t!=false;if(!t){if(this.BXIM.messenger.chat[e].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.userInChat[e];delete this.BXIM.messenger.unreadMessage["chat"+e];delete this.BXIM.messenger.showMessage["chat"+e];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}}else{for(var r=0;r<this.BXIM.messenger.userInChat[e].length;r++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e][r])){delete this.BXIM.messenger.userInChat[e][r];break}}this.BXIM.messenger.dialogStatusRedraw();delete this.BXIM.messenger.unreadMessage["chat"+e];delete this.BXIM.messenger.showMessage["chat"+e]}this.recentListHide("chat"+e,false);this.userListRedraw();this.BXIM.messenger.updateMessageCount();this.BXIM.updateCounter()}else{if(s.MessengerProxy){s.MessengerProxy.sendLeaveChatEvent("chat"+e)}s.ajax({url:this.BXIM.pathToAjax+"?CHAT_LEAVE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_CHAT_LEAVE:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){if(e.ERROR==""){this.readMessage("chat"+e.CHAT_ID,true,false);if(!this.BXIM.messenger.chat[e.CHAT_ID]||this.BXIM.messenger.chat[e.CHAT_ID].type!="open"||this.BXIM.messenger.users[this.BXIM.userId].extranet){delete this.BXIM.messenger.showMessage[e.CHAT_ID];delete this.BXIM.messenger.userInChat[e.CHAT_ID];delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];delete this.BXIM.messenger.chat[e.CHAT_ID];if(this.BXIM.messenger.popupMessenger!=null){if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);this.BXIM.messenger.extraClose()}}}else{for(var t=0;t<this.BXIM.messenger.userInChat[e.CHAT_ID].length;t++){if(this.BXIM.userId==parseInt(this.BXIM.messenger.userInChat[e.CHAT_ID][t])){delete this.BXIM.messenger.userInChat[e.CHAT_ID][t];break}}delete this.BXIM.messenger.unreadMessage[e.CHAT_ID];this.BXIM.messenger.dialogStatusRedraw()}this.recentListHide("chat"+e.CHAT_ID,false);this.userListRedraw();s.localStorage.set("mcl",e.CHAT_ID,5);this.BXIM.messenger.updateMessageCount();this.BXIM.updateCounter()}}),this)})}};t.prototype.isSlider=function(){return location.href.toString().indexOf("SIDE_SLIDER")>0};t.prototype.closeSlider=function(){if(!this.isSlider()){return false}s.SidePanel.Instance.close();return true};t.prototype.reloadDialogOL=function(){for(var e in this.BXIM.messenger.chat){if(this.BXIM.messenger.chat.hasOwnProperty(e)){if(typeof e!="undefined"&&this.BXIM.messenger.chat[e].type==="lines"){delete this.BXIM.messenger.userInChat[e];delete this.BXIM.messenger.unreadMessage["chat"+e];delete this.BXIM.messenger.showMessage["chat"+e]}}}};t.prototype.dialogCloseCurrent=function(e){if(this.closeSlider()){return true}this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()};t.prototype.pullEvent=function(){if(typeof s.PULL==="undefined"||!this.BXIM.ppServerStatus){return false}var t=s.delegate((function(t,r,i){if(this.isMobile()){this.BXIM.checkRevision(i.revision_im_mobile)}else{this.BXIM.checkRevision(i.revision_im_web)}if(t=="generalChatId"){this.BXIM.messenger.generalChatId=r.id}else if(t=="generalChatAccess"){if(this.BXIM.messenger.canSendMessageGeneralChat&&r.status=="blocked"){if(this.MobileActionEqual("DIALOG")){this.BXIM.messenger.canSendMessageGeneralChat=false;if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.redrawChatHeader({userRedraw:false})}}}else if(this.isMobile()&&this.MobileActionEqual("DIALOG")){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}else if(this.isDesktop()){console.log("NOTICE: Window reload, because CHANGE ALLOW OPTIONS for general chat");location.reload()}}else if(t=="settingsUpdate"){for(var a in r){this.BXIM.settings[a]=r[a]}}else if(t=="desktopOffline"){this.BXIM.desktopStatus=false}else if(t=="desktopOnline"){this.BXIM.desktopStatus=true;this.BXIM.desktopVersion=r.version;var n=document.title.match(/^(\((\d+)\)\s)(.*)+/);if(n&&n[1]){document.title=document.title.substr(n[1].length)}}else if(t=="readMessage"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.skipReadMessage=false;this.readMessage(r.dialogId,false,false,true);this.BXIM.dialogDetailCounter[r.dialogId]=r.counter;this.recentListUpdateItem({id:r.dialogId,counter:r.counter});this.recentListRedraw();this.BXIM.messenger.updateMessageCount()}else if(t=="readMessageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.readMessage(r.dialogId,false,false,true);if(r.lines){this.BXIM.linesDetailCounter[r.dialogId]=r.muted?0:r.counter}else{this.BXIM.dialogDetailCounter[r.dialogId]=r.muted?0:r.counter}this.recentListUpdateItem({id:r.dialogId,counter:r.counter});this.recentListRedraw();this.BXIM.messenger.updateMessageCount()}else if(t=="unreadMessage"||t=="unreadMessageChat"){if(r.lines){this.BXIM.linesDetailCounter[r.dialogId]=r.muted?0:r.counter}else{this.BXIM.dialogDetailCounter[r.dialogId]=r.muted?0:r.counter}this.recentListUpdateItem({id:r.dialogId,counter:r.counter});this.recentListRedraw();this.BXIM.messenger.updateMessageCount()}else if(t=="readAllChats"){this.BXIM.messenger.recent.forEach((function(e){e.counter=0}));this.recentListRedraw();this.BXIM.messenger.updateMessageCount()}else if(t=="readMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}this.BXIM.messenger.readedList["chat"+r.chatId][r.userId]={messageId:r.lastId,date:new Date(r.date)};this.recentListElementStatusChange(r.dialogId,r.chatMessageStatus);this.drawReadMessageChat("chat"+r.chatId)}else if(t=="readMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;this.drawReadMessage(r.userId,r.lastId,new Date(r.date));if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var o=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(o)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=o?". "+o:""}}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var o=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(o)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=o?". "+o:""}}}this.recentListElementStatusChange(r.dialogId,r.chatMessageStatus)}else if(t=="unreadMessageOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;var l=this.BXIM.messenger.popupMessengerBodyWrap?this.BXIM.messenger.popupMessengerBodyWrap.lastChild:null;if(l&&s.hasClass(l,"bx-messenger-content-item-notify")){if(r.userId==this.BXIM.messenger.currentTab||!this.countWriting(this.BXIM.messenger.currentTab)){s.remove(l)}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var o=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(o)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=o?". "+o:""}}}this.recentListElementStatusChange(r.dialogId,r.chatMessageStatus)}else if(t=="unreadMessageChatOpponent"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!this.BXIM.messenger.readedList["chat"+r.chatId]){this.BXIM.messenger.readedList["chat"+r.chatId]={}}delete this.BXIM.messenger.readedList["chat"+r.chatId][r.userId];this.drawReadMessageChat("chat"+r.chatId);if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var o=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(o)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=o?". "+o:""}}}this.recentListElementStatusChange(r.dialogId,r.chatMessageStatus)}else if(t=="startWriting"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(this.isBot(r.userId)&&!r.DEFERRED&&this.BXIM.messenger.showMessage[r.dialogId]&&this.BXIM.messenger.showMessage[r.dialogId].length){var m=this.BXIM.messenger.bot[r.userId];if(m.type=="human"){var h=s.clone({command:t,params:r,extra:i});setTimeout(s.delegate((function(){h.params.DEFERRED=true;if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[h])}else{s.onCustomEvent(e,"onPullEvent-im",[h.command,h.params,h.extra])}}),this),1e3);return false}}if(typeof this.BXIM.messenger.users[r.userId]!="undefined"){this.BXIM.messenger.users[r.userId].idle=false;this.BXIM.messenger.users[r.userId].last_activity_date=new Date;if(this.BXIM.messenger.currentTab.toString()==r.userId.toString()){var o=s.MessengerCommon.getUserLastDate(this.BXIM.messenger.users[r.userId]);if(this.isMobile()){BXMobileApp.UI.Page.TopBar.title.setDetailText(o)}else if(this.BXIM.messenger.popupMessengerPanelLastDate){this.BXIM.messenger.popupMessengerPanelLastDate.innerHTML=o?". "+o:""}}}this.startWriting(r.userId,r.dialogId,r.userName)}else if(t=="message"||t=="messageChat"){if(this.MobileActionNotEqual("RECENT","DIALOG"))return false;if(!r.deferred&&this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=r.message.id){return false}if(r.message.senderId!=this.BXIM.userId){s.onCustomEvent("onImMessageReceive",[{command:t,params:r}])}if(this.sendBotCommandBlock[r.message.senderId]){for(var g in this.sendBotCommandBlock[r.message.senderId]){delete this.sendBotCommandBlock[r.message.senderId][g];var p=s("im-message-keyboard-"+g);if(p){var c=s.findChildrenByClassName(p,"bx-messenger-keyboard-button-block",false);for(var a=0;a<c.length;a++){s.removeClass(c[a],"bx-messenger-keyboard-button-progress");s.removeClass(c[a],"bx-messenger-keyboard-button-block")}}}}if(this.isBot(r.message.senderId)&&!r.deferred&&this.BXIM.messenger.showMessage[r.dialogId]&&this.BXIM.messenger.showMessage[r.dialogId].length){var m=this.BXIM.messenger.bot[r.message.senderId];if(m.type=="human"){if(r.chat[r.dialogId]&&r.chat[r.dialogId].entity_type=="LINES"){d=1e3}else{var d=r.message.text.split(" ").length*300+1e3;if(d>5e3){d=5e3}}var h=s.clone({command:t,params:r,extra:i,waitTime:d});setTimeout(s.delegate((function(){h.params.deferred=true;if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[h])}else{s.onCustomEvent(e,"onPullEvent-im",[h.command,h.params,h.extra])}}),this),d);return false}}if(r.chatId&&this.BXIM.messenger.linesWritingList[r.chatId]){var I=this.BXIM.messenger.linesWritingList[r.chatId].id;var u=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+I);if(u){s.remove(u);delete this.BXIM.messenger.linesWritingList[r.chatId]}}var M={};M.SHOW_NEW_MESSAGE=!(r.message.params&&r.message.params.NOTIFY==="N");M.MESSAGE={};M.USERS_MESSAGE={};r.message.date=new Date(r.message.date);for(var a in r.chat){r.chat[a].date_create=new Date(r.chat[a].date_create);this.BXIM.messenger.chat[a]=r.chat[a]}for(var a in r.userInChat){this.BXIM.messenger.userInChat[a]=r.userInChat[a]}for(var a in r.userBlockChat){this.BXIM.messenger.userChatBlockStatus[a]=r.userBlockChat[a]}var f={};for(var a in r.users){if(this.BXIM.messenger.users[a]&&this.BXIM.messenger.users[a].status!=r.users[a].status&&Math.round(r.message.date.getTime()/1e3)+180>Math.round(new Date/1e3)){f[a]=this.BXIM.messenger.users[a].status;this.BXIM.messenger.users[a].status=r.users[a].status}}if(this.MobileActionEqual("RECENT")){for(var a in f){if(!this.BXIM.messenger.users[a])continue;var B=s.findChildrenByClassName(this.BXIM.messenger.recentListExternal,"bx-messenger-cl-id-"+a);if(B!=null){for(var X=0;X<B.length;X++){var b=s.MessengerCommon.getUserStatus(this.BXIM.messenger.users[a]);s.removeClass(B[X],"bx-messenger-cl-status-"+f[a]);s.addClass(B[X],"bx-messenger-cl-status-"+b);B[X].setAttribute("data-status",b)}}var B=s.findChildrenByClassName(this.BXIM.messenger.popupContactListElementsWrap,"bx-messenger-cl-id-"+a);if(B!=null){for(var X=0;X<B.length;X++){var b=s.MessengerCommon.getUserStatus(this.BXIM.messenger.users[a]);s.removeClass(B[X],"bx-messenger-cl-status-"+f[a]);s.addClass(B[X],"bx-messenger-cl-status-"+b);B[X].setAttribute("data-status",b)}}}}B=null;M.USERS=r.users;if(this.MobileActionEqual("DIALOG")){for(var a in r.files){if(!this.BXIM.disk.files[r.chatId])this.BXIM.disk.files[r.chatId]={};if(this.BXIM.disk.files[r.chatId][a])continue;r.files[a].date=new Date(r.files[a].date);this.BXIM.disk.files[r.chatId][a]=r.files[a]}}if((r.message.templateFileId||r.message.templateId)&&r.chatId&&this.BXIM.messenger.message[r.message.templateId]){this.clearProgessMessage(r.message.templateId);if(s("im-message-"+r.message.templateId)){s("im-message-"+r.message.templateId).id="im-message-"+r.message.id;var E=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+r.message.templateId}},true);if(E){E.setAttribute("data-messageid",""+r.message.id+"");if(E.getAttribute("data-blockmessageid")==""+r.message.templateId){E.setAttribute("data-blockmessageid",""+r.message.id+"")}s.removeClass(E,"bx-messenger-content-item-id-"+r.message.templateId);s.addClass(E,"bx-messenger-content-item-id-"+r.message.id);s.removeClass(E,"bx-messenger-content-item-content-progress")}else{var C=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.message.templateId}},true);if(C){C.setAttribute("data-blockmessageid",""+r.message.id+"")}}}var p=s("im-message-keyboard-"+r.message.templateId);if(p){p.id="im-message-keyboard-"+r.message.id}else{p=s("im-message-keyboard-empty-"+r.message.templateId);if(p){p.id="im-message-keyboard-empty-"+r.message.id}}this.BXIM.messenger.message[r.message.id]=r.message;delete this.BXIM.messenger.message[r.message.templateId];if(!this.BXIM.messenger.showMessage[r.dialogId]){this.BXIM.messenger.showMessage[r.dialogId]=[]}this.BXIM.messenger.showMessage[r.dialogId]=this.BXIM.messenger.showMessage[r.dialogId].filter((function(e){return e!=r.message.templateId&&e!=r.message.id}));this.BXIM.messenger.showMessage[r.dialogId].push(r.message.id.toString());if(r.message.templateFileId){this.BXIM.disk.files[r.chatId][r.message.templateFileId]=r.files[r.message.params.FILE_ID[0]];this.diskRedrawFile(r.chatId,r.message.templateFileId)}var _=s("im-message-"+r.message.id);_.innerHTML=this.prepareText(r.message.text,true,true,true);if(r.message.params){if(r.message.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(r.message.params.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile){s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}else{s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}if(r.message.params.ATTACH){var S=s.MessengerCommon.drawAttach(r.message.id,this.BXIM.messenger.message[r.message.id].chatId,r.message.params.ATTACH);if(_.nextElementSibling&&s.hasClass(_.nextElementSibling,"bx-messenger-attach-box")){_.nextElementSibling.innerHTML="";if(S.length>0){s.adjust(_.nextElementSibling,{children:S})}}else if(S.length>0){S=s.create("div",{props:{className:"bx-messenger-attach-box"},children:S});if(_.nextElementSibling){_.parentNode.insertBefore(S,_.nextElementSibling)}else{_.parentNode.appendChild(S)}}}}}else{M.MESSAGE[r.message.id]=r.message}this.BXIM.lastRecordId=parseInt(r.message.id)>this.BXIM.lastRecordId?parseInt(r.message.id):this.BXIM.lastRecordId;var T=r.message.text;if(!T||T.length<=0){if(r.message.params&&r.message.params.FILE_ID&&r.message.params.FILE_ID.length>0){T="["+s.message("IM_F_FILE")+"]"}else if(r.message.params&&r.message.params.ATTACH&&r.message.params.ATTACH.length>0){T="["+s.message("IM_F_ATTACH")+"]"}else{T=s.message("IM_M_DELETED")}}if(r.message.senderId==this.BXIM.userId){if(this.isMobile()){if(r.message.params["FILE_ID"]&&r.message.params["FILE_ID"].length>0){var v=false;r.message.params["FILE_ID"].forEach(function(e){if(this.BXIM.disk.messageBlock[e]){delete this.BXIM.disk.messageBlock[e];v=true}}.bind(this));if(v){return}}}this.readMessage(r.message.recipientId,false,false);M.USERS_MESSAGE[r.message.recipientId]=[r.message.id];this.updateStateVar(M);var y=r.lines||null;if(y){r.lines.date_create=new Date(r.lines.date_create)}this.recentListAddItem({id:r.dialogId,chat_id:r.chatId,counter:r.counter,lines:r.lines,message:{id:r.message.id,date:r.message.date,author_id:r.message.senderId,status:"received",text:s.util.htmlspecialchars(r.message.textOriginal),attach:r.message.params&&r.message.params.ATTACH?r.message.params.ATTACH.length>0:false,file:r.message.params&&r.message.params.FILE_ID?r.message.params.FILE_ID.length>0:false}});this.recentListRedraw();this.BXIM.messenger.updateMessageCount()}else{M.UNREAD_MESSAGE={};M.UNREAD_MESSAGE[r.dialogId]=[r.message.id];M.USERS_MESSAGE[r.dialogId]=[r.message.id];if(t=="message")this.endWriting(r.message.senderId,0,false);else this.endWriting(r.message.senderId,r.message.recipientId,false);var A=null;if(typeof r.message.params.CODE!=="undefined"){if(r.message.params.CODE==="USER_JOIN"&&s.MessengerExternalList&&s.MessengerExternalList.canShowMessage(r.dialogId)){M.SHOW_NEW_MESSAGE=false;A={dialogId:r.dialogId,title:s.util.htmlspecialcharsback(r.users[r.dialogId].name),text:r.message.text}}else if(r.message.params.CODE==="USER_JOIN_GENERAL"&&s.MessengerExternalList&&s.MessengerExternalList.canShowMessage(r.message.senderId)){M.SHOW_NEW_MESSAGE=false;A={dialogId:r.dialogId,title:s.util.htmlspecialcharsback(r.users[r.message.senderId].name),text:r.message.text}}}this.updateStateVar(M);if(t=="messageChat"&&!s.MessengerCommon.userInChat(r.message.chatId)){if(this.isMobile()){var L=this.BXIM.currentTab.toString().substr(0,4)==="chat"&&this.BXIM.messenger.chat[this.BXIM.currentTab.substr(4)]&&this.BXIM.messenger.chat[this.BXIM.currentTab.substr(4)].type==="lines";if(L){s.MessengerCommon.hideLinesKeyboard()}}return}var y=r.lines||null;if(y){r.lines.date_create=new Date(r.lines.date_create)}this.recentListAddItem({id:r.dialogId,chat_id:r.chatId,counter:r.counter,lines:y,message:{id:r.message.id,date:r.message.date,author_id:r.message.senderId,status:"delivered",text:s.util.htmlspecialchars(r.message.textOriginal),attach:r.message.params&&r.message.params.ATTACH?r.message.params.ATTACH.length>0:false,file:r.message.params&&r.message.params.FILE_ID?r.message.params.FILE_ID.length>0:false}});this.recentListRedraw();this.BXIM.messenger.updateMessageCount();if(A&&s.MessengerExternalList){s.MessengerExternalList.showMessage(A)}if(this.BXIM.messenger.currentTab==r.dialogId&&this.BXIM.isFocus()){this.readMessage(r.dialogId,true,true)}}}else if(t=="messageDeleteComplete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.message[r.id])return false;var x=0;if(r.type=="private"){x=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(x,0,false)}else{x="chat"+r.chatId;this.endWriting(r.senderId,x,false)}if(this.BXIM.messenger.currentTab==x&&s("im-message-"+r.id)){var N=s("im-message-"+r.id).parentNode.parentNode.parentNode.parentNode.parentNode;if(N.getAttribute("data-messageId")==N.getAttribute("data-blockMessageId")){s.remove(N)}else{N=s("im-message-"+r.id).parentNode;if(N.nextSibling&&s.hasClass(N.nextSibling,"bx-messenger-hr")){s.remove(N.nextSibling)}else if(!N.nextSibling&&s.hasClass(N.previousSibling,"bx-messenger-hr")){s.remove(N.previousSibling)}s.remove(N)}}this.recentListElementUpdate(x,r.id,r.text);if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw();delete this.BXIM.messenger.message[r.id];this.BXIM.messenger.showMessage[x].sort(s.delegate((function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}}),this))}else if(t=="messageUpdate"||t=="messageDelete"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var R in this.sendBotCommandBlock){if(this.sendBotCommandBlock[R][r.id]){delete this.sendBotCommandBlock[R][r.id];var p=s("im-message-keyboard-"+r.id);if(p){var c=s.findChildrenByClassName(p,"bx-messenger-keyboard-button-block",false);for(var a=0;a<c.length;a++){s.removeClass(c[a],"bx-messenger-keyboard-button-progress");s.removeClass(c[a],"bx-messenger-keyboard-button-block")}}}}if(this.BXIM.messenger.message[r.id]){if(!this.BXIM.messenger.message[r.id].params)this.BXIM.messenger.message[r.id].params={};var x=0;if(t=="messageDelete"){r.text=s.message("IM_M_DELETED");if(!this.BXIM.messenger.message[r.id].params){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.IS_DELETED="Y"}else if(t=="messageUpdate"){this.BXIM.messenger.message[r.id].params=r.params}this.BXIM.messenger.message[r.id].text=s.MessengerCommon.prepareText(r.text,true,true,true);this.BXIM.messenger.message[r.id].textOriginal=r.text;if(r.type=="private"){x=r.fromUserId==this.BXIM.userId&&r.toUserId?r.toUserId:r.fromUserId;this.endWriting(x,0,false)}else{x="chat"+r.chatId;this.endWriting(r.senderId,x,false)}this.recentListElementUpdate(x,r.id,r.text);if(this.BXIM.messenger.currentTab==x&&s("im-message-"+r.id)){var _=s("im-message-"+r.id);if(r.params&&r.params.IS_EDITED=="Y"){s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited")}var w=false;if(t=="messageDelete"){s.addClass(_.parentNode,"bx-messenger-message-deleted");var D=s("im-message-keyboard-"+r.id);s.remove(D);s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else if(t=="messageUpdate"){if(r.params){if(r.params.DATE_TEXT){var O=this.replaceDateText(r.id,this.BXIM.messenger.message[r.id].text,r.params);_.innerHTML=this.prepareText(O,false,true,true);w=true}if(r.params.IS_EDITED=="Y"){s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding")}if(r.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else{s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(r.params.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile){s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}else{s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}if(r.params.ATTACH){var S=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(_.nextElementSibling&&s.hasClass(_.nextElementSibling,"bx-messenger-attach-box")){_.nextElementSibling.innerHTML="";if(S.length>0){s.adjust(_.nextElementSibling,{children:S})}}else if(S.length>0){S=s.create("div",{props:{className:"bx-messenger-attach-box"},children:S});if(_.nextElementSibling){_.parentNode.insertBefore(S,_.nextElementSibling)}else{_.parentNode.appendChild(S)}}}if(r.params.KEYBOARD){var k=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);var p=s("im-message-keyboard-"+r.id);if(!p){p=s("im-message-keyboard-empty-"+r.id);p.id="im-message-keyboard-"+r.id;p.className="bx-messenger-keyboard"}if(p){p.innerHTML=k?k.innerHTML:""}}}else if(typeof r.params!="undefined"&&r.params==""){if(_.nextElementSibling&&s.hasClass(_.nextElementSibling,"bx-messenger-attach-box")){s.remove(_.nextElementSibling)}}}if(!w){_.innerHTML=s.MessengerCommon.prepareText(this.BXIM.messenger.message[r.id].text,true,true,true)}s.addClass(_,"bx-messenger-message-edited-anim");if(_.previousSibling&&(s.hasClass(_.previousSibling,"bx-messenger-file-box")||r.params&&r.params.ATTACH)){s.addClass(_.previousSibling,"bx-messenger-file-box-with-message")}setTimeout(s.delegate((function(){s.removeClass(_,"bx-messenger-message-edited-anim")}),this),1e3)}if(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)this.recentListRedraw()}}else if(t=="messageParamsUpdate"){if(this.MobileActionNotEqual("DIALOG"))return false;if(!this.BXIM.messenger.message[r.id])return false;if(this.BXIM.messenger.message[r.id].params&&this.BXIM.messenger.message[r.id].params.IS_DELETED=="Y")return false;var P=typeof r.animation=="undefined"?null:r.animation;for(var R in this.sendBotCommandBlock){if(this.sendBotCommandBlock[R][r.id]){delete this.sendBotCommandBlock[R][r.id];var p=s("im-message-keyboard-"+r.id);if(p){var c=s.findChildrenByClassName(p,"bx-messenger-keyboard-button-block",false);for(var a=0;a<c.length;a++){s.removeClass(c[a],"bx-messenger-keyboard-button-progress");s.removeClass(c[a],"bx-messenger-keyboard-button-block")}}}}this.BXIM.messenger.message[r.id].params=r.params;if(r.type=="private"){x=r.fromUserId==this.BXIM.userId?r.toUserId:r.fromUserId}else{x="chat"+r.chatId}var _=s("im-message-"+r.id);if(this.BXIM.messenger.currentTab==x&&_){var U=_.parentNode.parentNode.parentNode.parentNode.parentNode;if(r.params){if(r.params.DATE_TEXT){var O=this.replaceDateText(r.id,this.BXIM.messenger.message[r.id].text,r.params);_.innerHTML=this.prepareText(O,false,true,true)}if(r.params.FILE_ID){var H=s.MessengerCommon.diskDrawFiles(this.BXIM.messenger.message[r.id].chatId,r.params.FILE_ID);if(_.previousElementSibling&&s.hasClass(_.previousElementSibling,"bx-messenger-file-box")){_.previousElementSibling.innerHTML="";if(H.length>0){s.adjust(_.previousElementSibling,{children:H})}}else if(H.length>0){var G=r.text!=""||r.params&&r.params.ATTACH;H=s.create("div",{props:{className:"bx-messenger-file-box"+(G?" bx-messenger-file-box-with-message":"")},children:H});if(_.previousElementSibling){_.parentNode.insertBefore(H,_.previousElementSibling)}else{_.parentNode.insertBefore(H,_)}}if((_.innerHTML!=""||r.params&&r.params.ATTACH)&&_.previousElementSibling&&s.hasClass(_.previousElementSibling,"bx-messenger-file-box")){s.addClass(_.previousElementSibling,"bx-messenger-file-box-with-message")}}if(r.params.ATTACH){var S=s.MessengerCommon.drawAttach(r.id,this.BXIM.messenger.message[r.id].chatId,r.params.ATTACH);if(_.nextElementSibling&&s.hasClass(_.nextElementSibling,"bx-messenger-attach-box")){_.nextElementSibling.innerHTML="";if(S.length>0){s.adjust(_.nextElementSibling,{children:S})}}else if(S.length>0){S=s.create("div",{props:{className:"bx-messenger-attach-box"},children:S});if(_.nextElementSibling){_.parentNode.insertBefore(S,_.nextElementSibling)}else{_.parentNode.appendChild(S)}}if(P!="N"){P="Y"}}if(r.params.KEYBOARD){var k=s.MessengerCommon.drawKeyboard(this.BXIM.messenger.currentTab,r.id,r.params.KEYBOARD);var p=s("im-message-keyboard-"+r.id);if(!p){p=s("im-message-keyboard-empty-"+r.id);p.id="im-message-keyboard-"+r.id;p.className="bx-messenger-keyboard"}if(p){p.innerHTML=k?k.innerHTML:""}if(P!="N"){P="Y"}}if(r.params.CHAT_USER||r.params.CHAT_ID||r.params.CHAT_MESSAGE||r.params.CHAT_LAST_DATE){var F=s("im-message-content-reply-"+r.id);var V=s.MessengerCommon.drawMessageReply(r.id);if(F){F.innerHTML=V?V.innerHTML:""}}if(r.params&&r.params.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}else if(r.params&&r.params.URL_ONLY=="N"){s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}if(r.params&&r.params.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile){s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}else if(r.params&&r.params.LARGE_FONT=="N"){s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-large-font")}if(r.params&&r.params.IS_EDITED=="Y"){s.removeClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-without-padding");s.addClass(_.parentNode.parentNode.parentNode.parentNode,"bx-messenger-message-edited");if(P!="N"){P="Y"}}}else if(typeof r.params!="undefined"&&r.params==""){if(_.nextElementSibling&&s.hasClass(_.nextElementSibling,"bx-messenger-attach-box")){s.remove(_.nextElementSibling);if(P!="N"){P="Y"}}}if(r.params&&typeof r.params.CLASS!="undefined"){var W=s.findParent(_,{className:"bx-messenger-content-item"});s.addClass(W,r.params.CLASS)}if(r.params&&r.params.IS_DELIVERED){if(r.params.IS_DELIVERED=="N"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params&&r.params.SENDING){if(r.params.SENDING=="Y"){this.drawProgessMessage(r.id)}else{this.clearProgessMessage(r.id)}}if(r.params.IMOL_SID&&parseInt(r.params.IMOL_SID)>0){var j=s.findChildByClassName(U,"bx-messenger-message-extra");if(!j){U.insertBefore(s.create("div",{props:{className:"bx-messenger-message-extra"},html:s.message("IM_OL_DIALOG_NUMBER").replace("#NUMBER#",r.params.IMOL_SID)}),U.firstChild);if(this.isElementVisibleOnScreen(U,BXIM.messenger.popupMessengerBody)){this.linesBodyScroll()}}}if(r.params.IMOL_FORM&&this.BXIM.messenger.chat[r.chatId]&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var Y=r.params.IMOL_FORM.toString().substr(-6)=="-delay";var K=Y?r.params.IMOL_FORM.substr(0,r.params.IMOL_FORM.lastIndexOf("-delay")):r.params.IMOL_FORM;if(this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid<r.id&&this.BXIM.messenger.popupMessengerLiveChatFormType!=K){this.BXIM.messenger.popupMessengerLiveChatDelayedFormMid=r.id;this.BXIM.messenger.linesLivechatFormHide();clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate((function(){this.BXIM.messenger.linesLivechatFormShow(K)}),this),Y?3e4:5e3)}}if(r.params.IMOL_VOTE&&_){var J=this.linesVoteDraw(r.id);if(J){s.cleanNode(_);_.appendChild(J)}if(P!="N"){P="Y"}}else if(typeof r.params.IMOL_VOTE_SID!="undefined"&&_){var T=s.findChildByClassName(_,"bx-messenger-content-item-vote-message-text");if(T){var J=this.linesVoteResultDraw(r.id,T.innerHTML);if(J){s.cleanNode(_);_.appendChild(J)}}}if(P=="Y"){s.addClass(_,"bx-messenger-message-edited-anim");setTimeout(s.delegate((function(){s.removeClass(_,"bx-messenger-message-edited-anim")}),this),1e3)}}}else if(t=="messageLike"){if(this.MobileActionNotEqual("DIALOG"))return false;var q=s.util.in_array(this.BXIM.userId,r.users);var Q=r.users.length>0?r.users.length:"";if(!this.BXIM.messenger.message[r.id]){return false}if(typeof this.BXIM.messenger.message[r.id].params!="object"){this.BXIM.messenger.message[r.id].params={}}this.BXIM.messenger.message[r.id].params.LIKE=r.users;if(s("im-message-"+r.id)){var E=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+r.id+""}},false);if(E){var z=s.findChildByClassName(E,"bx-messenger-content-item-like");if(z){var $=s.findChildByClassName(z,"bx-messenger-content-like-digit",false);var Z=s.findChildByClassName(z,"bx-messenger-content-like-button",false);if(q){s.addClass(z,"bx-messenger-content-item-liked")}else{s.removeClass(z,"bx-messenger-content-item-liked")}if(Q>0){$.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass($.parentNode,"bx-messenger-content-like-digit-off")}else{$.setAttribute("title","");s.addClass($.parentNode,"bx-messenger-content-like-digit-off")}if($.innerHTML<Q){var ee=s.findChildByClassName(E,"bx-messenger-content-item-content",false);s.addClass(ee,"bx-messenger-content-item-plus-like");setTimeout((function(){s.removeClass(ee,"bx-messenger-content-item-plus-like")}),500)}$.innerHTML=Q}}}}else if(t=="promotionRead"){if(s.MessengerPromo){s.MessengerPromo.read(r.id)}}else if(t=="fileUpload"){if(this.MobileActionNotEqual("DIALOG"))return false;if(this.BXIM.disk.filesProgress[r.fileTmpId])return false;r.fileParams.date=new Date(r.fileParams.date);if(this.BXIM.disk.files[r.fileChatId]&&this.BXIM.disk.files[r.fileChatId][r.fileId]){r.fileParams["preview"]=this.BXIM.disk.files[r.fileChatId][r.fileId]["preview"]}if(!this.BXIM.disk.files[r.fileChatId])this.BXIM.disk.files[r.fileChatId]={};this.BXIM.disk.files[r.fileChatId][r.fileId]=r.fileParams;this.diskRedrawFile(r.fileChatId,r.fileId);if(this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate((function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll}),this)})).animate()}else if(this.BXIM.messenger.popupMessengerBody){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}else if(t=="fileUnRegister"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var se in r.files){if(this.BXIM.disk.filesRegister[r.chatId]){delete this.BXIM.disk.filesRegister[r.chatId][r.files[se]]}if(this.BXIM.disk.files[r.chatId]&&this.BXIM.disk.files[r.chatId][r.files[se]]){this.BXIM.disk.files[r.chatId][r.files[se]].status="error";s.MessengerCommon.diskRedrawFile(r.chatId,r.files[se])}delete this.BXIM.disk.filesProgress[se]}this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="fileDelete"){if(this.MobileActionNotEqual("DIALOG"))return false;delete this.BXIM.disk.files[r.chatId][r.fileId];this.drawTab(this.getRecipientByChatId(r.chatId))}else if(t=="dialogChange"){if(!this.BXIM.isOpen()||!this.BXIM.isFocus()){return false}this.BXIM.openMessenger(r.dialogId)}else if(t=="chatRename"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].name=s.util.htmlspecialchars(r.name);this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatAvatar"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.BXIM.messenger.updateChatAvatar(r.chatId,r.avatar)}else if(t=="chatChangeColor"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId].color=r.color;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatHide"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;this.recentListHide(r.dialogId,false);if(!this.isMobile()&&r.dialogId==this.BXIM.messenger.currentTab){s.MessengerCommon.dialogCloseCurrent()}this.BXIM.messenger.updateMessageCount()}else if(t=="chatShow"){if(this.MobileActionNotEqual("DIALOG","RECENT")){return false}var te=this.recentListElementFormat(r);delete this.BXIM.messenger.showMessage[te.id];delete this.BXIM.messenger.history[te.id];if(!this.isMobile()&&r.id==this.BXIM.messenger.currentTab){this.BXIM.messenger.openMessenger(r.id)}this.recentListAddItem(te);this.recentListRedraw();this.BXIM.messenger.updateMessageCount();var re=s.MessengerCalls&&s.MessengerCalls.hasActiveSharing();if(this.BXIM.settings.status!="dnd"&&this.BXIM.notify.muteModeCode<=0&&!re&&te.message.id>0&&!this.BXIM.messenger.message[te.message.id]&&te.counter>0){this.BXIM.messenger.message[te.message.id]={id:te.message.id,chatId:te.chat_id,date:te.message.date,messageType:te.type==="user"?"P":te.lines?"L":"C",params:{},recipientId:te.id,senderId:te.message.author_id,text:te.message.text,textOriginal:te.message.text,fake:true};if(!this.BXIM.messenger.flashMessage[te.id]){this.BXIM.messenger.flashMessage[te.id]={}}this.BXIM.messenger.flashMessage[te.id][te.message.id]=true;this.BXIM.messenger.newMessage()}}else if(t=="chatMuteNotify"){if(r.lines){this.BXIM.linesDetailCounter[r.dialogId]=r.muted?0:r.counter}else{this.BXIM.dialogDetailCounter[r.dialogId]=r.muted?0:r.counter}this.BXIM.messenger.updateMessageCount();this.muteMessageChat(r.dialogId,r.mute,false)}else if(t=="chatPin"){if(this.MobileActionNotEqual("RECENT"))return false;this.recentListElementPin(r.dialogId,r.active)}else if(t=="chatUnread"){if(r.lines){this.BXIM.linesDetailCounter[r.dialogId]=r.muted?0:r.counter?r.counter:1}else{this.BXIM.dialogDetailCounter[r.dialogId]=r.muted?0:r.counter?r.counter:1}this.recentListUpdateItem({id:r.dialogId,unread:r.active});this.recentListRedraw();this.BXIM.messenger.updateMessageCount()}else if(t=="chatUserAdd"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;for(var a in r.users){r.users[a].last_activity_date=r.users[a].last_activity_date?new Date(r.users[a].last_activity_date):false;r.users[a].mobile_last_date=r.users[a].mobile_last_date?new Date(r.users[a].mobile_last_date):false;r.users[a].idle=r.users[a].idle?new Date(r.users[a].idle):false;r.users[a].absent=r.users[a].absent?new Date(r.users[a].absent):false;this.BXIM.messenger.users[a]=r.users[a]}if(!this.BXIM.messenger.chat[r.chatId]){this.BXIM.messenger.chat[r.chatId]={id:r.chatId,name:r.chatId,owner:r.chatOwner,extranet:r.chatExtranet,fake:true,date_create:""}}else{this.BXIM.messenger.chat[r.chatId].extranet=r.chatExtranet;if(this.BXIM.messenger.userInChat[r.chatId]){for(a=0;a<r.newUsers.length;a++)this.BXIM.messenger.userInChat[r.chatId].push(r.newUsers[a])}else this.BXIM.messenger.userInChat[r.chatId]=r.newUsers;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatOwner"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[r.chatId])return false;this.BXIM.messenger.chat[r.chatId].owner=r.userId;if(!this.isMobile()&&this.BXIM.messenger.currentTab=="chat"+r.chatId){this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatManagers"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[r.chatId])return false;this.BXIM.messenger.chat[r.chatId].manager_list=r.list;if(this.BXIM.messenger.currentTab==r.dialogId){this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatUserLeave"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(r.userId==this.BXIM.userId){this.readMessage("chat"+r.chatId,true,false,true);this.leaveFromChat(r.chatId,false);if(this.BXIM.callController&&this.BXIM.callController.hasActiveCall()&&this.BXIM.callController.currentCall.associatedEntity.id=="chat"+r.chatId){this.BXIM.callController.currentCall.hangup()}}else if(this.MobileActionEqual("DIALOG")){if(!this.BXIM.messenger.chat[r.chatId]||!this.BXIM.messenger.userInChat[r.chatId])return false;var ie=[];for(var a=0;a<this.BXIM.messenger.userInChat[r.chatId].length;a++)if(this.BXIM.messenger.userInChat[r.chatId][a]!=r.userId)ie.push(this.BXIM.messenger.userInChat[r.chatId][a]);this.BXIM.messenger.userInChat[r.chatId]=ie;this.BXIM.messenger.redrawChatHeader()}}else if(t=="chatUpdateParams"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[r.chatId])return false;for(var ae in r.params){if(!r.params.hasOwnProperty(ae)){continue}this.BXIM.messenger.chat[r.chatId][ae]=r.params[ae];if(ae=="entity_data_1"&&this.BXIM.messenger.chat[r.chatId].type=="livechat"){var ne=this.livechatGetSession(r.chatId);ne.readedTime=ne.readedTime?new Date(ne.readedTime):false;this.drawReadMessage("chat"+r.chatId,ne.readedId,ne.readedTime);if(ne.showForm=="N"){if(!this.BXIM.messenger.popupMessengerLiveChatLastSend||this.BXIM.messenger.popupMessengerLiveChatLastSend+1e3<+new Date){this.BXIM.messenger.linesLivechatFormHide()}}}}if(this.BXIM.messenger.currentTab==r.dialogId){this.BXIM.messenger.redrawChatHeader()}if(this.MobileActionEqual("RECENT")&&(this.BXIM.messenger.recentList||this.BXIM.messenger.recentListExternal)){this.recentListRedraw()}}else if(t=="botAdd"||t=="botUpdate"){if(this.BXIM.userExtranet)return false;this.BXIM.messenger.bot[r.bot.id]=r.bot;r.user.last_activity_date=r.user.last_activity_date?new Date(r.user.last_activity_date):false;r.user.mobile_last_date=r.user.mobile_last_date?new Date(r.user.mobile_last_date):false;r.user.idle=r.user.idle?new Date(r.user.idle):false;r.user.absent=r.user.absent?new Date(r.user.absent):false;this.BXIM.messenger.users[r.user.id]=r.user;if(typeof r.userInGroup!="undefined"){for(var a in r.userInGroup){if(typeof this.BXIM.messenger.userInGroup[a]=="undefined"||typeof this.BXIM.messenger.userInGroup[a].users=="undefined"||!this.BXIM.messenger.userInGroup[a].users.length){this.BXIM.messenger.userInGroup[a]=r.userInGroup[a]}else{for(var X=0;X<r.userInGroup[a].users.length;X++)this.BXIM.messenger.userInGroup[a].users.push(r.userInGroup[a].users[X]);this.BXIM.messenger.userInGroup[a].users=s.util.array_unique(this.BXIM.messenger.userInGroup[a].users)}}}}else if(t=="botDelete"){if(this.BXIM.messenger.bot[r.botId]){delete this.BXIM.messenger.bot[r.botId]}if(this.BXIM.messenger.users[r.botId]){delete this.BXIM.messenger.users[r.botId]}this.recentListHide(r.botId,false);if(this.BXIM.messenger.currentTab==r.botId){this.BXIM.messenger.openMessenger("general")}}else if(t=="userInvite"){if(!this.BXIM.settings.viewCommonUsers){return false}this.BXIM.messenger.users[r.user.id]=r.user;this.recentListAddItem({id:r.user.id,invited:r.invited,message:{text:""}});this.recentListRedraw()}else if(t=="userUpdate"||t=="updateUser"){r.user.last_activity_date=r.user.last_activity_date?new Date(r.user.last_activity_date):false;r.user.mobile_last_date=r.user.mobile_last_date?new Date(r.user.mobile_last_date):false;r.user.idle=r.user.idle?new Date(r.user.idle):false;r.user.absent=r.user.absent?new Date(r.user.absent):false;this.BXIM.messenger.users[r.user.id]=r.user;this.BXIM.messenger.redrawChatHeader()}else if(t=="notifyAdd"){if(this.MobileActionNotEqual("NOTIFY"))return false;r.date=new Date(r.date);r.text=s.MessengerCommon.prepareText(r.text,true,true,false);var M={};M.UNREAD_NOTIFY={};M.UNREAD_NOTIFY[r.id]=[r.id];this.BXIM.messenger.notify.notify[r.id]=r;if(this.BXIM.ppStatus&&!this.BXIM.ppServerStatus&&this.BXIM.lastRecordId>=r.message.id){this.BXIM.messenger.notify.flashNotify[r.id]=false}else{this.BXIM.messenger.notify.flashNotify[r.id]=r.silent!="Y"}if(r.settingName=="im|like"&&r.originalTag.substr(0,10)=="RATING|IM|"){var oe=r.originalTag.split("|");if(this.BXIM.messenger.message[oe[4]]&&this.BXIM.messenger.message[oe[4]].recipientId==this.BXIM.messenger.currentTab&&this.BXIM.windowFocus){delete M.UNREAD_NOTIFY[r.id];this.BXIM.notify.flashNotify[r.id]=false}}this.BXIM.notify.changeUnreadNotify(M.UNREAD_NOTIFY,true,r.silent=="N");this.BXIM.lastRecordId=parseInt(r.id)>this.BXIM.lastRecordId?parseInt(r.id):this.BXIM.lastRecordId}else if(t=="notifyRead"){if(this.MobileActionNotEqual("NOTIFY"))return false;this.BXIM.notify.initNotifyCount=r.counter;this.BXIM.notify.notifyCount=r.counter;r.list.forEach(function(e){delete this.BXIM.notify.unreadNotify[e]}.bind(this));this.BXIM.notify.viewNotifyMarkupUpdate();this.BXIM.notify.updateNotifyCount(false)}else if(t=="notifyConfirm"){if(this.MobileActionNotEqual("NOTIFY"))return false;var le=parseInt(r.id);if(this.BXIM.notify.notify[le]){if(this.isMobile()){delete this.BXIM.notify.notify[le]}else{this.BXIM.notify.notify[le].confirmMessages=r.confirmMessages}}delete this.BXIM.notify.unreadNotify[le];delete this.BXIM.notify.flashNotify[le];this.BXIM.notify.updateNotifyCount(false);if(this.BXIM.messenger.popupMessenger!=null&&this.BXIM.notifyOpen)this.BXIM.notify.openNotify(true)}else if(t=="notifyUnread"){if(this.MobileActionNotEqual("NOTIFY"))return false;r.list.forEach(function(e){this.BXIM.notify.viewNotify(e,false,false)}.bind(this))}else if(t=="commandDelete"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.command.length;a++){if(!this.BXIM.messenger.command[a]||this.BXIM.messenger.command[a].id!=r.commandId){continue}delete this.BXIM.messenger.command[a];if(this.commandPopup!=null){this.commandPopup.destroy()}break}}else if(t=="appDeleteIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.textareaIcon.length;a++){if(!this.BXIM.messenger.textareaIcon[a]||this.BXIM.messenger.textareaIcon[a].id!=r.iconId){continue}delete this.BXIM.messenger.textareaIcon[a];if(this.popupSmileMenu!=null){this.popupSmileMenu.destroy()}s.MessengerSupport24.closePopup();var E=s.findChildByClassName(this.BXIM.messenger.popupMessengerTextareaIconBox,"bx-messenger-textarea-icon-marketplace-"+r.iconId,true);if(E){s.remove(E)}break}}else if(t=="appUpdateIcon"){if(this.MobileActionNotEqual("DIALOG"))return false;for(var a=0;a<this.BXIM.messenger.textareaIcon.length;a++){if(!this.BXIM.messenger.textareaIcon[a]||this.BXIM.messenger.textareaIcon[a].id!=r.iconId){continue}if(r.context){this.BXIM.messenger.textareaIcon[a].context=r.context}if(r.js){this.BXIM.messenger.textareaIcon[a].js=r.js}if(r.iframe){this.BXIM.messenger.textareaIcon[a].iframe=r.iframe}if(r.iframeWidth){this.BXIM.messenger.textareaIcon[a].iframeWidth=r.iframeWidth}if(r.iframeHeight){this.BXIM.messenger.textareaIcon[a].iframeHeight=r.iframeHeight}if(r.userId!=this.BXIM.userId&&this.popupSmileMenu!=null){this.popupIframeMenu.destroy()}break}}}),this);var r=s.delegate((function(e,s){if(this.isMobile()){s=e.params;e=e.command}if(e=="list"||e=="userStatus"){var t=[];for(var r in s.users){t.push(s.users[r])}this.userChangeStatus(t)}}),this);var i=s.delegate((function(e,s){if(this.isMobile()){s=e.params;e=e.command}if(e=="linesAnswer"){if(this.MobileActionNotEqual("DIALOG","RECENT"))return false;if(!this.BXIM.messenger.chat[s.chatId])return false;this.BXIM.messenger.chat[s.chatId].owner=this.BXIM.userId;this.BXIM.messenger.redrawChatHeader();if(this.BXIM.messenger.popupMessengerTextarea){this.BXIM.messenger.popupMessengerTextarea.focus()}}else if(e=="queueItemUpdate"){if(typeof this.BXIM.messenger.openlines=="undefined"){this.BXIM.messenger.openlines.queue=[s]}else{var t=true;for(var r=0,i=this.BXIM.messenger.openlines.queue.length;r<i;r++){if(this.BXIM.messenger.openlines.queue[r].id==s.id){this.BXIM.messenger.openlines.queue[r].name=s.name;this.BXIM.messenger.openlines.queue[r].priority=s.priority;this.BXIM.messenger.openlines.queue[r].queue_type=s.queue_type;t=false;break}}if(t){this.BXIM.messenger.openlines.queue.push(s)}}}else if(e=="queueItemDelete"){if(typeof this.BXIM.messenger.openlines=="undefined"||this.BXIM.messenger.openlines.queue.length<=0)return true;var a=[];for(var r=0,i=this.BXIM.messenger.openlines.queue.length;r<i;r++){if(this.BXIM.messenger.openlines.queue[r].id!=s.id){a.push(this.BXIM.messenger.openlines.queue[r])}}this.BXIM.messenger.openlines.queue=a}else if(e=="updateSessionStatus"){this.recentListUpdateItem({id:"chat"+s.chatId,lines:{status:s.status}});this.recentListRedraw()}}),this);if(this.isMobile()){console.warn("MOBILE!");BXMobileApp.addCustomEvent("onPull-im",s.delegate((function(e){console.log(e);var s=e.data;if(typeof s=="undefined"){t(e["command"],e["params"],e["extra"])}else{for(var r=0;r<s.length;r++){t(s[r]["command"],s[r]["params"],s[r]["extra"])}}}),this));BXMobileApp.addCustomEvent("onPullOnline",r);BXMobileApp.addCustomEvent("onPull-imopenlines",i)}else{s.addCustomEvent("onPullOnlineEvent",r);s.addCustomEvent("onPullEvent-im",t);s.addCustomEvent("onPullEvent-imopenlines",i)}s.PULL.subscribe({type:"client",moduleId:"imopenlines",command:"linesMessageWrite",callback:function(e,t){if(!this.BXIM.messenger.chat[e.operatorChatId]||!this.BXIM.messenger.chat[e.operatorChatId].entity_id){return}var r=this.BXIM.messenger.chat[e.operatorChatId].id;var i="chat"+r;var a=0;var n=s.MessengerCommon.linesGetSession(this.BXIM.messenger.chat[e.operatorChatId]);if(n){a=n.id}var o=this.BXIM.messenger.chat[e.operatorChatId].entity_id.toString().split("|");var l=0;var m=0;if(o[2]&&o[3]){l=o[2];m=o[3]}var h=s.md5(a+"/"+l+"/"+m);if(e.infoString===h){if(this.BXIM.messenger.linesWritingList[r]){this.BXIM.messenger.linesWritingList[r].text=e.text;var g=this.BXIM.messenger.linesWritingList[r].id;var p=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+g);if(p){if(e.text===""){clearTimeout(this.BXIM.messenger.linesWritingListTimeout[r]);s.remove(p);delete this.BXIM.messenger.linesWritingList[r];s.MessengerCommon.endWriting(m,i)}else{var c=s("im-message-"+g);c.innerText=e.text;clearTimeout(this.BXIM.messenger.linesWritingListTimeout[r]);this.BXIM.messenger.linesWritingListTimeout[r]=setTimeout(s.delegate((function(){s.remove(p);delete this.BXIM.messenger.linesWritingList[r];s.MessengerCommon.endWriting(m,i)}),this),29500)}}}else{if(e.text===""){return}var d={id:"ol-writing-"+Date.now(),senderId:m,text:s.util.htmlspecialchars(e.text),date:new Date,params:{CLASS:"bx-messenger-content-item-lines-writing"}};this.BXIM.messenger.linesWritingList[r]=d;if(i!==BXIM.messenger.currentTab){return}s.MessengerCommon.drawMessage(BXIM.messenger.currentTab,d);s.MessengerCommon.startWriting(m,i);var I=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+d.id);clearTimeout(this.BXIM.messenger.linesWritingListTimeout[r]);this.BXIM.messenger.linesWritingListTimeout[r]=setTimeout(s.delegate((function(){s.remove(I);delete this.BXIM.messenger.linesWritingList[r];s.MessengerCommon.endWriting(m,i)}),this),29500)}}}})};t.prototype.updateStateVar=function(e,t,r){r=r!==false;if(typeof e.CHAT!="undefined"){for(var i in e.CHAT){e.CHAT[i].date_create=new Date(e.CHAT[i].date_create);this.BXIM.messenger.chat[i]=e.CHAT[i]}}if(typeof e.USER_IN_CHAT!="undefined"){for(var i in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[i]=e.USER_IN_CHAT[i]}}if(typeof e.USER_BLOCK_CHAT!="undefined"){for(var i in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[i]=e.USER_BLOCK_CHAT[i]}}if(typeof e.USERS!="undefined"){for(var i in e.USERS){e.USERS[i].last_activity_date=e.USERS[i].last_activity_date?new Date(e.USERS[i].last_activity_date):false;e.USERS[i].mobile_last_date=e.USERS[i].mobile_last_date?new Date(e.USERS[i].mobile_last_date):false;e.USERS[i].idle=e.USERS[i].idle?new Date(e.USERS[i].idle):false;e.USERS[i].absent=e.USERS[i].absent?new Date(e.USERS[i].absent):false;this.BXIM.messenger.users[i]=e.USERS[i]}}if(typeof e.USER_IN_GROUP!="undefined"){for(var i in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[i]=="undefined"||typeof this.BXIM.messenger.userInGroup[i].users=="undefined"||!this.BXIM.messenger.userInGroup[i].users.length){this.BXIM.messenger.userInGroup[i]=e.USER_IN_GROUP[i]}else{for(var a=0;a<e.USER_IN_GROUP[i].users.length;a++)this.BXIM.messenger.userInGroup[i].users.push(e.USER_IN_GROUP[i].users[a]);this.BXIM.messenger.userInGroup[i].users=s.util.array_unique(this.BXIM.messenger.userInGroup[i].users)}}}if(typeof e.UNREAD_MESSAGE==="undefined"){e.UNREAD_MESSAGE={}}if(typeof e.MESSAGE!="undefined"){for(var i in e.MESSAGE){if(this.BXIM.messenger.message[i]&&this.BXIM.messenger.message[i].dropDuplicate){e.MESSAGE[i].dropDuplicate=true}e.MESSAGE[i].date=new Date(e.MESSAGE[i].date);e.MESSAGE[i].textOriginal=e.MESSAGE[i].text;e.MESSAGE[i].text=s.MessengerCommon.prepareText(e.MESSAGE[i].text,true,true,true);this.BXIM.messenger.message[i]=e.MESSAGE[i];this.BXIM.lastRecordId=parseInt(i)>this.BXIM.lastRecordId?parseInt(i):this.BXIM.lastRecordId}}this.changeUnreadMessage(e.UNREAD_MESSAGE,!!e.SHOW_NEW_MESSAGE);if(typeof e.USERS_MESSAGE!="undefined"){for(var i in e.USERS_MESSAGE){e.USERS_MESSAGE[i].sort(s.delegate((function(e,s){e=parseInt(e);s=parseInt(s);if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}}),this));for(var a=0;a<e.USERS_MESSAGE[i].length;a++){if(!e.USERS_MESSAGE[i][a])continue;e.USERS_MESSAGE[i][a]=e.USERS_MESSAGE[i][a].toString();if(this.BXIM.messenger.message[e.USERS_MESSAGE[i][a]].dropDuplicate||!this.BXIM.messenger.showMessage[i]||!s.util.in_array(e.USERS_MESSAGE[i][a],this.BXIM.messenger.showMessage[i])){if(!this.BXIM.messenger.showMessage[i]){this.BXIM.messenger.showMessage[i]=[]}this.BXIM.messenger.showMessage[i]=this.BXIM.messenger.showMessage[i].filter((function(s){return s!=e.USERS_MESSAGE[i][a]}));this.BXIM.messenger.showMessage[i].push(e.USERS_MESSAGE[i][a].toString());if(!this.BXIM.messenger.history[i]){this.BXIM.messenger.history[i]=[]}this.BXIM.messenger.history[i]=s.util.array_merge(this.BXIM.messenger.history[i],e.USERS_MESSAGE[i]);if(r&&this.BXIM.messenger.currentTab==i&&this.MobileActionEqual("DIALOG")&&!s("im-message-"+e.USERS_MESSAGE[i][a])){this.drawMessage(i,this.BXIM.messenger.message[e.USERS_MESSAGE[i][a]])}}}}}};t.prototype.changeUnreadMessage=function(e,t){if(s.type.isArray(e)){return}var r=this.isMobile()?"online":this.BXIM.settings.status;for(var i in e){if(this.BXIM.messenger.unreadMessage[i])this.BXIM.messenger.unreadMessage[i]=s.util.array_unique(s.util.array_merge(this.BXIM.messenger.unreadMessage[i],e[i]));else this.BXIM.messenger.unreadMessage[i]=e[i];this.BXIM.messenger.unreadMessage[i].sort((function(e,s){return e-s}));if(this.isMobile()&&this.BXIM.messenger.currentTab==i){var a=this.BXIM.messenger.currentTab;this.BXIM.isFocusMobile(s.delegate((function(e){if(e){setTimeout(s.delegate((function(e){s.MessengerCommon.readMessage(a,true,true)}),this),300)}}),this))}if(!t){continue}var n=i.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[i.toString().substr(4)]&&this.BXIM.messenger.chat[i.toString().substr(4)].type=="lines";if(typeof this.BXIM.messenger.flashMessage[i]=="undefined"){this.BXIM.messenger.flashMessage[i]={}}for(var o=0;o<e[i].length;o++){if(n&&s.MessengerCommon.getCounter(i)>0){var l=this.BXIM.messenger.message[e[i][o]].senderId;if(l==0||this.BXIM.messenger.users[l].extranet){this.BXIM.messenger.flashMessage[i][e[i][o]]=false;continue}}var m=this.BXIM.messenger.message[e[i][o]].text.match(new RegExp("("+this.BXIM.messenger.users[this.BXIM.userId].name.replace(/[\-\[\]\/\{\}\(\)\*\+\?\.\\\^\$\|]/g,"\\$&")+")","ig"));if(!m&&(r=="dnd"||this.BXIM.notify.muteModeCode>0||s.MessengerCalls&&s.MessengerCalls.hasActiveSharing())){this.BXIM.messenger.flashMessage[i][e[i][o]]=false}else{this.BXIM.messenger.flashMessage[i][e[i][o]]=true}}}this.BXIM.messenger.dialogStatusRedraw(this.isMobile()?{type:1,slidingPanelRedrawDisable:true,userRedraw:false}:{userRedraw:false});this.BXIM.messenger.newMessage(true);this.BXIM.messenger.updateMessageCount(true)};t.prototype.redrawDateMarks=function(){if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;if(typeof this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName=="undefined")return false;var e={};var t=this.BXIM.messenger.popupMessengerBodyWrap.getElementsByClassName("bx-messenger-content-group");var r=this.BXIM.messenger.popupMessengerBody.getBoundingClientRect().top;for(var i=0;i<t.length;i++){e=s.MessengerCommon.isElementCoordsBelow(t[i],this.BXIM.messenger.popupMessengerBody,33,true);if(t[i].className!="bx-messenger-content-group bx-messenger-content-group-today"){t[i].className="bx-messenger-content-group "+(e.top?"":"bx-messenger-content-group-float");t[i].firstChild.nextSibling.style.marginLeft=e.top?"":Math.round(t[i].offsetWidth/2-t[i].firstChild.nextSibling.offsetWidth/2)+"px";t[i].firstChild.nextSibling.style.marginTop=e.top?"":-e.coords.top+14+"px"}if(!e.top&&t[i-1]){t[i-1].className="bx-messenger-content-group";t[i-1].firstChild.nextSibling.style.marginLeft="";t[i-1].firstChild.nextSibling.style.marginTop=""}}};t.prototype.unreadMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e];var r="";if(t.recipientId.toString().substr(0,4)=="chat"){r=t.recipientId}else{r=t.senderId}s.rest.callMethod("im.dialog.unread",{DIALOG_ID:r,MESSAGE_ID:e});showMessage=this.BXIM.messenger.showMessage[r];showMessage.sort((function(e,s){if(e<s){return-1}else if(e>s){return 1}else{return 0}}));this.BXIM.messenger.unreadMessage[r]=[];var i=0;for(var a=0;a<showMessage.length;a++){if(parseInt(showMessage[a])>=parseInt(e)){if(!this.BXIM.messenger.unreadMessage[r])this.BXIM.messenger.unreadMessage[r]=[];this.BXIM.messenger.unreadMessage[r].push(showMessage[a]);i++}}this.recentListUpdateItem({id:r,counter:i});this.skipReadMessage=true;this.drawTab();this.recentListRedraw();setTimeout(s.delegate((function(){this.skipReadMessage=false}),this),1e3)};t.prototype.readMessage=function(t,r,i,a){if(!t||this.skipReadMessage){return false}r=r!=false;i=i!==false;if(i){a=a==true||this.isMobile();if(!a&&!s.MessengerCommon.getCounter(t)){return false}if(this.BXIM.callController&&this.BXIM.callController.hasActiveCall()&&this.BXIM.callController.hasVisibleCall()){return false}if(t.toString().substring(0,4)=="chat"){var n=t.toString().substring(4);if(this.BXIM.messenger.chat[n]&&this.BXIM.messenger.chat[n].type=="lines"&&this.BXIM.messenger.chat[n].owner==0){return false}}if(s.SidePanel&&s.SidePanel.Instance.isOpen()&&s.SidePanel.Instance.isOnTop()&&this.BXIM.messenger.popupMessenger){var o=s.SidePanel.Instance.getTopSlider();if(!(o.url==="/desktop_app/"||o.url.startsWith("im:slider"))){return false}}}var l=s.MessengerCommon.getCounter(t);this.recentListUpdateItem({id:t,counter:0,unread:false});this.recentListRedraw();var m=0;if(Math&&this.BXIM.messenger.unreadMessage[t])m=Math.max.apply(Math,this.BXIM.messenger.unreadMessage[t]);if(this.BXIM.messenger.unreadMessage[t]){var h=s.clone(this.BXIM.messenger.unreadMessage[t]);delete this.BXIM.messenger.unreadMessage[t]}if(this.BXIM.messenger.flashMessage[t])delete this.BXIM.messenger.flashMessage[t];if(!this.isMobile()){this.BXIM.messenger.updateMessageCount(r);this.BXIM.updateCounter()}if(this.BXIM.messenger.popupMessenger!=null&&t==this.BXIM.messenger.currentTab){elements=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-new",false);if(elements!=null){for(var g=0;g<elements.length;g++){if(elements[g].getAttribute("data-notifyType")!=1){s.removeClass(elements[g],"bx-messenger-content-item-new")}}}}if(i){if(s.MessengerProxy){s.MessengerProxy.sendCounterChangeEvent(t,0)}var p={IM_READ_MESSAGE:"Y",USER_ID:t,TAB:this.BXIM.messenger.currentTab,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()};if(parseInt(m)>0)p["LAST_ID"]=m;var c=s.ajax({url:this.BXIM.pathToAjax+"?READ_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,skipAuthCheck:true,data:p,onsuccess:s.delegate((function(r){if(r){if(r.BITRIX_SESSID)s.message({bitrix_sessid:r.BITRIX_SESSID});if(r.ERROR==""){s.onCustomEvent(e,"onImMessageRead",[t]);this.BXIM.messenger.setUpdateStateStep()}else{this.BXIM.messenger.unreadMessage[t]=h;if(s.MessengerProxy){s.MessengerProxy.sendCounterChangeEvent(t,l)}if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate((function(){this.readMessage(t,false,true)}),this),2e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate((function(){this.readMessage(t,false,true)}),this),1e4)}s.onCustomEvent(e,"onImError",[r.ERROR])}}}else{if(s.MessengerProxy){s.MessengerProxy.sendCounterChangeEvent(t,l)}this.BXIM.messenger.unreadMessage[t]=h}}),this),onfailure:s.delegate((function(){if(s.MessengerProxy){s.MessengerProxy.sendCounterChangeEvent(t,l)}this.BXIM.messenger.unreadMessage[t]=h;this.BXIM.messenger.sendAjaxTry=0;try{if(typeof c=="object"&&c.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(e){}}),this)})}if(r){s.localStorage.set("mrm",t,5);s.localStorage.set("mnnb",true,1)}};t.prototype.drawReadMessageChat=function(e,t){if(!this.BXIM.messenger.readedList[e]){return false}var r=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);var i=0;var a={};var n=0;var o=false;for(var l in this.BXIM.messenger.readedList[e]){if(l==this.BXIM.userId)continue;if(this.BXIM.messenger.message[r]&&this.BXIM.messenger.message[r].senderId==l)continue;if(this.BXIM.messenger.readedList[e][l].messageId>=r){if(!a[l]){a[l]={}}if(!o||o.getTime()>this.BXIM.messenger.readedList[e][l].date.getTime()){n=l;o=this.BXIM.messenger.readedList[e][l].date}a[l]=this.BXIM.messenger.readedList[e][l];i++}}if(i>0){this.BXIM.messenger.readedList[e]=a}else{this.BXIM.messenger.readedList[e]=false;var m=this.BXIM.messenger.popupMessengerBodyWrap?this.BXIM.messenger.popupMessengerBodyWrap.lastChild:null;if(m&&s.hasClass(m,"bx-messenger-content-item-notify")){if(!this.countWriting(e)){s.remove(m)}}return false}if(!this.countWriting(e)){var h=this.getUserParam(n);var g='<span title="'+this.formatDate(o)+'">'+h.name+"</span>";if(i>1){if(this.isMobile()){g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#","<b>").replace("#LINK_END#","</b>").replace("#COUNT#",i-1)}else{g=s.message("IM_M_READED_CHAT_MORE").replace("#USER#",g).replace("#LINK_START#",'<span class="bx-messenger-ajax" data-entity="readedList">').replace("#LINK_END#","</span>").replace("#COUNT#",i-1)}}t=t!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED_CHAT").replace("#USERS#",g),t)}};t.prototype.drawReadMessage=function(e,t,r,i){var a=Math.max.apply(Math,this.BXIM.messenger.showMessage[e]);if(a!=t||this.BXIM.messenger.message[a].senderId==e||!r){this.BXIM.messenger.readedList[e]=false;return false}this.BXIM.messenger.readedList[e]={messageId:t,date:r};if(!this.countWriting(e)){i=i!=false;this.drawNotifyMessage(e,"readed",s.message("IM_M_READED").replace("#DATE#",this.formatDate(r)),i)}};t.prototype.drawNotifyMessage=function(t,r,i,a){if(this.BXIM.messenger.popupMessenger==null||t!=this.BXIM.messenger.currentTab||typeof i=="undefined"||typeof r=="undefined"||t==0)return false;if(!this.BXIM.messenger.popupMessengerBodyWrap)return false;var n=this.BXIM.messenger.popupMessengerBodyWrap.lastChild;if(!n||s.hasClass(n,"bx-messenger-content-empty"))return false;var o=s.create("div",{attrs:{"data-type":"notify"},props:{className:"bx-messenger-content-item bx-messenger-content-item-notify"},children:[s.create("span",{props:{className:"bx-messenger-content-item-content"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-center"},children:[s.create("span",{props:{className:"bx-messenger-content-item-text-message"},html:'<span class="bx-messenger-content-item-notify-icon-'+r+'"></span>'+this.prepareText(i,false,true,true)})]})]})]});var l=true;if(s.hasClass(n,"bx-messenger-content-item-notify")){l=false;s.remove(n)}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(o);a=a!=false;if(l&&this.BXIM.messenger.popupMessengerBody&&s.MessengerCommon.enableScroll(this.BXIM.messenger.popupMessengerBody,this.BXIM.messenger.popupMessengerBody.offsetHeight)){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport&&a){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:1200,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate((function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll}),this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}};t.prototype.loadHistory=function(e,t,r){t=typeof t=="undefined"?true:t;r=typeof r=="undefined"?false:r;if(!this.BXIM.messenger.historyEndOfList[e])this.BXIM.messenger.historyEndOfList[e]={};if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};if(this.BXIM.messenger.historyLoadFlag[e]&&this.BXIM.messenger.historyLoadFlag[e][t]){if(this.isMobile())app.pullDownLoadingStop();return}if(this.isMobile()){t=false}else{if(t){if(this.BXIM.messenger.historySearch!=""||this.BXIM.messenger.historyDateSearch!="")return;if(!(this.BXIM.messenger.popupHistoryItems.scrollTop>this.BXIM.messenger.popupHistoryItems.scrollHeight-this.BXIM.messenger.popupHistoryItems.offsetHeight-100))return}else{if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0&&this.BXIM.messenger.popupMessengerBody.scrollTop>=5)return}}if(!this.BXIM.messenger.historyEndOfList[e]||!this.BXIM.messenger.historyEndOfList[e][t]){var i=[];if(t){i=s.findChildrenByClassName(this.BXIM.messenger.popupHistoryBodyWrap,"bx-messenger-history-item")}else{i=s.findChildrenByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-text-wrap")}if(!this.isMobile()&&i.length<30&&!r){return false}if(i.length>0)this.BXIM.messenger.historyOpenPage[e]=Math.floor(i.length/30)+1;else this.BXIM.messenger.historyOpenPage[e]=1;var a=null;if(!this.isMobile()&&!r){a=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});if(t){this.BXIM.messenger.popupHistoryBodyWrap.appendChild(a)}else{this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(a,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}else if(r){a=s.create("div",{props:{className:"bx-messenger-content-load-more-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});var n=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(n){n.innerHTML="";n.appendChild(a)}else{n=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history-empty");this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(a,n);s.remove(n)}}if(!this.BXIM.messenger.historyLoadFlag[e])this.BXIM.messenger.historyLoadFlag[e]={};this.BXIM.messenger.historyLoadFlag[e][t]=true;s.ajax({url:this.BXIM.pathToAjax+"?HISTORY_LOAD_MORE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_HISTORY_LOAD_MORE:"Y",USER_ID:e,PAGE_ID:this.BXIM.messenger.historyOpenPage[e],IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(r){if(a)s.remove(a);if(this.isMobile())app.pullDownLoadingStop();this.BXIM.messenger.historyLoadFlag[e][t]=false;if(r.MESSAGE&&r.MESSAGE.length==0){this.BXIM.messenger.historyEndOfList[e][t]=true;var i=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-empty");if(i){i.appendChild(s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_NO_MESSAGE")}))}return}for(var n in r.FILES){if(!this.BXIM.disk.files[r.CHAT_ID])this.BXIM.disk.files[r.CHAT_ID]={};if(this.BXIM.disk.files[r.CHAT_ID][n])continue;r.FILES[n].date=new Date(r.FILES[n].date);this.BXIM.disk.files[r.CHAT_ID][n]=r.FILES[n]}var o=0;for(var n in r.MESSAGE){r.MESSAGE[n].date=new Date(r.MESSAGE[n].date);r.MESSAGE[n].textOriginal=r.MESSAGE[n].text;r.MESSAGE[n].text=s.MessengerCommon.prepareText(r.MESSAGE[n].text,true,true,true);this.BXIM.messenger.message[n]=r.MESSAGE[n];o++}if(o<30){this.BXIM.messenger.historyEndOfList[e][t]=true}for(var n in r.USERS_MESSAGE){if(t){if(this.BXIM.messenger.history[n])this.BXIM.messenger.history[n]=s.util.array_merge(this.BXIM.messenger.history[n],r.USERS_MESSAGE[n]);else this.BXIM.messenger.history[n]=r.USERS_MESSAGE[n]}else{if(this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=s.util.array_unique(s.util.array_merge(r.USERS_MESSAGE[n],this.BXIM.messenger.showMessage[n]));else this.BXIM.messenger.showMessage[n]=r.USERS_MESSAGE[n]}}for(var n in r.USERS){r.USERS[n].last_activity_date=r.USERS[n].last_activity_date?new Date(r.USERS[n].last_activity_date):false;r.USERS[n].mobile_last_date=r.USERS[n].mobile_last_date?new Date(r.USERS[n].mobile_last_date):false;r.USERS[n].idle=r.USERS[n].idle?new Date(r.USERS[n].idle):false;r.USERS[n].absent=r.USERS[n].absent?new Date(r.USERS[n].absent):false;this.BXIM.messenger.users[n]=r.USERS[n]}for(var n in r.PHONES){this.BXIM.messenger.phones[n]={};for(var l in r.PHONES[n]){this.BXIM.messenger.phones[n][l]=s.util.htmlspecialcharsback(r.PHONES[n][l])}}for(var n in r.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[n]=="undefined"||typeof this.BXIM.messenger.userInGroup[n].users=="undefined"||!this.BXIM.messenger.userInGroup[n].users.length){this.BXIM.messenger.userInGroup[n]=r.USER_IN_GROUP[n]}else{for(var l=0;l<r.USER_IN_GROUP[n].users.length;l++)this.BXIM.messenger.userInGroup[n].users.push(r.USER_IN_GROUP[n].users[l]);this.BXIM.messenger.userInGroup[n].users=s.util.array_unique(this.BXIM.messenger.userInGroup[n].users)}}if(t){for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var m=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(m){if(s("im-message-history-"+m.id))continue;var h=s.MessengerCommon.formatDate(m.date,s.MessengerCommon.getDateFormatType("MESSAGE_TITLE"));var g=typeof s.translit!="undefined"?s.translit(h):h;if(!s("bx-im-history-"+g)){var p=s.create("div",{props:{className:"bx-messenger-content-group bx-messenger-content-group-history"},children:[s.create("div",{attrs:{id:"bx-im-history-"+g},props:{className:"bx-messenger-content-group-title"+(this.BXIM.language=="ru"?" bx-messenger-lowercase":"")},html:h})]});this.BXIM.messenger.popupHistoryBodyWrap.appendChild(p)}var m=this.BXIM.messenger.drawMessageHistory(m);if(m)this.BXIM.messenger.popupHistoryBodyWrap.appendChild(m)}}}else{var c=this.BXIM.messenger.popupMessengerBodyWrap.firstChild?this.BXIM.messenger.popupMessengerBodyWrap.firstChild.nextSibling:null;if(c){c=s("im-message-"+c.getAttribute("data-blockmessageid"))}if(r.USERS_MESSAGE[e]){for(var n=0;n<r.USERS_MESSAGE[e].length;n++){var m=this.BXIM.messenger.message[r.USERS_MESSAGE[e][n]];if(m){if(s("im-message-"+m.id))continue;s.MessengerCommon.drawMessage(e,m,false,true)}}}if(c){this.scrollToNode(c.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}}),this),onfailure:s.delegate((function(){if(a)s.remove(a);if(this.isMobile())app.pullDownLoadingStop()}),this)})}};t.prototype.loadMessageByDate=function(t,r,i){s.ajax({url:this.BXIM.pathToAjax+"?LOAD_MESSAGE_BY_DATE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LOAD_MESSAGE_BY_DATE:"Y",CHAT_ID:t,LAST_LOAD:r,FIRST_MESSAGE_ID:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(a){if(a&&a.BITRIX_SESSID){s.message({bitrix_sessid:a.BITRIX_SESSID})}if(a.ERROR==""){var n=a.DIALOG_ID;this.BXIM.messenger.sendAjaxTry=0;for(var o in a.USERS){a.USERS[o].last_activity_date=a.USERS[o].last_activity_date?new Date(a.USERS[o].last_activity_date):false;a.USERS[o].mobile_last_date=a.USERS[o].mobile_last_date?new Date(a.USERS[o].mobile_last_date):false;a.USERS[o].idle=a.USERS[o].idle?new Date(a.USERS[o].idle):false;a.USERS[o].absent=a.USERS[o].absent?new Date(a.USERS[o].absent):false;this.BXIM.messenger.users[o]=a.USERS[o]}for(var o in a.PHONES){this.BXIM.messenger.phones[o]={};for(var l in a.PHONES[o]){this.BXIM.messenger.phones[o][l]=s.util.htmlspecialcharsback(a.PHONES[o][l])}}for(var o in a.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[o]=="undefined"||typeof this.BXIM.messenger.userInGroup[o].users=="undefined"||!this.BXIM.messenger.userInGroup[o].users.length){this.BXIM.messenger.userInGroup[o]=a.USER_IN_GROUP[o]}else{for(var l=0;l<a.USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.userInGroup[o].users.push(a.USER_IN_GROUP[o].users[l]);this.BXIM.messenger.userInGroup[o].users=s.util.array_unique(this.BXIM.messenger.userInGroup[o].users)}}for(var o in a.FILES){if(!this.BXIM.messenger.disk.files[a.CHAT_ID])this.BXIM.messenger.disk.files[a.CHAT_ID]={};a.FILES[o].date=new Date(a.FILES[o].date);this.BXIM.messenger.disk.files[a.CHAT_ID][o]=a.FILES[o]}this.BXIM.messenger.sendAjaxTry=0;var m=0;for(var o in a.MESSAGE){m++;a.MESSAGE[o].date=new Date(a.MESSAGE[o].date);a.MESSAGE[o].textOriginal=a.MESSAGE[o].text;a.MESSAGE[o].text=s.MessengerCommon.prepareText(a.MESSAGE[o].text,true,true,true);this.BXIM.messenger.message[o]=a.MESSAGE[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}for(var o in a.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[o])this.BXIM.messenger.showMessage[o]=s.util.array_unique(s.util.array_merge(a.USERS_MESSAGE[o],this.BXIM.messenger.showMessage[o]));else this.BXIM.messenger.showMessage[o]=a.USERS_MESSAGE[o]}for(var o in a.DELETE_MESSAGE){delete this.BXIM.messenger.message[o];if(this.BXIM.messenger.currentTab==a.DIALOG_ID&&s("im-message-"+o)){var h=s("im-message-"+o).parentNode.parentNode.parentNode.parentNode.parentNode;if(h.getAttribute("data-messageId")==h.getAttribute("data-blockMessageId")){s.remove(h)}else{h=s("im-message-"+o).parentNode;if(h.nextSibling&&s.hasClass(h.nextSibling,"bx-messenger-hr")){s.remove(h.nextSibling)}else if(!h.nextSibling&&s.hasClass(h.previousSibling,"bx-messenger-hr")){s.remove(h.previousSibling)}s.remove(h)}}}for(var o in a.CHAT){a.CHAT[o].date_create=new Date(a.CHAT[o].date_create);this.BXIM.messenger.chat[o]=a.CHAT[o]}for(var o in a.USER_IN_CHAT){this.BXIM.messenger.userInChat[o]=a.USER_IN_CHAT[o]}for(var o in a.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[o]=a.USER_BLOCK_CHAT[o]}this.changeUnreadMessage(a.UNREAD_MESSAGE)}else{if(a.ERROR=="SESSION_ERROR"&&this.sendAjaxTry<2){this.sendAjaxTry++;setTimeout(s.delegate((function(){this.loadMessageByDate(t,r,i)}),this),1e3);s.onCustomEvent(e,"onImError",[a.ERROR,a.BITRIX_SESSID])}else if(a.ERROR=="AUTHORIZE_ERROR"){this.sendAjaxTry++;if(s.MessengerCommon.isDesktop()||this.isMobile()){setTimeout(s.delegate((function(){this.loadMessageByDate(t,r,i)}),this),1e4)}s.onCustomEvent(e,"onImError",[a.ERROR])}}}),this),onfailure:s.delegate((function(){this.sendAjaxTry=0}),this)})};t.prototype.loadUserData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?USER_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_USER_DATA_LOAD:"Y",USER_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){if(t.ERROR==""){this.BXIM.messenger.userChat[e]=t.CHAT_ID;s.MessengerCommon.getUserParam(e,true);this.BXIM.messenger.users[e].name=s.message("IM_M_USER_NO_ACCESS");for(var r in t.USERS){t.USERS[r].last_activity_date=t.USERS[r].last_activity_date?new Date(t.USERS[r].last_activity_date):false;t.USERS[r].mobile_last_date=t.USERS[r].mobile_last_date?new Date(t.USERS[r].mobile_last_date):false;t.USERS[r].idle=t.USERS[r].idle?new Date(t.USERS[r].idle):false;t.USERS[r].absent=t.USERS[r].absent?new Date(t.USERS[r].absent):false;this.BXIM.messenger.users[r]=t.USERS[r]}for(var r in t.PHONES){this.BXIM.messenger.phones[r]={};for(var i in t.PHONES[r]){this.BXIM.messenger.phones[r][i]=s.util.htmlspecialcharsback(t.PHONES[r][i])}}for(var r in t.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[r]=="undefined"||typeof this.BXIM.messenger.userInGroup[r].users=="undefined"||!this.BXIM.messenger.userInGroup[r].users.length){this.BXIM.messenger.userInGroup[r]=t.USER_IN_GROUP[r]}else{for(var i=0;i<t.USER_IN_GROUP[r].users.length;i++)this.BXIM.messenger.userInGroup[r].users.push(t.USER_IN_GROUP[r].users[i]);this.BXIM.messenger.userInGroup[r].users=s.util.array_unique(this.BXIM.messenger.userInGroup[r].users)}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}}else{this.BXIM.messenger.redrawTab[e]=true;if(t.ERROR=="ACCESS_DENIED"&&this.BXIM.messenger.currentTab==e){this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}}}),this)})};t.prototype.loadChatData=function(e){s.ajax({url:this.BXIM.pathToAjax+"?CHAT_DATA_LOAD&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_CHAT_DATA_LOAD:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){if(e.ERROR==""){if(this.BXIM.messenger.chat[e.CHAT_ID].fake){this.BXIM.messenger.chat[e.CHAT_ID].name=s.message("IM_M_USER_NO_ACCESS")}for(var t in e.CHAT){e.CHAT[t].date_create=new Date(e.CHAT[t].date_create);this.BXIM.messenger.chat[t]=e.CHAT[t]}for(var t in e.USER_IN_CHAT){this.BXIM.messenger.userInChat[t]=e.USER_IN_CHAT[t]}for(var t in e.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[t]=e.USER_BLOCK_CHAT[t]}for(var t in e.USERS){e.USERS[t].last_activity_date=e.USERS[t].last_activity_date?new Date(e.USERS[t].last_activity_date):false;e.USERS[t].mobile_last_date=e.USERS[t].mobile_last_date?new Date(e.USERS[t].mobile_last_date):false;e.USERS[t].idle=e.USERS[t].idle?new Date(e.USERS[t].idle):false;e.USERS[t].absent=e.USERS[t].absent?new Date(e.USERS[t].absent):false;this.BXIM.messenger.users[t]=e.USERS[t]}for(var t in e.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[t]=="undefined"||typeof this.BXIM.messenger.userInGroup[t].users=="undefined"||!this.BXIM.messenger.userInGroup[t].users.length){this.BXIM.messenger.userInGroup[t]=e.USER_IN_GROUP[t]}else{for(var r=0;r<e.USER_IN_GROUP[t].users.length;r++)this.BXIM.messenger.userInGroup[t].users.push(e.USER_IN_GROUP[t].users[r]);this.BXIM.messenger.userInGroup[t].users=s.util.array_unique(this.BXIM.messenger.userInGroup[t].users)}}if(this.BXIM.messenger.currentTab=="chat"+e.CHAT_ID){if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="call"){this.BXIM.messenger.openCallFlag=true}else if(this.BXIM.messenger.chat[e.CHAT_ID]&&this.BXIM.messenger.chat[e.CHAT_ID].type=="lines"){this.BXIM.messenger.openLinesFlag=true}this.drawTab(this.BXIM.messenger.currentTab)}}}),this)})};t.prototype.loadLastMessage=function(t,r){if(this.BXIM.messenger.loadLastMessageTimeout[t])return false;r=typeof r=="function"?r:function(e,s,t){};var i=0;var a=false;if(t.toString().substr(0,4)=="chat"){i=t.toString().substr(4);a=true}else if(t.toString().substr(0,2)=="sg"){i=t.toString().substr(2);a=true}else if(t.toString().substr(0,3)=="crm"){i=t.toString().substr(4);a=true}this.BXIM.messenger.historyWindowBlock=true;this.BXIM.messenger.loadLastMessageTimeout[t]=true;if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){if(a&&(!this.BXIM.messenger.chat[i]||this.BXIM.messenger.chat[i].fake)||!a&&(!this.BXIM.messenger.users[t]||this.BXIM.messenger.users[t].fake)){s.addClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}}var n=s.delegate((function(){this.BXIM.messenger.loadLastMessageTimeout[t]=false;r(t,false,{});if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==t){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}if(this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;clearTimeout(this.BXIM.messenger.loadLastMessageTimeout);this.BXIM.messenger.loadLastMessageTimeout=setTimeout(s.delegate((function(){s.MessengerCommon.loadLastMessage(t)}),this),2e3);return true}this.BXIM.messenger.historyWindowBlock=false;this.BXIM.messenger.redrawTab[t]=true;if(!this.BXIM.messenger.showMessage[t]||this.BXIM.messenger.showMessage[t].length<=0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";var e=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:e});if(this.isMobile()&&this.MobileActionEqual("DIALOG")){BXMobileApp.UI.Page.TopBar.title.setText(s.message("IM_F_ERROR"));BXMobileApp.UI.Page.TopBar.title.setDetailText("")}}else{this.BXIM.messenger.tooltip(this.BXIM.messenger.popupMessengerBody,s.message("IM_M_LOAD_ERROR"),{offsetTop:-10,offsetLeft:50,bindOptions:{position:"top"}});var i=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-notifier-content-link-history");if(i){s.remove(i)}}}),this);var o=s.delegate((function(i){this.BXIM.messenger.loadLastMessageTimeout[t]=false;if(!i){n();return false}if(this.BXIM.messenger.popupMessengerDialog&&this.BXIM.messenger.currentTab==i.USER_ID){s.removeClass(this.BXIM.messenger.popupMessengerDialog,"bx-messenger-chat-load-last-message")}this.BXIM.checkRevision(this.isMobile()?i.MOBILE_REVISION:i.REVISION);if(i&&i.BITRIX_SESSID){s.message({bitrix_sessid:i.BITRIX_SESSID})}if(i.ERROR==""){if(this.isMobile()){this.BXIM.disk.setChatParams(parseInt(i.CHAT_ID),parseInt(i.DISK_FOLDER_ID))}if(a){if(i.USER_ID.toString().substr(0,2)=="sg"){if(this.BXIM.messenger.currentTab==i.USER_ID){this.BXIM.messenger.currentTab="chat"+i.CHAT_ID}delete this.BXIM.messenger.chat[i.USER_ID];i.USER_ID="chat"+i.CHAT_ID;s.MessengerCommon.getUserParam(i.USER_ID)}else if(i.USER_ID.toString().substr(0,3)=="crm"){if(this.BXIM.messenger.currentTab==i.USER_ID){this.BXIM.messenger.currentTab="chat"+i.CHAT_ID}delete this.BXIM.messenger.chat[i.USER_ID];i.USER_ID="chat"+i.CHAT_ID;s.MessengerCommon.getUserParam(i.USER_ID)}}else{this.BXIM.messenger.userChat[t]=i.CHAT_ID;s.MessengerCommon.getUserParam(t,true);this.BXIM.messenger.users[t].name=s.message("IM_M_USER_NO_ACCESS")}for(var o in i.USERS){i.USERS[o].last_activity_date=i.USERS[o].last_activity_date?new Date(i.USERS[o].last_activity_date):false;i.USERS[o].mobile_last_date=i.USERS[o].mobile_last_date?new Date(i.USERS[o].mobile_last_date):false;i.USERS[o].idle=i.USERS[o].idle?new Date(i.USERS[o].idle):false;i.USERS[o].absent=i.USERS[o].absent?new Date(i.USERS[o].absent):false;this.BXIM.messenger.users[o]=i.USERS[o]}for(var o in i.PHONES){this.BXIM.messenger.phones[o]={};for(var l in i.PHONES[o]){this.BXIM.messenger.phones[o][l]=s.util.htmlspecialcharsback(i.PHONES[o][l])}}for(var o in i.USER_IN_GROUP){if(typeof this.BXIM.messenger.userInGroup[o]=="undefined"||typeof this.BXIM.messenger.userInGroup[o].users=="undefined"||!this.BXIM.messenger.userInGroup[o].users.length){this.BXIM.messenger.userInGroup[o]=i.USER_IN_GROUP[o]}else{for(var l=0;l<i.USER_IN_GROUP[o].users.length;l++)this.BXIM.messenger.userInGroup[o].users.push(i.USER_IN_GROUP[o].users[l]);this.BXIM.messenger.userInGroup[o].users=s.util.array_unique(this.BXIM.messenger.userInGroup[o].users)}}if(!a&&i.USER_LOAD=="Y")s.MessengerCommon.userListRedraw();for(var o in i.FILES){if(!this.BXIM.messenger.disk.files[i.CHAT_ID])this.BXIM.messenger.disk.files[i.CHAT_ID]={};i.FILES[o].date=new Date(i.FILES[o].date);this.BXIM.messenger.disk.files[i.CHAT_ID][o]=i.FILES[o]}this.BXIM.messenger.sendAjaxTry=0;var m=0;for(var o in i.MESSAGE){m++;i.MESSAGE[o].date=new Date(i.MESSAGE[o].date);i.MESSAGE[o].textOriginal=i.MESSAGE[o].text;i.MESSAGE[o].text=s.MessengerCommon.prepareText(i.MESSAGE[o].text,true,true,true);this.BXIM.messenger.message[o]=i.MESSAGE[o];this.BXIM.lastRecordId=parseInt(o)>this.BXIM.lastRecordId?parseInt(o):this.BXIM.lastRecordId}if(m>0){delete this.BXIM.messenger.redrawTab[t]}if(typeof this.BXIM.messenger.showMessage[t]!=="undefined"){this.BXIM.messenger.showMessage[t]=this.BXIM.messenger.showMessage[t].filter((function(e){return e.toString().startsWith("birthday")||e.toString().startsWith("temp")}))}for(var o in i.USERS_MESSAGE){if(this.BXIM.messenger.showMessage[o])this.BXIM.messenger.showMessage[o]=s.util.array_unique(s.util.array_merge(i.USERS_MESSAGE[o],this.BXIM.messenger.showMessage[o]));else this.BXIM.messenger.showMessage[o]=i.USERS_MESSAGE[o]}if(a&&this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)]&&this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)].fake){this.BXIM.messenger.chat[i.USER_ID.toString().substr(4)].name=s.message("IM_M_USER_NO_ACCESS")}for(var o in i.CHAT){i.CHAT[o].date_create=new Date(i.CHAT[o].date_create);this.BXIM.messenger.chat[o]=i.CHAT[o]}for(var o in i.USER_IN_CHAT){this.BXIM.messenger.userInChat[o]=i.USER_IN_CHAT[o]}for(var o in i.USER_BLOCK_CHAT){this.BXIM.messenger.userChatBlockStatus[o]=i.USER_BLOCK_CHAT[o]}if(this.isMobile()&&typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imOpenDialog",{});if(i.CHAT&&i.CHAT[i.CHAT_ID]){if(i.CHAT[i.CHAT_ID].type=="lines")fabric.Answers.sendCustomEvent("imOpenDialogLines",{});else fabric.Answers.sendCustomEvent("imOpenDialogChat",{})}else{fabric.Answers.sendCustomEvent("imOpenDialogPrivate",{})}}if(i.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var o in i.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[o]=i.OPENLINES.canVoteAsHead[o]}}if(this.BXIM.messenger.currentTab==i.USER_ID){if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)]&&this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)].type=="call"){this.BXIM.messenger.openCallFlag=true}}if(i.NETWORK_ID!=""){this.BXIM.messenger.currentTab=i.USER_ID?i.USER_ID:0;delete this.BXIM.messenger.users[i.NETWORK_ID];if(!this.BXIM.messenger.bot[i.USER_ID]){this.BXIM.messenger.bot[i.USER_ID]=this.BXIM.messenger.bot[i.NETWORK_ID]}delete this.BXIM.messenger.bot[i.NETWORK_ID];if(this.isMobile()&&this.MobileActionEqual("DIALOG")){app.onCustomEvent("onImDialogNetworkOpen",{NETWORK_ID:i.NETWORK_ID,USER_ID:i.USER_ID,USER:this.BXIM.messenger.users[i.USER_ID]})}}if(a){for(var o in i.READED_LIST){for(var h in i.READED_LIST[o]){i.READED_LIST[o][h].date=new Date(i.READED_LIST[o][h].date)}this.BXIM.messenger.readedList[o]=i.READED_LIST[o]}}else{for(var o in i.READED_LIST){i.READED_LIST[o].date=new Date(i.READED_LIST[o].date);this.BXIM.messenger.readedList[o]=i.READED_LIST[o]}}if(a&&this.BXIM.messenger.chat[i.CHAT_ID]&&this.BXIM.messenger.chat[i.CHAT_ID].type=="livechat"){var g=this.livechatGetSession(i.CHAT_ID);if(g.readed=="Y"){g.readedTime=g.readedTime?new Date(g.readedTime):new Date;this.BXIM.messenger.readedList["chat"+i.CHAT_ID]={messageId:g.readedId,date:g.readedTime}}}this.changeUnreadMessage(i.UNREAD_MESSAGE);this.drawTab(i.USER_ID,this.BXIM.messenger.currentTab==i.USER_ID,m);if(this.BXIM.messenger.currentTab==i.USER_ID&&this.BXIM.messenger.readedList[i.USER_ID]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(i.USER_ID,false)}else{this.drawReadMessage(i.USER_ID,this.BXIM.messenger.readedList[i.USER_ID].messageId,this.BXIM.messenger.readedList[i.USER_ID].date,false)}}this.BXIM.messenger.historyWindowBlock=false;if(this.BXIM.isFocus()){this.readMessage(i.USER_ID,true,s.MessengerCommon.getCounter(i.USER_ID)>0)}if(this.isMobile()){setTimeout(s.delegate((function(){this.BXIM.messenger.autoScroll()}),this),100)}s.onCustomEvent(e,"onImLoadLastMessage",[t,true,i]);r(t,true,i)}else{this.BXIM.messenger.redrawTab[t]=true;if(i.ERROR=="ACCESS_DENIED"&&this.BXIM.messenger.currentTab==t){if(s.MessengerProxy){s.MessengerProxy.sendAccessDeniedErrorEvent(i.USER_ID)}this.BXIM.messenger.currentTab=0;this.BXIM.messenger.openChatFlag=false;this.BXIM.messenger.openCallFlag=false;this.BXIM.messenger.openLinesFlag=false;this.BXIM.messenger.extraClose()}else if(i.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate((function(){this.loadLastMessage(t)}),this),2e3);s.onCustomEvent(e,"onImError",[i.ERROR,i.BITRIX_SESSID])}else if(i.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate((function(){this.loadLastMessage(t)}),this),1e4)}s.onCustomEvent(e,"onImError",[i.ERROR])}r(t,false,i)}}),this);var l=this.isMobile()||this.BXIM.isFocus();if(a&&this.BXIM.messenger.chat[i]&&this.BXIM.messenger.chat[i].owner==0&&this.BXIM.messenger.chat[i].type=="lines"){l=false}var m=s.ajax({url:this.BXIM.pathToAjax+"?LOAD_LAST_MESSAGE&D="+t+"&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,data:{IM_LOAD_LAST_MESSAGE:"Y",CHAT:a?"Y":"N",USER_ID:t,USER_LOAD:"Y",TAB:this.BXIM.messenger.currentTab,MOBILE:this.isMobile()?"Y":"N",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",SEARCH_MARK:!a&&this.BXIM.messenger.users[t]&&this.BXIM.messenger.users[t].search_mark?this.BXIM.messenger.users[t].search_mark:"",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:o,onprogress:function(e){if(e.position==0&&e.totalSize==0){n()}},onfailure:n})};t.prototype.openDialog=function(e,t,r){var i=s.MessengerCommon.getUserParam(e);if(i.id<=0)return false;e=e?e:0;var a=this.recentListGetItem(e);if(a&&a.unread){this.recentListUpdateItem({id:e,unread:false});this.recentListRedraw();s.rest.callMethod("im.recent.unread",{DIALOG_ID:e,ACTION:"N"})}this.BXIM.messenger.currentTab=e;if(e.toString().substr(0,4)=="chat"){this.BXIM.messenger.openChatFlag=true;if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="call")this.BXIM.messenger.openCallFlag=true;else if(this.BXIM.messenger.chat[e.toString().substr(4)]&&this.BXIM.messenger.chat[e.toString().substr(4)].type=="lines"){if(!this.BXIM.bitrixOpenLines){return false}this.BXIM.messenger.openLinesFlag=true}}s.localStorage.set("mct",this.BXIM.messenger.currentTab,15);if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}if(!this.isMobile()){if(this.BXIM.messenger.popupMessengerPanel){this.BXIM.messenger.popupMessengerPanel.className=this.BXIM.messenger.openChatFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel"}if(this.BXIM.messenger.openChatFlag){this.BXIM.messenger.popupMessengerPanelChat.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel bx-messenger-hide":"bx-messenger-panel";this.BXIM.messenger.popupMessengerPanelCall.className=this.BXIM.messenger.openCallFlag?"bx-messenger-panel":"bx-messenger-panel bx-messenger-hide"}else{this.BXIM.messenger.popupMessengerPanelChat.className="bx-messenger-panel bx-messenger-hide";this.BXIM.messenger.popupMessengerPanelCall.className="bx-messenger-panel bx-messenger-hide"}}t=t==true;r=r===true;var n=[];if(typeof this.BXIM.messenger.showMessage[e]!="undefined"&&this.BXIM.messenger.showMessage[e].length>0){if(!this.isMobile()&&this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length!=0&&this.BXIM.messenger.showMessage[e].length==s.MessengerCommon.getCounter(e)){this.drawTab(e,true);s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");var o=s.create("div",{props:{className:"bx-notifier-content-link-history"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]});this.BXIM.messenger.redrawTab[e]=true;this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(o,this.BXIM.messenger.popupMessengerBodyWrap.firstChild);if(this.isMobile()){setTimeout(s.delegate((function(){this.BXIM.messenger.autoScroll()}),this),100)}}else if(!i.fake&&this.BXIM.messenger.showMessage[e].length>=15){if(this.isMobile()&&this.BXIM.webComponent){this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}else if(this.BXIM.messenger.redrawTab[e]){this.drawTab(e,true)}}else{this.drawTab(e,true);this.BXIM.messenger.redrawTab[e]=true}}else if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_ERROR")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(typeof this.BXIM.messenger.showMessage[e]=="undefined"){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.redrawTab[e]=true}else if(this.BXIM.messenger.redrawTab[e]&&this.BXIM.messenger.showMessage[e].length==0){s.addClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-load"},children:[s.create("span",{props:{className:"bx-messenger-content-load-img"}}),s.create("span",{props:{className:"bx-messenger-content-load-text"},html:s.message("IM_M_LOAD_MESSAGE")})]})];this.BXIM.messenger.showMessage[e]=[]}else{var l="";if(this.isBot(e)&&this.BXIM.messenger.users[e]){l=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{l=s.message("IM_M_NO_MESSAGE")}s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");n=[s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:l})]})]}if(n.length>0){this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.adjust(this.BXIM.messenger.popupMessengerBodyWrap,{children:n})}if(t)this.BXIM.messenger.extraClose();if(r&&this.BXIM.callController&&this.BXIM.callController.hasActiveCall())this.BXIM.callController.showChat();if(this.isMobile()){BXMobileApp.UI.Page.TextPanel.setText(this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:"")}else{this.BXIM.messenger.popupMessengerTextarea.value=this.BXIM.messenger.textareaHistory[e]?this.BXIM.messenger.textareaHistory[e]:""}if(this.BXIM.messenger.redrawTab[e]){this.loadLastMessage(e)}else{this.drawTab(e,true);if(this.isMobile()){this.BXIM.isFocusMobile(s.delegate((function(t){if(t){s.MessengerCommon.readMessage(e)}}),this))}else if(this.BXIM.isFocus()){this.readMessage(e)}}if(!this.isMobile())this.BXIM.messenger.resizeMainWindow();if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(e,false)}else{this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}}s.onCustomEvent("onImDialogOpen",[{id:e}]);if(this.isMobile()){BXMobileApp.onCustomEvent("onImDialogOpen",{id:e},true)}else{this.BXIM.messenger.linesShowPromo();this.support24QuestionShowPromo()}};t.prototype.support24QuestionShowPromo=function(){clearTimeout(this.support24QuestionSchedulePromoTimeout);this.support24QuestionSchedulePromoTimeout=null;clearTimeout(this.support24QuestionShowPromoTimeout);this.support24QuestionShowPromoTimeout=null;if(!this.BXIM.messenger.currentTab||!this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!=="support24"||!s.MessengerPromo||typeof s.MessengerPromo.show!=="function"){return false}if(this.BXIM.messenger.popupMessengerTextarea.disabled){this.support24QuestionSchedulePromoTimeout=setTimeout(this.support24QuestionShowPromo.bind(this),5e3);return true}this.support24QuestionShowPromoTimeout=setTimeout((function(){var e=document.getElementsByClassName("bx-messenger-textarea-icon-marketplace-app-question")[0];if(!e){return}s.MessengerPromo.show("imbot:support24:25112021:web",e,{offsetLeft:15})}),2e4)};t.prototype.drawTab=function(e,t,r,i){r=r||0;i=i!==false;if(!e){e=this.BXIM.messenger.currentTab}if(this.BXIM.messenger.popupMessenger==null||e!=this.BXIM.messenger.currentTab)return false;if(typeof this.messageGroup!="object"){this.messageGroup={}}this.messageGroup["default"]={};var a=true;if(this.BXIM.messenger.openChatFlag){var n=e.toString().substr(4);if(this.BXIM.messenger.chat[n]){if(this.BXIM.messenger.chat[n].type=="open"){if(!s.MessengerCommon.userInChat(n)){if(this.isMobile()){BXMobileApp.onCustomEvent("onPullExtendWatch",{id:"IM_PUBLIC_"+n,force:this.BXIM.messenger.redrawTab[e]?false:true},true)}else{s.PULL.extendWatch("IM_PUBLIC_"+n,this.BXIM.messenger.redrawTab[e]?false:true)}}}else if(this.BXIM.messenger.chat[n].type=="lines"&&this.isLinesOperator()){a=false}}}if(this.isPage()&&i){if(a){if(s.MessengerWindow.currentTab!="im"){s.MessengerWindow.changeTab("im")}}else{if(s.MessengerWindow.currentTab!="im-ol"){s.MessengerWindow.changeTab("im-ol")}}}if(this.isMobile()){this.BXIM.messenger.dialogStatusRedrawDelay()}else{this.BXIM.messenger.dialogStatusRedraw()}this.BXIM.messenger.popupMessengerBodyWrap.innerHTML="";s.removeClass(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-loading");if(!this.BXIM.messenger.showMessage[e]||this.BXIM.messenger.showMessage[e].length<=0){var o="";var l=null;if(this.isBot(e)&&this.BXIM.messenger.users[e]){o=s.message("IM_M_NO_MESSAGE_BOT").replace("#BOT_NAME#",this.BXIM.messenger.users[e].name)}else{o=s.message("IM_M_NO_MESSAGE");l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate((function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)}),this)}})}this.BXIM.messenger.popupMessengerBodyWrap.appendChild(s.create("div",{props:{className:"bx-messenger-content-empty"},children:[s.create("span",{props:{className:"bx-messenger-content-load-text"},html:o}),l]}))}if(this.BXIM.messenger.showMessage[e])this.BXIM.messenger.showMessage[e].sort(s.delegate((function(e,s){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[s]){return 0}var t=this.BXIM.messenger.message[e].date.getTime();var r=this.BXIM.messenger.message[s].date.getTime();if(t<r){return-1}else if(t>r){return 1}else{if(e<s){return-1}else if(e>s){return 1}else{return 0}}}),this));else this.BXIM.messenger.showMessage[e]=[];for(var m=0;m<this.BXIM.messenger.showMessage[e].length;m++){if(this.isMobile()&&this.BXIM.webComponent&&this.BXIM.messenger.showMessage[e][m].toString().indexOf("temp")==0){continue}s.MessengerCommon.drawMessage(e,this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][m]],false)}if(r>0&&r<30){if(!this.BXIM.messenger.openChatFlag||this.BXIM.messenger.chat[e.toString().substr(4)]){var h=false;if(this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.chat[e.toString().substr(4)].date_create){if(this.BXIM.messenger.chat[e.toString().substr(4)].date_create.getTime()/1e3+25e5>(new Date).getTime()/1e3){h=true}}if(!h){var l=s.create("span",{props:{className:"bx-notifier-content-link-history bx-notifier-content-link-history-empty"},children:[s.create("span",{props:{className:"bx-notifier-item-button bx-notifier-item-button-white"},html:s.message("IM_M_NO_MESSAGE_LOAD")})],events:{click:s.delegate((function(){this.loadHistory(this.BXIM.messenger.currentTab,false,true)}),this)}});this.BXIM.messenger.popupMessengerBodyWrap.insertBefore(l,this.BXIM.messenger.popupMessengerBodyWrap.firstChild)}}}if(this.BXIM.messenger.chat[n]){if(this.BXIM.messenger.chat[n].entity_type=="LINES"){var g=s.MessengerCommon.linesGetSession(this.BXIM.messenger.chat[n]);var p;if(parseInt(g.id)>0){for(m=0;m<this.BXIM.messenger.openlines.queue.length;m++){if(this.BXIM.messenger.openlines.queue[m].id==g.lineId){p=this.BXIM.messenger.openlines.queue[m];break}}if(p&&p.queue_type=="all"){if(!s.MessengerCommon.isSessionBlocked(n)){s.style(this.BXIM.messenger.popupMessengerTextareaOpenLinesSkip,"display","none")}else{s.style(this.BXIM.messenger.popupMessengerTextareaOpenLinesSkip,"display","inline-block")}}else{s.style(this.BXIM.messenger.popupMessengerTextareaOpenLinesSkip,"display","inline-block")}}}}t=t!=false;if(t){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();if(e!=this.BXIM.userId&&this.BXIM.messenger.unreadMessage[e]&&this.BXIM.messenger.unreadMessage[e].length>0){var c=s("im-message-"+this.BXIM.messenger.unreadMessage[e][0]);if(c&&c.parentNode.parentNode.parentNode.parentNode.parentNode){this.scrollToNode(c.parentNode.parentNode.parentNode.parentNode.parentNode)}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}s.onCustomEvent("onImDrawTab",[{id:e,hasMessage:this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0}]);if(s.MessengerProxy&&s.MessengerCommon.getCounter(e)===0){s.MessengerProxy.sendCounterChangeEvent(e,0)}if(s.MessengerCommon.countWriting(e)){if(this.BXIM.messenger.openChatFlag)s.MessengerCommon.drawWriting(0,e);else s.MessengerCommon.drawWriting(e)}else if(this.BXIM.messenger.readedList[e]){if(this.BXIM.messenger.openChatFlag){this.drawReadMessageChat(e,false)}else{this.drawReadMessage(e,this.BXIM.messenger.readedList[e].messageId,this.BXIM.messenger.readedList[e].date,false)}}if(this.BXIM.messenger.linesWritingList[n]){var d="chat"+n;if(d===BXIM.messenger.currentTab){s.MessengerCommon.drawMessage(BXIM.messenger.currentTab,BXIM.messenger.linesWritingList[n]);var I=s.findChildByClassName(this.BXIM.messenger.popupMessengerBodyWrap,"bx-messenger-content-item-id-"+BXIM.messenger.linesWritingList[n].id);clearTimeout(this.BXIM.messenger.linesWritingListTimeout[n]);this.BXIM.messenger.linesWritingListTimeout[n]=setTimeout(s.delegate((function(){s.remove(I);delete this.BXIM.messenger.linesWritingList[n]}),this),29500)}}};t.prototype.scrollToNode=function(t){var r=s(t);var i=navigator.userAgent.indexOf("Edge")>-1;if(!i&&r.scrollIntoView){r.scrollIntoView(true)}else{var a=s.pos(r);e.scrollTo(a.left,a.top)}};t.prototype.sendMessageAjax=function(t,r,i,a,n){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;s.MessengerCommon.drawProgessMessage("temp"+t);if(this.BXIM.messenger.sendMessageFlag<0)this.BXIM.messenger.sendMessageFlag=0;clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout["temp"+t]);if(this.BXIM.messenger.sendMessageTmp[t])return false;this.BXIM.messenger.sendMessageTmp[t]=true;a=a==true;this.BXIM.messenger.sendMessageFlag++;if(typeof n==="boolean"){n=n?"Y":"N"}else{n="N";if(a&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[r.toString().substr(4)]){n="Y"}}this.recentListAddItem({id:r,message:{id:"temp"+t,date:new Date,author_id:this.BXIM.userId,status:"received",text:s.util.htmlspecialchars(i),attach:false,file:false}});this.recentListRedraw();this.BXIM.messenger.updateMessageCount();s.onCustomEvent("onImBeforeMessageSend",[{recipientId:r,messageText:i}]);if(s.MessengerProxy){s.MessengerProxy.sendSetMessageEvent({id:"temp"+t,dialogId:r,text:i,date:new Date})}var o=s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SEND&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.add",dialog:s.MessengerCommon.getDialogDataForTracking(r)}),method:"POST",dataType:"json",skipAuthCheck:true,timeout:120,data:{IM_SEND_MESSAGE:"Y",CHAT:a?"Y":"N",ID:"temp"+t,RECIPIENT_ID:r,MESSAGE:i,OL_SILENT:n,TAB:this.BXIM.messenger.currentTab,USER_TZ_OFFSET:s.message("USER_TZ_OFFSET"),IM_AJAX_CALL:"Y",FOCUS:!this.isMobile()||typeof BXMobileAppContext!="object"||BXMobileAppContext.isBackground()?"N":"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(n){if(this.isMobile()&&typeof fabric!="undefined"){fabric.Answers.sendCustomEvent("imMessageSend",{})}this.BXIM.messenger.sendMessageFlag--;if(n&&n.BITRIX_SESSID){s.message({bitrix_sessid:n.BITRIX_SESSID})}if(n&&n.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;if(this.BXIM.messenger.message[n.TMP_ID]){this.BXIM.messenger.message[n.TMP_ID].date=new Date(n.SEND_DATE);this.BXIM.messenger.message[n.TMP_ID].textOriginal=n.SEND_MESSAGE;this.BXIM.messenger.message[n.TMP_ID].text=s.MessengerCommon.prepareText(n.SEND_MESSAGE,true,true,true);this.BXIM.messenger.message[n.TMP_ID].id=n.ID;if(n.SEND_MESSAGE_PARAMS){this.BXIM.messenger.message[n.TMP_ID].params=n.SEND_MESSAGE_PARAMS}this.BXIM.messenger.message[n.ID]=this.BXIM.messenger.message[n.TMP_ID];delete this.BXIM.messenger.message[n.TMP_ID]}for(var o in n.SEND_MESSAGE_FILES){if(!this.BXIM.messenger.disk.files[n.CHAT_ID])this.BXIM.messenger.disk.files[n.CHAT_ID]={};if(this.BXIM.messenger.disk.files[n.CHAT_ID][o])continue;n.SEND_MESSAGE_FILES[o].date=new Date(n.SEND_MESSAGE_FILES[o].date);this.BXIM.messenger.disk.files[n.CHAT_ID][o]=n.SEND_MESSAGE_FILES[o]}if(this.BXIM.messenger.popupMessengerLastMessage==n.TMP_ID)this.BXIM.messenger.popupMessengerLastMessage=n.ID;var l=this.BXIM.messenger.message[n.ID];this.BXIM.messenger.showMessage[n.RECIPIENT_ID]=this.BXIM.messenger.showMessage[n.RECIPIENT_ID].filter((function(e){return e!=n.TMP_ID&&e!=n.ID}));this.BXIM.messenger.showMessage[n.RECIPIENT_ID].push(n.ID);var m=this.BXIM.messenger.recent.find((function(e){return e.message.id==n.TMP_ID}));if(m){m.message.id=""+n.ID+""}if(n.RECIPIENT_ID==this.BXIM.messenger.currentTab){var h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+n.TMP_ID+""}},true);if(!h){h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":""+n.ID+""}},true)}if(h){h.setAttribute("data-messageid",""+n.ID+"");if(h.getAttribute("data-blockmessageid")==""+n.TMP_ID+""){h.setAttribute("data-blockmessageid",""+n.ID+"")}else{var g=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+n.TMP_ID+""}},true);if(g){g.setAttribute("data-blockmessageid",""+n.ID+"")}}var p=s.findChild(h,{attribute:{"data-messageid":""+n.TMP_ID+""}},true);if(p){p.setAttribute("data-messageid",""+n.ID+"")}}var c=s("im-message-keyboard-"+n.TMP_ID);if(c){c.id="im-message-keyboard-"+n.ID}else{c=s("im-message-keyboard-empty-"+n.TMP_ID);if(c){c.id="im-message-keyboard-empty-"+n.ID}}s.MessengerCommon.clearProgessMessage(n.TMP_ID);var d=s("im-message-"+n.TMP_ID);if(!d){d=s("im-message-"+n.ID)}if(d){d.id="im-message-"+n.ID;var I={oneSmileInMessage:false};d.innerHTML=s.MessengerCommon.prepareText(n.SEND_MESSAGE,true,true,true,null,I);if(I.oneSmileInMessage){var u=s.findChildByClassName(h,"bx-messenger-content-item-content");if(u){s.addClass(u,"bx-messenger-content-item-content-transparent")}}}var M=s.findChildByClassName(h,"bx-messenger-content-item-date");if(M)M.innerHTML=s.MessengerCommon.formatDate(l.date,s.MessengerCommon.getDateFormatType("MESSAGE"))}if(!this.BXIM.messenger.history[n.RECIPIENT_ID]){this.BXIM.messenger.history[n.RECIPIENT_ID]=[]}this.BXIM.messenger.history[n.RECIPIENT_ID]=this.BXIM.messenger.history[n.RECIPIENT_ID].filter((function(e){return e!=l.id}));this.BXIM.messenger.history[n.RECIPIENT_ID].push(l.id);this.BXIM.messenger.updateStateVeryFastCount=2;this.BXIM.messenger.updateStateFastCount=5;this.BXIM.messenger.setUpdateStateStep();if(n.SEND_MESSAGE_PARAMS){if(n.SEND_MESSAGE_PARAMS.URL_ONLY=="Y"&&this.BXIM.settings.enableRichLink){s.addClass(h.firstElementChild,"bx-messenger-content-item-content-rich-link")}if(n.SEND_MESSAGE_PARAMS.LARGE_FONT=="Y"&&this.BXIM.settings.enableBigSmile){s.addClass(h.firstElementChild,"bx-messenger-content-item-content-large-font")}if(n.RECIPIENT_ID.toString().substr(0,4)=="chat"){if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[{command:"messageParamsUpdate",params:{id:n.ID,type:"chat",chatId:n.CHAT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}}])}else{s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:n.ID,type:"chat",chatId:n.CHAT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}else{if(this.isMobile()){s.onCustomEvent(e,"onPull-im",[{command:"messageParamsUpdate",params:{id:n.ID,type:"private",chatId:n.CHAT_ID,fromUserId:n.SENDER_ID,toUserId:n.RECIPIENT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},extra:{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}}])}else{s.onCustomEvent(e,"onPullEvent-im",["messageParamsUpdate",{id:n.ID,type:"private",chatId:n.CHAT_ID,fromUserId:n.SENDER_ID,toUserId:n.RECIPIENT_ID,senderId:n.SENDER_ID,params:n.SEND_MESSAGE_PARAMS,animation:"N"},{revision_im_web:this.BXIM.revision,revision_im_mobile:this.BXIM.revision}])}}}s.MessengerCommon.updateStateVar(n,true,true);s.localStorage.set("msm2",{id:n.ID,recipientId:n.RECIPIENT_ID,date:n.SEND_DATE,text:n.SEND_MESSAGE,senderId:this.BXIM.userId,MESSAGE:n.MESSAGE,USERS_MESSAGE:n.USERS_MESSAGE,USERS:n.USERS,USER_IN_GROUP:n.USER_IN_GROUP},5);if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0}else if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:800,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate((function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll}),this)})).animate()}else{this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(this.isMobile()?0:1)}}else{if(n&&n.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate((function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)}),this),2e3);s.onCustomEvent(e,"onImError",[n.ERROR,n.BITRIX_SESSID])}else if(n&&n.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;if(this.isDesktop()||this.isMobile()){setTimeout(s.delegate((function(){this.BXIM.messenger.sendMessageTmp[t]=false;this.sendMessageAjax(t,r,i,a)}),this),1e4)}s.onCustomEvent(e,"onImError",[n.ERROR])}else{this.BXIM.messenger.sendMessageTmp[t]=false;var h=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var M=s.findChildByClassName(h,"bx-messenger-content-item-date");console.warn(M);if(M){if(n.ERROR=="SESSION_ERROR"||n.ERROR=="AUTHORIZE_ERROR"||n.ERROR=="UNKNOWN_ERROR"||n.ERROR=="IM_MODULE_NOT_INSTALLED")M.innerHTML=s.message("IM_M_NOT_DELIVERED");else M.innerHTML=n.ERROR}s.onCustomEvent(e,"onImError",["SEND_ERROR",n.ERROR,n.TMP_ID,n.SEND_DATE,n.SEND_MESSAGE,n.RECIPIENT_ID]);console.log("temp"+t);s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true}}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.sendMessageFlag--;this.BXIM.messenger.sendMessageTmp[t]=false;var r=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-messageid":"temp"+t}},true);var i=s.findChildByClassName(r,"bx-messenger-content-item-date");if(i)i.innerHTML=s.message("IM_M_NOT_DELIVERED");s.MessengerCommon.drawProgessMessage("temp"+t,{title:s.message("IM_M_RETRY"),chat:a?"Y":"N"});this.BXIM.messenger.sendAjaxTry=0;try{if(typeof o=="object"&&o.status==0)s.onCustomEvent(e,"onImError",["CONNECT_ERROR"])}catch(e){}if(this.BXIM.messenger.message["temp"+t])this.BXIM.messenger.message["temp"+t].retry=true}),this)})};t.prototype.sendMessageRetry=function(){var e=this.BXIM.messenger.currentTab;var s=[];for(var t=0;t<this.BXIM.messenger.showMessage[e].length;t++){var r=this.BXIM.messenger.message[this.BXIM.messenger.showMessage[e][t]];if(!r||r.id.toString().indexOf("temp")!=0)continue;r.text=r.textOriginal;if(!r.text)continue;s.push(r)}if(s.length<=0)return false;s.sort((function(e,s){e=e.id.substr(4);s=s.id.substr(4);if(e<s){return-1}else if(e>s){return 1}else{return 0}}));for(var t=0;t<s.length;t++){this.sendMessageRetryTimeout(s[t],100*t)}};t.prototype.sendMessageRetryTimeout=function(e,t){var r=undefined;if(e.params&&e.params.CLASS==="bx-messenger-content-item-system"){r=true}clearTimeout(this.BXIM.messenger.sendMessageTmpTimeout[e.id]);this.BXIM.messenger.sendMessageTmpTimeout[e.id]=setTimeout(s.delegate((function(){s.MessengerCommon.sendMessageAjax(e.id.substr(4),e.recipientId,e.text,e.recipientId.toString().substr(0,4)=="chat",r)}),this),t)};t.prototype.getLastMessageInDialog=function(e){var s=false;if(this.BXIM.messenger.showMessage[e]&&this.BXIM.messenger.showMessage[e].length>0){var t=this.BXIM.messenger.showMessage[e][this.BXIM.messenger.showMessage[e].length-1];s=this.BXIM.messenger.message[t]}return s};t.prototype.joinToChat=function(e){if(this.BXIM.messenger.blockJoinChat[e]){return false}if(this.BXIM.messenger.chat[e]&&!(this.BXIM.messenger.chat[e].type=="open"||this.BXIM.messenger.chat[e].type=="announcement")){return false}if(s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?CHAT_JOIN&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:60,data:{IM_CHAT_JOIN:"Y",CHAT_ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.popupMessengerTextarea.disabled=false;this.BXIM.messenger.popupMessengerTextarea.focus()}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.messageUrlAttachDelete=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.ATTACH||!this.BXIM.messenger.message[e].params.URL_ID||this.BXIM.messenger.message[e].params.URL_ID.indexOf(parseInt(t))==-1&&this.BXIM.messenger.message[e].params.URL_ID.indexOf(t.toString())==-1){return false}for(var r=0;r<this.BXIM.messenger.message[e].params.ATTACH.length;r++){if(!this.BXIM.messenger.message[e].params.ATTACH[r])continue;if(this.BXIM.messenger.message[e].params.ATTACH[r].ID==t){delete this.BXIM.messenger.message[e].params.ATTACH[r];break}}for(var r=0;r<this.BXIM.messenger.message[e].params.URL_ID.length;r++){if(!this.BXIM.messenger.message[e].params.URL_ID[r])continue;if(this.BXIM.messenger.message[e].params.URL_ID[r]==t){delete this.BXIM.messenger.message[e].params.URL_ID[r];break}}var i=s("im-message-"+e);var a=s.MessengerCommon.drawAttach(e,this.BXIM.messenger.message[e].chatId,this.BXIM.messenger.message[e].params.ATTACH);i.nextElementSibling.innerHTML="";if(a.length>0){s.adjust(i.nextElementSibling,{children:a})}if(a.length<=0){s.removeClass(i.parentNode.parentNode.parentNode.parentNode,"bx-messenger-content-item-content-rich-link")}s.ajax({url:this.BXIM.pathToAjax+"?URL_ATTACH_DELETE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_URL_ATTACH_DELETE:"Y",ID:e,ATTACH_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});return true};t.prototype.messageLike=function(e,t){if(e.toString().substr(0,4)=="temp"||!this.BXIM.messenger.message[e]||this.BXIM.messenger.popupMessengerLikeBlock[e]){return false}t=typeof t=="undefined"?false:t;if(!this.BXIM.messenger.message[e].params){this.BXIM.messenger.message[e].params={}}if(!this.BXIM.messenger.message[e].params.LIKE){this.BXIM.messenger.message[e].params.LIKE=[]}var r=s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE);if(!t){var i=r?"minus":"plus";if(i=="plus"){this.BXIM.messenger.message[e].params.LIKE.push(this.BXIM.userId);r=true}else{var a=[];for(var n=0;n<this.BXIM.messenger.message[e].params.LIKE.length;n++){if(this.BXIM.messenger.message[e].params.LIKE[n]!=this.BXIM.userId){a.push(this.BXIM.messenger.message[e].params.LIKE[n])}}this.BXIM.messenger.message[e].params.LIKE=a;r=false}}var o=this.BXIM.messenger.message[e].params.LIKE.length>0?this.BXIM.messenger.message[e].params.LIKE.length:"";if(s("im-message-"+e)){var l=s.findChild(this.BXIM.messenger.popupMessengerBodyWrap,{attribute:{"data-blockmessageid":""+e+""}},false);var m=s.findChildByClassName(l,"bx-messenger-content-item-like");var h=s.findChildByClassName(l,"bx-messenger-content-like-digit",false);if(r){s.addClass(m,"bx-messenger-content-item-liked")}else{s.removeClass(m,"bx-messenger-content-item-liked")}if(o>0){h.setAttribute("title",s.message("IM_MESSAGE_LIKE_LIST"));s.removeClass(h.parentNode,"bx-messenger-content-like-digit-off")}else{h.setAttribute("title","");s.addClass(h.parentNode,"bx-messenger-content-like-digit-off")}h.innerHTML=o}if(this.isMobile()){app.exec("callVibration")}if(!t){clearTimeout(this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]);this.BXIM.messenger.popupMessengerLikeBlockTimeout[e]=setTimeout(s.delegate((function(){this.BXIM.messenger.popupMessengerLikeBlock[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_LIKE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_LIKE_MESSAGE:"Y",ID:e,ACTION:i,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){if(t.ERROR==""){this.BXIM.messenger.message[e].params.LIKE=t.LIKE}this.BXIM.messenger.popupMessengerLikeBlock[e]=false;s.MessengerCommon.messageLike(e,true)}),this),onfailure:s.delegate((function(s){this.BXIM.messenger.popupMessengerLikeBlock[e]=false}),this)})}),this),1e3)}return true};t.prototype.messageIsLike=function(e){return this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&typeof this.BXIM.messenger.message[e].params.LIKE=="object"&&s.util.in_array(this.BXIM.userId,this.BXIM.messenger.message[e].params.LIKE)};t.prototype.checkEditMessage=function(e,t){t=t||"list";if(this.BXIM.messenger.openLinesFlag){var r=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.currentTab.toString().substr(4)])}var i=false;if(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]&&(this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="support24")){return i}if(this.BXIM.ppServerStatus&&parseInt(e)!=0&&e.toString().substr(0,4)!="temp"&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].date.getTime()/1e3+259200>(new Date).getTime()/1e3&&(!this.BXIM.messenger.message[e].params||this.BXIM.messenger.message[e].params.IS_DELETED!="Y")&&s("im-message-"+e)&&s.util.in_array(e,this.BXIM.messenger.showMessage[this.BXIM.messenger.currentTab])){if(this.BXIM.messenger.openLinesFlag){if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){if(t=="edit"){i=this.BXIM.messenger.openlines.canUpdateOwnMessage.indexOf(r)>-1}else if(t=="delete"){i=this.BXIM.messenger.openlines.canDeleteOwnMessage.indexOf(r)>-1}}else if(this.BXIM.messenger.openlines.canDeleteMessage.indexOf(r)>-1&&t=="delete"){i=true}if(i&&r!="network"){if(this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.CLASS==="bx-messenger-content-item-system"){return true}if(!this.BXIM.messenger.message[e].params||typeof this.BXIM.messenger.message[e].params.CONNECTOR_MID=="undefined"||this.BXIM.messenger.message[e].params.CONNECTOR_MID.length<=0){i=false}}}else if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){i=true}}return i};t.prototype.editMessageAjax=function(e,t){if(this.BXIM.messenger.popupMessengerConnectionStatusState!="online")return false;this.BXIM.messenger.editMessageCancel();if(!s.MessengerCommon.checkEditMessage(e,"edit"))return false;if(t==this.BXIM.messenger.message[e].textOriginal)return false;t=t.replace("    ","\t");t=s.util.trim(t);if(t.length<=0){s.MessengerCommon.deleteMessageAjax(e);return false}this.BXIM.messenger.message[e].text=s.MessengerCommon.prepareText(t,true,true,true);this.BXIM.messenger.message[e].textOriginal=t;t=s.MessengerCommon.prepareMention(this.BXIM.messenger.currentTab,t);s.MessengerCommon.drawProgessMessage(e);if(s.MessengerProxy){s.MessengerProxy.sendSetMessageEvent({id:+e,dialogId:this.BXIM.messenger.message[e].recipientId,text:this.BXIM.messenger.message[e].textOriginal})}s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_EDIT&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.update",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId)}),method:"POST",dataType:"json",timeout:30,data:{IM_EDIT_MESSAGE:"Y",ID:e,MESSAGE:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){s.MessengerCommon.clearProgessMessage(e)}),this),onfailure:s.delegate((function(){s.MessengerCommon.clearProgessMessage(e)}),this)})};t.prototype.deleteMessageAjax=function(e){this.BXIM.messenger.editMessageCancel();if(this.BXIM.isAdmin&&this.BXIM.messenger.openChatFlag&&this.BXIM.messenger.message[e].chatId&&this.BXIM.messenger.generalChatId==this.BXIM.messenger.message[e].chatId){}else if(!s.MessengerCommon.checkEditMessage(e,"delete")){return false}s.MessengerCommon.drawProgessMessage(e);if(s.MessengerProxy){s.MessengerProxy.sendSetMessageEvent({id:+e,dialogId:this.BXIM.messenger.message[e].recipientId,text:this.BXIM.messenger.message[e].textOriginal})}s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_DELETE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.delete",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId)}),method:"POST",dataType:"json",timeout:30,data:{IM_DELETE_MESSAGE:"Y",ID:e,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){if(t.ERROR)return false;if(this.BXIM.messenger.message[e]){this.BXIM.messenger.message[e].isNowDeleted=true}s.MessengerCommon.clearProgessMessage(e)}),this),onfailure:s.delegate((function(){s.MessengerCommon.clearProgessMessage(e)}),this)});return true};t.prototype.shareMessageAjax=function(e,t,r){s.MessengerCommon.drawProgessMessage(e);s.ajax({url:this.BXIM.pathToAjax+"?MESSAGE_SHARE&TYPE="+t+"&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"im.message.share",dialog:s.MessengerCommon.getDialogDataForTracking(this.BXIM.messenger.message[e].recipientId),data:{timShareType:t.toString().toLowerCase()}}),method:"POST",dataType:"json",timeout:30,data:{IM_SHARE_MESSAGE:"Y",ID:e,TYPE:t,DATE:r?r:0,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(r){s.MessengerCommon.clearProgessMessage(e);if(r.ERROR){if(t==="POST"){s.UI.Notification.Center.notify({content:s.message("IM_SHARE_POST_ERROR"),autoHideDelay:2e3})}return false}}),this),onfailure:s.delegate((function(){s.MessengerCommon.clearProgessMessage(e)}),this)});return true};t.prototype.drawKeyboard=function(e,t,r){if(!r||r=="N"){i=s.create("div",{attrs:{id:"im-message-keyboard-empty-"+t}});return i}var i=null;var a=[];var n=null;var o=null;for(var l=0;l<r.length;l++){if(r[l].TYPE=="NEWLINE"){n=s.create("div",{props:{className:"bx-messenger-keyboard-new-line"}})}else{if(r[l].CONTEXT&&(this.isMobile()&&r[l].CONTEXT=="DESKTOP"||!this.isMobile()&&r[l].CONTEXT=="MOBILE")){continue}var m="";if(r[l].WIDTH){m=m+"width: "+r[l].WIDTH+"px;"}else if(r[l].DISPLAY=="BLOCK"){m=m+"width: 225px;"}if(r[l].BG_COLOR){m=m+"background-color: "+r[l].BG_COLOR+";"}if(r[l].TEXT_COLOR){m=m+"color: "+r[l].TEXT_COLOR+";"}if(r[l].DISABLED&&r[l].DISABLED=="Y"){o='<span class="bx-messenger-keyboard-button-text bx-messenger-keyboard-button-disabled" data-disabled="Y" style="'+m+'">'+s.util.htmlspecialchars(r[l].TEXT)+"</span>"}else{if(r[l].LINK){o='<a href="'+r[l].LINK+'" target="_blank" class="bx-messenger-keyboard-button-text" style="'+m+'">'+s.util.htmlspecialchars(r[l].TEXT)+"</a>"}else if(r[l].FUNCTION){var h=r[l].FUNCTION.toString().replace("#MESSAGE_ID#",t).replace("#DIALOG_ID#",e).replace("#USER_ID#",this.BXIM.userId);o='<a href="javascript:void(1);" onclick="'+h+'; BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+m+'">'+s.util.htmlspecialchars(r[l].TEXT)+"</a>"}else if(r[l].ACTION&&r[l].ACTION_VALUE.toString()){o='<a href="javascript:void(1);" onclick="BX.MessengerCommon.executeParamsButton(\'KEYBOARD\', '+t+", "+l+', event);" class="bx-messenger-keyboard-button-text" style="'+m+'">'+s.util.htmlspecialchars(r[l].TEXT)+"</a>"}else if(r[l].APP_ID){r[l].APP_PARAMS=r[l].APP_PARAMS?r[l].APP_PARAMS:"";o='<a href="javascript:void(1);" onclick="BXIM.messenger.textareaIconDialogClick('+parseInt(r[l].APP_ID)+", "+t+", '"+s.util.htmlspecialchars(r[l].APP_PARAMS)+'\'); BX.PreventDefault(event);" class="bx-messenger-keyboard-button-text" style="'+m+'">'+s.util.htmlspecialchars(r[l].TEXT)+"</a>"}else{o='<span class="bx-messenger-keyboard-button-text" data-dialogId="'+e+'" data-messageId="'+t+'" data-blockAfterClick="'+r[l].BLOCK+'" data-command="'+s.util.htmlspecialchars(r[l].COMMAND)+'" data-commandParams="'+s.util.htmlspecialchars(r[l].COMMAND_PARAMS)+'" data-botId="'+r[l].BOT_ID+'" style="'+m+'">'+s.util.htmlspecialchars(r[l].TEXT)+"</span>"}}n=s.create("span",{props:{className:"bx-messenger-keyboard-button bx-messenger-keyboard-button-"+r[l].DISPLAY.toLowerCase()},children:[o]})}a.push(n)}if(a.length>0){i=s.create("div",{attrs:{id:"im-message-keyboard-"+t},props:{className:"bx-messenger-keyboard"},children:a})}else{i=s.create("div",{attrs:{id:"im-message-keyboard-empty-"+t}})}return i};t.prototype.executeParamsButton=function(e,t,r){if(!this.BXIM.messenger.message[t]||!this.BXIM.messenger.message[t].params[e]||!this.BXIM.messenger.message[t].params[e][r]){return false}var i=this.BXIM.messenger.message[t].params[e][r];if(i.ACTION){if(i.ACTION==="SEND"){this.BXIM.sendMessage(this.BXIM.messenger.currentTab,i.ACTION_VALUE)}else if(i.ACTION==="PUT"){this.BXIM.putMessage(i.ACTION_VALUE)}else if(i.ACTION==="CALL"){this.BXIM.phoneTo(i.ACTION_VALUE)}else if(i.ACTION==="HELP"){if(i.ACTION_VALUE!==""&&i.ACTION_VALUE!=="-"){s.Helper.show("redirect=detail&HD_ID="+i.ACTION_VALUE)}else{s.Helper.show()}}else if(i.ACTION==="COPY"){if(this.isMobile()){app.exec("copyToClipboard",{text:i.ACTION_VALUE});new BXMobileApp.UI.NotificationBar({message:s.message("IM_COPIED"),color:"#af000000",textColor:"#ffffff",groupId:"clipboard",maxLines:1,align:"center",isGlobal:true,useCloseButton:true,autoHideTimeout:1500,hideOnTap:true},"copy").show()}else{s.UI.Notification.Center.notify({content:s.message("IM_COPIED"),autoHideDelay:2e3});s.MessengerCommon.clipboardCopy(i.ACTION_VALUE)}}else if(i.ACTION==="DIALOG"){this.BXIM.openMessenger(i.ACTION_VALUE)}}return false};t.prototype.clickButtonKeyboard=function(){if(s.proxy_context.tagName=="A")return true;if(this.sendBotCommand)return true;var e=s.proxy_context.getAttribute("data-dialogId");var t=s.proxy_context.getAttribute("data-messageId");var r=s.proxy_context.getAttribute("data-botId");var i=s.proxy_context.getAttribute("data-command");var a=s.proxy_context.getAttribute("data-commandParams");var n=s.proxy_context.getAttribute("data-disabled");var o=s.proxy_context.getAttribute("data-blockAfterClick");if(n=="Y"||s.hasClass(s.proxy_context,"bx-messenger-keyboard-button-block"))return true;this.sendBotCommand=true;if(!this.sendBotCommandBlock[r]){this.sendBotCommandBlock[r]={}}this.sendBotCommandBlock[r][t]=true;if(o=="Y"){var l=s("im-message-keyboard-"+t);if(l){var m=s.findChildrenByClassName(l,"bx-messenger-keyboard-button-text",false);for(var h=0;h<m.length;h++){s.addClass(m[h],"bx-messenger-keyboard-button-block")}}}s.addClass(s.proxy_context,"bx-messenger-keyboard-button-progress bx-messenger-keyboard-button-block");s.ajax({url:this.BXIM.pathToCallAjax+"?BOT_COMMAND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_BOT_COMMAND:"Y",BOT_ID:r,COMMAND:i,COMMAND_PARAMS:a,DIALOG_ID:e,MESSAGE_ID:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){this.sendBotCommand=false}),this),onfailure:s.delegate((function(){this.sendBotCommand=false}),this)});return true};t.prototype.drawAttach=function(e,t,r,i){if(!r||r.length==0)return[];var a=[];if(typeof r!="object"){a.push(r)}else{a=r}i=i||{};var n=this.getUserIdByChatId(t);var o=[];for(var l=0;l<a.length;l++){var m=a[l];if(!m)continue;var h="";if(typeof m.COLOR!="undefined"){h=m.COLOR}else if(n&&this.BXIM.messenger.users[n]){h=this.BXIM.messenger.users[n].color}else if(this.BXIM.messenger.chat[t]){h=this.BXIM.messenger.chat[t].color}else if(this.BXIM.messenger.users[this.BXIM.userId]){h=this.BXIM.messenger.users[this.BXIM.userId].color}if(typeof m["BLOCKS"]!="object"){continue}var g=typeof m["ID"]!="undefined"?m["ID"]:0;var p=[];var c=false;if(g&&this.BXIM.messenger.message[e]&&this.BXIM.messenger.message[e].params&&this.BXIM.messenger.message[e].params.URL_ID&&(this.BXIM.messenger.message[e].params.URL_ID.indexOf(g)>-1||this.BXIM.messenger.message[e].params.URL_ID.indexOf(parseInt(g))>-1)){if(!this.BXIM.settings.enableRichLink){continue}if(this.BXIM.messenger.message[e].senderId==this.BXIM.userId){c=true}}if(c){p.push(s.create("span",{props:{className:"bx-messenger-attach-delete"},attrs:{"data-attachId":g,"data-messageId":e,"data-action":"url"}}))}for(var d=0;d<m["BLOCKS"].length;d++){var I=m["BLOCKS"][d];var u=null;if(I.USER&&I.USER.length>0){var M=[];for(var f=0;f<I.USER.length;f++){var B=null;if(I.USER[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"network","data-networkId":I.USER[f].NETWORK_ID},text:I.USER[f].NAME})}else if(I.USER[f].BOT_ID){if(this.BXIM.messenger.users[I.USER[f].BOT_ID]){I.USER[f].NAME=this.BXIM.messenger.users[I.USER[f].BOT_ID].name;I.USER[f].AVATAR=this.BXIM.messenger.users[I.USER[f].BOT_ID].avatar}else if(!this.BXIM.messenger.bot[I.USER[f].BOT_ID]){I.USER[f].AVATAR=""}B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"user","data-userId":I.USER[f].BOT_ID},text:I.USER[f].NAME})}else if(I.USER[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax "+(I.USER[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":I.USER[f].USER_ID},text:I.USER[f].NAME});if(this.BXIM.messenger.users[I.USER[f].USER_ID]){I.USER[f].AVATAR=this.BXIM.messenger.users[I.USER[f].USER_ID].avatar}}else if(I.USER[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-attach-user-name bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":I.USER[f].CHAT_ID},text:I.USER[f].NAME})}else if(I.USER[f].LINK){B=s.create("a",{attrs:{href:this.formatUrl(I.USER[f].LINK),target:"_blank"},props:{className:"bx-messenger-attach-user-name"},text:I.USER[f].NAME})}else{B=s.create("span",{props:{className:"bx-messenger-attach-user-name"},text:I.USER[f].NAME})}var X="user";if(I.USER[f].AVATAR_TYPE=="CHAT"){X="chat"}else if(I.USER[f].AVATAR_TYPE=="BOT"){X="bot"}var b=s.create("span",{props:{className:"bx-messenger-attach-user"},children:[s.create("span",{props:{className:"bx-messenger-attach-user-avatar"},children:[I.USER[f].AVATAR?s.create("img",{attrs:{src:this.formatUrl(I.USER[f].AVATAR)},props:{className:"bx-messenger-attach-user-avatar-img"}}):s.create("span",{attrs:{style:"background-color: "+h},props:{className:"bx-messenger-attach-user-avatar-img bx-messenger-attach-"+X+"-avatar-default "}})]}),B]});M.push(b)}u=s.create("span",{props:{className:"bx-messenger-attach-users"},children:M})}else if(I.LINK&&I.LINK.length>0){var E=[];for(var f=0;f<I.LINK.length;f++){var B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},text:I.LINK[f].NAME?I.LINK[f].NAME:I.LINK[f].LINK});if(I.LINK[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":I.LINK[f].NETWORK_ID},children:[B]})}else if(I.LINK[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "+(I.LINK[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":I.LINK[f].USER_ID},children:[B]})}else if(I.LINK[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":I.LINK[f].CHAT_ID},children:[B]})}else{B=s.create("span",{props:{className:"bx-messenger-attach-link-name"},children:[s.create("a",{attrs:{href:this.formatUrl(I.LINK[f].LINK),target:"_blank"},text:I.LINK[f].NAME?I.LINK[f].NAME:I.LINK[f].LINK})]})}var C=null;if(I.LINK[f].HTML){C=s.create("span",{props:{className:"bx-messenger-attach-link-desc"},html:s.MessengerCommon.prepareText(I.LINK[f].HTML,true,true,true)})}else if(I.LINK[f].DESC){C=s.create("span",{props:{className:"bx-messenger-attach-link-desc"},html:s.MessengerCommon.prepareText(I.LINK[f].DESC,true,true,true)})}var _=null;if(I.LINK[f].PREVIEW){_=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:this.formatUrl(I.LINK[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}})]});var S=s.create("div",{children:[B,C,_]})}else{var S=s.create("div",{children:[B,C]})}E.push(S)}u=s.create("span",{props:{className:"bx-messenger-attach-links"},children:E})}else if(I.RICH_LINK&&I.RICH_LINK.length>0){var E=[];for(var f=0;f<I.RICH_LINK.length;f++){var T=document.createElement("p");if(I.RICH_LINK[f].NAME){T.innerHTML=I.RICH_LINK[f].NAME;I.RICH_LINK[f].NAME=T.innerText}if(I.RICH_LINK[f].DESC){T.innerHTML=I.RICH_LINK[f].DESC;I.RICH_LINK[f].DESC=T.innerText}var v=null;var B=s.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},text:I.RICH_LINK[f].NAME?I.RICH_LINK[f].NAME:I.RICH_LINK[f].LINK});if(I.RICH_LINK[f].NETWORK_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "},attrs:{"data-entity":"network","data-networkId":I.RICH_LINK[f].NETWORK_ID},children:[B]})}else if(I.RICH_LINK[f].USER_ID){B=s.create("span",{props:{className:"bx-messenger-ajax "+(I.RICH_LINK[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")},attrs:{"data-entity":"user","data-userId":I.RICH_LINK[f].USER_ID},children:[B]})}else if(I.RICH_LINK[f].CHAT_ID){B=s.create("span",{props:{className:"bx-messenger-ajax"},attrs:{"data-entity":"chat","data-chatId":I.RICH_LINK[f].CHAT_ID},children:[B]})}else{if(I.RICH_LINK[f].HTML){B=s.create("span",{props:{className:"bx-messenger-attach-rich-link-name"},children:[s.create("a",{attrs:{href:this.formatUrl(I.RICH_LINK[f].LINK),target:"_blank"},text:I.RICH_LINK[f].NAME?I.RICH_LINK[f].NAME:I.RICH_LINK[f].LINK})]})}v=s.create("div",{props:{className:"bx-messenger-attach-rich-link-source"},html:s.create("a",{attrs:{href:this.formatUrl(I.RICH_LINK[f].LINK)}}).hostname})}var C=null;if(I.RICH_LINK[f].DESC){C=s.create("span",{props:{className:"bx-messenger-attach-rich-link-desc"},text:I.RICH_LINK[f].DESC})}var _=null;if(I.RICH_LINK[f].HTML){_=s.create("div",{props:{className:"bx-messenger-attach-rich-link-html"},text:I.RICH_LINK[f].HTML});var S=s.create("span",{props:{className:"bx-messenger-attach-rich-link"+(I.RICH_LINK[f].PREVIEW?" bx-messenger-attach-rich-link-with-preview":"")},children:[B,C,_]})}else if(I.RICH_LINK[f].PREVIEW){_=s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[s.create("img",{attrs:{src:this.formatUrl(I.RICH_LINK[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this, true)"},props:{className:"bx-messenger-file-image-text"}})]});var S=s.create("a",{attrs:{href:this.formatUrl(I.RICH_LINK[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-image"},children:[_,s.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[B,C,v]})]})}else{var S=s.create("a",{attrs:{href:this.formatUrl(I.RICH_LINK[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-image bx-messenger-file-image-without-preview"},children:[s.create("span",{props:{className:"bx-messenger-attach-rich-link-panel"},children:[B,C,v]})]})}E.push(S)}u=s.create("span",{props:{className:"bx-messenger-attach-rich-links"},children:E})}else if(I.MESSAGE&&I.MESSAGE.length>0){u=s.create("span",{props:{className:"bx-messenger-attach-message"},html:s.MessengerCommon.prepareText(I.MESSAGE,true,true,true)})}else if(I.HTML&&I.HTML.length>0){u=s.create("span",{props:{className:"bx-messenger-attach-message"},html:s.MessengerCommon.prepareText(I.HTML,true,true,true)})}else if(I.GRID&&I.GRID.length>0){var y=[];for(var f=0;f<I.GRID.length;f++){var A=s.MessengerCommon.prepareText(I.GRID[f].VALUE,true,true,true);if(I.GRID[f].USER_ID){A='<span class="bx-messenger-ajax '+(I.GRID[f].USER_ID==this.BXIM.userId?"bx-messenger-ajax-self":"")+'" data-entity="user" data-userId="'+I.GRID[f].USER_ID+'">'+A+"</span>"}else if(I.GRID[f].CHAT_ID){A='<span class="bx-messenger-ajax" data-entity="chat" data-chatId="'+I.GRID[f].CHAT_ID+'">'+A+"</span>"}else if(I.GRID[f].LINK){A='<a href="'+this.formatUrl(I.GRID[f].LINK)+'" target="_blank">'+A+"</a>"}var L=I.GRID[f].WIDTH?"width: "+I.GRID[f].WIDTH+"px":"";var x=I.GRID[f].HEIGHT?"max-height: "+I.GRID[f].HEIGHT+"px;":"";var N=0;var R=null;var w=null;if(x){w=s.create("div",{props:{className:"bx-messenger-attach bx-messenger-attach-block-name"},attrs:{style:"position: absolute; left: -1000px;"+(I.GRID[f].DISPLAY=="ROW"?L:"")},html:A});document.body.appendChild(w);if(I.GRID[f].HEIGHT>=w.offsetHeight){x=""}else{N=w.offsetHeight}s.remove(w)}if(x){R=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+I.GRID[f].DISPLAY.toLowerCase()+" bx-messenger-attach-block-spoiler"},attrs:{style:I.GRID[f].DISPLAY=="LINE"||I.GRID[f].DISPLAY=="CARD"?L:""},children:[s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:I.GRID[f].DISPLAY=="ROW"?L:""},children:[s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-name"},text:I.GRID[f].NAME}),s.create("span",{props:{className:"bx-messenger-attach-block-spoiler-icon"}})]}),s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:x+(I.GRID[f].COLOR?"color: "+I.GRID[f].COLOR:""),"data-min-height":I.GRID[f].HEIGHT,"data-max-height":N},children:[s.create("span",{html:A})]})]})}else{var D=I.GRID[f].DISPLAY;if((D=="row"||D=="column")&&(!I.GRID[f].NAME||!I.GRID[f].VALUE)){D="BLOCK"}R=s.create("span",{props:{className:"bx-messenger-attach-block bx-messenger-attach-block-"+D.toLowerCase()},attrs:{style:D=="LINE"||D=="CARD"?L:""},children:[!I.GRID[f].NAME?null:s.create("div",{props:{className:"bx-messenger-attach-block-name"},attrs:{style:D=="ROW"?L:""},text:I.GRID[f].NAME}),!I.GRID[f].VALUE?null:s.create("div",{props:{className:"bx-messenger-attach-block-value"},attrs:{style:I.GRID[f].COLOR?"color: "+I.GRID[f].COLOR:""},html:A})]})}y.push(R)}u=s.create("span",{props:{className:"bx-messenger-attach-blocks"},children:y})}else if(I.DELIMITER){var O="";if(I.DELIMITER.SIZE){O+="width: "+I.DELIMITER.SIZE+"px;"}if(I.DELIMITER.COLOR){O+="background-color: "+I.DELIMITER.COLOR}if(O){O={style:O}}u=s.create("span",{props:{className:"bx-messenger-attach-delimiter"},attrs:O})}else if(I.IMAGE&&I.IMAGE.length>0){var k=[];for(var f=0;f<I.IMAGE.length;f++){if(!I.IMAGE[f].NAME){I.IMAGE[f].NAME=""}if(!I.IMAGE[f].PREVIEW){I.IMAGE[f].PREVIEW=I.IMAGE[f].LINK}var P=s.create("a",{props:{className:"bx-messenger-file-image-src"},attrs:{href:I.IMAGE[f].LINK,target:"_blank",title:I.IMAGE[f].NAME},children:[s.create("img",{attrs:{src:s.util.htmlspecialcharsback(I.IMAGE[f].PREVIEW),onerror:"BX.MessengerCommon.hideErrorImage(this)"},props:{className:"bx-messenger-attach-image bx-messenger-file-image-link"}})]});k.push(P)}u=s.create("span",{props:{className:"bx-messenger-attach-images"},children:k})}else if(I.FILE&&I.FILE.length>0){var U=[];for(var f=0;f<I.FILE.length;f++){var H=I.FILE[f].NAME?I.FILE[f].NAME:I.FILE[f].LINK;if(this.isMobile()){if(H.length>20){H=H.substr(0,7)+"..."+H.substr(H.length-10,H.length)}}else{if(H.length>43){H=H.substr(0,20)+"..."+H.substr(H.length-20,H.length)}}H=s.create("span",{attrs:{title:I.FILE[f].NAME},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},text:H})]});var G=s.create("div",{props:{className:"bx-messenger-file"},children:[s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[s.create("a",{props:{className:"bx-messenger-file-title-href"},attrs:{href:s.util.htmlspecialcharsback(I.FILE[f].LINK),target:"_blank"},children:[H]}),I.FILE[f].SIZE?s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(I.FILE[f].SIZE)}):null]}),s.create("div",{props:{className:"bx-messenger-file-download"},children:[s.create("a",{attrs:{href:s.util.htmlspecialcharsback(I.FILE[f].LINK),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")})]})]});U.push(G)}u=s.create("span",{props:{className:"bx-messenger-attach-files"},children:U})}p.push(u)}if(p.length>0){o.push(s.create("div",{props:{className:"bx-messenger-attach"},attrs:{style:h=="transparent"?"border: 0; padding-left: 0;":"border-color: "+h},children:p}))}}return o};t.prototype.diskGetMessageId=function(e,s){for(var t in this.BXIM.messenger.message){if(!this.BXIM.messenger.message.hasOwnProperty(t)){continue}var r=this.BXIM.messenger.message[t];if(r.params["FILE_ID"]&&r.params["FILE_ID"].length>0){var i=r.params["FILE_ID"].find((function(e){return e==s}));if(i){return r.id}}}return 0};t.prototype.diskDrawFiles=function(e,t,r){if(!this.BXIM.disk.enable||!e||!t)return[];var i=[];if(typeof t!="object"){i.push(t)}else{i=t}r=r||{};var a=true;var n=[];for(var o=0;o<i.length;o++){var l=this.BXIM.disk.files[e]&&this.BXIM.disk.files[e][i[o]];if(!l){var l={id:i[o],chatId:e};var m=r.boxId?r.boxId:"im-file";n.push(s.create("div",{attrs:{id:m+"-"+l.id,"data-chatId":l.chatId,"data-fileId":l.id,"data-boxId":m},props:{className:"bx-messenger-file"},children:[s.create("span",{props:{className:"bx-messenger-file-deleted"},html:s.message("IM_F_DELETED")})]}));continue}if(this.isDesktop()){if(!this.BXIM.desktop.enableInVersion(43)){if(l.type=="audio"){l.viewerAttrs=null}}if(!this.BXIM.desktop.enableInVersion(47)){if(l.type=="video"){l.viewerAttrs=null}}}if(r.status){if(typeof r.status!="object"){r.status=[r.status]}if(!s.util.in_array(l.status,r.status)){continue}}var h=null;var g=false;if(l.preview||l.urlPreview){var p=null;if(l.preview&&typeof l.preview!="string"){p=l.preview;if(l.urlPreview){l.preview=""}}else{p=s.create("img",{attrs:{src:this.formatUrl(l.urlPreview?l.urlPreview:l.preview),height:l.image?l.image.height>400?"400":l.image.height:"auto"},props:{className:"bx-messenger-file-image-text bx-messenger-file-image-type-"+l.type},events:{load:function(){this.parentNode.style.background="#fff";this.removeAttribute("height")}}})}if(a){var c=null;if(l.type=="video"){if(this.isMobile()){c=s.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[s.create("div",{events:{click:s.delegate((function(e){s.localStorage.set("impmh",true,1);app.openDocument({url:this.formatUrl(l.urlDownload),filename:l.name.toString().toLowerCase()});return s.PreventDefault(e)}),this)},props:{className:"bx-messenger-file-image-type-video-button-play"}})]})}else{c=s.create("div",{props:{className:"bx-messenger-file-image-type-video-button"},children:[s.create("div",{props:{className:"bx-messenger-file-image-type-video-button-play"}})]})}}if(l.type=="video"&&l.urlDownload||l.type!="video"&&l.urlPreview&&l.urlShow){if(this.isMobile()){h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{events:{click:s.delegate((function(){var e=this.BXIM.disk.files[s.proxy_context.dataset.chatid][s.proxy_context.dataset.diskid];var t=s.findParent(s.proxy_context,{className:"bx-messenger-content-item"});if(t&&t.getAttribute("data-messageid").indexOf("temp")==0){return false}if(e.type=="image"){this.BXIM.messenger.openPhotoGallery(e.urlShow);s.localStorage.set("impmh",true,1)}else{s.localStorage.set("impmh",true,1);app.openDocument({url:e.urlShow,filename:e.name.toString().toLowerCase()})}}),this)},attrs:{"data-chatId":l.chatId,"data-diskId":l.id},props:{className:"bx-messenger-file-image-src"},children:[c,p]})]})]})}else{h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("a",{dataset:l.viewerAttrs,attrs:{href:this.formatUrl(l.urlShow),target:"_blank"},props:{className:"bx-messenger-file-image-src"},children:[c,p]})]})]});g=true}}else{h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[p]})]})]})}}else{h=s.create("div",{props:{className:"bx-messenger-file-preview"},children:[s.create("span",{props:{className:"bx-messenger-file-image"},children:[s.create("span",{props:{className:"bx-messenger-file-image-src"},children:[p]})]})]})}}var d=l.name;if(this.isMobile()){if(d.length>20){d=d.substr(0,7)+"..."+d.substr(d.length-10,d.length)}}else{if(d.length>43){d=d.substr(0,20)+"..."+d.substr(d.length-20,d.length)}}if(l.type==="audio"&&(l.viewerAttrs||this.isMobile())){I=s.create("div",{props:{className:"bx-messenger-audioplayer-container bx-messenger-audioplayer-container-dark"},children:[s.create("div",{props:{className:"bx-messenger-audioplayer-controls-container"},children:[s.create("div",{props:{className:"bx-messenger-audioplayer-control bx-messenger-audioplayer-control-play"}})]}),s.create("div",{props:{className:"bx-messenger-audioplayer-timeline-container"},children:[s.create("div",{props:{className:"bx-messenger-audioplayer-track-mask"}}),s.create("div",{props:{className:"bx-messenger-audioplayer-track"}})]})],events:!this.isMobile()?null:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:l.urlDownload,filename:l.name.toString().toLowerCase()})}},dataset:l.viewerAttrs})}else{var I=s.create("span",{attrs:{title:l.name},props:{className:"bx-messenger-file-title"},children:[s.create("span",{props:{className:"bx-messenger-file-title-name"},html:d})]});if(a&&(l.urlShow||l.urlDownload)){if(this.isMobile()){I=s.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){s.localStorage.set("impmh",true,1);app.openDocument({url:this.urlDownload,filename:this.name.toString().toLowerCase()})}.bind(l)},children:[I]})}else if(!l.viewerAttrs&&s.desktopUtils.canDownload()){I=s.create("span",{props:{className:"bx-messenger-file-title-href"},events:{click:function(){s.desktopUtils.downloadFile(this.urlDownload,this.name)}.bind(l)},children:[I]})}else{I=s.create("a",{dataset:g?null:l.viewerAttrs,props:{className:"bx-messenger-file-title-href"},attrs:{href:this.formatUrl(l.urlShow?l.urlShow:l.urlDownload),target:"_blank"},children:[I]})}}I=s.create("div",{props:{className:"bx-messenger-file-attrs"},children:[I,l.size?s.create("span",{props:{className:"bx-messenger-file-size"},html:s.UploaderUtils.getFormattedSize(l.size)}):null]})}var u=null;if(l.status=="done"){if(!this.isMobile()){var M=null;if(l.urlDownload&&a){if(s.desktopUtils.canDownload()){M=s.create("span",{events:{click:function(){s.desktopUtils.downloadFile(this.urlDownload,this.name)}.bind(l)},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")})}else{M=s.create("a",{attrs:{href:this.formatUrl(l.urlDownload),target:"_blank"},props:{className:"bx-messenger-file-download-link bx-messenger-file-download-pc"},html:s.message("IM_F_DOWNLOAD")})}}u=s.create("div",{props:{className:"bx-messenger-file-download"},children:[M,!l.urlDownload||!this.BXIM.disk.enable||this.BXIM.context=="LINES"?null:s.create("span",{props:{className:"bx-messenger-file-download-link bx-messenger-file-download-disk"},html:s.message("IM_F_DOWNLOAD_DISK"),events:{click:s.delegate((function(){var e=s.proxy_context.parentNode.parentNode.getAttribute("data-chatId");var t=s.proxy_context.parentNode.parentNode.getAttribute("data-fileId");var r=s.proxy_context.parentNode.parentNode.getAttribute("data-boxId");this.BXIM.disk.saveToDisk(e,t,{boxId:r})}),this)}})]})}else{u=s.create("div",{props:{className:"bx-messenger-file-download"},children:[]})}}else if(l.status=="upload"){var f={};var B="";var X=null;var b="";var E="";if(l.authorId==this.BXIM.userId&&l.progress>=0){E=s.message("IM_F_UPLOAD_2").replace("#PERCENT#",l.progress);f={width:l.progress+"%"};X=s.create("span",{attrs:{title:s.message("IM_F_CANCEL")},props:{className:"bx-messenger-file-delete"}})}else{E=s.message("IM_F_UPLOAD");b=" bx-messenger-file-progress-infinite"}u=s.create("div",{props:{className:"bx-messenger-progress-box"},children:[s.create("span",{attrs:{title:E},props:{className:"bx-messenger-file-progress"},children:[s.create("span",{props:{className:"bx-messenger-file-progress-line"+b},style:f})]}),X]})}else if(l.status=="error"){u=s.create("span",{props:{className:"bx-messenger-file-status-error"},html:l.errorText?l.errorText:s.message("IM_F_ERROR")})}if(!u)return false;if(i.length==1&&r.showInner=="Y"){n=[h,I,u]}else{var m=r.boxId?r.boxId:"im-file";n.push(s.create("div",{attrs:{id:m+"-"+l.id,"data-chatId":l.chatId,"data-fileId":l.id,"data-boxId":m},props:{className:"bx-messenger-file"},children:[h,I,u]}))}}return n};t.prototype.diskRedrawFile=function(e,t,r){r=r||{};var i=r.boxId?r.boxId:"im-file";var a=s(i+"-"+t);if(a){var n=this.diskDrawFiles(e,t,{showInner:"Y",boxId:i});if(n){if(this.BXIM.disk.files[e]&&this.BXIM.disk.files[e][t]&&this.BXIM.disk.files[e][t].id!=t){var o=this.BXIM.disk.files[e][t].id;this.BXIM.disk.files[e][o]=this.BXIM.disk.files[e][t];a.setAttribute("data-fileid",o);a.setAttribute("id","im-file-"+o)}a.innerHTML="";s.adjust(a,{children:n})}}};t.prototype.diskChatDialogFileInited=function(t,r,i){i.messageText=i.messageText||"";var a=i.form.CHAT_ID.value;if(!this.BXIM.disk.files[a])this.BXIM.disk.files[a]={};this.BXIM.disk.files[a][t]={id:t,templateId:t,chatId:a,date:new Date,type:r.isImage?"image":"file",preview:r.isImage?r.canvas:"",name:s.util.htmlspecialchars(r.name),size:r.file.size,status:"upload",progress:-1,authorId:this.BXIM.userId,authorName:this.BXIM.messenger.users[this.BXIM.userId].name,urlPreview:"",urlShow:"",urlDownload:""};var n=0;if(this.BXIM.messenger.chat[a]&&this.BXIM.messenger.chat[a].type!="private"){n="chat"+a}else{for(var o in this.BXIM.messenger.userChat){if(this.BXIM.messenger.userChat[o]==a){n=o;break}}}if(!n)return false;var l="N";if(n.toString().substr(0,4)=="chat"&&this.BXIM.messenger.linesSilentMode&&this.BXIM.messenger.linesSilentMode[a]){l="Y"}var m=[this.BXIM.disk.files[a][t].id];var h="file";var g="tempFile"+this.BXIM.disk.fileTmpId+(new Date).getTime();this.BXIM.messenger.message[g]={id:g,chatId:a,senderId:this.BXIM.userId,recipientId:n,date:new Date,text:s.MessengerCommon.prepareText(i.messageText,true,true,true),textOriginal:i.messageText,params:{FILE_ID:m,CLASS:l=="Y"?"bx-messenger-content-item-system":""}};if(!this.BXIM.messenger.showMessage[n])this.BXIM.messenger.showMessage[n]=[];this.BXIM.messenger.showMessage[n]=this.BXIM.messenger.showMessage[n].filter((function(e){return e!=g}));this.BXIM.messenger.showMessage[n].push(g.toString());s.MessengerCommon.drawMessage(n,this.BXIM.messenger.message[g]);s.MessengerCommon.drawProgessMessage(g);this.recentListAddItem({id:n,message:{id:g,date:new Date,author_id:this.BXIM.userId,status:"delivered",text:i.messageText?i.messageText:"",attach:false,file:true}});this.recentListRedraw();this.BXIM.messenger.popupMessengerFileFormRegChatId.value=a;r.regTmpMessageId=this.BXIM.messenger.popupMessengerFileFormRegMessageId.value=g;r.regHiddenMessageId=this.BXIM.messenger.popupMessengerFileFormRegMessageHidden.value=l;r.regParams=this.BXIM.messenger.popupMessengerFileFormRegParams.value=JSON.stringify({FILE_TMP_ID:this.BXIM.disk.files[a][t].id,TEXT:i.messageText});this.BXIM.disk.OldBeforeUnload=e.onbeforeunload;e.onbeforeunload=function(){return s.message("IM_F_EFP")};this.BXIM.disk.fileTmpId++;i.messageText=""};t.prototype.diskChatDialogFileStart=function(e,t,r,i){var a=r.streams.packages.getItem(i).data;var n=a.CHAT_ID;var o=this.BXIM.disk.files[n][e.id].id;if(!this.BXIM.disk.files[a.CHAT_ID][o])return false;this.BXIM.disk.files[n][o].progress=parseInt(t);s.MessengerCommon.diskRedrawFile(n,o)};t.prototype.diskChatDialogFileProgress=function(e,t,r,i){var a=r.streams.packages.getItem(i).data;var n=a.CHAT_ID;var o=this.BXIM.disk.files[n][e.id].id;if(!this.BXIM.disk.files[a.CHAT_ID][o])return false;this.BXIM.disk.files[n][o].progress=Math.max(parseInt(t),this.BXIM.disk.files[n][o].progress||0);s.MessengerCommon.diskRedrawFile(n,o)};t.prototype.diskChatDialogFileDone=function(s,t,r,i){e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};t.prototype.diskChatDialogFileError=function(t,r,i,a){var n=i.streams.packages.getItem(a).data;this.clearProgessMessage(n.REG_MESSAGE_ID);var o=n.CHAT_ID;var l=this.BXIM.disk.files[o][t.id].id;if(!this.BXIM.disk.files[n.CHAT_ID][l])return false;t.deleteFile();this.BXIM.disk.files[n.CHAT_ID][l].status="error";this.BXIM.disk.files[n.CHAT_ID][l].errorText=r.error;s.MessengerCommon.diskRedrawFile(n.CHAT_ID,l);e.onbeforeunload=this.BXIM.disk.OldBeforeUnload};t.prototype.diskChatDialogUploadError=function(t,r,i){var a=t.post.REG_PARAMS?JSON.parse(t.post.REG_PARAMS):{};var n={};for(var o in a){if(this.BXIM.disk.filesMessage[o]){delete this.BXIM.disk.filesMessage[o]}if(this.BXIM.disk.files[t.post.REG_CHAT_ID]){if(this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]]){this.BXIM.disk.files[t.post.REG_CHAT_ID][a[o]].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,a[o])}if(this.BXIM.disk.files[t.post.REG_CHAT_ID][o]){this.BXIM.disk.files[t.post.REG_CHAT_ID][o].status="error";s.MessengerCommon.diskRedrawFile(t.post.REG_CHAT_ID,o)}}delete this.BXIM.disk.filesProgress[o]}e.onbeforeunload=this.BXIM.disk.OldBeforeUnload;s.MessengerCommon.drawTab(this.getRecipientByChatId(t.post.REG_CHAT_ID))};t.prototype.phoneCheckDesktop=function(e){e=e===true;var t=new s.Promise;if(e&&this.isMobile()){t.resolve();return t}s.desktopUtils.runningCheck((function(){t.reject()}),(function(){t.resolve()}));return t};t.prototype.pullPhoneEvent=function(){if(this.BXIM.options.frameMode){return false}var e=s.delegate((function(e,t){if(this.isMobile()){t=e.params;e=e.command;console.info("pull info: ",e,t)}if(e=="invite"){if(!this.BXIM.webrtc.phoneSupport())return false;if(this.BXIM.callController&&this.BXIM.callController.hasActiveCall()){return false}if(this.BXIM.webrtc.isCallListMode()){s.MessengerCommon.phoneCommand("busy",{CALL_ID:t.callId});return false}if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop(true).then(function(){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;if(this.BXIM.webrtc.phonePortalCall&&t.portalCallData){for(var e in t.portalCallData.users){t.portalCallData.users[e].last_activity_date=t.portalCallData.users[e].last_activity_date?new Date(t.portalCallData.users[e].last_activity_date):false;t.portalCallData.users[e].mobile_last_date=t.portalCallData.users[e].mobile_last_date?new Date(t.portalCallData.users[e].mobile_last_date):false;t.portalCallData.users[e].idle=t.portalCallData.users[e].idle?new Date(t.portalCallData.users[e].idle):false;t.portalCallData.users[e].absent=t.portalCallData.users[e].absent?new Date(t.portalCallData.users[e].absent):false;this.BXIM.messenger.users[e]=t.portalCallData.users[e]}for(var e in t.portalCallData.hrphoto)this.BXIM.messenger.hrphoto[e]=t.portalCallData.hrphoto[e];t.callerId=this.BXIM.messenger.users[t.portalCallUserId].name;t.phoneNumber=""}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallTime=0;this.BXIM.repeatSound("ringtone",5e3);if(this.isPage()){s.MessengerWindow.changeTab("im")}s.MessengerCommon.phoneCommand("wait",{CALL_ID:t.callId,DEBUG_INFO:this.getDebugInfo()});if(t.isTransfer){this.BXIM.webrtc.phoneTransferEnabled=true}this.BXIM.webrtc.phoneIncomingWait({chatId:t.chatId,callId:t.callId,callerId:t.callerId,lineNumber:t.lineNumber,companyPhoneNumber:t.phoneNumber,isCallback:t.isCallback,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,config:t.config})}.bind(this))}else if(e=="answer_self"){if(this.BXIM.webrtc.callSelfDisabled||this.BXIM.webrtc.phoneCallId!=t.callId)return false;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();this.BXIM.webrtc.phoneCallView.close();this.BXIM.webrtc.callInit=true;this.BXIM.webrtc.phoneCallId=t.callId}else if(e=="timeout"){if(this.BXIM.webrtc.phoneTransferCallId===t.callId){return this.BXIM.webrtc.errorInviteTransfer(t.failedCode,t.failedReason)}else if(this.BXIM.webrtc.phoneCallId!=t.callId){return false}clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");var r=this.BXIM.webrtc.phoneCallExternal;this.BXIM.stopRepeatSound("ringtone");this.BXIM.stopRepeatSound("dialtone");this.BXIM.webrtc.callInit=false;var i=this.BXIM.webrtc.phoneNumber;this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort();if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle,{failedCode:t.failedCode})}if(r&&t.failedCode==486){if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("offline");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_BUSY_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else if(r&&t.failedCode==480){if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setProgress("error");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_ERROR_NA_PHONE"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.sipPhoneError)}}else{if(this.BXIM.webrtc.phoneCallView){if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setStatusText("");this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}}else if(e=="outgoing"){if(this.BXIM.webrtc.callInit&&(this.BXIM.webrtc.phoneNumber==t.phoneNumber||t.phoneNumber.indexOf(this.BXIM.webrtc.phoneNumber)>=0)){this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=!!t.portalCall;this.BXIM.webrtc.phoneNumber=t.phoneNumber;if(this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setProgress("connect");this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_WAIT_ANSWER"))}this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCrm=t.CRM;if(this.BXIM.webrtc.phoneCallView&&t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl,bindings:t.crmBindings});this.BXIM.webrtc.phoneCallView.setConfig(t.config);this.BXIM.webrtc.phoneCallView.setCallId(t.callId);if(t.lineNumber)this.BXIM.webrtc.phoneCallView.setLineNumber(t.lineNumber);if(t.lineName)this.BXIM.webrtc.phoneCallView.setCompanyPhoneNumber(t.lineName);this.BXIM.webrtc.phoneCallView.reloadCrmCard()}if(this.BXIM.webrtc.phoneCallView&&this.BXIM.webrtc.phonePortalCall){this.BXIM.webrtc.phoneCallView.setPortalCall(true);this.BXIM.webrtc.phoneCallView.setPortalCallData(t.portalCallData);this.BXIM.webrtc.phoneCallView.setPortalCallUserId(t.portalCallUserId);this.BXIM.webrtc.phoneCallView.setPortalCallQueueName(t.portalCallQueueName)}}else if(!this.BXIM.webrtc.callInit&&!this.BXIM.webrtc.callActive&&t.callDevice=="PHONE"){this.phoneCheckDesktop(true).then(function(){this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";this.BXIM.webrtc.phonePortalCall=t.portalCall?true:false;this.BXIM.webrtc.phoneCallId=t.callId;this.BXIM.webrtc.phoneCallTime=0;this.BXIM.webrtc.phoneCallConfig=t.config?t.config:{};this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.phoneDisplayExternal({callId:t.callId,config:t.config?t.config:{},phoneNumber:t.phoneNumber,portalCall:t.portalCall,portalCallUserId:t.portalCallUserId,portalCallData:t.portalCallData,portalCallQueueName:t.portalCallQueueName,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId})}.bind(this))}}else if(e=="start"){if(this.BXIM.webrtc.phoneTransferCallId===t.callId){this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_M_CALL_ST_TRANSFER_CONNECTED"));return}else if(this.BXIM.webrtc.phoneCallId!=t.callId){return}this.BXIM.webrtc.callOverlayTimer("start");this.BXIM.stopRepeatSound("ringtone");if(this.BXIM.webrtc.phoneCallId==t.callId&&this.BXIM.webrtc.phoneCallDevice=="PHONE"&&(this.BXIM.webrtc.phoneCallDevice==t.callDevice||this.BXIM.webrtc.phonePortalCall)){this.BXIM.webrtc.phoneOnCallConnected()}else if(this.BXIM.webrtc.phoneCallId==t.callId&&t.callDevice=="PHONE"&&this.BXIM.webrtc.phoneIncoming){this.BXIM.webrtc.phoneCallDevice="PHONE";if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setDeviceCall(true)}this.BXIM.webrtc.phoneOnCallConnected()}if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.callOverlayDrawCrm()}if(this.BXIM.webrtc.phoneNumber!=""){this.BXIM.webrtc.phoneNumberLast=this.BXIM.webrtc.phoneNumber;this.BXIM.setLocalConfig("phone_last",this.BXIM.webrtc.phoneNumber)}}else if(e=="hold"||e=="unhold"){if(this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.phoneHolded=e=="hold"}}else if(e=="update_crm"){if(this.BXIM.webrtc.phoneCallId==t.callId&&t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM;if(this.isMobile()){this.BXIM.webrtc.callOverlayDrawCrm();if(this.BXIM.webrtc.callNotify)this.BXIM.webrtc.callNotify.adjustPosition()}else if(this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl,bindings:t.crmBindings});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}}else if(e==="updatePortalUser"){if(this.BXIM.webrtc.phoneCallId==t.callId&&this.BXIM.webrtc.phoneCallView){this.BXIM.webrtc.phoneCallView.setPortalCall(true);this.BXIM.webrtc.phoneCallView.setPortalCallData(t.portalCallData);this.BXIM.webrtc.phoneCallView.setPortalCallUserId(t.portalCallUserId)}}else if(e=="completeTransfer"){if(this.BXIM.webrtc.phoneCallId!=t.callId){return false}this.BXIM.webrtc.phoneCallId=t.newCallId;this.phoneTransferTargetId=0;this.phoneTransferTargetType="";this.phoneTransferCallId="";this.phoneTransferEnabled=false;s.localStorage.set("vite",false,1);this.BXIM.webrtc.phoneCallDevice=t.callDevice=="PHONE"?"PHONE":"WEBRTC";if(this.BXIM.webrtc.phoneCallDevice=="PHONE"){this.BXIM.webrtc.phoneCallView.setDeviceCall(true)}this.BXIM.webrtc.phoneCallView.setTransfer(false);this.BXIM.webrtc.phoneOnCallConnected()}else if(e=="phoneDeviceActive"){this.BXIM.webrtc.phoneDeviceActive=t.active=="Y"}else if(e=="changeDefaultLineId"){this.BXIM.webrtc.phoneDefaultLineId=t.defaultLineId}else if(e=="replaceCallerId"){var a=s.message("IM_PHONE_CALL_TRANSFER").replace("#PHONE#",t.callerId);this.BXIM.webrtc.setCallOverlayTitle(a);this.BXIM.webrtc.phoneCallView.setPhoneNumber(t.callerId);if(t.CRM){this.BXIM.webrtc.phoneCrm=t.CRM;this.BXIM.webrtc.phoneCallView.setCrmData(t.CRM);if(t.showCrmCard){this.BXIM.webrtc.phoneCallView.setCrmEntity({type:t.crmEntityType,id:t.crmEntityId,activityId:t.crmActivityId,activityEditUrl:t.crmActivityEditUrl,bindings:t.crmBindings});this.BXIM.webrtc.phoneCallView.reloadCrmCard()}}}else if(e=="showExternalCall"){if(this.BXIM.callController&&this.BXIM.callController.hasActiveCall())return false;if(s.localStorage.get("viInitedCall")||s.localStorage.get("viExternalCard")){return false}this.phoneCheckDesktop().then(function(){if(t.CRM&&t.CRM.FOUND){this.BXIM.webrtc.phoneCrm=t.CRM}else{this.BXIM.webrtc.phoneCrm={}}this.BXIM.webrtc.showExternalCall({callId:t.callId,fromUserId:t.fromUserId,toUserId:t.toUserId,isCallback:t.isCallback,phoneNumber:t.phoneNumber,lineNumber:t.lineNumber,companyPhoneNumber:t.companyPhoneNumber,showCrmCard:t.showCrmCard,crmEntityType:t.crmEntityType,crmEntityId:t.crmEntityId,crmBindings:t.crmBindings,crmActivityId:t.crmActivityId,crmActivityEditUrl:t.crmActivityEditUrl,config:t.config,portalCall:t.portalCall,portalCallData:t.portalCallData,portalCallUserId:t.portalCallUserId})}.bind(this))}else if(e=="hideExternalCall"){if(this.isMobile())return false;if(this.BXIM.webrtc.callActive&&this.BXIM.webrtc.phoneCallExternal&&this.BXIM.webrtc.phoneCallId==t.callId){this.BXIM.webrtc.hideExternalCall()}}}),this);s.addCustomEvent("onPullEvent-voximplant",e)};t.prototype.phoneCommand=function(e,t,r,i){var a=!s.type.isFunction(i);var n;if(a){n=new s.Promise}if(!this.BXIM.webrtc.phoneSupport()){if(a){n.reject();return n}else{return false}}r=r!=false;t=typeof t=="object"?t:{};try{t=JSON.stringify(t)}catch(e){console.error("Could not convert params to JSON, error: ",e);return}s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_SHARED&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,async:r,data:{IM_PHONE:"Y",COMMAND:e,PARAMS:t,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:function(e){if(a){n.resolve(e)}else{i(e)}}});return a?n:true};t.prototype.phoneCorrect=function(e){return e.toString().replace(/[^0-9+#*;,]/g,"")};t.prototype.phoneOnIncomingCall=function(e){if(this.BXIM.webrtc.phoneCurrentCall)return false;var t={};if(this.isMobile()){t=s.MobileVoximplantCall.events}else{t=VoxImplant.CallEvents}this.BXIM.webrtc.phoneCurrentCall=e.call;this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(t.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.answer()};t.prototype.phoneGetCallParams=function(){var e=s.type.isPlainObject(this.BXIM.webrtc.phoneParams)?s.clone(this.BXIM.webrtc.phoneParams):{};if(this.BXIM.webrtc.phoneFullNumber!=this.BXIM.webrtc.phoneNumber){e["FULL_NUMBER"]=this.BXIM.webrtc.phoneFullNumber}return JSON.stringify(e)};t.prototype.phoneCallStart=function(){this.BXIM.webrtc.phoneParams["CALLER_ID"]="";this.BXIM.webrtc.phoneParams["USER_ID"]=this.BXIM.userId;this.BXIM.webrtc.phoneLog("Call params: ",this.BXIM.webrtc.phoneNumber,this.BXIM.webrtc.phoneParams);if(!this.BXIM.webrtc.phoneAPI.connected()){this.BXIM.webrtc.phoneOnSDKReady();return false}if(!this.isMobile()&&false){this.BXIM.webrtc.phoneCurrentCall=true;this.BXIM.webrtc.callActive=true;this.BXIM.webrtc.phoneOnCallConnected();this.BXIM.webrtc.phoneCrm.FOUND="N";this.BXIM.webrtc.phoneCrm.CONTACT_URL="#";this.BXIM.webrtc.phoneCrm.LEAD_URL="#";this.BXIM.webrtc.callOverlayDrawCrm()}else{var e={};if(this.isMobile()){e=s.MobileVoximplantCall.events}else{e=VoxImplant.CallEvents;this.BXIM.webrtc.phoneAPI.setOperatorACDStatus("ONLINE")}this.BXIM.webrtc.phoneCurrentCall=this.BXIM.webrtc.phoneAPI.call(this.BXIM.webrtc.phoneNumber,false,this.phoneGetCallParams());this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Connected,s.delegate(this.BXIM.webrtc.phoneOnCallConnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Disconnected,s.delegate(this.BXIM.webrtc.phoneOnCallDisconnected,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.Failed,s.delegate(this.BXIM.webrtc.phoneOnCallFailed,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStart,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStart,this.BXIM.webrtc));this.BXIM.webrtc.phoneCurrentCall.addEventListener(e.ProgressToneStop,s.delegate(this.BXIM.webrtc.phoneOnProgressToneStop,this.BXIM.webrtc));if(this.isMobile()){this.BXIM.webrtc.phoneCurrentCall.start()}}s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_INIT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"init",NUMBER:this.BXIM.webrtc.phoneNumber,NUMBER_USER:s.util.htmlspecialcharsback(this.BXIM.webrtc.phoneNumberUser),IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){if(e.ERROR==""){if(!(e.HR_PHOTO.length==0)){for(var s in e.HR_PHOTO)this.BXIM.messenger.hrphoto[s]=e.HR_PHOTO[s];this.BXIM.webrtc.callOverlayUserId=e.DIALOG_ID}else{this.BXIM.webrtc.callOverlayChatId=e.DIALOG_ID.substr(4)}}}),this)})};t.prototype.phoneCallFinish=function(){clearInterval(this.BXIM.webrtc.phoneConnectedInterval);s.localStorage.remove("viInitedCall");clearInterval(this.BXIM.webrtc.phoneCallTimeInterval);this.BXIM.webrtc.callOverlayTimer("pause");if(!this.isMobile()){this.BXIM.desktop.closeTopmostWindow()}if(this.BXIM.webrtc.phoneCurrentCall){try{this.BXIM.webrtc.phoneCurrentCall.hangup({"X-Disconnect-Code":200,"X-Disconnect-Reason":"Normal hangup"})}catch(e){}this.BXIM.webrtc.phoneCurrentCall=null;this.BXIM.webrtc.phoneLog("Call hangup call")}else if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate((function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()}),this),500)}if(this.isMobile()){}else{if(this.BXIM.webrtc.popupKeyPad)this.BXIM.webrtc.popupKeyPad.close();if(this.BXIM.webrtc.popupTransferDialog)this.BXIM.webrtc.popupTransferDialog.close();s.localStorage.set("vite",false,1)}this.BXIM.webrtc.phoneRinging=0;this.BXIM.webrtc.phoneIncoming=false;this.BXIM.webrtc.phoneCallId="";this.BXIM.webrtc.phoneCallExternal=false;this.BXIM.webrtc.phoneCallDevice="WEBRTC";this.BXIM.webrtc.phoneNumber="";this.BXIM.webrtc.phoneNumberUser="";this.BXIM.webrtc.phoneParams={};this.BXIM.webrtc.callOverlayOptions={};this.BXIM.webrtc.callSelfDisabled=false;this.BXIM.webrtc.phoneMicMuted=false;this.BXIM.webrtc.phoneHolded=false;this.BXIM.webrtc.phoneMicAccess=false;this.BXIM.webrtc.phoneTransferTargetType="";this.BXIM.webrtc.phoneTransferTargetId=0;this.BXIM.webrtc.phoneTransferCallId="";this.BXIM.webrtc.phoneTransferEnabled=false};t.prototype.phoneAuthorize=function(){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_AUTHORIZE&V="+this.BXIM.revision,method:"POST",dataType:"json",skipAuthCheck:true,timeout:30,data:{IM_PHONE:"Y",COMMAND:"authorize",UPDATE_INFO:this.BXIM.webrtc.phoneCheckBalance?"Y":"N",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){if(t&&t.BITRIX_SESSID){s.message({bitrix_sessid:t.BITRIX_SESSID})}if(t.ERROR==""){this.BXIM.messenger.sendAjaxTry=0;this.BXIM.webrtc.phoneCheckBalance=false;if(t.HR_PHOTO){for(var r in t.HR_PHOTO)this.BXIM.messenger.hrphoto[r]=t.HR_PHOTO[r]}if(this.isMobile()){this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER;this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);s.MobileVoximplant.loginWithOneTimeKey(t.LOGIN+"@"+t.SERVER,t.HASH)}else{this.BXIM.webrtc.phoneLogin=t.LOGIN;this.BXIM.webrtc.phoneServer=t.SERVER}this.BXIM.webrtc.phoneCallerID=t.CALLERID;this.BXIM.webrtc.phoneApiInit()}else if(t.ERROR=="AUTHORIZE_ERROR"&&(this.isDesktop()||this.isMobile())&&this.BXIM.messenger.sendAjaxTry<3){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate((function(){this.phoneAuthorize()}),this),5e3);s.onCustomEvent(e,"onImError",[t.ERROR])}else if(t.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout(s.delegate((function(){this.phoneAuthorize()}),this),2e3);s.onCustomEvent(e,"onImError",[t.ERROR,t.BITRIX_SESSID])}else{this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.phoneLog("onetimekey",t.ERROR,t.CODE);if(t.ERROR=="AUTHORIZE_ERROR"||t.ERROR=="SESSION_ERROR"){s.onCustomEvent(e,"onImError",[t.ERROR]);this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"))}else{this.BXIM.webrtc.callAbort(t.ERROR+(this.BXIM.webrtc.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+t.CODE+")":""))}if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}}),this),onfailure:s.delegate((function(){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))}),this)})};t.prototype.phoneOnAuthResult=function(e){if(e.result){if(this.BXIM.webrtc.phoneCallDevice=="PHONE")return false;this.BXIM.webrtc.phoneLog("Authorize result","success");if(this.BXIM.webrtc.phoneIncoming){s.MessengerCommon.phoneCommand("ready",{CALL_ID:this.BXIM.webrtc.phoneCallId})}else if(this.BXIM.webrtc.callInitUserId==this.BXIM.userId){s.MessengerCommon.phoneCallStart()}}else if(!this.isMobile()&&e.code==302){s.ajax({url:this.BXIM.pathToCallAjax+"?PHONE_ONETIMEKEY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:30,data:{IM_PHONE:"Y",COMMAND:"onetimekey",KEY:e.key,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){if(e.ERROR==""){this.BXIM.webrtc.phoneLog("auth with",this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer);this.BXIM.webrtc.phoneAPI.loginWithOneTimeKey(this.BXIM.webrtc.phoneLogin+"@"+this.BXIM.webrtc.phoneServer,e.HASH)}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("onetimekey",e.ERROR,e.CODE);if(e.CODE)this.BXIM.webrtc.callAbort(s.message("IM_PHONE_ERROR_CONNECT"));else this.BXIM.webrtc.callAbort(e.ERROR+(this.debug?"<br />("+s.message("IM_ERROR_CODE")+": "+e.CODE+")":""));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}}),this),onfailure:s.delegate((function(){this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"));this.BXIM.webrtc.phoneCallFinish()}),this)})}else{if(e.code==401||e.code==400||e.code==403||e.code==404||e.code==302){this.BXIM.webrtc.callAbort(s.message("IM_PHONE_401"));this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true;s.MessengerCommon.phoneCommand("authorize_error")}else{this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))}this.BXIM.webrtc.callOverlayProgress("offline");if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.phoneLog("Authorize result","failed",e.code);this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin=""}};t.prototype.phoneOnCallFailed=function(e){var t=e.headers||{};this.BXIM.webrtc.phoneLog("Call failed",e.code,e.reason);var r=s.message("IM_PHONE_END");if(e.code==603){r=s.message("IM_PHONE_DECLINE")}else if(e.code==380){r=s.message("IM_PHONE_ERR_SIP_LICENSE")}else if(e.code==436){r=s.message("IM_PHONE_ERR_NEED_RENT")}else if(e.code==438){r=s.message("IM_PHONE_ERR_BLOCK_RENT")}else if(e.code==400){r=s.message("IM_PHONE_ERR_LICENSE")}else if(e.code==401){r=s.message("IM_PHONE_401")}else if(e.code==480||e.code==503){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){r=s.message("IM_PHONE_NO_EMERGENCY")}else{r=s.message("IM_PHONE_UNAVAILABLE")}}else if(e.code==484||e.code==404){if(this.BXIM.webrtc.phoneNumber==911||this.BXIM.webrtc.phoneNumber==112){r=s.message("IM_PHONE_NO_EMERGENCY")}else{r=s.message("IM_PHONE_INCOMPLETED")}}else if(e.code==402){if(t.hasOwnProperty("X-Reason")&&t["X-Reason"]==="SIP_PAYMENT_REQUIRED"){r=s.message("IM_PHONE_ERR_SIP_LICENSE")}else{r=s.message("IM_PHONE_NO_MONEY")+(this.BXIM.isAdmin?" "+s.message("IM_PHONE_PAY_URL_NEW"):"")}}else if(e.code==486&&this.BXIM.webrtc.phoneRinging>1){r=s.message("IM_M_CALL_ST_DECLINE")}else if(e.code==486){r=s.message("IM_PHONE_ERROR_BUSY")}else if(e.code==403){r=s.message("IM_PHONE_403");this.BXIM.webrtc.phoneServer="";this.BXIM.webrtc.phoneLogin="";this.BXIM.webrtc.phoneCheckBalance=true}this.BXIM.webrtc.phoneCallFinish();if(e.code==408||e.code==403){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate((function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()}),this),500)}}this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(r);if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}};t.prototype.phoneOnCallDisconnected=function(e){this.BXIM.webrtc.phoneLog("Call disconnected",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.id():"-",this.BXIM.webrtc.phoneCurrentCall?this.BXIM.webrtc.phoneCurrentCall.state():"-");if(this.BXIM.webrtc.phoneCurrentCall){this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayDeleteEvents();this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_END"));if(this.isMobile()){this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callOverlayState(s.MobileCallUI.form.state.FINISHED)}else{this.BXIM.playSound("stop");this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle);if(this.BXIM.webrtc.isCallListMode()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.outgoing)}else{this.BXIM.webrtc.phoneCallView.setStatusText(s.message("IM_PHONE_END"));this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.idle);this.BXIM.webrtc.phoneCallView.autoClose()}}}if(this.BXIM.webrtc.phoneDisconnectAfterCallFlag&&this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected()){setTimeout(s.delegate((function(){if(this.BXIM.webrtc.phoneAPI&&this.BXIM.webrtc.phoneAPI.connected())this.BXIM.webrtc.phoneAPI.disconnect()}),this),500)}};t.prototype.phoneOnProgressToneStart=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone start",this.BXIM.webrtc.phoneCurrentCall.id());this.BXIM.webrtc.phoneRinging++;this.BXIM.webrtc.callOverlayStatus(s.message("IM_PHONE_WAIT_ANSWER"))};t.prototype.phoneOnProgressToneStop=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Progress tone stop",this.BXIM.webrtc.phoneCurrentCall.id())};t.prototype.phoneOnConnectionEstablished=function(e){this.BXIM.webrtc.phoneLog("Connection established",this.BXIM.webrtc.phoneAPI.connected())};t.prototype.phoneOnConnectionFailed=function(e){this.BXIM.webrtc.phoneLog("Connection failed");this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ERR"))};t.prototype.phoneOnConnectionClosed=function(e){this.BXIM.webrtc.phoneLog("Connection closed");this.BXIM.webrtc.phoneSDKinit=false};t.prototype.phoneOnMicResult=function(e){this.BXIM.webrtc.phoneMicAccess=e.result;this.BXIM.webrtc.phoneLog("Mic Access Allowed",e.result);if(!this.isMobile()){clearTimeout(this.BXIM.webrtc.callDialogAllowTimeout);if(this.BXIM.webrtc.callDialogAllow)this.BXIM.webrtc.callDialogAllow.close()}if(e.result){this.BXIM.webrtc.callOverlayProgress("connect");this.BXIM.webrtc.callOverlayStatus(s.message("IM_M_CALL_ST_CONNECT"))}else{this.BXIM.webrtc.phoneCallFinish();this.BXIM.webrtc.callOverlayProgress("offline");this.BXIM.webrtc.callAbort(s.message("IM_M_CALL_ST_NO_ACCESS"));if(!this.isMobile()){this.BXIM.webrtc.phoneCallView.setUiState(s.PhoneCallView.UiState.error);this.BXIM.webrtc.phoneCallView.setCallState(s.PhoneCallView.CallState.idle)}}};t.prototype.phoneOnNetStatsReceived=function(e){if(!this.BXIM.webrtc.phoneCurrentCall||this.BXIM.webrtc.phoneCurrentCall.state()!="CONNECTED")return false;var s=100-parseInt(e.stats.packetLoss);var t=this.BXIM.webrtc.callPhoneOverlayMeter(s);this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"meter",PACKETLOSS:e.stats.packetLoss,PERCENT:s,GRADE:t}))};t.prototype.phoneHold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=true;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};t.prototype.phoneUnhold=function(){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;this.BXIM.webrtc.phoneHolded=false;if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}};t.prototype.phoneToggleHold=function(e){if(!this.BXIM.webrtc.phoneCurrentCall&&this.BXIM.webrtc.phoneCallDevice=="WEBRTC")return false;if(typeof e!="undefined"){this.BXIM.webrtc.phoneHolded=!e}if(this.BXIM.webrtc.phoneHolded){if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"unhold"}))}else{s.MessengerCommon.phoneCommand("unhold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}else{if(this.BXIM.webrtc.phoneCallDevice=="WEBRTC"){this.BXIM.webrtc.phoneCurrentCall.sendMessage(JSON.stringify({COMMAND:"hold"}))}else{s.MessengerCommon.phoneCommand("hold",{CALL_ID:this.BXIM.webrtc.phoneCallId})}}this.BXIM.webrtc.phoneHolded=!this.BXIM.webrtc.phoneHolded};t.prototype.phoneSendDTMF=function(e){if(!this.BXIM.webrtc.phoneCurrentCall)return false;this.BXIM.webrtc.phoneLog("Send DTMF code",this.BXIM.webrtc.phoneCurrentCall.id(),e);this.BXIM.webrtc.phoneCurrentCall.sendTone(e)};t.prototype.phoneStartCallViaRestApp=function(e,t,r){s.rest.callMethod("voximplant.call.startViaRest",{NUMBER:e,LINE_ID:t,PARAMS:r,SHOW:"Y"})};t.prototype.phoneGetCallFields=function(e){if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="call")return{crm:false};var s=this.BXIM.messenger.chat[e];var t=s.entity_data_1.toString().split("|");if(!this.BXIM.bitrixCrm||t.length<3||t[0]!=="Y"||!this.BXIM.path.crm[t[1]]){return{crm:false}}else{return{crm:true,crmEntityType:t[1],crmEntityId:t[2],crmShowUrl:this.BXIM.path.crm[t[1]].replace("#ID#",t[2])}}};t.prototype.getUser=function(e){return this.BXIM.messenger.users[e]||false};t.prototype.getHrPhoto=function(e,s){var t="";if(s===undefined){s=this.BXIM.messenger.users[e].color||""}if(e=="phone"){t="/bitrix/js/im/images/hidef-phone-v3.png"}else if(this.BXIM.messenger.hrphoto[e]){t=this.BXIM.messenger.hrphoto[e];if(this.BXIM.messenger.hrphoto[e]!="/bitrix/js/im/images/hidef-avatar-v3.png"){s=""}}else if(!this.BXIM.messenger.users[e]||this.BXIM.messenger.users[e].avatar==this.BXIM.pathToBlankImage){t="/bitrix/js/im/images/hidef-avatar-v3.png"}else{t=this.BXIM.messenger.users[e].avatar;s=""}return{src:t,color:s}};t.prototype.linesBodyScroll=function(){if(this.isMobile()&&document.body.offsetHeight<=e.innerHeight){this.BXIM.messenger.popupMessengerBody.scrollTop=0;return false}if(this.BXIM.animationSupport){if(this.BXIM.messenger.popupMessengerBodyAnimation!=null)this.BXIM.messenger.popupMessengerBodyAnimation.stop();s.defer((function(){(this.BXIM.messenger.popupMessengerBodyAnimation=new s.easing({duration:600,start:{scroll:this.BXIM.messenger.popupMessengerBody.scrollTop},finish:{scroll:this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)},transition:s.easing.makeEaseInOut(s.easing.transitions.quart),step:s.delegate((function(e){this.BXIM.messenger.popupMessengerBody.scrollTop=e.scroll}),this)})).animate()}),this)()}else{s.defer((function(){this.BXIM.messenger.popupMessengerBody.scrollTop=this.BXIM.messenger.popupMessengerBody.scrollHeight-this.BXIM.messenger.popupMessengerBody.offsetHeight*(s.MessengerCommon.isMobile()?0:1)}),this)()}};t.prototype.linesGetSessionHistory=function(r){s.ajax({url:this.BXIM.pathToAjax+"?SESSION_GET_HISTORY&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"sessionGetHistory",SESSION_ID:r,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(r){if(r&&r.BITRIX_SESSID){s.message({bitrix_sessid:r.BITRIX_SESSID})}if(r.ERROR==""){for(var i in r.FILES){if(!this.BXIM.messenger.disk.files[r.CHAT_ID])this.BXIM.messenger.disk.files[r.CHAT_ID]={};if(this.BXIM.messenger.disk.files[r.CHAT_ID][i])continue;r.FILES[i].date=new Date(r.FILES[i].date);this.BXIM.messenger.disk.files[r.CHAT_ID][i]=r.FILES[i]}this.BXIM.messenger.sendAjaxTry=0;for(var i in r.MESSAGE){r.MESSAGE[i].date=new Date(r.MESSAGE[i].date);r.MESSAGE[i].textOriginal=r.MESSAGE[i].text;r.MESSAGE[i].text=s.MessengerCommon.prepareText(r.MESSAGE[i].text,false,true,true);this.BXIM.messenger.message[i]=r.MESSAGE[i]}for(var i in r.USERS){r.USERS[i].last_activity_date=r.USERS[i].last_activity_date?new Date(r.USERS[i].last_activity_date):false;r.USERS[i].mobile_last_date=r.USERS[i].mobile_last_date?new Date(r.USERS[i].mobile_last_date):false;r.USERS[i].idle=r.USERS[i].idle?new Date(r.USERS[i].idle):false;r.USERS[i].absent=r.USERS[i].absent?new Date(r.USERS[i].absent):false;this.BXIM.messenger.users[i]=r.USERS[i]}for(var i in r.CHAT){if(!this.BXIM.messenger.chat[i]){r.CHAT[i].date_create=new Date(r.CHAT[i].date_create);this.BXIM.messenger.chat[i]=r.CHAT[i]}}if(r.OPENLINES.canVoteAsHead){if(!this.BXIM.messenger.openlines.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead={}}for(var i in r.OPENLINES.canVoteAsHead){this.BXIM.messenger.openlines.canVoteAsHead[i]=r.OPENLINES.canVoteAsHead[i]}}this.BXIM.messenger.linesShowHistory(r.CHAT_ID,{HISTORY:r.USERS_MESSAGE,FILES:r.FILES,CAN_JOIN:r.CAN_JOIN,CAN_VOTE_HEAD:r.CAN_VOTE_HEAD,SESSION_VOTE_HEAD:r.SESSION_VOTE_HEAD,SESSION_COMMENT_HEAD:r.SESSION_COMMENT_HEAD,SESSION_ID:r.SESSION_ID})}else{if(r.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(r.ERROR)}else if(r.ERROR=="SESSION_ERROR"&&this.BXIM.messenger.sendAjaxTry<2){this.BXIM.messenger.sendAjaxTry++;setTimeout((function(){t.prototype.linesGetSessionHistory(sessionID)}),1e3);s.onCustomEvent(e,"onImError",[r.ERROR,r.BITRIX_SESSID])}else if(r.ERROR=="AUTHORIZE_ERROR"){this.BXIM.messenger.sendAjaxTry++;s.onCustomEvent(e,"onImError",[r.ERROR])}}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.sendAjaxTry=0}),this)})};t.prototype.linesJoinSession=function(e){s.ajax({url:this.BXIM.pathToAjax+"?JOIN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"joinSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.linesStartSession=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;s.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_CHAT&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.linesStartSessionByMessage=function(e){if(!this.BXIM.messenger.message[e]){return false}var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?START_SESSION_BY_MESSAGE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"startSessionByMessage",CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[t]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[t]=false}),this)})};t.prototype.linesOpenSession=function(e,t){t=t||{};s.ajax({url:this.BXIM.pathToAjax+"?OPEN_SESSION&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"openSession",USER_CODE:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(e){if(e.ERROR==""){this.BXIM.messenger.openMessenger("chat"+e.CHAT_ID,t).then(function(){if(s.MessengerWindow&&this.isLinesOperator()){if(s.MessengerWindow.currentTab!="im-ol"){s.MessengerWindow.changeTab("im-ol")}}}.bind(this))}else{if(e.CODE=="ACCESS_DENIED"){this.BXIM.openConfirm(e.ERROR)}}}),this)})};t.prototype.linesVoteDraw=function(e){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE){return null}var t=this.BXIM.messenger.message[e];var r=false;if(this.BXIM.messenger.currentTab.toString().substr(0,4)=="chat"){var i=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.message[e].chatId]);if(!i){return null}if(!this.BXIM.messenger.users[this.BXIM.userId].connector&&!(i=="livechat"||i=="network"||i=="support24Question")){return null}r=!this.BXIM.messenger.users[this.BXIM.userId].connector&&i!="support24Question"}else if(!this.BXIM.messenger.bot[this.BXIM.messenger.currentTab]||this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="network"&&this.BXIM.messenger.bot[this.BXIM.messenger.currentTab].type!="support24"){return null}var a="";var n=false;if(t.params.IMOL_VOTE=="like"){n=true;a=t.params.IMOL_VOTE_LIKE}else if(t.params.IMOL_VOTE=="dislike"){n=true;a=t.params.IMOL_VOTE_DISLIKE}else{a=t.params.IMOL_VOTE_TEXT}return s.create("div",{attrs:{"data-messageId":e},props:{className:"bx-messenger-content-item-vote-block"+(n?" bx-messenger-content-item-vote-block-done":"")},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-block-text"},html:s.util.htmlspecialchars(a)}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-buttons"},children:[s.create("span",{attrs:{title:s.message("IM_OL_VOTE_LIKE")},props:{className:"bx-messenger-content-item-vote-block-like"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate((function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"like")}),this)}}),s.create("span",{attrs:{title:s.message("IM_OL_VOTE_DISLIKE")},props:{className:"bx-messenger-content-item-vote-block-dislike"+(r?" bx-messenger-content-item-vote-block-disabled":"")},events:{click:r?function(){}:s.delegate((function(){this.linesVoteSend(this.BXIM.messenger.currentTab,s.proxy_context.parentNode.parentNode.getAttribute("data-messageId"),"dislike")}),this)}})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-block-final"},children:[s.create("span",{props:{className:t.params.IMOL_VOTE=="dislike"?"bx-messenger-content-item-vote-block-smile-dislike":"bx-messenger-content-item-vote-block-smile-like"}})]})]})};t.prototype.linesVoteResultDraw=function(e,t){if(!this.BXIM.messenger.message[e]||!this.BXIM.messenger.message[e].params||!this.BXIM.messenger.message[e].params.IMOL_VOTE_SID){return t}var r=this.BXIM.messenger.message[e];var i="";if(typeof r.params.IMOL_VOTE_USER=="undefined"||r.params.IMOL_VOTE_USER==0){i=s.message("IM_OL_VOTE_WO")}else if(r.params.IMOL_VOTE_USER==5){i='<span class="bx-smile bx-im-smile-like" title="'+s.message("IM_MESSAGE_LIKE")+'"></span>'}else{i='<span class="bx-smile bx-im-smile-dislike" title="'+s.message("IM_MESSAGE_DISLIKE")+'"></span>'}var a=this.linesGetSession(this.BXIM.messenger.chat[r.chatId]);if(!a){return t}var n=this.linesVoteHeadNodes(r.params.IMOL_VOTE_SID,r.params.IMOL_VOTE_HEAD,a.canVoteHead);if(typeof r.params.IMOL_COMMENT_HEAD=="object"&&r.params.IMOL_COMMENT_HEAD){var o=r.params.IMOL_COMMENT_HEAD["text"]}else{var o=r.params.IMOL_COMMENT_HEAD}var l=this.linesCommentHeadNodes(r.params.IMOL_VOTE_SID,o,a.canVoteHead);return s.create("div",{attrs:{"data-messageId":e},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-message-text"},html:t}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result"},children:[s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_USER")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},html:i})]}),s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_VOTE_HEAD")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[n]})]}),l?s.create("div",{props:{className:"bx-messenger-content-item-vote-result-row"},children:[s.create("span",{props:{className:"bx-messenger-content-item-vote-result-name"},html:s.message("IM_OL_COMMENT_HEAD")+":"}),s.create("span",{props:{className:"bx-messenger-content-item-vote-result-value"},children:[l]})]}):null]})]})};t.prototype.linesVoteSend=function(e,t,r){if(!this.BXIM.messenger.message[t]||!this.BXIM.messenger.message[t].params||!this.BXIM.messenger.message[t].params.IMOL_VOTE){return false}if(!!this.BXIM.messenger.message[t].params.IMOL_DATE_CLOSE_VOTE&&new Date(this.BXIM.messenger.message[t].params.IMOL_DATE_CLOSE_VOTE).getTime()<(new Date).getTime()){var i=s.message("IM_OL_CLOSE_VOTE_NO_DAY");if(!!this.BXIM.messenger.message[t].params.IMOL_TIME_LIMIT_VOTE&&this.BXIM.messenger.message[t].params.IMOL_TIME_LIMIT_VOTE>0){i=s.message("IM_OL_CLOSE_VOTE").replace("#DAYS#",s.date.format("ddiff",Date.now()/1e3-this.BXIM.messenger.message[t].params.IMOL_TIME_LIMIT_VOTE))}var a=s.findChild(s("im-message-"+t),{class:"bx-messenger-content-item-vote-block-"+r},true,false);var n=s.PopupWindowManager.create("popup-close-vote-message-"+r,a,{content:s.create("DIV",{style:{padding:"10px"},children:i}),zIndex:100,closeIcon:{opacity:1},closeByEsc:true,darkMode:false,autoHide:true,angle:true,offsetLeft:20,offsetTop:10,events:{onPopupClose:s.proxy((function(){n.destroy()}),this)}});n.show();return false}if(e.toString().substr(0,4)=="chat"){var o=this.linesGetSource(this.BXIM.messenger.chat[this.BXIM.messenger.message[t].chatId]);if(!o){return null}if(!this.BXIM.messenger.users[this.BXIM.userId].connector&&!(o=="livechat"||o=="network"||o=="support24Question")){return null}}else if(!this.BXIM.messenger.bot[e]||this.BXIM.messenger.bot[e].type!="network"&&this.BXIM.messenger.bot[e].type!="support24"){return null}this.BXIM.messenger.message[t].params.IMOL_VOTE=r;var l=s("im-message-"+t);if(l){l.innerHTML="";l.appendChild(this.linesVoteDraw(t))}s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{IM_LINES_VOTE_SEND:"Y",DIALOG_ID:e,MESSAGE_ID:t,RATING:r,IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){if(this.BXIM.messenger.popupMessengerLiveChatDelayedForm){clearTimeout(this.BXIM.messenger.popupMessengerLiveChatActionTimeout);this.BXIM.messenger.popupMessengerLiveChatActionTimeout=setTimeout(s.delegate((function(){this.BXIM.messenger.linesLivechatFormShow(this.BXIM.messenger.popupMessengerLiveChatDelayedForm);this.BXIM.messenger.popupMessengerLiveChatDelayedForm=null}),this),1e3)}}),this)})};t.prototype.linesSaveToQuickAnswers=function(e,t){if(!this.BXIM.messenger.message[e]){return false}var r=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[r])return false;if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(r))return false;this.BXIM.messenger.blockJoinChat[r]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_SAVE_TO_QUICK_ANSWERS&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.message.saveToQuickAnswers",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+r)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"saveToQuickAnswers",CHAT_ID:r,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(i){this.BXIM.messenger.blockJoinChat[r]=false;if(t!==true){if(i.ERROR){this.BXIM.openConfirm(i.ERROR)}else{this.BXIM.openConfirm(s.message("IM_SAVE_TO_QUICK_ANSWERS_SUCCESS"));this.BXIM.messenger.message[e].quick_saved=true}}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[r]=false;if(t!==true){this.BXIM.openConfirm(s.message("IM_SAVE_TO_QUICK_ANSWERS_ERROR"))}}),this)})};t.prototype.linesVoteHeadNodes=function(e,t,r,i){t=t||0;r=r||false;var a=s.delegate((function(){if(!this.BXIM.messenger.openlines.canUseVoteHead){s.UI.InfoHelper.show("limit_contact_center_ol_boss_rate");return false}var e=s.proxy_context.getAttribute("data-rating");var t=s.proxy_context.getAttribute("data-sessionId");s.proxy_context.parentNode.previousSibling.style.width=e*20+"%";if(i)i.setAttribute("data-rating",e);this.linesVoteHeadSend(t,e);if(this.BXIM.messenger.popupTooltip)this.BXIM.messenger.popupTooltip.close()}),this);return s.create("div",{props:{className:"bx-lines-rating-box"},children:[s.create("div",{props:{className:"bx-lines-rating-box-current"},attrs:{style:"width:"+t*20+"%"}}),r?s.create("div",{props:{className:"bx-lines-rating-box-live"},children:[s.create("span",{attrs:{"data-rating":1,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":2,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":3,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":4,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}}),s.create("span",{attrs:{"data-rating":5,"data-sessionId":e},props:{className:"bx-lines-rating-box-item"},events:{click:a}})]}):null]})};t.prototype.linesCommentHeadNodes=function(e,t,r,i){var a=null;if(!i){i="im"}if(typeof t==="undefined"||t===null||t==="")t="";r=r||false;var n=s.delegate((function(){if(!this.BXIM.messenger.openlines.canUseVoteHead){s.UI.InfoHelper.show("limit_contact_center_ol_boss_rate");return false}if(this.BXIM.messenger.linesCommentHeadAdd){this.BXIM.messenger.linesCommentHeadAdd(null,t)}if(this.BXIM.messenger.popupTooltip)this.BXIM.messenger.popupTooltip.close()}),this);if(t===""){if(r&&this.BXIM.messenger.linesCommentHeadAdd){a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-add bx-messenger-ajax"},html:s.message("IM_OL_COMMENT_HEAD_ADD"),events:{click:n}})}}else{var o=t.replace(/\n/gi,"<br />");if(r&&this.BXIM.messenger.linesCommentHeadAdd){a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-edit bx-messenger-ajax"},html:o,events:{click:n}})}else{a=s.create("span",{attrs:{"data-sessionId":e,"data-context":i},props:{className:"bx-messenger-content-item-vote-comment-not-edit bx-messenger-ajax"},html:o})}}return a};t.prototype.linesVoteHeadSend=function(e,t,r){var i=false;if(!t){t=null}if(typeof r==="undefined"){r=null}e=parseInt(e);t=parseInt(t);if(t<=0||t>5||isNaN(t)){t=null}if(e>0&&(t!=null||r!=null)){if(t!=null){if(!this.BXIM.messenger.openlines["voteRatingHead"]){this.BXIM.messenger.openlines["voteRatingHead"]={}}this.BXIM.messenger.openlines["voteRatingHead"][e]=t}if(r!=null){if(!this.BXIM.messenger.openlines["voteCommentHead"]){this.BXIM.messenger.openlines["voteCommentHead"]={}}this.BXIM.messenger.openlines["voteCommentHead"][e]=r}s.ajax({url:this.BXIM.pathToAjax+"?LINES_VOTE_SEND&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"voteHead",SESSION_ID:e,RATING:t,COMMENT:r,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()}});i=true}return i};t.prototype.linesCanVoteAsHead=function(e){if(!this.BXIM.messenger.openlines||!this.BXIM.messenger.openlines.canVoteAsHead||!this.BXIM.messenger.openlines.canVoteAsHead[e]){return false}return true};t.prototype.linesGetCrmPath=function(e,s){if(!this.BXIM.path.crm[e]||!this.BXIM.bitrixCrm){return""}return this.BXIM.path.crm[e].replace("#ID#",s)};t.prototype.linesGetSession=function(e){var s=null;if(!e||e.type!="lines")return s;s={};s.source=this.linesGetSource(e);var t=e.entity_id.toString().split("|");s.connector=t[0];s.canVoteHead=this.linesCanVoteAsHead(t[1]);var r=e.entity_data_1.toString().split("|");var i=e.entity_data_2.toString().split("|");s.crm=this.BXIM.bitrixCrm&&typeof r[0]!="undefined"&&r[0]=="Y"?"Y":"N";s.crmEntityType=this.BXIM.bitrixCrm&&typeof r[1]!="undefined"?r[1]:"NONE";s.crmEntityId=this.BXIM.bitrixCrm&&typeof r[2]!="undefined"?r[2]:0;s.crmLink="";s.pin=typeof r[3]!="undefined"&&r[3]=="Y"?"Y":"N";s.wait=typeof r[4]!="undefined"&&r[4]=="Y"?"Y":"N";s.id=typeof r[5]!="undefined"?parseInt(r[5]):Math.round(new Date/1e3)+e.id;s.dateCreate=typeof r[6]!="undefined"||r[6]>0?parseInt(r[6]):s.id;s.lineId=typeof r[7]!="undefined"&&r[7]>0?parseInt(r[7]):t[1];s.blockDate=typeof r[8]!="undefined"||r[8]>0?parseInt(r[8]):0;s.blockReason=typeof r[9]!="undefined"?r[9].toUpperCase():"NONE";s.crmLinkLead="";s.crmLead=0;s.crmLinkCompany="";s.crmCompany=0;s.crmLinkContact="";s.crmContact=0;s.crmLinkDeal="";s.crmDeal=0;if(this.BXIM.bitrixCrm&&i){var a;for(a=0;a<i.length;a=a+2){if(i[a]=="LEAD"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkLead=this.linesGetCrmPath("LEAD",i[a+1]);s.crmLead=i[a+1]}if(i[a]=="COMPANY"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkCompany=this.linesGetCrmPath("COMPANY",i[a+1]);s.crmCompany=i[a+1]}if(i[a]=="CONTACT"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkContact=this.linesGetCrmPath("CONTACT",i[a+1]);s.crmContact=i[a+1]}if(i[a]=="DEAL"&&i[a+1]!=0&&i[a+1]!="undefined"){s.crmLinkDeal=this.linesGetCrmPath("DEAL",i[a+1]);s.crmDeal=i[a+1]}else{s.crmDeal=0}}}if(s.crmEntityType!="NONE"){s.crmLink=this.linesGetCrmPath(s.crmEntityType,s.crmEntityId)}return s};t.prototype.linesSetSession=function(e,s){var t=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="lines")return t;t=this.linesGetSession(this.BXIM.messenger.chat[e]);if(typeof s.crm!="undefined"){t.crm=s.crm}if(typeof s.crmEntityType!="undefined"){t.crmEntityType=s.crmEntityType}if(typeof s.crmEntityId!="undefined"){t.crmEntityId=s.crmEntityId}if(typeof s.pin!="undefined"){t.pin=s.pin}if(typeof s.wait!="undefined"){t.wait=s.wait}if(typeof s.id!="undefined"){t.id=s.id}if(typeof s.dateCreate!="undefined"){t.dateCreate=s.dateCreate}if(typeof s.crmLead!="undefined"){t.crmLead=s.crmLead}if(typeof s.crmCompany!="undefined"){t.crmCompany=s.crmCompany}if(typeof s.crmContact!="undefined"){t.crmContact=s.crmContact}if(typeof s.crmDeal!="undefined"){t.crmDeal=s.crmDeal}this.BXIM.messenger.chat[e].entity_data_1=[t.crm,t.crmEntityType,t.crmEntityId,t.pin,t.wait,t.id,t.dateCreate].join("|");this.BXIM.messenger.chat[e].entity_data_2="LEAD|"+t.crmLead+"|COMPANY|"+t.crmCompany+"|CONTACT|"+t.crmContact+"|DEAL|"+t.crmDeal;return t};t.prototype.livechatGetSession=function(e){var s=null;if(!this.BXIM.messenger.chat[e]||this.BXIM.messenger.chat[e].type!="livechat")return s;s={};var t=this.BXIM.messenger.chat[e].entity_data_1.toString().split("|");s.readed=typeof t[0]!="undefined"&&t[0]=="Y"?"Y":"N";s.readedId=typeof t[1]!="undefined"?t[1]:0;s.readedTime=typeof t[2]!="undefined"?t[2]:false;s.sessionId=typeof t[3]!="undefined"?t[3]:0;s.showForm=typeof t[4]!="undefined"?t[4]:"Y";return s};t.prototype.linesGetSource=function(e){var s="";if(!e||!(e.type=="livechat"||e.type=="lines"||e.type=="support24Question")){return s}if(e.type=="livechat"){s="livechat"}else if(e.type=="support24Question"){s="support24Question"}else{s=e.entity_id.toString().split("|")[0]}if(s=="skypebot"){s="skype"}else{s=s.replace(".","_")}return s};t.prototype.linesAnswer=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ANSWER&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.answer",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"answer",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.linesSkip=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_SKIP&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.skip",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"skip",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){if(this.closeSlider()){return true}this.BXIM.messenger.blockJoinChat[e]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesActivateSilentMode=function(e,t,r){if(!r)return false;if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"";if(this.BXIM.messenger.chat[e].entity_data_3==t)return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_SILENT_MODE&V="+this.BXIM.revision,method:"POST",dataType:"json",timeout:60,data:{COMMAND:"silentMode",ACTIVATE:t?"Y":"N",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false;this.BXIM.messenger.chat[e].entity_data_3=t}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.linesActivatePinMode=function(e,t){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;t=t=="Y"?"Y":"N";this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_ACTIVATE_PIN_MODE&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.pin",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e),data:{timLinesPinAction:t}}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"pinMode",ACTIVATE:t,CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(r){this.BXIM.messenger.blockJoinChat[e]=false;if(typeof r.CODE!="undefined"){if(r.CODE==="ERROR_USER_NOT_OPERATOR"){s.MessengerCommon.reloadDialogOL();BXIM.openMessenger("chat"+e)}}else{s.MessengerCommon.linesSetSession(e,{pin:t})}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.linesCloseDialog=function(e,t){if(t===undefined){t=false}if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.MessengerCommon.dialogCloseCurrent();var r="closeDialog";if(t!==false){r="closeDialogOtherOperator"}s.ajax({url:this.BXIM.pathToAjax+"?LINES_CLOSE_DIALOG&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.finish",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:r,CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){this.BXIM.messenger.blockJoinChat[e]=false;s.MessengerCommon.linesSetSession(e,{wait:"Y"});this.BXIM.messenger.redrawChatHeader({userRedraw:false});if(typeof t.CODE!="undefined"&&t.CODE==="ERROR_USER_NOT_OPERATOR"){s.MessengerCommon.reloadDialogOL()}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesMarkAsSpam=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_MARK_SPAM&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.spam",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"markSpam",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false;this.linesSetSession(e,{id:0,wait:"Y"});this.dialogCloseCurrent();this.BXIM.messenger.redrawChatHeader({userRedraw:false})}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)});delete this.BXIM.messenger.chat[e];delete this.BXIM.messenger.showMessage["chat"+e]};t.prototype.linesInterceptSession=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_INTERCEPT_SESSION&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.session.intercept",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"interceptSession",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.linesCreateLead=function(e){if(this.BXIM.messenger.blockJoinChat[e])return false;if(this.BXIM.messenger.chat[e]&&this.BXIM.messenger.chat[e].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(e))return false;var t=this.linesGetSession(this.BXIM.messenger.chat[e]);if(!this.BXIM.bitrixCrm||t.crm=="Y"){return false}this.BXIM.messenger.blockJoinChat[e]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CREATE_LEAD&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.create",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+e)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"createLead",CHAT_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(t){this.BXIM.messenger.blockJoinChat[e]=false;if(typeof t.CODE!="undefined"&&t.CODE==="ERROR_USER_NOT_OPERATOR"){s.MessengerCommon.reloadDialogOL();BXIM.openMessenger("chat"+e)}}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[e]=false}),this)})};t.prototype.linesChangeCrmEntity=function(t){if(!this.BXIM.messenger.message[t])return false;var r=this.BXIM.messenger.message[t].chatId;if(this.BXIM.messenger.blockJoinChat[r])return false;if(this.BXIM.messenger.chat[r]&&this.BXIM.messenger.chat[r].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(r))return false;var i=this.linesGetSession(this.BXIM.messenger.chat[r]);if(!this.BXIM.bitrixCrm||i.crm=="N")return false;this.linesChangeCrmEntityMessageId=t;if(e.obCrm&&e.obCrm.olCrmSelector){e.obCrm.olCrmSelector.Open()}else{s.ajax({url:BXIM.pathToAjax+"?CRM_SELECTOR&V="+BXIM.revision,method:"POST",timeout:30,data:{IM_CRM_SELECTOR:"Y",sessid:s.bitrix_sessid()}});s.addCustomEvent("onCrmSelectorInit",(function(t,r,i){if(r!="olCrmSelector")return true;setTimeout((function(){e.obCrm[r].Open();e.obCrm[r].AddOnSaveListener((function(e){s.MessengerCommon.linesChangeCrmEntityAjax(e)}))}),200)}))}};t.prototype.linesChangeCrmEntityAjax=function(e){if(!this.BXIM.bitrixCrm){return false}var t=false;for(var r in e["company"]){t=e["company"][r]}if(!t){for(var r in e["contact"]){t=e["contact"][r]}}if(!t){for(var r in e["lead"]){t=e["lead"][r]}}if(!t){return false}var i=this.linesChangeCrmEntityMessageId;if(!this.BXIM.messenger.message[i])return false;var a=this.BXIM.messenger.message[i].chatId;if(this.BXIM.messenger.blockJoinChat[a])return false;if(this.BXIM.messenger.chat[a]&&this.BXIM.messenger.chat[a].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(a))return false;var n=t.id.split("_")[1];var o=t.type;this.BXIM.messenger.blockJoinChat[a]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CHANGE_CRM_ENTITY&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.change",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+a)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"changeCrmEntity",CHAT_ID:a,MESSAGE_ID:i,ENTITY_TYPE:o,ENTITY_ID:n,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[a]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[a]=false}),this)})};t.prototype.linesCancelCrmExtend=function(e){if(!this.BXIM.bitrixCrm){return false}if(!this.BXIM.messenger.message[e])return false;var t=this.BXIM.messenger.message[e].chatId;if(this.BXIM.messenger.blockJoinChat[t])return false;if(this.BXIM.messenger.chat[t]&&this.BXIM.messenger.chat[t].entity_type!="LINES")return false;if(!s.MessengerCommon.userInChat(t))return false;this.BXIM.messenger.blockJoinChat[t]=true;s.ajax({url:this.BXIM.pathToAjax+"?LINES_CANCEL_CRM_EXTEND&V="+this.BXIM.revision+"&logTag="+s.MessengerCommon.getLogTrackingParams({name:"imopenlines.operator.crm.cancel",dialog:s.MessengerCommon.getDialogDataForTracking("chat"+t)}),method:"POST",dataType:"json",timeout:60,data:{COMMAND:"cancelCrmExtend",CHAT_ID:t,MESSAGE_ID:e,IM_OPEN_LINES:"Y",IM_AJAX_CALL:"Y",sessid:s.bitrix_sessid()},onsuccess:s.delegate((function(){this.BXIM.messenger.blockJoinChat[t]=false}),this),onfailure:s.delegate((function(){this.BXIM.messenger.blockJoinChat[t]=false}),this)});var r=s("im-message-keyboard-"+e);if(r){r.innerHTML="";r.id="im-message-keyboard-empty-"+e;r.className=""}};t.prototype.getMessageParam=function(e,s,t){var r=this.getMessageParams(e);if(!r){return t}if(typeof r[s]==="undefined"){return t}return r[s]};t.prototype.getMessageParams=function(e){if(typeof this.BXIM.messenger.message[e]==="undefined"){return null}var s=this.BXIM.messenger.message[e];if(typeof s.params==="undefined"){return{}}return s.params};t.prototype.getMessagePlural=function(e,t){return s.Loc.getMessagePlural(e,parseInt(t))};t.prototype.openStore=function(e){if(!s.MessengerCommon.isSliderSupport()){if(this.isDesktop()){s.desktop.browse("/online/?IM_DIALOG="+this.BXIM.messenger.currentTab)}else{this.BXIM.openConfirm(s.message("IM_FUNCTION_FOR_BROWSER"))}return false}else{var t=this.getDialogId();var r=this.linesGetSession(this.BXIM.messenger.chat[t.substr(4)]);var i={dialogId:t,sessionId:r.id,ownerId:r.crmDeal,context:"chat"};Object.assign(i,e);var a=s.util.add_url_param("/saleshub/app/",i);if(i["compilationId"]){s.SidePanel.Instance.destroy(a)}s.SidePanel.Instance.open(a,{allowChangeHistory:false,width:1140})}};t.prototype.sendCompilationByChat=function(e){s.ajax.runAction("salescenter.compilation.sendCompilationByChat",{data:{compilationId:e}})};t.prototype.openRenamePortal=function(e){if(e&&s.hasClass(e,"bx-messenger-keyboard-button-block")){return false}if(this.isMobile()){app.alert({text:s.message("IM_FUNCTION_FOR_BROWSER")})}if(this.isDesktop()){s.desktop.browse(this.BXIM.path.profile+"?b24renameform=1","desktopApp")}else if(typeof s.Bitrix24!="undefined"){s.Bitrix24.renamePortal()}else{this.BXIM.openConfirm(s.message("IM_UNKNOWN_ERROR"))}return true};t.prototype.updateUserData=function(e){var t;if(s.type.isPlainObject(e.users)){for(t in e.users){e.users[t].last_activity_date=e.users[t].last_activity_date?new Date(e.users[t].last_activity_date):false;e.users[t].mobile_last_date=e.users[t].mobile_last_date?new Date(e.users[t].mobile_last_date):false;e.users[t].idle=e.users[t].idle?new Date(e.users[t].idle):false;e.users[t].absent=e.users[t].absent?new Date(e.users[t].absent):false;this.BXIM.messenger.users[t]=e.users[t]}}if(s.type.isPlainObject(e.hrphoto)){for(t in e.hrphoto){this.BXIM.messenger.hrphoto[t]=e.hrphoto[t]}}if(s.type.isPlainObject(e.chat)){for(t in e.chat){e.chat[t].date_create=new Date(e.chat[t].date_create);this.BXIM.messenger.chat[t]=e.chat[t]}}if(s.type.isPlainObject(e.userInChat)){for(t in e.userInChat){this.BXIM.messenger.userInChat[t]=e.userInChat[t]}}};s.MessengerCommon=new t;var r=function(){this.list={};this.updateInterval=1e3;clearInterval(this.updateIntervalId);this.updateIntervalId=setInterval(this.worker.bind(this),this.updateInterval)};r.prototype.start=function(e,s,t,r,i){s=s===null?"default":s;t=parseInt(t);if(t<=0||s.toString().length<=0){return false}if(typeof this.list[e]=="undefined"){this.list[e]={}}this.list[e][s]={dateStop:(new Date).getTime()+t,callback:typeof r=="function"?r:function(){},callbackParams:typeof i=="undefined"?{}:i};return true};r.prototype.stop=function(e,s,t){s=s===null?"default":s;if(s.toString().length<=0||typeof this.list[e]=="undefined"){return false}if(!this.list[e][s]){return true}if(t!==true){this.list[e][s]["callback"](s,this.list[e][s]["callbackParams"])}delete this.list[e][s];return true};r.prototype.stopAll=function(e){for(var s in this.list){if(this.list.hasOwnProperty(s)){for(var t in this.list[s]){if(this.list[s].hasOwnProperty(t)){this.stop(s,t,e)}}}}return true};r.prototype.worker=function(){for(var e in this.list){if(!this.list.hasOwnProperty(e)){continue}for(var s in this.list[e]){if(!this.list[e].hasOwnProperty(s)||this.list[e][s]["dateStop"]>new Date){continue}this.stop(e,s)}}return true};r.prototype.destroy=function(){clearInterval(this.updateIntervalId);this.stopAll(true);return true};s.MessengerTimer=new r})(window);
//# sourceMappingURL=common.map.js