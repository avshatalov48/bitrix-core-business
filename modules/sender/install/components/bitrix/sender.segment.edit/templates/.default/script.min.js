(function(){BX.namespace("BX.Sender.Connector");if(BX.Sender.Connector.Manager){return}var t=BX.Sender.Page;var e=BX.Sender.Helper;function i(t){this.node=t.node}i.prototype.getInputs=function(t){var e=this.node.elements;e=BX.convert.nodeListToArray(e);return e.filter(this.checkInput.bind(this,t),this)};i.prototype.checkInput=function(t,e){t=t||null;if(!e||!e.name||!BX.type.isString(e.name)){return false}if(e.name.substring(0,11)!=="CONNECTOR_S"){return false}if(t&&!t.contains(e)){return false}return!e.disabled};i.prototype.getInputName=function(t){return t.name};i.prototype.getInputValue=function(t){switch(t.type.toLowerCase()){case"text":case"textarea":case"password":case"number":case"hidden":case"select-one":return t.value;break;case"file":break;case"radio":case"checkbox":if(t.checked){return t.value}break;case"select-multiple":var e=[];for(var i=0;i<t.options.length;i++){if(t.options[i].selected){e.push(t.options[i].value)}}if(e.length>0){return e}break;default:break}return null};i.prototype.getFields=function(t){var e={};var i=this.getInputs(t);for(var n=0;n<i.length;n++){var o=i[n];var r=this.getInputName(o);var s=this.getInputValue(o);if(BX.type.isString(e[r])){e[r]=[e[r]]}if(BX.type.isArray(e[r])){if(!BX.util.in_array(s,e[r])){e[r].push(s)}}else{e[r]=s}}return e};function n(){}n.prototype.init=function(n){this.list=[];this.actionUri=n.actionUri||"";this.onlyConnectorFilters=n.onlyConnectorFilters;this.showContactSets=n.showContactSets;this.prettyDateFormat=n.prettyDateFormat;this.mess=n.mess||{patternTitle:"",newTitle:""};this.availableConnectors=n.availableConnectors||[];this.context=BX(n.containerId);this.isFrame=n.isFrame||false;this.isSaved=n.isSaved||false;this.canViewConnData=n.canViewConnData||false;this.contactTileNameTemplate=n.contactTileNameTemplate||"";this.pathToResult=n.pathToResult||"";this.pathToContactList=n.pathToContactList||"";this.pathToContactImport=n.pathToContactImport||"";this.segmentTile=n.segmentTile||{};this.ajaxAction=new BX.AjaxAction(this.actionUri);this.form=new i({node:this.context.querySelector("form")});new o({manager:this});this.initUi();this.initItems();this.contactList=new s({manager:this});e.hint.init(this.context);if(!this.ui.title.value.trim()){this.ui.title.value=e.replace(this.mess.patternTitle,{name:this.mess.newTitle,date:BX.date.format(this.prettyDateFormat)})}t.initButtons();if(this.isFrame){e.titleEditor.init({dataNode:this.ui.title})}if(this.isFrame&&this.isSaved){top.BX.onCustomEvent(top,"sender-segment-edit-change",[this.segmentTile]);BX.Sender.Page.slider.close()}};n.prototype.initUi=function(){this.ui={counter:this.context.querySelector("[data-bx-counter]"),countInfo:this.context.querySelector("[data-bx-count-info]"),button:this.context.querySelector("[data-bx-button]"),list:this.context.querySelector("[data-bx-list]"),title:e.getNode("segment-title",this.context)};BX.unbindAll(this.ui.button);BX.bind(this.ui.button,"click",this.showMenuAdd.bind(this))};n.prototype.initItems=function(){var t=this.ui.list.querySelectorAll("[data-bx-item]");t=BX.convert.nodeListToArray(t);t.forEach(this.initItem.bind(this));if(this.onlyConnectorFilters){this.availableConnectors.reverse().forEach(function(t){if(t.ID==="sender_contact_list"){return}var e=this.list.filter(function(e){return t.ID===e.getCode()}).length>0;if(e){return}this.createItem(t.ID)},this)}this.updateCounter()};n.prototype.getConnectorDataById=function(t){var e=this.availableConnectors.filter(function(e){return e.ID===t});return e[0]?e[0]:null};n.prototype.createItem=function(t){var e=this.getConnectorDataById(t);if(!e){return}var i=e.IS_FILTER;var n=e.FORM;var o=Math.floor(Math.random()*(1e4-100+1))+100;n=n.replace(new RegExp("%CONNECTOR_NUM%","g"),o);n=this.getConnectorForm({"%CONNECTOR_FILTER_ID%":e.FILTER_ID,"%CONNECTOR_NUM%":o,"%CONNECTOR_CODE%":e.CODE,"%CONNECTOR_MODULE_ID%":e.MODULE_ID,"%CONNECTOR_NAME%":BX.util.htmlspecialchars(e.NAME),"%CONNECTOR_COUNT%":"0","%CONNECTOR_COUNTER%":"","%CONNECTOR_FORM%":n,"%CONNECTOR_FILTER%":"","%CONNECTOR_IS_RESULT_VIEWABLE%":e.IS_RESULT_VIEWABLE},i);var r=BX.processHTML(n);var s=document.createElement("div");s.innerHTML=r.HTML;var a=BX.findChild(s,{tag:"div"});var l=a.style.display;a.style.display="none";this.ui.list.insertBefore(a,this.ui.list.firstChild);if(r.SCRIPT.length>0){var c;for(var u in r["SCRIPT"]){if(!r["SCRIPT"].hasOwnProperty(u)){continue}c=r["SCRIPT"][u];BX.evalGlobal(c.JS)}}var h=this.initItem(a);var d=new BX.easing({duration:500,start:{height:0,opacity:0},finish:{height:100,opacity:100},transition:BX.easing.transitions.quart,step:function(t){a.style.opacity=t.opacity/100;a.style.display=l},complete:function(){}});d.animate();this.getCount(h)};n.prototype.initItem=function(t){var e=new r({caller:this,context:t,code:t.getAttribute("data-code")});this.list.push(e);BX.addCustomEvent(e,"remove",this.removeItem.bind(this,e));BX.addCustomEvent(e,"change",this.getCount.bind(this,e));return e};n.prototype.onMenuAddClick=function(t){this.createItem(t);this.menuAdd.close()};n.prototype.showMenuAdd=function(){if(this.menuAdd){this.menuAdd.show();return}var t=this.availableConnectors.map(function(t){return{id:t.ID,text:t.NAME,onclick:this.onMenuAddClick.bind(this,t.ID)}},this);this.menuAdd=BX.PopupMenu.create("sender-segment-edit-menu-add",this.ui.button,t,{autoHide:true,offsetLeft:0,offsetTop:0,events:{}});this.menuAdd.show()};n.prototype.get=function(t){this.actionUri=t.actionUri};n.prototype.updateCounter=function(){var t=0;var i=[];this.list.forEach(function(e){t+=e.getCount();e.getCounters().forEach(function(t){var e=i.filter(function(e){return e.typeId===t.typeId});if(e.length){e[0].count+=t.count}else{i.push(BX.clone(t))}})});this.ui.countInfo.textContent=i.map(function(t){return t.typeName+" - "+t.count}).join(", ");e.changeDisplay(this.ui.countInfo.previousElementSibling,i.length>0);this.ui.counter.textContent=t;e.changeDisplay(this.ui.counter,!t)};n.prototype.getConnectorForm=function(t,e){e=e||false;var i=BX("connector-template"+(e?"-filter":""));var n=i.innerHTML;for(var o in t){if(!t.hasOwnProperty(o)){continue}n=n.replace(new RegExp(o,"g"),t[o])}return n};n.prototype.updateFilterData=function(t,e){this.ajaxAction.request({action:"getFilterData",onsuccess:this.onFilterData.bind(this,t,e),data:{filterId:t}})};n.prototype.onFilterData=function(t,e,i){if(!i.num){return}var n=this.getItemById(i.num);if(!n){return}this.setCount(n,i);n.flushFilterFields(i.data);if(e){e.apply(this,[])}};n.prototype.getCount=function(t){t.animateCounter(true);this.ajaxAction.request({action:"getCount",onsuccess:this.setCount.bind(this,t),data:t.getFields()})};n.prototype.setCount=function(t,e){e=e||{};t.animateCounter(false);t.setCount(e.count||{});this.updateCounter()};n.prototype.getItemById=function(t){var e=this.list.filter(function(e){return e.getId()===t});return e.length>0?e[0]:null};n.prototype.getItemByFilterId=function(t){var e=this.list.filter(function(e){return e.getFilterId()===t});return e.length>0?e[0]:null};n.prototype.removeItem=function(t){this.list=BX.util.deleteFromArray(this.list,this.list.indexOf(t));var e=new BX.easing({duration:300,start:{height:100,opacity:100},finish:{height:0,opacity:0},transition:BX.easing.transitions.quart,step:function(e){t.getContext().style.opacity=e.opacity/100},complete:BX.proxy(function(){t.remove();this.updateCounter()},this)});e.animate()};function o(t){this.manager=t.manager;this.init()}o.prototype.init=function(){BX.addCustomEvent("BX.Filter.Search:input",this.onBeforeApplyFilter.bind(this));BX.addCustomEvent("BX.Main.Filter:beforeApply",this.onBeforeApplyFilter.bind(this));BX.addCustomEvent("BX.Main.Filter:apply",this.onApplyFilter.bind(this))};o.prototype.onBeforeApplyFilter=function(t){var e=this.manager.getItemByFilterId(t);if(e){e.animateCounter(true)}};o.prototype.onFilterData=function(t,e){var i=this.manager.getItemByFilterId(t);if(i){i.animateCounter(false)}e.fulfill()};o.prototype.onApplyFilter=function(t,e,i,n,o){o.autoResolve=false;this.manager.updateFilterData(t,this.onFilterData.bind(this,t,n))};function r(t){this.code=t.code;this.caller=t.caller;this.context=t.context;this.init()}r.prototype.init=function(){this.ui={remove:this.context.querySelector("[data-bx-item-remove]"),counter:this.context.querySelector("[data-bx-item-counter]"),countInfo:this.context.querySelector("[data-bx-item-count-info]"),resultView:this.context.querySelector("[data-bx-item-result-view]"),toggler:this.context.querySelector("[data-bx-item-toggler]"),close:this.context.querySelector("[data-bx-item-close]"),filter:this.context.querySelector("[data-bx-item-filter]")};BX.bind(this.ui.remove,"click",this.onRemoveClick.bind(this));if(this.ui.toggler){BX.bind(this.ui.toggler,"click",this.toggleView.bind(this))}if(this.ui.close){BX.bind(this.ui.close,"click",this.toggleView.bind(this))}if(this.isResultViewable()){e.changeDisplay(this.ui.resultView,true);BX.bind(this.ui.resultView,"click",this.viewResult.bind(this,null))}var t=this.ui.countInfo.getAttribute("data-bx-item-count-info");if(t){try{t=JSON.parse(t)}catch(e){t=null}}this.setCount(t);this.caller.form.getInputs(this.context).forEach(this.listenInputChanges.bind(this));this.applyPreset();this.drawFilterFields();this.changeFilterPlaceholder()};r.prototype.getId=function(){return this.context.getAttribute("data-bx-item")};r.prototype.getCode=function(){return this.context.getAttribute("data-code")};r.prototype.listenInputChanges=function(t){BX.bind(t,"change",BX.delegate(function(){BX.onCustomEvent(this,"change",[this])},this))};r.prototype.getFilterId=function(){return this.context.getAttribute("data-bx-item-filter")};r.prototype.getFilter=function(){var t=BX.Main.filterManager.getById(this.getFilterId());if(!t||!(t instanceof BX.Main.Filter)){return null}return t};r.prototype.applyPreset=function(){var t=this.getFilter();if(!t){return}t.disableAddPreset();var e=this.getFilterFields();if(!e.BX_PRESET_ID){return}setTimeout(function(){t.getPreset().applyPreset(e.BX_PRESET_ID)},100)};r.prototype.flushFilterFields=function(t){if(!this.ui.filter){return}this.ui.filter.value=JSON.stringify(t)};r.prototype.getFilterFields=function(){if(!this.ui.filter){return{}}try{var t=JSON.parse(this.ui.filter.value)}catch(t){return{}}return BX.type.isPlainObject(t)?t:{}};r.prototype.drawFilterFields=function(){var t=this.getFilter();if(!t){return}var e=this.getFilterFields();if(e.length===0){return}for(var i in e){if(!e.hasOwnProperty(i)){continue}if(BX.type.isArray(e[i])){e[i]=e[i].reduce(function(t,e,i){t[i]=e;return t},{})}if(BX.type.isPlainObject(e[i])){var n=e[i];for(var o in n){if(!n.hasOwnProperty(o)){continue}if(!/[^\d]/.test(o)){continue}e[o]=n[o]}}}t.getApi().setFields(e)};r.prototype.changeFilterPlaceholder=function(){var t=this.getFilter();if(!t){return}var e=this.caller.mess.filterPlaceholder;var i=this.caller.mess.filterPlaceholderCrmLead;var n=this.caller.mess.filterPlaceholderCrmClient;if(i&&this.code==="sender_crm_lead"){e=i}else if(n&&this.code==="sender_crm_client"){e=n}t.params["MAIN_UI_FILTER__PLACEHOLDER_DEFAULT"]=e;t.params["MAIN_UI_FILTER__PLACEHOLDER_WITH_FILTER"]=e;t.params["MAIN_UI_FILTER__PLACEHOLDER"]=e;t.getSearch().adjustPlaceholder()};r.prototype.getFields=function(){return this.caller.form.getFields(this.context)};r.prototype.toggleView=function(){if(!this.isFormShown()){this.caller.list.forEach(function(t){if(!t.isFormShown()){return}t.toggleView()})}BX.toggleClass(this.context,"sender-box-list-item-hidden")};r.prototype.isFormShown=function(){return!BX.hasClass(this.context,"sender-box-list-item-hidden")};r.prototype.isResultViewable=function(){return this.caller.canViewConnData&&this.ui.resultView&&this.context.getAttribute("data-result-viewable")==="Y"};r.prototype.viewResult=function(t){if(!this.caller.canViewConnData){return}t=t||null;var e={code:this.getCode(),fields:JSON.stringify(this.getFilterFields())};e.SENDER_RECIPIENT_TYPE_ID=t;e.apply_filter="Y";var i=BX.util.add_url_param(this.caller.pathToResult,e);BX.SidePanel.Instance.open(i,{cacheable:false})};r.prototype.animateCounter=function(t){e.changeClass(this.context,"loading",t);if(t){this.setCount(null)}};r.prototype.getContext=function(){return this.context};r.prototype.setCount=function(t){t=t||{};this.counters=t.counters||[];this.ui.counter.textContent=t.summary||0;this.ui.countInfo.innerHTML="";this.counters.filter(function(t){return t.count>0},this).map(function(t){var e=document.createElement("a");if(this.isResultViewable()){BX.addClass(e,"sender-segment-counter-item");BX.bind(e,"click",this.viewResult.bind(this,t.typeId))}e.textContent=t.typeName+" - "+t.count;return e},this).forEach(function(t,e,i){this.ui.countInfo.appendChild(t);if(i.length>e+1){this.ui.countInfo.appendChild(document.createTextNode(", "))}},this);e.changeDisplay(this.ui.resultView,this.counters.length>0&&this.isResultViewable());e.changeDisplay(this.ui.counter,t.summary<=0)};r.prototype.getCounters=function(){return this.counters};r.prototype.getCount=function(){var t=parseInt(this.ui.counter.textContent);return isNaN(t)?0:t};r.prototype.onRemoveClick=function(t){t.preventDefault();BX.onCustomEvent(this,"remove",[this])};r.prototype.remove=function(){BX.unbindAll(this.ui.remove);BX.unbindAll(this.ui.toggler);BX.remove(this.context)};function s(t){this.manager=t.manager;this.init()}s.prototype.init=function(){var t="sender-segment-contacts";this.selector=BX.Sender.UI.TileSelector.getById(t);if(!this.selector){throw new Error("Tile selector `"+t+"` not found.")}BX.addCustomEvent(this.selector,this.selector.events.buttonSelect,this.onButtonSelect.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonSelectFirst,this.onButtonSelectFirst.bind(this));BX.addCustomEvent(this.selector,this.selector.events.containerClick,this.onButtonAdd.bind(this));BX.addCustomEvent(this.selector,this.selector.events.buttonAdd,this.onButtonAdd.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileClick,this.onTileClick.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileRemove,this.onTileRemove.bind(this));BX.addCustomEvent(this.selector,this.selector.events.tileAdd,this.onTileAdd.bind(this));BX.addCustomEvent(this.selector,this.selector.events.input,this.onInput.bind(this));BX.addCustomEvent(this.selector,this.selector.events.search,this.onSearch.bind(this));top.BX.addCustomEvent(top,"BX.Sender.ContactImport::loaded",this.onContactImportLoaded.bind(this))};s.prototype.onButtonSelect=function(){this.selector.showSearcher(this.manager.mess.contactSearchTitle)};s.prototype.onButtonSelectFirst=function(){var t=this.selector;this.manager.ajaxAction.request({action:"getContactSets",onsuccess:function(e){t.setSearcherData(e.list||[])},onfailure:t.hideSearcher.bind(t),data:{}})};s.prototype.onInput=function(t){};s.prototype.onSearch=function(t){};s.prototype.onTileAdd=function(t){this.setFields({LIST_ID:t.id||0})};s.prototype.onContactImportLoaded=function(t){var e=t.NAME;if(!this.manager.showContactSets){e=this.manager.contactTileNameTemplate.replace("%count%",t.COUNT||0)}var i=this.getContactTile();if(i){this.selector.updateTile(i,e)}else{this.selector.addTile(e,{},t.ID||0)}};s.prototype.setFields=function(t){var i=e.getNode("contact_list",this.manager.context);if(i){i.value=BX.type.isPlainObject(t)?JSON.stringify(t):null}};s.prototype.getContactTile=function(){var t=this.selector.getTiles();return t.length>0?t[0]:null};s.prototype.onButtonAdd=function(){var e=this.manager.pathToContactImport;var i=this.getContactTile();if(i){e+=e.indexOf("?")<0?"?":"&";e+="listId="+i.id}t.open(e)};s.prototype.onTileClick=function(e){var i=this.manager.pathToContactList;i+=i.indexOf("?")<0?"?":"&";i+="listId="+e.id;t.open(i)};s.prototype.onTileRemove=function(){this.setFields(null)};BX.Sender.Connector.Item=r;BX.Sender.Connector.Manager=new n})(window);