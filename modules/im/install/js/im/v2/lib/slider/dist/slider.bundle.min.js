this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,i,s,n,r,a,o,l,d,c,g,h){"use strict";const p="im:slider";const u=1200;const m="bx-im-messenger__slider";const y="/bitrix/js/im/v2/lib/slider/src/images/loader-chats.svg?v2";var v=babelHelpers.classPrivateFieldLooseKey("checkHistoryDialogId");var L=babelHelpers.classPrivateFieldLooseKey("prepareHistorySliderLink");class b{static init(){if(this.instance){return}this.instance=new this}static getInstance(){this.init();return this.instance}constructor(){Object.defineProperty(this,L,{value:C});Object.defineProperty(this,v,{value:S});this.instances={};this.sidePanelManager=BX.SidePanel.Instance;this.v2enabled=false;a.Logger.warn("Slider: class created");this.initSettings();this.bindEvents();this.store=n.Core.getStore()}async openChat(e=""){const t=e.toString();if(c.Utils.dialog.isLinesExternalId(t)){return this.openLines(t)}await this.openSlider();await this.store.dispatch("application/setLayout",{layoutName:r.Layout.chat.name,entityId:t});s.EventEmitter.emit(r.EventType.layout.onOpenChat,{dialogId:t});return Promise.resolve()}async openLines(e=""){let t=e.toString();if(c.Utils.dialog.isLinesExternalId(t)){const e=new h.LinesService;t=await e.getDialogIdByUserCode(t)}await this.openSlider();return this.store.dispatch("application/setLayout",{layoutName:r.Layout.openlines.name,entityId:t})}openHistory(e=""){if(!babelHelpers.classPrivateFieldLooseBase(this,v)[v](e)){return Promise.reject()}const t=babelHelpers.classPrivateFieldLooseBase(this,L)[L](e);BX.SidePanel.Instance.open(t,{width:c.Utils.dialog.isLinesExternalId(e)?700:1e3,allowChangeHistory:false,allowChangeTitle:false,cacheable:false});return Promise.resolve()}async openNotifications(){await this.openSlider();await this.store.dispatch("application/setLayout",{layoutName:r.Layout.notification.name});s.EventEmitter.emit(r.EventType.layout.onOpenNotifications);return Promise.resolve()}async openRecentSearch(){await this.openSlider();await this.store.dispatch("application/setLayout",{layoutName:r.Layout.chat.name});s.EventEmitter.emit(r.EventType.recent.openSearch);return Promise.resolve()}async openSettings(e={}){a.Logger.warn("Slider: openSettings",e);await this.openSlider();await this.store.dispatch("application/setLayout",{layoutName:r.Layout.settings.name});return Promise.resolve()}openConference(e=""){a.Logger.warn("Slider: openConference",e);if(!c.Utils.conference.isValidCode(e)){return new Promise(((e,t)=>{t()}))}const t=c.Utils.conference.getUrlByCode(e);c.Utils.browser.openLink(t,c.Utils.conference.getWindowNameByCode(e));return new Promise(((e,t)=>{e()}))}startVideoCall(e="",t=true){a.Logger.warn("Slider: onStartVideoCall",e,t);if(!c.Utils.dialog.isDialogId(e)){a.Logger.error("Slider: onStartVideoCall - dialogId is not correct",e);return false}l.CallManager.getInstance().startCall(e,t);return Promise.resolve()}startPhoneCall(e,t){a.Logger.warn("Slider: startPhoneCall",e,t);d.PhoneManager.getInstance().startCall(e,t);return Promise.resolve()}startCallList(e,t){a.Logger.warn("Slider: startCallList",e,t);d.PhoneManager.getInstance().startCallList(e,t);return Promise.resolve()}openNewTab(e){if(t.DesktopApi.getApiVersion()>=75&&t.DesktopApi.isChatTab()){t.DesktopApi.createImTab(`${e}&${r.GetParameter.desktopChatTabMode}=Y`)}else{c.Utils.browser.openLink(e)}}bindEvents(){if(!this.v2enabled){a.Logger.warn("Slider: v2 is not enabled");return false}s.EventEmitter.subscribe("SidePanel.Slider:onCloseByEsc",this.onCloseByEsc.bind(this));s.EventEmitter.subscribe("SidePanel.Slider:onClose",this.onClose.bind(this));s.EventEmitter.subscribe("SidePanel.Slider:onDestroy",this.onDestroy.bind(this));i.Event.ready(this.initZIndex.bind(this));return true}initSettings(){const e=i.Extension.getSettings("im.v2.lib.slider");this.v2enabled=e.get("v2enabled",false)}openSlider(){if(g.DesktopManager.isChatWindow()){this.sidePanelManager.closeAll(true);return Promise.resolve()}if(this.isOpened()){i.ZIndexManager.bringToFront(this.getCurrent().getOverlay());return Promise.resolve()}this.launchMessengerApplication();return new Promise((e=>{if(this.isFocused()){e();return}const t=this.getNextId();this.sidePanelManager.open(`${p}:${t}`,{data:{rightBoundary:0},cacheable:false,animationDuration:100,hideControls:true,customLeftBoundary:0,customRightBoundary:0,loader:y,contentCallback:()=>`<div class="${m}"></div>`,events:{onLoad:e=>{e.slider.showLoader()},onOpenComplete:t=>{this.initMessengerComponent().then((()=>{t.slider.closeLoader();return e()}))}}});this.instances[t]=this.sidePanelManager.getSlider(`${p}:${t}`)}))}launchMessengerApplication(){if(this.applicationPromise){return this.applicationPromise}this.applicationPromise=i.Runtime.loadExtension("im.v2.application.messenger").then((()=>o.Launch("messenger"))).then((e=>{a.Logger.warn("Slider: Messenger application launched",e);return e}));return this.applicationPromise}initMessengerComponent(){return this.applicationPromise.then((e=>{this.store.dispatch("application/setLayout",{layoutName:r.Layout.chat.name,entityId:""});return e.initComponent(`.${m}`)}))}onDialogOpen(e){a.Logger.warn("Slider: onDialogOpen",e.data.dialogId)}onClose({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(p)){return}if(!this.canClose()){e.denyAction();return}const i=this.getIdFromSliderId(t);delete this.instances[i];s.EventEmitter.emit(r.EventType.slider.onClose);this.store.dispatch("application/setLayout",{layoutName:r.Layout.chat.name,entityId:""})}onCloseByEsc({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(p)){return}if(!this.canCloseByEsc()){e.denyAction()}}onDestroy({data:e}){[e]=e;const t=e.getSlider().getUrl().toString();if(!t.startsWith(p)){return}const i=this.getIdFromSliderId(t);delete this.instances[i]}initZIndex(){if(!i.ZIndexManager){return}const e=i.ZIndexManager.getOrAddStack(document.body);e.baseIndex=u;e.sort()}getZIndex(){return u}isOpened(){return Object.keys(this.instances).length>0}isFocused(){if(!this.isOpened()){return false}const e=this.sidePanelManager.getTopSlider();if(!e){return false}return e.getUrl().toString().startsWith(p)}canClose(){return true}canCloseByEsc(){return false}getCurrent(){return this.instances[this.getCurrentId()]}getCurrentId(){return Object.keys(this.instances).length}getNextId(){return this.getCurrentId()+1}getIdFromSliderId(e){return Number.parseInt(e.slice(p.length+1),10)}}function S(e){return c.Utils.dialog.isDialogId(e)||c.Utils.dialog.isLinesHistoryId(e)||c.Utils.dialog.isLinesExternalId(e)}function C(e){const t=new URLSearchParams({[r.GetParameter.openHistory]:e,[r.GetParameter.backgroundType]:"light"});return`/desktop_app/history.php?${t.toString()}`}b.instance=null;e.MessengerSlider=b})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.Messenger.v2.Lib,BX,BX.Event,BX.Messenger.v2.Application,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Service);
//# sourceMappingURL=slider.bundle.map.js