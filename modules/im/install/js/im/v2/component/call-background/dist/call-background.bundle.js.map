{"version":3,"file":"call-background.bundle.js","sources":["../src/classes/items/background.js","../src/components/background.js","../src/classes/items/action.js","../src/components/action.js","../src/classes/items/mask.js","../src/components/mask.js","../src/components/loader.js","../src/classes/limit-manager.js","../src/const.js","../src/components/tab-panel.js","../src/components/video-preview.js","../src/classes/background-service.js","../src/classes/upload-manager.js","../src/call-background.js"],"sourcesContent":["import {Loc} from 'main.core';\n\nimport {FileStatus} from 'im.v2.const';\n\nimport type {BackgroundRestResult} from '../../types/rest';\n\nexport type UploadState = {\n\tprogress: number,\n\tstatus: string,\n\tsize: number\n};\n\nexport class Background\n{\n\tid: string = '';\n\ttitle: string = '';\n\tbackground: string = '';\n\tpreview: string = '';\n\tisVideo: boolean = false;\n\tisSupported: boolean = true;\n\tisCustom: boolean = false;\n\tcanRemove: boolean = false;\n\n\tisLoading: boolean = false;\n\tuploadState: UploadState = null;\n\n\tconstructor(params)\n\t{\n\t\tObject.assign(this, params);\n\t}\n\n\tstatic createDefaultFromRest(restItem: BackgroundRestResult): Background\n\t{\n\t\treturn new Background({\n\t\t\t...restItem,\n\t\t\tisVideo: restItem.id.includes(':video'),\n\t\t\tisCustom: false,\n\t\t\tcanRemove: false,\n\t\t\tisSupported: true\n\t\t});\n\t}\n\n\tstatic createCustomFromRest(restItem: BackgroundRestResult): Background\n\t{\n\t\tlet title = Loc.getMessage('BX_IM_CALL_BG_CUSTOM');\n\t\tif (!restItem.isSupported)\n\t\t{\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_UNSUPPORTED');\n\t\t}\n\n\t\treturn new Background({\n\t\t\t...restItem,\n\t\t\ttitle,\n\t\t\tisCustom: true,\n\t\t\tcanRemove: true\n\t\t});\n\t}\n\n\tstatic createCustomFromUploaderEvent(uploaderData: {id: string, filePreview: string, file: File}): Background\n\t{\n\t\tconst {id, filePreview, file} = uploaderData;\n\n\t\treturn new Background({\n\t\t\tid: id,\n\t\t\tbackground: filePreview,\n\t\t\tpreview: filePreview,\n\t\t\ttitle: Loc.getMessage('BX_IM_CALL_BG_CUSTOM'),\n\t\t\tisVideo: file.type.startsWith('video'),\n\t\t\tisCustom: true,\n\t\t\tcanRemove: false,\n\t\t\tisSupported: true,\n\t\t\tisLoading: true,\n\t\t\tuploadState: {\n\t\t\t\tprogress: 0,\n\t\t\t\tstatus: FileStatus.upload,\n\t\t\t\tsize: file.size,\n\t\t\t}\n\t\t});\n\t}\n\n\tsetUploadProgress(progress: number)\n\t{\n\t\tthis.uploadState.progress = progress;\n\t}\n\n\tsetUploadError()\n\t{\n\t\tthis.uploadState.status = FileStatus.error;\n\t\tthis.uploadState.progress = 0;\n\t}\n\n\tonUploadComplete(fileResult)\n\t{\n\t\tthis.id = fileResult.id;\n\n\t\tif (this.isVideo)\n\t\t{\n\t\t\tthis.background = fileResult.links.download;\n\t\t}\n\n\t\tthis.isLoading = false;\n\t\tthis.canRemove = true;\n\t}\n}","import {ProgressBarManager} from 'im.v2.lib.progressbar';\n\nimport {Background} from '../classes/items/background';\n\nimport '../css/background-item.css';\n\n// @vue/component\nexport const BackgroundComponent = {\n\tprops:\n\t{\n\t\telement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t},\n\t\tisSelected: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['click', 'remove', 'cancel'],\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tbackground(): Background\n\t\t{\n\t\t\treturn this.element;\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [];\n\n\t\t\tif (this.isSelected)\n\t\t\t{\n\t\t\t\tclasses.push('--selected');\n\t\t\t}\n\n\t\t\tif (!this.background.isSupported)\n\t\t\t{\n\t\t\t\tclasses.push('--unsupported');\n\t\t\t}\n\n\t\t\tif (this.background.isLoading)\n\t\t\t{\n\t\t\t\tclasses.push('--loading');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t},\n\t\timageStyle(): {backgroundImage: string}\n\t\t{\n\t\t\tlet backgroundImage = '';\n\t\t\tif (this.background.preview)\n\t\t\t{\n\t\t\t\tbackgroundImage = `url('${this.background.preview}')`;\n\t\t\t}\n\n\t\t\treturn {backgroundImage};\n\t\t}\n\t},\n\twatch:\n\t{\n\t\t'background.uploadState.status'()\n\t\t{\n\t\t\tthis.getProgressBarManager().update();\n\t\t},\n\t\t'background.uploadState.progress'()\n\t\t{\n\t\t\tthis.getProgressBarManager().update();\n\t\t}\n\t},\n\tmounted()\n\t{\n\t\tthis.initProgressBar();\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.removeProgressBar();\n\t},\n\tmethods:\n\t{\n\t\tinitProgressBar()\n\t\t{\n\t\t\tif (!this.background.uploadState || this.background.uploadState.progress === 100)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.progressBarManager = new ProgressBarManager({\n\t\t\t\tcontainer: this.$refs['container'],\n\t\t\t\tuploadState: this.background.uploadState\n\t\t\t});\n\n\t\t\tthis.progressBarManager.subscribe(ProgressBarManager.event.cancel, () => {\n\t\t\t\tthis.$emit('cancel', this.background);\n\t\t\t});\n\t\t\tthis.progressBarManager.subscribe(ProgressBarManager.event.destroy, () => {\n\t\t\t\tif (this.progressBar)\n\t\t\t\t{\n\t\t\t\t\tthis.progressBar = null;\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tthis.progressBarManager.start();\n\t\t},\n\t\tremoveProgressBar()\n\t\t{\n\t\t\tif (!this.progressBarManager)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.progressBarManager.destroy();\n\t\t},\n\t\tgetProgressBarManager(): ProgressBarManager\n\t\t{\n\t\t\treturn this.progressBarManager;\n\t\t},\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div @click=\"$emit('click')\" :class=\"containerClasses\" class=\"bx-im-call-background__item\" ref=\"container\">\n\t\t\t<div :style=\"imageStyle\" class=\"bx-im-call-background__item_image\"></div>\n\t\t\t<div v-if=\"background.isSupported && background.isVideo\" class=\"bx-im-call-background__item_video\"></div>\n\t\t\t<div v-if=\"!background.isLoading\" class=\"bx-im-call-background__item_title_container\">\n\t\t\t\t<span class=\"bx-im-call-background__item_title\">{{background.title}}</span>\n\t\t\t\t<div\n\t\t\t\t\tv-if=\"background.canRemove\"\n\t\t\t\t\t:title=\"loc('BX_IM_CALL_BG_REMOVE')\"\n\t\t\t\t\t@click.stop=\"$emit('remove')\"\n\t\t\t\t\tclass=\"bx-im-call-background__item_remove\"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t</div>\n\t`\n};","import {Loc} from 'main.core';\n\nexport class Action\n{\n\tstatic type = {\n\t\tnone: 'none',\n\t\tupload: 'upload',\n\t\tblur: 'blur',\n\t\tgaussianBlur: 'gaussianBlur'\n\t};\n\n\tid: string;\n\ttitle: string;\n\tbackground: string;\n\n\tconstructor(type: String)\n\t{\n\t\tlet id = Action.type.none;\n\t\tlet background = Action.type.none;\n\t\tlet title = Loc.getMessage('BX_IM_CALL_BG_ACTION_NONE');\n\n\t\tif (type === Action.type.upload)\n\t\t{\n\t\t\tid = type;\n\t\t\tbackground = type;\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_ACTION_UPLOAD');\n\t\t}\n\t\telse if (type === Action.type.gaussianBlur)\n\t\t{\n\t\t\tid = type;\n\t\t\tbackground = type;\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_ACTION_BLUR');\n\t\t}\n\t\telse if (type === Action.type.blur)\n\t\t{\n\t\t\tid = type;\n\t\t\tbackground = type;\n\t\t\ttitle = Loc.getMessage('BX_IM_CALL_BG_ACTION_BLUR_MAX');\n\t\t}\n\n\t\tthis.id = id;\n\t\tthis.background = background;\n\t\tthis.title = title;\n\t}\n\n\tisEmpty(): boolean\n\t{\n\t\treturn this.id === Action.type.none;\n\t}\n\n\tisBlur(): boolean\n\t{\n\t\treturn this.id === Action.type.gaussianBlur || this.id === Action.type.blur;\n\t}\n\n\tisUpload(): boolean\n\t{\n\t\treturn this.id === Action.type.upload;\n\t}\n}","import {Action} from '../classes/items/action';\n\n// @vue/component\nexport const ActionComponent = {\n\tprops:\n\t{\n\t\telement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t},\n\t\tisSelected: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\taction(): Action\n\t\t{\n\t\t\treturn this.element;\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [`--${this.action.id}`];\n\t\t\tif (this.isSelected)\n\t\t\t{\n\t\t\t\tclasses.push('--selected');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div :class=\"containerClasses\" class=\"bx-im-call-background__item --action\">\n\t\t\t<div class=\"bx-im-call-background__action_icon\"></div>\n\t\t\t<div class=\"bx-im-call-background__action_title\">\n\t\t\t\t{{ action.title }}\n\t\t\t</div>\n\t\t</div>\n\t`\n};","import {Loc} from 'main.core';\n\nimport type {MaskRestResult} from '../../types/rest';\n\nexport class Mask\n{\n\tid: string = '';\n\tactive: boolean = true;\n\tmask: string = '';\n\tbackground: string = '';\n\tpreview: string = '';\n\ttitle: string = '';\n\n\tisLoading: boolean = false;\n\n\tconstructor(params)\n\t{\n\t\tObject.assign(this, params);\n\t}\n\n\tisEmpty()\n\t{\n\t\treturn this.id === '';\n\t}\n\n\tstatic createEmpty()\n\t{\n\t\treturn new Mask({\n\t\t\tactive: true,\n\t\t\tid: '',\n\t\t\tmask: '',\n\t\t\tpreview: '',\n\t\t\tbackground: '',\n\t\t\ttitle: Loc.getMessage('BX_IM_CALL_BG_NO_MASK_TITLE')\n\t\t});\n\t}\n\n\tstatic createFromRest(rawMask: MaskRestResult)\n\t{\n\t\tconst {active, id, mask, background, preview, title} = rawMask;\n\n\t\treturn new Mask({\n\t\t\tactive,\n\t\t\tid,\n\t\t\tmask,\n\t\t\tpreview,\n\t\t\tbackground,\n\t\t\ttitle\n\t\t});\n\t}\n}","import '../css/mask.css';\n\nimport {Mask} from '../classes/items/mask';\n\n// @vue/component\nexport const MaskComponent = {\n\tprops:\n\t{\n\t\telement: {\n\t\t\ttype: Object,\n\t\t\trequired: true\n\t\t},\n\t\tisSelected: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\tmask(): Mask\n\t\t{\n\t\t\treturn this.element;\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [`--${this.mask.id}`];\n\t\t\tif (this.isSelected)\n\t\t\t{\n\t\t\t\tclasses.push('--selected');\n\t\t\t}\n\n\t\t\tif (!this.mask.active)\n\t\t\t{\n\t\t\t\tclasses.push('--inactive');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t},\n\t\timageStyle(): {backgroundImage: string}\n\t\t{\n\t\t\tlet backgroundImage = '';\n\t\t\tif (this.mask.preview)\n\t\t\t{\n\t\t\t\tbackgroundImage = `url('${this.mask.preview}')`;\n\t\t\t}\n\n\t\t\treturn {backgroundImage};\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div :class=\"containerClasses\" class=\"bx-im-call-background__item --mask\">\n\t\t\t<div v-if=\"!mask.active\" class=\"bx-im-call-background__mask_fade\"></div>\n\t\t\t<div class=\"bx-im-call-background__mask_background\"></div>\n\t\t\t<div :style=\"imageStyle\" class=\"bx-im-call-background__item_image\"></div>\n\t\t\t<div v-if=\"mask.isLoading\" class=\"bx-im-call-background__mask_loading-container\">\n\t\t\t\t<div class=\"bx-im-call-background__mask_loading-icon\"></div>\n\t\t\t\t<div class=\"bx-im-call-background__mask_loading-text\">{{ loc('BX_IM_CALL_BG_MASK_LOADING') }}</div>\n\t\t\t</div>\n\t\t\t<div v-else-if=\"!mask.active\" class=\"bx-im-call-background__mask_soon-container\">\n\t\t\t\t<div class=\"bx-im-call-background__mask_soon-text\">{{ loc('BX_IM_CALL_BG_MASK_COMING_SOON') }}</div>\n\t\t\t</div>\n\t\t\t<div v-else class=\"bx-im-call-background__mask_title\">{{ mask.title }}</div>\n\t\t</div>\n\t`\n};","// @vue/component\nexport const Loader = {\n\tname: 'CallBackgroundLoader',\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\ttemplate:\n\t`\n\t\t<div class=\"bx-im-call-background__loader\">\n\t\t\t<svg class=\"bx-desktop-loader-circular\" viewBox=\"25 25 50 50\">\n\t\t\t\t<circle class=\"bx-desktop-loader-path\" cx=\"50\" cy=\"50\" r=\"20\" fill=\"none\" stroke-miterlimit=\"10\"/>\n\t\t\t</svg>\n\t\t</div>\n\t`\n};","import 'ui.info-helper';\n\nimport {Utils} from 'im.v2.lib.utils';\nimport {DesktopFeature} from 'im.v2.const';\n\nimport {Action} from './items/action';\n\nimport type {LimitRestResult} from '../types/rest';\n\nexport class LimitManager\n{\n\tstatic limitCode = {\n\t\tblur: 'call_blur_background',\n\t\timage: 'call_background'\n\t};\n\n\tlimits: {[limitId: string]: LimitRestResult} = {};\n\n\tconstructor(params: {limits: LimitRestResult[], infoHelperUrlTemplate: string})\n\t{\n\t\tconst {limits, infoHelperUrlTemplate} = params;\n\t\tthis.#initLimits(limits);\n\t\tthis.#initInfoHelper(infoHelperUrlTemplate);\n\t}\n\n\tisLimitedAction(action: Action): boolean\n\t{\n\t\tif (action.isEmpty() || action.isUpload())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn action.isBlur() && this.#limitIsActive(LimitManager.limitCode.blur);\n\t}\n\n\tisLimitedBackground(): boolean\n\t{\n\t\treturn this.#limitIsActive(LimitManager.limitCode.image);\n\t}\n\n\tshowLimitSlider(limitCode: string)\n\t{\n\t\twindow.BX.UI.InfoHelper.show(this.limits[limitCode].articleCode);\n\t}\n\n\t// region Mask feature\n\tstatic isMaskFeatureAvailable(): boolean\n\t{\n\t\tif (!Utils.platform.isBitrixDesktop())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn Utils.platform.isDesktopFeatureEnabled(DesktopFeature.mask.id);\n\t}\n\n\tstatic isMaskFeatureSupportedByDesktopVersion(): boolean\n\t{\n\t\tif (!Utils.platform.isBitrixDesktop())\n\t\t{\n\t\t\treturn true;\n\t\t}\n\n\t\treturn Utils.platform.getDesktopVersion() >= DesktopFeature.mask.availableFromVersion;\n\t}\n\t// endregion Mask feature\n\n\tstatic showHelpArticle(articleCode: string)\n\t{\n\t\twindow.BX.Helper?.show(`redirect=detail&code=${articleCode}`);\n\t}\n\n\t#initLimits(limits: LimitRestResult[])\n\t{\n\t\tlimits.forEach((limit: LimitRestResult) => {\n\t\t\tthis.limits[limit.id] = limit;\n\t\t});\n\t}\n\n\t#initInfoHelper(infoHelperUrlTemplate: string)\n\t{\n\t\tif (window.BX.UI.InfoHelper.isInited())\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\twindow.BX.UI.InfoHelper.init({\n\t\t\tframeUrlTemplate: infoHelperUrlTemplate\n\t\t});\n\t}\n\n\t#limitIsActive(limitCode: string): boolean\n\t{\n\t\tconst limitIsActive = !!this.limits[limitCode]?.active;\n\t\tconst articleIsActive = !!this.limits[limitCode]?.articleCode;\n\n\t\treturn limitIsActive && articleIsActive;\n\t}\n}","export const TabId = {\n\tmask: 'mask',\n\tbackground: 'background'\n};\n\nexport const MASK_HELP_ARTICLE_CODE = 12398124;","import {LimitManager} from '../classes/limit-manager';\nimport {TabId} from '../const';\n\nimport '../css/tab-panel.css';\n\nimport type {Tab} from '../types/tab';\n\n// @vue/component\nexport const TabPanel = {\n\tprops:\n\t{\n\t\tselectedTab: {\n\t\t\ttype: String,\n\t\t\trequired: true\n\t\t}\n\t},\n\temits: ['tabChange'],\n\tdata()\n\t{\n\t\treturn {};\n\t},\n\tcomputed:\n\t{\n\t\ttabs(): Tab[]\n\t\t{\n\t\t\tconst tabs = [];\n\t\t\tif (LimitManager.isMaskFeatureAvailable())\n\t\t\t{\n\t\t\t\ttabs.push({\n\t\t\t\t\tid: TabId.mask,\n\t\t\t\t\tloc: 'BX_IM_CALL_BG_TAB_MASK',\n\t\t\t\t\tisNew: true\n\t\t\t\t});\n\t\t\t}\n\n\t\t\ttabs.push({\n\t\t\t\tid: TabId.background,\n\t\t\t\tloc: 'BX_IM_CALL_BG_TAB_BG',\n\t\t\t\tisNew: false\n\t\t\t});\n\n\t\t\treturn tabs;\n\t\t}\n\t},\n\tmethods:\n\t{\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div class=\"bx-im-call-background__tab-panel\">\n\t\t\t<div\n\t\t\t\tv-for=\"tab in tabs\"\n\t\t\t\t:key=\"tab.id\"\n\t\t\t\t@click=\"$emit('tabChange', tab.id)\"\n\t\t\t\t:class=\"{'--active': selectedTab === tab.id, '--new': tab.isNew}\"\n\t\t\t\tclass=\"bx-im-call-background__tab\"\n\t\t\t>\n\t\t\t\t<div v-if=\"tab.isNew\" class=\"bx-im-call-background__tab_new\">{{ loc('BX_IM_CALL_BG_TAB_NEW') }}</div>\n\t\t\t\t<div class=\"bx-im-call-background__tab_text\">{{ loc(tab.loc) }}</div>\n\t\t\t</div>\n\t\t</div>\n\t`\n};","import {Logger} from 'im.v2.lib.logger';\n\nconst VIDEO_CONSTRAINT_WIDTH = 1280;\nconst VIDEO_CONSTRAINT_HEIGHT = 720;\n\n// @vue/component\nexport const VideoPreview = {\n\tdata()\n\t{\n\t\treturn {\n\t\t\tnoVideo: false\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tvideoClasses()\n\t\t{\n\t\t\treturn {'--flipped': BX.Call.Hardware.enableMirroring};\n\t\t}\n\t},\n\tcreated()\n\t{\n\t\tthis.initHardware().then(() => {\n\t\t\tthis.getDefaultDevices();\n\t\t}).catch(error => {\n\t\t\tconsole.error('VideoPreview: error initing hardware', error);\n\t\t});\n\t},\n\tbeforeUnmount()\n\t{\n\t\tthis.videoStream.getTracks().forEach(tr => tr.stop());\n\t\tthis.videoStream = null;\n\t},\n\tmethods:\n\t{\n\t\tgetDefaultDevices()\n\t\t{\n\t\t\tconst constraints = {audio: false, video: true};\n\t\t\tconstraints.video = {};\n\t\t\tconstraints.video.width = {ideal: VIDEO_CONSTRAINT_WIDTH};\n\t\t\tconstraints.video.height = {ideal: VIDEO_CONSTRAINT_HEIGHT};\n\n\t\t\tif (BX.Call.Hardware.defaultCamera)\n\t\t\t{\n\t\t\t\tthis.selectedCamera = BX.Call.Hardware.defaultCamera;\n\t\t\t\tconstraints.video = {...constraints.video, ...{deviceId: {exact: this.selectedCamera}}};\n\t\t\t}\n\t\t\telse if (Object.keys(BX.Call.Hardware.cameraList).length === 0)\n\t\t\t{\n\t\t\t\tconsole.error('VideoPreview: no camera');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tnavigator.mediaDevices.getUserMedia(constraints).then((stream: MediaStream) => {\n\t\t\t\tthis.videoStream = stream;\n\t\t\t\tif (stream.getVideoTracks().length === 0)\n\t\t\t\t{\n\t\t\t\t\tthis.noVideo = true;\n\t\t\t\t\tconsole.error('VideoPreview: no video tracks');\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tif (!this.selectedCamera)\n\t\t\t\t{\n\t\t\t\t\tthis.selectedCamera = stream.getVideoTracks()[0].getSettings().deviceId;\n\t\t\t\t}\n\t\t\t\tthis.playLocalVideo();\n\t\t\t});\n\t\t},\n\t\tplayLocalVideo()\n\t\t{\n\t\t\tLogger.warn('VideoPreview: playing local video');\n\t\t\tthis.$refs['video'].volume = 0;\n\t\t\tthis.$refs['video'].srcObject = this.videoStream;\n\t\t\tthis.$refs['video'].play();\n\t\t},\n\t\tinitHardware(): Promise\n\t\t{\n\t\t\treturn BX.Call.Hardware.init();\n\t\t},\n\t\tloc(phraseCode: string): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode);\n\t\t}\n\t},\n\ttemplate: `\n\t\t<div class=\"bx-im-call-background__video\">\n\t\t\t<div v-if=\"noVideo\" class=\"bx-im-call-background__no-cam_container\">\n\t\t\t\t<div class=\"bx-im-call-background__no-cam_icon\"></div>\n\t\t\t\t<div class=\"bx-im-call-background__no-cam_title\">{{ loc('BX_IM_CALL_BG_NO_CAM') }}</div>\n\t\t\t</div>\n\t\t\t<video v-else :class=\"videoClasses\" ref=\"video\" muted autoplay playsinline></video>\n\t\t</div>\n\t`\n};","import {rest as RestClient} from 'rest.client';\n\nimport {Logger} from 'im.v2.lib.logger';\nimport {RestMethod} from 'im.v2.const';\n\nimport type {BackgroundListRestResult} from '../types/rest';\n\ntype ElementsListRestResult = {\n\t[RestMethod.imCallBackgroundGet]: RestResult,\n\t[RestMethod.imCallMaskGet]: RestResult\n};\n\nexport class BackgroundService\n{\n\tgetElementsList(): Promise<BackgroundListRestResult>\n\t{\n\t\tconst query = {\n\t\t\t[RestMethod.imCallBackgroundGet]: [RestMethod.imCallBackgroundGet],\n\t\t\t[RestMethod.imCallMaskGet]: [RestMethod.imCallMaskGet]\n\t\t};\n\n\t\treturn new Promise((resolve, reject) => {\n\t\t\tRestClient.callBatch(query, (response: ElementsListRestResult) => {\n\t\t\t\tLogger.warn('BackgroundService: getElementsList result', response);\n\t\t\t\tconst backgroundResult: RestResult = response[RestMethod.imCallBackgroundGet];\n\t\t\t\tconst maskResult: RestResult = response[RestMethod.imCallMaskGet];\n\t\t\t\tif (backgroundResult.error())\n\t\t\t\t{\n\t\t\t\t\tconsole.error('BackgroundService: error getting background list', backgroundResult.error());\n\t\t\t\t\treturn reject('Error getting background list');\n\t\t\t\t}\n\t\t\t\tif (maskResult.error())\n\t\t\t\t{\n\t\t\t\t\tconsole.error('BackgroundService: error getting mask list', maskResult.error());\n\t\t\t\t\treturn reject('Error getting mask list');\n\t\t\t\t}\n\n\t\t\t\treturn resolve({\n\t\t\t\t\tbackgroundResult: backgroundResult.data(),\n\t\t\t\t\tmaskResult: maskResult.data()\n\t\t\t\t});\n\t\t\t});\n\t\t});\n\t}\n\n\tcommitBackground(fileId: string): Promise\n\t{\n\t\treturn RestClient.callMethod(RestMethod.imCallBackgroundCommit, {\n\t\t\tfileId\n\t\t});\n\t}\n\n\tdeleteFile(fileId: string): Promise\n\t{\n\t\treturn RestClient.callMethod(RestMethod.imCallBackgroundDelete, {\n\t\t\tfileId\n\t\t});\n\t}\n}","import {Loc} from 'main.core';\nimport {EventEmitter, BaseEvent} from 'main.core.events';\n\nimport {Logger} from 'im.v2.lib.logger';\nimport {Uploader} from 'im.lib.uploader';\n\nimport 'ui.notification';\n\nconst FILE_MAX_SIZE = 100 * 1024 * 1024;\nconst FILE_MAX_SIZE_PHRASE_NUMBER = 100;\nconst UPLOAD_CHUNK_SIZE = 1024 * 1024;\nconst NOTIFICATION_HIDE_DELAY = 5000;\nconst CUSTOM_BG_TASK_PREFIX = 'custom';\nconst EVENT_NAMESPACE = 'BX.Messenger.v2.CallBackground.UploadManager';\n\nexport class UploadManager extends EventEmitter\n{\n\tstatic allowedFileTypes = [\n\t\t'image/png',\n\t\t'image/jpg',\n\t\t'image/jpeg',\n\t\t'video/avi',\n\t\t'video/mp4',\n\t\t'video/quicktime'\n\t];\n\n\tstatic event = {\n\t\tuploadStart: 'uploadStart',\n\t\tuploadProgress: 'uploadProgress',\n\t\tuploadComplete: 'uploadComplete',\n\t\tuploadError: 'uploadError'\n\t};\n\n\tuploader: Uploader;\n\tdiskFolderId: number;\n\n\tconstructor(params: {inputNode: HTMLElement})\n\t{\n\t\tsuper();\n\t\tthis.setEventNamespace(EVENT_NAMESPACE);\n\n\t\tconst {inputNode} = params;\n\t\tthis.uploader = new Uploader({\n\t\t\tinputNode,\n\t\t\tgeneratePreview: true,\n\t\t\tfileMaxSize: FILE_MAX_SIZE\n\t\t});\n\n\t\tthis.#bindEvents();\n\t}\n\n\tsetDiskFolderId(diskFolderId: number)\n\t{\n\t\tthis.diskFolderId = diskFolderId;\n\t}\n\n\tcancelUpload(fileId: string)\n\t{\n\t\tthis.uploader.deleteTask(fileId);\n\t}\n\n\t// region events\n\t#bindEvents()\n\t{\n\t\tthis.uploader.subscribe('onFileMaxSizeExceeded', this.#onFileMaxSizeExceeded.bind(this));\n\t\tthis.uploader.subscribe('onSelectFile', this.#onSelectFile.bind(this));\n\t\tthis.uploader.subscribe('onStartUpload', this.#onStartUpload.bind(this));\n\t\tthis.uploader.subscribe('onProgress', this.#onProgress.bind(this));\n\t\tthis.uploader.subscribe('onComplete', this.#onComplete.bind(this));\n\t\tthis.uploader.subscribe('onUploadFileError', this.#onUploadError.bind(this));\n\t\tthis.uploader.subscribe('onCreateFileError', this.#onUploadError.bind(this));\n\t}\n\n\t#onFileMaxSizeExceeded(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onFileMaxSizeExceeded', event);\n\t\tconst eventData = event.getData();\n\t\tconst {file} = eventData;\n\n\t\tconst phrase = Loc.getMessage('BX_IM_CALL_BG_FILE_SIZE_EXCEEDED')\n\t\t\t.replace('#LIMIT#', FILE_MAX_SIZE_PHRASE_NUMBER)\n\t\t\t.replace('#FILE_NAME#', file.name);\n\n\t\tthis.#showNotification(phrase);\n\t}\n\n\t#onSelectFile(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onSelectFile', event);\n\t\tconst {file, previewData} = event.getData();\n\n\t\tif (!this.#isAllowedType(file.type) || !previewData)\n\t\t{\n\t\t\tconst phrase = Loc.getMessage('BX_IM_CALL_BG_UNSUPPORTED_FILE')\n\t\t\t\t.replace('#FILE_NAME#', file.name);\n\t\t\tthis.#showNotification(phrase);\n\n\t\t\treturn false;\n\t\t}\n\n\t\tthis.#addUploadTask(file, previewData);\n\t}\n\n\t#onStartUpload(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onStartUpload', event);\n\t\tconst {previewData, id, file} = event.getData();\n\n\t\tconst filePreview = URL.createObjectURL(previewData);\n\t\tthis.emit(UploadManager.event.uploadStart, {\n\t\t\tid,\n\t\t\tfilePreview,\n\t\t\tfile\n\t\t});\n\t}\n\n\t#onProgress(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onProgress', event);\n\t\tconst {id, progress} = event.getData();\n\t\tthis.emit(UploadManager.event.uploadProgress, {\n\t\t\tid,\n\t\t\tprogress\n\t\t});\n\t}\n\n\t#onComplete(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onComplete', event);\n\t\tconst {id, result} = event.getData();\n\t\tthis.emit(UploadManager.event.uploadComplete, {\n\t\t\tid,\n\t\t\tfileResult: result.data.file\n\t\t});\n\t}\n\n\t#onUploadError(event: BaseEvent)\n\t{\n\t\tLogger.warn('UploadManager: onUploadError', event);\n\t\tconst eventData = event.getData();\n\t\tthis.emit(UploadManager.event.uploadError, {\n\t\t\tid: eventData.id\n\t\t});\n\t}\n\t// endregion events\n\n\t#addUploadTask(file: File, previewData)\n\t{\n\t\tthis.uploader.addTask({\n\t\t\ttaskId: `${CUSTOM_BG_TASK_PREFIX}:${Date.now()}`,\n\t\t\tchunkSize: UPLOAD_CHUNK_SIZE,\n\t\t\tfileData: file,\n\t\t\tfileName: file.name,\n\t\t\tdiskFolderId: this.diskFolderId,\n\t\t\tgenerateUniqueName: true,\n\t\t\tpreviewBlob: previewData,\n\t\t});\n\t}\n\n\t#isAllowedType(fileType: string): boolean\n\t{\n\t\treturn UploadManager.allowedFileTypes.includes(fileType);\n\t}\n\n\t#showNotification(text: string)\n\t{\n\t\tBX.UI.Notification.Center.notify({\n\t\t\tcontent: text,\n\t\t\tautoHideDelay: NOTIFICATION_HIDE_DELAY\n\t\t});\n\t}\n}","import {BaseEvent} from 'main.core.events';\n\nimport 'ui.buttons';\nimport 'ui.fonts.opensans';\n\nimport {Utils} from 'im.v2.lib.utils';\nimport {Logger} from 'im.v2.lib.logger';\n\nimport {BackgroundComponent} from './components/background';\nimport {ActionComponent} from './components/action';\nimport {MaskComponent} from './components/mask';\nimport {Loader} from './components/loader';\nimport {TabPanel} from './components/tab-panel';\nimport {VideoPreview} from './components/video-preview';\n\nimport {Action} from './classes/items/action';\nimport {Background} from './classes/items/background';\nimport {Mask} from './classes/items/mask';\nimport {BackgroundService} from './classes/background-service';\nimport {UploadManager} from './classes/upload-manager';\nimport {LimitManager} from './classes/limit-manager';\nimport {TabId, MASK_HELP_ARTICLE_CODE} from './const';\n\nimport './css/call-background.css';\nimport './css/call-background-dark.css';\n\nimport type {ElementListRestResult, BackgroundListRestResult, BackgroundRestResult, MaskListRestResult, MaskRestResult} from './types/rest';\n\n// @vue/component\nexport const CallBackground = {\n\tname: 'CallBackground',\n\tcomponents: {BackgroundComponent, ActionComponent, MaskComponent, Loader, TabPanel, VideoPreview},\n\tprops: {\n\t\ttab: {\n\t\t\ttype: String,\n\t\t\tdefault: TabId.background,\n\t\t}\n\t},\n\tdata()\n\t{\n\t\treturn {\n\t\t\tselectedTab: '',\n\t\t\tselectedBackgroundId: '',\n\t\t\tselectedMaskId: '',\n\t\t\tloadingItems: true,\n\t\t\tactions: [],\n\t\t\tdefaultBackgrounds: [],\n\t\t\tcustomBackgrounds: [],\n\t\t\tmasks: [],\n\t\t\tlistIsScrolled: false\n\t\t};\n\t},\n\tcomputed:\n\t{\n\t\tTabId: () => TabId,\n\t\tbackgrounds(): Background[]\n\t\t{\n\t\t\treturn [...this.customBackgrounds, ...this.defaultBackgrounds];\n\t\t},\n\t\tcontainerClasses(): string[]\n\t\t{\n\t\t\tconst classes = [];\n\n\t\t\tif (this.isDesktop)\n\t\t\t{\n\t\t\t\tclasses.push('--desktop');\n\t\t\t}\n\n\t\t\treturn classes;\n\t\t},\n\t\tuploadTypes(): string\n\t\t{\n\t\t\treturn UploadManager.allowedFileTypes.join(', ');\n\t\t},\n\t\tdescriptionText(): string\n\t\t{\n\t\t\tconst replaces = {\n\t\t\t\t'#HIGHLIGHT_START#': '<span class=\"bx-im-call-background__description_highlight\">',\n\t\t\t\t'#HIGHLIGHT_END#': '</span>',\n\t\t\t\t'#BR#': '</br></br>'\n\t\t\t};\n\t\t\tif (this.selectedTab === TabId.mask)\n\t\t\t{\n\t\t\t\treturn this.loc('BX_IM_CALL_BG_DESCRIPTION_MASK_2', replaces);\n\t\t\t}\n\n\t\t\treturn this.loc('BX_IM_CALL_BG_DESCRIPTION_BG', replaces);\n\t\t},\n\t\tisDesktop()\n\t\t{\n\t\t\treturn Utils.platform.isBitrixDesktop();\n\t\t}\n\t},\n\tcreated()\n\t{\n\t\tthis.initSelectedTab();\n\n\t\tthis.getBackgroundService().getElementsList().then((result: ElementListRestResult) => {\n\t\t\tconst {backgroundResult, maskResult} = result;\n\n\t\t\tthis.initLimitManager(backgroundResult);\n\t\t\tthis.initBackgroundList(backgroundResult);\n\n\t\t\tthis.uploadManager.setDiskFolderId(backgroundResult.upload.folderId);\n\t\t\tconst uploadActionIsAvailable = !!backgroundResult.upload.folderId;\n\t\t\tthis.initActions(uploadActionIsAvailable);\n\n\t\t\tthis.initMasks(maskResult);\n\t\t\tthis.initMaskLoadEventHandler();\n\n\t\t\tthis.initPreviouslySelectedItem();\n\t\t\tthis.loadingItems = false;\n\n\t\t\tthis.hideLoader();\n\t\t}).catch(() => {\n\t\t\tthis.loadingItems = false;\n\t\t});\n\t},\n\tmounted()\n\t{\n\t\tthis.initUploader();\n\t},\n\tmethods:\n\t{\n\t\t// region init\n\t\tinitSelectedTab()\n\t\t{\n\t\t\tif (this.tab === TabId.mask && !LimitManager.isMaskFeatureAvailable())\n\t\t\t{\n\t\t\t\tthis.selectedTab = TabId.background;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (this.tab === TabId.mask && !LimitManager.isMaskFeatureSupportedByDesktopVersion())\n\t\t\t{\n\t\t\t\tthis.selectedTab = TabId.background;\n\t\t\t\tLimitManager.showHelpArticle(MASK_HELP_ARTICLE_CODE);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedTab = this.tab;\n\t\t},\n\t\tinitPreviouslySelectedItem()\n\t\t{\n\t\t\tthis.initPreviouslySelectedMask();\n\t\t\tthis.initPreviouslySelectedBackground();\n\t\t},\n\t\tinitPreviouslySelectedMask()\n\t\t{\n\t\t\tif (this.isDesktop)\n\t\t\t{\n\t\t\t\tconst {id: maskId} = window.BX.desktop.getMask();\n\t\t\t\tlet foundMask = this.masks.find(mask => mask.id === maskId);\n\t\t\t\tif (!foundMask)\n\t\t\t\t{\n\t\t\t\t\tfoundMask = Mask.createEmpty();\n\t\t\t\t}\n\t\t\t\tthis.previouslySelectedMask = foundMask;\n\t\t\t\tLogger.warn('CallBackground: previously selected mask', this.previouslySelectedMask);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.previouslySelectedMask = Mask.createEmpty();\n\t\t\t}\n\n\t\t\tthis.selectedMaskId = this.previouslySelectedMask.id;\n\t\t},\n\t\tinitPreviouslySelectedBackground()\n\t\t{\n\t\t\tif (this.isDesktop)\n\t\t\t{\n\t\t\t\tconst {id: backgroundId} = window.BX.desktop.getBackgroundImage();\n\t\t\t\tconst itemsToSearch = [...this.actions, ...this.backgrounds];\n\t\t\t\tlet foundBackground = itemsToSearch.find(item => item.id === backgroundId);\n\t\t\t\tif (!foundBackground)\n\t\t\t\t{\n\t\t\t\t\tfoundBackground = new Action(Action.type.none);\n\t\t\t\t}\n\t\t\t\tthis.previouslySelectedBackground = foundBackground;\n\t\t\t\tLogger.warn('CallBackground: previously selected background', this.previouslySelectedBackground);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.previouslySelectedBackground = new Action(Action.type.none);\n\t\t\t}\n\n\t\t\tthis.selectedBackgroundId = this.previouslySelectedBackground.id;\n\t\t},\n\t\tinitActions(uploadActionIsAvailable: boolean)\n\t\t{\n\t\t\tthis.actions = [\n\t\t\t\tnew Action(Action.type.none),\n\t\t\t\t...uploadActionIsAvailable ? [new Action(Action.type.upload)]: [],\n\t\t\t\tnew Action(Action.type.gaussianBlur),\n\t\t\t\tnew Action(Action.type.blur),\n\t\t\t];\n\t\t},\n\t\tinitBackgroundList(restResult: BackgroundListRestResult)\n\t\t{\n\t\t\tthis.defaultBackgrounds = [];\n\t\t\trestResult.backgrounds.default.forEach((background: BackgroundRestResult) => {\n\t\t\t\tthis.defaultBackgrounds.push(Background.createDefaultFromRest(background));\n\t\t\t});\n\n\t\t\tthis.customBackgrounds = [];\n\t\t\trestResult.backgrounds.custom.forEach((background: BackgroundRestResult) => {\n\t\t\t\tthis.customBackgrounds.push(Background.createCustomFromRest(background));\n\t\t\t});\n\t\t},\n\t\tinitLimitManager(result: BackgroundListRestResult)\n\t\t{\n\t\t\tconst {limits, infoHelperParams} = result;\n\t\t\tthis.limitManager = new LimitManager({\n\t\t\t\tlimits,\n\t\t\t\tinfoHelperUrlTemplate: infoHelperParams.frameUrlTemplate\n\t\t\t});\n\t\t},\n\t\tinitUploader()\n\t\t{\n\t\t\tthis.uploadManager = new UploadManager({\n\t\t\t\tinputNode: this.$refs['uploadInput']\n\t\t\t});\n\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadStart, (event: BaseEvent) => {\n\t\t\t\tconst backgroundsInstance = Background.createCustomFromUploaderEvent(event.getData());\n\t\t\t\tthis.customBackgrounds.unshift(backgroundsInstance);\n\t\t\t});\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadProgress, (event: BaseEvent) => {\n\t\t\t\tconst {id, progress} = event.getData();\n\t\t\t\tconst background = this.findCustomBackgroundById(id);\n\t\t\t\tif (!background)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbackground.setUploadProgress(progress);\n\t\t\t});\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadComplete, (event: BaseEvent) => {\n\t\t\t\tconst {id, fileResult} = event.getData();\n\t\t\t\tconst background = this.findCustomBackgroundById(id);\n\t\t\t\tif (!background)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbackground.onUploadComplete(fileResult);\n\n\t\t\t\tthis.onBackgroundClick(background);\n\n\t\t\t\tthis.getBackgroundService().commitBackground(background.id);\n\t\t\t});\n\t\t\tthis.uploadManager.subscribe(UploadManager.event.uploadError, (event: BaseEvent) => {\n\t\t\t\tconst {id} = event.getData();\n\t\t\t\tconst background = this.findCustomBackgroundById(id);\n\t\t\t\tif (!background)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t\tbackground.setUploadError();\n\t\t\t});\n\t\t},\n\t\tinitMasks(result: MaskListRestResult)\n\t\t{\n\t\t\tconst {masks} = result;\n\t\t\tthis.masks.push(Mask.createEmpty());\n\t\t\tmasks.forEach((mask: MaskRestResult) => {\n\t\t\t\tthis.masks.push(Mask.createFromRest(mask));\n\t\t\t});\n\t\t},\n\t\tinitMaskLoadEventHandler()\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tthis.maskLoadTimeouts = {};\n\t\t\twindow.BX.desktop.setCallMaskLoadHandlers(this.onMaskLoad.bind(this));\n\t\t},\n\t\t// endregion init\n\t\t// region component events\n\t\tonActionClick(action: Action)\n\t\t{\n\t\t\tif (this.getLimitManager().isLimitedAction(action))\n\t\t\t{\n\t\t\t\tthis.getLimitManager().showLimitSlider(LimitManager.limitCode.blur);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (action.isUpload())\n\t\t\t{\n\t\t\t\tthis.$refs['uploadInput'].click();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedBackgroundId = action.id;\n\n\t\t\tif (action.isEmpty())\n\t\t\t{\n\t\t\t\tthis.removeCallBackground();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedMaskId = '';\n\t\t\tthis.setCallBlur(action);\n\t\t},\n\t\tonBackgroundClick(background: Background)\n\t\t{\n\t\t\tif (this.getLimitManager().isLimitedBackground())\n\t\t\t{\n\t\t\t\tthis.getLimitManager().showLimitSlider(LimitManager.limitCode.image);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (!background.isSupported || background.isLoading)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedBackgroundId = background.id;\n\t\t\tthis.selectedMaskId = '';\n\t\t\tthis.setCallBackground(background);\n\t\t},\n\t\tonBackgroundRemove(background: Background)\n\t\t{\n\t\t\tif (background.id === this.selectedBackgroundId)\n\t\t\t{\n\t\t\t\tthis.selectedBackgroundId = Action.type.none;\n\t\t\t\tthis.removeCallBackground();\n\t\t\t}\n\n\t\t\tif (background.isLoading)\n\t\t\t{\n\t\t\t\tthis.uploadManager.cancelUpload(background.id);\n\t\t\t}\n\t\t\telse\n\t\t\t{\n\t\t\t\tthis.getBackgroundService().deleteFile(background.id);\n\t\t\t}\n\n\t\t\tthis.customBackgrounds = this.customBackgrounds.filter(element => element.id !== background.id);\n\t\t},\n\t\tonMaskClick(mask: Mask)\n\t\t{\n\t\t\tif (!mask.active)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (mask.isEmpty())\n\t\t\t{\n\t\t\t\tthis.selectedMaskId = mask.id;\n\t\t\t\tthis.removeCallMask();\n\t\t\t}\n\n\t\t\tthis.setCallMask(mask);\n\t\t},\n\t\tonSaveButtonClick()\n\t\t{\n\t\t\twindow.close();\n\t\t},\n\t\tonCancelButtonClick()\n\t\t{\n\t\t\tconst backgroundWasChanged = this.previouslySelectedBackground.id !== this.selectedBackgroundId;\n\t\t\tconst maskWasChanged = this.previouslySelectedMask.id !== this.selectedMaskId;\n\t\t\tif (!backgroundWasChanged && !maskWasChanged)\n\t\t\t{\n\t\t\t\twindow.close();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet backgroundPromise = Promise.resolve();\n\t\t\tif (backgroundWasChanged)\n\t\t\t{\n\t\t\t\tbackgroundPromise = this.setCallBackground(this.previouslySelectedBackground);\n\t\t\t}\n\n\t\t\tbackgroundPromise.then(() => {\n\t\t\t\tif (maskWasChanged && !this.previouslySelectedMask.isEmpty())\n\t\t\t\t{\n\t\t\t\t\tthis.setCallMask(this.previouslySelectedMask);\n\t\t\t\t\tthis.isWaitingForMaskToCancel = true;\n\t\t\t\t}\n\t\t\t\telse if (this.previouslySelectedMask.isEmpty())\n\t\t\t\t{\n\t\t\t\t\tthis.removeCallMask();\n\t\t\t\t\twindow.close();\n\t\t\t\t}\n\t\t\t\telse\n\t\t\t\t{\n\t\t\t\t\twindow.close();\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\t\tonListScroll(event: Event)\n\t\t{\n\t\t\tif (event.target.scrollTop === 0)\n\t\t\t{\n\t\t\t\tthis.listIsScrolled = false;\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.listIsScrolled = true;\n\t\t},\n\t\tonTabChange(newTabId: string)\n\t\t{\n\t\t\tif (newTabId === TabId.mask && !LimitManager.isMaskFeatureSupportedByDesktopVersion())\n\t\t\t{\n\t\t\t\tLimitManager.showHelpArticle(MASK_HELP_ARTICLE_CODE);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.selectedTab = newTabId;\n\t\t},\n\t\tonMaskLoad(url: string)\n\t\t{\n\t\t\tLogger.warn('CallBackground: onMaskLoad', url);\n\t\t\tif (this.isWaitingForMaskToCancel)\n\t\t\t{\n\t\t\t\twindow.close();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst masksWithoutEmpty = this.masks.filter((mask: Mask) => !mask.isEmpty());\n\t\t\tconst loadedMask = masksWithoutEmpty.find((mask: Mask) => url.includes(mask.mask));\n\t\t\tLogger.warn('CallBackground: loaded mask', loadedMask);\n\t\t\tif (!loadedMask)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tclearTimeout(this.maskLoadTimeouts[loadedMask.id]);\n\t\t\tloadedMask.isLoading = false;\n\t\t\tif (this.lastRequestedMaskId === loadedMask.id)\n\t\t\t{\n\t\t\t\tthis.selectedMaskId = loadedMask.id;\n\t\t\t}\n\t\t},\n\t\t// endregion component events\n\t\t// region desktop interactions\n\t\tsetCallBackground(backgroundInstance: Background): Promise\n\t\t{\n\t\t\tLogger.warn('CallBackground: set background', backgroundInstance);\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn window.BX.desktop.setCallBackground(backgroundInstance.id, backgroundInstance.background);\n\t\t},\n\t\tsetCallBlur(action: Action): Promise\n\t\t{\n\t\t\tLogger.warn('CallBackground: set blur', action);\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn window.BX.desktop.setCallBackground(action.id, action.background);\n\t\t},\n\t\tremoveCallBackground(): Promise\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\treturn window.BX.desktop.setCallBackground(Action.type.none, Action.type.none);\n\t\t},\n\t\tsetCallMask(mask: Mask)\n\t\t{\n\t\t\tLogger.warn('CallBackground: set mask', mask);\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tif (mask.isEmpty())\n\t\t\t{\n\t\t\t\tLogger.warn('CallBackground: empty mask - removing it');\n\t\t\t\twindow.BX.desktop.setCallMask();\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.lastRequestedMaskId = mask.id;\n\n\t\t\tconst MASK_LOAD_STATUS_DELAY = 500;\n\t\t\tthis.maskLoadTimeouts[mask.id] = setTimeout(() => {\n\t\t\t\tmask.isLoading = true;\n\t\t\t}, MASK_LOAD_STATUS_DELAY);\n\t\t\twindow.BX.desktop.setCallMask(mask.id, mask.mask, mask.background);\n\t\t},\n\t\tremoveCallMask()\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\twindow.BX.desktop.setCallMask();\n\t\t},\n\t\thideLoader()\n\t\t{\n\t\t\tif (!this.isDesktop)\n\t\t\t{\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\twindow.BX.desktop.hideLoader();\n\t\t},\n\t\t// endregion desktop interactions\n\t\tfindCustomBackgroundById(id: string): ?Background\n\t\t{\n\t\t\treturn this.customBackgrounds.find(element => element.id === id);\n\t\t},\n\t\tgetBackgroundService(): BackgroundService\n\t\t{\n\t\t\tif (!this.backgroundService)\n\t\t\t{\n\t\t\t\tthis.backgroundService = new BackgroundService();\n\t\t\t}\n\n\t\t\treturn this.backgroundService;\n\t\t},\n\t\tgetLimitManager(): LimitManager\n\t\t{\n\t\t\treturn this.limitManager;\n\t\t},\n\t\tloc(phraseCode: string, replacements: {[p: string]: string} = {}): string\n\t\t{\n\t\t\treturn this.$Bitrix.Loc.getMessage(phraseCode, replacements);\n\t\t}\n\t},\n\ttemplate:\n\t`\n\t\t<div :class=\"{'--desktop': isDesktop}\" class=\"bx-im-call-background__scope bx-im-call-background__container\">\n\t\t\t<div v-if=\"loadingItems\" class=\"bx-im-call-background__loader_container\">\n\t\t\t\t<Loader />\n\t\t\t</div>\n\t\t\t<div v-else class=\"bx-im-call-background__content\">\n\t\t\t\t<div class=\"bx-im-call-background__left\">\n\t\t\t\t\t<VideoPreview />\n\t\t\t\t\t<div v-html=\"descriptionText\" class=\"bx-im-call-background__description\"></div>\n\t\t\t\t</div>\n\t\t\t\t<div :class=\"{'--scrolled': listIsScrolled}\" class=\"bx-im-call-background__right\">\n\t\t\t\t\t<TabPanel :selectedTab=\"selectedTab\" @tabChange=\"onTabChange\" />\n\t\t\t\t\t<div v-if=\"selectedTab === TabId.background\" @scroll=\"onListScroll\" class=\"bx-im-call-background__list\">\n\t\t\t\t\t\t<ActionComponent\n\t\t\t\t\t\t\tv-for=\"action in actions\"\n\t\t\t\t\t\t\t:element=\"action\"\n\t\t\t\t\t\t\t:key=\"action.id\"\n\t\t\t\t\t\t\t:isSelected=\"selectedBackgroundId === action.id\"\n\t\t\t\t\t\t\t@click=\"onActionClick(action)\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<BackgroundComponent\n\t\t\t\t\t\t\tv-for=\"background in backgrounds\"\n\t\t\t\t\t\t\t:element=\"background\"\n\t\t\t\t\t\t\t:key=\"background.id\"\n\t\t\t\t\t\t\t:isSelected=\"selectedBackgroundId === background.id\"\n\t\t\t\t\t\t\t@click=\"onBackgroundClick(background)\"\n\t\t\t\t\t\t\t@cancel=\"onBackgroundRemove(background)\"\n\t\t\t\t\t\t\t@remove=\"onBackgroundRemove(background)\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div v-else-if=\"selectedTab === TabId.mask\" @scroll=\"onListScroll\" class=\"bx-im-call-background__list\">\n\t\t\t\t\t\t<MaskComponent\n\t\t\t\t\t\t\tv-for=\"mask in masks\"\n\t\t\t\t\t\t\t:element=\"mask\"\n\t\t\t\t\t\t\t:key=\"mask.id\"\n\t\t\t\t\t\t\t:isSelected=\"selectedMaskId === mask.id\"\n\t\t\t\t\t\t\t@click=\"onMaskClick(mask)\"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\t\n\t\t\t</div>\n\t\t\t<div class=\"bx-im-call-background__button-panel\">\n\t\t\t\t<button @click=\"onSaveButtonClick\" :class=\"{'ui-btn-wait ui-btn-disabled': loadingItems}\" class=\"ui-btn ui-btn-success\">\n\t\t\t\t\t{{ loc('BX_IM_CALL_BG_SAVE') }}\n\t\t\t\t</button>\n\t\t\t\t<button @click=\"onCancelButtonClick\" class=\"ui-btn ui-btn-link\">\n\t\t\t\t\t{{ loc('BX_IM_CALL_BG_CANCEL') }}\n\t\t\t\t</button>\n\t\t\t</div>\n\t\t</div>\n\t\t<div class=\"bx-im-call-background__upload-input\">\n\t\t\t<input type=\"file\" :accept=\"uploadTypes\" ref=\"uploadInput\"/>\n\t\t</div>\n\t`\n};"],"names":["Background","params","Object","assign","progress","uploadState","status","FileStatus","error","fileResult","id","isVideo","background","links","download","isLoading","canRemove","restItem","includes","isCustom","isSupported","title","Loc","getMessage","uploaderData","filePreview","file","preview","type","startsWith","upload","size","BackgroundComponent","props","element","required","isSelected","Boolean","emits","data","computed","containerClasses","classes","push","imageStyle","backgroundImage","watch","getProgressBarManager","update","mounted","initProgressBar","beforeUnmount","removeProgressBar","methods","progressBarManager","ProgressBarManager","container","$refs","subscribe","event","cancel","$emit","destroy","progressBar","start","loc","phraseCode","$Bitrix","template","Action","none","gaussianBlur","blur","ActionComponent","action","Mask","active","mask","rawMask","MaskComponent","Loader","name","LimitManager","limits","infoHelperUrlTemplate","isEmpty","isUpload","isBlur","limitCode","image","window","BX","UI","InfoHelper","show","articleCode","Utils","platform","isBitrixDesktop","isDesktopFeatureEnabled","DesktopFeature","getDesktopVersion","availableFromVersion","Helper","forEach","limit","isInited","init","frameUrlTemplate","limitIsActive","articleIsActive","TabId","MASK_HELP_ARTICLE_CODE","TabPanel","selectedTab","String","tabs","isMaskFeatureAvailable","isNew","VIDEO_CONSTRAINT_WIDTH","VIDEO_CONSTRAINT_HEIGHT","VideoPreview","noVideo","videoClasses","Call","Hardware","enableMirroring","created","initHardware","then","getDefaultDevices","console","videoStream","getTracks","tr","stop","constraints","audio","video","width","ideal","height","defaultCamera","selectedCamera","deviceId","exact","keys","cameraList","length","navigator","mediaDevices","getUserMedia","stream","getVideoTracks","getSettings","playLocalVideo","Logger","warn","volume","srcObject","play","BackgroundService","query","RestMethod","imCallBackgroundGet","imCallMaskGet","Promise","resolve","reject","RestClient","callBatch","response","backgroundResult","maskResult","fileId","callMethod","imCallBackgroundCommit","imCallBackgroundDelete","FILE_MAX_SIZE","FILE_MAX_SIZE_PHRASE_NUMBER","UPLOAD_CHUNK_SIZE","NOTIFICATION_HIDE_DELAY","CUSTOM_BG_TASK_PREFIX","EVENT_NAMESPACE","UploadManager","_classPrivateMethodInitSpec","setEventNamespace","inputNode","uploader","Uploader","generatePreview","fileMaxSize","_classPrivateMethodGet","diskFolderId","deleteTask","EventEmitter","bind","eventData","getData","phrase","replace","previewData","URL","createObjectURL","emit","uploadStart","uploadProgress","result","uploadComplete","uploadError","addTask","taskId","Date","now","chunkSize","fileData","fileName","generateUniqueName","previewBlob","fileType","allowedFileTypes","text","Notification","Center","notify","content","autoHideDelay","CallBackground","components","tab","selectedBackgroundId","selectedMaskId","loadingItems","actions","defaultBackgrounds","customBackgrounds","masks","listIsScrolled","backgrounds","isDesktop","uploadTypes","join","descriptionText","replaces","initSelectedTab","getBackgroundService","getElementsList","initLimitManager","initBackgroundList","uploadManager","setDiskFolderId","folderId","uploadActionIsAvailable","initActions","initMasks","initMaskLoadEventHandler","initPreviouslySelectedItem","hideLoader","initUploader","isMaskFeatureSupportedByDesktopVersion","showHelpArticle","initPreviouslySelectedMask","initPreviouslySelectedBackground","desktop","getMask","maskId","foundMask","find","createEmpty","previouslySelectedMask","getBackgroundImage","backgroundId","itemsToSearch","foundBackground","item","previouslySelectedBackground","restResult","createDefaultFromRest","custom","createCustomFromRest","infoHelperParams","limitManager","backgroundsInstance","createCustomFromUploaderEvent","unshift","findCustomBackgroundById","setUploadProgress","onUploadComplete","onBackgroundClick","commitBackground","setUploadError","createFromRest","maskLoadTimeouts","setCallMaskLoadHandlers","onMaskLoad","onActionClick","getLimitManager","isLimitedAction","showLimitSlider","click","removeCallBackground","setCallBlur","isLimitedBackground","setCallBackground","onBackgroundRemove","cancelUpload","deleteFile","filter","onMaskClick","removeCallMask","setCallMask","onSaveButtonClick","close","onCancelButtonClick","backgroundWasChanged","maskWasChanged","backgroundPromise","isWaitingForMaskToCancel","onListScroll","target","scrollTop","onTabChange","newTabId","url","masksWithoutEmpty","loadedMask","clearTimeout","lastRequestedMaskId","backgroundInstance","MASK_LOAD_STATUS_DELAY","setTimeout","backgroundService","replacements"],"mappings":"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"}