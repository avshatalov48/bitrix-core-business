{"version":3,"file":"script.js","sources":["src/index.js"],"sourcesContent":["import {Dom, Event, Loc, Reflection, Tag, Text, Type} from 'main.core';\nimport {BpCondition, Operator} from 'bizproc.condition';\n\nconst namespace = Reflection.namespace('BX.Bizproc.Activity');\n\nclass FieldCondition\n{\n\t#table: HTMLTableElement;\n\t#conditions: Array<{\n\t\toperator: string,\n\t\tfieldId: string,\n\t\tjoiner: number,\n\t\tvalue: any,\n\t}> = [];\n\t#documentField: Object<string, {Name: string, Type: string, BaseType: string}> = {};\n\t#documentType: any;\n\n\t#index: number = 0;\n\t#fieldConditionCountNode: HTMLInputElement;\n\t#useOperatorModified: boolean = false;\n\n\tconstructor(options: {\n\t\ttable: HTMLTableElement,\n\t\tconditions: {\n\t\t\tfield_condition_count: string,\n\t\t},\n\t\tdocumentFields: Object<string, {Name: string, Type: string, BaseType: string}>,\n\t\tdocumentType: any,\n\t\tuseOperatorModified: string,\n\t})\n\t{\n\t\tif (!Type.isPlainObject(options))\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tif (Type.isElementNode(options.table))\n\t\t{\n\t\t\tthis.#table = options.table;\n\t\t}\n\n\t\tif (Type.isPlainObject(options.conditions))\n\t\t{\n\t\t\tconst indexes = String(options.conditions.field_condition_count).split(',').map(Text.toInteger);\n\t\t\tindexes.forEach((index) => {\n\t\t\t\tthis.#conditions.push({\n\t\t\t\t\toperator: options.conditions['field_condition_condition_' + index] || Operator.EQUAL,\n\t\t\t\t\tfieldId: options.conditions['field_condition_field_' + index] || '',\n\t\t\t\t\tjoiner: options.conditions['field_condition_joiner_' + index] || 0,\n\t\t\t\t\tvalue: options.conditions['field_condition_value_' + index] || '',\n\t\t\t\t});\n\t\t\t});\n\t\t}\n\n\t\tif (Type.isPlainObject(options.documentFields))\n\t\t{\n\t\t\tthis.#documentField = options.documentFields;\n\t\t}\n\n\t\tthis.#documentType = options.documentType;\n\t\tthis.#useOperatorModified = (options.useOperatorModified === 'Y');\n\t}\n\n\tinit()\n\t{\n\t\tconst wrapper = Tag.render`<tbody></tbody>`;\n\t\tthis.#conditions.forEach((condition) => this.#renderConditionTo(condition, wrapper));\n\n\t\tDom.append(this.#renderAddButton(), wrapper);\n\n\t\tDom.append(wrapper, this.#table);\n\t}\n\n\t#renderConditionTo(condition: {operator?: string, fieldId?: string, joiner?: number, value?: any}, wrapper)\n\t{\n\t\tconst bpCondition = new BpCondition({\n\t\t\toperator: condition.operator || Operator.EQUAL,\n\t\t\tvalue: condition.value || '',\n\t\t\tselectName: 'field_condition_condition_' + String(this.#index),\n\t\t\tinputName: 'field_condition_value_' + String(this.#index),\n\t\t\tdocumentType: this.#documentType,\n\t\t\tuseOperatorModified: this.#useOperatorModified,\n\t\t});\n\n\t\tif (this.#index !== 0)\n\t\t{\n\t\t\tDom.append(this.#renderJoinerAndDeleteButton(Text.toInteger(condition.joiner || 0), bpCondition), wrapper);\n\t\t}\n\n\t\tconst fieldNode = this.#renderField(condition.fieldId || '', this.#index, bpCondition);\n\t\tDom.append(fieldNode, wrapper);\n\n\t\tconst field =\n\t\t\tthis.#documentField[condition.fieldId || '']\n\t\t\t?? this.#documentField[fieldNode.getElementsByTagName('SELECT')[0].options[0].value]\n\t\t;\n\n\t\tbpCondition.renderOperatorTo(field.BaseType, wrapper);\n\t\tbpCondition.renderValueTo(field, wrapper);\n\n\t\tthis.#index++;\n\t}\n\n\t#renderField(fieldId: string = '', index: string, condition: BpCondition): HTMLElement\n\t{\n\t\tconst select: HTMLSelectElement = Tag.render`\n\t\t\t<select name=\"field_condition_field_${String(index)}\"></select>\n\t\t`;\n\n\t\tObject.keys(this.#documentField).forEach((key) => {\n\t\t\tDom.append(\n\t\t\t\tTag.render`\n\t\t\t\t\t<option value=\"${Text.encode(key)}\"${fieldId === key ? ' selected' : ''}>\n\t\t\t\t\t\t${Text.encode(this.#documentField[key].Name)}\n\t\t\t\t\t</option>\n\t\t\t\t`,\n\t\t\t\tselect\n\t\t\t);\n\t\t});\n\t\tEvent.bind(select, 'change', this.#onFieldChange.bind(this, condition));\n\n\t\treturn Tag.render`\n\t\t\t<tr>\n\t\t\t\t<td align=\"right\" width=\"40%\" class=\"adm-detail-content-cell-l\">\n\t\t\t\t\t${Loc.getMessage('BPFC_PD_FIELD') + ':'}\n\t\t\t\t</td>\n\t\t\t\t<td width=\"60%\" class=\"adm-detail-content-cell-r\">\n\t\t\t\t\t${select}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`;\n\t}\n\n\t#onFieldChange(condition: BpCondition, event)\n\t{\n\t\tconst select: HTMLSelectElement = event.target;\n\t\tconst fieldId = select.selectedOptions[0].value;\n\n\t\tlet field = this.#documentField[fieldId];\n\t\tif (!field)\n\t\t{\n\t\t\tselect.selectedIndex = 0;\n\t\t\tfield = this.#documentField[select.selectedOptions[0]];\n\t\t}\n\t\tcondition.rerenderOperator(field.BaseType ?? 'string');\n\t\tcondition.rerenderValue(field ?? {Type: 'string'});\n\t}\n\n\t#renderJoinerAndDeleteButton(joiner: number, condition: BpCondition): HTMLElement\n\t{\n\t\tconst index = this.#index;\n\t\tconst deleteButton = Tag.render`<a href=\"#\">${Loc.getMessage('BPFC_PD_DELETE')}</a>`;\n\t\tEvent.bindOnce(deleteButton, 'click', this.#onDeleteClick.bind(this, condition, index));\n\n\t\treturn Tag.render`\n\t\t\t<tr>\n\t\t\t\t<td align=\"right\" width=\"40%\" class=\"adm-detail-content-cell-l\">\n\t\t\t\t\t<select name=\"${'field_condition_joiner_' + String(this.#index)}\">\n\t\t\t\t\t\t<option value=\"0\">${Loc.getMessage('BPFC_PD_AND')}</option>\n\t\t\t\t\t\t<option value=\"1\"${joiner === 1 ? ' selected' : ''}>${Loc.getMessage('BPFC_PD_OR')}</option>\n\t\t\t\t\t</select>\n\t\t\t\t</td>\n\t\t\t\t<td align=\"right\" width=\"60%\" class=\"adm-detail-content-cell-r\">\n\t\t\t\t\t${deleteButton}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`;\n\t}\n\n\t#onDeleteClick(condition: BpCondition, index: number, event)\n\t{\n\t\tevent.preventDefault();\n\n\t\tconst eventTarget: HTMLElement = event.target;\n\t\tconst wrapper = eventTarget.closest('tbody');\n\n\t\tconst td = eventTarget.parentElement;\n\t\tconst tr: HTMLTableRowElement = td.parentElement;\n\n\t\tconst rowIndex = tr.rowIndex;\n\t\twrapper.deleteRow(rowIndex + 1); // field\n\t\twrapper.deleteRow(rowIndex); // joiner\n\t\tcondition.destroy();\n\n\t\tconst currentIndexes = this.#fieldConditionCountNode.value.split(',');\n\t\tconst deletedIndex = currentIndexes.indexOf(String(index));\n\t\tif (deletedIndex !== -1)\n\t\t{\n\t\t\tcurrentIndexes.splice(deletedIndex, 1);\n\t\t}\n\t\tthis.#fieldConditionCountNode.value = currentIndexes.join(',');\n\t}\n\n\t#renderAddButton(): HTMLElement\n\t{\n\t\tthis.#fieldConditionCountNode = Tag.render`\n\t\t\t<input \n\t\t\t\ttype=\"hidden\"\n\t\t\t\tname=\"field_condition_count\"\n\t\t\t\tvalue=\"${[...Array(this.#index)].map((value, index) => index).join(',')}\"\n\t\t\t>\n\t\t`;\n\n\t\tconst addButton = Tag.render`<a href=\"#\">${Loc.getMessage('BPFC_PD_ADD')}</a>`;\n\t\tEvent.bind(addButton, 'click', this.#onAddClick.bind(this));\n\n\t\treturn Tag.render`\n\t\t\t<tr>\n\t\t\t\t<td class=\"adm-detail-content-cell-l\"></td>\n\t\t\t\t<td class=\"adm-detail-content-cell-r\">\n\t\t\t\t\t${this.#fieldConditionCountNode}\n\t\t\t\t\t${addButton}\n\t\t\t\t</td>\n\t\t\t</tr>\n\t\t`;\n\t}\n\n\t#onAddClick(event)\n\t{\n\t\tevent.preventDefault();\n\n\t\tconst eventTarget: HTMLElement = event.target;\n\t\tconst wrapper = eventTarget.closest('tbody');\n\n\t\tconst addRow = eventTarget.closest('tr');\n\t\tDom.remove(addRow);\n\n\t\tthis.#fieldConditionCountNode.value += ',' + String(this.#index);\n\t\tthis.#renderConditionTo({}, wrapper);\n\n\t\tDom.append(addRow, wrapper);\n\t}\n}\n\nnamespace.FieldCondition = FieldCondition;"],"names":["namespace","Reflection","FieldCondition","options","Type","isPlainObject","isElementNode","table","conditions","indexes","String","field_condition_count","split","map","Text","toInteger","forEach","index","push","operator","Operator","EQUAL","fieldId","joiner","value","documentFields","documentType","useOperatorModified","wrapper","Tag","render","condition","Dom","append","bpCondition","BpCondition","selectName","inputName","fieldNode","field","getElementsByTagName","renderOperatorTo","BaseType","renderValueTo","select","Object","keys","key","encode","Name","Event","bind","Loc","getMessage","event","target","selectedOptions","selectedIndex","rerenderOperator","rerenderValue","deleteButton","bindOnce","preventDefault","eventTarget","closest","td","parentElement","tr","rowIndex","deleteRow","destroy","currentIndexes","deletedIndex","indexOf","splice","join","Array","addButton","addRow","remove"],"mappings":"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"}