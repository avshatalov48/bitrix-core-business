{"version":3,"file":"script.js","sources":["script.es6.js"],"sourcesContent":["import { ajax, Reflection, Runtime, Text, Type } from 'main.core';\nimport { type BaseEvent, EventEmitter } from 'main.core.events';\n\nclass ImageInput\n{\n\tonUploaderIsInitedHandler = this.handleOnUploaderIsInited.bind(this);\n\n\tvalues = new Map();\n\tnewValues = new Map();\n\n\tstatic imageInputInstances = new Map();\n\n\tstatic PROCESS_STATUS = 'PROCESS';\n\tstatic WAIT_STATUS = 'WAIT';\n\n\tstatic getById(id: string): ?ImageInput\n\t{\n\t\treturn ImageInput.imageInputInstances.get(id) || null;\n\t}\n\n\tconstructor(id, options = {})\n\t{\n\t\tthis.id = id;\n\t\tthis.wrapper = BX(id);\n\t\tif (!this.wrapper)\n\t\t{\n\t\t\treturn;\n\t\t}\n\t\tthis.productId = options.productId;\n\t\tthis.skuId = options.skuId;\n\t\tthis.iblockId = options.iblockId;\n\t\tthis.saveable = options.saveable;\n\t\tthis.inputId = options.inputId;\n\t\tthis.ajaxStatus = ImageInput.WAIT_STATUS;\n\t\tif (options.hideAddButton === true)\n\t\t{\n\t\t\tconst addButton = this.wrapper.querySelector('[data-role=\"image-add-button\"]');\n\t\t\tif (Type.isDomNode(addButton))\n\t\t\t{\n\t\t\t\taddButton.style.display = 'none';\n\t\t\t}\n\t\t}\n\n\t\tif (Type.isObject(options.values))\n\t\t{\n\t\t\tfor (const key in options.values)\n\t\t\t{\n\t\t\t\tif (!options.values.hasOwnProperty(key))\n\t\t\t\t{\n\t\t\t\t\tcontinue;\n\t\t\t\t}\n\n\t\t\t\tthis.values.set(key, options.values[key]);\n\t\t\t}\n\t\t}\n\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.subscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\n\t\tImageInput.imageInputInstances.set(this.id, this);\n\t}\n\n\tisSaveable()\n\t{\n\t\treturn (this.saveable === true);\n\t}\n\n\thandleOnUploaderIsInited(event)\n\t{\n\t\tconst [id, uploader] = event.getCompatData();\n\t\tif (Type.isStringFilled(this.inputId) && this.inputId === id)\n\t\t{\n\t\t\tthis.uploaderFieldMap = new Map();\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsDeleted', this.onFileDelete.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onFileIsUploaded', this.onFileUpload.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onDone', this.onDone.bind(this));\n\t\t\tEventEmitter.subscribe(uploader, 'onQueueIsChanged', this.onQueueIsChanged.bind(this));\n\t\t}\n\t}\n\n\tunsubscribeEvents()\n\t{\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tEventEmitter.unsubscribe('onUploaderIsInited', this.onUploaderIsInitedHandler);\n\t\t}\n\t}\n\n\tunsubscribeImageInputEvents()\n\t{\n\t\tif (Reflection.getClass('BX.UI.ImageInput'))\n\t\t{\n\t\t\tconst imageInput = BX.UI.ImageInput.getById(this.inputId);\n\t\t\tif (imageInput)\n\t\t\t{\n\t\t\t\timageInput.unsubscribeEvents();\n\t\t\t}\n\t\t}\n\t}\n\n\tgetId()\n\t{\n\t\treturn this.id;\n\t}\n\n\tsetId(id)\n\t{\n\t\tthis.id = id;\n\t}\n\n\tonFileDelete(event: BaseEvent)\n\t{\n\t\tconst [, , , file] = event.getCompatData();\n\t\tconst inputName = file.input_name;\n\n\t\tif (Type.isNil(inputName))\n\t\t{\n\t\t\treturn null;\n\t\t}\n\n\t\tthis.values.delete(inputName);\n\t\tif (this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\t}\n\n\tonQueueIsChanged(event: BaseEvent)\n\t{\n\t\tconst [, type, itemId, uploaderItem] = event.getCompatData();\n\t\tconst image = uploaderItem.file;\n\n\t\tif (\n\t\t\ttype === 'add'\n\t\t\t&& 'input_name' in image\n\t\t\t&& Type.isNil(this.uploaderFieldMap.get(itemId))\n\t\t)\n\t\t{\n\t\t\tthis.uploaderFieldMap.set(itemId, image['input_name']);\n\t\t}\n\t}\n\n\tonDone()\n\t{\n\t\tif (this.newValues.size > 0 && this.isSaveable())\n\t\t{\n\t\t\tthis.save();\n\t\t}\n\n\t\tthis.newValues.clear();\n\t}\n\n\tonFileUpload(event: BaseEvent)\n\t{\n\t\tconst [itemId, , params] = event.getCompatData();\n\n\t\tif (\n\t\t\t!this.isSaveable()\n\t\t\t|| !Type.isObject(params)\n\t\t\t|| !('file' in params)\n\t\t\t|| !('files' in params.file)\n\t\t\t|| !('default' in params.file.files)\n\t\t)\n\t\t{\n\t\t\treturn;\n\t\t}\n\n\t\tthis.#sendEvent({\n\t\t\ttool: 'catalog',\n\t\t\tcategory: 'product_selector',\n\t\t\tevent: 'image_upload',\n\t\t});\n\n\t\tconst currentUploadedFile = params['file']['files']['default'];\n\t\tconst photoItem = {\n\t\t\tfileId: itemId,\n\t\t\tdata: {\n\t\t\t\tname: currentUploadedFile.name,\n\t\t\t\ttype: currentUploadedFile.type,\n\t\t\t\ttmp_name: currentUploadedFile.path,\n\t\t\t\tsize: currentUploadedFile.size,\n\t\t\t\terror: null\n\t\t\t}\n\t\t};\n\t\tconst fileFieldName = this.uploaderFieldMap.get(itemId) || itemId;\n\t\tthis.values.set(fileFieldName, photoItem);\n\t\tthis.newValues.set(fileFieldName, photoItem);\n\t}\n\n\tsave()\n\t{\n\t\tif (this.submitFileTimeOut)\n\t\t{\n\t\t\tclearTimeout(this.submitFileTimeOut);\n\t\t}\n\n\t\tconst requestId = Text.getRandom(20);\n\t\tthis.refreshImageSelectorId = requestId;\n\t\tthis.submitFileTimeOut = setTimeout(() => {\n\t\t\tconst values = {};\n\t\t\tthis.values.forEach((file, id) => {\n\t\t\t\tvalues[id] = file;\n\t\t\t});\n\n\t\t\tajax.runAction(\n\t\t\t\t'catalog.productSelector.saveMorePhoto',\n\t\t\t\t{\n\t\t\t\t\tjson: {\n\t\t\t\t\t\tproductId: this.productId,\n\t\t\t\t\t\tvariationId: this.skuId,\n\t\t\t\t\t\tiblockId: this.iblockId,\n\t\t\t\t\t\timageValues: values,\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t).then((response) => {\n\t\t\t\tif (!this.refreshImageSelectorId === requestId)\n\t\t\t\t{\n\t\t\t\t\treturn;\n\t\t\t\t}\n\n\t\t\t\tthis.values.clear();\n\t\t\t\tif (Type.isObject(response.data?.values))\n\t\t\t\t{\n\t\t\t\t\tfor (const key in response.data.values)\n\t\t\t\t\t{\n\t\t\t\t\t\tif (!response.data.values.hasOwnProperty(key))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tcontinue;\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\tthis.values.set(key, response.data.values[key]);\n\t\t\t\t\t}\n\t\t\t\t}\n\n\t\t\t\tRuntime.html(this.wrapper, response.data.input);\n\t\t\t\tEventEmitter.emit( 'Catalog.ImageInput::save', [\n\t\t\t\t\tthis.id,\n\t\t\t\t\tthis.inputId,\n\t\t\t\t\tresponse,\n\t\t\t\t]);\n\t\t\t});\n\t\t}, 500);\n\t}\n\n\t#sendEvent(data: Object): void\n\t{\n\t\tRuntime.loadExtension('ui.analytics')\n\t\t\t.then((exports) => {\n\t\t\t\tconst { sendData } = exports;\n\n\t\t\t\tsendData(data);\n\t\t\t}).catch(() => {\n\t\t\t\tconsole.error(\"catalog.image.input: can't load ui.analytics\");\n\t\t\t});\n\t}\n}\n\nReflection.namespace('BX.Catalog').ImageInput = ImageInput;\n"],"names":["ImageInput","id","imageInputInstances","get","options","handleOnUploaderIsInited","bind","Map","wrapper","BX","productId","skuId","iblockId","saveable","inputId","ajaxStatus","WAIT_STATUS","hideAddButton","addButton","querySelector","Type","isDomNode","style","display","isObject","values","key","hasOwnProperty","set","isSaveable","EventEmitter","subscribe","onUploaderIsInitedHandler","event","getCompatData","uploader","isStringFilled","uploaderFieldMap","onFileDelete","onFileUpload","onDone","onQueueIsChanged","unsubscribe","Reflection","getClass","imageInput","UI","getById","unsubscribeEvents","file","inputName","input_name","isNil","save","type","itemId","uploaderItem","image","newValues","size","clear","params","files","tool","category","currentUploadedFile","photoItem","fileId","data","name","tmp_name","path","error","fileFieldName","submitFileTimeOut","clearTimeout","requestId","Text","getRandom","refreshImageSelectorId","setTimeout","forEach","ajax","runAction","json","variationId","imageValues","then","response","Runtime","html","input","emit","loadExtension","exports","sendData","console","namespace"],"mappings":";;;;;;;AAAA,CACgE;CAAA,IAE1DA,UAAU;GAAA;KAAA;KAAA,wBAYAC,EAAU,EACzB;OACC,OAAOD,UAAU,CAACE,mBAAmB,CAACC,GAAG,CAACF,EAAE,CAAC,IAAI,IAAI;;;GAGtD,oBAAYA,EAAE,EACd;KAAA,IADgBG,OAAO,uEAAG,EAAE;KAAA;KAAA;KAAA,+DAfA,IAAI,CAACC,wBAAwB,CAACC,IAAI,CAAC,IAAI,CAAC;KAAA,4CAE3D,IAAIC,GAAG,EAAE;KAAA,+CACN,IAAIA,GAAG,EAAE;KAcpB,IAAI,CAACN,EAAE,GAAGA,EAAE;KACZ,IAAI,CAACO,OAAO,GAAGC,EAAE,CAACR,EAAE,CAAC;KACrB,IAAI,CAAC,IAAI,CAACO,OAAO,EACjB;OACC;;KAED,IAAI,CAACE,SAAS,GAAGN,OAAO,CAACM,SAAS;KAClC,IAAI,CAACC,KAAK,GAAGP,OAAO,CAACO,KAAK;KAC1B,IAAI,CAACC,QAAQ,GAAGR,OAAO,CAACQ,QAAQ;KAChC,IAAI,CAACC,QAAQ,GAAGT,OAAO,CAACS,QAAQ;KAChC,IAAI,CAACC,OAAO,GAAGV,OAAO,CAACU,OAAO;KAC9B,IAAI,CAACC,UAAU,GAAGf,UAAU,CAACgB,WAAW;KACxC,IAAIZ,OAAO,CAACa,aAAa,KAAK,IAAI,EAClC;OACC,IAAMC,SAAS,GAAG,IAAI,CAACV,OAAO,CAACW,aAAa,CAAC,gCAAgC,CAAC;OAC9E,IAAIC,cAAI,CAACC,SAAS,CAACH,SAAS,CAAC,EAC7B;SACCA,SAAS,CAACI,KAAK,CAACC,OAAO,GAAG,MAAM;;;KAIlC,IAAIH,cAAI,CAACI,QAAQ,CAACpB,OAAO,CAACqB,MAAM,CAAC,EACjC;OACC,KAAK,IAAMC,GAAG,IAAItB,OAAO,CAACqB,MAAM,EAChC;SACC,IAAI,CAACrB,OAAO,CAACqB,MAAM,CAACE,cAAc,CAACD,GAAG,CAAC,EACvC;WACC;;SAGD,IAAI,CAACD,MAAM,CAACG,GAAG,CAACF,GAAG,EAAEtB,OAAO,CAACqB,MAAM,CAACC,GAAG,CAAC,CAAC;;;KAI3C,IAAI,IAAI,CAACG,UAAU,EAAE,EACrB;OACCC,6BAAY,CAACC,SAAS,CAAC,oBAAoB,EAAE,IAAI,CAACC,yBAAyB,CAAC;;KAG7EhC,UAAU,CAACE,mBAAmB,CAAC0B,GAAG,CAAC,IAAI,CAAC3B,EAAE,EAAE,IAAI,CAAC;;GACjD;KAAA;KAAA,6BAGD;OACC,OAAQ,IAAI,CAACY,QAAQ,KAAK,IAAI;;;KAC9B;KAAA,yCAEwBoB,KAAK,EAC9B;OACC,2BAAuBA,KAAK,CAACC,aAAa,EAAE;SAAA;SAArCjC,EAAE;SAAEkC,QAAQ;OACnB,IAAIf,cAAI,CAACgB,cAAc,CAAC,IAAI,CAACtB,OAAO,CAAC,IAAI,IAAI,CAACA,OAAO,KAAKb,EAAE,EAC5D;SACC,IAAI,CAACoC,gBAAgB,GAAG,IAAI9B,GAAG,EAAE;SACjCuB,6BAAY,CAACC,SAAS,CAACI,QAAQ,EAAE,iBAAiB,EAAE,IAAI,CAACG,YAAY,CAAChC,IAAI,CAAC,IAAI,CAAC,CAAC;SACjFwB,6BAAY,CAACC,SAAS,CAACI,QAAQ,EAAE,kBAAkB,EAAE,IAAI,CAACI,YAAY,CAACjC,IAAI,CAAC,IAAI,CAAC,CAAC;SAClFwB,6BAAY,CAACC,SAAS,CAACI,QAAQ,EAAE,QAAQ,EAAE,IAAI,CAACK,MAAM,CAAClC,IAAI,CAAC,IAAI,CAAC,CAAC;SAClEwB,6BAAY,CAACC,SAAS,CAACI,QAAQ,EAAE,kBAAkB,EAAE,IAAI,CAACM,gBAAgB,CAACnC,IAAI,CAAC,IAAI,CAAC,CAAC;;;;KAEvF;KAAA,oCAGD;OACC,IAAI,IAAI,CAACuB,UAAU,EAAE,EACrB;SACCC,6BAAY,CAACY,WAAW,CAAC,oBAAoB,EAAE,IAAI,CAACV,yBAAyB,CAAC;;;;KAE/E;KAAA,8CAGD;OACC,IAAIW,oBAAU,CAACC,QAAQ,CAAC,kBAAkB,CAAC,EAC3C;SACC,IAAMC,UAAU,GAAGpC,EAAE,CAACqC,EAAE,CAAC9C,UAAU,CAAC+C,OAAO,CAAC,IAAI,CAACjC,OAAO,CAAC;SACzD,IAAI+B,UAAU,EACd;WACCA,UAAU,CAACG,iBAAiB,EAAE;;;;;KAGhC;KAAA,wBAGD;OACC,OAAO,IAAI,CAAC/C,EAAE;;;KACd;KAAA,sBAEKA,EAAE,EACR;OACC,IAAI,CAACA,EAAE,GAAGA,EAAE;;;KACZ;KAAA,6BAEYgC,KAAgB,EAC7B;OACC,4BAAqBA,KAAK,CAACC,aAAa,EAAE;SAAA;SAA7Be,IAAI;OACjB,IAAMC,SAAS,GAAGD,IAAI,CAACE,UAAU;OAEjC,IAAI/B,cAAI,CAACgC,KAAK,CAACF,SAAS,CAAC,EACzB;SACC,OAAO,IAAI;;OAGZ,IAAI,CAACzB,MAAM,UAAO,CAACyB,SAAS,CAAC;OAC7B,IAAI,IAAI,CAACrB,UAAU,EAAE,EACrB;SACC,IAAI,CAACwB,IAAI,EAAE;;;;KAEZ;KAAA,iCAEgBpB,KAAgB,EACjC;OACC,4BAAuCA,KAAK,CAACC,aAAa,EAAE;SAAA;SAAnDoB,IAAI;SAAEC,MAAM;SAAEC,YAAY;OACnC,IAAMC,KAAK,GAAGD,YAAY,CAACP,IAAI;OAE/B,IACCK,IAAI,KAAK,KAAK,IACX,YAAY,IAAIG,KAAK,IACrBrC,cAAI,CAACgC,KAAK,CAAC,IAAI,CAACf,gBAAgB,CAAClC,GAAG,CAACoD,MAAM,CAAC,CAAC,EAEjD;SACC,IAAI,CAAClB,gBAAgB,CAACT,GAAG,CAAC2B,MAAM,EAAEE,KAAK,CAAC,YAAY,CAAC,CAAC;;;;KAEvD;KAAA,yBAGD;OACC,IAAI,IAAI,CAACC,SAAS,CAACC,IAAI,GAAG,CAAC,IAAI,IAAI,CAAC9B,UAAU,EAAE,EAChD;SACC,IAAI,CAACwB,IAAI,EAAE;;OAGZ,IAAI,CAACK,SAAS,CAACE,KAAK,EAAE;;;KACtB;KAAA,6BAEY3B,KAAgB,EAC7B;OACC,4BAA2BA,KAAK,CAACC,aAAa,EAAE;SAAA;SAAzCqB,MAAM;SAAIM,MAAM;OAEvB,IACC,CAAC,IAAI,CAAChC,UAAU,EAAE,IACf,CAACT,cAAI,CAACI,QAAQ,CAACqC,MAAM,CAAC,IACtB,EAAE,MAAM,IAAIA,MAAM,CAAC,IACnB,EAAE,OAAO,IAAIA,MAAM,CAACZ,IAAI,CAAC,IACzB,EAAE,SAAS,IAAIY,MAAM,CAACZ,IAAI,CAACa,KAAK,CAAC,EAErC;SACC;;OAGD,2BAAI,gCAAJ,IAAI,EAAY;SACfC,IAAI,EAAE,SAAS;SACfC,QAAQ,EAAE,kBAAkB;SAC5B/B,KAAK,EAAE;QACP;OAED,IAAMgC,mBAAmB,GAAGJ,MAAM,CAAC,MAAM,CAAC,CAAC,OAAO,CAAC,CAAC,SAAS,CAAC;OAC9D,IAAMK,SAAS,GAAG;SACjBC,MAAM,EAAEZ,MAAM;SACda,IAAI,EAAE;WACLC,IAAI,EAAEJ,mBAAmB,CAACI,IAAI;WAC9Bf,IAAI,EAAEW,mBAAmB,CAACX,IAAI;WAC9BgB,QAAQ,EAAEL,mBAAmB,CAACM,IAAI;WAClCZ,IAAI,EAAEM,mBAAmB,CAACN,IAAI;WAC9Ba,KAAK,EAAE;;QAER;OACD,IAAMC,aAAa,GAAG,IAAI,CAACpC,gBAAgB,CAAClC,GAAG,CAACoD,MAAM,CAAC,IAAIA,MAAM;OACjE,IAAI,CAAC9B,MAAM,CAACG,GAAG,CAAC6C,aAAa,EAAEP,SAAS,CAAC;OACzC,IAAI,CAACR,SAAS,CAAC9B,GAAG,CAAC6C,aAAa,EAAEP,SAAS,CAAC;;;KAC5C;KAAA,uBAGD;OAAA;OACC,IAAI,IAAI,CAACQ,iBAAiB,EAC1B;SACCC,YAAY,CAAC,IAAI,CAACD,iBAAiB,CAAC;;OAGrC,IAAME,SAAS,GAAGC,cAAI,CAACC,SAAS,CAAC,EAAE,CAAC;OACpC,IAAI,CAACC,sBAAsB,GAAGH,SAAS;OACvC,IAAI,CAACF,iBAAiB,GAAGM,UAAU,CAAC,YAAM;SACzC,IAAMvD,MAAM,GAAG,EAAE;SACjB,KAAI,CAACA,MAAM,CAACwD,OAAO,CAAC,UAAChC,IAAI,EAAEhD,EAAE,EAAK;WACjCwB,MAAM,CAACxB,EAAE,CAAC,GAAGgD,IAAI;UACjB,CAAC;SAEFiC,cAAI,CAACC,SAAS,CACb,uCAAuC,EACvC;WACCC,IAAI,EAAE;aACL1E,SAAS,EAAE,KAAI,CAACA,SAAS;aACzB2E,WAAW,EAAE,KAAI,CAAC1E,KAAK;aACvBC,QAAQ,EAAE,KAAI,CAACA,QAAQ;aACvB0E,WAAW,EAAE7D;;UAEd,CACD,CAAC8D,IAAI,CAAC,UAACC,QAAQ,EAAK;WAAA;WACpB,IAAI,CAAC,KAAI,CAACT,sBAAsB,KAAKH,SAAS,EAC9C;aACC;;WAGD,KAAI,CAACnD,MAAM,CAACmC,KAAK,EAAE;WACnB,IAAIxC,cAAI,CAACI,QAAQ,mBAACgE,QAAQ,CAACpB,IAAI,mDAAb,eAAe3C,MAAM,CAAC,EACxC;aACC,KAAK,IAAMC,GAAG,IAAI8D,QAAQ,CAACpB,IAAI,CAAC3C,MAAM,EACtC;eACC,IAAI,CAAC+D,QAAQ,CAACpB,IAAI,CAAC3C,MAAM,CAACE,cAAc,CAACD,GAAG,CAAC,EAC7C;iBACC;;eAGD,KAAI,CAACD,MAAM,CAACG,GAAG,CAACF,GAAG,EAAE8D,QAAQ,CAACpB,IAAI,CAAC3C,MAAM,CAACC,GAAG,CAAC,CAAC;;;WAIjD+D,iBAAO,CAACC,IAAI,CAAC,KAAI,CAAClF,OAAO,EAAEgF,QAAQ,CAACpB,IAAI,CAACuB,KAAK,CAAC;WAC/C7D,6BAAY,CAAC8D,IAAI,CAAE,0BAA0B,EAAE,CAC9C,KAAI,CAAC3F,EAAE,EACP,KAAI,CAACa,OAAO,EACZ0E,QAAQ,CACR,CAAC;UACF,CAAC;QACF,EAAE,GAAG,CAAC;;;GACP;CAAA;CAAA,qBAEUpB,IAAY,EACvB;GACCqB,iBAAO,CAACI,aAAa,CAAC,cAAc,CAAC,CACnCN,IAAI,CAAC,UAACO,OAAO,EAAK;KAClB,IAAQC,QAAQ,GAAKD,OAAO,CAApBC,QAAQ;KAEhBA,QAAQ,CAAC3B,IAAI,CAAC;IACd,CAAC,SAAM,CAAC,YAAM;KACd4B,OAAO,CAACxB,KAAK,CAAC,8CAA8C,CAAC;IAC7D,CAAC;CACJ;CAAC,4BA7PIxE,UAAU,yBAOc,IAAIO,GAAG,EAAE;CAAA,4BAPjCP,UAAU,oBASS,SAAS;CAAA,4BAT5BA,UAAU,iBAUM,MAAM;AAsP5B2C,qBAAU,CAACsD,SAAS,CAAC,YAAY,CAAC,CAACjG,UAAU,GAAGA,UAAU;;;;"}