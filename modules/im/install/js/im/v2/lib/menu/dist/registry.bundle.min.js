this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(e,t,s,i,n,o,r,a,c,l,h,g,u,I,d,M,m){"use strict";const _="BX.Messenger.v2.Lib.Menu";var v=babelHelpers.classPrivateFieldLooseKey("prepareMenuItems");var L=babelHelpers.classPrivateFieldLooseKey("filterExcessDelimiters");var C=babelHelpers.classPrivateFieldLooseKey("filterDuplicateDelimiters");var p=babelHelpers.classPrivateFieldLooseKey("filterFinishingDelimiter");var x=babelHelpers.classPrivateFieldLooseKey("isDelimiter");class B extends l.EventEmitter{constructor(){super();Object.defineProperty(this,x,{value:y});Object.defineProperty(this,p,{value:N});Object.defineProperty(this,C,{value:b});Object.defineProperty(this,L,{value:E});Object.defineProperty(this,v,{value:f});this.id="im-base-context-menu";this.setEventNamespace(_);this.store=u.Core.getStore();this.restClient=u.Core.getRestClient();this.onClosePopupHandler=this.onClosePopup.bind(this)}openMenu(e,t){if(this.menuInstance){this.close()}this.context=e;this.target=t;this.menuInstance=this.getMenuInstance();this.menuInstance.show()}getMenuInstance(){return o.MenuManager.create(this.getMenuOptions())}getMenuOptions(){return{id:this.id,bindOptions:{forceBindPosition:true,position:"bottom"},targetContainer:document.body,bindElement:this.target,cacheable:false,className:this.getMenuClassName(),items:babelHelpers.classPrivateFieldLooseBase(this,v)[v](),events:{onClose:()=>{this.emit(B.events.onCloseMenu);this.close()}}}}getMenuItems(){return[]}getMenuClassName(){return""}onClosePopup(){this.close()}close(){if(!this.menuInstance){return}this.menuInstance.destroy();this.menuInstance=null}destroy(){this.close()}getCurrentUserId(){return u.Core.getUserId()}}function f(){return babelHelpers.classPrivateFieldLooseBase(this,L)[L](this.getMenuItems())}function E(e){const t=babelHelpers.classPrivateFieldLooseBase(this,C)[C](e);return babelHelpers.classPrivateFieldLooseBase(this,p)[p](t)}function b(e){let t=null;return e.filter((e=>{if(babelHelpers.classPrivateFieldLooseBase(this,x)[x](t)&&babelHelpers.classPrivateFieldLooseBase(this,x)[x](e)){return false}if(e!==null){t=e}return true}))}function N(e){let t=null;return e.reverse().filter((e=>{if(t===null&&babelHelpers.classPrivateFieldLooseBase(this,x)[x](e)){return false}if(e!==null){t=e}return true})).reverse()}function y(e){return c.Type.isObjectLike(e)&&e.delimiter===true}B.events={onCloseMenu:"onCloseMenu"};const P="intranet.controller.invite.reinvite";const U="intranet.controller.invite.deleteinvitation";const R={resendInvite(e){const t={params:{userId:e}};c.ajax.runAction(P,{data:t}).then((()=>{this.showNotification(c.Loc.getMessage("IM_LIB_INVITE_RESEND_DONE"),2e3)}),(e=>{this.handleActionError(e)}))},cancelInvite(e){const t={params:{userId:e}};c.ajax.runAction(U,{data:t}).then((()=>{this.showNotification(c.Loc.getMessage("IM_LIB_INVITE_CANCEL_DONE"),2e3)}),(e=>{this.handleActionError(e)}))},showNotification(e,t=4e3){BX.UI.Notification.Center.notify({content:e,autoHideDelay:t})},handleActionError(e){if(e.status==="error"&&e.errors.length>0){const t=e.errors.map((e=>e.message)).join(". ");this.showNotification(t);return true}this.showNotification(c.Loc.getMessage("IM_LIST_RECENT_CONNECT_ERROR"))}};var O=babelHelpers.classPrivateFieldLooseKey("leaveChat");var A=babelHelpers.classPrivateFieldLooseKey("leaveCollab");class S extends B{constructor(){super();Object.defineProperty(this,A,{value:F});Object.defineProperty(this,O,{value:k});this.id="im-recent-context-menu";this.chatService=new I.ChatService;this.callManager=s.CallManager.getInstance();this.permissionManager=M.PermissionManager.getInstance()}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:true,offsetLeft:32}}getMenuClassName(){return this.context.compactMode?"":super.getMenuClassName()}getMenuItems(){if(this.context.invitation.isActive){return this.getInviteItems()}return[this.getUnreadMessageItem(),this.getPinMessageItem(),this.getMuteItem(),this.getOpenProfileItem(),this.getChatsWithUserItem(),this.getHideItem(),this.getLeaveItem()]}getSendMessageItem(){return{text:c.Loc.getMessage("IM_LIB_MENU_WRITE_V2"),onclick:()=>{h.Messenger.openChat(this.context.dialogId);this.menuInstance.close()}}}getOpenItem(){return{text:c.Loc.getMessage("IM_LIB_MENU_OPEN"),onclick:()=>{h.Messenger.openChat(this.context.dialogId);this.menuInstance.close()}}}getUnreadMessageItem(){const e=this.store.getters["chats/get"](this.context.dialogId,true);const t=this.context.unread||e.counter>0;return{text:t?c.Loc.getMessage("IM_LIB_MENU_READ"):c.Loc.getMessage("IM_LIB_MENU_UNREAD"),onclick:()=>{if(t){this.chatService.readDialog(this.context.dialogId)}else{this.chatService.unreadDialog(this.context.dialogId)}this.menuInstance.close()}}}getPinMessageItem(){const e=this.context.pinned;return{text:e?c.Loc.getMessage("IM_LIB_MENU_UNPIN_MSGVER_1"):c.Loc.getMessage("IM_LIB_MENU_PIN_MSGVER_1"),onclick:()=>{if(e){this.chatService.unpinChat(this.context.dialogId)}else{this.chatService.pinChat(this.context.dialogId)}this.menuInstance.close()}}}getMuteItem(){const e=this.permissionManager.canPerformActionByRole(m.ActionByRole.mute,this.context.dialogId);if(!e){return null}const t=this.store.getters["chats/get"](this.context.dialogId,true);const s=t.muteList.includes(u.Core.getUserId());return{text:s?c.Loc.getMessage("IM_LIB_MENU_UNMUTE_2"):c.Loc.getMessage("IM_LIB_MENU_MUTE_2"),onclick:()=>{if(s){this.chatService.unmuteChat(this.context.dialogId)}else{this.chatService.muteChat(this.context.dialogId)}this.menuInstance.close()}}}getCallItem(){const e=this.callManager.chatCanBeCalled(this.context.dialogId);const t=this.permissionManager.canPerformActionByRole(m.ActionByRole.call,this.context.dialogId);if(!e||!t){return null}return{text:c.Loc.getMessage("IM_LIB_MENU_CALL_2"),onclick:()=>{n.Analytics.getInstance().onRecentStartCallClick({isGroupChat:this.context.dialogId.includes("chat"),chatId:this.context.chatId});this.callManager.startCall(this.context.dialogId);this.menuInstance.close()}}}getOpenProfileItem(){if(!this.isUser()||this.isBot()){return null}const e=g.Utils.user.getProfileLink(this.context.dialogId);return{text:c.Loc.getMessage("IM_LIB_MENU_OPEN_PROFILE_V2"),href:e,onclick:()=>{this.menuInstance.close()}}}getHideItem(){var e,t;if((e=this.context.invitation)!=null&&e.isActive||(t=this.context.options)!=null&&t.default_user_record){return null}return{text:c.Loc.getMessage("IM_LIB_MENU_HIDE_MSGVER_1"),onclick:()=>{I.RecentService.getInstance().hideChat(this.context.dialogId);this.menuInstance.close()}}}getLeaveItem(){if(this.isCollabChat()){return babelHelpers.classPrivateFieldLooseBase(this,A)[A]()}return babelHelpers.classPrivateFieldLooseBase(this,O)[O]()}getChatsWithUserItem(){if(!this.isUser()||this.isBot()){return null}const e=this.store.getters["application/getLayout"].entityId.length>0;return{text:c.Loc.getMessage("IM_LIB_MENU_FIND_CHATS_WITH_USER"),onclick:async()=>{if(!e){await h.Messenger.openChat(this.context.dialogId)}l.EventEmitter.emit(m.EventType.sidebar.open,{panel:m.SidebarDetailBlock.chatsWithUser,standalone:true,dialogId:this.context.dialogId});this.menuInstance.close()}}}getInviteItems(){const e=[this.getSendMessageItem(),this.getOpenProfileItem()];let t;if(c.Type.isUndefined(BX.MessengerProxy)){t=true;console.error("BX.MessengerProxy.canInvite() method not found in v2 version!")}else{t=BX.MessengerProxy.canInvite()}const s=t&&u.Core.getUserId()===this.context.invitation.originator;if(s){e.push(this.getDelimiter(),this.context.invitation.canResend?this.getResendInviteItem():null,this.getCancelInviteItem())}return e}getResendInviteItem(){return{text:c.Loc.getMessage("IM_LIB_INVITE_RESEND"),onclick:()=>{R.resendInvite(this.context.dialogId);this.menuInstance.close()}}}getCancelInviteItem(){return{text:c.Loc.getMessage("IM_LIB_INVITE_CANCEL"),onclick:()=>{t.MessageBox.show({message:c.Loc.getMessage("IM_LIB_INVITE_CANCEL_CONFIRM"),modal:true,buttons:t.MessageBoxButtons.OK_CANCEL,onOk:e=>{R.cancelInvite(this.context.dialogId);e.close()},onCancel:e=>{e.close()}});this.menuInstance.close()}}}getDelimiter(){return{delimiter:true}}getChat(){return this.store.getters["chats/get"](this.context.dialogId,true)}isUser(){return this.store.getters["chats/isUser"](this.context.dialogId)}isBot(){if(!this.isUser()){return false}const e=this.store.getters["users/get"](this.context.dialogId);return e.type===m.UserType.bot}isChannel(){return i.ChannelManager.isChannel(this.context.dialogId)}isCommentsChat(){const{type:e}=this.store.getters["chats/get"](this.context.dialogId,true);return e===m.ChatType.comment}isCollabChat(){const{type:e}=this.store.getters["chats/get"](this.context.dialogId,true);return e===m.ChatType.collab}}function k(){const e=this.permissionManager.canPerformActionByRole(m.ActionByRole.leave,this.context.dialogId);if(!e){return null}const t=this.isChannel()?c.Loc.getMessage("IM_LIB_MENU_LEAVE_CHANNEL"):c.Loc.getMessage("IM_LIB_MENU_LEAVE_MSGVER_1");return{text:t,onclick:async()=>{this.menuInstance.close();const e=await d.showLeaveChatConfirm(this.context.dialogId);if(e===true){this.chatService.leaveChat(this.context.dialogId)}}}}function F(){const e=this.permissionManager.canPerformActionByRole(m.ActionByRole.leave,this.context.dialogId);const t=this.permissionManager.canPerformActionByUserType(m.ActionByUserType.leaveCollab);if(!e||!t){return null}return{text:c.Loc.getMessage("IM_LIB_MENU_LEAVE_MSGVER_1"),onclick:async()=>{this.menuInstance.close();const e=await d.showLeaveChatConfirm(this.context.dialogId);if(!e){return}this.chatService.leaveCollab(this.context.dialogId)}}}var T=babelHelpers.classPrivateFieldLooseKey("getKickItemText");var H=babelHelpers.classPrivateFieldLooseKey("kickUser");class X extends B{constructor(){super();Object.defineProperty(this,H,{value:V});Object.defineProperty(this,T,{value:D});this.id="bx-im-user-context-menu";this.permissionManager=M.PermissionManager.getInstance()}getKickItem(){const e=this.permissionManager.canPerformActionByRole(m.ActionByRole.kick,this.context.dialog.dialogId);if(!e){return null}return{text:babelHelpers.classPrivateFieldLooseBase(this,T)[T](),onclick:async()=>{this.menuInstance.close();const e=await d.showKickUserConfirm(this.context.dialog.dialogId);if(e!==true){return}void babelHelpers.classPrivateFieldLooseBase(this,H)[H]()}}}getMentionItem(){return{text:c.Loc.getMessage("IM_LIB_MENU_USER_MENTION"),onclick:()=>{l.EventEmitter.emit(m.EventType.textarea.insertMention,{mentionText:this.context.user.name,mentionReplacement:g.Utils.text.getMentionBbCode(this.context.user.id,this.context.user.name),dialogId:this.context.dialog.dialogId,isMentionSymbol:false});this.menuInstance.close()}}}getSendItem(){if(this.context.dialog.type===m.ChatType.user){return null}return{text:c.Loc.getMessage("IM_LIB_MENU_USER_WRITE"),onclick:()=>{void h.Messenger.openChat(this.context.user.id);this.menuInstance.close()}}}getProfileItem(){if(this.isBot()){return null}const e=g.Utils.user.getProfileLink(this.context.user.id);const t=this.context.user.id===u.Core.getUserId();const s=t?"IM_LIB_MENU_OPEN_OWN_PROFILE":"IM_LIB_MENU_OPEN_PROFILE_V2";return{text:c.Loc.getMessage(s),href:e,onclick:()=>{this.menuInstance.close()}}}isCollabChat(){const{type:e}=this.store.getters["chats/get"](this.context.dialog.dialogId,true);return e===m.ChatType.collab}isBot(){return this.context.user.type===m.UserType.bot}}function D(){if(this.isCollabChat()){return c.Loc.getMessage("IM_LIB_MENU_USER_KICK_FROM_COLLAB")}return c.Loc.getMessage("IM_LIB_MENU_USER_KICK_FROM_CHAT")}function V(){if(this.isCollabChat()){return(new I.ChatService).kickUserFromCollab(this.context.dialog.dialogId,this.context.user.id)}return(new I.ChatService).kickUserFromChat(this.context.dialog.dialogId,this.context.user.id)}e.RecentMenu=S;e.BaseMenu=B;e.UserMenu=X})(this.BX.Messenger.v2.Lib=this.BX.Messenger.v2.Lib||{},BX.UI.Dialogs,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Call.Lib,BX.Main,BX.Vue3.Vuex,BX,BX,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Service,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const);
//# sourceMappingURL=registry.bundle.map.js