(function(e){function t(e){this.calendar=e.calendar;this.wrap=e.wrap;this.popupId=this.calendar.id+"_view_switcher";if(e.dropDownMode){this.createDropDown()}else{this.createSelector()}BX.addCustomEvent(this.calendar,"afterSetView",BX.proxy(this.onAfterSetView,this))}t.prototype={createSelector:function(){var e=this.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-view-switcher-list"},events:{click:BX.delegate(function(e){var t=e.target||e.srcElement;if(t&&t.getAttribute){var i=t.getAttribute("data-bx-calendar-view");this.calendar.setView(i,{animation:true})}},this)}}));this.calendar.views.forEach(function(t){t.switchNode=e.appendChild(BX.create("SPAN",{props:{className:"calendar-view-switcher-list-item"+(this.calendar.currentViewName==t.name?" calendar-view-switcher-list-item-active":"")},attrs:{"data-bx-calendar-view":t.name},text:t.title||t.name}))},this)},createDropDown:function(){this.selectorText=BX.create("div",{props:{className:"calendar-view-switcher-text"}});this.selectorTextInner=this.selectorText.appendChild(BX.create("div",{props:{className:"calendar-view-switcher-text-inner"}}));BX.adjust(this.wrap,{children:[this.selectorText,BX.create("div",{props:{className:"calendar-view-switcher-dropdown"}})],events:{click:BX.proxy(this.showPopup,this)}});if(BX.type.isArray(this.calendar.util.config.additionalViewModes)){this.viewModeTextInner=this.selectorText.appendChild(BX.create("div",{props:{className:"calendar-view-switcher-text-mode-inner"}}))}this.getMenuItems()},getMenuItems:function(){this.menuItems=[];this.calendar.views.forEach(function(e){this.menuItems.push({text:e.title||e.name,className:this.calendar.currentViewName==e.name?"menu-popup-item-accept":" ",onclick:BX.delegate(function(){this.calendar.setView(e.name,{animation:true});this.menuPopup.close()},this)});if(this.calendar.currentViewName==e.name){this.selectorTextInner.innerHTML=e.title||e.name}},this);if(BX.type.isArray(this.calendar.util.config.additionalViewModes)){var e,t;this.menuItems.push({text:"<span>"+BX.message("EC_VIEW_MODE_SHOW_BY")+"</span>",className:"main-buttons-submenu-separator main-buttons-submenu-item main-buttons-hidden-label"});for(e=0;e<this.calendar.util.config.additionalViewModes.length;e++){t=this.calendar.util.config.additionalViewModes[e];this.menuItems.push({dataset:t,text:BX.util.htmlspecialchars(t.label),className:t.selected?"menu-popup-item-accept":" ",onclick:BX.delegate(function(e,t){this.calendar.triggerEvent("changeViewMode",t.dataset);this.viewModeTextInner.innerHTML="("+BX.util.htmlspecialchars(t.dataset.label)+")";for(j=0;j<this.calendar.util.config.additionalViewModes.length;j++){this.calendar.util.config.additionalViewModes[j].selected=t.dataset.id==this.calendar.util.config.additionalViewModes[j].id}this.menuPopup.close()},this)});if(t.selected){this.viewModeTextInner.innerHTML="("+BX.util.htmlspecialchars(t.label)+")"}}}this.calendar.triggerEvent("beforeViewModePopupOpened",this.menuItems);return this.menuItems},showPopup:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){return this.menuPopup.close()}this.getMenuItems();this.menuPopup=BX.PopupMenu.create(this.popupId,this.selectorText,this.menuItems,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:-3,offsetLeft:this.selectorText.offsetWidth-6,angle:true});this.menuPopup.show();BX.addCustomEvent(this.menuPopup.popupWindow,"onPopupClose",BX.delegate(function(){BX.PopupMenu.destroy(this.popupId)},this))},onAfterSetView:function(){var e=this.calendar.getView(),t,i=this.wrap.querySelectorAll(".calendar-view-switcher-list-item-active");for(t=0;t<i.length;t++){BX.removeClass(i[t],"calendar-view-switcher-list-item-active")}if(e){if(e.switchNode){BX.addClass(this.calendar.getView().switchNode,"calendar-view-switcher-list-item-active")}if(this.selectorTextInner){this.selectorTextInner.innerHTML=e.title||e.name}}}};function i(e){this.calendar=e.calendar;this.wrap=e.wrap;this.id=this.calendar.id+"_top_add_button";this.create()}i.prototype={create:function(){this.button=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button webform-small-button-blue"},html:BX.message("EC_ADD"),events:{click:BX.proxy(this.addEntry,this)}}));this.menuItems=[{text:BX.message("EC_ADD_EVENT"),onclick:BX.proxy(this.addEntry,this)}];if(this.calendar.showTasks){this.menuItems.push({text:BX.message("EC_ADD_TASK"),onclick:BX.proxy(this.addTask,this)})}if(this.menuItems.length>1){BX.addClass(this.wrap,"webform-small-button-separate-wrap");this.addButtonMore=this.wrap.appendChild(BX.create("SPAN",{props:{className:"webform-small-button-right-part"},events:{click:BX.proxy(this.showPopup,this)}}))}},showPopup:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){return this.menuPopup.close()}this.menuPopup=BX.PopupMenu.create(this.id,this.addButtonMore,this.menuItems,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:15,angle:true});this.menuPopup.show();BX.addCustomEvent(this.menuPopup.popupWindow,"onPopupClose",BX.delegate(function(){BX.PopupMenu.destroy(this.addButtonMorePopupId);BX.PopupMenu.destroy(this.id)},this))},addEntry:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){this.menuPopup.close()}if(!this.calendar.editSlider){this.calendar.editSlider=new e.BXEventCalendar.EditEntrySlider(this.calendar)}this.calendar.editSlider.show({})},addTask:function(){if(this.menuPopup&&this.menuPopup.popupWindow&&this.menuPopup.popupWindow.isShown()){this.menuPopup.close()}BX.SidePanel.Instance.open(this.calendar.util.getEditTaskPath(),{loader:"task-new-loader"})}};function a(e){this.id=e.id||"bx-select-input-"+Math.round(Math.random()*1e6);this.values=e.values||false;this.input=e.input;this.defaultValue=e.defaultValue||"";this.openTitle=e.openTitle||"";this.className=e.className||"";this.currentValue=e.value;this.currentValueIndex=e.valueIndex;this.onChangeCallback=e.onChangeCallback||null;this.zIndex=e.zIndex||1200;this.disabled=e.disabled;if(this.onChangeCallback){BX.bind(this.input,"change",this.onChangeCallback);BX.bind(this.input,"keyup",this.onChangeCallback)}if(this.currentValueIndex!==undefined&&this.values[this.currentValueIndex]){this.input.value=this.values[this.currentValueIndex].label}this.curInd=false;if(this.values){BX.bind(this.input,"click",BX.proxy(this.onClick,this));BX.bind(this.input,"focus",BX.proxy(this.onFocus,this));BX.bind(this.input,"blur",BX.proxy(this.onBlur,this));BX.bind(this.input,"keyup",BX.proxy(this.onKeyup,this))}}a.prototype={showPopup:function(){if(this.shown||this.disabled)return;var e=0,t=0,i=[],a,s=this;for(a=0;a<this.values.length;a++){if(this.values[a].delimiter){i.push(this.values[a])}else{if(this.currentValue&&this.values[a]&&this.values[a].value==this.currentValue.value){e=t}i.push({id:this.values[a].value,text:this.values[a].label,onclick:this.values[a].callback||function(e,t){return function(){s.input.value=t;s.popupMenu.close();s.onChange()}}(this.values[a].value,this.values[a].labelRaw||this.values[a].label)});t++}}this.popupMenu=BX.PopupMenu.create(this.id,this.input,i,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:0});this.popupMenu.popupWindow.setWidth(this.input.offsetWidth-2);var n=this.popupMenu.layout.menuContainer;BX.addClass(this.popupMenu.layout.menuContainer,"calendar-select-popup");this.popupMenu.show();var o=this.popupMenu.menuItems[e];if(o&&o.layout){n.scrollTop=o.layout.item.offsetTop-o.layout.item.offsetHeight}BX.addCustomEvent(this.popupMenu.popupWindow,"onPopupClose",function(){BX.PopupMenu.destroy(s.id);s.shown=false});this.input.select();this.shown=true},closePopup:function(){BX.PopupMenu.destroy(this.id);this.shown=false},onFocus:function(){setTimeout(BX.delegate(function(){if(!this.shown){this.showPopup()}},this),200)},onClick:function(){if(this.shown){this.closePopup()}else{this.showPopup()}},onBlur:function(){setTimeout(BX.delegate(this.closePopup,this),200)},onKeyup:function(){setTimeout(BX.delegate(this.closePopup,this),50)},onChange:function(){var e=this.input.value;BX.onCustomEvent(this,"onSelectInputChanged",[this,e]);if(this.onChangeCallback&&typeof this.onChangeCallback=="function")this.onChangeCallback({value:e})},destroy:function(){if(this.onChangeCallback){BX.unbind(this.input,"change",this.onChangeCallback);BX.unbind(this.input,"keyup",this.onChangeCallback)}BX.unbind(this.input,"click",BX.proxy(this.onClick,this));BX.unbind(this.input,"focus",BX.proxy(this.onFocus,this));BX.unbind(this.input,"blur",BX.proxy(this.onBlur,this));BX.unbind(this.input,"keyup",BX.proxy(this.onKeyup,this));if(this.popupMenu)this.popupMenu.close();BX.PopupMenu.destroy(this.id);this.shown=false}};function s(e){this.controlList={};this.selectedValues=[];this.values=e.values;this.addButton=e.addButtonNode;this.valuesWrap=e.valuesContainerNode;this.changeCallack=e.changeCallack;this.showPopupCallBack=e.showPopupCallBack;this.hidePopupCallBack=e.hidePopupCallBack;this.id=e.id||"reminder-"+Math.round(Math.random()*1e6);this.zIndex=e.zIndex||3200;BX.unbind(this.addButton,"click",BX.proxy(this.showPopup,this));BX.bind(this.addButton,"click",BX.proxy(this.showPopup,this));if(e.selectedValues&&e.selectedValues.length>0){for(var t=0;t<e.selectedValues.length;t++){this.addValue(e.selectedValues[t])}}}s.prototype={showPopup:function(){var e=this,t,i=[];for(t=0;t<this.values.length;t++){if(!BX.util.in_array(this.values[t].value,this.selectedValues)){i.push({text:this.values[t].label,onclick:function(t){return function(){e.addValue(t);e.reminderMenu.close()}}(this.values[t].value)})}}this.reminderMenu=BX.PopupMenu.create(this.id,this.addButton,i,{closeByEsc:true,autoHide:true,zIndex:this.zIndex,offsetTop:0,offsetLeft:9,angle:true});this.reminderMenu.show();if(this.showPopupCallBack)this.showPopupCallBack();BX.addCustomEvent(e.reminderMenu.popupWindow,"onPopupClose",function(){if(e.hidePopupCallBack)e.hidePopupCallBack();BX.PopupMenu.destroy(e.id)})},addValue:function(e){var t,i,a,s=this;for(t=0;t<this.values.length;t++){if(this.values[t].value==e&&e>=0&&!BX.util.in_array(e,this.selectedValues)){if(!this.selectedValues.length)BX.cleanNode(this.valuesWrap);i=this.valuesWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-reminder-item"},text:this.values[t].shortLabel||this.values[t].label}));a=i.appendChild(BX.create("SPAN",{props:{className:"calendar-reminder-clear-icon"},events:{click:function(){s.removeValue(e)}}}));this.selectedValues.push(e);this.controlList[e]=i;break}}if(this.selectedValues.length==this.values.length){this.addButton.style.display="none"}if(this.changeCallack)this.changeCallack(this.selectedValues)},removeValue:function(e){if(this.controlList[e]&&BX.isNodeInDom(this.controlList[e])){BX.cleanNode(this.controlList[e],true)}this.selectedValues=BX.util.deleteFromArray(this.selectedValues,BX.util.array_search(e,this.selectedValues));if(this.selectedValues.length<this.values.length){this.addButton.style.display=""}if(!this.selectedValues.length){this.valuesWrap.appendChild(BX.create("SPAN",{props:{className:""},text:" "+BX.message("EC_REMIND_NO")}))}if(this.changeCallack)this.changeCallack(this.selectedValues)}};function n(e,t){this.params=t;this.id=e;this.calendar=t.calendar;this.zIndex=t.zIndex||3100;this.wrapNode=t.wrapNode;this.destinationInputName=t.inputName||"EVENT_DESTINATION";if(this.params.itemsSelected&&this.params.itemsSelected.length){this.params.itemsSelected=this.convertAttendeesCodes(this.params.itemsSelected)}this.create()}n.prototype={create:function(){var e=this.id;this.socnetDestinationWrap=this.wrapNode.appendChild(BX.create("DIV",{props:{className:"event-grid-dest-wrap"},events:{click:function(t){BX.SocNetLogDestination.openDialog(e);BX.PreventDefault(t)}}}));this.socnetDestinationItems=this.socnetDestinationWrap.appendChild(BX.create("SPAN",{props:{className:""},events:{click:function(t){var i=t.target||t.srcElement;if(i.className=="feed-event-del-but"){BX.SocNetLogDestination.deleteItem(i.getAttribute("data-item-id"),i.getAttribute("data-item-type"),e);t.preventDefault();t.stopPropagation()}},mouseover:function(e){var t=e.target||e.srcElement;if(t.className=="feed-event-del-but")BX.addClass(t.parentNode,"event-grid-dest-hover")},mouseout:function(e){var t=e.target||e.srcElement;if(t.className=="feed-event-del-but")BX.removeClass(t.parentNode,"event-grid-dest-hover")}}}));this.socnetDestinationInputWrap=this.socnetDestinationWrap.appendChild(BX.create("SPAN",{props:{className:"feed-add-destination-input-box"}}));this.socnetDestinationInput=this.socnetDestinationInputWrap.appendChild(BX.create("INPUT",{props:{id:e+"-inp",className:"feed-add-destination-inp"},attrs:{value:"",type:"text"},events:{keydown:function(t){return BX.SocNetLogDestination.searchBeforeHandler(t,{formName:e,inputId:e+"-inp"})},keyup:function(t){return BX.SocNetLogDestination.searchHandler(t,{formName:e,inputId:e+"-inp",linkId:"event-grid-dest-add-link",sendAjax:true})}}}));this.socnetDestinationLink=this.socnetDestinationWrap.appendChild(BX.create("SPAN",{html:this.params.addLinkMessage||BX.message("EC_DESTINATION_ADD_USERS"),props:{id:e+"-link",className:"feed-add-destination-link"},events:{keydown:function(t){return BX.SocNetLogDestination.searchBeforeHandler(t,{formName:e,inputId:e+"-inp"})},keyup:function(t){return BX.SocNetLogDestination.searchHandler(t,{formName:e,inputId:e+"-inp",linkId:"event-grid-dest-add-link",sendAjax:true})}}}));this.params.items=this.calendar.util.getSocnetDestinationConfig("items");this.params.itemsLast=this.calendar.util.getSocnetDestinationConfig("itemsLast");if(this.params.itemsSelected&&!this.checkItemsSelected(this.params.items,this.params.itemsLast,this.params.itemsSelected,BX.proxy(this.init,this))){return}this.init()},init:function(){if(!this.socnetDestinationInput||!this.socnetDestinationWrap)return;var e=this;if(this.params.selectGroups===false){this.params.items.groups={};this.params.items.department={};this.params.items.sonetgroups={}}if(this.params.selectUsers===false){this.params.items.users={};this.params.items.groups={};this.params.items.department={}}BX.SocNetLogDestination.init({name:this.id,searchInput:this.socnetDestinationInput,extranetUser:false,userSearchArea:"I",bindMainPopup:{node:this.socnetDestinationWrap,offsetTop:"5px",offsetLeft:"15px"},bindSearchPopup:{node:this.socnetDestinationWrap,offsetTop:"5px",offsetLeft:"15px"},callback:{select:BX.proxy(this.selectCallback,this),unSelect:BX.proxy(this.unSelectCallback,this),openDialog:BX.proxy(this.openDialogCallback,this),closeDialog:BX.proxy(this.closeDialogCallback,this),openSearch:BX.proxy(this.openDialogCallback,this),closeSearch:function(){e.closeDialogCallback(true)}},items:this.params.items,itemsLast:this.params.itemsLast,itemsSelected:this.params.itemsSelected,departmentSelectDisable:this.params.selectGroups===false})},checkItemsSelected:function(e,t,i,a){var s=[];for(var n in i){if(i.hasOwnProperty(n)){if(i[n]=="users"&&!e.users[n]){s.push(n)}}}if(s.length>0){var o=this.socnetDestinationWrap.appendChild(BX.adjust(this.calendar.util.getLoader(40),{style:{height:"50px"}}));this.calendar.request({type:"get",data:{action:"get_destination_items",codes:s},handler:BX.delegate(function(e){if(o)BX.remove(o);this.calendar.util.mergeSocnetDestinationConfig(e.destinationItems);this.params.items=this.calendar.util.getSocnetDestinationConfig("items");this.params.itemsLast=this.calendar.util.getSocnetDestinationConfig("itemsLast");if(a&&typeof a=="function")a()},this)});return false}return true},closeAll:function(){if(BX.SocNetLogDestination.isOpenDialog()){BX.SocNetLogDestination.closeDialog()}BX.SocNetLogDestination.closeSearch()},selectCallback:function(e,t){var i=t,a="S";if(t=="sonetgroups"){a="SG"}else if(t=="groups"){a="UA";i="all-users"}else if(t=="users"){a="U"}else if(t=="department"){a="DR"}this.socnetDestinationItems.appendChild(BX.create("span",{attrs:{"data-id":e.id},props:{className:"event-grid-dest event-grid-dest-"+i},children:[BX.create("input",{attrs:{type:"hidden",name:this.destinationInputName+"["+a+"][]",value:e.id}}),BX.create("span",{props:{className:"event-grid-dest-text"},html:e.name}),BX.create("span",{props:{className:"feed-event-del-but"},attrs:{"data-item-id":e.id,"data-item-type":t}})]}));BX.onCustomEvent("OnDestinationAddNewItem",[e]);this.socnetDestinationInput.value="";this.socnetDestinationLink.innerHTML=this.params.addLinkMessage||(BX.SocNetLogDestination.getSelectedCount(this.id)>0?BX.message("EC_DESTINATION_ADD_MORE"):BX.message("EC_DESTINATION_ADD_USERS"))},unSelectCallback:function(e,t,i){var a=BX.findChildren(this.socnetDestinationItems,{attribute:{"data-id":e.id}},true);if(a!=null){for(var s=0;s<a.length;s++){BX.remove(a[s])}}BX.onCustomEvent("OnDestinationUnselect");this.socnetDestinationInput.value="";this.socnetDestinationLink.innerHTML=this.params.addLinkMessage||(BX.SocNetLogDestination.getSelectedCount(this.id)>0?BX.message("EC_DESTINATION_ADD_MORE"):BX.message("EC_DESTINATION_ADD_USERS"))},openDialogCallback:function(){if(BX.SocNetLogDestination.popupWindow){BX.SocNetLogDestination.popupWindow.params.zIndex=this.zIndex;BX.SocNetLogDestination.popupWindow.popupContainer.style.zIndex=this.zIndex}if(BX.SocNetLogDestination.popupSearchWindow){BX.SocNetLogDestination.popupSearchWindow.params.zIndex=this.zIndex;BX.SocNetLogDestination.popupSearchWindow.popupContainer.style.zIndex=this.zIndex}BX.style(this.socnetDestinationInputWrap,"display","inline-block");BX.style(this.socnetDestinationLink,"display","none");BX.focus(this.socnetDestinationInput)},closeDialogCallback:function(t){if(!BX.SocNetLogDestination.isOpenSearch()&&this.socnetDestinationInput.value.length<=0){BX.style(this.socnetDestinationInputWrap,"display","none");BX.style(this.socnetDestinationLink,"display","inline-block");if(t===true)this.socnetDestinationInput.value="";if(BX.SocNetLogDestination.backspaceDisable||BX.SocNetLogDestination.backspaceDisable!=null)BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.bind(e,"keydown",BX.SocNetLogDestination.backspaceDisable=function(e){if(e.keyCode==8){e.preventDefault();return false}});setTimeout(function(){BX.unbind(e,"keydown",BX.SocNetLogDestination.backspaceDisable);BX.SocNetLogDestination.backspaceDisable=null},5e3)}},getCodes:function(){var e=this.socnetDestinationItems.getElementsByTagName("INPUT"),t=[],i;for(i=0;i<e.length;i++){t.push(e[i].value)}return t},getAttendeesCodes:function(){var e=this.socnetDestinationItems.getElementsByTagName("INPUT"),t=[],i,a;for(i=0;i<e.length;i++){t.push(e[i].value)}return this.convertAttendeesCodes(t)},convertAttendeesCodes:function(e){var t={};if(BX.type.isArray(e)){e.forEach(function(e){if(e.substr(0,2)=="DR"){t[e]="department"}else if(e.substr(0,2)=="UA"){t[e]="groups"}else if(e.substr(0,2)=="SG"){t[e]="sonetgroups"}else if(e.substr(0,1)=="U"){t[e]="users"}})}return t},getAttendeesCodesList:function(e){var t=[];if(!e)e=this.getAttendeesCodes();for(var i in e){if(e.hasOwnProperty(i)){t.push(i)}}return t}};function o(e,t,i){this.params=t;this.id=e;this.zIndex=t.zIndex||3100;this.DOM={wrapNode:t.wrapNode};this.calendar=i;this.disabled=!this.calendar.util.isRichLocationEnabled();this.value={type:"",text:"",value:""};if(t.value&&typeof t.value==="object"){this.value.text=t.value.text||"";this.value.type=t.value.type||"";this.value.value=t.value.value||""}else if(t.value&&t.value!==""){this.value=this.calendar.util.parseLocation(t.value)}this.create()}o.prototype={create:function(){this.DOM.inputWrap=this.DOM.wrapNode.appendChild(BX.create("DIV",{props:{className:"calendar-field-block"}}));if(this.disabled){BX.addClass(this.DOM.wrapNode,"locked");this.DOM.inputWrap.appendChild(BX.create("DIV",{props:{className:"calendar-lock-icon"},events:{click:function(){B24.licenseInfoPopup.show("calendar_location",BX.message("EC_B24_LOCATION_LIMITATION_TITLE"),BX.message("EC_B24_LOCATION_LIMITATION"))}}}))}this.DOM.input=this.DOM.inputWrap.appendChild(BX.create("INPUT",{attrs:{name:this.params.inputName||"",placeholder:BX.message("EC_LOCATION_LABEL"),type:"text"},props:{className:"calendar-field calendar-field-select"}}));this.setValues()},setValues:function(){if(this.selectContol){this.selectContol.destroy()}var e=[],t=this.calendar.util.getMeetingRoomList(),i=this.calendar.util.getLocationList(),s=false;if(t&&t.length){for(n=0;n<t.length;n++){e.push({ID:parseInt(t[n].ID),label:BX.util.htmlspecialchars(t[n].NAME),value:t[n].ID,type:"mr"});if(this.value.type=="mr"&&this.value.value==t[n].ID){s=e.length-1}}e.push({delimiter:true})}if(!i||!i.length){e.push({label:BX.message("EC_ADD_LOCATION"),callback:BX.delegate(this.editMeetingRooms,this)})}else{var n;for(n=0;n<i.length;n++){e.push({ID:parseInt(i[n].ID),label:BX.util.htmlspecialchars(i[n].NAME),labelRaw:i[n].NAME,value:parseInt(i[n].ID),type:"calendar"});if(this.value.type=="calendar"&&this.value.value==i[n].ID){s=e.length-1}}e.push({delimiter:true});e.push({label:BX.message("EC_LOCATION_MEETING_ROOM_SET"),callback:BX.delegate(this.editMeetingRooms,this)})}if(this.value){this.DOM.input.value=this.value.str||"";if(this.value.type&&this.value.str==this.calendar.util.getTextLocation(this.value)){this.DOM.input.value=BX.message("EC_LOCATION_404")}}if(this.selectContol){this.selectContol.destroy()}this.selectContol=new a({input:this.DOM.input,values:e,valueIndex:s,zIndex:this.zIndex,disabled:this.disabled,onChangeCallback:BX.delegate(function(){var t,i=this.DOM.input.value;this.value={text:i};for(t=0;t<e.length;t++){if(e[t].label===i){this.value.type=e[t].type;this.value.value=e[t].value;break}}if(this.params.onChangeCallback&&typeof this.params.onChangeCallback=="function"){this.params.onChangeCallback()}},this)})},editMeetingRooms:function(){var e={};if(this.params.getControlContentCallback)e.wrap=this.params.getControlContentCallback();if(!e.wrap){e.wrap=this.showEditMeetingRooms()}this.buildLocationEditControl(e)},showEditMeetingRooms:function(){var e=this;if(this.editDialog){this.editDialog.destroy()}this.editDialogContent=BX.create("DIV");this.editDialog=new BX.PopupWindow(this.id+"_popup",null,{overlay:{opacity:10},autoHide:true,closeByEsc:true,zIndex:this.zIndex,offsetLeft:0,offsetTop:0,draggable:true,bindOnResize:false,titleBar:BX.message("EC_MEETING_ROOM_LIST_TITLE"),closeIcon:{right:"12px",top:"10px"},className:"bxc-popup-window",buttons:[new BX.PopupWindowButton({text:BX.message("EC_SEC_SLIDER_SAVE"),events:{click:function(){e.saveValues();if(e.editDialog){e.editDialog.close()}}}}),new BX.PopupWindowButtonLink({text:BX.message("EC_SEC_SLIDER_CANCEL"),className:"popup-window-button-link-cancel",events:{click:function(){if(e.editDialog){e.editDialog.close()}}}})],content:this.editDialogContent,events:{}});this.editDialog.show();return this.editDialogContent},buildLocationEditControl:function(e){var t=this,i;this.locationEditControlShown=true;this.editDialogWrap=e.wrap;var a=this.calendar.util.getLocationList();this.locationList=[];this.addNewButtonField=false;for(i=0;i<a.length;i++){this.locationList.push({id:a[i].ID,name:a[i].NAME})}if(!this.locationList.length){this.locationList.push({id:0,name:""})}for(i=0;i<this.locationList.length;i++){this.addRoomField(this.locationList[i],e.wrap)}this.addNewButtonField={outerWrap:e.wrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-container calendar-field-container-container-text"}}))};this.addNewButtonField.innerWrap=this.addNewButtonField.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-block"}}));this.addNewButtonField.innerCont=this.addNewButtonField.innerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-text"},html:'<span class="calendar-text-link">'+BX.message("EC_MEETING_ROOM_ADD")+"</span>",events:{click:function(){var i=t.locationList[t.locationList.length-1];if(i.id||i.deleted||BX.util.trim(i.field.input.value))t.locationList.push(t.addRoomField({id:0},e.wrap))}}}));e.wrap.appendChild(this.addNewButtonField.outerWrap)},addRoomField:function(e){e.field={outerWrap:this.editDialogWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-container calendar-field-container-string"}}))};e.field.innerWrap=e.field.outerWrap.appendChild(BX.create("DIV",{props:{className:"calendar-field-block"}}));var t=this;e.field.innerWrap.style.paddingRight="40px";e.field.input=e.field.innerWrap.appendChild(BX.create("INPUT",{props:{className:"calendar-field calendar-field-string"},attrs:{value:e.name||"",placeholder:BX.message("EC_MEETING_ROOM_PLACEHOLDER"),type:"text"},events:{keyup:function(i){if(i.keyCode==13){t.editRoom(e)}}}}));e.field.delRoomEntry=e.field.innerWrap.appendChild(BX.create("SPAN",{props:{className:"calendar-remove-filed"},events:{click:function(){t.deleteField(e)}}}));if(this.addNewButtonField){this.editDialogWrap.appendChild(this.addNewButtonField.outerWrap)}if(!e.id)e.field.input.focus();return e},editRoom:function(e){if(!this.locationEditControlShown)return;e.field.input.value=BX.util.trim(e.field.input.value);if(!e.id){if(e.field.input.value&&e.field.input.value!=e.name){e.name=e.field.input.value;this.locationList.push(this.addRoomField({id:0}))}}else{if(e.field.input.value!=e.name){e.name=e.field.input.value;e.changed=true}}},deleteField:function(e){BX.remove(e.field.outerWrap,true);e.deleted=true;e.changed=true},saveValues:function(){var e,t=[];for(e=0;e<this.locationList.length;e++){if(this.locationList[e].field&&this.locationList[e].field.input){if(this.locationList[e].name!==this.locationList[e].field.input.value&&this.locationList[e].id)this.locationList[e].changed=true;this.locationList[e].name=this.locationList[e].field.input.value}if(!this.locationList[e].deleted&&this.locationList[e].name||this.locationList[e].id){t.push({id:this.locationList[e].id||0,name:this.locationList[e].name||"",changed:this.locationList[e].changed||!this.locationList[e].id?"Y":"N",deleted:this.locationList[e].deleted||!this.locationList[e].name?"Y":"N"})}}this.calendar.request({type:"post",data:{action:"update_location_list",data:t},handler:BX.delegate(function(e){this.calendar.util.setLocationList(e.locationList);this.setValues()},this)});this.locationEditControlShown=false},getTextValue:function(e){if(!e){e=this.value}var t=e.str||e.text||"";if(e&&e.type=="mr"){t="ECMR_"+e.value}else if(e&&e.type=="calendar"){t="calendar_"+e.value}return t},getValue:function(){return this.value}};function l(e,t){this.calendar=e;this.outerWrap=t.wrap;this.created=false}l.prototype={show:function(){if(!this.created){this.smallCalendar=new BX.JCCalendar;this.smallCalendar.month_popup_classname="calendar-navi-month-popup";this.smallCalendar.year_popup_classname="calendar-navi-year-popup";this.smallCalendar.Show({node:this.outerWrap,callback_after:BX.proxy(this.changeDate,this),bTime:false});this.outerWrap.appendChild(this.smallCalendar.DIV);this.smallCalendar.popup.close();this.created=true;BX.addCustomEvent(this.calendar,"changeViewRange",BX.proxy(this.setDate,this))}this.outerWrap.style.display=""},hide:function(){this.outerWrap.style.display="none"},changeDate:function(e){if(e&&this.calendar.util.getDayCode(this.calendar.getViewRangeDate())!=this.calendar.util.getDayCode(e)&&this.calendar.getView()){this.calendar.getView().adjustViewRangeToDate(e)}},setDate:function(e){if(e&&this.smallCalendar.value&&this.calendar.util.getDayCode(this.smallCalendar.value)!=this.calendar.util.getDayCode(e)){e.setHours(12,0);this.smallCalendar.SetValue(e)}}};function r(e){this.calendar=e}r.prototype={reset:function(){jsDD.Reset()},registerDay:function(e){var t=e.node;jsDD.registerDest(t);t.onbxdestdragfinish=BX.delegate(function(){if(this.draggedNode){var i=this.currentState.entry;e.date.setHours(0,0,0,0);i.from.setFullYear(e.date.getFullYear(),e.date.getMonth(),e.date.getDate());i.to=new Date(i.from.getTime()+(i.data.DT_LENGTH-(i.fullDay?1:0))*1e3);i.startDayCode=i.from;i.endDayCode=i.to;i.opacity="0";this.calendar.getView().displayEntries({reloadEntries:false});var a=i.getWrap(0);BX.addClass(this.draggedNode,"animate");setTimeout(BX.delegate(function(){this.draggedNode.style.top=BX.pos(a).top+"px";this.draggedNode.style.left=BX.pos(a).left+"px"},this),1);setTimeout(BX.delegate(function(){delete i.opacity;i.parts.forEach(function(e){e.params.wrapNode.style.opacity=""});BX.remove(this.draggedNode)},this),300);this.calendar.entryController.moveEventToNewDate(this.currentState.entry,e.date);BX.removeClass(t,"calendar-grid-drag-select")}return true},this);t.onbxdestdraghover=function(){BX.addClass(t,"calendar-grid-drag-select")};t.onbxdestdraghout=function(){BX.removeClass(t,"calendar-grid-drag-select")}},registerTimelineDay:function(e){var t=e.node;jsDD.registerDest(t);t.onbxdestdragfinish=BX.delegate(function(i){if(i.getAttribute("data-bx-entry-resizer")=="Y"&&this.resizedState){this.calendar.entryController.moveEventToNewDate(this.resizedState.entry,this.resizedState.entry.from,this.resizedState.entry.to);return true}else if(this.draggedNode){var a=this.currentState.entry;a.from.setFullYear(e.date.getFullYear(),e.date.getMonth(),e.date.getDate());a.to=new Date(a.from.getTime()+(a.data.DT_LENGTH-(a.fullDay?1:0))*1e3);if(this.calendar.util.getDayCode(a.from)!=this.calendar.util.getDayCode(a.to)&&a.to.getHours()==0&&a.to.getMinutes()==0){a.to=new Date(a.to.getTime()-1e3*60)}a.startDayCode=a.from;a.endDayCode=a.to;a.opacity="0";this.calendar.getView().displayEntries({reloadEntries:false});var s=a.getWrap(0);BX.addClass(this.draggedNode,"animate");setTimeout(BX.delegate(function(){var e=BX.pos(s);this.draggedNode.style.top=e.top+"px";this.draggedNode.style.left=e.left+"px";this.draggedNode.style.height=e.height+"px";this.draggedNode.style.width=e.width+"px";this.draggedNode.style.opacity="0.6"},this),1);setTimeout(BX.delegate(function(){delete a.opacity;a.parts.forEach(function(e){e.params.wrapNode.style.opacity=""});BX.remove(this.draggedNode)},this),250);this.calendar.entryController.moveEventToNewDate(this.currentState.entry,a.from,a.to);BX.removeClass(t,"calendar-timeline-drag-select")}return true},this);t.onbxdestdraghover=BX.delegate(function(){if(this.draggedNode){var e=BX.pos(t).left+4;if(Math.abs(e-parseInt(this.draggedNode.style.left))>30){BX.addClass(this.draggedNode,"animate");setTimeout(BX.delegate(function(){this.draggedNode.style.left=BX.pos(t).left+4+"px"},this),1);if(this.clearAnimateTimeout){clearTimeout(this.clearAnimateTimeout)}this.clearAnimateTimeout=setTimeout(BX.delegate(function(){BX.removeClass(this.draggedNode,"animate")},this),300)}BX.addClass(t,"calendar-timeline-drag-select")}},this);t.onbxdestdraghout=BX.delegate(function(){if(this.draggedNode){BX.removeClass(t,"calendar-timeline-drag-select")}},this)},registerEntry:function(e,t){var i=this.calendar.entryController.canDo(t.entry,"edit");jsDD.registerObject(e);e.onbxdragstart=BX.delegate(function(){if(!i){this.draggedNode=false;BX.addClass(e,"calendar-entry-shake-mode");if(this.denyDragTimeout)clearTimeout(this.denyDragTimeout);this.denyDragTimeout=setTimeout(function(){BX.removeClass(e,"calendar-entry-shake-mode")},1e3);return}this.currentState=t;this.draggedNode=document.body.appendChild(e.cloneNode(true));e.style.opacity="0.3";BX.addClass(this.draggedNode,"calendar-entry-drag-mode");BX.removeClass(this.draggedNode,"calendar-event-line-start-yesterday");BX.removeClass(this.draggedNode,"calendar-event-line-finish-tomorrow");if(this.calendar.currentViewName=="week"||this.calendar.currentViewName=="day"){this.draggedNode.style.left=BX.pos(e).left+2+"px";this.draggedNode.style.width=this.calendar.getView().getDayWidth()-5+"px";this.currentState.offtimeTuneBaseZeroPos=BX.pos(this.calendar.getView().timeLinesCont).top;this.currentState.bottomBasePos=BX.pos(this.calendar.getView().bottomOffHours).bottom-2}else{this.draggedNode.style.width=this.calendar.getView().getDayWidth()+"px"}var a=this.currentState.entry,s=a.getLengthInDays(),n=this.draggedNode.querySelector(".calendar-event-resizer"),o=this.draggedNode.querySelector(".calendar-event-line-inner-container"),l=this.draggedNode.querySelector(".calendar-event-block-background"),r=this.draggedNode.querySelector(".calendar-event-line-inner");if(s>1){var d=this.draggedNode.querySelector(".calendar-event-line-text");if(d){d.innerHTML='<span class="calendar-event-line-days-count">('+BX.message("EC_DAY_LENGTH").replace("#COUNT#",s)+")</span> "+d.innerHTML}}if(o){if(a.isFullDay()){o.style.backgroundColor=this.calendar.util.hexToRgba(a.color,.7);o.style.borderColor=this.calendar.util.hexToRgba(a.color,.7)}else{if(a.isLongWithTime()){o.style.borderColor=this.calendar.util.hexToRgba(a.color,.7)}}}if(l){l.style.opacity="0.45"}if(r){r.style.maxWidth=""}if(this.calendar.getView().allEventsPopup){this.calendar.getView().allEventsPopup.close()}},this);e.onbxdrag=BX.delegate(function(e,t){if(this.draggedNode){if(this.calendar.currentViewName=="week"||this.calendar.currentViewName=="day"){var i,a,s=7,n=this.currentState.entry,o=this.calendar.getView(),l=this.draggedNode.offsetHeight,r=t-s;if(r<this.currentState.offtimeTuneBaseZeroPos){BX.addClass(this.draggedNode,"calendar-entry-shake-mode");if(this.shakeTimeout)clearTimeout(this.shakeTimeout);this.shakeTimeout=setTimeout(BX.proxy(function(){BX.removeClass(this.draggedNode,"calendar-entry-shake-mode")},this),400);r=this.currentState.offtimeTuneBaseZeroPos}else if(r+l>this.currentState.bottomBasePos){BX.addClass(this.draggedNode,"calendar-entry-shake-mode");if(this.shakeTimeout)clearTimeout(this.shakeTimeout);this.shakeTimeout=setTimeout(BX.proxy(function(){BX.removeClass(this.draggedNode,"calendar-entry-shake-mode")},this),400);r=this.currentState.bottomBasePos-l}i=o.getTimeByPos(r-this.currentState.offtimeTuneBaseZeroPos,5);a=this.draggedNode.querySelector(".calendar-event-block-time");this.draggedNode.style.top=r+"px";if(a&&i){n.from.setHours(i.h,i.m);n.to=new Date(n.from.getTime()+(n.data.DT_LENGTH-(n.fullDay?1:0))*1e3);if(this.calendar.util.getDayCode(n.from)!=this.calendar.util.getDayCode(n.to)&&n.to.getHours()==0&&n.to.getMinutes()==0){n.to=new Date(n.to.getTime()-1e3)}a.innerHTML=this.calendar.util.formatTime(n.from)+" &ndash; "+this.calendar.util.formatTime(n.to)}}else{this.draggedNode.style.top=t-10+"px";this.draggedNode.style.left=e-20+"px"}}},this);e.onbxdragstop=BX.delegate(function(){setTimeout(BX.delegate(function(){BX.remove(this.draggedNode)},this),400)},this);if(t.part.params.resizerNode){this.registerResizer(t.part.params.resizerNode,t)}},registerResizer:function(t,i){t.setAttribute("data-bx-entry-resizer","Y");BX.bind(t,"mousedown",BX.delegate(function(a){a=a||e.event;this.resizedState={entry:i.entry,entryWrap:i.part.params.wrapNode,node:t,startY:a.clientY+BX.GetWindowSize().scrollTop,height:parseInt(i.part.params.wrapNode.offsetHeight)||0}},this));jsDD.registerObject(t);t.onbxdrag=BX.delegate(function(e,t){if(this.resizedState){var i=this.resizedState.entry,a=Math.max(this.resizedState.height+t-this.resizedState.startY+5,5),s=this.calendar.getView().getTimeByPos(parseInt(this.resizedState.entryWrap.style.top)+a,5),n=this.calendar.util.formatTime(i.from)+" &ndash; "+this.calendar.util.formatTime(s.h,s.m),o=this.resizedState.entryWrap.querySelector(".calendar-event-block-time");i.to.setHours(s.h,s.m,0);if(o){o.innerHTML=n+'<span class="calendar-event-block-time-shadow">'+n+"</span>"}this.resizedState.entryWrap.style.height=a+"px"}},this);t.onbxdragstop=function(){setTimeout(BX.delegate(function(){if(this.resizedState){this.resizedState=null}},this),400)}}};if(e.BXEventCalendar){e.BXEventCalendar.ViewSwitcher=t;e.BXEventCalendar.AddButton=i;e.BXEventCalendar.SelectInput=a;e.BXEventCalendar.ReminderSelector=s;e.BXEventCalendar.DestinationSelector=n;e.BXEventCalendar.LocationSelector=o;e.BXEventCalendar.NavigationCalendar=l;e.BXEventCalendar.DragDrop=r}else{BX.addCustomEvent(e,"onBXEventCalendarInit",function(){e.BXEventCalendar.ViewSwitcher=t;e.BXEventCalendar.AddButton=i;e.BXEventCalendar.SelectInput=a;e.BXEventCalendar.ReminderSelector=s;e.BXEventCalendar.DestinationSelector=n;e.BXEventCalendar.LocationSelector=o;e.BXEventCalendar.NavigationCalendar=l;e.BXEventCalendar.DragDrop=r})}})(window);