{"version":3,"file":"message-component-manager.bundle.js","sources":["../src/message-component-manager.js"],"sourcesContent":["import { Utils } from 'im.v2.lib.utils';\nimport { Core } from 'im.v2.application.core';\nimport { MessageComponent } from 'im.v2.const';\nimport { SmileManager } from 'im.v2.lib.smile-manager';\nimport { OpenLinesMessageManager } from 'imopenlines.v2.lib.message-manager';\n\nimport type { Store } from 'ui.vue3.vuex';\nimport type { ImModelMessage } from 'im.v2.model';\n\nconst serverComponentList = new Set([\n\tMessageComponent.unsupported,\n\tMessageComponent.chatCreation,\n\tMessageComponent.ownChatCreation,\n\tMessageComponent.conferenceCreation,\n\tMessageComponent.callInvite,\n\tMessageComponent.copilotCreation,\n\tMessageComponent.copilotMessage,\n\tMessageComponent.supportVote,\n\tMessageComponent.supportSessionNumber,\n\tMessageComponent.supportChatCreation,\n\tMessageComponent.zoomInvite,\n\tMessageComponent.copilotAddedUsers,\n\tMessageComponent.supervisorUpdateFeature,\n\tMessageComponent.supervisorEnableFeature,\n\tMessageComponent.sign,\n\tMessageComponent.checkIn,\n\tMessageComponent.generalChatCreationMessage,\n\tMessageComponent.generalChannelCreationMessage,\n\tMessageComponent.channelCreationMessage,\n\tMessageComponent.callMessage,\n\tMessageComponent.voteMessage,\n]);\n\nexport class MessageComponentManager\n{\n\t#message: ImModelMessage;\n\t#store: Store;\n\n\tconstructor(message: ImModelMessage)\n\t{\n\t\tthis.#message = message;\n\t\tthis.#store = Core.getStore();\n\t}\n\n\tgetName(): $Values<typeof MessageComponent>\n\t{\n\t\tconst openLinesManager = new OpenLinesMessageManager(this.#message);\n\n\t\tif (openLinesManager.checkComponentInOpenLinesList())\n\t\t{\n\t\t\treturn openLinesManager.getMessageComponent();\n\t\t}\n\n\t\tif (this.#isDeletedMessage())\n\t\t{\n\t\t\treturn MessageComponent.deleted;\n\t\t}\n\n\t\tif (this.#isServerComponent())\n\t\t{\n\t\t\treturn this.#message.componentId;\n\t\t}\n\n\t\tif (this.#isSystemMessage())\n\t\t{\n\t\t\treturn MessageComponent.system;\n\t\t}\n\n\t\tif (this.#hasFiles())\n\t\t{\n\t\t\treturn MessageComponent.file;\n\t\t}\n\n\t\tif (this.#isEmojiOnly() || this.#hasSmilesOnly())\n\t\t{\n\t\t\treturn MessageComponent.smile;\n\t\t}\n\n\t\treturn MessageComponent.default;\n\t}\n\n\t#isServerComponent(): boolean\n\t{\n\t\treturn serverComponentList.has(this.#message.componentId);\n\t}\n\n\t#hasFiles(): boolean\n\t{\n\t\treturn this.#message.files.length > 0;\n\t}\n\n\t#hasText(): boolean\n\t{\n\t\treturn this.#message.text.length > 0;\n\t}\n\n\t#hasAttach(): boolean\n\t{\n\t\treturn this.#message.attach.length > 0;\n\t}\n\n\t#isEmptyMessage(): boolean\n\t{\n\t\treturn !this.#hasText() && !this.#hasFiles() && !this.#hasAttach();\n\t}\n\n\t#isDeletedMessage(): boolean\n\t{\n\t\treturn this.#message.isDeleted || this.#isEmptyMessage();\n\t}\n\n\t#isSystemMessage(): boolean\n\t{\n\t\treturn this.#message.authorId === 0;\n\t}\n\n\t#isEmojiOnly(): boolean\n\t{\n\t\tif (this.#message.replyId > 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.#isForward())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this.#hasOnlyText())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn Utils.text.isEmojiOnly(this.#message.text);\n\t}\n\n\t#hasSmilesOnly(): boolean\n\t{\n\t\tif (this.#message.replyId > 0)\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (this.#isForward())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\tif (!this.#hasOnlyText())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\t// todo: need to sync with getSmileRatio in lib/parser/src/functions/smile.js\n\t\tconst smileManager = SmileManager.getInstance();\n\t\tconst smiles = smileManager.smileList?.smiles ?? [];\n\t\tconst sortedSmiles = [...smiles].sort((a, b) => {\n\t\t\treturn b.typing.localeCompare(a.typing);\n\t\t});\n\t\tconst pattern = sortedSmiles.map((smile) => {\n\t\t\treturn Utils.text.escapeRegex(smile.typing);\n\t\t}).join('|');\n\n\t\tconst replacedText = this.#message.text.replaceAll(new RegExp(pattern, 'g'), '');\n\t\tconst hasOnlySmiles = replacedText.trim().length === 0;\n\n\t\tconst matchOnlySmiles = new RegExp(`(?:(?:${pattern})\\\\s*){4,}`);\n\n\t\treturn hasOnlySmiles && !matchOnlySmiles.test(this.#message.text);\n\t}\n\n\t#hasOnlyText(): boolean\n\t{\n\t\tif (!this.#hasText())\n\t\t{\n\t\t\treturn false;\n\t\t}\n\n\t\treturn !this.#hasFiles() && !this.#hasAttach();\n\t}\n\n\t#isForward(): boolean\n\t{\n\t\treturn this.#store.getters['messages/isForward'](this.#message.id);\n\t}\n}\n"],"names":["serverComponentList","Set","MessageComponent","unsupported","chatCreation","ownChatCreation","conferenceCreation","callInvite","copilotCreation","copilotMessage","supportVote","supportSessionNumber","supportChatCreation","zoomInvite","copilotAddedUsers","supervisorUpdateFeature","supervisorEnableFeature","sign","checkIn","generalChatCreationMessage","generalChannelCreationMessage","channelCreationMessage","callMessage","voteMessage","MessageComponentManager","constructor","message","Core","getStore","getName","openLinesManager","OpenLinesMessageManager","checkComponentInOpenLinesList","getMessageComponent","deleted","componentId","system","file","smile","default","has","files","length","text","attach","isDeleted","authorId","replyId","Utils","isEmojiOnly","smileManager","SmileManager","getInstance","smiles","smileList","sortedSmiles","sort","a","b","typing","localeCompare","pattern","map","escapeRegex","join","replacedText","replaceAll","RegExp","hasOnlySmiles","trim","matchOnlySmiles","test","getters","id"],"mappings":"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"}