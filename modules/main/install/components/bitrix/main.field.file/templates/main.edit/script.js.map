{"version":3,"file":"script.js","sources":["src/components/inputmanager.js","src/components/main.js","src/app.js"],"sourcesContent":["export const InputManager = {\n\tprops: {\n\t\tcontrolId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tcontrolName: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tmultiple: {\n\t\t\ttype: Boolean,\n\t\t\trequired: true,\n\t\t},\n\t\tfilledValues: {\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t},\n\tdata()\n\t{\n\t\treturn {\n\t\t\tvalues: this.filledValues,\n\t\t\tdeletedValues: [],\n\t\t};\n\t},\n\tmethods: {\n\t\tfireChange()\n\t\t{\n\t\t\tBX.fireEvent(this.$refs.valueChanger, \"change\");\n\t\t},\n\t\tsetValues(values: Array)\n\t\t{\n\t\t\tconst prevValues = this.values;\n\t\t\tthis.values = [ ...this.filledValues,  ...values]\n\t\t\t\t.filter((value, index, array) => array.indexOf(value) === index);\n\t\t\tif (!this.arraysAreEqual(prevValues, this.values))\n\t\t\t{\n\t\t\t\tthis.fireChange();\n\t\t\t}\n\t\t},\n\t\taddDeleted(fileId: Number)\n\t\t{\n\t\t\tthis.deletedValues = [...this.deletedValues, fileId];\n\t\t\tthis.fireChange();\n\t\t},\n\t\tremoveValue(fileId: Number)\n\t\t{\n\t\t\tconst index = this.values.indexOf(fileId);\n\t\t\tif (index >= 0)\n\t\t\t{\n\t\t\t\tthis.values.splice(index, 1);\n\t\t\t\tthis.fireChange();\n\t\t\t}\n\t\t},\n\t\tarraysAreEqual(a: Array, b: Array): boolean\n\t\t{\n\t\t\tif (a.length !== b.length)\n\t\t\t{\n\t\t\t\treturn false;\n\t\t\t}\n\n\t\t\tfor (let i = 0; i > a.length; i++)\n\t\t\t{\n\t\t\t\tif (a[i] !== b[i])\n\t\t\t\t{\n\t\t\t\t\treturn false;\n\t\t\t\t}\n\t\t\t}\n\t\t\treturn true;\n\t\t},\n\t},\n\ttemplate: `\n\t\t<input ref=\"valueChanger\" type=\"hidden\" />\n\t\t<div class=\"uf-hidden-inputs\" style=\"display: none;\">\n\t\t\t<div v-if=\"Object.hasOwn(this.values, '0')\">\n\t\t\t\t<input v-if=\"this.multiple\" v-for=\"(el, index) in values\" :key=\"index\" type=\"hidden\"\n\t\t\t\t\t   :name=\"controlName + '[]'\"\n\t\t\t\t\t   :value=\"values[index]\"/>\n\t\t\t\t<input v-else type=\"hidden\" :name=\"controlName\" :value=\"values[values.length - 1]\" />\n\t\t\t</div>\n\t\t\t<div v-else>\n\t\t\t\t<input type=\"hidden\" :name=\"this.multiple ? controlName + '[]' : controlName\" />\n\t\t\t</div>\n            <div v-if=\"Object.hasOwn(this.deletedValues, '0')\">\n\t\t\t\t<input v-if=\"this.multiple\" v-for=\"(el, index) in deletedValues\" :key=\"index\" type=\"hidden\"\n\t\t\t\t\t   :name=\"controlName + '_del' + '[]'\"\n\t\t\t\t\t   :value=\"deletedValues[index]\"/>\n\t\t\t\t<input v-else type=\"hidden\" :name=\"controlName + '_del'\" :value=\"deletedValues[0]\" />\n\t\t\t\t<input v-for=\"(el, index) in deletedValues\" :key=\"index\" type=\"hidden\"\n\t\t\t\t\t   :name=\"controlId + '_deleted' + '[]'\"\n\t\t\t\t\t   :value=\"deletedValues[index]\" />\n\t\t\t</div>\n\t\t</div>\n\t`,\n};\n","import { Type } from 'main.core';\nimport { TileWidgetComponent } from 'ui.uploader.tile-widget';\nimport { InputManager } from './inputmanager';\n\nexport {Main, AppContext};\n\ndeclare type AppContext = {\n\tid: number,\n\tentityId: string,\n\tfieldName: string,\n\tmultiple: boolean,\n};\n\nconst Main = {\n\tdata()\n\t{\n\t\tconst data =  {\n\t\t\tfileTokens: [],\n\t\t};\n\n\t\treturn this.getPreparedData(data);\n\t},\n\tprops: {\n\t\tcontrolId: {\n\t\t\ttype: String,\n\t\t\trequired: true,\n\t\t},\n\t\tcontainer: {\n\t\t\ttype: HTMLElement,\n\t\t\trequired: true,\n\t\t},\n\t\tcontext: {\n\t\t\ttype: Object,\n\t\t\trequired: true,\n\t\t},\n\t\tfilledValues: {\n\t\t\ttype: Object,\n\t\t},\n\t},\n\tcomponents: {\n\t\tInputManager,\n\t\tTileWidgetComponent,\n\t},\n\tcomputed: {\n\t\tuploaderOptions()\n\t\t{\n\t\t\treturn {\n\t\t\t\tcontroller: 'main.fileUploader.fieldFileUploaderController',\n\t\t\t\tcontrollerOptions: this.context,\n\t\t\t\tfiles: this.fileTokens,\n\t\t\t\tevents: {\n\t\t\t\t\tonUploadComplete: () => {\n\t\t\t\t\t\tvoid this.$nextTick(() => {\n\t\t\t\t\t\t\tthis.fileTokens = this.getFileIdList();\n\t\t\t\t\t\t});\n\t\t\t\t\t},\n\t\t\t\t\t\"File:onRemove\": (event) => {\n\t\t\t\t\t\tconst eventData = event.getData();\n\t\t\t\t\t\tif (Type.isObject(eventData) && Type.isObject(eventData[\"file\"]))\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconst file = eventData[\"file\"];\n\t\t\t\t\t\t\tif (Type.isObject(file))\n\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\tconst fileId = file.getServerFileId();\n\t\t\t\t\t\t\t\tif (Type.isNumber(fileId))\n\t\t\t\t\t\t\t\t{\n\t\t\t\t\t\t\t\t\tthis.$refs.inputManager.addDeleted(fileId);\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t\telse {\n\t\t\t\t\t\t\t\t\tthis.$refs.inputManager.addDeleted(this.getRealFileId(file));\n\t\t\t\t\t\t\t\t}\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t}\n\t\t\t\t\t},\n\t\t\t\t},\n\t\t\t\tmultiple: this.context.multiple,\n\t\t\t\tautoUpload: true,\n\t\t\t\ttreatOversizeImageAsFile: true,\n\t\t\t};\n\t\t},\n\t\twidgetOptions(): Object\n\t\t{\n\t\t\treturn {};\n\t\t},\n\t},\n\tmethods: {\n\t\tgetPreparedData(data: Object): Object\n\t\t{\n\t\t\tconst { filledValues } = this;\n\n\t\t\tif (Type.isArrayFilled(filledValues))\n\t\t\t{\n\t\t\t\tdata.fileTokens = filledValues;\n\t\t\t}\n\n\t\t\treturn data;\n\t\t},\n\t\tgetFileIdList(): number[]\n\t\t{\n\t\t\tconst ids = [];\n\n\t\t\tthis.$refs.uploader.uploader.getFiles().forEach((file) => {\n\t\t\t\tif (file.isComplete())\n\t\t\t\t{\n\t\t\t\t\tconst realFileId = this.getRealFileId(file);\n\t\t\t\t\tif (Type.isNumber(realFileId))\n\t\t\t\t\t{\n\t\t\t\t\t\tids.push(realFileId);\n\t\t\t\t\t}\n\t\t\t\t\telse\n\t\t\t\t\t{\n\t\t\t\t\t\tids.push(file.getServerFileId());\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t});\n\n\t\t\treturn ids;\n\t\t},\n\t\tgetRealFileId(file: Object) {\n\t\t\tconst { realFileId } = file.getCustomData();\n\n\t\t\treturn Type.isNumber(realFileId) ? realFileId : null;\n\t\t},\n\t\tupdateInputManagerValues(): void\n\t\t{\n\t\t\tthis.$refs.inputManager.setValues(this.fileTokens);\n\t\t},\n\t},\n\ttemplate: `\n\t<div class=\"main-field-file-wrapper\">\n\t\t<InputManager\n\t\t\tref=\"inputManager\"\n\t\t\t:controlId=\"controlId\"\n\t\t\t:controlName=\"context.fieldName\"\n\t\t\t:multiple=\"context.multiple\"\n\t\t\t:filledValues=\"filledValues\"\n\t\t/>\n\t\t<TileWidgetComponent\n\t\t\tref=\"uploader\"\n\t\t\t:uploaderOptions=\"uploaderOptions\"\n\t\t\t:widgetOptions=\"widgetOptions\"\n\t\t/>\n\t</div>`,\n\tcreated()\n\t{\n\t\tthis.$watch(\n\t\t\t'fileTokens',\n\t\t\tthis.updateInputManagerValues,\n\t\t\t{\n\t\t\t\tdeep: true,\n\t\t\t},\n\t\t);\n\t},\n};\n","import { Type } from 'main.core';\nimport { BitrixVue, VueCreateAppResult } from 'ui.vue3';\nimport { Main, AppContext } from './components/main';\n\ndeclare type AppConstructorParams = {\n\tcontainerId: string,\n\tcontext: AppContext,\n\tvalue: Array,\n};\n\nexport class App\n{\n\t#controlId: string;\n\t#container: HTMLElement;\n\t#context: AppContext;\n\t#value: Array;\n\n\t#app: ?VueCreateAppResult = null;\n\n\tconstructor(params: AppConstructorParams)\n\t{\n\t\tthis.#controlId = params.controlId;\n\t\tthis.#container = document.getElementById(params.containerId);\n\n\t\tif (!Type.isDomNode(this.#container))\n\t\t{\n\t\t\tthrow new Error('container not found');\n\t\t}\n\t\t\n\t\tthis.#context = params.context;\n\t\tthis.#value = params.value.map((value) => { return parseInt(value); });\n\t}\n\n\tstart(): void\n\t{\n\t\tthis.#app = BitrixVue.createApp(\n\t\t\t{\n\t\t\t\t...Main\n\t\t\t},\n\t\t\t{\n\t\t\t\tcontrolId: this.#controlId,\n\t\t\t\tcontainer: this.#container,\n\t\t\t\tcontext: this.#context,\n\t\t\t\tfilledValues: this.#value,\n\t\t\t},\n\t\t);\n\n\t\tthis.#app.mount(this.#container);\n\t}\n\n\tstop(): void\n\t{\n\t\tthis.#app.unmount();\n\n\t\tthis.#app = null;\n\t}\n}\n"],"names":["InputManager","props","controlId","type","String","required","controlName","multiple","Boolean","filledValues","Object","data","values","deletedValues","methods","fireChange","BX","fireEvent","$refs","valueChanger","setValues","prevValues","filter","value","index","array","indexOf","arraysAreEqual","addDeleted","fileId","removeValue","splice","a","b","length","i","template","Main","fileTokens","getPreparedData","container","HTMLElement","context","components","TileWidgetComponent","computed","uploaderOptions","controller","controllerOptions","files","events","onUploadComplete","$nextTick","getFileIdList","event","eventData","getData","Type","isObject","file","getServerFileId","isNumber","inputManager","getRealFileId","autoUpload","treatOversizeImageAsFile","widgetOptions","isArrayFilled","ids","uploader","getFiles","forEach","isComplete","realFileId","push","getCustomData","updateInputManagerValues","created","$watch","deep","App","params","document","getElementById","containerId","isDomNode","Error","map","parseInt","BitrixVue","createApp","mount","unmount"],"mappings":"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"}