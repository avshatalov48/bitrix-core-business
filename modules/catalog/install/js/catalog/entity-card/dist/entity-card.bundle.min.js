this.BX=this.BX||{};this.BX.Catalog=this.BX.Catalog||{};(function(e,t,i,n,r,a){"use strict";var s=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.id=a.Type.isStringFilled(t)?t:a.Text.getRandom();this.settings=a.Type.isObjectLike(i)?i:{};this.container=this.settings.container;if(!this.container){throw"Error: Could not find container."}this.serviceUrl=this.settings.serviceUrl||"";if(!a.Type.isStringFilled(this.serviceUrl)){throw"Error. Could not find service url."}this.tabId=this.settings.tabId||"";if(!a.Type.isStringFilled(this.tabId)){throw"Error: Could not find tab id."}this.params=a.Type.isObjectLike(this.settings.componentData)?this.settings.componentData:{};this.isRequestRunning=false;this.loaded=false}babelHelpers.createClass(e,[{key:"isLoaded",value:function e(){return this.loaded}},{key:"load",value:function e(){if(!this.isLoaded()){this.startRequest(babelHelpers.objectSpread({},this.params,{TABID:this.tabId}))}}},{key:"startRequest",value:function e(t){if(this.isRequestRunning){return false}this.isRequestRunning=true;BX.ajax({url:this.serviceUrl,method:"POST",dataType:"html",data:{LOADERID:this.id,PARAMS:t},onsuccess:this.onRequestSuccess.bind(this),onfailure:this.onRequestFailure.bind(this)});return true}},{key:"onRequestSuccess",value:function e(t){this.isRequestRunning=false;this.container.innerHTML=t;this.loaded=true}},{key:"onRequestFailure",value:function e(){this.isRequestRunning=false;this.loaded=true}}]);return e}();var l=function(){function e(t,i){babelHelpers.classCallCheck(this,e);this.id=a.Type.isStringFilled(t)?t:a.Text.getRandom();this.settings=a.Type.isObjectLike(i)?i:{};this.data=a.Type.isObjectLike(this.settings.data)?this.settings.data:{};this.manager=i.manager||null;this.container=this.settings.container;this.menuContainer=this.settings.menuContainer;this.active=a.Type.isBoolean(this.data.active)?this.data.active:false;this.enabled=a.Type.isBoolean(this.data.enabled)?this.data.enabled:true;a.Event.bind(this.menuContainer.querySelector("a.catalog-entity-section-tab-link"),"click",this.onMenuClick.bind(this));this.loader=null;if(a.Type.isObjectLike(this.data.loader)){this.loader=new s(this.id,babelHelpers.objectSpread({},this.data.loader,{tabId:this.id,container:this.container}))}}babelHelpers.createClass(e,[{key:"isEnabled",value:function e(){return this.enabled}},{key:"isActive",value:function e(){return this.active}},{key:"setActive",value:function e(t){t=!!t;if(this.isActive()===t){return}this.active=t;if(this.isActive()){this.showTab()}else{this.hideTab()}}},{key:"showTab",value:function e(){var t=this;a.Dom.addClass(this.container,"catalog-entity-section-tab-content-show");a.Dom.removeClass(this.container,"catalog-entity-section-tab-content-hide");a.Dom.addClass(this.menuContainer,"catalog-entity-section-tab-current");this.container.style.display="";this.container.style.position="absolute";this.container.style.top=0;this.container.style.left=0;this.container.style.width="100%";new BX.easing({duration:350,start:{opacity:0,translateX:100},finish:{opacity:100,translateX:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function e(i){t.container.style.opacity=i.opacity/100;t.container.style.transform="translateX("+i.translateX+"%)"},complete:function e(){a.Dom.removeClass(t.container,"catalog-entity-section-tab-content-show");t.container.style.cssText="";a.Event.EventEmitter.emit(window,"onEntityDetailsTabShow",[t])}}).animate()}},{key:"hideTab",value:function e(){var t=this;a.Dom.addClass(this.container,"catalog-entity-section-tab-content-hide");a.Dom.removeClass(this.container,"catalog-entity-section-tab-content-show");a.Dom.removeClass(this.menuContainer,"catalog-entity-section-tab-current");new BX.easing({duration:350,start:{opacity:100},finish:{opacity:0},transition:BX.easing.makeEaseOut(BX.easing.transitions.quart),step:function e(i){t.container.style.opacity=i.opacity/100},complete:function e(){t.container.style.display="none";t.container.style.transform="translateX(100%)";t.container.style.opacity=0}}).animate()}},{key:"onMenuClick",value:function e(t){if(this.isEnabled()){if(this.loader&&!this.loader.isLoaded()){this.loader.load()}this.manager.selectItem(this)}t.preventDefault()}}]);return e}();var o=function(){function e(t,i){var n=this;babelHelpers.classCallCheck(this,e);this.id=a.Type.isStringFilled(t)?t:a.Text.getRandom();this.settings=a.Type.isObjectLike(i)?i:{};this.container=this.settings.container;this.menuContainer=this.settings.menuContainer;this.items=[];if(a.Type.isArray(this.settings.data)){this.settings.data.forEach(function(e){n.items.push(new l(e.id,{manager:n,data:e,container:n.container.querySelector('[data-tab-id="'+e.id+'"]'),menuContainer:n.menuContainer.querySelector('[data-tab-id="'+e.id+'"]')}))})}}babelHelpers.createClass(e,[{key:"findItemById",value:function e(t){return this.items.find(function(e){return e.id===t})||null}},{key:"selectItem",value:function e(t){this.items.forEach(function(e){return e.setActive(e===t)})}}]);return e}();function u(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t\t<span class="ui-tile-selector-selector-wrap readonly">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</span>\n\t\t\t\t</div>"]);u=function t(){return e};return e}function d(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<span class="ui-tile-selector-item ui-tile-selector-item-readonly-yes">\n\t\t\t\t\t\t<span data-role="tile-item-name">',"</span>\n\t\t\t\t\t</span>\n\t\t\t\t"]);d=function t(){return e};return e}function c(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);c=function t(){return e};return e}function h(){var e=babelHelpers.taggedTemplateLiteral(['<div class="ui-entity-editor-content-block"></div>']);h=function t(){return e};return e}function p(){var e=babelHelpers.taggedTemplateLiteral(['<input type="hidden" name="','[]" value="0">']);p=function t(){return e};return e}var f=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));n.initialize(e,i);n.innerWrapper=null;n.tileSelector=null;return n}babelHelpers.createClass(t,[{key:"getContentWrapper",value:function e(){return this.innerWrapper}},{key:"layout",value:function e(){var t=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(this._hasLayout){return}this.ensureWrapperCreated({classNames:["catalog-entity-editor-content-block-field-iblock-section"]});this.adjustWrapper();if(this.isNeedToDisplay()){this._wrapper.appendChild(this.createTitleNode(this.getTitle()));if(this._mode===BX.UI.EntityEditorMode.edit){this.drawEditMode()}else{this.drawViewMode()}if(this.isContextMenuEnabled()){this._wrapper.appendChild(this.createContextMenuButton())}}this.registerLayout(t);this._hasLayout=true}},{key:"drawEditMode",value:function e(){this.defaultInput=a.Tag.render(p(),this.getName());this._wrapper.appendChild(this.defaultInput);this.innerWrapper=a.Tag.render(h());this._wrapper.appendChild(this.innerWrapper);a.ajax.runComponentAction("bitrix:catalog.productcard.iblocksectionfield","lazyLoad",{mode:"ajax",data:{iblockId:this.getIblockId(),productId:this.getProductId(),selectedSectionIds:this.getValue()}}).then(this.renderFromResponse.bind(this)).catch(function(e){throw new Error(e.errors.join("\n"))})}},{key:"renderFromResponse",value:function e(t){if(!this._wrapper){return}a.Runtime.html(this.innerWrapper,t.data.html,{callback:this.initTileSelector.bind(this)})}},{key:"initTileSelector",value:function e(){if(BX.UI&&BX.UI.TileSelector){this.tileSelector=BX.UI.TileSelector.getById(this.getTileSelectorId());if(!this.tileSelector){throw new Error("Tile selector `"+this.getTileSelectorId()+"` not found.")}if(this.tileSelector){this.changeDisplay(this.tileSelector.buttonAdd,false)}n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.buttonSelectFirst,this.tileSelectorSelectFirstHandler.bind(this));n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.input,this.onInputSearch.bind(this));n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.buttonAdd,this.onButtonAdd.bind(this));n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.buttonSelect,this.onButtonSelect.bind(this));n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.tileAdd,this.markAsChanged.bind(this));n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.tileRemove,this.markAsChanged.bind(this));n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.search,this.onInputEnd.bind(this));n.EventEmitter.subscribe(this.tileSelector,this.tileSelector.events.searcherInit,this.onSearcherInit.bind(this));a.Event.bind(this.tileSelector.input,"blur",this.onBlur.bind(this));if(this.tileSelector.buttonAdd){this.tileSelector.buttonAdd.style.top="auto";this.tileSelector.buttonAdd.style.bottom=0}}}},{key:"changeDisplay",value:function e(t,i){if(!t){return}t.style.display=i?"":"none"}},{key:"markAsChanged",value:function e(i){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"markAsChanged",this).call(this);n.EventEmitter.emit(this.getEditor(),"IblockSectionField:onChange",[this].concat(babelHelpers.toConsumableArray(i.getData())))}},{key:"onBlur",value:function e(){var t=this;window.setTimeout(function(){t.tileSelector.onInputEnd()},500)}},{key:"onSearcherInit",value:function e(t){var i=t.getData(),n=babelHelpers.slicedToArray(i,1),r=n[0];var a=BX.PopupWindowManager.getPopupById(r.id);if(a){a.destroy()}if(r.categoryContainer){r.categoryContainer.parentNode.removeChild(r.categoryContainer)}}},{key:"onInputEnd",value:function e(){this.changeDisplay(this.tileSelector.buttonAdd,false)}},{key:"getTileSelectorId",value:function e(){var t=this.getIblockId()||0;var i=this.getProductId()||0;return"catalog-iblocksectionfield-".concat(t,"-").concat(i)}},{key:"onButtonSelect",value:function e(){if(this.tileSelector){this.tileSelector.showSearcher()}}},{key:"onButtonAdd",value:function e(){if(!BX.type.isNotEmptyString(this.tileSelector.input.value)){return}a.ajax.runComponentAction("bitrix:catalog.productcard.iblocksectionfield","addSection",{mode:"ajax",data:{iblockId:this.getIblockId(),name:this.tileSelector.input.value}}).then(this.onAddSection.bind(this)).catch(function(e){throw new Error(e.errors.join("\n"))})}},{key:"onAddSection",value:function e(t){var i=this.tileSelector.searcher.addItem("all",t.data.id,t.data.name);this.tileSelector.searcher.onItemClick(i);if(this.tileSelector.searcher.popup){this.tileSelector.searcher.popup.destroy();this.tileSelector.searcher.popup=null}this.changeDisplay(i.node,false);this.tileSelector.onInputEnd();this.onInputEnd()}},{key:"onInputSearch",value:function e(){var t=this.tileSelector.input.value;var i=new RegExp(BX.util.escapeRegExp(t),"i");if(!this.tileSelector.searcher){return}var n=this.tileSelector.searcher.items.filter(function(e){return i.test(e.name)});if(n.length===0){this.changeDisplay(this.tileSelector.buttonAdd,true);this.tileSelector.searcher.hide()}else{this.changeDisplay(this.tileSelector.buttonAdd,false);this.tileSelector.searcher.show()}}},{key:"tileSelectorSelectFirstHandler",value:function e(){var t=this;a.ajax.runComponentAction("bitrix:catalog.productcard.iblocksectionfield","getSections",{mode:"ajax",data:{iblockId:this.getIblockId()}}).then(function(e){t.tileSelector.setSearcherData(e.data||[])}).catch(this.tileSelector.hideSearcher.bind(this.tileSelector))}},{key:"drawViewMode",value:function e(){if(this.hasNoSections()){this.innerWrapper=a.Tag.render(c(),a.Loc.getMessage("CATALOG_ENTITY_CARD_EMPTY_SECTION"));a.Dom.addClass(this._wrapper,"ui-entity-editor-content-block-click-empty")}else{var t=[];Object.entries(this.getSections()).forEach(function(e){var i=babelHelpers.slicedToArray(e,2),n=i[0],r=i[1];t.push(a.Tag.render(d(),a.Text.encode(r)))});this.innerWrapper=a.Tag.render(u(),t)}this._wrapper.appendChild(this.innerWrapper)}},{key:"getSections",value:function e(){return this._model.getField("IBLOCK_SECTION_DATA",{})}},{key:"getIblockId",value:function e(){return this._model.getField("IBLOCK_ID",0)}},{key:"getProductId",value:function e(){return this._model.getField("ID",0)}},{key:"hasNoSections",value:function e(){var t=this.getValue();return t.length===0||t.length===1&&(t.includes("0")||t.includes(0))}},{key:"doClearLayout",value:function e(t){if(this.tileSelector){n.EventEmitter.unsubscribeAll(this.tileSelector,this.tileSelector.events.buttonSelect);n.EventEmitter.unsubscribeAll(this.tileSelector,this.tileSelector.events.buttonSelectFirst);n.EventEmitter.unsubscribeAll(this.tileSelector,this.tileSelector.events.tileAdd);n.EventEmitter.unsubscribeAll(this.tileSelector,this.tileSelector.events.tileRemove);n.EventEmitter.unsubscribeAll(this.tileSelector,this.tileSelector.events.searcherInit);n.EventEmitter.unsubscribeAll(this.tileSelector,this.tileSelector.events.search);n.EventEmitter.unsubscribeAll(this.tileSelector,this.tileSelector.events.buttonAdd)}if(this.defaultInput){a.Dom.clean(this.defaultInput);this.defaultInput=null}if(this.innerWrapper){a.Dom.clean(this.innerWrapper);this.innerWrapper=null}this._hasLayout=false}},{key:"getModeSwitchType",value:function e(t){var i=BX.UI.EntityEditorModeSwitchType.common;if(t===BX.UI.EntityEditorMode.edit){i|=BX.UI.EntityEditorModeSwitchType.button|BX.UI.EntityEditorModeSwitchType.content}return i}}]);return t}(BX.UI.EntityEditorField);var m=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);n.EventEmitter.subscribe("BX.UI.EntityEditorControlFactory:onInitialize",function(e){var i=e.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];r.methods["entityCard"]=t.factory.bind(t)})}babelHelpers.createClass(e,[{key:"factory",value:function e(t,i,n){if(t==="iblock_section"){return new f(i,n)}return null}}]);return e}();var g="PROPERTY_";var b="properties";var y=function(e){babelHelpers.inherits(t,e);function t(e,i){var r;babelHelpers.classCallCheck(this,t);r=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));r.initialize(e,i);r.isRequesting=false;r.clearServiceFields();n.EventEmitter.subscribe(r._editor,"IblockSectionField:onChange",r.onChangeHandler.bind(babelHelpers.assertThisInitialized(r)));n.EventEmitter.subscribe(r._editor,"BX.UI.EntityEditor:onFieldCreate",r.onFieldAdd.bind(babelHelpers.assertThisInitialized(r)));n.EventEmitter.subscribe(r._editor,"BX.UI.EntityEditor:onFieldModify",r.onFieldUpdate.bind(babelHelpers.assertThisInitialized(r)));return r}babelHelpers.createClass(t,[{key:"clearServiceFields",value:function e(){this.lastDataHash=null;this.initialElements=null;this.deletedControls={};this.deletedAvailableSchemes={}}},{key:"onChangeHandler",value:function e(t){var i=this;var n=t.getData(),r=babelHelpers.slicedToArray(n,1),a=r[0];var s=a.tileSelector.list.map(function(e){return e.id});var l=JSON.stringify(s);if(this.lastDataHash===null||this.lastDataHash!==l){this.lastDataHash=l;clearTimeout(this.timeout);this.timeout=setTimeout(function(){i.refreshLinkedProperties(s)},50)}}},{key:"onFieldAdd",value:function e(t){var i=this;var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,2),s=r[0],l=r[1];var o=this.getFieldsForm(l);a.ajax.runComponentAction(this._editor._settings.ajaxData.COMPONENT_NAME,"addProperty",{mode:"class",signedParameters:this._editor._settings.ajaxData.SIGNED_PARAMETERS,data:o}).then(function(e){var t=i._editor.getSchemeElementByName(b);var n=e.data.PROPERTY_FIELDS;if(!t||!n){return}var r=e.data.ADDITIONAL_VALUES;if(r){var a=i._editor._model;for(var o=0,u=Object.entries(r);o<u.length;o++){var d=babelHelpers.slicedToArray(u[o],2),c=d[0],h=d[1];a.setField(c,h)}}var p=BX.UI.EntityEditorMode.view;if(s instanceof BX.UI.EntityEditorSection){p=s.getMode()}var f=i.createProperty(n,{layout:{notifyIfNotDisplayed:true,forceDisplay:l.showAlways},mode:p});f.toggleOptionFlag(l.showAlways);i._editor.saveSchemeChanges();i.isRequesting=false}).catch(function(e){i.isRequesting=false})}},{key:"onFieldUpdate",value:function e(t){var i=this;var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,2),s=r[0],l=r[1];if(!(l.field instanceof BX.UI.EntityEditorControl)){return}var o=l.field;l.CODE=o.getId();var u=this.getFieldsForm(l);var d=o.getSchemeElement();d._isRequired=l.mandatory;a.ajax.runComponentAction(this._editor._settings.ajaxData.COMPONENT_NAME,"updateProperty",{mode:"class",signedParameters:this._editor._settings.ajaxData.SIGNED_PARAMETERS,data:u}).then(function(e){if(o instanceof BX.UI.EntityEditorDatetime||o instanceof BX.UI.EntityEditorMultiDatetime){var t=o.getSchemeElement().getData();t.enableTime=l.enableTime}var n=null;var r=null;if(l.multiple===true){if(o instanceof BX.UI.EntityEditorText){n="multitext"}else if(o instanceof BX.UI.EntityEditorList){n="multilist"}else if(o instanceof BX.UI.EntityEditorDatetime){n="multidatetime"}else if(o instanceof BX.UI.EntityEditorNumber){n="multinumber"}}else{if(o instanceof BX.UI.EntityEditorMultiList){n="list"}else if(o instanceof BX.UI.EntityEditorMultiDatetime){n="datetime"}else if(o instanceof BX.UI.EntityEditorMultiNumber){n="number"}else if(o instanceof BX.UI.EntityEditorMultiText){n="text"}r=o.getSchemeElement()}var a=e.data.PROPERTY_FIELDS;if((o instanceof BX.UI.EntityEditorList||o instanceof BX.UI.EntityEditorMultiList)&&a){r=BX.UI.EntitySchemeElement.create(a);n=a.type}if(n){var u=s.getChildIndex(o);var d=i._editor.createControl(n,l.CODE,{schemeElement:r,model:s._model,parent:s,mode:s.getMode()});s.addChild(d,{index:u,layout:{forceDisplay:true},enableSaving:false});s.removeChild(o,{enableSaving:false})}i.isRequesting=false}).catch(function(e){i.isRequesting=false})}},{key:"getFieldsForm",value:function e(t){var i=this;var n=new FormData;var r={NAME:t.label,MULTIPLE:t.multiple?"Y":"N",IS_REQUIRED:t.mandatory?"Y":"N",PROPERTY_TYPE:"S",CODE:t.CODE||""};switch(t.typeId){case"integer":case"double":r.PROPERTY_TYPE="N";break;case"list":case"multilist":r.PROPERTY_TYPE="L";t.enumeration.forEach(function(e,t){n.append(i.getFormFieldName("VALUES]["+t+"][SORT"),e.SORT);n.append(i.getFormFieldName("VALUES]["+t+"][VALUE"),e.VALUE);n.append(i.getFormFieldName("VALUES]["+t+"][ID"),e.ID)});break;case"directory":r.USER_TYPE="directory";t.enumeration.forEach(function(e,t){n.append(i.getFormFieldName("VALUES]["+t+"][SORT"),e.SORT);n.append(i.getFormFieldName("VALUES]["+t+"][VALUE"),e.VALUE.value);n.append(i.getFormFieldName("VALUES]["+t+"][XML_ID"),e.XML_ID);n.append(i.getFormFieldName("VALUES]["+t+"][FILE_ID"),e.FILE_ID);n.append("FILES["+e.SORT+"]",e.VALUE.file)});break;case"boolean":r.PROPERTY_TYPE="L";n.append(this.getFormFieldName("VALUES][0][VALUE"),"Y");r.LIST_TYPE="C";break;case"money":r.USER_TYPE="Money";break;case"address":r.USER_TYPE="map_google";break;case"datetime":case"multidatetime":r.USER_TYPE=t.enableTime===true?"DateTime":"Date";break;case"file":r.USER_TYPE="DiskFile";break}for(var a=0,s=Object.entries(r);a<s.length;a++){var l=babelHelpers.slicedToArray(s[a],2),o=l[0],u=l[1];n.append(this.getFormFieldName(o),u)}return n}},{key:"getFormFieldName",value:function e(t){return"fields["+t+"]"}},{key:"refreshLinkedProperties",value:function e(t){var i=this;if(this.isRequesting){return}this.isRequesting=true;a.ajax.runComponentAction(this._editor._settings.ajaxData.COMPONENT_NAME,"refreshLinkedProperties",{mode:"class",signedParameters:this._editor._settings.ajaxData.SIGNED_PARAMETERS,data:{sectionIds:t}}).then(function(e){var t=i.getAllCurrentProperties();if(i.initialElements===null){i.initialElements=babelHelpers.toConsumableArray(t)}e.data.ENTITY_FIELDS.forEach(function(e){if(!t.includes(e.name)){i.addProperty(e,{layout:{forceDisplay:true},mode:BX.UI.EntityEditorMode.edit})}});var n=e.data.ENTITY_FIELDS.map(function(e){return e.name});t.forEach(function(e){if(!n.includes(e)){i.removeProperty(e)}});i._editor.commitSchemeChanges();i.isRequesting=false}).catch(function(e){i.isRequesting=false})}},{key:"getAllCurrentProperties",value:function e(){var t=this._editor.getAllControls().filter(function(e){return e.getName().indexOf(g)===0}).map(function(e){return e.getName()});var i=this._editor.getAvailableSchemeElements().filter(function(e){return e.getName().indexOf(g)===0}).map(function(e){return e.getName()});return[].concat(babelHelpers.toConsumableArray(t),babelHelpers.toConsumableArray(i))}},{key:"addProperty",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};if(t.name in this.deletedControls){this.restoreDeletedProperty(this.deletedControls[t.name],i)}else if(t.name in this.deletedAvailableSchemes){this.restoreDeletedAvailableProperty(this.deletedAvailableSchemes[t.name],i)}else{this.createProperty(t,i)}}},{key:"restoreDeletedProperty",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=i.mode||t._mode;t._mode=n;t.getParent().addChild(t,babelHelpers.objectSpread({},i,{enableSaving:false}));if(n===BX.UI.EntityEditorMode.edit){this._editor.registerActiveControl(t)}else if(n===BX.UI.EntityEditorMode.view){this._editor.unregisterActiveControl(t)}}},{key:"restoreDeletedAvailableProperty",value:function e(t){this._editor.addAvailableSchemeElement(t)}},{key:"createProperty",value:function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};var n=this._editor.getSchemeElementByName(b);var r=BX.UI.EntitySchemeElement.create(t);n._elements.push(r);var a=i.mode||BX.UI.EntityEditorMode.edit;var s=this._editor.createControl(r.getType(),r.getName(),{schemeElement:r,model:this._model,parent:this,mode:a});if(!s){return}var l=this._editor.getControlById(b);l.addChild(s,babelHelpers.objectSpread({},i,{enableSaving:false}));return s}},{key:"removeProperty",value:function e(t){var i=this._editor.getControlByIdRecursive(t);if(i){this.deletedControls[i.getName()]=i;i.getParent().removeChild(i,{enableSaving:false});this._editor.removeAvailableSchemeElement(i.getSchemeElement());this._editor.unregisterActiveControl(i)}else{var n=this._editor.getAvailableSchemeElementByName(t);if(n){this.deletedAvailableSchemes[n.getName()]=n;this._editor.removeAvailableSchemeElement(n)}}}},{key:"rollback",value:function e(){var i=this;babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);if(this.initialElements===null){return}var n=this.getAllCurrentProperties();n.forEach(function(e){if(!i.initialElements.includes(e)){i.removeProperty(e)}});this.initialElements.forEach(function(e){if(!n.includes(e)){i.addProperty({name:e},{layout:{forceDisplay:false},mode:BX.UI.EntityEditorMode.view})}});this._editor.commitSchemeChanges();this.clearServiceFields()}}]);return t}(BX.UI.EntityEditorController);var E=function(e){babelHelpers.inherits(t,e);function t(e,i){var n;babelHelpers.classCallCheck(this,t);n=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).call(this));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(n),"areaHeight",null);n.initialize(e,i);return n}babelHelpers.createClass(t,[{key:"doInitialize",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"doInitialize",this).call(this);n.EventEmitter.subscribe("Grid::thereEditedRows",this.markAsChangedHandler.bind(this));n.EventEmitter.subscribe("Grid::noEditedRows",this.checkEditorToolbar.bind(this));n.EventEmitter.subscribe("Grid::updated",this.checkEditorToolbar.bind(this));n.EventEmitter.subscribe("Grid::beforeRequest",this.onBeforeGridRequest.bind(this));n.EventEmitter.subscribe("onAjaxSuccess",this.ajaxSuccessHandler.bind(this));n.EventEmitter.subscribe("BX.UI.EntityEditorIncludedArea:onBeforeLoad",this.onBeforeIncludedAreaLoaded.bind(this));n.EventEmitter.subscribe("BX.UI.EntityEditorIncludedArea:onAfterLoad",this.onAfterIncludedAreaLoaded.bind(this));this.subscribeToFormSubmit()}},{key:"onBeforeIncludedAreaLoaded",value:function e(t){if(a.Type.isNumber(this.areaHeight)){a.Dom.style(this.getVariationGridLoader(),"height",this.areaHeight+"px")}}},{key:"onAfterIncludedAreaLoaded",value:function e(t){a.Dom.style(this.getVariationGridLoader(),"height","");this.areaHeight=null}},{key:"getVariationGridLoader",value:function e(){var t=this.getGridControl();if(t){var i=t.getWrapper();if(i){return i.querySelector(".ui-entity-editor-included-area-container-loader")}}return null}},{key:"rollback",value:function e(){babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"rollback",this).call(this);this.checkEditorToolbar();this.unsubscribeGridEvents()}},{key:"onAfterSave",value:function e(){if(this.isChanged()){this.setGridControlCache(null)}this.subscribeToFormSubmit();babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"onAfterSave",this).call(this)}},{key:"setGridControlCache",value:function e(t){var i=this.getGridControl();if(i){i._loadedHtml=t}}},{key:"onBeforeSubmit",value:function e(){this.unsubscribeGridEvents()}},{key:"getVariationGridComponent",value:function e(){return a.Reflection.getClass("BX.Catalog.VariationGrid.Instance")}},{key:"unsubscribeGridEvents",value:function e(){var t=this.getVariationGridComponent();if(t){t.unsubscribeCustomEvents()}}},{key:"ajaxSuccessHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];if(r.url.indexOf(this.getReloadUrl())===0){this.setGridControlCache(null)}}},{key:"subscribeToFormSubmit",value:function e(){n.EventEmitter.subscribe(this._editor._ajaxForm,"onBeforeSubmit",this.onBeforeSubmitForm.bind(this))}},{key:"markAsChangedHandler",value:function e(){if(!this._editor.isNew()){this.markAsChanged()}}},{key:"checkEditorToolbar",value:function e(){this._isChanged=false;if(this._editor.getActiveControlCount()>0){this._editor.showToolPanel()}else{this._editor.hideToolPanel()}if(this._editor._toolPanel){this._editor._toolPanel.clearErrors()}}},{key:"getGridControl",value:function e(){return this._editor.getControlById("variation_grid")}},{key:"onBeforeGridRequest",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];r.sessid=BX.bitrix_sessid();r.method="POST";r.url=this.getReloadUrl();r.data=babelHelpers.objectSpread({},r.data,{signedParameters:this.getSignedParameters()});this.unsubscribeGridEvents()}},{key:"getReloadUrl",value:function e(){return this.getConfigStringParam("reloadUrl","")}},{key:"getSignedParameters",value:function e(){return this.getConfigStringParam("signedParameters","")}},{key:"getGridId",value:function e(){return this.getConfigStringParam("gridId","")}},{key:"getGrid",value:function e(){if(!a.Reflection.getClass("BX.Main.gridManager.getInstanceById")){return null}return BX.Main.gridManager.getInstanceById(this.getGridId())}},{key:"onBeforeSubmitForm",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];var s=this.getGrid();if(!s){return}var l=this.getGridId();var o=s.getRows().getEditSelectedValues();for(var u in o){for(var d in o[u]){if(!o[u].hasOwnProperty(d)){continue}if(d.includes("SKU_GRID_CATALOG_GROUP")||d.includes("SKU_GRID_PURCHASING")){for(var c in o[u][d]){if(o[u][d].hasOwnProperty(c)){o[u][c]=o[u][d][c]}}}else if(d.includes("[EDIT_HTML]")){var h=d.replace("[EDIT_HTML]","");if(h.endsWith("_custom")){if("bxu_files[]"in o[u][d]){o[u][d].isFile=true;delete o[u][d]["bxu_files[]"]}if(o[u][d].isFile){for(var p in o[u][d]){if(o[u][d].hasOwnProperty(p)){var f=new RegExp(/([0-9A-Za-z_]+?(_n\d+)*)\[([A-Za-z_]+)\]/);if(f.test(p)){var m=void 0,g=void 0;var b=p.match(f);var y=babelHelpers.slicedToArray(b,4);m=y[1];g=y[3];if(m&&g){o[u][d][m]=o[u][d][m]||{};o[u][d][m][g]=o[u][d][p];delete o[u][d][p]}}}}}}o[u][h]=o[u][d];delete o[u][d]}}}if(!a.Type.isPlainObject(r.options)){r.options={}}if(!a.Type.isPlainObject(r.options.data)){r.options.data={}}r.options.data[l]=o;this.areaHeight=this.getGridControl().getWrapper().offsetHeight}}]);return t}(BX.UI.EntityEditorController);var v=function(){function e(){var t=this;babelHelpers.classCallCheck(this,e);n.EventEmitter.subscribe("BX.UI.EntityEditorControllerFactory:onInitialize",function(e){var i=e.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];r.methods["entityCard"]=t.factory.bind(t)})}babelHelpers.createClass(e,[{key:"factory",value:function e(t,i,n){if(t==="iblock_section"){return new y(i,n)}if(t==="variation_grid"){return new E(i,n)}return null}}]);return e}();function I(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-remove-block"></div>\n\t\t\t']);I=function t(){return e};return e}function _(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input \n\t\t\t\t\tclass="ui-ctl-element" \n\t\t\t\t\tvalue="','"\n\t\t\t\t\tplaceholder="','"\n\t\t\t\t>\n\t\t\t']);_=function t(){return e};return e}function C(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<label class="catalog-dictionary-item ','">\n\t\t\t\t<img src="','" alt="">\n\t\t\t\t',"\n\t\t\t</label>\n\t\t\t"]);C=function t(){return e};return e}function T(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<input class="input-image-hidden" value="','" type="file" accept="image/*">\n\t\t\t']);T=function t(){return e};return e}function k(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-ctl ui-ctl-textbox ui-ctl-w100 ui-ctl-row"></div>\n\t\t\t']);k=function t(){return e};return e}var S=function(e){babelHelpers.inherits(t,e);function t(){var e;var i;babelHelpers.classCallCheck(this,t);for(var n=arguments.length,r=new Array(n),a=0;a<n;a++){r[a]=arguments[a]}i=babelHelpers.possibleConstructorReturn(this,(e=babelHelpers.getPrototypeOf(t)).call.apply(e,[this].concat(r)));babelHelpers.defineProperty(babelHelpers.assertThisInitialized(i),"fileChanged",false);return i}babelHelpers.createClass(t,[{key:"layout",value:function e(){if(this._hasLayout){return}this._wrapper=a.Tag.render(k());this._fileInput=a.Tag.render(T(),BX.prop.getString(this._data,"FILE_ID",""));a.Event.bind(this._fileInput,"change",this.onFileLoaderChange.bind(this));var t=BX.prop.getString(this._data,"IMAGE_SRC","");this._wrapper.appendChild(a.Tag.render(C(),t===""?"catalog-dictionary-item-empty":"",t,this._fileInput));var i=a.Text.encode(BX.prop.getString(this._data,"TEXT",""));this._labelInput=a.Tag.render(_(),i,BX.message("CATALOG_ENTITY_CARD_NEW_FIELD_ITEM_PLACEHOLDER"));this._wrapper.appendChild(this._labelInput);var n=a.Tag.render(I());a.Event.bind(n,"click",this.onDeleteButtonClick.bind(this));this._wrapper.appendChild(n);var r=BX.prop.getElementNode(this._settings,"anchor");if(r){this._container.insertBefore(this._wrapper,r)}else{this._container.appendChild(this._wrapper)}this._hasLayout=true}},{key:"onFileLoaderChange",value:function e(t){var i=t.target;if(i.files&&i.files[0]){var n=new FileReader;n.onload=function(e){i.parentNode.querySelector("img").src=e.target.result};this.fileChanged=true;n.readAsDataURL(i.files[0]);i.parentNode.classList.remove("catalog-dictionary-item-empty")}}},{key:"isFileChanged",value:function e(){return this.fileChanged}},{key:"prepareData",value:function e(){var t=this._labelInput?BX.util.trim(this._labelInput.value):"";var i=this._fileInput&&this._fileInput.files&&this._fileInput.files[0]?this._fileInput.files[0]:{};if(t===""&&!this.isFileChanged()){return}var n={VALUE:{value:t,file:i},XML_ID:"",FILE_ID:""};var r=BX.prop.getString(this._data,"ID","");if(BX.type.isNotEmptyString(r)){n["XML_ID"]=r;n["FILE_ID"]=BX.prop.getString(this._data,"FILE_ID","")}return n}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityEditorUserFieldListItem);function B(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block-add-field">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);B=function t(){return e};return e}function A(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-card-content-add-field">\n\t\t\t\t\t',"\n\t\t\t\t</div>\n\t\t\t"]);A=function t(){return e};return e}function U(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t\t']);U=function t(){return e};return e}function D(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t<span class="ui-entity-editor-block-title-text">',"</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t"]);D=function t(){return e};return e}function L(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t']);L=function t(){return e};return e}function H(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t']);H=function t(){return e};return e}function X(){var e=babelHelpers.taggedTemplateLiteral(['<hr class="ui-entity-editor-line">']);X=function t(){return e};return e}function F(){var e=babelHelpers.taggedTemplateLiteral(['<hr class="ui-entity-editor-line">']);F=function t(){return e};return e}var R=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"layoutInternal",value:function e(){this._wrapper.appendChild(this.getInputContainer());if(this._typeId==="list"||this._typeId==="multilist"||this._typeId==="directory"){this._wrapper.appendChild(a.Tag.render(F()));this._wrapper.appendChild(this.getEnumerationContainer())}this._wrapper.appendChild(this.getOptionContainer());this._wrapper.appendChild(this.getErrorContainer());a.Dom.append(a.Tag.render(X()),this._wrapper);this._wrapper.appendChild(this.getButtonContainer())}},{key:"getOptionContainer",value:function e(){var t=this._field===null;this._optionWrapper=a.Tag.render(H());if(this._typeId==="datetime"||this._typeId==="multidatetime"){this._isTimeEnabledCheckBox=this.getIsTimeEnabledCheckBox()}if(this._typeId!=="boolean"&&this._enableMandatoryControl){this._isRequiredCheckBox=this.getIsRequiredCheckBox()}if(this._typeId!=="directory"){this._isMultipleCheckBox=this.getMultipleCheckBox()}this._showAlwaysCheckBox=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_SHOW_ALWAYS"),helpUrl:"https://helpdesk.bitrix24.ru/open/7046149/",helpCode:"9627471"});this._showAlwaysCheckBox.checked=t?BX.prop.getBoolean(this._settings,"showAlways",true):this._field.checkOptionFlag(BX.UI.EntityEditorControlOptions.showAlways);return this._optionWrapper}},{key:"getInputTitle",value:function e(){var t=this._editor.getUserFieldManager();return this._field?this._field.getTitle():t.getDefaultFieldLabel(this._typeId)}},{key:"getErrorContainer",value:function e(){this._errorContainer=a.Tag.render(L());return this._errorContainer}},{key:"getEnumerationContainer",value:function e(){var t=this;var i=a.Tag.render(D(),BX.message("UI_ENTITY_EDITOR_UF_ENUM_ITEMS"));this._enumItemContainer=a.Tag.render(U());a.Dom.append(this._enumItemContainer,i);var n=a.Tag.render(A(),BX.message("UI_ENTITY_EDITOR_ADD"));a.Event.bind(n,"click",this.onEnumerationItemAddButtonClick.bind(this));a.Dom.append(a.Tag.render(B(),n),i);if(this._field){this._field.getItems().forEach(function(e){if(e.VALUE!==""){t.createEnumerationItem({VALUE:e.NAME,FILE_ID:e.IMAGE||null,IMAGE_SRC:e.IMAGE_SRC||"",TEXT:e.TEXT||"",ID:e.VALUE})}})}var r=this.createEnumerationItem();r.focus();this.initItemClickHandlers();return i}},{key:"onEnumerationItemAddButtonClick",value:function e(){this.unbindItemClickHandlers();this.createEnumerationItem().focus();this.bindLastItemClickHandler()}},{key:"onEnumerationItemClick",value:function e(){this.unbindItemClickHandlers();this.createEnumerationItem();this.bindLastItemClickHandler()}},{key:"initItemClickHandlers",value:function e(){this.unbindItemClickHandlers();this.bindLastItemClickHandler()}},{key:"unbindItemClickHandlers",value:function e(){this._enumItems.forEach(function(e){return a.Event.unbindAll(e._labelInput,"click")})}},{key:"bindLastItemClickHandler",value:function e(){var t=this._enumItems[this._enumItems.length-1];if(t){a.Event.bindOnce(t._labelInput,"click",this.onEnumerationItemClick.bind(this))}}},{key:"createEnumerationItem",value:function e(t){var i=null;if(this._typeId==="directory"){i=S.create("",{configurator:this,container:this._enumItemContainer,data:t})}else{i=BX.UI.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemContainer,data:t})}this._enumItems.push(i);i.layout();return i}},{key:"removeEnumerationItem",value:function e(t){for(var i=0,n=this._enumItems.length;i<n;i++){if(this._enumItems[i]===t){this._enumItems[i].clearLayout();this._enumItems.splice(i,1);this.initItemClickHandlers();break}}}},{key:"prepareSaveParams",value:function e(i){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareSaveParams",this).call(this,this,arguments);if(this._typeId==="list"||this._typeId==="multilist"){n["enumeration"]=[];var r=[];this._enumItems.forEach(function(e){if(!(e instanceof BX.UI.EntityEditorUserFieldListItem)){return}var t=e.prepareData();if(!t){return}var i=BX.util.hashCode(t["VALUE"]);if(BX.util.in_array(i,r)){return}r.push(i);t["SORT"]=(n["enumeration"].length+1)*100;n["enumeration"].push(t)})}if(this._typeId==="directory"){n["enumeration"]=[];this._enumItems.forEach(function(e){if(!(e instanceof S)){return}var t=e.prepareData();if(!t){return}t["SORT"]=(n["enumeration"].length+1)*100;n["enumeration"].push(t)})}else if(this._typeId==="datetime"||this._typeId==="multidatetime"){n["enableTime"]=this._isTimeEnabledCheckBox.checked}if(this._field){if(this._isMultipleCheckBox){n["multiple"]=this._isMultipleCheckBox.checked}}else{if(this._typeId==="boolean"){n["multiple"]=false}else if(this._isMultipleCheckBox){n["multiple"]=this._isMultipleCheckBox.checked}}return n}},{key:"getMultipleCheckBox",value:function e(){var t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_MULTIPLE_FIELD")});if(this._field instanceof BX.UI.EntityEditorMultiText||this._field instanceof BX.UI.EntityEditorMultiNumber||this._field instanceof BX.UI.EntityEditorMultiList||this._field instanceof BX.UI.EntityEditorMultiDatetime){t.checked=true}return t}},{key:"getIsRequiredCheckBox",value:function e(){var t;if(this._mandatoryConfigurator){t=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"ui-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});t.checked=this._field&&this._field.isRequired()||this._mandatoryConfigurator.isCustomized();this._mandatoryConfigurator.setSwitchCheckBox(t);this._mandatoryConfigurator.setLabel(t.nextSibling);this._mandatoryConfigurator.setEnabled(t.checked);this._mandatoryConfigurator.adjust()}else{t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_REQUIRED_FIELD")});t.checked=this._field&&this._field.isRequired()}return t}},{key:"getIsTimeEnabledCheckBox",value:function e(){var t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_ENABLE_TIME")});t.checked=this._field&&this._field.isTimeEnabled();return t}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityEditorFieldConfigurator);a.Reflection.namespace("BX.Catalog").IblockFieldConfigurator=R;var P=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"createFieldConfigurator",value:function e(t,i){if(!BX.type.isPlainObject(t)){throw"IblockFieldConfigurationManager: The 'params' argument must be object."}return this.getSimpleFieldConfigurator(t,i)}},{key:"getSimpleFieldConfigurator",value:function e(t,i){var n="";var r=BX.prop.get(t,"field",null);if(r){n=r.getType();r.setVisible(false);if(!BX.prop.get(r.getSchemeElement().getData(),"isProductProperty",false)){return this._fieldConfigurator=BX.UI.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null})}else if(BX.prop.get(r.getSchemeElement().getData(),"userType",false)){n=BX.prop.getString(r.getSchemeElement().getData(),"userType")}}else{n=BX.prop.get(t,"typeId",BX.UI.EntityUserFieldType.string)}this._fieldConfigurator=R.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null});return this._fieldConfigurator}},{key:"isCreationEnabled",value:function e(){return true}},{key:"getCreationPageUrl",value:function e(t){return this.creationPageUrl}},{key:"openCreationPageUrl",value:function e(t){BX.SidePanel.Instance.open(this.getCreationPageUrl(t),{allowChangeHistory:false,cacheable:false})}},{key:"setCreationPageUrl",value:function e(t){return this.creationPageUrl=t}},{key:"getTypeInfos",value:function e(){var t=[];t.push({name:"string",title:BX.message("UI_ENTITY_EDITOR_UF_STRING_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_STRING_LEGEND")});t.push({name:"list",title:BX.message("UI_ENTITY_EDITOR_UF_ENUM_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_ENUM_LEGEND")});t.push({name:"datetime",title:BX.message("UI_ENTITY_EDITOR_UF_DATETIME_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_DATETIME_LEGEND")});t.push({name:"address",title:BX.message("UI_ENTITY_EDITOR_UF_ADDRESS_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_ADDRESS_LEGEND")});t.push({name:"money",title:BX.message("UI_ENTITY_EDITOR_UF_MONEY_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_MONEY_LEGEND")});t.push({name:"boolean",title:BX.message("UI_ENTITY_EDITOR_BOOLEAN_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_BOOLEAN_LEGEND")});t.push({name:"double",title:BX.message("UI_ENTITY_EDITOR_UF_DOUBLE_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_DOUBLE_LEGEND")});t.push({name:"directory",title:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_TITLE"),legend:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_LEGEND")});t.push({name:"custom",title:BX.message("UI_ENTITY_EDITOR_UF_CUSTOM_TITLE"),legend:BX.message("UI_ENTITY_EDITOR_UF_CUSTOM_LEGEND")});return t}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityConfigurationManager);function O(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-entity-editor-content-block-add-field">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t"]);O=function t(){return e};return e}function N(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-entity-card-content-add-field">\n\t\t\t\t\t\t',"\n\t\t\t\t\t</div>\n\t\t\t\t"]);N=function t(){return e};return e}function M(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t\t<div class="ui-entity-editor-content-block"></div>\n\t\t\t\t']);M=function t(){return e};return e}function w(){var e=babelHelpers.taggedTemplateLiteral(['\n\t\t\t\t<div class="ui-entity-editor-content-block">\n\t\t\t\t\t<div class="ui-entity-editor-block-title">\n\t\t\t\t\t\t<span class="ui-entity-editor-block-title-text">',"</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t"]);w=function t(){return e};return e}function x(){var e=babelHelpers.taggedTemplateLiteral(['<hr class="ui-entity-editor-line">']);x=function t(){return e};return e}var Y=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"appendEnumerationSettings",value:function e(){var t=this;if(this._typeId==="list"||this._typeId==="multilist"){a.Dom.append(a.Tag.render(x()),this._wrapper);var i=a.Tag.render(w(),BX.message("UI_ENTITY_EDITOR_UF_ENUM_ITEMS"));a.Dom.append(i,this._wrapper);this._enumItemContainer=a.Tag.render(M());a.Dom.append(this._enumItemContainer,i);var n=a.Tag.render(N(),BX.message("UI_ENTITY_EDITOR_ADD"));a.Event.bind(n,"click",this.onEnumerationItemAddButtonClick.bind(this));a.Dom.append(a.Tag.render(O(),n),i);if(this._field){this._field.getItems().forEach(function(e){if(e.VALUE!==""){t.createEnumerationItem({VALUE:e.NAME,ID:e.VALUE})}})}this.createEnumerationItem();this.initItemFocusHandlers()}}},{key:"onEnumerationItemAddButtonClick",value:function e(){this.unbindItemFocusHandlers();this.createEnumerationItem().focus();this.bindLastItemFocusHandler()}},{key:"onEnumerationItemFocus",value:function e(){this.unbindItemFocusHandlers();this.createEnumerationItem();this.bindLastItemFocusHandler()}},{key:"initItemFocusHandlers",value:function e(){this.unbindItemFocusHandlers();this.bindLastItemFocusHandler()}},{key:"unbindItemFocusHandlers",value:function e(){this._enumItems.forEach(function(e){return a.Event.unbindAll(e._labelInput,"focus")})}},{key:"bindLastItemFocusHandler",value:function e(){var t=this._enumItems[this._enumItems.length-1];if(t){a.Event.bindOnce(t._labelInput,"focus",this.onEnumerationItemFocus.bind(this))}}},{key:"createEnumerationItem",value:function e(t){var i=BX.UI.EntityEditorUserFieldListItem.create("",{configurator:this,container:this._enumItemContainer,data:t});this._enumItems.push(i);i.layout();return i}},{key:"removeEnumerationItem",value:function e(t){for(var i=0,n=this._enumItems.length;i<n;i++){if(this._enumItems[i]===t){this._enumItems[i].clearLayout();this._enumItems.splice(i,1);this.initItemFocusHandlers();break}}}},{key:"prepareSaveParams",value:function e(i){var n=babelHelpers.get(babelHelpers.getPrototypeOf(t.prototype),"prepareSaveParams",this).call(this,this,arguments);if(this._typeId==="list"||this._typeId==="multilist"){n["enumeration"]=[];var r=[];this._enumItems.forEach(function(e){if(!(e instanceof BX.UI.EntityEditorUserFieldListItem)){return}var t=e.prepareData();if(!t){return}var i=BX.util.hashCode(t["VALUE"]);if(BX.util.in_array(i,r)){return}r.push(i);t["SORT"]=(n["enumeration"].length+1)*100;n["enumeration"].push(t)})}else if(this._typeId==="datetime"||this._typeId==="multidatetime"){n["enableTime"]=this._isTimeEnabledCheckBox.checked}return n}},{key:"getMultipleCheckBox",value:function e(){var t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_MULTIPLE_FIELD")});if(this._field instanceof BX.UI.EntityEditorMultiText||this._field instanceof BX.UI.EntityEditorMultiNumber||this._field instanceof BX.UI.EntityEditorMultiList||this._field instanceof BX.UI.EntityEditorMultiDatetime){t.checked=true}return t}},{key:"getIsRequiredCheckBox",value:function e(){var t=null;if(this._typeId!=="boolean"){if(this._enableMandatoryControl){if(this._mandatoryConfigurator){t=this.createOption({caption:this._mandatoryConfigurator.getTitle()+":",labelSettings:{props:{className:"ui-entity-new-field-addiction-label"}},containerSettings:{style:{alignItems:"center"}},elements:this._mandatoryConfigurator.getButton().prepareLayout()});t.checked=this._field&&this._field.isRequired()||this._mandatoryConfigurator.isCustomized();this._mandatoryConfigurator.setSwitchCheckBox(t);this._mandatoryConfigurator.setLabel(t.nextSibling);this._mandatoryConfigurator.setEnabled(t.checked);this._mandatoryConfigurator.adjust()}else{t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_REQUIRED_FIELD")});t.checked=this._field&&this._field.isRequired()}}}return t}},{key:"getIsTimeEnabledCheckBox",value:function e(){var t=null;if(this._typeId==="datetime"||this._typeId==="multidatetime"){t=this.createOption({caption:BX.message("UI_ENTITY_EDITOR_UF_ENABLE_TIME")});t.checked=this._field&&this._field.isTimeEnabled()}return t}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityEditorFieldConfigurator);var G=function(e){babelHelpers.inherits(t,e);function t(){babelHelpers.classCallCheck(this,t);return babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(t).apply(this,arguments))}babelHelpers.createClass(t,[{key:"createFieldConfigurator",value:function e(t,i){if(!a.Type.isPlainObject(t)){throw"GridFieldConfigurationManager: The 'params' argument must be object."}return this.getSimpleFieldConfigurator(t,i)}},{key:"getSimpleFieldConfigurator",value:function e(t,i){var n="";var r=BX.prop.get(t,"field",null);if(r){n=r.getType();r.setVisible(false);if(!BX.prop.get(r.getSchemeElement().getData(),"isProductProperty",false)){return this._fieldConfigurator=BX.UI.EntityEditorFieldConfigurator.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null})}}else{n=BX.prop.get(t,"typeId",BX.UI.EntityUserFieldType.string)}this._fieldConfigurator=Y.create("",{editor:this._editor,schemeElement:null,model:i._model,mode:BX.UI.EntityEditorMode.edit,parent:i,typeId:n,field:r,mandatoryConfigurator:null});return this._fieldConfigurator}},{key:"isSelectionEnabled",value:function e(){return false}},{key:"isCreationEnabled",value:function e(){return false}},{key:"hasExternalForm",value:function e(t){return true}},{key:"getCreationPageUrl",value:function e(t){var i=this.getTypeInfos().filter(function(e){return e.name===t});if(i.length>0){return this.creationPageUrl.replace("#PROPERTY_TYPE#",t)}}},{key:"openCreationPageUrl",value:function e(t){var i=this;var n=function e(){return i.openCreationPageSlider(i.getCreationPageUrl(t))};var r=a.Reflection.getClass("BX.Catalog.VariationGrid.Instance");if(r){r.askToLossGridData(n,null,{message:a.Loc.getMessage("CATALOG_ENTITY_CARD_UNSAVED_DATA_MESSAGE")})}else{n()}}},{key:"openCreationPageSlider",value:function e(t){if(a.Type.isStringFilled(t)){BX.SidePanel.Instance.open(t,{width:550,allowChangeHistory:false,cacheable:false})}}},{key:"setCreationPageUrl",value:function e(t){return this.creationPageUrl=t}},{key:"getTypeInfos",value:function e(){return[{name:"list",title:BX.message("CATALOG_ENTITY_CARD_LIST_TITLE"),legend:BX.message("CATALOG_ENTITY_CARD_LIST_LEGEND")},{name:"directory",title:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_TITLE"),legend:BX.message("CATALOG_ENTITY_CARD_DICTIONARY_LEGEND")}]}}],[{key:"create",value:function e(t,i){var n=new this;n.initialize(t,i);return n}}]);return t}(BX.UI.EntityConfigurationManager);function j(){var e=babelHelpers.taggedTemplateLiteral(['<div class="catalog-entity-overlay"></div>']);j=function t(){return e};return e}var q=function(){function e(t){var i=arguments.length>1&&arguments[1]!==undefined?arguments[1]:{};babelHelpers.classCallCheck(this,e);babelHelpers.defineProperty(this,"stackWithOffset",null);this.id=a.Type.isStringFilled(t)?t:a.Text.getRandom();this.settings=i;this.cardSettings=i.cardSettings||[];this.feedbackUrl=i.feedbackUrl||"";this.entityId=a.Text.toInteger(i.entityId)||0;this.container=document.getElementById(i.containerId);this.componentName=i.componentName||null;this.componentSignedParams=i.componentSignedParams||null;this.isSimpleProduct=i.isSimpleProduct||false;this.initializeTabManager();this.checkFadeOverlay();this.registerFieldsFactory();this.registerControllersFactory();this.registerEvents()}babelHelpers.createClass(e,[{key:"getEntityType",value:function e(){return"Entity"}},{key:"getCardSetting",value:function e(t){return this.cardSettings.filter(function(e){return e.id===t})[0]}},{key:"isCardSettingEnabled",value:function e(t){var i=this.getCardSetting(t);return i&&i.checked}},{key:"initializeTabManager",value:function e(){return new o(this.id,{container:document.getElementById(this.settings.tabContainerId),menuContainer:document.getElementById(this.settings.tabMenuContainerId),data:this.settings.tabs||[]})}},{key:"checkFadeOverlay",value:function e(){if(this.entityId<=0){this.overlay=a.Tag.render(j());a.Dom.append(this.overlay,this.container);if(window===window.top){this.overlay.style.position="absolute";this.overlay.style.top=this.overlay.style.left=this.overlay.style.right="-15px"}}}},{key:"registerFieldsFactory",value:function e(){return new m}},{key:"registerControllersFactory",value:function e(){return new v}},{key:"registerEvents",value:function e(){n.EventEmitter.subscribe("BX.UI.EntityConfigurationManager:onInitialize",this.onConfigurationManagerInit.bind(this));n.EventEmitter.subscribe("BX.UI.EntityEditor:onCancel",this.removeFileHiddenInputs.bind(this));n.EventEmitter.subscribe("BX.UI.EntityEditor:onInit",this.onEditorInitHandler.bind(this));n.EventEmitter.subscribe("BX.UI.EntityEditorAjax:onSubmit",this.onEditorAjaxSubmit.bind(this));n.EventEmitter.subscribe("onEntityCreate",this.onEntityCreateHandler.bind(this));n.EventEmitter.subscribe("onEntityUpdate",this.onEntityUpdateHandler.bind(this));n.EventEmitter.subscribe("onAttachFiles",this.onAttachFilesHandler.bind(this));n.EventEmitter.subscribe("BX.Main.Popup:onClose",this.onFileEditorCloseHandler.bind(this))}},{key:"onAttachFilesHandler",value:function e(t){var i=this.getEditorInstance();if(!i){return}var n=t.getCompatData(),r=babelHelpers.slicedToArray(n,3),s=r[2];if(s&&a.Type.isDomNode(s.fileInput)){var l=s.fileInput.closest("[data-cid]");if(a.Type.isDomNode(l)){var o=l.getAttribute("data-cid");var u=i.getControlByIdRecursive(o);if(u){u.markAsChanged()}}}}},{key:"onFileEditorCloseHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];if(r&&r.getId()==="popupFM"&&r.onApplyFlag){this.showNotification(a.Loc.getMessage("CATALOG_ENTITY_CARD_FILE_CLOSE_NOTIFICATION"),{autoHideDelay:5e3})}}},{key:"onEditorInitHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[0],a=n[1];if(r&&!a.entityId){var s=r.getControlByIdRecursive("NAME");if(s){requestAnimationFrame(function(){s.focus()})}}}},{key:"getEditorInstance",value:function e(){if(a.Reflection.getClass("BX.UI.EntityEditor")){return BX.UI.EntityEditor.getDefault()}return null}},{key:"onEditorAjaxSubmit",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[0],s=n[1];var l=r.NAME||"";this.changePageTitle(l);if(s.data){if(a.Type.isBoolean(s.data.IS_SIMPLE_PRODUCT)){this.isSimpleProduct=s.data.IS_SIMPLE_PRODUCT}}if(s.status==="success"){this.removeFileHiddenInputs()}}},{key:"onEntityCreateHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];this.postSliderMessage("onCreate",r)}},{key:"onEntityUpdateHandler",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,1),r=n[0];this.postSliderMessage("onUpdate",r)}},{key:"postSliderMessage",value:function e(t,i){BX.SidePanel.Instance.postMessage(window,"Catalog.".concat(this.getEntityType(),"Card::").concat(t),i)}},{key:"changePageTitle",value:function e(t){var i=document.getElementById("pagetitle");if(a.Type.isDomNode(i)){i.innerText=t}document.title=t;if(BX.getClass("BX.SidePanel.Instance.updateBrowserTitle")){BX.SidePanel.Instance.updateBrowserTitle()}}},{key:"removeFileHiddenInputs",value:function e(){document.querySelectorAll('form>input[type="hidden"]').forEach(function(e){var t=e.getAttribute("name");var i=document.querySelector('form>input[name="'.concat(t,'_del"]'));if(i){a.Dom.remove(e);a.Dom.remove(i)}})}},{key:"onConfigurationManagerInit",value:function e(t){var i=t.getCompatData(),n=babelHelpers.slicedToArray(i,2),r=n[1];if(!r.type||r.type==="editor"){r.configurationFieldManager=this.initializeIblockFieldConfigurationManager(r)}if(r.id==="variation_grid"){r.configurationFieldManager=this.initializeVariationPropertyConfigurationManager(r)}}},{key:"initializeIblockFieldConfigurationManager",value:function e(t){var i=P.create(this.id,t);i.setCreationPageUrl(this.settings.creationPropertyUrl);return i}},{key:"initializeVariationPropertyConfigurationManager",value:function e(t){var i=G.create(this.id,t);i.setCreationPageUrl(this.settings.creationVariationPropertyUrl);return i}},{key:"showNotification",value:function e(t,i){i=i||{};if(BX.GetWindowScrollPos().scrollTop<=10){i.stack=this.getStackWithOffset()}BX.UI.Notification.Center.notify({content:t,stack:i.stack||null,position:"top-right",width:"auto",category:i.category||null,autoHideDelay:i.autoHideDelay||3e3})}},{key:"getStackWithOffset",value:function e(){if(this.stackWithOffset===null){this.stackWithOffset=new BX.UI.Notification.Stack(BX.mergeEx({},BX.UI.Notification.Center.getStackDefaults(),{id:"top-right-with-offset",position:"top-right-with-offset",offsetY:74}))}return this.stackWithOffset}},{key:"openFeedbackPanel",value:function e(){if(!a.Reflection.getClass("BX.SidePanel.Instance")||!a.Type.isStringFilled(this.feedbackUrl)){return}BX.SidePanel.Instance.open(this.feedbackUrl,{cacheable:false,allowChangeHistory:false,width:580})}}]);return e}();e.EntityCard=q})(this.BX.Catalog.EntityCard=this.BX.Catalog.EntityCard||{},BX,BX,BX.Event,BX,BX);
//# sourceMappingURL=entity-card.bundle.map.js