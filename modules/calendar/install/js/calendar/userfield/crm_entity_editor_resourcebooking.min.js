(function(){"use strict";BX.namespace("BX.Calendar.UserField");function e(){BX.Calendar.UserField.EntityEditorUserFieldConfigurator=function(){BX.Calendar.UserField.EntityEditorUserFieldConfigurator.superclass.constructor.apply(this)};BX.extend(BX.Calendar.UserField.EntityEditorUserFieldConfigurator,BX.Crm.EntityEditorUserFieldConfigurator);BX.Calendar.UserField.EntityEditorUserFieldConfigurator.create=function(e,t){var i=new BX.Calendar.UserField.EntityEditorUserFieldConfigurator;i.initialize(e,t);return i};BX.Calendar.UserField.EntityEditorUserFieldConfigurator.prototype.layout=function(e,t){if(this._hasLayout){return}if(!BX.type.isPlainObject(t)){t={}}if(this._mode===BX.Crm.EntityEditorMode.view){throw"EntityEditorUserFieldConfigurator. View mode is not supported by this control type."}this.getBitrix24Limitation({callback:BX.delegate(function(e){this.RESOURCE_LIMIT=e},this)});if(this._field){this.fieldInfo=this._field.getFieldInfo()}else if(!t.settings){return this.getDefaultUserfieldSettings({displayCallback:BX.delegate(function(t){this.layout(e,{settings:t})},this)})}this._wrapper=BX.create("div",{props:{className:"calendar-resourcebook-content"}});this._innerWrapper=this._wrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-wrap"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-inner"}}));var i=this.fieldInfo?this.fieldInfo.SETTINGS:t.settings,s=[],r=[],o=this._field===null,a=this.getMessage("labelField"),n=this._editor.getUserFieldManager(),c=this._field?this._field.getTitle():n.getDefaultFieldLabel(this._typeId);this.RESOURCE_LIMIT=i.RESOURCE_LIMIT||0;this._labelInput=BX.create("input",{attrs:{className:"crm-entity-widget-content-input",type:"text",value:c}});this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block"},children:[BX.create("div",{props:{className:"crm-entity-widget-content-block-title"},children:[BX.create("span",{attrs:{className:"crm-entity-widget-content-block-title-text"},text:a})]}),BX.create("div",{props:{className:"calendar-resourcebook-content-block-field"},children:[this._labelInput]}),BX.create("hr",{props:{className:"crm-entity-widget-hr"}})]}));this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block"},children:[BX.create("span",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_CHOOSE")}),new BX.Calendar.UserField.ResourceBooking.ModeSelector({useResources:i.USE_RESOURCES=="Y",useUsers:i.USE_USERS=="Y",showUsers:BX.delegate(function(){this.resourceList.hide();this.userList.show()},this),showResources:BX.delegate(function(){this.resourceList.show();this.userList.hide()},this),showResourcesAndUsers:BX.delegate(function(){this.resourceList.show();this.userList.show()},this)}).getOuterWrap()]}));var l=this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block"}}));this.resourcesWrap=l.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.resourcesTitleWrap=this.resourcesWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_RESOURCE_CONTROL_DEFAULT_NAME")+":"}));this.resourcesListWrap=this.resourcesWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-new-entries-wrap calendar-resourcebook-content-block-detail-inner"}}));this.resourcesListLowControls=this.resourcesWrap.appendChild(BX.create("div",{props:{className:"calendar-resource-content-block-add-field"}}));if(i.RESOURCES&&BX.type.isPlainObject(i.RESOURCES["resource"])&&BX.type.isArray(i.RESOURCES["resource"].SECTIONS)){i.RESOURCES["resource"].SECTIONS.forEach(function(e){s.push({id:e.ID,title:e.NAME,type:e.CAL_TYPE})})}if(BX.type.isArray(i.SELECTED_RESOURCES)){i.SELECTED_RESOURCES.forEach(function(e){r.push({id:e.id,type:e.type})})}this.resourceList=new BX.Calendar.UserField.ResourceBooking.ResourceListSelector({shown:i.USE_RESOURCES=="Y",editMode:true,outerWrap:this.resourcesWrap,listWrap:this.resourcesListWrap,controlsWrap:this.resourcesListLowControls,values:r,resourceList:s,checkLimitCallback:BX.proxy(this.checkResourceCountLimit,this)});this.userSelectorWrap=l.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.usersTitleWrap=this.userSelectorWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_USERS_CONTROL_DEFAULT_NAME")+":"}));this.usersListWrap=this.userSelectorWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control"}}));var d=[];if(BX.type.isArray(i.SELECTED_USERS)){i.SELECTED_USERS.forEach(function(e){d.push("U"+parseInt(e))})}this.userList=new BX.Calendar.UserField.ResourceBooking.UserSelector({shown:i.USE_USERS=="Y",outerWrap:this.userSelectorWrap,wrapNode:this.usersListWrap,socnetDestination:BX.Calendar.UserField.ResourceBooking.getSocnetDestination(),itemsSelected:d,checkLimitCallback:BX.proxy(this.checkResourceCountLimit,this)});l.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this.datetimeOptionsWrap=l.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-control-field calendar-resourcebook-content-block-control-field-add"}}));this.datetimeOptionsWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title"}})).appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-title-text"},text:BX.message("USER_TYPE_RESOURCE_DATETIME_BLOCK_TITLE")+":"}));this.datetimeOptionsInnerWrap=this.datetimeOptionsWrap.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-options"}}));this._fulldayCheckBox=BX.create("input",{props:{type:"checkbox",checked:i.FULL_DAY=="Y"}});this.datetimeOptionsInnerWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._fulldayCheckBox,BX.create("span",{text:BX.message("USER_TYPE_RESOURCE_FULL_DAY")})]}));this._servicesCheckBox=BX.create("input",{props:{type:"checkbox",checked:i.USE_SERVICES=="Y"},events:{click:BX.delegate(function(){if(this.serviceList){this.serviceList.show(this._servicesCheckBox.checked)}},this)}});this.datetimeOptionsInnerWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._servicesCheckBox,BX.create("span",{text:BX.message("USER_TYPE_RESOURCE_ADD_SERVICES")})]}));this.serviceList=new BX.Calendar.UserField.ResourceBooking.ServiceList({outerCont:this.datetimeOptionsInnerWrap,onFullClearHandler:BX.proxy(function(){this._servicesCheckBox.checked=false},this),fieldSettings:i,getFullDayValue:BX.proxy(function(){return this._fulldayCheckBox.checked},this)});l.appendChild(BX.create("hr",{props:{className:"crm-entity-widget-hr"}}));this.additionaOptionsWrap=l.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-options"}}));this._isRequiredCheckBox=BX.create("input",{props:{type:"checkbox",checked:this._field&&this._field.isRequired()}});this.additionaOptionsWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._isRequiredCheckBox,BX.create("span",{text:this.getMessage("isRequiredField")})]}));this._showAlwaysCheckBox=BX.create("input",{props:{type:"checkbox"}});if(o){this._showAlwaysCheckBox.checked=BX.prop.getBoolean(this._settings,"showAlways",true)}else{this._showAlwaysCheckBox.checked=this._field.checkOptionFlag(BX.Crm.EntityEditorControlOptions.showAlways)}this.additionaOptionsWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._showAlwaysCheckBox,BX.create("span",{text:this.getMessage("showAlways")})]}));this._overbookingCheckBox=BX.create("input",{props:{type:"checkbox",checked:i.ALLOW_OVERBOOKING=="Y"}});this.additionaOptionsWrap.appendChild(BX.create("label",{props:{className:"calendar-resourcebook-content-block-option"},children:[this._overbookingCheckBox,BX.create("span",{text:BX.message("USER_TYPE_RESOURCE_OVERBOOKING")})]}));this._innerWrapper.appendChild(BX.create("div",{props:{className:"calendar-resourcebook-content-block-btn-container"},children:[BX.create("hr",{props:{className:"crm-entity-widget-hr"}}),BX.create("span",{props:{className:"ui-btn ui-btn-sm ui-btn-primary"},text:BX.message("CRM_EDITOR_SAVE"),events:{click:BX.delegate(this.onSaveButtonClick,this)}}),BX.create("span",{props:{className:"ui-btn ui-btn-sm ui-btn-light-border"},text:BX.message("CRM_EDITOR_CANCEL"),events:{click:BX.delegate(this.onCancelButtonClick,this)}})]}));this.fieldSettings=i;this.registerLayout(e);this._hasLayout=true};BX.Calendar.UserField.EntityEditorUserFieldConfigurator.prototype.getDefaultUserfieldSettings=function(e){BX.ajax.runAction("calendar.api.resourcebookingajax.getdefaultuserfieldsettings",{data:{}}).then(function(t){if(e&&BX.type.isFunction(e.displayCallback)){e.displayCallback(t.data)}},function(e){})};BX.Calendar.UserField.EntityEditorUserFieldConfigurator.prototype.getBitrix24Limitation=function(e){BX.ajax.runAction("calendar.api.resourcebookingajax.getbitrix24limitation",{data:{}}).then(function(t){if(e&&BX.type.isFunction(e.callback)){e.callback(t.data)}},function(e){})};BX.Calendar.UserField.EntityEditorUserFieldConfigurator.prototype.createUserListControl=function(e){return new BX.Calendar.UserField.ResourceBooking.UserListSelector(e)};BX.Calendar.UserField.EntityEditorUserFieldConfigurator.prototype.onSaveButtonClick=function(){if(this._isLocked){return}if(this.RESOURCE_LIMIT>0&&this.getTotalResourceCount()>this.RESOURCE_LIMIT){BX.Calendar.UserField.ResourceBooking.showLimitationPopup();return}var e={typeId:this._typeId,label:this._labelInput.value,mandatory:this._isRequiredCheckBox.checked,showAlways:this._showAlwaysCheckBox.checked,multiple:true};if(this._field){e["field"]=this._field}this.fieldSettings.USE_RESOURCES=this.resourceList.isShown()?"Y":"N";this.fieldSettings.USE_USERS=this.userList.isShown()?"Y":"N";if(this.fieldSettings&&BX.type.isPlainObject(this.fieldSettings.RESOURCES)&&BX.type.isPlainObject(this.fieldSettings.RESOURCES["resource"])){this.fieldSettings.SELECTED_RESOURCES=[];this.resourceList.getSelectedValues().forEach(function(e){this.fieldSettings.SELECTED_RESOURCES.push(e)},this);this.resourceList.getDeletedValues().forEach(function(e){this.fieldSettings.SELECTED_RESOURCES.push(e)},this)}if(this.fieldSettings&&this.userList){this.fieldSettings.SELECTED_USERS=[0];this.userList.getAttendeesCodesList().forEach(function(e){if(e.substr(0,1)=="U"){this.fieldSettings.SELECTED_USERS.push(parseInt(e.substr(1)))}},this)}this.fieldSettings.USE_SERVICES=this._servicesCheckBox.checked?"Y":"N";this.fieldSettings.SERVICE_LIST=[];if(this._servicesCheckBox.checked&&this.serviceList){this.fieldSettings.SERVICE_LIST=this.serviceList.getValues()}this.fieldSettings.FULL_DAY=this._fulldayCheckBox.checked?"Y":"N";this.fieldSettings.ALLOW_OVERBOOKING=this._overbookingCheckBox.checked?"Y":"N";e["settings"]=this.fieldSettings;BX.onCustomEvent(this,"onSave",[this,e])};BX.Calendar.UserField.EntityEditorUserFieldConfigurator.prototype.getTotalResourceCount=function(){var e=0;if(this.fieldSettings){if(BX.type.isPlainObject(this.fieldSettings.RESOURCES)&&BX.type.isPlainObject(this.fieldSettings.RESOURCES.resource)&&BX.type.isArray(this.fieldSettings.RESOURCES.resource.SECTIONS)){e+=this.fieldSettings.RESOURCES.resource.SECTIONS.length}e-=this.resourceList.getDeletedValues().length;this.resourceList.getSelectedValues().forEach(function(t){if(!t.id&&t.title!==""){e++}},this);if(this.userList){e+=this.userList.getAttendeesCodesList().length}}return e};BX.Calendar.UserField.EntityEditorUserFieldConfigurator.prototype.checkResourceCountLimit=function(){return this.RESOURCE_LIMIT<=0||this.getTotalResourceCount()<this.RESOURCE_LIMIT}}if(!BX.Crm||typeof BX.Crm.EntityEditorUserFieldConfigurator==="undefined"){BX.addCustomEvent(window,"BX.Crm.EntityEditorUserFieldConfigurator:onDefine",e)}else{e()}})();