this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};(function(t,e,i,s,a,n,r,o,l,d,c,h,u,m,g,p,b,v,I,f,_,x,C,S,M,k,L,T,y,B,D,E,P,A){"use strict";function w(t){const e=A.Core.getStore().getters["chats/get"](t,true);return e.chatId}function F(t,e="ASC"){if(t.length===0){return null}t.sort(((t,i)=>{if(e==="ASC"){return t.id-i.id}return i.id-t.id}));const[i]=t;if(S.Type.isNumber(i.id)){return i.id}return null}const R=50;class N{constructor({dialogId:t}){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=w(t);this.userManager=new P.UserManager}getInitialQuery(){return{[E.RestMethod.imChatFavoriteCounterGet]:{chat_id:this.chatId},[E.RestMethod.imChatFavoriteGet]:{chat_id:this.chatId,limit:R}}}getResponseHandler(){return t=>{if(!t[E.RestMethod.imChatFavoriteCounterGet]){return Promise.reject(new Error("SidebarInfo service error: no response"))}const e=t[E.RestMethod.imChatFavoriteCounterGet];const i=this.store.dispatch("sidebar/favorites/setCounter",{chatId:this.chatId,counter:e.counter});const s=this.handleResponse(t[E.RestMethod.imChatFavoriteGet]);return Promise.all([i,s])}}loadNextPage(){const t=this.getQueryParams();return this.requestPage(t)}getQueryParams(){const t={CHAT_ID:this.chatId,LIMIT:R};const e=this.store.getters["sidebar/favorites/getLastId"](this.chatId);if(e>0){t.LAST_ID=e}return t}requestPage(t){return this.restClient.callMethod(E.RestMethod.imChatFavoriteGet,t).then((t=>this.handleResponse(t.data()))).catch((t=>{console.error("SidebarInfo: Im.imChatFavoriteGet: page request error",t)}))}handleResponse(t){return this.updateModels(t)}updateModels(t){const{list:e=[],users:i=[],files:s=[]}=t;const a=this.userManager.setUsersToModel(i);const n=e.map((t=>t.message));const r=e.length===R;const o=F(e);const l=this.store.dispatch("files/set",s);const d=this.store.dispatch("messages/store",n);const c=this.store.dispatch("sidebar/favorites/set",{chatId:this.chatId,favorites:e,hasNextPage:r,lastId:o});return Promise.all([l,d,c,a])}}const U={support24:"support24"};const $={user:[E.ChatType.user],chat:[E.ChatType.chat],copilot:[E.ChatType.copilot],support24:[U.support24]};const O=Object.freeze({chat:"chat",user:"user",info:"info",file:"file",fileUnsorted:"fileUnsorted",task:"task",meeting:"meeting",market:"market"});const H={[$.user]:{[O.user]:10,[O.info]:20,[O.file]:30,[O.fileUnsorted]:30,[O.task]:40,[O.meeting]:50,[O.market]:60},[$.chat]:{[O.chat]:10,[O.info]:20,[O.file]:30,[O.fileUnsorted]:30,[O.task]:40,[O.meeting]:50,[O.market]:60},[$.copilot]:{[O.user]:10,[O.info]:20,[O.task]:40,[O.meeting]:50}};class G{constructor(){this.settings=S.Extension.getSettings("im.v2.component.sidebar");this.saveSettings()}async saveSettings(){await A.Core.ready();void A.Core.getStore().dispatch("sidebar/setFilesMigrated",this.settings.get("filesMigrated",false));void A.Core.getStore().dispatch("sidebar/setLinksMigrated",this.settings.get("linksAvailable",false))}canShowBriefs(){return this.settings.get("canShowBriefs",false)}isLinksMigrationFinished(){return A.Core.getStore().state.sidebar.isLinksMigrated}isFileMigrationFinished(){return A.Core.getStore().state.sidebar.isFilesMigrated}}function z(t){const e=q(t);return Object.entries(H[e]).sort((([,t],[,e])=>t-e)).map((([t])=>t))}function q(t){var e;const i=X(t);return(e=$[i])!=null?e:$.chat}const X=t=>A.Core.getStore().getters["chats/get"](t).type;const V=new G;function Q(t){const e=z(t);return K(t,e)}function K(t,e){const i=new Set(e);if(Y()){i.delete(O.fileUnsorted)}else{i.delete(O.file)}if(!W(t)){i.delete(O.market)}if(j(t)){i.delete(O.task);i.delete(O.meeting)}return[...i]}function j(t){const e=A.Core.getStore().getters["users/get"](t);return(e==null?void 0:e.bot)===true}function Y(){return V.isFileMigrationFinished()}function W(t){return p.MarketManager.getInstance().getAvailablePlacementsByType(E.PlacementType.sidebar,t).length>0}const J=50;class Z{constructor({dialogId:t}){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=w(t);this.userManager=new P.UserManager}getInitialQuery(){return{[E.RestMethod.imChatUrlCounterGet]:{chat_id:this.chatId},[E.RestMethod.imChatUrlGet]:{chat_id:this.chatId,limit:J}}}getResponseHandler(){return t=>{if(!t[E.RestMethod.imChatUrlCounterGet]||!t[E.RestMethod.imChatUrlGet]){return Promise.reject(new Error("SidebarInfo service error: no response"))}const e=this.handleUrlGetResponse(t[E.RestMethod.imChatUrlGet]);const i=this.handleCounterGetResponse(t[E.RestMethod.imChatUrlCounterGet]);return Promise.all([e,i])}}loadNextPage(){const t=this.getLinksCountFromModel();if(t===0){return Promise.resolve()}const e=this.getQueryParams(t);return this.requestPage(e)}getQueryParams(t=0){const e={CHAT_ID:this.chatId,LIMIT:J};if(S.Type.isNumber(t)&&t>0){e.OFFSET=t}return e}requestPage(t){return this.restClient.callMethod(E.RestMethod.imChatUrlGet,t).then((t=>this.handleUrlGetResponse(t.data()))).catch((t=>{console.error("SidebarInfo: Im.chatUrlList: page request error",t)}))}handleUrlGetResponse(t){const{list:e,users:i}=t;const s=this.userManager.setUsersToModel(i);const a=this.store.dispatch("sidebar/links/set",{chatId:this.chatId,links:e,hasNextPage:e.length===J});return Promise.all([a,s])}handleCounterGetResponse(t){const e=t.counter;return this.store.dispatch("sidebar/links/setCounter",{chatId:this.chatId,counter:e})}getLinksCountFromModel(){return this.store.getters["sidebar/links/getSize"](this.chatId)}}const tt=50;class et{constructor({dialogId:t}){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=w(t);this.userManager=new P.UserManager}getInitialQuery(){return{[E.RestMethod.imChatFileCollectionGet]:{chat_id:this.chatId,limit:tt}}}getResponseHandler(){return t=>{if(!t[E.RestMethod.imChatFileCollectionGet]){return Promise.reject(new Error("SidebarInfo service error: no response"))}return this.updateModels(t[E.RestMethod.imChatFileCollectionGet])}}updateModels(t){const{list:e,users:i,files:s}=t;const a=this.userManager.setUsersToModel(i);const n=this.store.dispatch("files/set",s);const r={};e.forEach((t=>{if(!r[t.subType]){r[t.subType]=[]}r[t.subType].push(t)}));const o=[];Object.keys(r).forEach((t=>{const e=r[t];o.push(this.store.dispatch("sidebar/files/set",{chatId:this.chatId,files:e,subType:t}),this.store.dispatch("sidebar/files/setHasNextPage",{chatId:this.chatId,subType:t,hasNextPage:e.length===tt}),this.store.dispatch("sidebar/files/setLastId",{chatId:this.chatId,subType:t,lastId:F(e)}))}));return Promise.all([n,a,...o])}loadFirstPage(t){return this.loadFirstPageBySubType(t)}loadNextPage(t){return this.loadNextPageBySubType(t)}loadFirstPageBySubType(t){const e=this.getFilesCountFromModel(t);if(e>tt){return Promise.resolve()}const i=this.getQueryParams(t);return this.requestPage(i)}loadNextPageBySubType(t){const e=this.getQueryParams(t);return this.requestPage(e)}getQueryParams(t){const e={CHAT_ID:this.chatId,SUBTYPE:t,LIMIT:tt};const i=this.store.getters["sidebar/files/getLastId"](this.chatId,t);if(i>0){e.LAST_ID=i}return e}requestPage(t){return this.restClient.callMethod(E.RestMethod.imChatFileGet,t).then((t=>this.updateModels(t.data()))).catch((t=>{console.error("SidebarInfo: imChatFileGet: page request error",t)}))}getFilesCountFromModel(t){return this.store.getters["sidebar/files/getSize"](this.chatId,t)}}const it=50;class st{constructor({dialogId:t}){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=w(t);this.userManager=new P.UserManager}getInitialQuery(){return{[E.RestMethod.imChatTaskGet]:{chat_id:this.chatId,limit:it}}}getResponseHandler(){return t=>{if(!t[E.RestMethod.imChatTaskGet]){return Promise.reject(new Error("SidebarInfo service error: no response"))}return this.updateModels(t[E.RestMethod.imChatTaskGet])}}loadFirstPage(){const t=this.getTasksCountFromModel();if(t>it){return Promise.resolve()}const e=this.getQueryParams();return this.requestPage(e)}loadNextPage(){const t=this.getQueryParams();return this.requestPage(t)}getQueryParams(){const t={CHAT_ID:this.chatId,LIMIT:it};const e=this.store.getters["sidebar/tasks/getLastId"](this.chatId);if(e>0){t.LAST_ID=e}return t}requestPage(t){return this.restClient.callMethod(E.RestMethod.imChatTaskGet,t).then((t=>this.updateModels(t.data()))).catch((t=>{console.error("SidebarInfo: Im.imChatFavoriteGet: page request error",t)}))}updateModels(t){const{list:e,users:i}=t;const s=e.length===it;const a=F(e);const n=this.userManager.setUsersToModel(i);const r=this.store.dispatch("sidebar/tasks/set",{chatId:this.chatId,tasks:e,hasNextPage:s,lastId:a});return Promise.all([r,n])}getTasksCountFromModel(){return this.store.getters["sidebar/tasks/getSize"](this.chatId)}}const at=50;class nt{constructor({dialogId:t}){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=w(t);this.userManager=new P.UserManager}getInitialQuery(){return{[E.RestMethod.imChatCalendarGet]:{chat_id:this.chatId,limit:at}}}getResponseHandler(){return t=>{if(!t[E.RestMethod.imChatCalendarGet]){return Promise.reject(new Error("SidebarInfo service error: no response"))}return this.updateModels(t[E.RestMethod.imChatCalendarGet])}}loadFirstPage(){const t=this.getMeetingsCountFromState();if(t>at){return Promise.resolve()}const e=this.getQueryParams();return this.requestPage(e)}loadNextPage(){const t=this.getQueryParams();return this.requestPage(t)}getQueryParams(){const t={CHAT_ID:this.chatId,LIMIT:at};const e=this.store.getters["sidebar/meetings/getLastId"](this.chatId);if(e>0){t.LAST_ID=e}return t}requestPage(t){return this.restClient.callMethod(E.RestMethod.imChatCalendarGet,t).then((t=>this.updateModels(t.data()))).catch((t=>{console.error("SidebarInfo: Im.imChatCalendarGet: page request error",t)}))}updateModels(t){const{list:e,users:i}=t;const s=e.length===at;const a=F(e);const n=this.userManager.setUsersToModel(i);const r=this.store.dispatch("sidebar/meetings/set",{chatId:this.chatId,meetings:e,hasNextPage:s,lastId:a});return Promise.all([r,n])}getMeetingsCountFromState(){return this.store.getters["sidebar/meetings/getSize"](this.chatId)}}const rt=50;class ot{constructor({dialogId:t}){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=w(t);this.userManager=new P.UserManager}getInitialQuery(){return{[E.RestMethod.imDialogUsersList]:{dialog_id:this.dialogId,limit:rt}}}loadFirstPage(){const t=this.getMembersCountFromModel();if(t>rt){return Promise.resolve()}const e=this.getQueryParams();return this.requestPage(e)}loadNextPage(){const t=this.getQueryParams();return this.requestPage(t)}getQueryParams(){return{DIALOG_ID:this.dialogId,LIMIT:rt,LAST_ID:this.store.getters["sidebar/members/getLastId"](this.chatId)}}async requestPage(t){let e=[];try{const i=await this.restClient.callMethod(E.RestMethod.imDialogUsersList,t);e=i.data()}catch(t){console.error("SidebarMain: Im.DialogUsersList: page request error",t)}return this.updateModels(e)}getResponseHandler(){return t=>this.updateModels(t[E.RestMethod.imDialogUsersList])}updateModels(t){const e=[];const i=this.userManager.setUsersToModel(t);t.forEach((t=>{e.push(t.id)}));const s=this.store.dispatch("sidebar/members/set",{chatId:this.chatId,users:e,lastId:F(t,"DESC"),hasNextPage:t.length===rt});return Promise.all([i,s])}getMembersCountFromModel(){return this.store.getters["sidebar/members/getSize"](this.chatId)}}const lt=50;class dt{constructor({dialogId:t}){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=this.getChatId();this.userManager=new P.UserManager}getInitialQuery(){return{[E.RestMethod.imDiskFolderListGet]:{chat_id:this.chatId,limit:lt}}}getResponseHandler(){return t=>{if(!t[E.RestMethod.imDiskFolderListGet]){return Promise.reject(new Error("SidebarInfo service error: no response"))}return this.updateModels(t[E.RestMethod.imDiskFolderListGet])}}loadFirstPage(){const t=this.getFilesCountFromModel(E.SidebarDetailBlock.fileUnsorted);if(t>lt){return Promise.resolve()}const e=this.getQueryParams();return this.requestPage(e)}loadNextPage(){const t=this.getQueryParams();return this.requestPage(t)}getQueryParams(){const t={CHAT_ID:this.chatId,LIMIT:lt};const e=this.store.getters["sidebar/files/getLastId"](this.chatId,E.SidebarDetailBlock.fileUnsorted);if(e>0){t.LAST_ID=e}return t}requestPage(t){return this.restClient.callMethod(E.RestMethod.imDiskFolderListGet,t).then((t=>this.handleResponse(t.data()))).catch((t=>{console.error("SidebarInfo: Im.imDiskFolderListGet: page request error",t)}))}handleResponse(t){const e=t;if(e.files.length<lt){this.hasMoreItemsToLoad=false}const i=F(e.files);if(i){this.lastId=i}return this.updateModels(e)}updateModels(t){const{users:e,files:i}=t;const s=i.map((t=>({...t,subType:E.SidebarDetailBlock.fileUnsorted})));const a=this.userManager.setUsersToModel(e);const n=this.store.dispatch("files/set",s);const r=this.store.dispatch("sidebar/files/set",{chatId:this.chatId,files:s,subType:E.SidebarDetailBlock.fileUnsorted});const o=this.store.dispatch("sidebar/files/setHasNextPage",{chatId:this.chatId,subType:E.SidebarDetailBlock.fileUnsorted,hasNextPage:s.length===lt});const l=this.store.dispatch("sidebar/files/setLastId",{chatId:this.chatId,subType:E.SidebarDetailBlock.fileUnsorted,lastId:F(s)});return Promise.all([n,r,a,o,l])}getFilesCountFromModel(t){return this.store.getters["sidebar/files/getSize"](this.chatId,t)}getChatId(){const t=this.store.getters["chats/get"](this.dialogId,true);return t.chatId}}const ct={Members:ot,Favorite:N,Link:Z,Task:st,File:et,Meeting:nt,FileUnsorted:dt};const ht=Object.freeze({[O.chat]:[E.SidebarDetailBlock.members],[O.info]:[E.SidebarDetailBlock.favorite,E.SidebarDetailBlock.link],[O.file]:[E.SidebarDetailBlock.file],[O.fileUnsorted]:[E.SidebarDetailBlock.fileUnsorted],[O.task]:[E.SidebarDetailBlock.task],[O.meeting]:[E.SidebarDetailBlock.meeting]});class ut{constructor({dialogId:t}){this.blockServices=[];this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.buildBlocks()}async requestInitialData(){const t=this.getInitialQuery();const e=await i.callBatch(t);return this.handleBatchRequestResult(e)}buildBlocks(){const t=this.getServiceClassesForBlocks();this.blockServices=t.map((t=>{const e=new ct[t]({dialogId:this.dialogId});return{initialQuery:e.getInitialQuery(),responseHandler:e.getResponseHandler()}}))}getServiceClassesForBlocks(){const t=[];const e=Q(this.dialogId);e.forEach((e=>{const i=ht[e];if(i){t.push(...i)}}));return t.map((t=>S.Text.capitalize(t)))}getInitialQuery(){let t={};this.blockServices.forEach((e=>{t=Object.assign(t,e.initialQuery)}));return t}handleBatchRequestResult(t){const e=[];this.blockServices.forEach((i=>{e.push(i.responseHandler(t))}));return Promise.all(e).then((()=>this.setInited())).catch((t=>console.error(t)))}setInited(){return this.store.dispatch("sidebar/setInited",w(this.dialogId))}}const mt={name:"ChatLinks",directives:{hint:o.hint},props:{dialogId:{type:String,required:true}},data(){return{expanded:false}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},urlCounter(){const t=this.$store.getters["sidebar/links/getCounter"](this.chatId);return this.getCounterString(t)},isLinksAvailable(){return this.$store.state.sidebar.isLinksMigrated},hintDirectiveContent(){return{text:this.$Bitrix.Loc.getMessage("IM_SIDEBAR_LINKS_NOT_AVAILABLE"),popupOptions:{angle:true,targetContainer:document.body,offsetLeft:141,offsetTop:-10,bindOptions:{position:"top"}}}},chatId(){return this.dialog.chatId}},methods:{getCounterString(t){const e=100;if(t>=e){return"99+"}return t.toString()},onLinkClick(){if(!this.isLinksAvailable){return}L.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.link,dialogId:this.dialogId})},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div \n\t\t\tclass="bx-im-sidebar-chat-links__container" \n\t\t\t:class="[isLinksAvailable ? '' : '--links-not-active']"\n\t\t\t@click="onLinkClick"\n\t\t>\n\t\t\t<div \n\t\t\t\tv-if="!isLinksAvailable" \n\t\t\t\tclass="bx-im-sidebar-chat-links__hint-not-active" \n\t\t\t\tv-hint="hintDirectiveContent"\n\t\t\t></div>\n\t\t\t<div class="bx-im-sidebar-chat-links__title-container">\n\t\t\t\t<div class="bx-im-sidebar-chat-links__icon"></div>\n\t\t\t\t<div class="bx-im-sidebar-chat-links__title-text">\n\t\t\t\t\t{{ loc('IM_SIDEBAR_LINK_DETAIL_TITLE') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-chat-links__counter-container">\n\t\t\t\t<span class="bx-im-sidebar-chat-links__counter">{{urlCounter}}</span>\n\t\t\t</div>\n\t\t</div>\n\t`};const gt={name:"ChatFavourites",props:{dialogId:{type:String,required:true}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},favoriteCounter(){const t=this.$store.getters["sidebar/favorites/getCounter"](this.chatId);return this.getCounterString(t)},chatId(){return this.dialog.chatId}},methods:{getCounterString(t){const e=100;if(t>=e){return"99+"}return t.toString()},onFavouriteClick(){L.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.favorite,dialogId:this.dialogId})},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-chat-favourites__container" @click="onFavouriteClick">\n\t\t\t<div class="bx-im-sidebar-chat-favourites__title">\n\t\t\t\t<div class="bx-im-sidebar-chat-favourites__icon"></div>\n\t\t\t\t<div class="bx-im-sidebar-chat-favourites__title-text">\n\t\t\t\t\t{{ loc('IM_SIDEBAR_FAVORITE_DETAIL_TITLE') }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-chat-favourites__counter-container">\n\t\t\t\t<span class="bx-im-sidebar-chat-favourites__counter">{{favoriteCounter}}</span>\n\t\t\t</div>\n\t\t</div>\n\t`};const pt=25;const bt={name:"ChatDescription",props:{dialogId:{type:String,required:true}},data(){return{expanded:false}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isUser(){return this.dialog.type===E.ChatType.user},isBot(){const t=this.$store.getters["users/get"](this.dialogId,true);return t.bot===true},previewDescription(){if(this.dialog.description.length===0){return this.chatTypeText}if(this.dialog.description.length>pt){return`${this.dialog.description.slice(0,pt)}...`}return this.dialog.description},descriptionToShow(){const t=this.expanded?this.dialog.description:this.previewDescription;return M.Parser.purifyText(t)},chatTypeText(){if(this.isBot){return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_CHAT_TYPE_BOT")}if(this.isUser){return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_CHAT_TYPE_USER")}return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_CHAT_TYPE_GROUP_V2")},showExpandButton(){if(this.expanded){return false}return this.dialog.description.length>=pt}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-chat-description__container">\n\t\t\t<div class="bx-im-sidebar-chat-description__text-container" :class="[expanded ? '--expanded' : '']">\n\t\t\t\t<div class="bx-im-sidebar-chat-description__icon"></div>\n\t\t\t\t<div class="bx-im-sidebar-chat-description__text">\n\t\t\t\t\t{{ descriptionToShow }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tv-if="showExpandButton"\n\t\t\t\tclass="bx-im-sidebar-chat-description__show-more-button"\n\t\t\t\t@click="expanded = !expanded"\n\t\t\t>\n\t\t\t\t{{ loc('IM_SIDEBAR_CHAT_DESCRIPTION_SHOW') }}\n\t\t\t</button>\n\t\t</div>\n\t`};const vt={name:"InfoPreview",components:{ChatDescription:bt,ChatLinks:mt,ChatFavourites:gt},props:{dialogId:{type:String,required:true}},template:`\n\t\t<div class="bx-im-sidebar-info-preview__container">\n\t\t\t<ChatDescription :dialogId="dialogId" />\n\t\t\t<ChatFavourites :dialogId="dialogId" />\n\t\t\t<ChatLinks :dialogId="dialogId" />\n\t\t</div>\n\t`};const It={name:"FilePreviewItem",directives:{lazyload:s.lazyload},props:{fileItem:{type:Object,required:true}},computed:{sidebarFileItem(){return this.fileItem},file(){return this.$store.getters["files/get"](this.sidebarFileItem.fileId,true)},previewImageStyles(){if(!this.hasPreview){return{}}return{backgroundImage:`url('${this.file.urlPreview}')`}},hasPreview(){return this.file.urlPreview!==""},fileShortName(){const t=22;return y.Utils.file.getShortFileName(this.file.name,t)},viewerAttributes(){return y.Utils.file.getViewerDataAttributes(this.file.viewerAttrs)},isImage(){return this.file.type==="image"},isVideo(){return this.file.type==="video"},isAudio(){return this.file.type==="audio"},fileIconClass(){return`ui-icon ui-icon-file-${this.file.icon}`},isViewerAvailable(){return Object.keys(this.viewerAttributes).length>0}},methods:{download(){if(this.isViewerAvailable){return}const t=this.file.urlShow?this.file.urlShow:this.file.urlDownload;window.open(t,"_blank")}},template:`\n\t\t<div \n\t\t\tclass="bx-im-sidebar-file-preview-item__container bx-im-sidebar-file-preview-item__scope" \n\t\t\tv-bind="viewerAttributes" \n\t\t\t@click="download" \n\t\t\t:title="file.name"\n\t\t>\n\t\t\t<img\n\t\t\t\tv-if="isImage"\n\t\t\t\tv-lazyload\n\t\t\t\tdata-lazyload-dont-hide\n\t\t\t\t:data-lazyload-src="file.urlShow"\n\t\t\t\t:title="file.name"\n\t\t\t\t:alt="file.name"\n\t\t\t\tclass="bx-im-sidebar-file-preview-item__preview-box"\n\t\t\t/>\n\t\t\t<div \n\t\t\t\tv-else-if="isVideo" \n\t\t\t\tclass="bx-im-sidebar-file-preview-item__preview-box bx-im-sidebar-file-preview-item__preview-video-box"\n\t\t\t\t:style="previewImageStyles"\n\t\t\t>\n\t\t\t\t<video v-if="!hasPreview" class="bx-im-sidebar-file-preview-item__preview-video" preload="metadata" :src="file.urlDownload"></video>\n\t\t\t\t<div class="bx-im-sidebar-file-preview-item__preview-video-play-button"></div>\n\t\t\t\t<div class="bx-im-sidebar-file-preview-item__preview-video-play-icon"></div>\n\t\t\t</div>\n\t\t\t<div v-else-if="isAudio" class="bx-im-sidebar-file-preview-item__preview-box">\n\t\t\t\t<div class="bx-im-sidebar-file-preview-item__preview-audio-play-button"></div>\n\t\t\t</div>\n\t\t\t<div v-else class="bx-im-sidebar-file-preview-item__preview-box">\n\t\t\t\t<div :class="fileIconClass"><i></i></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-file-preview-item__text">{{ fileShortName }}</div>\n\t\t</div>\n\t`};const ft={name:"DetailEmptyState",props:{title:{type:String,required:true},iconType:{type:String,required:true}},computed:{iconClass(){return`--${S.Text.toKebabCase(this.iconType)}`}},template:`\n\t\t<div class="bx-im-sidebar-detail-empty-state__container bx-im-sidebar-detail-empty-state__scope">\n\t\t\t<span class="bx-im-sidebar-detail-empty-state__icon" :class="[iconClass]"></span>\n\t\t\t<span class="bx-im-sidebar-detail-empty-state__text">{{ title }}</span>\n\t\t</div>\n\t`};const _t={name:"FilePreview",components:{DetailEmptyState:ft,FilePreviewItem:It},props:{dialogId:{type:String,required:true}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,files(){if(this.isMigrationFinished){return this.$store.getters["sidebar/files/getLatest"](this.chatId)}return this.$store.getters["sidebar/files/getLatestUnsorted"](this.chatId)},hasFiles(){return this.files.length>0},isMigrationFinished(){return this.$store.state.sidebar.isFilesMigrated},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},methods:{onOpenDetail(){if(!this.hasFiles){return}const t=this.isMigrationFinished?E.SidebarDetailBlock.file:E.SidebarDetailBlock.fileUnsorted;L.EventEmitter.emit(E.EventType.sidebar.open,{panel:t,dialogId:this.dialogId})}},template:`\n\t\t<div class="bx-im-sidebar-file-preview__scope">\n\t\t\t<div class="bx-im-sidebar-file-preview__container">\n\t\t\t\t<div \n\t\t\t\t\tclass="bx-im-sidebar-file-preview__header_container" \n\t\t\t\t\t:class="[hasFiles ? '--active': '']" \n\t\t\t\t\t@click="onOpenDetail"\n\t\t\t\t>\n\t\t\t\t\t<span class="bx-im-sidebar-file-preview__title-text">\n\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_SIDEBAR_MEDIA_DETAIL_TITLE') }}\n\t\t\t\t\t</span>\n\t\t\t\t\t<div v-if="hasFiles" class="bx-im-sidebar__forward-icon"></div>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="hasFiles" class="bx-im-sidebar-file-preview__files-container">\n\t\t\t\t\t<FilePreviewItem v-for="file in files" :fileItem="file" />\n\t\t\t\t</div>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-else\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_MEDIA_AND_FILES_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.media"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};class xt extends n.BaseMenu{constructor(){super();this.id="im-sidebar-context-menu"}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName()}}getOpenContextMessageItem(){if(!this.context.messageId||this.context.messageId===0){return null}return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_GO_TO_CONTEXT_MESSAGE"),onclick:()=>{L.EventEmitter.emit(E.EventType.dialog.goToMessageContext,{messageId:this.context.messageId,dialogId:this.context.dialogId});this.menuInstance.close()}}}getCopyLinkItem(t){if(!BX.clipboard.isCopySupported()){return null}return{text:t,onclick:()=>{if(BX.clipboard.copy(this.context.source)){BX.UI.Notification.Center.notify({content:S.Loc.getMessage("IM_SIDEBAR_COPIED_SUCCESS")})}this.menuInstance.close()}}}}class Ct{constructor(){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient()}delete({id:t,chatId:e}){this.store.dispatch("sidebar/tasks/delete",{chatId:e,id:t});const i={LINK_ID:t};this.restClient.callMethod(E.RestMethod.imChatTaskDelete,i).catch((t=>{console.error("Im.Sidebar: error deleting task",t)}))}}class St extends xt{constructor(){super();this.id="im-sidebar-context-menu";this.taskManager=new Ct}getMenuItems(){return[this.getOpenContextMessageItem(),this.getCopyLinkItem(S.Loc.getMessage("IM_SIDEBAR_MENU_COPY_TASK_LINK")),this.getDeleteItem()]}getDeleteItem(){return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_DELETE_TASK_CONNECTION"),onclick:function(){this.taskManager.delete(this.context.task);this.menuInstance.close()}.bind(this)}}}const Mt={name:"TaskItem",components:{Avatar:D.Avatar,AvatarSize:D.AvatarSize},props:{task:{type:Object,required:true}},emits:["contextMenuClick"],data(){return{showContextButton:false}},computed:{AvatarSize:()=>D.AvatarSize,taskItem(){return this.task},taskTitle(){return this.taskItem.task.title},taskAuthorDialogId(){return this.taskItem.task.creatorId.toString()},taskResponsibleDialogId(){return this.taskItem.task.responsibleId.toString()},taskDeadlineText(){const t=S.Type.isStringFilled(this.taskItem.task.state)?this.taskItem.task.state:this.taskItem.task.statusTitle;return y.Utils.text.convertHtmlEntities(t)},taskBackgroundColorClass(){if(this.taskItem.task.status===5){return"--completed"}return""},statusColorClass(){if(!this.taskItem.task.color||!a.LabelColor[this.taskItem.task.color.toUpperCase()]){return""}return`ui-label-${this.taskItem.task.color.toLowerCase()}`}},methods:{onTaskClick(){BX.SidePanel.Instance.open(this.taskItem.task.source,{cacheable:false})},onContextMenuClick(t){this.$emit("contextMenuClick",{task:this.taskItem,source:this.taskItem.task.source,messageId:this.taskItem.messageId},t.currentTarget)}},template:`\n\t\t<div \n\t\t\tclass="bx-im-sidebar-task-item__container bx-im-sidebar-task-item__scope" \n\t\t\t:class="taskBackgroundColorClass"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<div class="bx-im-sidebar-task-item__content" @click="onTaskClick">\n\t\t\t\t<div class="bx-im-sidebar-task-item__header-text" :title="taskTitle">\n\t\t\t\t\t{{ taskTitle }}\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-sidebar-task-item__detail-container">\n\t\t\t\t\t<Avatar :size="AvatarSize.XS" :dialogId="taskAuthorDialogId" />\n\t\t\t\t\t<div class="bx-im-sidebar-task-item__forward-small-icon bx-im-sidebar__forward-small-icon"></div>\n\t\t\t\t\t<Avatar :size="AvatarSize.XS" :dialogId="taskResponsibleDialogId" />\n\t\t\t\t\t<div class="bx-im-sidebar-task-item__status-text" :class="statusColorClass">\n\t\t\t\t\t\t{{taskDeadlineText}}\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<button \n\t\t\t\tv-if="showContextButton"\n\t\t\t\tclass="bx-im-messenger__context-menu-icon" \n\t\t\t\t@click="onContextMenuClick"\n\t\t\t></button>\n\t\t</div>\n\t`};const kt={name:"TaskPreview",components:{DetailEmptyState:ft,TaskItem:Mt,MessengerButton:D.Button},props:{dialogId:{type:String,required:true}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,ButtonSize:()=>D.ButtonSize,ButtonColor:()=>D.ButtonColor,firstTask(){return this.$store.getters["sidebar/tasks/get"](this.chatId)[0]},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.contextMenu=new St},beforeUnmount(){this.contextMenu.destroy()},methods:{getEntityCreator(){if(!this.entityCreator){this.entityCreator=new b.EntityCreator(this.chatId)}return this.entityCreator},onAddClick(){this.getEntityCreator().createTaskForChat()},onOpenDetail(){if(!this.firstTask){return}L.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.task,dialogId:this.dialogId})},onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)}},template:`\n\t\t<div class="bx-im-sidebar-task-preview__scope">\n\t\t\t<div class="bx-im-sidebar-task-preview__container">\n\t\t\t\t<div \n\t\t\t\t\tclass="bx-im-sidebar-task-preview__header_container"\n\t\t\t\t\t:class="[firstTask ? '--active': '']"\n\t\t\t\t\t@click="onOpenDetail"\n\t\t\t\t>\n\t\t\t\t\t<div class="bx-im-sidebar-task-preview__title">\n\t\t\t\t\t\t<span class="bx-im-sidebar-task-preview__title-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_SIDEBAR_TASK_DETAIL_TITLE') }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<div v-if="firstTask" class="bx-im-sidebar__forward-icon"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<transition name="add-button">\n\t\t\t\t\t\t<MessengerButton\n\t\t\t\t\t\t\t:text="$Bitrix.Loc.getMessage('IM_SIDEBAR_ADD_BUTTON_TEXT')"\n\t\t\t\t\t\t\t:size="ButtonSize.S"\n\t\t\t\t\t\t\t:color="ButtonColor.PrimaryLight"\n\t\t\t\t\t\t\t:isRounded="true"\n\t\t\t\t\t\t\t:isUppercase="false"\n\t\t\t\t\t\t\ticon="plus"\n\t\t\t\t\t\t\t@click="onAddClick"\n\t\t\t\t\t\t\tclass="bx-im-sidebar-task-preview__title-button"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</transition>\n\t\t\t\t</div>\n\t\t\t\t<TaskItem v-if="firstTask" :task="firstTask" @contextMenuClick="onContextMenuClick"/>\n\t\t\t\t<DetailEmptyState \n\t\t\t\t\tv-else \n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_TASKS_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.task"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};class Lt extends n.RecentMenu{constructor(){super();this.id="im-sidebar-context-menu";this.permissionManager=f.PermissionManager.getInstance()}getMenuOptions(){return{...super.getMenuOptions(),className:this.getMenuClassName(),angle:false}}getMenuItems(){return[this.getUnreadMessageItem(),this.getPinMessageItem(),this.getCallItem(),this.getOpenProfileItem(),this.getOpenUserCalendarItem(),this.getChatsWithUserItem(),this.getAddMembersToChatItem(),this.getHideItem(),this.getLeaveItem()]}getOpenUserCalendarItem(){const t=this.store.getters["chats/isUser"](this.context.dialogId);if(!t){return null}const e=this.store.getters["users/get"](this.context.dialogId,true);if(e.bot){return null}const i=y.Utils.user.getCalendarLink(this.context.dialogId);return{text:S.Loc.getMessage("IM_LIB_MENU_OPEN_CALENDAR"),onclick:()=>{BX.SidePanel.Instance.open(i);this.menuInstance.close()}}}getAddMembersToChatItem(){const t=this.store.getters["users/get"](this.context.dialogId);if((t==null?void 0:t.bot)===true){return null}const e=this.permissionManager.canPerformAction(E.ChatActionType.extend,this.context.dialogId);if(!e){return null}return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_INVITE_MEMBERS"),onclick:()=>{this.emit(Lt.events.onAddToChatShow);this.menuInstance.close()}}}getJoinChatItem(){const t=this.store.getters["chats/get"](this.context.dialogId);const e=t.type===E.ChatType.user;if(e){return null}return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_JOIN_CHAT"),onclick:()=>{console.warn("sidebar menu: join chat is not implemented");this.menuInstance.close()}}}canShowFullMenu(t){const e=this.store.getters["recent/get"](t);return Boolean(e)}}Lt.events={onAddToChatShow:"onAddToChatShow"};const Tt={name:"MainHeader",components:{AddToChat:v.AddToChat},props:{dialogId:{type:String,required:true}},data(){return{showAddToChatPopup:false}},computed:{recentItem(){return this.$store.getters["recent/get"](this.dialogId,true)},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)}},created(){this.contextMenu=new Lt;this.contextMenu.subscribe(Lt.events.onAddToChatShow,this.onAddChatShow)},beforeUnmount(){this.contextMenu.destroy();this.contextMenu.unsubscribe(Lt.events.onAddToChatShow,this.onAddChatShow)},methods:{onAddChatShow(){this.showAddToChatPopup=true},onContextMenuClick(t){const e={dialogId:this.dialogId,...this.recentItem};this.contextMenu.openMenu(e,t.target)},onSidebarCloseClick(){L.EventEmitter.emit(E.EventType.sidebar.close)},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-header__container bx-im-sidebar-header__scope">\n\t\t\t<div class="bx-im-sidebar-header__title-container">\n\t\t\t\t<button \n\t\t\t\t\tclass="bx-im-sidebar-header__cross-icon bx-im-messenger__cross-icon" \n\t\t\t\t\t@click="onSidebarCloseClick"\n\t\t\t\t></button>\n\t\t\t\t<div class="bx-im-sidebar-header__title">{{ loc('IM_SIDEBAR_HEADER_TITLE') }}</div>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tclass="bx-im-sidebar-header__context-menu-icon bx-im-messenger__context-menu-icon"\n\t\t\t\t@click="onContextMenuClick"\n\t\t\t\tref="context-menu"\n\t\t\t></button>\n\t\t\t<AddToChat\n\t\t\t\t:bindElement="$refs['context-menu'] || {}"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:showPopup="showAddToChatPopup"\n\t\t\t\t:popupConfig="{offsetTop: 0, offsetLeft: -420}"\n\t\t\t\t@close="showAddToChatPopup = false"\n\t\t\t/>\n\t\t</div>\n\t`};const yt={name:"MarketItem",props:{item:{type:Object,required:true}},computed:{marketItem(){return this.item},iconClass(){return`fa ${this.marketItem.options.iconName}`},iconColor(){return this.marketItem.options.color}},template:`\n\t\t<div class="bx-im-sidebar-market-preview-item__container bx-im-sidebar-market-preview-item__scope">\n\t\t\t<div class="bx-im-sidebar-market-preview-item__icon-container" :style="{backgroundColor: iconColor}">\n\t\t\t\t<i :class="iconClass" aria-hidden="true"></i>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-market-preview-item__title-container" :title="marketItem.title">\n\t\t\t\t{{ marketItem.title }}\n\t\t\t</div>\n\t\t</div>\n\t`};const Bt={name:"MarketPreview",components:{MarketItem:yt},props:{dialogId:{type:String,required:true}},emits:["openDetail"],computed:{marketMenuItems(){return p.MarketManager.getInstance().getAvailablePlacementsByType(E.PlacementType.sidebar,this.dialogId)}},methods:{onMarketItemClick(t){L.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.market,dialogId:this.dialogId,entityId:t})},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-market-preview__scope bx-im-sidebar-market-preview__container">\n\t\t\t<div class="bx-im-sidebar-market-preview__header_container">\n\t\t\t\t<div class="bx-im-sidebar-market-preview__title">\n\t\t\t\t\t<span class="bx-im-sidebar-market-preview__title-text">\n\t\t\t\t\t\t{{ loc('IM_SIDEBAR_MARKET_DETAIL_TITLE') }}\n\t\t\t\t\t</span>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<MarketItem \n\t\t\t\tv-for="item in marketMenuItems" \n\t\t\t\t:key="item.id"\n\t\t\t\t:item="item"\n\t\t\t\t@click="onMarketItemClick(item.id)"\n\t\t\t/>\n\t\t</div>\n\t`};class Dt{constructor(){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient()}delete({id:t,chatId:e}){this.store.dispatch("sidebar/meetings/delete",{chatId:e,id:t});const i={LINK_ID:t};this.restClient.callMethod(E.RestMethod.imChatCalendarDelete,i).catch((t=>{console.error("Im.Sidebar: error deleting meeting",t)}))}}class Et extends xt{constructor(){super();this.id="im-sidebar-context-menu";this.meetingManager=new Dt}getMenuItems(){return[this.getOpenContextMessageItem(),this.getCopyLinkItem(S.Loc.getMessage("IM_SIDEBAR_MENU_COPY_MEETING_LINK")),this.getDeleteItem()]}getDeleteItem(){return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_DELETE_MEETING_CONNECTION"),onclick:function(){this.meetingManager.delete(this.context.meeting);this.menuInstance.close()}.bind(this)}}}const Pt={name:"MeetingItem",props:{meeting:{type:Object,required:true}},emits:["contextMenuClick"],data(){return{showContextButton:false}},computed:{meetingItem(){return this.meeting},title(){return this.meetingItem.meeting.title},date(){const t=this.meetingItem.meeting.dateFrom;return B.DateFormatter.formatByTemplate(t,B.DateTemplate.meeting)},day(){return this.meetingItem.meeting.dateFrom.getDate().toString()},monthShort(){return r.DateTimeFormat.format("M",this.meetingItem.meeting.dateFrom)},isActive(){return this.meetingItem.meeting.dateFrom.getTime()>Date.now()}},methods:{onMeetingClick(){new(window.top.BX||window.BX).Calendar.SliderLoader(this.meetingItem.meeting.id).show()},onContextMenuClick(t){this.$emit("contextMenuClick",{meeting:this.meetingItem,source:this.meetingItem.meeting.source,messageId:this.meetingItem.messageId},t.currentTarget)}},template:`\n\t\t<div \n\t\t\tclass="bx-im-sidebar-meeting-item__container bx-im-sidebar-meeting-item__scope"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<div \n\t\t\t\tclass="bx-im-sidebar-meeting-item__icon-container"\n\t\t\t\t:class="[isActive ? '--active' : '--inactive']"\n\t\t\t>\n\t\t\t\t<div class="bx-im-sidebar-meeting-item__day-text">{{ day }}</div>\n\t\t\t\t<div class="bx-im-sidebar-meeting-item__month-text">{{ monthShort }}</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-meeting-item__content-container" @click="onMeetingClick">\n\t\t\t\t<div class="bx-im-sidebar-meeting-item__content">\n\t\t\t\t\t<div class="bx-im-sidebar-meeting-item__title" :title="title">{{ title }}</div>\n\t\t\t\t\t<div class="bx-im-sidebar-meeting-item__date">{{ date }}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<button \n\t\t\t\tv-if="showContextButton"\n\t\t\t\tclass="bx-im-messenger__context-menu-icon" \n\t\t\t\t@click="onContextMenuClick"\n\t\t\t></button>\n\t\t</div>\n\t`};const At={name:"MeetingPreview",components:{MeetingItem:Pt,DetailEmptyState:ft,MessengerButton:D.Button},props:{dialogId:{type:String,required:true}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,ButtonSize:()=>D.ButtonSize,ButtonColor:()=>D.ButtonColor,firstMeeting(){return this.$store.getters["sidebar/meetings/get"](this.chatId)[0]},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.contextMenu=new Et},beforeUnmount(){this.contextMenu.destroy()},methods:{getEntityCreator(){if(!this.entityCreator){this.entityCreator=new b.EntityCreator(this.chatId)}return this.entityCreator},onAddClick(){this.getEntityCreator().createMeetingForChat()},onOpenDetail(){if(!this.firstMeeting){return}L.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.meeting,dialogId:this.dialogId})},onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)}},template:`\n\t\t<div class="bx-im-sidebar-meeting-preview__scope">\n\t\t\t<div class="bx-im-sidebar-meeting-preview__container">\n\t\t\t\t<div\n\t\t\t\t\tclass="bx-im-sidebar-meeting-preview__header_container"\n\t\t\t\t\t:class="[firstMeeting ? '--active': '']"\n\t\t\t\t\t@click="onOpenDetail"\n\t\t\t\t>\n\t\t\t\t\t<div class="bx-im-sidebar-meeting-preview__title">\n\t\t\t\t\t\t<span class="bx-im-sidebar-meeting-preview__title-text">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_SIDEBAR_MEETING_DETAIL_TITLE') }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t\t<div v-if="firstMeeting" class="bx-im-sidebar__forward-icon"></div>\n\t\t\t\t\t</div>\n\t\t\t\t\t<transition name="add-button">\n\t\t\t\t\t\t<MessengerButton\n\t\t\t\t\t\t\t:text="$Bitrix.Loc.getMessage('IM_SIDEBAR_ADD_BUTTON_TEXT')"\n\t\t\t\t\t\t\t:size="ButtonSize.S"\n\t\t\t\t\t\t\t:color="ButtonColor.PrimaryLight"\n\t\t\t\t\t\t\t:isRounded="true"\n\t\t\t\t\t\t\t:isUppercase="false"\n\t\t\t\t\t\t\ticon="plus"\n\t\t\t\t\t\t\t@click="onAddClick"\n\t\t\t\t\t\t\tclass="bx-im-sidebar-meeting-preview__title-button"\n\t\t\t\t\t\t/>\n\t\t\t\t\t</transition>\n\t\t\t\t</div>\n\t\t\t\t<MeetingItem v-if="firstMeeting" :meeting="firstMeeting" @contextMenuClick="onContextMenuClick"/>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-else\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_MEETINGS_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.meeting"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};const wt={name:"MuteChat",directives:{hint:o.hint},components:{Toggle:D.Toggle},props:{dialogId:{type:String,required:true}},data(){return{autoDeleteEnabled:false}},computed:{ToggleSize:()=>D.ToggleSize,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},isGroupChat(){return this.dialogId.startsWith("chat")},canBeMuted(){return f.PermissionManager.getInstance().canPerformAction(E.ChatActionType.mute,this.dialogId)},isChatMuted(){const t=this.dialog.muteList.find((t=>t===A.Core.getUserId()));return Boolean(t)},hintMuteNotAvailable(){if(this.canBeMuted){return null}return{text:this.$Bitrix.Loc.getMessage("IM_SIDEBAR_MUTE_NOT_AVAILABLE"),popupOptions:{angle:true,targetContainer:document.body,offsetLeft:141,offsetTop:-10,bindOptions:{position:"top"}}}}},methods:{getChatService(){if(!this.chatService){this.chatService=new x.ChatService}return this.chatService},muteActionHandler(){if(!this.canBeMuted){return}if(this.isChatMuted){this.getChatService().unmuteChat(this.dialogId)}else{this.getChatService().muteChat(this.dialogId)}},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div\n\t\t\tv-if="isGroupChat"\n\t\t\tclass="bx-im-sidebar-mute-chat__container"\n\t\t\t:class="[canBeMuted ? '' : '--not-active']"\n\t\t\tv-hint="hintMuteNotAvailable"\n\t\t>\n\t\t\t<div class="bx-im-sidebar-mute-chat__title">\n\t\t\t\t<div class="bx-im-sidebar-mute-chat__title-text bx-im-sidebar-mute-chat__icon">\n\t\t\t\t\t{{ loc('IM_SIDEBAR_ENABLE_NOTIFICATION_TITLE_2') }}\n\t\t\t\t</div>\n\t\t\t\t<Toggle :size="ToggleSize.M" :isEnabled="!isChatMuted" @change="muteActionHandler" />\n\t\t\t</div>\n\t\t</div>\n\t`};const Ft={name:"AutoDelete",directives:{hint:o.hint},components:{Toggle:D.Toggle},computed:{ToggleSize:()=>D.ToggleSize,hintAutoDeleteNotAvailable(){return{text:this.loc("IM_MESSENGER_NOT_AVAILABLE"),popupOptions:{bindOptions:{position:"top"},angle:true,targetContainer:document.body,offsetLeft:125,offsetTop:-10}}}},methods:{loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-auto-delete__container --not-active" v-hint="hintAutoDeleteNotAvailable">\n\t\t\t<div class="bx-im-sidebar-auto-delete__title">\n\t\t\t\t<div class="bx-im-sidebar-auto-delete__title-text bx-im-sidebar-auto-delete__icon">\n\t\t\t\t\t{{ loc('IM_SIDEBAR_ENABLE_AUTODELETE_TITLE') }}\n\t\t\t\t</div>\n\t\t\t\t<Toggle :size="ToggleSize.M" :isEnabled="false" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-auto-delete__status">\n\t\t\t\t{{ loc('IM_SIDEBAR_AUTODELETE_STATUS_OFF') }}\n\t\t\t</div>\n\t\t</div>\n\t`};const Rt={name:"ChatMembersAvatars",components:{Avatar:D.Avatar,MessengerButton:D.Button,AddToChat:v.AddToChat},props:{dialogId:{type:String,required:true}},data(){return{showAddToChatPopup:false}},computed:{AvatarSize:()=>D.AvatarSize,ButtonSize:()=>D.ButtonSize,ButtonColor:()=>D.ButtonColor,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId},dialogIds(){const t=4;const e=this.$store.getters["sidebar/members/get"](this.chatId);return e.map((t=>t.toString())).slice(0,t)},canSeeMembers(){return f.PermissionManager.getInstance().canPerformAction(E.ChatActionType.userList,this.dialogId)},canInviteMembers(){return f.PermissionManager.getInstance().canPerformAction(E.ChatActionType.extend,this.dialogId)},usersInChatCount(){return this.dialog.userCounter},moreUsersCount(){return Math.max(this.usersInChatCount-this.dialogIds.length,0)},isCopilotLayout(){const{name:t}=this.$store.getters["application/getLayout"];return t===E.Layout.copilot.name},addUsersButtonColor(){if(this.isCopilotLayout){return this.ButtonColor.Copilot}return this.ButtonColor.PrimaryLight}},methods:{onOpenUsers(){L.EventEmitter.emit(E.EventType.sidebar.open,{panel:E.SidebarDetailBlock.members,dialogId:this.dialogId})},onOpenInvitePopup(){this.showAddToChatPopup=true},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-chat-members-avatars__container">\n\t\t\t<div v-if="canSeeMembers" class="bx-im-sidebar-chat-members-avatars__members" @click="onOpenUsers">\n\t\t\t\t<div class="bx-im-sidebar-chat-members-avatars__avatars" >\n\t\t\t\t\t<Avatar\n\t\t\t\t\t\tclass="bx-im-sidebar-chat-members-avatars__avatar"\n\t\t\t\t\t\tv-for="id in dialogIds"\n\t\t\t\t\t\t:size="AvatarSize.S"\n\t\t\t\t\t\t:dialogId="id"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<div v-if="moreUsersCount > 0" class="bx-im-sidebar-chat-members-avatars__text">\n\t\t\t\t\t+{{ moreUsersCount }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div ref="add-members">\n\t\t\t\t<MessengerButton\n\t\t\t\t\tv-if="canInviteMembers"\n\t\t\t\t\t:text="loc('IM_SIDEBAR_ADD_BUTTON_TEXT')"\n\t\t\t\t\t:size="ButtonSize.S"\n\t\t\t\t\t:color="addUsersButtonColor"\n\t\t\t\t\t:isRounded="true"\n\t\t\t\t\t:isUppercase="false"\n\t\t\t\t\ticon="plus"\n\t\t\t\t\t@click="onOpenInvitePopup"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<AddToChat\n\t\t\t\t:bindElement="$refs['add-members'] || {}"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:showPopup="showAddToChatPopup"\n\t\t\t\t:popupConfig="{offsetTop: -220, offsetLeft: -420}"\n\t\t\t\t@close="showAddToChatPopup = false"\n\t\t\t/>\n\t\t</div>\n\t`};const Nt={name:"ChatPreview",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle,MuteChat:wt,ChatMembersAvatars:Rt,AutoDelete:Ft},props:{dialogId:{type:String,required:true}},computed:{AvatarSize:()=>D.AvatarSize},template:`\n\t\t<div class="bx-im-sidebar-main-preview__scope">\n\t\t\t<div class="bx-im-sidebar-main-preview-group-chat__avatar-container">\n\t\t\t\t<div class="bx-im-sidebar-main-preview-group-chat__avatar">\n\t\t\t\t\t<Avatar :size="AvatarSize.XXXL" :dialogId="dialogId" />\n\t\t\t\t</div>\n\t\t\t\t<ChatTitle :dialogId="dialogId" :twoLine="true" class="bx-im-sidebar-main-preview-group-chat__title" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-main-preview-group-chat__chat-members">\n\t\t\t\t<ChatMembersAvatars :dialogId="dialogId" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-main-preview-group-chat__settings">\n\t\t\t\t<MuteChat :dialogId="dialogId" />\n\t\t\t\t<AutoDelete />\n\t\t\t</div>\n\t\t</div>\n\t`};const Ut={name:"UserPreview",directives:{hint:o.hint},components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle,MessengerButton:D.Button,AddToChat:v.AddToChat,AutoDelete:Ft},props:{dialogId:{type:String,required:true}},data(){return{showAddToChatPopup:false}},computed:{AvatarSize:()=>D.AvatarSize,ButtonSize:()=>D.ButtonSize,ButtonColor:()=>D.ButtonColor,userPosition(){return this.$store.getters["users/getPosition"](this.dialogId)},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},user(){return this.$store.getters["users/get"](this.dialogId,true)},chatId(){return this.dialog.chatId},canInviteMembers(){return f.PermissionManager.getInstance().canPerformAction(E.ChatActionType.extend,this.dialogId)},showInviteButton(){if(this.isBot){return false}return this.canInviteMembers},userLink(){return y.Utils.user.getProfileLink(this.dialogId)},isBot(){return this.user.bot===true}},methods:{onAddClick(){this.showAddToChatPopup=true}},template:`\n\t\t<div class="bx-im-sidebar-main-preview__scope">\n\t\t\t<div class="bx-im-sidebar-main-preview-personal-chat__avatar-container">\n\t\t\t\t<Avatar\n\t\t\t\t\t:size="AvatarSize.XXXL"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\tclass="bx-im-sidebar-main-preview-personal-chat__avatar"\n\t\t\t\t/>\n\t\t\t\t<a :href="userLink" target="_blank">\n\t\t\t\t\t<ChatTitle :dialogId="dialogId" class="bx-im-sidebar-main-preview-personal-chat__user-name" />\n\t\t\t\t</a>\n\t\t\t\t<div class="bx-im-sidebar-main-preview-personal-chat__user-position" :title="userPosition">\n\t\t\t\t\t{{ userPosition }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div \n\t\t\t\tv-if="showInviteButton" \n\t\t\t\tclass="bx-im-sidebar-main-preview-personal-chat__invite-button-container" \n\t\t\t\tref="add-members"\n\t\t\t>\n\t\t\t\t<MessengerButton\n\t\t\t\t\tv-if="canInviteMembers"\n\t\t\t\t\t:text="$Bitrix.Loc.getMessage('IM_SIDEBAR_CREATE_GROUP_CHAT')"\n\t\t\t\t\t:size="ButtonSize.S"\n\t\t\t\t\t:color="ButtonColor.PrimaryLight"\n\t\t\t\t\t:isRounded="true"\n\t\t\t\t\t:isUppercase="false"\n\t\t\t\t\ticon="plus"\n\t\t\t\t\t@click="onAddClick"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-main-preview-personal-chat__auto-delete-container">\n\t\t\t\t<AutoDelete :dialogId="dialogId" />\n\t\t\t</div>\n\t\t\t<AddToChat\n\t\t\t\t:bindElement="$refs['add-members'] || {}"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:showPopup="showAddToChatPopup"\n\t\t\t\t:popupConfig="{offsetTop: -220, offsetLeft: -320}"\n\t\t\t\t@close="showAddToChatPopup = false"\n\t\t\t/>\n\t\t</div>\n\t`};const $t={name:"SidebarSkeleton",template:`\n\t\t<div class="bx-im-sidebar-skeleton__container">\n\t\t\t<div class="bx-im-sidebar-skeleton__block">\n\t\t\t\t<div class="bx-im-sidebar-skeleton__avatar"></div>\n\t\t\t\t<div class="bx-im-sidebar-skeleton__invite-button"></div>\n\t\t\t\t<div class="bx-im-sidebar-skeleton__settings"></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-skeleton__block">\n\t\t\t\t<div class="bx-im-sidebar-skeleton__info"></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-skeleton__block">\n\t\t\t\t<div class="bx-im-sidebar-skeleton__files"></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-skeleton__block">\n\t\t\t\t<div class="bx-im-sidebar-skeleton__tasks"></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ot={name:"MainPanel",components:{MainHeader:Tt,ChatPreview:Nt,UserPreview:Ut,InfoPreview:vt,FilePreview:_t,TaskPreview:kt,MeetingPreview:At,FileUnsortedPreview:_t,MarketPreview:Bt,SidebarSkeleton:$t},props:{dialogId:{type:String,required:true}},data(){return{isLoading:false}},computed:{blocks(){return Q(this.dialogId)},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},dialogInited(){return this.dialog.inited},chatId(){return this.dialog.chatId},hasInitialData(){return this.$store.getters["sidebar/isInited"](this.chatId)}},watch:{chatId(t){if(t>0){this.initializeSidebar()}}},created(){this.initializeSidebar()},methods:{getPreviewComponentName(t){return`${t}Preview`},initializeSidebar(){if(this.hasInitialData){this.isLoading=false;return}this.sidebarService=new ut({dialogId:this.dialogId});this.isLoading=true;this.sidebarService.requestInitialData().then((()=>{this.isLoading=false})).catch((t=>{C.Logger.warn("Sidebar: request initial data error:",t)}))}},template:`\n\t\t<div class="bx-im-sidebar-main-panel__container">\n\t\t\t<MainHeader :dialogId="dialogId" />\n\t\t\t<SidebarSkeleton v-if="isLoading" />\n\t\t\t<div v-else class="bx-im-sidebar-main-panel__blocks">\n\t\t\t\t<component\n\t\t\t\t\tv-for="block in blocks"\n\t\t\t\t\t:key="block"\n\t\t\t\t\tclass="bx-im-sidebar-main-panel__block"\n\t\t\t\t\t:is="getPreviewComponentName(block)"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ht={name:"DateGroup",props:{dateText:{type:String,required:true}},template:`\n\t\t<div class="bx-im-sidebar-date-group__container bx-im-sidebar-date-group__scope">\n\t\t\t<div class="bx-im-sidebar-date-group__text">\n\t\t\t\t{{ dateText }}\n\t\t\t</div>\n\t\t</div>\n\t`};const Gt={name:"DetailHeader",components:{ChatButton:D.Button},props:{title:{type:String,required:true},secondLevel:{type:Boolean,default:false},withAddButton:{type:Boolean,default:false}},emits:["back","addClick"],computed:{ButtonSize:()=>D.ButtonSize,ButtonColor:()=>D.ButtonColor},template:`\n\t\t<div class="bx-im-sidebar-detail-header__container bx-im-sidebar-detail-header__scope">\n\t\t\t<div class="bx-im-sidebar-detail-header__title-container">\n\t\t\t\t<button\n\t\t\t\t\t:class="{'bx-im-messenger__cross-icon': !secondLevel, 'bx-im-sidebar__back-icon': secondLevel}"\n\t\t\t\t\t@click="$emit('back')"\n\t\t\t\t></button>\n\t\t\t\t<div class="bx-im-sidebar-detail-header__title-text">{{ title }}</div>\n\t\t\t\t<div v-if="withAddButton" class="bx-im-sidebar-detail-header__add-button" ref="add-button">\n\t\t\t\t\t<ChatButton\n\t\t\t\t\t\t:text="$Bitrix.Loc.getMessage('IM_SIDEBAR_ADD_BUTTON_TEXT')"\n\t\t\t\t\t\t:size="ButtonSize.S"\n\t\t\t\t\t\t:color="ButtonColor.PrimaryLight"\n\t\t\t\t\t\t:isRounded="true"\n\t\t\t\t\t\t:isUppercase="false"\n\t\t\t\t\t\ticon="plus"\n\t\t\t\t\t\t@click="$emit('addClick', {target: $refs['add-button']})"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};class zt{constructor(){this.cachedDateGroups={}}format(t){const e={};t.forEach((t=>{const i=this.getDateGroup(t.date);if(!e[i.title]){e[i.title]={dateGroupTitle:i.title,items:[]}}e[i.title].items.push(t)}));return Object.values(e)}getDateGroup(t){const e=10;const i=t.toJSON().slice(0,e);if(this.cachedDateGroups[i]){return this.cachedDateGroups[i]}this.cachedDateGroups[i]={id:i,title:B.DateFormatter.formatByTemplate(t,B.DateTemplate.dateGroup)};return this.cachedDateGroups[i]}destroy(){this.cachedDateGroups={}}}const qt={name:"TaskPanel",components:{TaskItem:Mt,DateGroup:Ht,DetailHeader:Gt,DetailEmptyState:ft,Loader:D.Loader},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,tasks(){return this.$store.getters["sidebar/tasks/get"](this.chatId)},formattedCollection(){return this.collectionFormatter.format(this.tasks)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.collectionFormatter=new zt;this.contextMenu=new St;this.service=new st({dialogId:this.dialogId})},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.task})},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/tasks/hasNextPage"](this.chatId);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage();this.isLoading=false},onAddClick(){new b.EntityCreator(this.chatId).createTaskForChat()}},template:`\n\t\t<div class="bx-im-sidebar-task-detail__scope">\n\t\t\t<DetailHeader\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_TASK_DETAIL_TITLE')"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t:withAddButton="true"\n\t\t\t\t@addClick="onAddClick"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<div class="bx-im-sidebar-task-detail__container bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-task-detail__date-group_container">\n\t\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t\t<TaskItem\n\t\t\t\t\t\tv-for="task in dateGroup.items"\n\t\t\t\t\t\t:task="task"\n\t\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_TASKS_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.task"\n\t\t\t\t/>\n\t\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t\t</div>\n\t\t</div>\n\t`};const Xt=50;const Vt={name:"DetailTabs",props:{tabs:{type:Array,default:()=>[]}},emits:["tabSelect"],data(){return{hasLeftControl:false,hasRightControl:false,currentElementIndex:0,highlightOffsetLeft:0,highlightWidth:0}},computed:{highlightStyle(){return{left:`${this.highlightOffsetLeft}px`,width:`${this.highlightWidth}px`}}},watch:{currentElementIndex(t){this.updateHighlightPosition(t);this.$emit("tabSelect",this.tabs[t]);this.scrollToElement(t)}},mounted(){if(this.$refs.tabs.scrollWidth>this.$refs.tabs.offsetWidth){this.hasRightControl=true}this.updateHighlightPosition(this.currentElementIndex)},methods:{getElementNodeByIndex(t){return[...this.$refs.tabs.children].filter((t=>!S.Dom.hasClass(t,"bx-sidebar-tabs-highlight")))[t]},updateHighlightPosition(t){const e=this.getElementNodeByIndex(t);this.highlightOffsetLeft=e.offsetLeft;this.highlightWidth=e.offsetWidth},scrollToElement(t){const e=this.getElementNodeByIndex(t);this.$refs.tabs.scroll({left:e.offsetLeft-Xt,behavior:"smooth"})},onTabClick(t){this.currentElementIndex=t.index},getTabTitle(t){const e=`IM_SIDEBAR_FILES_${t.toUpperCase()}_TAB`;return this.$Bitrix.Loc.getMessage(e)},isSelectedTab(t){return t===this.currentElementIndex},onLeftClick(){if(this.currentElementIndex<=0){return}this.currentElementIndex--},onRightClick(){if(this.currentElementIndex>=this.tabs.length-1){return}this.currentElementIndex++},updateControlsVisibility(){this.hasRightControl=this.$refs.tabs.scrollWidth>this.$refs.tabs.scrollLeft+this.$refs.tabs.clientWidth;this.hasLeftControl=this.$refs.tabs.scrollLeft>0}},template:`\n\t\t<div class="bx-im-sidebar-detail-tabs__container bx-im-sidebar-detail-tabs__scope">\n\t\t\t<div v-if="hasLeftControl" @click.stop="onLeftClick" class="bx-im-sidebar-ears__control --left">\n\t\t\t\t<div class="bx-im-sidebar__forward-icon"></div>\n\t\t\t</div>\n\t\t\t<div v-if="hasRightControl" @click.stop="onRightClick" class="bx-im-sidebar-ears__control --right">\n\t\t\t\t<div class="bx-im-sidebar__forward-icon"></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-ears__elements" ref="tabs" @scroll.passive="updateControlsVisibility">\n\t\t\t\t<div class="bx-sidebar-tabs-highlight" :style="highlightStyle"></div>\n\t\t\t\t<div\n\t\t\t\t\tv-for="(tab, index) in tabs"\n\t\t\t\t\t:key="tab"\n\t\t\t\t\tclass="bx-im-sidebar-detail-tabs__item"\n\t\t\t\t\t:class="[isSelectedTab(index) ? '--selected' : '']"\n\t\t\t\t\t@click="onTabClick({index: index})"\n\t\t\t\t>\n\t\t\t\t\t<div class="bx-im-sidebar-detail-tabs__item-title">{{ getTabTitle(tab) }}</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Qt={name:"MediaDetailItem",components:{SocialVideo:l.SocialVideo,Avatar:D.Avatar},props:{fileItem:{type:Object,required:true}},emits:["contextMenuClick"],data(){return{showContextButton:false,videoDuration:0}},computed:{AvatarSize:()=>D.AvatarSize,sidebarFileItem(){return this.fileItem},file(){return this.$store.getters["files/get"](this.sidebarFileItem.fileId,true)},previewPicture(){if(!this.hasPreview){return{}}return{backgroundImage:`url('${this.file.urlPreview}')`}},hasPreview(){return this.file.urlPreview!==""},isImage(){return this.file.type==="image"},isVideo(){return this.file.type==="video"},viewerAttributes(){return y.Utils.file.getViewerDataAttributes(this.file.viewerAttrs)},videoDurationText(){if(this.videoDuration===0){return"--:--"}return this.formatTime(this.videoDuration)}},methods:{formatTime(t){t=Math.floor(t);const e=Math.floor(t/60/60);if(e>0){t-=e*60*60}const i=Math.floor(t/60);if(i>0){t-=i*60}const s=e>0?`${e}:`:"";const a=s>0?`${i.toString().padStart(2,"0")}:`:`${i}:`;const n=t.toString().padStart(2,"0");return s+a+n},handleVideoEvent(){if(!this.$refs.video){return}this.videoDuration=this.$refs.video.duration},onContextMenuClick(t){this.$emit("contextMenuClick",{sidebarFile:this.sidebarFileItem,file:this.file,messageId:this.sidebarFileItem.messageId},t.currentTarget)}},template:`\n\t\t<div \n\t\t\tclass="bx-im-sidebar-file-media-detail-item__container bx-im-sidebar-file-media-detail-item__scope"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<div class="bx-im-sidebar-file-media-detail-item__header-container">\n\t\t\t\t<div class="bx-im-sidebar-file-media-detail-item__avatar-container">\n\t\t\t\t\t<Avatar :dialogId="sidebarFileItem.authorId" :size="AvatarSize.S"></Avatar>\n\t\t\t\t</div>\n\t\t\t\t<button\n\t\t\t\t\tv-if="showContextButton"\n\t\t\t\t\tclass="bx-im-sidebar-file-media-detail-item__context-menu bx-im-messenger__context-menu-icon"\n\t\t\t\t\t@click="onContextMenuClick"\n\t\t\t\t></button>\n\t\t\t</div>\n\t\t\t<div \n\t\t\t\tv-if="isImage"\n\t\t\t\tclass="bx-im-sidebar-file-media-detail-item__content --image" \n\t\t\t\t:style="previewPicture"\n\t\t\t\tv-bind="viewerAttributes"\n\t\t\t\t:title="file.name"\n\t\t\t>\n\t\t\t</div>\n\t\t\t<div\n\t\t\t\tv-if="isVideo"\n\t\t\t\tclass="bx-im-sidebar-file-media-detail-item__content --video"\n\t\t\t\t:style="previewPicture"\n\t\t\t\tv-bind="viewerAttributes"\n\t\t\t\t:title="file.name"\n\t\t\t>\n\t\t\t\t<video \n\t\t\t\t\tv-show="!hasPreview"\n\t\t\t\t\tref="video"\n\t\t\t\t\tclass="bx-im-sidebar-file-media-detail-item__video" \n\t\t\t\t\tpreload="metadata" :src="file.urlDownload"\n\t\t\t\t\t@durationchange="handleVideoEvent"\n\t\t\t\t\t@loadeddata="handleVideoEvent"\n\t\t\t\t\t@loadedmetadata="handleVideoEvent"\n\t\t\t\t></video>\n\t\t\t</div>\n\t\t\t<div v-if="isVideo" class="bx-im-sidebar-file-media-detail-item__video-controls">\n\t\t\t\t<span class="bx-im-sidebar-file-media-detail-item__video-controls-icon"></span>\n\t\t\t\t<span class="bx-im-sidebar-file-media-detail-item__video-controls-time">{{ videoDurationText }}</span>\n\t\t\t</div>\n\t\t</div>\n\t`};class Kt{constructor(){this.store=A.Core.getStore();this.diskService=new x.DiskService}delete(t){this.store.dispatch("sidebar/files/delete",{dialogId:t.chatId,id:t.id});this.diskService.delete({chatId:t.chatId,fileId:t.fileId})}saveOnDisk(t){return this.diskService.save(t)}}class jt extends xt{constructor(){super();this.id="im-sidebar-context-menu";this.mediaManager=new Kt}getMenuItems(){return[this.getOpenContextMessageItem(),this.getDownloadFileItem(),this.getSaveFileOnDiskItem(),this.getDeleteFileItem()]}getViewFileItem(){const t=y.Utils.file.getViewerDataAttributes(this.context.file.viewerAttrs);if(!t||this.context.file.type==="audio"){return null}return{html:this.getViewHtml(t),onclick:function(){this.menuInstance.close()}.bind(this)}}getDownloadFileItem(){if(!this.context.file.urlDownload){return null}return{html:this.getDownloadHtml(this.context.file.urlDownload,this.context.file.name),onclick:function(){this.menuInstance.close()}.bind(this)}}getSaveFileOnDiskItem(){if(!this.context.sidebarFile.fileId){return null}return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_SAVE_FILE_ON_DISK_MSGVER_1"),onclick:function(){this.mediaManager.saveOnDisk(this.context.sidebarFile.fileId).then((()=>{BX.UI.Notification.Center.notify({content:S.Loc.getMessage("IM_SIDEBAR_FILE_SAVE_ON_DISK_SUCCESS")})}));this.menuInstance.close()}.bind(this)}}getDeleteFileItem(){if(this.getCurrentUserId()!==this.context.sidebarFile.authorId){return null}return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_DELETE_FILE"),onclick:function(){this.mediaManager.delete(this.context.sidebarFile);this.menuInstance.close()}.bind(this)}}getViewHtml(t){const e=S.Dom.create("div",{text:S.Loc.getMessage("IM_SIDEBAR_MENU_VIEW_FILE")});Object.entries(t).forEach((t=>{const[i,s]=t;e.setAttribute(i,s)}));return e}getDownloadHtml(t,e){const i=S.Dom.create("a",{text:S.Loc.getMessage("IM_SIDEBAR_MENU_DOWNLOAD_FILE")});S.Dom.style(i,"display","block");S.Dom.style(i,"color","inherit");S.Dom.style(i,"text-decoration","inherit");i.setAttribute("href",t);i.setAttribute("download",e);return i}}const Yt={name:"MediaTab",components:{DateGroup:Ht,MediaDetailItem:Qt,DetailEmptyState:ft,Loader:D.Loader},props:{dialogId:{type:String,required:true}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId},files(){return this.$store.getters["sidebar/files/get"](this.chatId,E.SidebarFileTypes.media)},formattedCollection(){return this.collectionFormatter.format(this.files)},isEmptyState(){return this.formattedCollection.length===0}},created(){this.service=new et({dialogId:this.dialogId});this.collectionFormatter=new zt;this.contextMenu=new jt},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/files/hasNextPage"](this.chatId,E.SidebarFileTypes.media);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage(E.SidebarFileTypes.media);this.isLoading=false}},template:`\n\t\t<div class="bx-im-sidebar-file-media-detail__scope bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-file-media-detail__date-group_container">\n\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t<div class="bx-im-sidebar-file-media-detail__items-group">\n\t\t\t\t\t<MediaDetailItem\n\t\t\t\t\t\tv-for="file in dateGroup.items"\n\t\t\t\t\t\t:fileItem="file"\n\t\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<DetailEmptyState\n\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FILES_EMPTY')"\n\t\t\t\t:iconType="SidebarDetailBlock.media"\n\t\t\t/>\n\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t</div>\n\t`};const Wt={name:"AudioDetailItem",components:{AudioPlayer:D.AudioPlayer,Avatar:D.Avatar},props:{id:{type:Number,required:true},fileItem:{type:Object,required:true}},emits:["contextMenuClick"],data(){return{timelineType:0}},computed:{AvatarSize:()=>D.AvatarSize,sidebarFileItem(){return this.fileItem},file(){return this.$store.getters["files/get"](this.sidebarFileItem.fileId,true)},audioUrl(){return this.file.urlDownload}},created(){this.timelineType=Math.floor(Math.random()*5)},methods:{onContextMenuClick(t){this.$emit("contextMenuClick",{sidebarFile:this.sidebarFileItem,file:this.file,messageId:this.sidebarFileItem.messageId},t.currentTarget)}},template:`\n\t\t<div class="bx-im-sidebar-file-audio-detail-item__container bx-im-sidebar-file-audio-detail-item__scope">\n\t\t\t<AudioPlayer \n\t\t\t\t:id="id"\n\t\t\t\t:src="audioUrl" \n\t\t\t\t:file="file" \n\t\t\t\t:timelineType="timelineType" \n\t\t\t\t:authorId="sidebarFileItem.authorId" \n\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t/>\n\t\t</div>\n\t`};const Jt={name:"AudioTab",components:{DetailEmptyState:ft,AudioDetailItem:Wt,DateGroup:Ht,Loader:D.Loader},props:{dialogId:{type:String,required:true}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,files(){return this.$store.getters["sidebar/files/get"](this.chatId,E.SidebarFileTypes.audio)},formattedCollection(){return this.collectionFormatter.format(this.files)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.service=new et({dialogId:this.dialogId});this.collectionFormatter=new zt;this.contextMenu=new jt},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/files/hasNextPage"](this.chatId,E.SidebarFileTypes.audio);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage(E.SidebarFileTypes.audio);this.isLoading=false}},template:`\n\t\t<div class="bx-im-sidebar-file-audio-detail__scope bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-file-audio-detail__date-group_container">\n\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t<AudioDetailItem\n\t\t\t\t\tv-for="file in dateGroup.items"\n\t\t\t\t\t:id="file.id"\n\t\t\t\t\t:fileItem="file"\n\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<DetailEmptyState\n\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FILES_EMPTY')"\n\t\t\t\t:iconType="SidebarDetailBlock.audio"\n\t\t\t/>\n\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t</div>\n\t`};const Zt={name:"BriefItem",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle},props:{brief:{type:Object,required:true}},emits:["contextMenuClick"],data(){return{showContextButton:false}},computed:{AvatarSize:()=>D.AvatarSize,sidebarFileItem(){return this.brief},file(){return this.$store.getters["files/get"](this.sidebarFileItem.fileId,true)},fileShortName(){const t=15;return y.Utils.file.getShortFileName(this.file.name,t)},fileSize(){return y.Utils.file.formatFileSize(this.file.size)},viewerAttributes(){return y.Utils.file.getViewerDataAttributes(this.file.viewerAttrs)},isViewerAvailable(){return Object.keys(this.viewerAttributes).length>0}},methods:{download(){if(this.isViewerAvailable){return}const t=this.file.urlShow?this.file.urlShow:this.file.urlDownload;window.open(t,"_blank")},onContextMenuClick(t){this.$emit("contextMenuClick",{sidebarFile:this.sidebarFileItem,file:this.file,messageId:this.sidebarFileItem.messageId},t.currentTarget)}},template:`\n\t\t<div \n\t\t\tclass="bx-im-sidebar-brief-item__container bx-im-sidebar-brief-item__scope"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<div class="bx-im-sidebar-brief-item__icon-container"></div>\n\t\t\t<div class="bx-im-sidebar-brief-item__content-container">\n\t\t\t\t<div class="bx-im-sidebar-brief-item__content">\n\t\t\t\t\t<div class="bx-im-sidebar-brief-item__title" @click="download" v-bind="viewerAttributes">\n\t\t\t\t\t\t<span class="bx-im-sidebar-brief-item__title-text" :title="file.name">{{fileShortName}}</span>\n\t\t\t\t\t\t<span class="bx-im-sidebar-brief-item__size-text">{{fileSize}}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-sidebar-brief-item__author-container">\n\t\t\t\t\t\t<Avatar \n\t\t\t\t\t\t\t:dialogId="sidebarFileItem.authorId" \n\t\t\t\t\t\t\t:size="AvatarSize.XS"\n\t\t\t\t\t\t\tclass="bx-im-sidebar-brief-item__author-avatar" \n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<ChatTitle :dialogId="sidebarFileItem.authorId" :showItsYou="false" />\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tv-if="showContextButton"\n\t\t\t\tclass="bx-im-messenger__context-menu-icon bx-im-sidebar-brief-item__context-menu-button"\n\t\t\t\t@click="onContextMenuClick"\n\t\t\t></button>\n\t\t</div>\n\t`};const te={name:"BriefTab",components:{DateGroup:Ht,BriefItem:Zt,DetailEmptyState:ft,Loader:D.Loader},props:{dialogId:{type:String,required:true}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,files(){return this.$store.getters["sidebar/files/get"](this.chatId,E.SidebarFileTypes.brief)},formattedCollection(){return this.collectionFormatter.format(this.files)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.service=new et({dialogId:this.dialogId});this.collectionFormatter=new zt;this.contextMenu=new jt},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/files/hasNextPage"](this.chatId,E.SidebarFileTypes.brief);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage(E.SidebarFileTypes.brief);this.isLoading=false}},template:`\n\t\t<div class="bx-im-sidebar-brief-detail__scope bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-brief-detail__date-group_container">\n\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle"/>\n\t\t\t\t<BriefItem\n\t\t\t\t\tv-for="file in dateGroup.items"\n\t\t\t\t\t:brief="file"\n\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<DetailEmptyState\n\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_BRIEFS_EMPTY')"\n\t\t\t\t:iconType="SidebarDetailBlock.brief"\n\t\t\t/>\n\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t</div>\n\t`};const ee={name:"DocumentDetailItem",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle},props:{fileItem:{type:Object,required:true}},emits:["contextMenuClick"],data(){return{showContextButton:false}},computed:{AvatarSize:()=>D.AvatarSize,sidebarFileItem(){return this.fileItem},file(){return this.$store.getters["files/get"](this.sidebarFileItem.fileId,true)},fileIconClass(){return`ui-icon ui-icon-file-${this.file.icon}`},fileShortName(){const t=15;return y.Utils.file.getShortFileName(this.file.name,t)},fileSize(){return y.Utils.file.formatFileSize(this.file.size)},viewerAttributes(){return y.Utils.file.getViewerDataAttributes(this.file.viewerAttrs)},isViewerAvailable(){return Object.keys(this.viewerAttributes).length>0},authorId(){return this.sidebarFileItem.authorId}},methods:{download(){if(this.isViewerAvailable){return}const t=this.file.urlShow?this.file.urlShow:this.file.urlDownload;window.open(t,"_blank")},onContextMenuClick(t){this.$emit("contextMenuClick",{sidebarFile:this.sidebarFileItem,file:this.file,messageId:this.sidebarFileItem.messageId},t.currentTarget)}},template:`\n\t\t<div \n\t\t\tclass="bx-im-sidebar-file-document-detail-item__container bx-im-sidebar-file-document-detail-item__scope"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\t\t\n\t\t>\n\t\t\t<div class="bx-im-sidebar-file-document-detail-item__icon-container">\n\t\t\t\t<div :class="fileIconClass"><i></i></div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-file-document-detail-item__content-container" v-bind="viewerAttributes">\n\t\t\t\t<div class="bx-im-sidebar-file-document-detail-item__content">\n\t\t\t\t\t<div class="bx-im-sidebar-file-document-detail-item__document-title" @click="download" :title="file.name">\n\t\t\t\t\t\t<span class="bx-im-sidebar-file-document-detail-item__document-title-text">{{fileShortName}}</span>\n\t\t\t\t\t\t<span class="bx-im-sidebar-file-document-detail-item__document-size">{{fileSize}}</span>\n\t\t\t\t\t</div>\n\t\t\t\t\t<div class="bx-im-sidebar-file-document-detail-item__author-container">\n\t\t\t\t\t\t<template v-if="authorId > 0">\n\t\t\t\t\t\t\t<Avatar\n\t\t\t\t\t\t\t\t:dialogId="authorId"\n\t\t\t\t\t\t\t\t:size="AvatarSize.XS"\n\t\t\t\t\t\t\t\tclass="bx-im-sidebar-file-document-detail-item__author-avatar"\n\t\t\t\t\t\t\t/>\n\t\t\t\t\t\t\t<ChatTitle :dialogId="authorId" :showItsYou="false" />\n\t\t\t\t\t\t</template>\n\t\t\t\t\t\t<span v-else class="bx-im-sidebar-file-document-detail-item__system-author-text">\n\t\t\t\t\t\t\t{{$Bitrix.Loc.getMessage('IM_SIDEBAR_SYSTEM_USER')}}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<button\n\t\t\t\tv-if="showContextButton"\n\t\t\t\tclass="bx-im-messenger__context-menu-icon" \n\t\t\t\t@click="onContextMenuClick"\n\t\t\t></button>\n\t\t</div>\n\t`};const ie={name:"OtherTab",components:{DateGroup:Ht,DocumentDetailItem:ee,DetailEmptyState:ft,Loader:D.Loader},props:{dialogId:{type:String,required:true}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,files(){return this.$store.getters["sidebar/files/get"](this.chatId,E.SidebarFileTypes.other)},formattedCollection(){return this.collectionFormatter.format(this.files)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.service=new et({dialogId:this.dialogId});this.collectionFormatter=new zt;this.contextMenu=new jt},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/files/hasNextPage"](this.chatId,E.SidebarFileTypes.other);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage(E.SidebarFileTypes.other);this.isLoading=false}},template:`\n\t\t<div class="bx-im-sidebar-file-other-detail__scope bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-file-other-detail__date-group_container">\n\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t<DocumentDetailItem\n\t\t\t\t\tv-for="file in dateGroup.items"\n\t\t\t\t\t:fileItem="file"\n\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<DetailEmptyState\n\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FILES_EMPTY')"\n\t\t\t\t:iconType="SidebarDetailBlock.other"\n\t\t\t/>\n\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t</div>\n\t`};const se={name:"DocumentTab",components:{DateGroup:Ht,DocumentDetailItem:ee,DetailEmptyState:ft,Loader:D.Loader},props:{dialogId:{type:String,required:true}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,files(){return this.$store.getters["sidebar/files/get"](this.chatId,E.SidebarFileTypes.document)},formattedCollection(){return this.collectionFormatter.format(this.files)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.service=new et({dialogId:this.dialogId});this.collectionFormatter=new zt;this.contextMenu=new jt},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/files/hasNextPage"](this.chatId,E.SidebarFileTypes.document);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage(E.SidebarFileTypes.document);this.isLoading=false}},template:`\n\t\t<div class="bx-im-sidebar-file-document-detail__scope bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-file-document-detail__date-group_container">\n\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t<DocumentDetailItem\n\t\t\t\t\tv-for="file in dateGroup.items"\n\t\t\t\t\t:fileItem="file"\n\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t\t<DetailEmptyState\n\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FILES_EMPTY')"\n\t\t\t\t:iconType="SidebarDetailBlock.document"\n\t\t\t/>\n\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t</div>\n\t`};const ae={name:"FilePanel",components:{DetailHeader:Gt,DetailTabs:Vt,MediaTab:Yt,AudioTab:Jt,DocumentTab:se,BriefTab:te,OtherTab:ie},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{tab:E.SidebarFileTabTypes.media}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,tabComponentName(){return`${S.Text.capitalize(this.tab)}Tab`},tabs(){const t=Object.values(E.SidebarFileTabTypes);const e=S.Extension.getSettings("im.v2.component.sidebar");const i=e.get("canShowBriefs",false);if(!i){return t.filter((t=>t!==E.SidebarDetailBlock.brief))}return t}},methods:{onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.file})},onTabSelect(t){this.tab=t}},template:`\n\t\t<div>\n\t\t\t<DetailHeader\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_MEDIA_DETAIL_TITLE')"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<DetailTabs :tabs="tabs" @tabSelect="onTabSelect" />\n\t\t\t<KeepAlive>\n\t\t\t\t<component :is="tabComponentName" :dialogId="dialogId" />\n\t\t\t</KeepAlive>\n\t\t</div>\n\t`};const ne={name:"FileUnsortedPanel",components:{DateGroup:Ht,DocumentDetailItem:ee,DetailEmptyState:ft,DetailHeader:Gt,Loader:D.Loader},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,files(){return this.$store.getters["sidebar/files/get"](this.chatId,E.SidebarFileTypes.fileUnsorted)},formattedCollection(){return this.collectionFormatter.format(this.files)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.service=new dt({dialogId:this.dialogId});this.collectionFormatter=new zt;this.contextMenu=new jt},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/files/hasNextPage"](this.chatId,E.SidebarFileTypes.fileUnsorted);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage();this.isLoading=false},onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.fileUnsorted})}},template:`\n\t\t<div class="bx-im-sidebar-file-unsorted-detail__scope">\n\t\t\t<DetailHeader\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FILEUNSORTED_DETAIL_TITLE')"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<div class="bx-im-sidebar-file-unsorted-detail__container bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-file-unsorted-detail__date-group_container">\n\t\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t\t<DocumentDetailItem\n\t\t\t\t\t\tv-for="file in dateGroup.items"\n\t\t\t\t\t\t:fileItem="file"\n\t\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FILES_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.document"\n\t\t\t\t/>\n\t\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t\t</div>\n\t\t</div>\n\t`};const re={name:"LinkItem",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle},props:{link:{type:Object,required:true}},emits:["contextMenuClick"],data(){return{showContextButton:false}},computed:{AvatarSize:()=>D.AvatarSize,linkItem(){return this.link},source(){return this.linkItem.source},shortDescription(){let t="";try{t=new URL(this.source).hostname}catch(e){t=this.source;console.error(e)}return t},description(){const{name:t,description:e}=this.linkItem.richData;const i=e||t||this.source;return y.Utils.text.convertHtmlEntities(i)},authorDialogId(){return this.linkItem.authorId.toString()},hasPreview(){var t;return Boolean((t=this.linkItem.richData)==null?void 0:t.previewUrl)},previewStyles(){var t;return{backgroundImage:`url('${(t=this.linkItem.richData)==null?void 0:t.previewUrl}')`,backgroundSize:"cover",backgroundRepeat:"no-repeat"}},iconTypeClass(){var t;switch((t=this.linkItem.richData)==null?void 0:t.type){case"TASKS":return"--task";case"LANDING":return"--landing";case"POST":return"--post";case"CALENDAR":return"--calendar";default:return"--common"}}},methods:{onContextMenuClick(t){this.$emit("contextMenuClick",{id:this.linkItem.id,messageId:this.linkItem.messageId,source:this.source,target:t.currentTarget})}},template:`\n\t\t<div \n\t\t\tclass="bx-im-link-item__container bx-im-link-item__scope"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<template v-if="hasPreview">\n\t\t\t\t<div class="bx-im-link-item__icon-container" :style="previewStyles"></div>\n\t\t\t</template>\n\t\t\t<template v-else>\n\t\t\t\t<div class="bx-im-link-item__icon-container" :class="iconTypeClass">\n\t\t\t\t\t<div class="bx-im-link-item__icon" :class="iconTypeClass" ></div>\n\t\t\t\t</div>\n\t\t\t</template>\n\t\t\t<div class="bx-im-link-item__content">\n\t\t\t\t<div class="bx-im-link-item__short-description-text">{{ shortDescription }}</div>\n\t\t\t\t<a :href="source" :title="description" target="_blank" class="bx-im-link-item__description-text">\n\t\t\t\t\t{{ description }}\n\t\t\t\t</a>\n\t\t\t\t<div class="bx-im-link-item__author-container">\n\t\t\t\t\t<Avatar \n\t\t\t\t\t\t:size="AvatarSize.XS"\n\t\t\t\t\t\t:dialogId="authorDialogId" \n\t\t\t\t\t\tclass="bx-im-link-item__author-avatar" \n\t\t\t\t\t/>\n\t\t\t\t\t<ChatTitle :dialogId="authorDialogId" :showItsYou="false" class="bx-im-link-item__author-text" />\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div v-if="showContextButton" class="bx-im-link-item__context-menu">\n\t\t\t\t<button class="bx-im-messenger__context-menu-icon" @click="onContextMenuClick"></button>\n\t\t\t</div>\n\t\t</div>\n\t`};class oe{constructor(){this.store=A.Core.getStore();this.restClient=A.Core.getRestClient()}delete(t){this.store.dispatch("sidebar/links/delete",{chatId:t.chatId,id:t.id});const e={LINK_ID:t.id};this.restClient.callMethod(E.RestMethod.imChatUrlDelete,e).catch((t=>{console.error("Im.Sidebar: error deleting link",t)}))}}class le extends xt{constructor(){super();this.linkManager=new oe}getMenuItems(){return[this.getOpenContextMessageItem(),this.getCopyLinkItem(S.Loc.getMessage("IM_SIDEBAR_MENU_COPY_LINK")),this.getDeleteLinkItem()]}getDeleteLinkItem(){return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_DELETE_FROM_LINKS"),onclick:function(){this.linkManager.delete(this.context);this.menuInstance.close()}.bind(this)}}}const de={name:"LinkPanel",components:{DetailHeader:Gt,LinkItem:re,DateGroup:Ht,DetailEmptyState:ft,Loader:D.Loader},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,links(){return this.$store.getters["sidebar/links/get"](this.chatId)},formattedCollection(){return this.collectionFormatter.format(this.links)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.collectionFormatter=new zt;this.contextMenu=new le;this.service=new Z({dialogId:this.dialogId})},beforeUnmount(){this.contextMenu.destroy();this.collectionFormatter.destroy()},methods:{onContextMenuClick(t){const e={id:t.id,messageId:t.messageId,dialogId:this.dialogId,chatId:this.chatId,source:t.source};this.contextMenu.openMenu(e,t.target)},onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.link})},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/links/hasNextPage"](this.chatId);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage();this.isLoading=false}},template:`\n\t\t<div class="bx-im-sidebar-link-detail__scope">\n\t\t\t<DetailHeader\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_LINK_DETAIL_TITLE')"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<div class="bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-link-detail__date-group_container">\n\t\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t\t<template v-for="link in dateGroup.items">\n\t\t\t\t\t\t<LinkItem :link="link" @contextMenuClick="onContextMenuClick" />\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_LINKS_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.link"\n\t\t\t\t/>\n\t\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t\t</div>\n\t\t</div>\n\t`};const ce={name:"MarketPanel",components:{Spinner:D.Spinner,DetailHeader:Gt},props:{dialogId:{type:String,required:true},entityId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:true}},computed:{SpinnerSize:()=>D.SpinnerSize,SidebarDetailBlock:()=>E.SidebarDetailBlock,placement(){const t=Number.parseInt(this.entityId,10);return this.$store.getters["market/getById"](t)},title(){if(this.placement&&S.Type.isStringFilled(this.placement.title)){return this.placement.title}return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_MARKET_DETAIL_TITLE")}},created(){this.marketManager=p.MarketManager.getInstance()},async mounted(){const t={dialogId:this.dialogId};const e=await this.marketManager.loadPlacement(this.entityId,t);this.isLoading=false;S.Runtime.html(this.$refs["im-messenger-sidebar-placement"],e)},methods:{onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.market})}},template:`\n\t\t<div class="bx-im-sidebar-favorite-detail__scope">\n\t\t\t<DetailHeader\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:title="title"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<div class="bx-im-sidebar-market-detail__container">\n\t\t\t\t<div v-if="isLoading" class="bx-im-sidebar-market-detail__loader-container">\n\t\t\t\t\t<Spinner :size="SpinnerSize.S" />\n\t\t\t\t</div>\n\t\t\t\t<div \n\t\t\t\t\tclass="bx-im-sidebar-market-detail__placement-container" \n\t\t\t\t\tref="im-messenger-sidebar-placement"\n\t\t\t\t></div>\n\t\t\t</div>\n\t\t</div>\n\t`};const he={name:"MeetingPanel",components:{MeetingItem:Pt,DateGroup:Ht,DetailEmptyState:ft,DetailHeader:Gt,Loader:D.Loader},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,meetings(){return this.$store.getters["sidebar/meetings/get"](this.chatId)},formattedCollection(){return this.collectionFormatter.format(this.meetings)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.collectionFormatter=new zt;this.contextMenu=new Et},beforeUnmount(){this.collectionFormatter.destroy();this.contextMenu.destroy()},methods:{onContextMenuClick(t,e){const i={...t,dialogId:this.dialogId};this.contextMenu.openMenu(i,e)},onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.meeting})},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/meetings/hasNextPage"](this.chatId);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage();this.isLoading=false},onAddClick(){new b.EntityCreator(this.chatId).createMeetingForChat()}},template:`\n\t\t<div class="bx-im-sidebar-meeting-detail__scope">\n\t\t\t<DetailHeader\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_MEETING_DETAIL_TITLE')"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t:withAddButton="true"\n\t\t\t\t@addClick="onAddClick"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<div class="bx-im-sidebar-meeting-detail__container bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-sidebar-meeting-detail__date-group_container">\n\t\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t\t<MeetingItem\n\t\t\t\t\t\tv-for="meeting in dateGroup.items"\n\t\t\t\t\t\t:meeting="meeting"\n\t\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_MEETINGS_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.meeting"\n\t\t\t\t/>\n\t\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t\t</div>\n\t\t</div>\n\t`};const ue={name:"DetailUser",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle},props:{dialogId:{type:String,required:true},isOwner:{type:Boolean,default:false}},data(){return{showContextButton:false}},computed:{AvatarSize:()=>D.AvatarSize,position(){return this.$store.getters["users/getPosition"](this.dialogId)},user(){return this.$store.getters["users/get"](this.dialogId,true)},userLink(){return y.Utils.user.getProfileLink(this.dialogId)},needContextMenu(){const t=this.$store.getters["users/bots/getByUserId"](this.dialogId);if(!t){return true}return t.code!=="copilot"},isCopilot(){const t=Number.parseInt(this.dialogId,10);const e=this.$store.getters["users/bots/getCopilotUserId"];return e===t},hasLink(){return!this.isCopilot}},methods:{onClickContextMenu(t){this.$emit("contextMenuClick",{userDialogId:this.dialogId,target:t.currentTarget})}},template:`\n\t\t<div\n\t\t\tclass="bx-im-sidebar-main-detail__user"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<div class="bx-im-sidebar-main-detail__avatar-container">\n\t\t\t\t<Avatar :size="AvatarSize.L" :dialogId="dialogId" />\n\t\t\t\t<span v-if="isOwner" class="bx-im-sidebar-main-detail__avatar-owner-icon"></span>\n\t\t\t</div>\n\t\t\t<div class="bx-im-sidebar-main-detail__user-info-container">\n\t\t\t\t<div class="bx-im-sidebar-main-detail__user-title-container">\n\t\t\t\t\t<a v-if="hasLink" :href="userLink" target="_blank" class="bx-im-sidebar-main-detail__user-title-link">\n\t\t\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t\t</a>\n\t\t\t\t\t<div v-else class="bx-im-sidebar-main-detail__user-title-link">\n\t\t\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t\t</div>\n\t\t\t\t\t<div\n\t\t\t\t\t\tv-if="needContextMenu && showContextButton"\n\t\t\t\t\t\tclass="bx-im-sidebar-main-detail__context-menu-icon bx-im-messenger__context-menu-icon"\n\t\t\t\t\t\t@click="onClickContextMenu"\n\t\t\t\t\t></div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-sidebar-main-detail__position-text" :title="position">\n\t\t\t\t\t{{ position }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\t\n\t`};class me extends xt{constructor(){super();this.chatService=new x.ChatService;this.callManager=I.CallManager.getInstance();this.permissionManager=f.PermissionManager.getInstance()}getMenuItems(){return[this.getInsertNameItem(),this.getSendMessageItem(),this.getCallItem(),this.getOpenProfileItem(),this.getOpenUserCalendarItem(),this.getKickItem(),this.getLeaveItem()]}getInsertNameItem(){const t=this.store.getters["users/get"](this.context.dialogId,true);return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_INSERT_NAME"),onclick:()=>{L.EventEmitter.emit(E.EventType.textarea.insertMention,{mentionText:t.name,mentionReplacement:y.Utils.text.getMentionBbCode(this.context.dialogId,t.name)});this.menuInstance.close()}}}getSendMessageItem(){return{text:S.Loc.getMessage("IM_LIB_MENU_WRITE"),onclick:()=>{T.Messenger.openChat(this.context.dialogId);this.menuInstance.close()}}}getCallItem(){const t=this.callManager.chatCanBeCalled(this.context.dialogId);const e=this.permissionManager.canPerformAction(E.ChatActionType.call,this.context.dialogId);if(!t||!e){return null}return{text:S.Loc.getMessage("IM_LIB_MENU_CALL_2"),onclick:()=>{this.callManager.startCall(this.context.dialogId);this.menuInstance.close()}}}getOpenProfileItem(){if(!this.isUser()||this.isBot()){return null}const t=y.Utils.user.getProfileLink(this.context.dialogId);return{text:S.Loc.getMessage("IM_LIB_MENU_OPEN_PROFILE"),href:t,onclick:()=>{this.menuInstance.close()}}}getOpenUserCalendarItem(){if(!this.isUser()||this.isBot()){return null}const t=y.Utils.user.getCalendarLink(this.context.dialogId);return{text:S.Loc.getMessage("IM_LIB_MENU_OPEN_CALENDAR"),onclick:()=>{BX.SidePanel.Instance.open(t);this.menuInstance.close()}}}getKickItem(){const t=Number.parseInt(this.context.dialogId,10);const e=t===this.getCurrentUserId();const i=this.permissionManager.canPerformAction(E.ChatActionType.kick,this.context.contextDialogId);if(e||!i){return null}return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_KICK_FROM_CHAT"),onclick:async()=>{this.menuInstance.close();const t=await _.showKickUserConfirm();if(t===true){this.chatService.kickUserFromChat(this.context.contextDialogId,this.context.dialogId)}}}}getLeaveItem(){const t=Number.parseInt(this.context.dialogId,10);const e=t===this.getCurrentUserId();const i=this.permissionManager.canPerformAction(E.ChatActionType.leave,this.context.contextDialogId);if(!e||!i){return null}return{text:S.Loc.getMessage("IM_LIB_MENU_LEAVE"),onclick:async()=>{this.menuInstance.close();const t=await _.showLeaveFromChatConfirm();if(t===true){this.chatService.leaveChat(this.context.contextDialogId)}}}}isUser(){return this.store.getters["chats/isUser"](this.context.dialogId)}isBot(){if(!this.isUser()){return false}const t=this.store.getters["users/get"](this.context.dialogId);return t.bot===true}}const ge={name:"MembersPanel",components:{DetailUser:ue,ChatButton:D.Button,DetailHeader:Gt,Loader:D.Loader,AddToChat:v.AddToChat},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:false,showAddToChatPopup:false,showAddToChatTarget:null}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,ButtonSize:()=>D.ButtonSize,ButtonColor:()=>D.ButtonColor,dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},dialogIds(){const t=this.$store.getters["sidebar/members/get"](this.chatId);return t.map((t=>t.toString()))},chatLink(){const t=this.dialog.type===E.ChatType.copilot;const e=t?E.GetParameter.openCopilotChat:E.GetParameter.openChat;return`${A.Core.getHost()}/online/?${e}=${this.dialogId}`},hasNextPage(){return this.$store.getters["sidebar/members/hasNextPage"](this.chatId)},panelInited(){return this.$store.getters["sidebar/members/getInited"](this.chatId)},chatId(){return this.dialog.chatId},title(){let t=this.dialog.userCounter;if(t>=1e3){t=`${Math.floor(t/1e3)}k`}return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_MEMBERS_DETAIL_TITLE").replace("#NUMBER#",t)},needAddButton(){if(this.isCopilotLayout&&!this.isAddToCopilotChatAvailable){return false}return f.PermissionManager.getInstance().canPerformAction(E.ChatActionType.extend,this.dialogId)},isCopilotLayout(){const{name:t}=this.$store.getters["application/getLayout"];return t===E.Layout.copilot.name},isAddToCopilotChatAvailable(){const t=S.Extension.getSettings("im.v2.component.content.copilot");return t.isAddToChatAvailable==="Y"}},watch:{dialogId(t){this.service=new ot({dialogId:t});void this.loadFirstPage()}},created(){this.contextMenu=new me;this.service=new ot({dialogId:this.dialogId});void this.loadFirstPage()},beforeUnmount(){this.contextMenu.destroy()},methods:{async loadFirstPage(){if(this.panelInited||this.isLoading){return}this.isLoading=true;this.chats=await this.service.loadFirstPage();this.isLoading=false},isOwner(t){const e=Number.parseInt(t,10);return this.dialog.ownerId===e},onContextMenuClick(t){const e={dialogId:t.userDialogId,contextDialogId:this.dialogId};this.contextMenu.openMenu(e,t.target)},onCopyInviteClick(){if(BX.clipboard.copy(this.chatLink)){BX.UI.Notification.Center.notify({content:this.$Bitrix.Loc.getMessage("IM_SIDEBAR_COPIED_SUCCESS")})}},onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.members})},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;return i&&this.hasNextPage},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage();this.isLoading=false},onAddClick(t){this.showAddToChatPopup=true;this.showAddToChatTarget=t.target},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-main-detail__scope">\n\t\t\t<DetailHeader \n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:title="title"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t:withAddButton="needAddButton"\n\t\t\t\t@addClick="onAddClick"\n\t\t\t\t@back="onBackClick" \n\t\t\t/>\n\t\t\t<div class="bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t\t<div class="bx-im-sidebar-main-detail__invitation-button-container">\n\t\t\t\t\t<ChatButton\n\t\t\t\t\t\t:text="loc('IM_SIDEBAR_COPY_INVITE_LINK')"\n\t\t\t\t\t\t:size="ButtonSize.M"\n\t\t\t\t\t\t:color="ButtonColor.PrimaryBorder"\n\t\t\t\t\t\t:isRounded="true"\n\t\t\t\t\t\t:isUppercase="false"\n\t\t\t\t\t\ticon="link"\n\t\t\t\t\t\t@click="onCopyInviteClick"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<DetailUser\n\t\t\t\t\tv-for="dialogId in dialogIds"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:isOwner="isOwner(dialogId)"\n\t\t\t\t\t@contextMenuClick="onContextMenuClick"\n\t\t\t\t/>\n\t\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t\t</div>\n\t\t\t<AddToChat\n\t\t\t\t:bindElement="showAddToChatTarget || {}"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:showPopup="showAddToChatPopup"\n\t\t\t\t:popupConfig="{offsetTop: 0, offsetLeft: 0}"\n\t\t\t\t@close="showAddToChatPopup = false"\n\t\t\t/>\n\t\t</div>\n\t`};class pe extends xt{constructor(){super();this.id="im-sidebar-context-menu"}getMenuItems(){return[this.getOpenContextMessageItem(),this.getDeleteFromFavoriteItem()]}getDeleteFromFavoriteItem(){return{text:S.Loc.getMessage("IM_SIDEBAR_MENU_REMOVE_FROM_SAVED_V2"),onclick:function(){const t=new x.MessageService({chatId:this.context.chatId});t.removeMessageFromFavorite(this.context.messageId);this.menuInstance.close()}.bind(this)}}}const be={name:"FavoriteItem",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle},props:{favorite:{type:Object,required:true},chatId:{type:Number,required:true},dialogId:{type:String,required:true}},emits:["contextMenuClick"],data(){return{showContextButton:false}},computed:{AvatarSize:()=>D.AvatarSize,favoriteItem(){return this.favorite},favoriteMessage(){return this.$store.getters["messages/getById"](this.favoriteItem.messageId)},authorDialogId(){return this.favoriteMessage.authorId.toString()},messageText(){return M.Parser.purifyMessage(this.favoriteMessage)}},methods:{onContextMenuClick(t){this.$emit("contextMenuClick",{id:this.favoriteItem.id,messageId:this.favorite.messageId,target:t.currentTarget})},onItemClick(){L.EventEmitter.emit(E.EventType.dialog.goToMessageContext,{messageId:this.favorite.messageId,dialogId:this.dialogId})},onMessageBodyClick(t){if(t.target.tagName==="A"){t.stopPropagation()}}},template:`\n\t\t<div \n\t\t\tclass="bx-im-favorite-item__container bx-im-favorite-item__scope" \n\t\t\t@click.stop="onItemClick"\n\t\t\t@mouseover="showContextButton = true"\n\t\t\t@mouseleave="showContextButton = false"\n\t\t>\n\t\t\t<div class="bx-im-favorite-item__header-container">\n\t\t\t\t<div class="bx-im-favorite-item__author-container">\n\t\t\t\t\t<Avatar\n\t\t\t\t\t\t:size="AvatarSize.XS"\n\t\t\t\t\t\t:dialogId="authorDialogId"\n\t\t\t\t\t\tclass="bx-im-favorite-item__author-avatar"\n\t\t\t\t\t/>\n\t\t\t\t\t<ChatTitle :dialogId="authorDialogId" :showItsYou="false" class="bx-im-favorite-item__author-text" />\n\t\t\t\t</div>\n\t\t\t\t<button \n\t\t\t\t\tv-if="showContextButton"\n\t\t\t\t\tclass="bx-im-messenger__context-menu-icon"\n\t\t\t\t\t@click.stop="onContextMenuClick"\n\t\t\t\t></button>\n\t\t\t</div>\n\t\t\t<div class="bx-im-favorite-item__message-text" v-html="messageText" @click="onMessageBodyClick"></div>\n\t\t</div>\n\t`};const ve={name:"FavoritePanel",components:{FavoriteItem:be,DateGroup:Ht,DetailEmptyState:ft,DetailHeader:Gt,Loader:D.Loader},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,favorites(){return this.$store.getters["sidebar/favorites/get"](this.chatId)},formattedCollection(){return this.collectionFormatter.format(this.favorites)},isEmptyState(){return this.formattedCollection.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},created(){this.collectionFormatter=new zt;this.contextMenu=new pe;this.service=new N({dialogId:this.dialogId})},beforeUnmount(){this.contextMenu.destroy();this.collectionFormatter.destroy()},methods:{onContextMenuClick(t){const e={id:t.id,messageId:t.messageId,dialogId:this.dialogId,chatId:this.chatId};this.contextMenu.openMenu(e,t.target)},onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.favorite})},needToLoadNextPage(t){const e=t.target;const i=e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight;const s=this.$store.getters["sidebar/favorites/hasNextPage"](this.chatId);return i&&s},async onScroll(t){this.contextMenu.destroy();if(this.isLoading||!this.needToLoadNextPage(t)){return}this.isLoading=true;await this.service.loadNextPage();this.isLoading=false}},template:`\n\t\t<div class="bx-im-sidebar-favorite-detail__scope">\n\t\t\t<DetailHeader\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FAVORITE_DETAIL_TITLE')"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<div class="bx-im-sidebar-favorite-detail__container bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t\t<div \n\t\t\t\t\tv-for="dateGroup in formattedCollection" \n\t\t\t\t\tclass="bx-im-sidebar-favorite-detail__date-group_container"\n\t\t\t\t>\n\t\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t\t<FavoriteItem \n\t\t\t\t\t\tv-for="favorite in dateGroup.items" \n\t\t\t\t\t\t:favorite="favorite"\n\t\t\t\t\t\t:chatId="chatId"\n\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t@contextMenuClick="onContextMenuClick" \n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_FAVORITES_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.favorite"\n\t\t\t\t/>\n\t\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-detail__loader-container" />\n\t\t\t</div>\n\t\t</div>\n\t`};const Ie=50;var fe=babelHelpers.classPrivateFieldLooseKey("lastMessageId");var _e=babelHelpers.classPrivateFieldLooseKey("query");var xe=babelHelpers.classPrivateFieldLooseKey("request");var Ce=babelHelpers.classPrivateFieldLooseKey("processSearchResponse");var Se=babelHelpers.classPrivateFieldLooseKey("updateModels");class Me{constructor({dialogId:t}){Object.defineProperty(this,Se,{value:Te});Object.defineProperty(this,Ce,{value:Le});Object.defineProperty(this,xe,{value:ke});this.hasMoreItemsToLoad=true;Object.defineProperty(this,fe,{writable:true,value:0});Object.defineProperty(this,_e,{writable:true,value:""});this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.chatId=w(t);this.userManager=new P.UserManager}searchOnServer(t){if(babelHelpers.classPrivateFieldLooseBase(this,_e)[_e]!==t){babelHelpers.classPrivateFieldLooseBase(this,_e)[_e]=t;this.hasMoreItemsToLoad=true;babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]=0}return babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]()}loadNextPage(){return babelHelpers.classPrivateFieldLooseBase(this,xe)[xe]()}loadFirstPage(){return Promise.resolve()}resetSearchState(){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]=0;babelHelpers.classPrivateFieldLooseBase(this,_e)[_e]="";this.hasMoreItemsToLoad=true}}function ke(){const t={SEARCH_MESSAGE:babelHelpers.classPrivateFieldLooseBase(this,_e)[_e],CHAT_ID:this.chatId};if(babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]>0){t.LAST_ID=babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]}return new Promise(((e,i)=>{this.restClient.callMethod(E.RestMethod.imDialogMessagesSearch,t).then((t=>{const i=t.data();e(babelHelpers.classPrivateFieldLooseBase(this,Ce)[Ce](i))})).catch((t=>i(t)))}))}function Le(t){babelHelpers.classPrivateFieldLooseBase(this,fe)[fe]=F(t.messages);if(t.messages.length<Ie){this.hasMoreItemsToLoad=false}return babelHelpers.classPrivateFieldLooseBase(this,Se)[Se](t).then((()=>t.messages.map((t=>t.id))))}function Te(t){const{files:e,users:i,usersShort:s,reactions:a,additionalMessages:n,messages:r}=t;const o=Promise.all([this.userManager.setUsersToModel(i),this.userManager.addUsersToModel(s)]);const l=this.store.dispatch("files/set",e);const d=this.store.dispatch("messages/reactions/set",a);const c=this.store.dispatch("messages/store",n);const h=this.store.dispatch("messages/store",r);return Promise.all([l,o,d,c,h])}const ye={name:"EmptyState",computed:{title(){return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_MESSAGE_SEARCH_NOT_FOUND")},subTitle(){return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_MESSAGE_SEARCH_NOT_FOUND_DESCRIPTION")}},template:`\n\t\t<div class="bx-im-message-search-empty-state__container bx-im-message-search-empty-state__scope">\n\t\t\t<div class="bx-im-message-search-empty-state__icon"></div>\n\t\t\t<div class="bx-im-message-search-empty-state__title">\n\t\t\t\t{{ title }}\n\t\t\t</div>\n\t\t\t<div class="bx-im-message-search-empty-state__subtitle">\n\t\t\t\t{{ subTitle }}\n\t\t\t</div>\n\t\t</div>\n\t`};const Be={name:"SearchItem",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle},props:{messageId:{type:[String,Number],required:true},dialogId:{type:String,required:true},query:{type:String,default:""}},computed:{AvatarSize:()=>D.AvatarSize,message(){return this.$store.getters["messages/getById"](this.messageId)},authorDialogId(){return this.message.authorId.toString()},isSystem(){return this.message.authorId===0},messageText(){const t=M.Parser.purifyMessage(this.message);return k.highlightText(S.Text.encode(t),this.query)}},methods:{onItemClick(){L.EventEmitter.emit(E.EventType.dialog.goToMessageContext,{messageId:this.messageId,dialogId:this.dialogId})},onMessageBodyClick(t){if(t.target.tagName==="A"){t.stopPropagation()}}},template:`\n\t\t<div \n\t\t\tclass="bx-im-message-search-item__container bx-im-message-search-item__scope" \n\t\t\t@click.stop="onItemClick"\n\t\t>\n\t\t\t<div class="bx-im-message-search-item__header-container">\n\t\t\t\t<div class="bx-im-message-search-item__author-container">\n\t\t\t\t\t<template v-if="!isSystem">\n\t\t\t\t\t\t<Avatar\n\t\t\t\t\t\t\t:size="AvatarSize.XS"\n\t\t\t\t\t\t\t:dialogId="authorDialogId"\n\t\t\t\t\t\t\tclass="bx-im-message-search-item__author-avatar"\n\t\t\t\t\t\t/>\n\t\t\t\t\t\t<ChatTitle \n\t\t\t\t\t\t\t:dialogId="authorDialogId" \n\t\t\t\t\t\t\t:showItsYou="false" \n\t\t\t\t\t\t\tclass="bx-im-message-search-item__author-text" \n\t\t\t\t\t\t/>\n\t\t\t\t\t</template>\n\t\t\t\t\t<template v-else>\n\t\t\t\t\t\t<span class="bx-im-message-search-item__system-author">\n\t\t\t\t\t\t\t{{ $Bitrix.Loc.getMessage('IM_SIDEBAR_SYSTEM_MESSAGE') }}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t</template>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t\t<div class="bx-im-message-search-item__message-text" v-html="messageText" @click="onMessageBodyClick"></div>\n\t\t</div>\n\t`};const De={name:"SearchHeader",components:{SearchInput:D.SearchInput},props:{secondLevel:{type:Boolean,default:false}},emits:["back","changeQuery"],template:`\n\t\t<div class="bx-im-sidebar-search-header__container bx-im-sidebar-search-header__scope">\n\t\t\t<div class="bx-im-sidebar-search-header__title-container">\n\t\t\t\t<button\n\t\t\t\t\t:class="{'bx-im-messenger__cross-icon': !secondLevel, 'bx-im-sidebar__back-icon': secondLevel}"\n\t\t\t\t\t@click="$emit('back')"\n\t\t\t\t></button>\n\t\t\t\t<SearchInput\n\t\t\t\t\t:placeholder="$Bitrix.Loc.getMessage('IM_SIDEBAR_SEARCH_MESSAGE_PLACEHOLDER')"\n\t\t\t\t\t:withIcon="false"\n\t\t\t\t\t:delayForFocusOnStart="300"\n\t\t\t\t\t@queryChange="$emit('changeQuery', $event)"\n\t\t\t\t\tclass="bx-im-sidebar-search-header__input"\n\t\t\t\t/>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ee={name:"MessageSearchPanel",components:{DateGroup:Ht,EmptyState:ye,SearchItem:Be,Loader:D.Loader,StartState:ft,SearchHeader:De},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{searchQuery:"",isLoading:false,searchResult:[],currentServerQueries:0}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,formattedCollection(){const t=this.searchResult.map((t=>this.$store.getters["messages/getById"](t))).filter((t=>Boolean(t)));return this.collectionFormatter.format(t)},isEmptyState(){return this.preparedQuery.length>0&&this.formattedCollection.length===0},preparedQuery(){return this.searchQuery.trim().toLowerCase()}},watch:{preparedQuery(t,e){if(t===e){return}this.service.resetSearchState();this.searchResult=[];this.startSearch(t)}},created(){this.service=new Me({dialogId:this.dialogId});this.collectionFormatter=new zt;this.searchOnServerDelayed=S.Runtime.debounce(this.searchOnServer,500,this)},beforeUnmount(){this.collectionFormatter.destroy()},methods:{searchOnServer(t){this.currentServerQueries++;this.service.searchOnServer(t).then((e=>{if(t!==this.preparedQuery){this.isLoading=false;return}this.searchResult=this.mergeResult(e)})).catch((t=>{console.error(t)})).finally((()=>{this.currentServerQueries--;this.stopLoader()}))},startSearch(t){if(t.length<3){return}if(t.length>=3){this.isLoading=true;this.searchOnServerDelayed(t)}if(t.length===0){this.cleanSearchResult()}},stopLoader(){if(this.currentServerQueries>0){return}this.isLoading=false},cleanSearchResult(){this.searchResult=[]},needToLoadNextPage(t){const e=t.target;return e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight},onScroll(t){if(this.isLoading||this.preparedQuery.length===0){return}if(!this.needToLoadNextPage(t)||!this.service.hasMoreItemsToLoad){return}this.isLoading=true;this.service.loadNextPage().then((t=>{this.searchResult=this.mergeResult(t);this.isLoading=false})).catch((t=>{C.Logger.warn("Message Search: loadNextPage error",t)}))},mergeResult(t){return[...this.searchResult,...t].sort(((t,e)=>e-t))},onChangeQuery(t){this.searchQuery=t},onClickBack(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.messageSearch})}},template:`\n\t\t<div class="bx-im-message-search-detail__scope">\n\t\t\t<SearchHeader :secondLevel="secondLevel" @changeQuery="onChangeQuery" @back="onClickBack" />\n\t\t\t<div class="bx-im-message-search-detail__container bx-im-sidebar-detail__container" @scroll="onScroll">\n\t\t\t\t<StartState \n\t\t\t\t\tv-if="!isLoading && preparedQuery.length === 0"\n\t\t\t\t\t:title="$Bitrix.Loc.getMessage('IM_SIDEBAR_SEARCH_MESSAGE_START_TITLE')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.messageSearch"\n\t\t\t\t/>\n\t\t\t\t<EmptyState v-if="!isLoading && isEmptyState" />\n\t\t\t\t<Loader v-if="isLoading && isEmptyState" class="bx-im-message-search-detail__loader" />\n\t\t\t\t<div v-for="dateGroup in formattedCollection" class="bx-im-message-search-detail__date-group_container">\n\t\t\t\t\t<DateGroup :dateText="dateGroup.dateGroupTitle" />\n\t\t\t\t\t<SearchItem\n\t\t\t\t\t\tv-for="item in dateGroup.items"\n\t\t\t\t\t\t:messageId="item.id"\n\t\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t\t:query="preparedQuery"\n\t\t\t\t\t/>\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Pe={name:"ChatItem",components:{Avatar:D.Avatar,ChatTitle:D.ChatTitle},props:{dialogId:{type:String,required:true},dateMessage:{type:String,default:""}},emits:["clickItem"],computed:{AvatarSize:()=>D.AvatarSize,chatItemText(){return this.$Bitrix.Loc.getMessage("IM_SIDEBAR_CHAT_TYPE_GROUP_V2")},formattedDate(){if(!this.dateMessage){return""}const t=y.Utils.date.cast(this.dateMessage);return this.formatDate(t)}},methods:{onClick(t){this.$emit("clickItem",{dialogId:this.dialogId,nativeEvent:t})},formatDate(t){return B.DateFormatter.formatByTemplate(t,B.DateTemplate.recent)}},template:`\n\t\t<div \n\t\t\t@click="onClick"\n\t\t\tclass="bx-im-chat-with-user-item__container bx-im-chat-with-user-item__scope"\n\t\t>\n\t\t\t<div class="bx-im-chat-with-user-item__avatar-container">\n\t\t\t\t<Avatar :dialogId="dialogId" :size="AvatarSize.XL" />\n\t\t\t</div>\n\t\t\t<div class="bx-im-chat-with-user-item__content-container">\n\t\t\t\t<div class="bx-im-chat-with-user-item__content_header">\n\t\t\t\t\t<ChatTitle :dialogId="dialogId" />\n\t\t\t\t\t<div v-if="formattedDate.length > 0" class="bx-im-chat-with-user-item__date">\n\t\t\t\t\t\t<span>{{ formattedDate }}</span>\n\t\t\t\t\t</div>\n\t\t\t\t</div>\n\t\t\t\t<div class="bx-im-chat-with-user-item__item-text" :title="chatItemText">\n\t\t\t\t\t{{ chatItemText }}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t`};const Ae=50;var we=babelHelpers.classPrivateFieldLooseKey("chatsCount");var Fe=babelHelpers.classPrivateFieldLooseKey("getRequestParams");var Re=babelHelpers.classPrivateFieldLooseKey("requestPage");var Ne=babelHelpers.classPrivateFieldLooseKey("handleResponse");var Ue=babelHelpers.classPrivateFieldLooseKey("updateModels");var $e=babelHelpers.classPrivateFieldLooseKey("setDialoguesPromise");class Oe{constructor({dialogId:t}){Object.defineProperty(this,$e,{value:Xe});Object.defineProperty(this,Ue,{value:qe});Object.defineProperty(this,Ne,{value:ze});Object.defineProperty(this,Re,{value:Ge});Object.defineProperty(this,Fe,{value:He});this.hasMoreItemsToLoad=true;Object.defineProperty(this,we,{writable:true,value:0});this.store=A.Core.getStore();this.restClient=A.Core.getRestClient();this.dialogId=t;this.userManager=new P.UserManager}loadFirstPage(){return babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]()}loadNextPage(){return babelHelpers.classPrivateFieldLooseBase(this,Re)[Re]()}}function He(){const t=Number.parseInt(this.dialogId,10);const e={filter:{userId:t},limit:Ae};if(babelHelpers.classPrivateFieldLooseBase(this,we)[we]>0){e.offset=babelHelpers.classPrivateFieldLooseBase(this,we)[we]}return e}async function Ge(){const t=babelHelpers.classPrivateFieldLooseBase(this,Fe)[Fe]();const e=await this.restClient.callMethod(E.RestMethod.imV2ChatListShared,t);return babelHelpers.classPrivateFieldLooseBase(this,Ne)[Ne](e.data())}async function ze(t){const{chats:e}=t;babelHelpers.classPrivateFieldLooseBase(this,we)[we]+=e.length;if(e.length<Ae){this.hasMoreItemsToLoad=false}await babelHelpers.classPrivateFieldLooseBase(this,Ue)[Ue](e);return e.map((t=>({dialogId:t.dialogId,dateMessage:t.dateMessage})))}function qe(t){return babelHelpers.classPrivateFieldLooseBase(this,$e)[$e](t)}function Xe(t){return this.store.dispatch("chats/set",t)}const Ve={name:"ChatsWithUserPanel",components:{DetailHeader:Gt,ChatItem:Pe,DetailEmptyState:ft,Loader:D.Loader},props:{dialogId:{type:String,required:true},secondLevel:{type:Boolean,default:false}},data(){return{isLoading:false,chats:[]}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,isEmptyState(){return!this.isLoading&&this.chats.length===0},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},chatId(){return this.dialog.chatId}},watch:{dialogId(){this.chats=[];this.service=new Oe({dialogId:this.dialogId});void this.loadFirstPage()}},created(){this.service=new Oe({dialogId:this.dialogId});void this.loadFirstPage()},methods:{onClick(t){const{dialogId:e}=t;void T.Messenger.openChat(e)},async loadFirstPage(){this.isLoading=true;this.chats=await this.service.loadFirstPage();this.isLoading=false},needToLoadNextPage(t){const e=t.target;return e.scrollTop+e.clientHeight>=e.scrollHeight-e.clientHeight},async onScroll(t){if(this.isLoading){return}if(!this.needToLoadNextPage(t)||!this.service.hasMoreItemsToLoad){return}this.isLoading=true;const e=await this.service.loadNextPage();this.chats=[...this.chats,...e];this.isLoading=false},onBackClick(){L.EventEmitter.emit(E.EventType.sidebar.close,{panel:E.SidebarDetailBlock.chatsWithUser})},loc(t){return this.$Bitrix.Loc.getMessage(t)}},template:`\n\t\t<div class="bx-im-sidebar-chats-with-user-detail__scope">\n\t\t\t<DetailHeader\n\t\t\t\t:title="loc('IM_SIDEBAR_CHATSWITHUSER_DETAIL_TITLE')"\n\t\t\t\t:dialogId="dialogId"\n\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t@back="onBackClick"\n\t\t\t/>\n\t\t\t<div \n\t\t\t\tclass="bx-im-sidebar-chats-with-user-detail__container" \n\t\t\t\t@scroll="onScroll"\n\t\t\t>\n\t\t\t\t<ChatItem\n\t\t\t\t\tv-for="chat in chats"\n\t\t\t\t\t:dialogId="chat.dialogId"\n\t\t\t\t\t:dateMessage="chat.dateMessage"\n\t\t\t\t\t@clickItem="onClick"\n\t\t\t\t/>\n\t\t\t\t<DetailEmptyState\n\t\t\t\t\tv-if="!isLoading && isEmptyState"\n\t\t\t\t\t:title="loc('IM_SIDEBAR_CHATS_WITH_USER_EMPTY')"\n\t\t\t\t\t:iconType="SidebarDetailBlock.messageSearch"\n\t\t\t\t/>\n\t\t\t\t<Loader v-if="isLoading" class="bx-im-sidebar-chats-with-user-detail__loader-container" />\n\t\t\t</div>\n\t\t</div>\n\t`};const Qe={name:"SidebarPanel",components:{MainPanel:Ot,ChatsWithUserPanel:Ve,MembersPanel:ge,FavoritePanel:ve,LinkPanel:de,FilePanel:ae,TaskPanel:qt,MeetingPanel:he,MarketPanel:ce,MessageSearchPanel:Ee,FileUnsortedPanel:ne},props:{dialogId:{type:String,required:true},panel:{type:String,required:true},secondLevel:{type:Boolean,default:false},entityId:{type:String,default:""}},computed:{panelComponentName(){return`${S.Text.capitalize(this.panel)}Panel`}},template:`\n\t\t<div class="bx-im-sidebar-panel__container" :class="{'--second-level': secondLevel}">\n\t\t\t<KeepAlive>\n\t\t\t\t<component\n\t\t\t\t\t:is="panelComponentName"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:entityId="entityId"\n\t\t\t\t\t:secondLevel="secondLevel"\n\t\t\t\t\tclass="bx-im-sidebar-panel__component"\n\t\t\t\t/>\n\t\t\t</KeepAlive>\n\t\t</div>\n\t`};const Ke={name:"ChatSidebar",components:{SidebarPanel:Qe},props:{originDialogId:{type:String,required:true}},emits:["changePanel"],data(){return{needTopLevelTransition:true,needSecondLevelTransition:true,topLevelPanelType:"",topLevelPanelDialogId:"",topLevelPanelStandalone:false,secondLevelPanelType:"",secondLevelPanelDialogId:"",secondLevelPanelEntityId:"",secondLevelPanelStandalone:false}},computed:{SidebarDetailBlock:()=>E.SidebarDetailBlock,topLevelTransitionName(){return this.needTopLevelTransition?"top-level-panel":""},secondLevelTransitionName(){return this.needSecondLevelTransition?"second-level-panel":""},canShowTopPanel(){const t=this.topLevelPanelType===E.SidebarDetailBlock.members;const e=!this.originDialogId.startsWith("chat");if(t&&e){return false}const i=this.topLevelPanelType===E.SidebarDetailBlock.messageSearch;return!i},isCopilotLayout(){const{name:t}=this.$store.getters["application/getLayout"];return t===E.Layout.copilot.name}},watch:{originDialogId(t,e){const i=Boolean(t&&e);if(i){this.needTopLevelTransition=false}if(!this.topLevelPanelStandalone){this.updateTopPanelOriginDialogId(t)}const s=this.secondLevelPanelType.length>0;if(s&&!this.secondLevelPanelStandalone){this.closeSecondLevelPanel()}if(!this.canShowTopPanel){this.closeTopPanel()}},topLevelPanelType(t,e){this.needTopLevelTransition=e.length===0||t.length===0;const i=t===E.SidebarDetailBlock.main;this.saveSidebarOpenedState(i)},secondLevelPanelType(t,e){this.needSecondLevelTransition=!(t&&e)}},created(){C.Logger.warn("ChatSidebar: created");this.restoreOpenState()},mounted(){L.EventEmitter.subscribe(E.EventType.sidebar.open,this.onSidebarOpen);L.EventEmitter.subscribe(E.EventType.sidebar.close,this.onSidebarClose)},beforeUnmount(){L.EventEmitter.unsubscribe(E.EventType.sidebar.open,this.onSidebarOpen);L.EventEmitter.unsubscribe(E.EventType.sidebar.close,this.onSidebarClose)},methods:{onSidebarOpen(t){const{panel:e="",standalone:i=false,dialogId:s,entityId:a=""}=t.getData();const n=e&&this.secondLevelPanelType===e;if(n){this.closeSecondLevelPanel();return}const r=this.topLevelPanelType&&this.topLevelPanelType!==e;if(r){this.openSecondLevelPanel(e,s,i,a)}else{this.openTopPanel(e,s,i)}},onSidebarClose(t){this.needTopLevelTransition=true;const{panel:e=""}=t.getData();const i=e&&this.secondLevelPanelType===e;if(i){this.closeSecondLevelPanel()}else{this.closeSecondLevelPanel();this.closeTopPanel()}},restoreOpenState(){const t=e.LocalStorageManager.getInstance().get(E.LocalStorageKey.sidebarOpened);if(!t||this.isCopilotLayout){return}this.openTopPanel(E.SidebarDetailBlock.main,this.originDialogId,false)},saveSidebarOpenedState(t){const i=200;clearTimeout(this.saveSidebarStateTimeout);this.saveSidebarStateTimeout=setTimeout((()=>{e.LocalStorageManager.getInstance().set(E.LocalStorageKey.sidebarOpened,t)}),i)},openTopPanel(t,e,i=false){this.topLevelPanelType=t;this.topLevelPanelDialogId=e;this.topLevelPanelStandalone=i;this.$emit("changePanel",{panel:this.topLevelPanelType})},updateTopPanelOriginDialogId(t){this.topLevelPanelDialogId=t},openSecondLevelPanel(t,e,i=false,s=""){this.secondLevelPanelType=t;this.secondLevelPanelDialogId=e;this.secondLevelPanelStandalone=i;this.secondLevelPanelEntityId=s;this.$emit("changePanel",{panel:this.secondLevelPanelType})},closeTopPanel(){this.topLevelPanelType="";this.topLevelPanelDialogId="";this.topLevelPanelStandalone=false;this.$emit("changePanel",{panel:""})},closeSecondLevelPanel(){this.secondLevelPanelType="";this.secondLevelPanelDialogId="";this.secondLevelPanelStandalone=false;this.$emit("changePanel",{panel:this.topLevelPanelType})}},template:`\n\t\t<div class="bx-im-sidebar__container">\n\t\t\t<Transition :name="topLevelTransitionName">\n\t\t\t\t<SidebarPanel\n\t\t\t\t\tv-if="topLevelPanelType"\n\t\t\t\t\t:dialogId="topLevelPanelDialogId"\n\t\t\t\t\t:panel="topLevelPanelType"\n\t\t\t\t/>\n\t\t\t</Transition>\n\t\t\t<Transition :name="secondLevelTransitionName">\n\t\t\t\t<SidebarPanel\n\t\t\t\t\tv-if="secondLevelPanelType"\n\t\t\t\t\t:dialogId="secondLevelPanelDialogId" \n\t\t\t\t\t:panel="secondLevelPanelType"\n\t\t\t\t\t:entityId="secondLevelPanelEntityId"\n\t\t\t\t\t:secondLevel="true"\n\t\t\t\t/>\n\t\t\t</Transition>\n\t\t</div>\n\t`};t.ChatSidebar=Ke})(this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{},BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Vue3.Directives,BX.UI,BX.Messenger.v2.Lib,BX.Main,BX.Vue3.Directives,BX.Vue3.Components,BX.UI.Viewer,BX,BX.Messenger.v2.Model,BX,BX,BX.Vue3.Vuex,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.EntitySelector,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Provider.Service,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Component.Elements,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Application);
//# sourceMappingURL=sidebar.bundle.map.js