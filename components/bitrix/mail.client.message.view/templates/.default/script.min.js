(function(){if(window.BXMailView){return}var e=function(t){if(e.__views[t.messageId]){return e.__views[t.messageId]}this.mailboxId=t.mailboxId;this.id=t.messageId;this.options=t;this.progressPercent=0;this.progressInterval=0;e.__views[this.id]=this;e.__views[this.id].init()};e.__views={};e.getView=function(t){return e.__views[t]};e.prototype.init=function(){if(this.options.isAjaxBody&&this.options.messageBodyElementId){this.ajaxLoadMessageBody()}else{this.ajaxLoadAttachments()}this.addPageSwapper();if(this.options.fileRefreshButtonId){this.setRefreshFileButtonAction()}};e.prototype.ajaxLoadMessageBody=function(){const e=this.options.messageId;if(!e){return}this.startProgress();this.bindErrorClose();BX.ajax.runComponentAction("bitrix:mail.client.message.view","getHtmlBody",{mode:"class",data:{id:e}}).then((e=>{this.handleSuccessResponse(e.data)}),(()=>{this.handleFailedResponse()}))};e.prototype.handleSuccessResponse=function(e){this.stopProgress();if(BX.type.isNotEmptyObject(e)&&BX.type.isString(e.messageHtml)){this.insertBodyText(e.messageHtml);if(BX.type.isString(e.quote)){this.insertQuoteText(e.quote)}}t(this.options.warningWaitElementId);this.showControls();this.ajaxLoadAttachments()};e.prototype.insertQuoteText=function(e){const t=this.options;if(BX.type.isString(e)&&BX.type.isString(t.formId)&&BX.type.isString(t.quoteFieldName)&&BX.type.isObject(BXMainMailForm)&&BX.type.isObject(BXMainMailForm.getForm(t.formId))&&BX.type.isArray(BXMainMailForm.getForm(t.formId).fields)){const s=BXMainMailForm.getForm(t.formId).fields;for(const i in s){if(s.hasOwnProperty(i)){if(BX.type.isObject(s[i])&&s[i].name===t.quoteFieldName){s[i].value=e;break}}}}};e.prototype.insertBodyText=function(e){const t=this.options;const s=document.getElementById(t.messageBodyElementId);if(!s){return}s.innerHTML='<div id="mail-message-wrapper">'+e+"</div>";if(BX.type.isObject(t.bxMailMessage)){BX.onCustomEvent(t.bxMailMessage,"MailMessage:reInitMessageBody")}};e.prototype.ajaxLoadAttachments=function(){const e=this.options;const t=this;if(!e.ajaxAttachmentElementId||!e.messageId){return}const s=document.getElementById(e.ajaxAttachmentElementId);if(!s){return}const i=new BX.Loader({target:s,mode:"inline",size:20,color:"#828b95"});i.show();BX.ajax.runComponentAction("bitrix:mail.client.message.view","getAttachments",{mode:"class",data:{id:e.messageId,mail_uf_message_token:e.mailUfMessageToken}}).then((function(n){if(BX.type.isNotEmptyObject(n.data)&&BX.type.isString(n.data.attachmentsHtml)){i.hide();s.innerHTML=n.data.attachmentsHtml;if(e.fileRefreshButtonId){t.setRefreshFileButtonAction()}}}),(function(){i.hide();BX.hide(s.parentElement)}))};e.prototype.showError=function(){t(this.options.warningWaitElementId);s(this.options.warningFailElementId)};e.prototype.startProgress=function(){const e=this.options;if(!e.bodyLoaderElementId||!e.bodyLoaderMaxTime){return}const t=document.getElementById(e.bodyLoaderElementId);if(!t){return}const s=new BX.UI.ProgressBar({maxValue:100,value:0});s.renderTo(BX(e.bodyLoaderElementId));const i=e.bodyLoaderMaxTime/100*1e3;this.progressInterval=setInterval((()=>{if(this.progressPercent>=100){this.stopProgress();this.progressPercent=100}else{this.progressPercent+=1}s.setValue(this.progressPercent);s.update()}),i)};e.prototype.stopProgress=function(){clearInterval(this.progressInterval)};e.prototype.handleFailedResponse=function(){this.stopProgress();this.showError();this.showControls();this.ajaxLoadAttachments()};e.prototype.showControls=function(){s(this.options.messageControlElementId);s(this.options.fastReplyElementId)};e.prototype.bindErrorClose=function(){if(!this.options.warningFailElementId){return}const e=document.getElementById(this.options.warningFailElementId);if(!e){return}const t=e.querySelector(".ui-alert-close-btn");if(!t){return}BX.bind(t,"click",(function(){BX.hide(e)}))};e.prototype.addPageSwapper=function(){const e=BX.SidePanel.Instance.getTopSlider();const t=e.iframe.contentDocument.getElementById("header-page-swapper-container");if(!t){return}if(t.firstChild){return}const s=e.getData().get("hrefList");if(!e||!BX.UI.SidePanel.PageSwapper||!s){t.remove();return}this.pageSwapper=new BX.UI.SidePanel.PageSwapper({slider:e,container:t,pagesHref:s,pageType:"mail"});this.pageSwapper.init();const i=BX.SidePanel.Instance.getOpenSliders();const n=i.length;const o=i[n-2].getFrameWindow();const r=e.getData().get("enableNextPage");if(r&&!this.pageSwapper.hasPagesBeforeEnd(3)){o.document.querySelector(".main-grid-more-btn").click()}};e.prototype.setRefreshFileButtonAction=function(){const e=document.getElementById(this.options.fileRefreshButtonId);if(!e){return}const t=document.querySelector(".mail-msg-refresh-files-button-icon");if(!t){return}const s=()=>{const e="mail-msg-refresh-files-button-icon-rotate";if(this.refreshFilesInProgress){BX.Dom.removeClass(t,e);this.refreshFilesInProgress=false;return}BX.Dom.addClass(t,e);this.refreshFilesInProgress=true};BX.bind(e,"click",(()=>{if(this.refreshFilesInProgress){return}s();BX.ajax.runAction("mail.syncingattachments.resyncAttachments",{data:{messageId:this.id,mailboxId:this.mailboxId}}).then((e=>{if(e.status!=="success"){s();return}location.reload()})).catch((()=>{s()}))}))};function t(e){if(e){const t=document.getElementById(e);if(t){BX.hide(t)}}}function s(e){if(e){const t=document.getElementById(e);if(t&&t.style&&t.style.display==="none"){t.style.display=""}}}window.BXMailView=e})();
//# sourceMappingURL=script.map.js