this.BX=this.BX||{};this.BX.Messenger=this.BX.Messenger||{};this.BX.Messenger.v2=this.BX.Messenger.v2||{};this.BX.Messenger.v2.Component=this.BX.Messenger.v2.Component||{};(function(e,t,s,i,o,a,r,n,l,g,c,d,h,u,p,m,M,b,v,S,f,I,w,B){"use strict";const T="BX.Messenger.v2.Dialog.ScrollManager";var P=babelHelpers.classPrivateFieldLooseKey("getScrollPosition");class C extends d.EventEmitter{constructor(){super();Object.defineProperty(this,P,{value:L});this.isScrolling=false;this.currentScroll=0;this.lastScroll=0;this.chatIsScrolledUp=false;this.scrollButtonClicked=false;this.startScrollNeeded=true;this.setEventNamespace(T)}setContainer(e){this.container=e}onScroll(e){if(this.isScrolling||!e.target){return}this.currentScroll=e.target.scrollTop;const t=this.lastScroll<this.currentScroll;const s=!t;if(s){this.scrollButtonClicked=false}const i=1500;const o=e.target.scrollHeight-e.target.scrollTop-e.target.clientHeight;if(t&&this.isStartScrollCompleted()&&o<i){this.emit(C.events.onScrollTriggerDown)}else if(s&&this.currentScroll<=i){this.emit(C.events.onScrollTriggerUp)}this.lastScroll=this.currentScroll;this.checkIfChatIsScrolledUp()}checkIfChatIsScrolledUp(){const e=400;const t=this.container.scrollHeight-this.container.clientHeight;const s=this.currentScroll+e<t;if(s!==this.chatIsScrolledUp){this.emit(C.events.onScrollThresholdPass,s)}this.chatIsScrolledUp=s}scrollToBottom(){h.Logger.warn("Dialog: ScrollManager: scroll to bottom");this.forceScrollTo(this.container.scrollHeight-this.container.clientHeight)}animatedScrollToBottom(){h.Logger.warn("Dialog: ScrollManager: animated scroll to bottom");this.animatedScrollTo(this.container.scrollHeight-this.container.clientHeight)}scrollToMessage(e,t={}){h.Logger.warn("Dialog: ScrollManager: scroll to message - ",e);const s=this.getDomElementById(e);if(!s){h.Logger.warn("Dialog: ScrollManager: message not found - ",e);return}const i=babelHelpers.classPrivateFieldLooseBase(this,P)[P](s,t);this.forceScrollTo(i)}setStartScrollNeeded(e){this.startScrollNeeded=e}isStartScrollCompleted(){if(!this.startScrollNeeded){return true}return this.lastScroll>0}animatedScrollToMessage(e,t={}){h.Logger.warn("Dialog: ScrollManager: animated scroll to message - ",e);const s=this.getDomElementById(e);if(!s){h.Logger.warn("Dialog: ScrollManager: message not found - ",e);return Promise.resolve()}const i=babelHelpers.classPrivateFieldLooseBase(this,P)[P](s,t);return this.animatedScrollTo(i)}forceScrollTo(e){h.Logger.warn("Dialog: ScrollManager: Force scroll to - ",e);this.cancelAnimatedScroll();this.container.scroll({top:e,behavior:"instant"})}adjustScrollOnHistoryAddition(e){h.Logger.warn("Dialog: ScrollManager: Adjusting scroll after history addition");const t=this.container.scrollHeight-this.container.clientHeight;const s=this.container.scrollTop+t-e;this.forceScrollTo(s)}animatedScrollTo(e){h.Logger.warn("Dialog: ScrollManager: Animated scroll to - ",e);return new Promise((t=>{u.Animation.start({start:this.container.scrollTop,end:e,element:this.container,elementProperty:"scrollTop",callback:()=>{this.checkIfChatIsScrolledUp();t()}})}))}cancelAnimatedScroll(){if(!this.isScrolling){return}u.Animation.cancel();this.isScrolling=false}isAtTheTop(){return this.container.scrollTop===0}isAtTheBottom(){return this.container.scrollTop+this.container.clientHeight>=this.container.scrollHeight}isAroundBottom(){const e=40;return this.container.scrollHeight-this.container.scrollTop-this.container.clientHeight<e}getDomElementById(e){return this.container.querySelector(`[data-id="${e}"]`)}}function L(e,t={}){const s=52;const i=100;const{withDateOffset:o=true,position:a=C.scrollPosition.messageTop}=t;const r=o?-s:-10;let n=e.offsetTop+r;if(a===C.scrollPosition.messageBottom){n+=e.clientHeight-i}return n}C.events={onScrollTriggerUp:"onScrollTriggerUp",onScrollTriggerDown:"onScrollTriggerDown",onScrollThresholdPass:"onScrollThresholdPass"};C.scrollPosition={messageTop:"messageTop",messageBottom:"messageBottom"};const y="IM_PUBLIC_";const x="IM_PUBLIC_COMMENT_";var E=babelHelpers.classPrivateFieldLooseKey("dialog");var F=babelHelpers.classPrivateFieldLooseKey("pullClient");var H=babelHelpers.classPrivateFieldLooseKey("subscribeChannel");var D=babelHelpers.classPrivateFieldLooseKey("subscribeOpenChat");var $=babelHelpers.classPrivateFieldLooseKey("requestWatchStart");var _=babelHelpers.classPrivateFieldLooseKey("isGuest");var U=babelHelpers.classPrivateFieldLooseKey("isChannel");var k=babelHelpers.classPrivateFieldLooseKey("isCommentsChat");class A{constructor(e){Object.defineProperty(this,k,{value:W});Object.defineProperty(this,U,{value:R});Object.defineProperty(this,_,{value:N});Object.defineProperty(this,$,{value:V});Object.defineProperty(this,D,{value:O});Object.defineProperty(this,H,{value:X});Object.defineProperty(this,E,{writable:true,value:void 0});Object.defineProperty(this,F,{writable:true,value:void 0});babelHelpers.classPrivateFieldLooseBase(this,E)[E]=p.Core.getStore().getters["chats/get"](e,true);babelHelpers.classPrivateFieldLooseBase(this,F)[F]=p.Core.getPullClient()}subscribe(){if(babelHelpers.classPrivateFieldLooseBase(this,U)[U]()){babelHelpers.classPrivateFieldLooseBase(this,H)[H]();return}if(babelHelpers.classPrivateFieldLooseBase(this,k)[k]()||!babelHelpers.classPrivateFieldLooseBase(this,_)[_]()){return}babelHelpers.classPrivateFieldLooseBase(this,D)[D]()}unsubscribe(){babelHelpers.classPrivateFieldLooseBase(this,F)[F].clearWatch(`${y}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`);babelHelpers.classPrivateFieldLooseBase(this,F)[F].clearWatch(`${x}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`)}}function X(){babelHelpers.classPrivateFieldLooseBase(this,$)[$]();babelHelpers.classPrivateFieldLooseBase(this,F)[F].extendWatch(`${y}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`);babelHelpers.classPrivateFieldLooseBase(this,F)[F].extendWatch(`${x}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`)}function O(){babelHelpers.classPrivateFieldLooseBase(this,$)[$]();babelHelpers.classPrivateFieldLooseBase(this,F)[F].extendWatch(`${y}${babelHelpers.classPrivateFieldLooseBase(this,E)[E].chatId}`)}function V(){m.runAction(b.RestMethod.imV2ChatExtendPullWatch,{data:{dialogId:babelHelpers.classPrivateFieldLooseBase(this,E)[E].dialogId}})}function N(){var e,t;return((e=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:e.role)===b.UserRole.guest&&((t=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:t.dialogId)!=="settings"}function R(){var e;return M.ChannelManager.isChannel((e=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:e.dialogId)}function W(){var e;return((e=babelHelpers.classPrivateFieldLooseBase(this,E)[E])==null?void 0:e.type)===b.ChatType.comment}var Q=babelHelpers.classPrivateFieldLooseKey("visibleMessages");class j{constructor(){Object.defineProperty(this,Q,{writable:true,value:new Set})}setMessageAsVisible(e){babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].add(e)}setMessageAsNotVisible(e){babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].delete(e)}getVisibleMessages(){return[...babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]]}getFirstMessageId(){if(babelHelpers.classPrivateFieldLooseBase(this,Q)[Q].size===0){return 0}const[e]=[...babelHelpers.classPrivateFieldLooseBase(this,Q)[Q]].sort(((e,t)=>e-t));return e}}const q={props:{message:{type:Object,required:true}},data(){return{}},computed:{internalMessage(){return this.message},text(){return S.Parser.purifyMessage(this.internalMessage)},authorId(){return this.internalMessage.authorId},author(){return this.$store.getters["users/get"](this.authorId)}},template:`\n\t\t<div class="bx-im-dialog-chat__pinned_item">\n\t\t\t<span v-if="author" class="bx-im-dialog-chat__pinned_item_user">{{ author.name }}:</span> {{ text }}\n\t\t</div>\n\t`};const K={name:"PinnedMessages",components:{PinnedMessage:q},props:{dialogId:{type:String,default:""},messages:{type:Array,required:true}},emits:["messageClick","messageUnpin"],data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},firstMessage(){return this.messagesToShow[0]},messagesToShow(){return this.messages.slice(-1)},canUnpin(){return v.PermissionManager.getInstance().canPerformAction(b.ChatActionType.pinMessage,this.dialogId)},showUnpin(){return!this.isCommentChat&&this.canUnpin},isCommentChat(){return this.dialog.type===b.ChatType.comment}},methods:{loc(e){return this.$Bitrix.Loc.getMessage(e)}},template:`\n\t\t<div @click="$emit('messageClick', firstMessage.id)" class="bx-im-dialog-chat__pinned_container">\n\t\t\t<div class="bx-im-dialog-chat__pinned_title">{{ loc('IM_DIALOG_CHAT_PINNED_TITLE') }}</div>\n\t\t\t<PinnedMessage\n\t\t\t\tv-for="message in messagesToShow"\n\t\t\t\t:message="message"\n\t\t\t\t:key="message.id"\n\t\t\t/>\n\t\t\t<div v-if="showUnpin" @click.stop="$emit('messageUnpin', firstMessage.id)" class="bx-im-dialog-chat__pinned_unpin"></div>\n\t\t</div>\n\t`};var G;const Y=44;const z=60;const J=10;const Z=B.MessengerSlider.getInstance().getCurrent();const ee=Z==null?void 0:Z.layout.container.getBoundingClientRect();const te=(G=ee==null?void 0:ee.top)!=null?G:0;const se=".bx-im-message-default-content__text";const ie={name:"QuoteButton",props:{dialogId:{type:String,default:""}},data(){return{text:"",message:null,mouseX:0,mouseY:0}},computed:{containerStyle(){return{top:`${this.mouseY-Y-J-te}px`,left:`${this.mouseX-z/2}px`,width:`${z}px`,height:`${Y}px`}}},mounted(){f.Event.bind(window,"mousedown",this.onMouseDown)},methods:{onMessageMouseUp(e,t){if(t.button===2){return}this.prepareSelectedText();this.message=e;this.mouseX=t.clientX;this.mouseY=t.clientY},onMouseDown(e){const t=this.$refs.container;if(!t||t.contains(e.target)){return}this.$emit("close")},prepareSelectedText(){if(w.Utils.browser.isFirefox()){this.text=window.getSelection().toString();return}const e=window.getSelection().getRangeAt(0);const t=e.cloneContents();let s=t.childNodes;const i=t.querySelector(se);if(i){s=i.childNodes}for(const e of s){if(this.isImage(e)){var o;this.text+=(o=e.getAttribute("data-code"))!=null?o:e.getAttribute("alt")}else if(this.isLineBreak(e)){this.text+="\n"}else{this.text+=e.textContent}}},isImage(e){if(!(e instanceof HTMLElement)){return false}return e.tagName.toLowerCase()==="img"},isLineBreak(e){return e.nodeName.toLowerCase()==="br"},isText(e){return e.nodeName==="#text"},isMessageTextNode(e){if(!(e instanceof HTMLElement)){return false}const t=e.matches(se);return Boolean(t)},extractTextFromMessageNode(e){const t=e.querySelector(se);if(!t){return e.textContent}return t.textContent},onQuoteClick(){I.Quote.sendQuoteEvent(this.message,this.text,this.dialogId);this.$emit("close")}},template:`\n\t\t<div ref="container" @click="onQuoteClick" :style="containerStyle" class="bx-im-dialog-chat__quote-button">\n\t\t\t<div class="bx-im-dialog-chat__quote-icon"></div>\n\t\t\t<div class="bx-im-dialog-chat__quote-icon --hover"></div>\n\t\t</div>\n\t`};const oe={name:"ScrollButton",props:{dialogId:{type:String,required:true}},data(){return{}},computed:{dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},formattedCounter(){if(this.dialog.counter===0){return""}if(this.dialog.counter>99){return"99+"}return String(this.dialog.counter)}},template:`\n\t\t<div class="bx-im-dialog-chat__scroll-button">\n\t\t\t<div v-if="dialog.counter" class="bx-im-dialog-chat__scroll-button_counter">\n\t\t\t\t{{ formattedCounter }}\n\t\t\t</div>\n\t\t</div>\n\t`};const ae={name:"ChatDialog",components:{MessageList:o.MessageList,PinnedMessages:K,QuoteButton:ie,ScrollButton:oe,PullStatus:s.PullStatus,ForwardPopup:a.ForwardPopup},props:{dialogId:{type:String,default:""},saveScrollOnExit:{type:Boolean,default:true},resetOnExit:{type:Boolean,default:false}},data(){return{forwardPopup:{show:false,messageId:0},contextMode:{active:false,messageIsLoaded:false},isScrolledUp:false,windowFocused:false,showQuoteButton:false,messagesToRead:new Set}},computed:{layout(){return this.$store.getters["application/getLayout"]},dialog(){return this.$store.getters["chats/get"](this.dialogId,true)},dialogInited(){return this.dialog.inited},messageCollection(){return this.$store.getters["messages/getByChatId"](this.dialog.chatId)},pinnedMessages(){return this.$store.getters["messages/pin/getPinned"](this.dialog.chatId)},isOpened(){const e=this.$store.getters["application/getLayout"].entityId;return this.dialogId===e},isGuest(){return this.dialog.role===b.UserRole.guest},debouncedScrollHandler(){const e=100;return f.Runtime.debounce(this.getScrollManager().onScroll,e,this.getScrollManager())},debouncedReadHandler(){const e=50;return f.Runtime.debounce(this.readQueuedMessages,e,this)},messageListComponent(){return o.MessageList},showScrollButton(){return this.isScrolledUp||this.dialog.hasNextPage},hasCommentsOnTop(){return this.$store.getters["messages/comments/areOpenedForChannel"](this.dialogId)}},watch:{dialogInited(e,t){if(!e||t){return}this.getPullWatchManager().subscribe();this.onChatInited()},hasCommentsOnTop:{handler(e){const t=e===false;if(!t){return}this.readVisibleMessages()},flush:"post"}},created(){h.Logger.warn("Dialog: Chat created",this.dialogId);this.initContextMode()},mounted(){this.getScrollManager().setContainer(this.getContainer());if(this.dialogInited){this.getPullWatchManager().subscribe();this.onChatInited()}else if(!this.dialogInited&&this.messageCollection.length>0){this.scrollOnStart()}this.windowFocused=document.hasFocus();this.subscribeToEvents()},beforeUnmount(){this.unsubscribeFromEvents();if(this.dialogInited){this.saveScrollPosition();this.handleMessagesOnExit()}this.getPullWatchManager().unsubscribe();this.closeDialogPopups();this.forwardPopup.show=false},methods:{async scrollOnStart(){await this.$nextTick();if(this.contextMode.active&&this.contextMode.messageIsLoaded){this.getScrollManager().scrollToMessage(this.layout.contextId);void this.$nextTick((()=>{this.highlightMessage(this.layout.contextId)}));return}if(this.contextMode.active&&!this.contextMode.messageIsLoaded){this.goToMessageContext(this.layout.contextId);return}if(this.dialog.markedId){this.getScrollManager().scrollToMessage(b.DialogBlockType.newMessages);return}if(this.dialog.savedPositionMessageId&&!this.isGuest){h.Logger.warn("Dialog: saved scroll position, scrolling to",this.dialog.savedPositionMessageId);this.getScrollManager().scrollToMessage(this.dialog.savedPositionMessageId,{withDateOffset:false});return}const e=this.$store.getters["chats/getLastReadId"](this.dialogId);const t=e===this.dialog.lastMessageId;if(e>0&&!t){h.Logger.warn('Dialog: scroll to "New messages" mark, lastReadId -',e,"lastMessageId",this.dialog.lastMessageId);this.getScrollManager().scrollToMessage(b.DialogBlockType.newMessages);return}const s=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(e===0||s){this.getScrollManager().setStartScrollNeeded(false);h.Logger.warn("Dialog: dont scroll, hasUnread -",s,"lastReadId",e);return}this.getScrollManager().scrollToBottom()},showLoadingBar(){d.EventEmitter.emit(b.EventType.dialog.showLoadingBar,{dialogId:this.dialogId})},hideLoadingBar(){d.EventEmitter.emit(b.EventType.dialog.hideLoadingBar,{dialogId:this.dialogId})},async goToMessageContext(e,t={}){const{position:s=C.scrollPosition.messageTop}=t;const o=this.$store.getters["messages/hasMessage"]({chatId:this.dialog.chatId,messageId:e});if(o){h.Logger.warn("Dialog: we have this message, scrolling to it",e);await this.getScrollManager().animatedScrollToMessage(e,{position:s});this.highlightMessage(e);return}const{hasAccess:a,errorCode:r}=await l.AccessManager.checkMessageAccess(e);if(!a&&r===l.AccessErrorCode.messageAccessDeniedByTariff){i.Analytics.getInstance().historyLimit.onGoToContextLimitExceeded({dialogId:this.dialogId});g.FeatureManager.chatHistory.openFeatureSlider();return}this.showLoadingBar();await this.getMessageService().loadContext(e).catch((e=>{h.Logger.error("goToMessageContext error",e)}));await this.$nextTick();this.hideLoadingBar();this.getScrollManager().scrollToMessage(e,{position:s});await this.$nextTick();this.highlightMessage(e)},highlightMessage(e){const t="bx-im-dialog-chat__highlighted-message";const s=2e3;const i=this.getScrollManager().getDomElementById(e);if(!i){return}f.Dom.addClass(i,t);setTimeout((()=>{f.Dom.removeClass(i,t)}),s)},saveScrollPosition(){if(!this.saveScrollOnExit){return}let e=this.getVisibleMessagesManager().getFirstMessageId();if(this.getScrollManager().isAroundBottom()){e=0}this.$store.dispatch("chats/update",{dialogId:this.dialogId,fields:{savedPositionMessageId:e}})},handleMessagesOnExit(){if(this.resetOnExit){this.getChatService().resetChat(this.dialogId);return}const e=200;setTimeout((()=>{void this.getMessageService().reloadMessageList()}),e)},readQueuedMessages(){if(!this.messagesCanBeRead()){return}[...this.messagesToRead].forEach((e=>{this.getChatService().readMessage(this.dialog.chatId,e);this.messagesToRead.delete(e)}))},readVisibleMessages(){if(!this.messagesCanBeRead()){return}const e=this.getVisibleMessagesManager().getVisibleMessages();e.forEach((e=>{const t=this.$store.getters["messages/getById"](e);if(!t||t.viewed){return}this.getChatService().readMessage(this.dialog.chatId,e)}))},messagesCanBeRead(){if(!this.dialogInited||!this.isChatVisible()){return false}const e=v.PermissionManager.getInstance();return e.canPerformAction(b.ChatActionType.readMessage,this.dialogId)},onChatInited(){this.scrollOnStart();this.readVisibleMessages();void this.$nextTick((()=>{this.getChatService().clearDialogMark(this.dialogId)}));d.EventEmitter.emit(b.EventType.dialog.onDialogInited,{dialogId:this.dialogId})},async onScrollTriggerUp(){if(!this.dialogInited||!this.getContainer()){return}h.Logger.warn("Dialog: scroll triggered UP");const e=this.getContainer();const t=e.scrollHeight-e.clientHeight;if(this.getMessageService().hasPreparedHistoryMessages()){await this.getMessageService().drawPreparedHistoryMessages();this.getScrollManager().adjustScrollOnHistoryAddition(t);return}if(this.getMessageService().isLoading()||!this.dialog.hasPrevPage){return}this.showLoadingBar();await this.getMessageService().loadHistory();this.hideLoadingBar();if(this.getScrollManager().isAtTheTop()){h.Logger.warn("Dialog: we are at the top after history request, inserting messages");await this.getMessageService().drawPreparedHistoryMessages();this.getScrollManager().adjustScrollOnHistoryAddition(t)}},async onScrollTriggerDown(){if(!this.dialogInited||!this.getContainer()){return}h.Logger.warn("Dialog: scroll triggered DOWN");if(this.getMessageService().hasPreparedUnreadMessages()){await this.getMessageService().drawPreparedUnreadMessages();return}if(this.getMessageService().isLoading()||!this.dialog.hasNextPage){return}this.showLoadingBar();await this.getMessageService().loadUnread();this.hideLoadingBar();if(this.getScrollManager().isAroundBottom()){h.Logger.warn("Dialog: we are at the bottom after unread request, inserting messages");await this.getMessageService().drawPreparedUnreadMessages();this.getScrollManager().checkIfChatIsScrolledUp()}},async onScrollToBottom(e){const{chatId:t,threshold:s=b.DialogScrollThreshold.halfScreenUp,animation:i=true}=e.getData();if(this.dialog.chatId!==t){return}if(!this.windowFocused||this.hasVisibleCall()){const e=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(e){await this.$nextTick();this.getScrollManager().scrollToMessage(e);return}}h.Logger.warn("Dialog: scroll to bottom",t,s);if(s===b.DialogScrollThreshold.halfScreenUp&&this.isScrolledUp){return}if(s===b.DialogScrollThreshold.nearTheBottom&&!this.getScrollManager().isAroundBottom()){return}await this.$nextTick();if(i){this.getScrollManager().animatedScrollToBottom();return}this.getScrollManager().scrollToBottom()},onGoToMessageContext(e){const{dialogId:t,messageId:s}=e.getData();if(this.dialog.dialogId!==t){return}this.goToMessageContext(s)},onPinnedMessageClick(e){this.goToMessageContext(e)},onPinnedMessageUnpin(e){this.getMessageService().unpinMessage(this.dialog.chatId,e)},onScroll(e){this.closeDialogPopups();this.debouncedScrollHandler(e)},async onScrollButtonClick(){if(this.getScrollManager().scrollButtonClicked){void this.handleSecondScrollButtonClick();return}this.getScrollManager().scrollButtonClicked=true;if(this.dialog.counter===0){this.showLoadingBar();await this.getMessageService().loadInitialMessages();this.hideLoadingBar();this.getScrollManager().scrollToBottom();return}const e=this.$store.getters["messages/getFirstUnread"](this.dialog.chatId);if(!e){this.showLoadingBar();await this.getMessageService().loadInitialMessages();this.hideLoadingBar();await this.getScrollManager().animatedScrollToMessage(e)}await this.getScrollManager().animatedScrollToMessage(e)},onWindowFocus(){this.windowFocused=true;this.readVisibleMessages()},onWindowBlur(){this.windowFocused=false},onCallFold(){const e=r.CallManager.getInstance().getCurrentCallDialogId();if(e!==this.dialogId){return}this.readVisibleMessages()},async onShowQuoteButton(e){const{message:t,event:s}=e.getData();const i=v.PermissionManager.getInstance();if(!i.canPerformAction(b.ChatActionType.send,this.dialogId)){return}this.showQuoteButton=true;await this.$nextTick();this.$refs.quoteButton.onMessageMouseUp(t,s)},async handleSecondScrollButtonClick(){this.getScrollManager().scrollButtonClicked=false;if(this.dialog.hasNextPage){this.showLoadingBar();await this.getMessageService().loadContext(this.dialog.lastMessageId).catch((e=>{h.Logger.error("ChatDialog: scroll to chat end loadContext error",e)}));this.hideLoadingBar();d.EventEmitter.emit(b.EventType.dialog.scrollToBottom,{chatId:this.dialog.chatId});return}void this.getScrollManager().animatedScrollToMessage(this.dialog.lastMessageId,{withDateOffset:false})},onShowForwardPopup(e){const{messageId:t}=e.getData();this.forwardPopup.messageId=t;this.forwardPopup.show=true},onCloseForwardPopup(){this.forwardPopup.messageId=0;this.forwardPopup.show=false},onMessageIsVisible(e){const{messageId:t,dialogId:s}=e.getData();if(s!==this.dialogId){return}this.getVisibleMessagesManager().setMessageAsVisible(t);const i=this.$store.getters["messages/getById"](t);if(!i.viewed&&this.isChatVisible()){this.messagesToRead.add(t);this.debouncedReadHandler()}},onMessageIsNotVisible(e){const{messageId:t,dialogId:s}=e.getData();if(s!==this.dialogId){return}this.getVisibleMessagesManager().setMessageAsNotVisible(t)},initContextMode(){const e=n.LayoutManager.getInstance();if(!e.isChatContextAvailable(this.dialogId)){return}this.contextMode.active=true;this.contextMode.messageIsLoaded=!this.dialogInited},getMessageService(){if(!this.messageService){this.messageService=new c.MessageService({chatId:this.dialog.chatId})}return this.messageService},getChatService(){if(!this.chatService){this.chatService=new c.ChatService}return this.chatService},getScrollManager(){if(!this.scrollManager){this.scrollManager=new C;this.scrollManager.subscribe(C.events.onScrollTriggerUp,this.onScrollTriggerUp);this.scrollManager.subscribe(C.events.onScrollTriggerDown,this.onScrollTriggerDown);this.scrollManager.subscribe(C.events.onScrollThresholdPass,(e=>{this.isScrolledUp=e.getData()}))}return this.scrollManager},getPullWatchManager(){if(!this.pullWatchManager){this.pullWatchManager=new A(this.dialogId)}return this.pullWatchManager},getVisibleMessagesManager(){if(!this.visibleMessagesManager){this.visibleMessagesManager=new j}return this.visibleMessagesManager},isChatVisible(){return this.windowFocused&&!this.hasVisibleCall()&&!this.hasCommentsOnTop},hasVisibleCall(){return r.CallManager.getInstance().hasVisibleCall()},closeDialogPopups(){var e,s,i,o,a;this.showQuoteButton=false;(e=t.PopupManager.getPopupById(b.PopupType.dialogAvatarMenu))==null?void 0:e.close();(s=t.PopupManager.getPopupById(b.PopupType.dialogMessageMenu))==null?void 0:s.close();(i=t.PopupManager.getPopupById(b.PopupType.dialogReactionUsers))==null?void 0:i.close();(o=t.PopupManager.getPopupById(b.PopupType.dialogReadUsers))==null?void 0:o.close();(a=t.PopupManager.getPopupById(b.PopupType.messageBaseFileMenu))==null?void 0:a.close()},subscribeToEvents(){d.EventEmitter.subscribe(b.EventType.dialog.scrollToBottom,this.onScrollToBottom);d.EventEmitter.subscribe(b.EventType.dialog.goToMessageContext,this.onGoToMessageContext);d.EventEmitter.subscribe(b.EventType.call.onFold,this.onCallFold);d.EventEmitter.subscribe(b.EventType.dialog.showForwardPopup,this.onShowForwardPopup);d.EventEmitter.subscribe(b.EventType.dialog.showQuoteButton,this.onShowQuoteButton);d.EventEmitter.subscribe(b.EventType.dialog.onMessageIsVisible,this.onMessageIsVisible);d.EventEmitter.subscribe(b.EventType.dialog.onMessageIsNotVisible,this.onMessageIsNotVisible);f.Event.bind(window,"focus",this.onWindowFocus);f.Event.bind(window,"blur",this.onWindowBlur)},unsubscribeFromEvents(){d.EventEmitter.unsubscribe(b.EventType.dialog.scrollToBottom,this.onScrollToBottom);d.EventEmitter.unsubscribe(b.EventType.dialog.goToMessageContext,this.onGoToMessageContext);d.EventEmitter.unsubscribe(b.EventType.call.onFold,this.onCallFold);d.EventEmitter.unsubscribe(b.EventType.dialog.showForwardPopup,this.onShowForwardPopup);d.EventEmitter.unsubscribe(b.EventType.dialog.showQuoteButton,this.onShowQuoteButton);d.EventEmitter.unsubscribe(b.EventType.dialog.onMessageIsVisible,this.onMessageIsVisible);d.EventEmitter.unsubscribe(b.EventType.dialog.onMessageIsNotVisible,this.onMessageIsNotVisible);f.Event.unbind(window,"focus",this.onWindowFocus);f.Event.unbind(window,"blur",this.onWindowBlur)},getContainer(){return this.$refs.container}},template:`\n\t\t<div class="bx-im-dialog-chat__block bx-im-dialog-chat__scope">\n\t\t\t\x3c!-- Top --\x3e\n\t\t\t<slot name="pinned-panel">\n\t\t\t\t<PinnedMessages\n\t\t\t\t\tv-if="pinnedMessages.length > 0"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t:messages="pinnedMessages"\n\t\t\t\t\t@messageClick="onPinnedMessageClick"\n\t\t\t\t\t@messageUnpin="onPinnedMessageUnpin"\n\t\t\t\t/>\n\t\t\t</slot>\n\t\t\t<PullStatus/>\n\t\t\t\x3c!-- Message list --\x3e\n\t\t\t<div @scroll="onScroll" class="bx-im-dialog-chat__scroll-container" ref="container">\n\t\t\t\t<slot name="message-list">\n\t\t\t\t\t<component :is="messageListComponent" :dialogId="dialogId" />\n\t\t\t\t</slot>\n\t\t\t</div>\n\t\t\t\x3c!-- Float buttons --\x3e\n\t\t\t<slot name="additional-float-button"></slot>\n\t\t\t<Transition name="float-button-transition">\n\t\t\t\t<ScrollButton v-if="showScrollButton" :dialogId="dialogId" @click="onScrollButtonClick" />\n\t\t\t</Transition>\n\t\t\t\x3c!-- Absolute elements --\x3e\n\t\t\t<ForwardPopup\n\t\t\t\t:showPopup="forwardPopup.show"\n\t\t\t\t:messageId="forwardPopup.messageId"\n\t\t\t\t@close="onCloseForwardPopup"\n\t\t\t/>\n\t\t\t<Transition name="fade-up">\n\t\t\t\t<QuoteButton\n\t\t\t\t\tv-if="showQuoteButton"\n\t\t\t\t\t:dialogId="dialogId"\n\t\t\t\t\t@close="showQuoteButton = false" \n\t\t\t\t\tclass="bx-im-message-base__quote-button"\n\t\t\t\t\tref="quoteButton"\n\t\t\t\t/>\n\t\t\t</Transition>\n\t\t</div>\n\t`};e.ChatDialog=ae;e.ScrollManager=C;e.PinnedMessages=K})(this.BX.Messenger.v2.Component.Dialog=this.BX.Messenger.v2.Component.Dialog||{},BX.Main,window,BX.Messenger.v2.Lib,BX.Messenger.v2.Component,BX.Messenger.v2.Component.EntitySelector,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Service,BX.Event,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Application,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Const,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib,BX.Messenger.v2.Lib);
//# sourceMappingURL=chat-dialog.bundle.map.js