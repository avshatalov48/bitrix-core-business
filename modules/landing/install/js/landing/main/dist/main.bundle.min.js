this.BX=this.BX||{};(function(e,n,t,o,a,i,r){"use strict";function s(e){return!!e&&!!e.querySelector(".block-wrapper")}function l(e){return!!e&&!!e.querySelector('button[data-id="insert_first_block"]')}function c(e,n){return new Promise(function(t){var o=function o(a){if(!n||a.animationName===n){t(a);r.Event.bind(e,"animationend",o)}};r.Event.bind(e,"animationend",o)})}function d(e){if(r.Type.isNil(e)){return true}if(r.Type.isArrayLike(e)){return!e.length}if(r.Type.isObject(e)){return Object.keys(e).length<=0}return true}function u(){var e=babelHelpers.taggedTemplateLiteral(["",""]);u=function n(){return e};return e}var k="ru";var g="by";var f="kz";var h="la";var B="de";var m="br";var b="ua";BX.Landing.getMode=function(){return"edit"};var v=function(e){babelHelpers.inherits(v,e);babelHelpers.createClass(v,null,[{key:"getMode",value:function e(){return"edit"}},{key:"createInstance",value:function e(n){var t=BX.Landing.PageObject.getRootWindow();t.BX.Landing.Main.instance=new BX.Landing.Main(n)}},{key:"getInstance",value:function e(){var n=BX.Landing.PageObject.getRootWindow();n.BX.Reflection.namespace("BX.Landing.Main");if(n.BX.Landing.Main.instance){return n.BX.Landing.Main.instance}n.BX.Landing.Main.instance=new v(-1);return n.BX.Landing.Main.instance}}]);function v(e){var t;babelHelpers.classCallCheck(this,v);t=babelHelpers.possibleConstructorReturn(this,babelHelpers.getPrototypeOf(v).call(this));t.setEventNamespace("BX.Landing.Main");var o=n.Env.getInstance().getOptions();t.id=e;t.options=Object.freeze(o);t.currentBlock=null;t.isDesignBlockModeFlag=t.options["design_block"]===true;t.loadedDeps={};t.cache=new r.Cache.MemoryCache;t.onSliderFormLoaded=t.onSliderFormLoaded.bind(babelHelpers.assertThisInitialized(t));t.onBlockDelete=t.onBlockDelete.bind(babelHelpers.assertThisInitialized(t));BX.addCustomEvent("Landing.Block:onAfterDelete",t.onBlockDelete);t.adjustEmptyAreas();BX.Landing.UI.Panel.StatusPanel.setLastModified(o.lastModified);if(!t.isDesignBlockModeFlag){BX.Landing.UI.Panel.StatusPanel.getInstance().show()}return t}babelHelpers.createClass(v,[{key:"isDesignBlockMode",value:function e(){return this.isDesignBlockModeFlag}},{key:"getBlocksPanel",value:function e(){var n=this;return this.cache.remember("blockPanel",function(){var e=n.createBlocksPanel();setTimeout(function(){e.sidebarButtons.get(n.options.default_section).layout.click()});e.layout.hidden=true;e.content.hidden=false;r.Dom.append(e.layout,document.body);return e})}},{key:"hideBlocksPanel",value:function e(){if(this.getBlocksPanel()){return this.getBlocksPanel().hide()}return Promise.resolve()}},{key:"getLayoutAreas",value:function e(){return this.cache.remember("layoutAreas",function(){return[].concat(babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-header")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-sidebar")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-main")),babelHelpers.toConsumableArray(document.body.querySelectorAll(".landing-footer")))})}},{key:"createInsertBlockButton",value:function e(n){var o=new BX.Landing.UI.Button.Plus("insert_first_block",{text:t.Loc.getMessage("ACTION_BUTTON_CREATE")});o.on("click",this.showBlocksPanel.bind(this,null,n,o));o.on("mouseover",this.onCreateButtonMouseover.bind(this,n,o));o.on("mouseout",this.onCreateButtonMouseout.bind(this,n,o));return o}},{key:"onCreateButtonMouseover",value:function e(n,o){if(r.Dom.hasClass(n,"landing-header")||r.Dom.hasClass(n,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){var i=t.Loc.getMessage("ACTION_BUTTON_CREATE");if(r.Dom.hasClass(n,"landing-main")){o.setText("".concat(i," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_MAIN")))}if(r.Dom.hasClass(n,"landing-header")){o.setText("".concat(i," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_HEADER")))}if(r.Dom.hasClass(n,"landing-sidebar")){o.setText("".concat(i," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_SIDEBAR")))}if(r.Dom.hasClass(n,"landing-footer")){o.setText("".concat(i," ").concat(t.Loc.getMessage("LANDING_ADD_BLOCK_TO_FOOTER")))}clearTimeout(this.fadeTimeout);this.fadeTimeout=setTimeout(function(){r.Dom.addClass(n,"landing-area-highlight");a.filter(function(e){return e!==n}).forEach(function(e){r.Dom.addClass(e,"landing-area-fade")})},400)}}}},{key:"onCreateButtonMouseout",value:function e(n,o){clearTimeout(this.fadeTimeout);if(r.Dom.hasClass(n,"landing-header")||r.Dom.hasClass(n,"landing-footer")){var a=this.getLayoutAreas();if(a.length>1){o.setText(t.Loc.getMessage("ACTION_BUTTON_CREATE"));a.forEach(function(e){r.Dom.removeClass(e,"landing-area-highlight");r.Dom.removeClass(e,"landing-area-fade")})}}}},{key:"initEmptyArea",value:function e(n){if(n){n.innerHTML="";r.Dom.append(this.createInsertBlockButton(n).layout,n);r.Dom.addClass(n,"landing-empty")}}},{key:"destroyEmptyArea",value:function e(n){if(n){var t=n.querySelector('button[data-id="insert_first_block"]');if(t){r.Dom.remove(t)}r.Dom.removeClass(n,"landing-empty")}}},{key:"adjustEmptyAreas",value:function e(){this.getLayoutAreas().filter(function(e){return s(e)&&l(e)}).forEach(this.destroyEmptyArea,this);this.getLayoutAreas().filter(function(e){return!s(e)&&!l(e)}).forEach(this.initEmptyArea,this);var n=document.body.querySelector("main.landing-edit-mode");var t=!this.getLayoutAreas().some(s);if(n){if(t){r.Dom.addClass(n,"landing-empty");return}r.Dom.removeClass(n,"landing-empty")}}},{key:"enableControls",value:function e(){r.Dom.removeClass(document.body,"landing-ui-hide-controls")}},{key:"disableControls",value:function e(){r.Dom.addClass(document.body,"landing-ui-hide-controls")}},{key:"isControlsEnabled",value:function e(){return!r.Dom.hasClass(document.body,"landing-ui-hide-controls")}},{key:"appendBlock",value:function e(n,t){var o=r.Tag.render(u(),n.content);o.id="block".concat(n.id);if(!t){r.Dom.addClass(o,"landing-ui-show");c(o,"showBlock").then(function(){r.Dom.removeClass(o,"landing-ui-show")})}this.insertToBlocksFlow(o);return o}},{key:"showBlocksPanel",value:function e(n,t,o){this.currentBlock=n;this.currentArea=t;this.getBlocksPanel().show();this.disableAddBlockButtons();if(!!t&&!!o){this.onCreateButtonMouseout(t,o)}}},{key:"disableAddBlockButtons",value:function e(){i.PageObject.getBlocks().forEach(function(e){var n=e.panels.get("create_action");if(n){var t=n.buttons.get("insert_after");if(t){t.disable()}}})}},{key:"enableAddBlockButtons",value:function e(){i.PageObject.getBlocks().forEach(function(e){var n=e.panels.get("create_action");if(n){var t=n.buttons.get("insert_after");if(t){t.enable()}}})}},{key:"createBlocksPanel",value:function e(){var n=this;var a=this.options.blocks;var i=Object.keys(a);var r=new o.Content("blocks_panel",{title:t.Loc.getMessage("LANDING_CONTENT_BLOCKS_TITLE"),className:"landing-ui-panel-block-list",scrollAnimation:true});r.subscribe("onCancel",function(){n.enableAddBlockButtons()});i.forEach(function(e){var t=!d(a[e].items);var o=e==="popular";var i=a[e].separator;if(t&&!o||i){r.appendSidebarButton(n.createBlockPanelSidebarButton(e,a[e]))}});r.appendSidebarButton(new BX.Landing.UI.Button.SidebarButton("feedback_button",{className:"landing-ui-button-sidebar-feedback",text:t.Loc.getMessage("LANDING_BLOCKS_LIST_FEEDBACK_BUTTON"),onClick:this.showFeedbackForm.bind(this)}));return r}},{key:"showSliderFeedbackForm",value:function e(){var n=this;var a=arguments.length>0&&arguments[0]!==undefined?arguments[0]:{};if(!this.sliderFeedbackInited){this.sliderFeedbackInited=true;this.sliderFeedback=new o.Content("slider_feedback",{title:t.Loc.getMessage("LANDING_PANEL_FEEDBACK_TITLE"),className:"landing-ui-panel-feedback"});r.Dom.append(this.sliderFeedback.layout,document.body);this.sliderFormLoader=new BX.Loader({target:this.sliderFeedback.content});this.sliderFormLoader.show();this.initFeedbackForm()}a.bitrix24=this.options.server_name;a.siteId=this.options.site_id;a.siteUrl=this.options.url;a.siteTemplate=this.options.xml_id;a.productType=this.options.productType||"Undefined";a.typeproduct=function(){if(n.options.params.type==="GROUP"){return"KNOWLEDGE_GROUP"}return n.options.params.type}();var i=this.getFeedbackFormOptions();window.b24formFeedBack({id:i.id,lang:i.lang,sec:i.sec,type:"slider_inline",node:this.sliderFeedback.content,handlers:{load:this.onSliderFormLoaded.bind(this)},presets:r.Type.isPlainObject(a)?a:{}});this.sliderFeedback.show()}},{key:"getFeedbackFormOptions",value:function e(){var n=t.Loc.getMessage("LANGUAGE_ID");var o={id:"16",sec:"3h483y",lang:"en"};switch(n){case k:case g:case f:o={id:"8",sec:"x80yjw",lang:"ru"};break;case h:o={id:"14",sec:"wu561i",lang:"la"};break;case B:o={id:"10",sec:"eraz2q",lang:"de"};break;case m:o={id:"12",sec:"r6wvge",lang:"br"};break;case b:o={id:"18",sec:"d9e09o",lang:"ua"};break;default:break}return o}},{key:"onSliderFormLoaded",value:function e(){this.sliderFormLoader.hide()}},{key:"showFeedbackForm",value:function e(){this.showSliderFeedbackForm({target:"blocksList"})}},{key:"initFeedbackForm",value:function e(){(function(e,n,t,o){e.Bitrix24FormObject=o;e[o]=e[o]||function(){arguments[0].ref=t;(e[o].forms=e[o].forms||[]).push(arguments[0])};if(e[o].forms)return;var a=n.createElement("script");var i=1*new Date;a.async=1;a.src="".concat(t,"?").concat(i);var r=n.getElementsByTagName("script")[0];r.parentNode.insertBefore(a,r)})(window,document,"https://landing.bitrix24.ru/bitrix/js/crm/form_loader.js","b24formFeedBack")}},{key:"createBlockPanelSidebarButton",value:function e(n,t){return new BX.Landing.UI.Button.SidebarButton(n,{text:t.name,child:!t.separator,className:t.new?"landing-ui-new-section":"",onClick:this.onBlocksListCategoryChange.bind(this,n)})}},{key:"onBlocksListCategoryChange",value:function e(n){var t=this;this.getBlocksPanel().content.hidden=false;this.getBlocksPanel().sidebarButtons.forEach(function(e){var t=e.id===n?"add":"remove";e.layout.classList[t]("landing-ui-active")});this.getBlocksPanel().content.innerHTML="";if(n==="last"){if(!this.lastBlocks){this.lastBlocks=Object.keys(this.options.blocks.last.items)}this.lastBlocks=babelHelpers.toConsumableArray(new Set(this.lastBlocks));this.lastBlocks.forEach(function(e){var n=t.getBlockFromRepository(e);t.getBlocksPanel().appendCard(t.createBlockCard(e,n))});return}Object.keys(this.options.blocks[n].items).forEach(function(e){var o=t.options.blocks[n].items[e];t.getBlocksPanel().appendCard(t.createBlockCard(e,o))});if(this.getBlocksPanel().content.scrollTop){requestAnimationFrame(function(){t.getBlocksPanel().content.scrollTop=0})}}},{key:"getBlockFromRepository",value:function e(n){var t=this.options.blocks;var o=Object.keys(t);var a=o.find(function(e){return n in t[e].items});if(a){return t[a].items[n]}}},{key:"onCopyBlock",value:function e(n){window.localStorage.landingBlockId=n.id;window.localStorage.landingBlockName=n.manifest.block.name;window.localStorage.landingBlockAction="copy";try{window.localStorage.requiredUserAction=JSON.stringify(n.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}}},{key:"onCutBlock",value:function e(n){window.localStorage.landingBlockId=n.id;window.localStorage.landingBlockName=n.manifest.block.name;window.localStorage.landingBlockAction="cut";try{window.localStorage.requiredUserAction=JSON.stringify(n.requiredUserActionOptions)}catch(e){window.localStorage.requiredUserAction=""}BX.Landing.PageObject.getBlocks().remove(n);r.Dom.remove(n.node);BX.onCustomEvent("Landing.Block:onAfterDelete",[n])}},{key:"onPasteBlock",value:function e(n){var t=this;if(window.localStorage.landingBlockId){var o="Landing::copyBlock";if(window.localStorage.landingBlockAction==="cut"){o="Landing::moveBlock"}var a={};a[o]={action:o,data:{lid:n.lid||BX.Landing.Main.getInstance().id,block:window.localStorage.landingBlockId,params:{AFTER_ID:n.id,RETURN_CONTENT:"Y"}}};BX.Landing.Backend.getInstance().batch(o,a,{action:o}).then(function(e){t.currentBlock=n;return t.addBlock(e[o].result.content)})}}},{key:"addBlock",value:function e(n,t,o){if(this.lastBlocks){this.lastBlocks.unshift(n.manifest.code)}var a=this;var i=this.appendBlock(n,o);return this.loadBlockDeps(n).then(function(e){if(!r.Type.isBoolean(t)||t===false){var o=null;var s=null;if(a.currentBlock){o=a.currentBlock.lid;s=a.currentBlock.id}if(a.currentArea){o=r.Dom.attr(a.currentArea,"data-landing");s=r.Dom.attr(a.currentArea,"data-site")}BX.Landing.History.getInstance().push(new BX.Landing.History.Entry({block:e.id,selector:"#block".concat(e.id),command:"addBlock",undo:"",redo:{currentBlock:s,lid:o,code:e.manifest.code}}))}a.currentBlock=null;a.currentArea=null;var l=parseInt(n.id);var c=BX.Landing.PageObject.getBlocks().get(l);if(c){r.Dom.remove(c.node);BX.Landing.PageObject.getBlocks().remove(c)}void new BX.Landing.Block(i,{id:l,requiredUserAction:n.requiredUserAction,manifest:n.manifest,access:n.access,active:r.Text.toBoolean(n.active),php:n.php,designed:n.designed,anchor:n.anchor,dynamicParams:n.dynamicParams});return a.runBlockScripts(n).then(function(){return i})}).catch(function(e){console.warn(e)})}},{key:"onAddBlock",value:function e(n,t,o){var a=this;var i=r.Text.toNumber(t);this.hideBlocksPanel();return this.showBlockLoader().then(this.loadBlock(n,i)).then(function(e){return new Promise(function(n){setTimeout(function(){n(e)},500)})}).then(function(e){var n=a.addBlock(e,o);a.adjustEmptyAreas();void a.hideBlockLoader();a.enableAddBlockButtons();return n})}},{key:"insertToBlocksFlow",value:function e(n){var t=this.currentBlock&&this.currentBlock.node&&this.currentBlock.node.parentNode;if(t){r.Dom.insertAfter(n,this.currentBlock.node);return}r.Dom.prepend(n,this.currentArea)}},{key:"getBlockLoader",value:function e(){if(!this.blockLoader){this.blockLoader=new BX.Loader({size:60});this.blockLoaderContainer=r.Dom.create("div",{props:{className:"landing-block-loader-container"},children:[this.blockLoader.layout]})}return this.blockLoaderContainer}},{key:"showBlockLoader",value:function e(){this.insertToBlocksFlow(this.getBlockLoader());this.blockLoader.show();return Promise.resolve()}},{key:"hideBlockLoader",value:function e(){r.Dom.remove(this.getBlockLoader());this.blockLoader=null;return Promise.resolve()}},{key:"loadBlockDeps",value:function e(n){var t=this;var o=BX.processHTML(n.content_ext);if(BX.type.isArray(o.SCRIPT)){o.SCRIPT=o.SCRIPT.filter(function(e){return!e.isInternal})}var a=0;var i=n.js.length+o.SCRIPT.length+o.STYLE.length+n.css.length;var r=null;if(!this.loadedDeps[n.manifest.code]&&i>0){r=new Promise(function(e){function r(){a+=1;if(a===i){e(n)}}if(i>a){o.SCRIPT.forEach(function(e){if(!e.isInternal){BX.loadScript(e.JS,r)}});o.STYLE.forEach(function(e){BX.loadScript(e,r)});n.css.forEach(function(e){BX.loadScript(e,r)});n.js.forEach(function(e){BX.loadScript(e,r)})}else{r()}t.loadedDeps[n.manifest.code]=true})}else{r=Promise.resolve(n)}return r}},{key:"runBlockScripts",value:function e(n){return new Promise(function(e){var t=BX.processHTML(n.content).SCRIPT;if(t.length){BX.ajax.processScripts(t,undefined,function(){e(n)})}else{e(n)}})}},{key:"loadBlock",value:function e(n,t){var o=this;return function(){var e=o.id;var a=o.options.site_id;if(o.currentBlock){e=o.currentBlock.lid;a=o.currentBlock.siteId}if(o.currentArea){e=r.Dom.attr(o.currentArea,"data-landing");a=r.Dom.attr(o.currentArea,"data-site")}var i={lid:e,siteId:a};var s={ACTIVE:"Y",CODE:n,AFTER_ID:o.currentBlock?o.currentBlock.id:0,RETURN_CONTENT:"Y"};if(!t){i.fields=s;return BX.Landing.Backend.getInstance().action("Landing::addBlock",i,{code:n})}i={undeleete:{action:"Landing::markUndeletedBlock",data:{lid:e,block:t}},getContent:{action:"Block::getContent",data:{block:t,lid:e,fields:s,editMode:1}}};return BX.Landing.Backend.getInstance().batch("Landing::addBlock",i,{code:n}).then(function(e){e.getContent.result.id=t;return e.getContent.result})}}},{key:"createBlockCard",value:function e(n,t,o){return new BX.Landing.UI.Card.BlockPreviewCard({title:t.name,image:t.preview,code:n,mode:o,isNew:t.new===true,onClick:this.onAddBlock.bind(this,n)})}},{key:"onBlockDelete",value:function e(n){if(!n.parent.querySelector(".block-wrapper")){this.adjustEmptyAreas()}}},{key:"showOverlay",value:function e(){var n=document.querySelector("main.landing-edit-mode");if(n){r.Dom.addClass(n,"landing-ui-overlay")}}},{key:"hideOverlay",value:function e(){var n=document.querySelector("main.landing-edit-mode");if(n){r.Dom.removeClass(n,"landing-ui-overlay")}}},{key:"reloadSlider",value:function e(n){return a.SliderHacks.reloadSlider(n,window.parent)}}]);return v}(r.Event.EventEmitter);babelHelpers.defineProperty(v,"TYPE_PAGE","PAGE");babelHelpers.defineProperty(v,"TYPE_STORE","STORE");e.Main=v})(this.BX.Landing=this.BX.Landing||{},BX.Landing,BX.Landing,BX.Landing.UI.Panel,BX.Landing,BX.Landing,BX);
//# sourceMappingURL=main.bundle.map.js