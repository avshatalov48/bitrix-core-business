{"version":3,"file":"widgetvueloader.bundle.js","sources":["../src/widgetvueloader.js"],"sourcesContent":["import {LoaderOptions} from './internal/types';\nimport {VueCreateAppResult} from 'ui.vue3';\nimport {Backend} from 'landing.backend';\nimport {Runtime, Text, Type, Dom, ajax as Ajax} from 'main.core';\nimport {Content} from '../../widgetvue/src/components/content';\nimport {Loader} from 'main.loader';\n\nexport class WidgetVueLoader\n{\n\tstatic runningAppNodes: Set<HTMLElement> = new Set();\n\n\t#rootNode: ?HTMLElement;\n\t#data: {} = {};\n\t#lang: {[key: string]: string} = {};\n\t#blockId: number = 0;\n\t#appId: number = 0;\n\n\t#fetchable: boolean;\n\t#clickable: boolean;\n\t#allowedByTariff: boolean;\n\n\t// #application: VueCreateAppResult;\n\t// #contentComponent: Object;\n\n\t// #widgetOptions: {};\n\n\tconstructor(options: LoaderOptions): void\n\t{\n\t\tconsole.log(\"options\", options);\n\t\tthis.#rootNode = Type.isString(options.rootNode)\n\t\t\t? document.querySelector(options.rootNode)\n\t\t\t: null\n\t\t;\n\n\t\tthis.#data = Type.isObject(options.data) ? options.data : null;\n\t\tthis.#lang = options.lang || {};\n\t\tthis.#blockId = options.blockId ? Text.toNumber(options.blockId) : 0;\n\t\tthis.#appId = options.appId ? Text.toNumber(options.appId) : 0;\n\n\t\t// todo: need?\n\t\t// this.#widgetOptions = options;\n\t\t//\n\t\t// delete this.#widgetOptions.rootNode;\n\t\t//\n\t\t// const isEditMode = Type.isFunction(BX.Landing.getMode) && BX.Landing.getMode() === 'edit';\n\t\t// this.#widgetOptions.clickable = !isEditMode;\n\n\t\tthis.#fetchable = options.fetchable || false;\n\t\tconst isEditMode = Type.isFunction(BX.Landing.getMode) && BX.Landing.getMode() === 'edit';\n\t\tthis.#clickable = !isEditMode;\n\t\tthis.#allowedByTariff =\n\t\t\t(this.#appId && Type.isBoolean(options.allowedByTariff))\n\t\t\t\t? options.allowedByTariff\n\t\t\t\t: true\n\t\t;\n\t}\n\n\t/**\n\t * Create frame with widget content\n\t * @returns {Promise|*}\n\t */\n\tmount()\n\t{\n\t\treturn this.#getFrameContent()\n\t\t\t.then(srcDoc =>\n\t\t\t{\n\t\t\t\tconst frame = document.createElement('iframe');\n\t\t\t\tframe.sandbox = 'allow-scripts';\n\t\t\t\tframe.srcdoc = srcDoc;\n\n\t\t\t\tif (\n\t\t\t\t\tthis.#blockId > 0\n\t\t\t\t\t&& this.#rootNode\n\t\t\t\t\t&& !WidgetVueLoader.runningAppNodes.has(this.#rootNode)\n\t\t\t\t)\n\t\t\t\t{\n\t\t\t\t\tDom.clean(this.#rootNode);\n\t\t\t\t\tDom.append(frame, this.#rootNode);\n\n\t\t\t\t\twindow.addEventListener(\"message\", event =>\n\t\t\t\t\t{\n\t\t\t\t\t\tif (event.origin === 'null')\n\t\t\t\t\t\t{\n\t\t\t\t\t\t\tconsole.log(\"event\", event);\n\t\t\t\t\t\t\t// this.#getAssetsConfigs();\n\t\t\t\t\t\t}\n\n\t\t\t\t\t\t// can message back using event.source.postMessage(...)\n\t\t\t\t\t});\n\t\t\t\t}\n\t\t\t})\n\t\t;\n\t}\n\n\t#getFrameContent(): Promise\n\t{\n\t\treturn this.#getFrameHead()\n\t\t\t.then(frameHead => {\n\t\t\t\treturn frameHead + this.#getFrameBody();\n\t\t\t})\n\t\t;\n\t}\n\n\t#getFrameHead()\n\t{\n\t\treturn this.#getAssetsConfigs()\n\t\t\t.then(assets => {\n\t\t\t\tconst domain = `${document.location.protocol}//${document.location.host}`;\n\t\t\t\tlet head = '';\n\n\t\t\t\t(assets.js || []).forEach(js => {\n\t\t\t\t\thead += `<script src=\"${domain}${js}\"></script>`;\n\t\t\t\t});\n\n\t\t\t\t(assets.css || []).forEach(css => {\n\t\t\t\t\thead += `<link href=\"${domain}${css}\" type=\"text/css\" rel=\"stylesheet\" />`;\n\t\t\t\t});\n\n\t\t\t\tconst lang = JSON.stringify(assets.lang_additional || {});\n\t\t\t\thead += `<script>BX.message(${lang})</script>`;\n\n\t\t\t\thead += `<script>BX.message(${this.#lang})</script>`;\n\n\t\t\t\treturn head;\n\t\t\t})\n\t\t;\n\t}\n\n\t#getAssetsConfigs()\n\t{\n\t\tconst extCodes = [\n\t\t\t'main.core',\n\t\t\t'landing.widgetvue',\n\t\t];\n\n\t\treturn Backend.getInstance()\n\t\t\t.action(\n\t\t\t\t'Block::getAssetsConfig',\n\t\t\t\t{ extCodes },\n\t\t\t)\n\t\t;\n\t}\n\n\t#getFrameBody()\n\t{\n\t\tlet frameContent = `\n\t\t\t<script>\n\t\t\t\tconsole.log('test message', BX.message('LANDING_WIDGETVUE_ERROR_PAYMENT'));\t\n\t\t\t</script>\n\t\t`;\n\n\t\t// window.parent.postMessage(\"halou\", \"*\");\n\n\t\treturn frameContent;\n\t}\n}\n"],"names":["WidgetVueLoader","constructor","options","console","log","Type","isString","rootNode","document","querySelector","isObject","data","lang","blockId","Text","toNumber","appId","fetchable","isEditMode","isFunction","BX","Landing","getMode","isBoolean","allowedByTariff","mount","then","srcDoc","frame","createElement","sandbox","srcdoc","runningAppNodes","has","Dom","clean","append","window","addEventListener","event","origin","frameHead","assets","domain","location","protocol","host","head","js","forEach","css","JSON","stringify","lang_additional","extCodes","Backend","getInstance","action","frameContent","Set"],"mappings":"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"}