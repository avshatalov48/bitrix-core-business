{"version":3,"file":"core.bundle.js","sources":["../src/core.js"],"sourcesContent":["import { Extension, Loc } from 'main.core';\nimport { BitrixVue } from 'ui.vue3';\nimport { Builder, Store } from 'ui.vue3.vuex';\n\nimport 'pull.client';\nimport 'rest.client';\n\nimport 'im.v2.application.launch';\n\nimport {\n\tApplicationModel,\n\tMessagesModel,\n\tChatsModel,\n\tUsersModel,\n\tFilesModel,\n\tRecentModel,\n\tNotificationsModel,\n\tSidebarModel,\n\tMarketModel,\n\tCountersModel,\n\tCopilotModel,\n} from 'im.v2.model';\nimport {\n\tBasePullHandler,\n\tRecentPullHandler,\n\tNotificationPullHandler,\n\tNotifierPullHandler,\n\tOnlinePullHandler,\n\tCounterPullHandler,\n} from 'im.v2.provider.pull';\nimport { Logger } from 'im.v2.lib.logger';\nimport { OpenLinesLaunchResources } from 'imopenlines.v2.lib.launch-resources';\n\nimport type { RestClient } from 'rest.client';\n\nclass CoreApplication\n{\n\thost: string;\n\tuserId: number;\n\tsiteId: string;\n\tsiteDir: string;\n\tlanguageId: string;\n\tapplicationData: {[key]: any} = {};\n\n\t/* region 01. Initialize and store data */\n\tconstructor()\n\t{\n\t\tthis.inited = false;\n\t\tthis.initPromise = new Promise((resolve) => {\n\t\t\tthis.initPromiseResolver = resolve;\n\t\t});\n\n\t\tthis.offline = false;\n\n\t\tthis.vuexAdditionalModel = [];\n\n\t\tthis.store = null;\n\t\tthis.storeBuilder = null;\n\n\t\tthis.prepareVariables();\n\t\tthis.initRestClient();\n\t}\n\n\tstart()\n\t{\n\t\tthis.initStorage()\n\t\t\t.then(() => this.initPull())\n\t\t\t.then(() => this.initComplete())\n\t\t\t.catch((error) => {\n\t\t\t\tLogger.error('Core: error starting core application', error);\n\t\t\t})\n\t\t;\n\t}\n\n\tprepareVariables()\n\t{\n\t\tthis.localize = BX ? { ...BX.message } : {};\n\n\t\tthis.host = location.origin;\n\t\tthis.userId = Number.parseInt(Loc.getMessage('USER_ID'), 10) ?? 0;\n\t\tthis.siteId = Loc.getMessage('SITE_ID') ?? 's1';\n\t\tthis.siteDir = Loc.getMessage('SITE_DIR') ?? 's1';\n\t\tthis.languageId = Loc.getMessage('LANGUAGE_ID') ?? 'en';\n\t}\n\n\tinitRestClient()\n\t{\n\t\tthis.restInstance = BX.RestClient;\n\t\tthis.restClient = BX.rest;\n\t}\n\n\tinitStorage(): Promise\n\t{\n\t\tconst builder = Builder.init()\n\t\t\t.addModel(ApplicationModel.create())\n\t\t\t.addModel(MessagesModel.create())\n\t\t\t.addModel(ChatsModel.create())\n\t\t\t.addModel(FilesModel.create())\n\t\t\t.addModel(UsersModel.create())\n\t\t\t.addModel(RecentModel.create())\n\t\t\t.addModel(CountersModel.create())\n\t\t\t.addModel(NotificationsModel.create())\n\t\t\t.addModel(SidebarModel.create())\n\t\t\t.addModel(MarketModel.create())\n\t\t\t.addModel(CopilotModel.create())\n\t\t;\n\n\t\tOpenLinesLaunchResources.models.forEach((model) => {\n\t\t\tbuilder.addModel(model.create());\n\t\t});\n\n\t\treturn builder.build().then((result) => {\n\t\t\tthis.store = result.store;\n\t\t\tthis.storeBuilder = result.builder;\n\n\t\t\treturn true;\n\t\t});\n\t}\n\n\tinitPull(): Promise\n\t{\n\t\tthis.pullInstance = BX.PullClient;\n\t\tthis.pullClient = BX.PULL;\n\t\tif (!this.pullClient)\n\t\t{\n\t\t\treturn Promise.reject(new Error('Core: error setting pull client'));\n\t\t}\n\n\t\tthis.pullClient.subscribe(new BasePullHandler());\n\t\tthis.pullClient.subscribe(new RecentPullHandler());\n\t\tthis.pullClient.subscribe(new NotificationPullHandler());\n\t\tthis.pullClient.subscribe(new NotifierPullHandler());\n\t\tthis.pullClient.subscribe(new OnlinePullHandler());\n\t\tthis.pullClient.subscribe(new CounterPullHandler());\n\n\t\tOpenLinesLaunchResources.pullHandlers.forEach((Handler) => {\n\t\t\tthis.pullClient.subscribe(new Handler());\n\t\t});\n\n\t\tthis.pullClient.subscribe({\n\t\t\ttype: this.pullInstance.SubscriptionType.Status,\n\t\t\tcallback: this.onPullStatusChange.bind(this),\n\t\t});\n\n\t\treturn Promise.resolve();\n\t}\n\n\tinitComplete()\n\t{\n\t\tthis.inited = true;\n\t\tthis.initPromiseResolver(this);\n\t}\n\t/* endregion 01. Initialize and store data */\n\n\t/* region 02. Push & Pull */\n\tonPullStatusChange(data)\n\t{\n\t\tif (data.status === this.pullInstance.PullStatus.Online)\n\t\t{\n\t\t\tthis.offline = false;\n\t\t}\n\t\telse if (data.status === this.pullInstance.PullStatus.Offline)\n\t\t{\n\t\t\tthis.offline = true;\n\t\t}\n\t}\n\t/* endregion 02. Push & Pull */\n\n\t/* region 04. Template engine */\n\tcreateVue(application, config = {}): Promise\n\t{\n\t\tconst initConfig = {};\n\n\t\tif (config.el)\n\t\t{\n\t\t\tinitConfig.el = config.el;\n\t\t}\n\n\t\tif (config.template)\n\t\t{\n\t\t\tinitConfig.template = config.template;\n\t\t}\n\n\t\tif (config.name)\n\t\t{\n\t\t\tinitConfig.name = config.name;\n\t\t}\n\n\t\tif (config.components)\n\t\t{\n\t\t\tinitConfig.components = config.components;\n\t\t}\n\n\t\treturn new Promise((resolve) => {\n\t\t\tinitConfig.created = function() {\n\t\t\t\tresolve(this);\n\t\t\t};\n\t\t\tconst bitrixVue = BitrixVue.createApp(initConfig);\n\t\t\tbitrixVue.config.errorHandler = function(err, vm, info) {\n\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\tconsole.error(err, vm, info);\n\t\t\t};\n\n\t\t\tbitrixVue.config.warnHandler = function(warn, vm, trace) {\n\t\t\t\t// eslint-disable-next-line no-console\n\t\t\t\tconsole.warn(warn, vm, trace);\n\t\t\t};\n\n\t\t\t// todo: remove after updating Vue to 3.3+\n\t\t\tbitrixVue.config.unwrapInjectedRef = true;\n\n\t\t\t// eslint-disable-next-line no-param-reassign\n\t\t\tapplication.bitrixVue = bitrixVue;\n\t\t\tbitrixVue.use(this.store).mount(initConfig.el);\n\t\t});\n\t}\n\t/* endregion 04. Template engine */\n\n\t/* region 05. Core methods */\n\tgetHost(): string\n\t{\n\t\treturn this.host;\n\t}\n\n\tgetUserId(): number\n\t{\n\t\treturn this.userId;\n\t}\n\n\tgetSiteId(): string\n\t{\n\t\treturn this.siteId;\n\t}\n\n\tgetLanguageId(): string\n\t{\n\t\treturn this.languageId;\n\t}\n\n\tgetStore(): Store\n\t{\n\t\treturn this.store;\n\t}\n\n\tgetRestClient(): RestClient\n\t{\n\t\treturn this.restClient;\n\t}\n\n\tgetPullClient(): Pull\n\t{\n\t\treturn this.pullClient;\n\t}\n\n\tsetApplicationData(data: {string: any})\n\t{\n\t\tthis.applicationData = { ...this.applicationData, ...data };\n\t}\n\n\tgetApplicationData(): {[key]: any}\n\t{\n\t\treturn this.applicationData;\n\t}\n\n\tisOnline(): boolean\n\t{\n\t\treturn !this.offline;\n\t}\n\n\tisCloud(): boolean\n\t{\n\t\tconst settings = Extension.getSettings('im.v2.application.core');\n\n\t\treturn settings.get('isCloud');\n\t}\n\n\tready(): Promise\n\t{\n\t\tif (this.inited)\n\t\t{\n\t\t\treturn Promise.resolve(this);\n\t\t}\n\n\t\tCore.start();\n\n\t\treturn this.initPromise;\n\t}\n\n\t/* endregion 05. Methods */\n}\n\nconst Core = new CoreApplication();\nexport { Core, CoreApplication };\n"],"names":["CoreApplication","constructor","applicationData","inited","initPromise","Promise","resolve","initPromiseResolver","offline","vuexAdditionalModel","store","storeBuilder","prepareVariables","initRestClient","start","initStorage","then","initPull","initComplete","catch","error","Logger","localize","BX","message","host","location","origin","userId","Number","parseInt","Loc","getMessage","siteId","siteDir","languageId","restInstance","RestClient","restClient","rest","builder","Builder","init","addModel","ApplicationModel","create","MessagesModel","ChatsModel","FilesModel","UsersModel","RecentModel","CountersModel","NotificationsModel","SidebarModel","MarketModel","CopilotModel","OpenLinesLaunchResources","models","forEach","model","build","result","pullInstance","PullClient","pullClient","PULL","reject","Error","subscribe","BasePullHandler","RecentPullHandler","NotificationPullHandler","NotifierPullHandler","OnlinePullHandler","CounterPullHandler","pullHandlers","Handler","type","SubscriptionType","Status","callback","onPullStatusChange","bind","data","status","PullStatus","Online","Offline","createVue","application","config","initConfig","el","template","name","components","created","bitrixVue","BitrixVue","createApp","errorHandler","err","vm","info","console","warnHandler","warn","trace","unwrapInjectedRef","use","mount","getHost","getUserId","getSiteId","getLanguageId","getStore","getRestClient","getPullClient","setApplicationData","getApplicationData","isOnline","isCloud","settings","Extension","getSettings","get","ready","Core"],"mappings":"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"}