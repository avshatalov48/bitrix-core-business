this.BX=this.BX||{};(function(e,t,i,s,n,o,r,a,l,c,d){"use strict";let h=e=>e,u,p,f,g,y,D,m,E,C,M,v,I,S,O,T,w,b,L,_,B,A,N,P,k,U,V,F,R,x,W,$,z,X,Y,j;class H extends i.EventEmitter{constructor(e={}){super();this.STATE={READY:1,REQUEST:2,ERROR:3};this.zIndex=1200;this.Z_INDEX_OFFSET=-1e3;this.userSettings="";this.DOM={};this.displayed=false;this.sections=[];this.sectionIndex={};this.trackingUsersList=[];this.checkDataBeforeCloseMode=true;this.CHECK_CHANGES_DELAY=500;this.RELOAD_DATA_DELAY=500;this.excludedUsers=[];this.setEventNamespace("BX.Calendar.CompactEventForm");this.BX=s.Util.getBX();this.userId=parseInt(e.userId,10)||s.Util.getCurrentUserId();this.type=e.type||"user";this.isLocationCalendar=e.isLocationCalendar||false;this.calendarContext=e.calendarContext||null;this.ownerId=e.ownerId||this.userId;this.isCollabUser=s.Util.getCalendarContext().isCollabUser||false;this.checkForChangesDebounce=t.Runtime.debounce(this.checkForChanges,this.CHECK_CHANGES_DELAY,this);this.reloadEntryDataDebounce=t.Runtime.debounce(this.reloadEntryData,this.RELOAD_DATA_DELAY,this);this.checkOutsideClickClose=this.checkOutsideClickClose.bind(this);this.outsideMouseDownClose=this.outsideMouseDownClose.bind(this);this.keyHandler=this.handleKeyPress.bind(this);this.lastUsedSaveOptions={}}show(e=H.EDIT_MODE,i={}){this.setParams(i);this.setMode(e);this.state=this.STATE.READY;this.popupId=`compact-event-form-${Math.round(Math.random()*1e5)}`;if(this.popup){this.popup.destroy()}this.popup=this.getPopup(i);t.Dom.addClass(this.popup.titleBar,"calendar-add-popup-titlebar");t.Dom.removeClass(this.popup.popupContainer,"popup-window-with-titlebar");t.Dom.removeClass(this.popup.closeIcon,"popup-window-titlebar-close-icon");t.Event.bind(document,"mousedown",this.outsideMouseDownClose);t.Event.bind(document,"mouseup",this.checkOutsideClickClose);t.Event.bind(document,"keydown",this.keyHandler);t.Event.bind(this.popup.popupContainer,"transitionend",(()=>{t.Dom.removeClass(this.popup.popupContainer,"calendar-simple-view-popup-show")}));if(this.isEditMode()){r.EntryManager.doDelayedActions()}if(this.isViewMode()&&!this.isLocationMode()){this.sendOpenViewCardAnalytics()}this.prepareData().then((()=>{if(this.isLocationMode()){this.setFormValuesLocation()}else{this.setFormValues()}this.popup.show();if(this.hasToOpenPlannerInDefault()){this.userPlannerSelector.showPlanner()}if(this.isTitleOverflowing()){this.DOM.titleInput.title=this.entry.name}this.checkDataBeforeCloseMode=true;if(this.canDo("edit")&&this.DOM.titleInput&&e===H.EDIT_MODE){this.DOM.titleInput.focus();this.DOM.titleInput.select()}this.displayed=true;if(this.getMode()===H.VIEW_MODE){s.Util.sendAnalyticLabel({calendarAction:"view_event",formType:"compact"});this.popup.getButtons()[0].button.focus()}if(this.getMode()===H.EDIT_MODE&&!this.userPlannerSelector.isPlannerDisplayed()){this.userPlannerSelector.checkBusyTime()}}))}getPopup(e){return new n.Popup(this.popupId,e.bindNode,{zIndex:this.zIndex+this.Z_INDEX_OFFSET,closeByEsc:true,offsetTop:0,offsetLeft:0,closeIcon:true,titleBar:true,draggable:true,resizable:false,lightShadow:true,className:"calendar-simple-view-popup calendar-simple-view-popup-show",cacheable:false,content:this.isLocationMode()?this.getPopupContentLocation():this.getPopupContentCalendar(),buttons:this.getButtons(),events:{onPopupClose:this.close.bind(this)}})}isShown(){return this.displayed}close(e=true,i=false){if(!e&&!this.checkTopSlider()){if(this.popup){this.popup.destroyed=true;setTimeout((()=>{this.popup.destroyed=false}),0)}return}if(this.getMode()===H.EDIT_MODE&&this.formDataChanged()&&this.checkDataBeforeCloseMode&&!i){this.showConfirmClosePopup();if(this.popup){this.popup.destroyed=true;setTimeout((()=>{this.popup.destroyed=false}),0)}return}this.displayed=false;this.emit("onClose");t.Event.unbind(document,"mousedown",this.outsideMouseDownClose);t.Event.unbind(document,"mouseup",this.checkOutsideClickClose);t.Event.unbind(document,"keydown",this.keyHandler);if(this.userPlannerSelector){this.userPlannerSelector.destroy()}if(this.popup){this.popup.destroy()}if(o.Location){o.Location.setCurrentCapacity(0)}s.Util.clearPlannerWatches();s.Util.closeAllPopups()}getPopupContentCalendar(){this.DOM.wrap=t.Tag.render(u||(u=h`<div class="calendar-add-popup-wrap">
			${0}
			<div class="calendar-field-container calendar-field-container-choice">
				${0}
			</div>

			${0}

			${0}

			${0}

			<div class="calendar-field-container calendar-field-container-info">
				${0}

					${0}

				${0}
				${0}
			</div>
		</div>`),this.DOM.titleOuterWrap=t.Tag.render(p||(p=h`
			<div class="calendar-field-container calendar-field-container-string-select">
				<div class="calendar-field-block">
					${0}
					${0}
					${0}
					${0}
				</div>
			</div>`),this.getEntryCounter(),this.getTitleControl(),this.getTitleFade(),this.getColorControl()),this.getSectionControl("textselect"),this.getDateTimeControl(),this.getUserPlannerSelector(),this.getRelationControl(),this.getTypeInfoControl(),this.getLocationControl(),this.DOM.remindersOuterWrap=t.Tag.render(f||(f=h`
				<div class="calendar-field-block">
					<div class="calendar-field-title">${0}:</div>
					${0}
				</div>`),t.Loc.getMessage("EC_REMIND_LABEL"),this.createRemindersControl()),this.getRRuleInfoControl());return this.DOM.wrap}getPopupContentLocation(){this.DOM.wrap=t.Tag.render(g||(g=h`<div class="calendar-add-popup-wrap">
			${0}
			<div class="calendar-field-container calendar-field-container-choice">
				${0}
			</div>
			${0}
			
		</div>`),this.DOM.titleOuterWrap=t.Tag.render(y||(y=h`
			<div class="calendar-field-container calendar-field-container-string-select">
				<div class="calendar-field-block">
					${0}
					${0}
					${0}
				</div>
			</div>`),this.getTitleControlLocation(),this.getTitleFade(),this.getColorControlsLocationView()),this.getSectionControl("location"),this.getDateTimeControl());if(this.entry.id!==this.entry.parentId){this.DOM.wrap.appendChild(t.Tag.render(D||(D=h`
				${0}
			`),this.getHostControl()))}return this.DOM.wrap}getButtons(){let e=[];if(this.isLocationMode()){e=this.getLocationModeButtons()}else if(this.isInvitedMode()){e=this.getInvitedButtons()}else if(this.isEditMode()){e=this.getEditModeButtons()}else if(this.isViewMode()){e=this.getViewModeButtons()}if(e.length>3){const t=e.slice(0,2);const i=e.slice(2);e=[...t,this.getMoreButton(i)]}if(e.length>2){e[1].button.className="ui-btn ui-btn-light-border"}return e}getLocationModeButtons(){const e=[this.getOpenParentButton()];if(this.canDo("release")){e.push(this.getReleaseLocationButton())}return e}getInvitedButtons(){return[this.getAcceptButton(),this.getDeclineButton(),this.getOpenButton(),...this.getEditEventButtons()]}getEditModeButtons(){const e=[this.getSaveButton(),this.getCloseButton()];if(this.canDo("edit")){e.push(this.getFullFormButton())}return e}getViewModeButtons(){const e=[this.getOpenButton()];if(this.entry.isMeeting()&&this.entry.getMeetingHost()!==this.userId){if(this.entry.getCurrentStatus()==="N"){e.push(this.getAcceptButtonWithoutBorder())}else if(this.entry.getCurrentStatus()==="Y"){e.push(this.getDeclineButton())}}e.push(...this.getEditEventButtons());return e}getEditEventButtons(){var e,t,i;const s=[];if(!this.isNewEntry()&&((e=this.entry.permissions)!=null&&e.edit||this.canDo("edit")||this.canDo("editLocation")||this.canDo("editAttendees"))){s.push(this.getEditButton())}if(this.isCollabUser&&!this.isNewEntry()&&((t=this.entry.permissions)!=null&&t.view_full||this.canDo("viewFull"))){s.push(this.getDownloadIcsButton())}if(!this.isNewEntry()&&((i=this.entry.permissions)!=null&&i.edit||this.canDo("edit"))){s.push(this.getDeleteButton())}return s}getOpenButton(){const e=this.entry.isInvited()?"ui-btn-link":"ui-btn-primary";const i=new BX.UI.Button({className:`ui-btn ${e}`,text:t.Loc.getMessage("CALENDAR_EVENT_DO_OPEN"),events:{click:()=>{this.checkDataBeforeCloseMode=false;BX.Calendar.EntryManager.openViewSlider(this.entry.id,{entry:this.entry,calendarContext:this.calendarContext,type:this.type,ownerId:this.ownerId,userId:this.userId,from:this.entry.from,timezoneOffset:this.entry&&this.entry.data?this.entry.data.TZ_OFFSET_FROM:null});this.close()}}});i.button.setAttribute("data-role","openButton");return i}getEditButton(){return new BX.UI.Button({text:t.Loc.getMessage("CALENDAR_EVENT_DO_EDIT"),className:"ui-btn ui-btn-link",events:{click:this.editEntryInSlider.bind(this)}})}getSaveButton(){const e=this.isNewEntry()?"CALENDAR_EVENT_DO_ADD":"CALENDAR_EVENT_DO_SAVE";const i=new BX.UI.Button({name:"save",text:t.Loc.getMessage(e),className:"ui-btn ui-btn-primary",events:{click:()=>{this.checkDataBeforeCloseMode=false;this.save()}}});i.button.setAttribute("data-role","saveButton");return i}getDeleteButton(){return new BX.UI.Button({text:t.Loc.getMessage("CALENDAR_EVENT_DO_DELETE"),className:"ui-btn ui-btn-link",events:{click:()=>{i.EventEmitter.subscribeOnce("BX.Calendar.Entry:beforeDelete",(()=>{this.checkDataBeforeCloseMode=false;this.close()}));r.EntryManager.deleteEntry(this.entry);if(!this.entry.wasEverRecursive()){this.close()}}}})}getCloseButton(){const e=new BX.UI.Button({text:t.Loc.getMessage("CALENDAR_EVENT_DO_CANCEL"),className:"ui-btn ui-btn-link",events:{click:()=>{if(this.isNewEntry()){this.checkDataBeforeCloseMode=false;this.close()}else{this.setFormValues();if(this.userPlannerSelector){this.userPlannerSelector.destroy()}this.setMode(H.VIEW_MODE);this.popup.setButtons(this.getButtons())}}}});e.button.setAttribute("data-role","closeButton");return e}getFullFormButton(){const e=new BX.UI.Button({text:t.Loc.getMessage("CALENDAR_EVENT_FULL_FORM"),className:"ui-btn calendar-full-form-btn",events:{click:this.editEntryInSlider.bind(this)}});e.button.setAttribute("data-role","fullForm");return e}getDownloadIcsButton(){return new BX.UI.Button({text:t.Loc.getMessage("CALENDAR_EVENT_DO_DOWNLOAD_ICS"),className:"ui-btn ui-btn-link",events:{click:()=>r.EntryManager.downloadIcs(this.getCurrentEntry().id)}})}getAcceptButtonWithoutBorder(){return this.getAcceptButton(true)}getAcceptButton(e=false){const i=e?"ui-btn-link":"ui-btn-primary";const s=new BX.UI.Button({className:`ui-btn ${i}`,text:t.Loc.getMessage("EC_DESIDE_BUT_Y"),events:{click:()=>{if(!this.entry.isRecursive()){this.entry.setCurrentStatus("Y");this.setFormValues()}r.EntryManager.setMeetingStatus(this.entry,"Y").then(this.refreshMeetingStatus.bind(this))}}});s.button.setAttribute("data-role","accept");return s}getDeclineButton(){const e=new BX.UI.Button({className:"ui-btn ui-btn-link",text:t.Loc.getMessage("EC_DESIDE_BUT_N"),events:{click:()=>{r.EntryManager.setMeetingStatus(this.entry,"N").then((()=>{if(this.isShown()){this.close()}}))}}});e.button.setAttribute("data-role","decline");return e}getOpenParentButton(){const e=this.entry.isInvited()?"ui-btn-link":"ui-btn-primary";return new BX.UI.Button({className:`ui-btn ${e}`,text:t.Loc.getMessage("CALENDAR_EVENT_DO_OPEN_PARENT"),events:{click:()=>{this.checkDataBeforeCloseMode=false;BX.Calendar.EntryManager.openViewSlider(this.entry.parentId,{userId:this.userId,from:this.entry.from,timezoneOffset:this.entry&&this.entry.data?this.entry.data.TZ_OFFSET_FROM:null});this.close()}}})}getReleaseLocationButton(){return new BX.UI.Button({name:"release",text:t.Loc.getMessage("CALENDAR_EVENT_DO_RELEASE"),className:"ui-btn ui-btn-light-border",events:{click:()=>{this.checkDataBeforeCloseMode=false;this.releaseLocation()}}})}getMoreButton(e){let i;const s=new BX.UI.Button({text:t.Loc.getMessage("CALENDAR_EVENT_DO_MORE"),className:"ui-btn ui-btn-light-border ui-btn-dropdown",events:{click:()=>{i.show()}}});const o=e.map((e=>({text:e.button.innerText,onclick:()=>{e.button.click()}})));i=n.MenuManager.create({id:`calendar-compact-event-form-more${Date.now()}`,bindElement:s.button,items:o});return s}freezePopup(){if(this.popup){this.popup.buttons.forEach((e=>{var t;if((e==null?void 0:(t=e.options)==null?void 0:t.name)==="save"){e.setClocking(true)}else{e.setDisabled(true)}}))}}unfreezePopup(){if(this.popup){this.popup.buttons.forEach((e=>{e.setClocking(false);e.setDisabled(false)}))}}refreshMeetingStatus(){this.emit("doRefresh");this.popup.setButtons(this.getButtons());if(this.entry.isInvited()){t.Dom.removeClass(this.DOM.entryCounter,"calendar-event-invite-counter-none")}else{t.Dom.addClass(this.DOM.entryCounter,"calendar-event-invite-counter-none")}if(this.userPlannerSelector){const e=this.entry.isInvited();this.userPlannerSelector.setViewMode(e);this.userPlannerSelector.displayAttendees(this.entry.getAttendees());this.locationSelector.setViewMode(e);if(!e){if(this.isLocationCalendar){this.locationSelector.setValue(this.locationSelector.default)}else{this.DOM.locationOuterWrap.style.display="";this.locationSelector.setValue(this.entry.getLocation())}}}}hideLoader(){if(t.Type.isDomNode(this.DOM.loader)){t.Dom.remove(this.DOM.loader);this.DOM.loader=null}}showInEditMode(e={}){return this.show(H.EDIT_MODE,e)}showInViewMode(e={}){return this.show(H.VIEW_MODE,e)}isLocationMode(){return this.isViewMode()&&this.type==="location"}isInvitedMode(){return this.entry.isInvited()}isEditMode(){return this.getMode()===H.EDIT_MODE}isViewMode(){return this.getMode()===H.VIEW_MODE}setMode(e){if(e==="edit"||e==="view"){this.mode=e}}getMode(){return this.mode}checkForChanges(){if(!this.isNewEntry()&&this.getMode()===H.VIEW_MODE&&this.formDataChanged()){this.setMode(H.EDIT_MODE);this.popup.setButtons(this.getButtons())}else if(!this.isNewEntry()&&this.getMode()===H.EDIT_MODE&&!this.formDataChanged()){this.setMode(H.VIEW_MODE);this.popup.setButtons(this.getButtons())}this.emitOnChange()}updateEventNameInputTitle(){if(this.isTitleOverflowing()){this.DOM.titleInput.title=this.DOM.titleInput.value}else{this.DOM.titleInput.title=""}}isTitleOverflowing(){const e=this.DOM.titleInput;return e.clientWidth<e.scrollWidth||e.clientHeight<e.scrollHeight}hasToOpenPlannerInDefault(){return this.userPlannerSelector&&(this.isLocationCalendar||this.userPlannerSelector.attendeesEntityList.length>1&&this.getMode()!==H.VIEW_MODE)}checkLocationForm(e){if(!this.isCollabUser&&e&&e instanceof i.BaseEvent){const t=e.getData();const i=t.usersCount;let s=o.Location.getCurrentCapacity()||0;if(this.locationSelector.value.type===undefined&&s){s=0;o.Location.setCurrentCapacity(0)}if(s<i&&s!==0){this.locationSelector.addCapacityAlert()}else{this.locationSelector.removeCapacityAlert()}}}getFormDataChanges(e=[]){const t=this.entry;const i=[];if(!e.includes("name")&&t.name!==this.DOM.titleInput.value){i.push("name")}if(!e.includes("location")&&this.locationSelector.getTextLocation(o.Location.parseStringValue(t.getLocation()))!==this.locationSelector.getTextLocation(o.Location.parseStringValue(this.locationSelector.getTextValue()))){i.push("location")}const s=this.dateTimeControl.getValue();if(!e.includes("date&time")&&(t.isFullDay()!==s.fullDay||s.from.toString()!==t.from.toString()||s.to.toString()!==t.to.toString())){i.push("date&time")}if(!e.includes("notify")&&(!t.isMeeting()||t.getMeetingNotify())!==this.userPlannerSelector.getInformValue()){i.push("notify")}if(!e.includes("section")&&parseInt(t.sectionId)!==parseInt(this.sectionValue)){i.push("section")}if(!e.includes("codes")&&this.userPlannerSelector.getEntityList().map((e=>`${e.entityId}:${e.id}`)).join("|")!==t.getAttendeesEntityList().map((e=>`${e.entityId}:${e.id}`)).join("|")){i.push("codes")}return i}formDataChanged(){return this.getFormDataChanges().length>0}setParams(e={}){var i;this.userId=parseInt(e.userId,10)||s.Util.getCurrentUserId();this.type=e.type||"user";this.isLocationCalendar=e.isLocationCalendar||false;this.locationAccess=e.locationAccess||false;this.calendarContext=e.calendarContext||null;this.ownerId=(i=e.ownerId)!=null?i:0;if(this.type==="user"&&!this.ownerId){this.ownerId=this.userId}this.entry=r.EntryManager.getEntryInstance(e.entry,e.userIndex,{type:this.type,ownerId:this.ownerId});this.sectionValue=null;this.analyticsSubSection=this.getFormAnalyticsContext();if(!this.entry.id&&t.Type.isPlainObject(e.entryTime)&&t.Type.isDate(e.entryTime.from)&&t.Type.isDate(e.entryTime.to)){this.entry.setDateTimeValue(e.entryTime)}if(t.Type.isPlainObject(e.userSettings)){this.userSettings=e.userSettings}this.locationFeatureEnabled=Boolean(e.locationFeatureEnabled);this.locationList=t.Type.isArray(e.locationList)?e.locationList.filter((e=>e.PERM.view_full)):[];this.roomsManager=e.roomsManager||null;this.iblockMeetingRoomList=e.iblockMeetingRoomList||[];this.plannerFeatureEnabled=Boolean(e.plannerFeatureEnabled);this.setSections(e.sections,e.trackingUserList)}setSections(e,t=[]){this.sections=e;this.trackingUsersList=t||[];this.updateSectionIndex();if(this.entry.id){const e=this.getCurrentSection();this.getSectionsForEditEvent(this.sections,e)}}prepareData(e={}){return new Promise((e=>{const t=this.getCurrentSection();if(t&&t.canDo){e()}else{this.BX.ajax.runAction("calendar.api.calendarajax.getCompactFormData",{data:{entryId:this.entry.id,loadSectionId:this.entry.sectionId}}).then((t=>{if(t&&t.data&&t.data.section){this.sections.push(new window.BXEventCalendar.Section(s.Util.getCalendarContext(),t.data.section));this.setSections(this.sections);e()}}))}}))}getEntryCounter(){if(!this.DOM.entryCounter){this.DOM.entryCounter=t.Tag.render(m||(m=h`
				<span class="calendar-event-invite-counter calendar-event-invite-counter-big">1</span>
			`))}if(this.entry.isInvited()){t.Dom.removeClass(this.DOM.entryCounter,"calendar-event-invite-counter-none")}else{t.Dom.addClass(this.DOM.entryCounter,"calendar-event-invite-counter-none")}return this.DOM.entryCounter}getTitleControl(){this.DOM.titleInput=t.Tag.render(E||(E=h`
			<input class="calendar-field calendar-field-string --text-overflow-none"
				value=""
				placeholder="${0}"
				type="text"
			/>
		`),t.Loc.getMessage("EC_ENTRY_NAME"));this.bindFade();t.Event.bind(this.DOM.titleInput,"keyup",this.checkForChangesDebounce);t.Event.bind(this.DOM.titleInput,"change",this.checkForChangesDebounce);t.Event.bind(this.DOM.titleInput,"keyup",this.updateEventNameInputTitle.bind(this));t.Event.bind(this.DOM.titleInput,"change",this.updateEventNameInputTitle.bind(this));return this.DOM.titleInput}bindFade(){let e=false;t.Event.bind(this.DOM.titleInput,"focusout",(()=>{if(this.DOM.titleInput.scrollWidth>this.DOM.titleInput.offsetWidth){this.getTitleFade().classList.add("--show")}else{this.getTitleFade().classList.remove("--show")}e=false}));t.Event.bind(this.DOM.titleInput,"focus",(()=>{this.getTitleFade().classList.remove("--show");e=true}));t.Event.bind(this.DOM.titleInput,"scroll",(()=>{if(this.DOM.titleInput.scrollWidth>this.DOM.titleInput.offsetWidth&&Math.ceil(this.DOM.titleInput.offsetWidth+this.DOM.titleInput.scrollLeft)<this.DOM.titleInput.scrollWidth&&!e){this.getTitleFade().classList.add("--show")}else{this.getTitleFade().classList.remove("--show")}}))}getTitleFade(){if(!this.DOM.titleFade){this.DOM.titleFade=t.Tag.render(C||(C=h`
				<div class="calendar-field-title-fade"></div>	
			`))}return this.DOM.titleFade}getTitleControlLocation(){this.DOM.titleInput=t.Tag.render(M||(M=h`
			<input class="calendar-field calendar-field-string --text-overflow-none"
				value=""
				placeholder="${0}"
				type="text"
				readonly
			/>
		`),t.Loc.getMessage("EC_ENTRY_NAME"));this.bindFade();return this.DOM.titleInput}getHostControl(){const e=this.entry.data.CREATED_BY;const i=H.USER_URL.replace("#USER_ID#",e);const s=this.BX.Calendar.EntryManager.userIndex[e]?this.BX.Calendar.EntryManager.userIndex[e].AVATAR:"";this.DOM.hostBar=t.Tag.render(v||(v=h`
			<div class="calendar-slider-detail-option-without-border">
				<div class="calendar-slider-detail-option-block">
					<div class="calendar-field-value">
						${0}
					</div>
					<span class="calendar-field-location-host-img">
						<a href="${0}">
							${0}
						</a>
					</span>
					<div class="calendar-slider-detail-option-value">
						<a href="${0}" class="calendar-slider-sidebar-user-info-name calendar-slider-sidebar-user-info-name-padding">${0}</a>
					</div>
				</div>
			</div>
		`),`${t.Loc.getMessage("EC_HOST")}: `,i,this.renderAvatar(s),i,BX.util.htmlspecialchars(this.entry.name));return this.DOM.hostBar}renderAvatar(e){const i="calendar-field-location-host-img-value";if(this.isAvatar(e)){return t.Tag.render(I||(I=h`
				<img class="${0}" src="${0}" alt="">
			`),i,e)}return t.Tag.render(S||(S=h`
			<div class="ui-icon ui-icon-common-user ${0}"><i></i></div>
		`),i)}isAvatar(e){return t.Type.isStringFilled(e)&&e!=="/bitrix/images/1.gif"}getColorControl(){this.DOM.colorSelect=t.Tag.render(O||(O=h`<div class="calendar-field calendar-field-select calendar-field-tiny"></div>`));this.colorSelector=new o.ColorSelector({wrap:this.DOM.colorSelect,mode:"selector"});this.colorSelector.subscribe("onChange",(e=>{if(e instanceof i.BaseEvent){const t=e.getData().value;if(!this.isNewEntry()&&(this.canDo("edit")||this.entry.getCurrentStatus()!==false)){this.BX.ajax.runAction("calendar.api.calendarajax.updateColor",{data:{entryId:this.entry.id,userId:this.userId,color:t}});this.entry.data.COLOR=t;this.emit("doRefresh");this.emitOnChange()}}}));return this.DOM.colorSelect}getColorControlsLocationView(){this.DOM.colorSelect=t.Tag.render(T||(T=h`<div class="calendar-field calendar-field-select calendar-colorpicker-readonly calendar-field-tiny"></div>`));this.colorSelector=new o.ColorSelector({wrap:this.DOM.colorSelect,mode:"view"});return this.DOM.colorSelect}getSectionControl(e){this.DOM.sectionSelectWrap=t.Tag.render(w||(w=h`<div class="calendar-field-choice-calendar"></div>`));this.sectionSelector=new o.SectionSelector({outerWrap:this.DOM.sectionSelectWrap,defaultCalendarType:this.type,defaultOwnerId:this.ownerId,sectionList:s.Util.filterSectionsByContext(this.sections,{isCollabUser:this.isCollabUser,calendarType:this.type,calendarOwnerId:this.ownerId}),sectionGroupList:a.SectionManager.getSectionGroupList({type:this.type,ownerId:this.ownerId,userId:this.userId,trackingUsersList:this.trackingUsersList,isCollabUser:this.isCollabUser,isCollabContext:this.getCurrentSection().isCollab()}),mode:e,zIndex:this.zIndex,getCurrentSection:()=>{const e=this.getCurrentSection();if(e){return{id:e.id,name:e.name,color:e.color}}return false},selectCallback:e=>{if(e){if(this.colorSelector){this.colorSelector.setValue(e.color)}this.sectionValue=e.id;this.checkForChangesDebounce();a.SectionManager.saveDefaultSectionId(this.sectionValue)}}});return this.DOM.sectionSelectWrap}getDateTimeControl(){this.DOM.dateTimeWrap=t.Tag.render(b||(b=h`<div class="calendar-field-container calendar-field-container-datetime"></div>`));this.dateTimeControl=new o.DateTimeControl(null,{showTimezone:false,outerWrap:this.DOM.dateTimeWrap,inlineEditMode:true});this.dateTimeControl.subscribe("onSetValue",(()=>{this.excludedUsers=[]}));this.dateTimeControl.subscribe("onChange",(e=>{if(e instanceof i.BaseEvent){const t=e.getData().value;if(this.remindersControl){this.remindersControl.setFullDayMode(t.fullDay);if(this.isNewEntry()&&!this.remindersControl.wasChangedByUser()){const e=r.EntryManager.getNewEntryReminders(t.fullDay?"fullDay":"withTime");this.remindersControl.setValue(e,false)}}if(this.userPlannerSelector){if(!this.userPlannerSelector.isPlannerDisplayed()){this.userPlannerSelector.showPlanner();this.userPlannerSelector.refreshPlannerStateDebounce()}this.userPlannerSelector.setLocationValue(this.locationSelector.getTextValue());this.userPlannerSelector.setDateTime(t,true)}if(this.locationSelector){this.locationSelector.checkLocationAccessibility({from:e.getData().value.from,to:e.getData().value.to,fullDay:e.getData().value.fullDay,currentEventId:this.entry.parentId})}this.checkForChangesDebounce()}}));return this.DOM.dateTimeWrap}getUserPlannerSelector(){this.DOM.userPlannerSelectorOuterWrap=t.Tag.render(L||(L=h`<div>
			<div class="calendar-field-container calendar-field-container-members">
				${0}
				<span class="calendar-videocall-wrap calendar-videocall-hidden"></span>
				${0}
			</div>
			<div class="calendar-user-selector-wrap"></div>
			<div class="calendar-add-popup-planner-wrap calendar-add-popup-show-planner">
				${0}
			</div>
			${0}
		<div>`),this.DOM.userSelectorWrap=t.Tag.render(_||(_=h`
				<div class="calendar-field-block">
					<div class="calendar-members-selected">
						<span class="calendar-attendees-label"></span>
						<span class="calendar-attendees-list"></span>
						<span class="calendar-members-more">${0}</span>
						<span class="calendar-members-change-link">${0}</span>
					</div>
				</div>`),t.Loc.getMessage("EC_ATTENDEES_MORE"),t.Loc.getMessage("EC_SEC_SLIDER_CHANGE")),this.DOM.informWrap=t.Tag.render(B||(B=h`
				<div class="calendar-field-container-inform">
					<span class="calendar-field-container-inform-text">${0}</span>
				</div>`),t.Loc.getMessage("EC_NOTIFY_OPTION")),this.DOM.plannerOuterWrap=t.Tag.render(A||(A=h`
				<div class="calendar-planner-wrapper" style="height: 0">
				</div>`)),this.DOM.hideGuestsWrap=t.Tag.render(N||(N=h`
			<div class="calendar-hide-members-container" style="display: none;">
				<div class="calendar-hide-members-container-inner">
					<div class="calendar-hide-members-icon-hidden"></div>
					<div class="calendar-hide-members-text">${0}</div>
					<span class="calendar-hide-members-helper" data-hint="${0}"></span>
				</div>
			</div>`),t.Loc.getMessage("EC_HIDE_GUEST_NAMES"),t.Loc.getMessage("EC_HIDE_GUEST_NAMES_HINT")));this.userPlannerSelector=new o.UserPlannerSelector({plannerReadOnly:!this.canDo("editUserPlannerSelector"),outerWrap:this.DOM.userPlannerSelectorOuterWrap,wrap:this.DOM.userSelectorWrap,informWrap:this.DOM.informWrap,plannerOuterWrap:this.DOM.plannerOuterWrap,hideGuestsWrap:this.DOM.hideGuestsWrap,readOnlyMode:false,userId:this.userId,type:this.type,ownerId:this.ownerId,zIndex:this.zIndex+10,plannerFeatureEnabled:this.plannerFeatureEnabled,isEditableSharingEvent:this.shouldShowFakeUserControl(),openEditFormCallback:()=>{this.editEntryInSlider("userSelector")}});this.userPlannerSelector.subscribe("onDateChange",this.handlePlannerSelectorChanges.bind(this));this.userPlannerSelector.subscribe("onNotifyChange",this.checkForChangesDebounce);this.userPlannerSelector.subscribe("onUserCodesChange",this.checkForChangesDebounce);return this.DOM.userPlannerSelectorOuterWrap}getRelationControl(){var e,i;this.DOM.relationWrap=null;if(((e=this.entry)==null?void 0:(i=e.data)==null?void 0:i.EVENT_TYPE)==="#shared_crm#"){this.DOM.relationWrap=t.Tag.render(P||(P=h`<div></div>`));this.relationControl=new d.RelationInterface({parentNode:this.DOM.relationWrap,eventId:this.entry.parentId});t.Dom.append(this.relationControl.render(),this.DOM.relationWrap)}return this.DOM.relationWrap}getLocationControl(){this.DOM.locationWrap=t.Tag.render(k||(k=h`<div class="calendar-field-place"></div>`));this.locationSelector=new o.Location({wrap:this.DOM.locationWrap,richLocationEnabled:this.locationFeatureEnabled,hideLocationLock:this.isCollabUser,locationList:this.locationList||[],roomsManager:this.roomsManager||null,locationAccess:this.locationAccess||false,iblockMeetingRoomList:this.iblockMeetingRoomList||[],inlineEditModeEnabled:!this.isLocationCalendar,onChangeCallback:()=>{if(this.userPlannerSelector){this.userPlannerSelector.setLocationValue(this.locationSelector.getTextValue());if(this.locationSelector.getValue().type!==undefined&&!this.userPlannerSelector.isPlannerDisplayed()){this.userPlannerSelector.showPlanner()}this.userPlannerSelector.refreshPlannerStateDebounce()}this.checkForChangesDebounce()}});const e=this.locationSelector.getTextLocation(o.Location.parseStringValue(this.entry.getLocation()));this.DOM.editLocationInFullForm=t.Tag.render(U||(U=h`
			<div class="calendar-field-place-link">
				<span class="calendar-notification-text">
					${0}
				</span>
			</div>
		`),e||t.Loc.getMessage("EC_REMIND1_ADD"));t.Event.bind(this.DOM.editLocationInFullForm,"click",(()=>this.editEntryInSlider("location")));t.Dom.style(this.DOM.editLocationInFullForm,"display",this.shouldShowFakeLocationControl()?"":"none");this.DOM.locationOuterWrap=t.Tag.render(V||(V=h`
			<div class="calendar-field-block">
				<div class="calendar-field-title calendar-field-title-align-top">${0}:</div>
				${0}
				${0}
			</div>
		`),t.Loc.getMessage("EC_LOCATION_LABEL"),this.DOM.locationWrap,this.DOM.editLocationInFullForm);if(this.userPlannerSelector){var i;this.userPlannerSelector.subscribe("onDisplayAttendees",this.checkLocationForm.bind(this));(i=this.userPlannerSelector.planner)==null?void 0:i.subscribe("onDisplayAttendees",this.checkLocationForm.bind(this))}return this.DOM.locationOuterWrap}createRemindersControl(){this.reminderValues=[];this.DOM.remindersWrap=t.Tag.render(F||(F=h`<div class="calendar-text"></div>`));this.remindersControl=new o.Reminder({wrap:this.DOM.remindersWrap,zIndex:this.zIndex});this.remindersControl.subscribe("onChange",(e=>{if(e instanceof i.BaseEvent){this.reminderValues=e.getData().values;if(!this.isNewEntry()&&(this.canDo("edit")||this.entry.getCurrentStatus()!==false)){this.BX.ajax.runAction("calendar.api.calendarajax.updateReminders",{data:{entryId:this.entry.id,userId:this.userId,reminders:this.reminderValues}}).then((e=>{this.entry.data.REMIND=e.data.REMIND}))}}}));return this.DOM.remindersWrap}getTypeInfoControl(){this.DOM.typeInfoTitle=t.Tag.render(R||(R=h`<div class="calendar-field-title"></div>`));this.DOM.typeInfoLink=t.Tag.render(x||(x=h`<div class="calendar-field-link"></div>`));this.DOM.typeInfoWrap=t.Tag.render(W||(W=h`
			<div class="calendar-field-block" style="display: none">
				${0}
				${0}
			</div>
		`),this.DOM.typeInfoTitle,this.DOM.typeInfoLink);return this.DOM.typeInfoWrap}getRRuleInfoControl(){this.DOM.rruleInfo=t.Tag.render($||($=h`<div class="calendar-text"></div>`));this.DOM.rruleInfoWrap=t.Tag.render(z||(z=h`
			<div class="calendar-field-block" style="display: none">
				<div class="calendar-field-title">${0}:</div>
				${0}
			</div>
		`),t.Loc.getMessage("EC_REPEAT"),this.DOM.rruleInfo);return this.DOM.rruleInfoWrap}getTimezoneInfoControl(){this.DOM.timezoneInfo=t.Tag.render(X||(X=h`<div class="calendar-text"></div>`));this.DOM.timezoneInfoWrap=t.Tag.render(Y||(Y=h`
			<div class="calendar-field-block" style="display: none">
				<div class="calendar-field-title">${0}:</div>
				${0}
			</div>
		`),t.Loc.getMessage("EC_TIMEZONE"),this.DOM.timezoneInfo);return this.DOM.timezoneInfoWrap}isNewEntry(){return!this.entry.id}canDo(e){const i=this.getCurrentSection();if(e==="edit"||e==="delete"){var s;if(this.entry.isMeeting()&&this.entry.id!==this.entry.parentId){return false}if(this.entry.isResourcebooking()){return false}if(!this.isNewEntry()&&this.isCollabUser&&!((s=this.entry)!=null&&s.permissions.edit)){return false}return i.canDo("edit")}if(e==="view"){if(this.entry.permissions&&t.Type.isBoolean(this.entry.permissions.view_time)){return this.entry.permissions.view_time===true}return i.canDo("view_time")}if(e==="viewFull"){if(this.entry.permissions&&t.Type.isBoolean(this.entry.permissions.view_full)){return this.entry.permissions.view_full===true}return i.canDo("view_full")}if(e==="release"){return i.canDo("access")}const n=["Q","N"].includes(this.entry.getCurrentStatus());if(e==="editLocation"){var o,r;const e=((o=this.entry.permissions)==null?void 0:o.edit)===true;const t=((r=this.entry.permissions)==null?void 0:r.edit_location)===true;return this.isNewEntry()||!n&&(e||t)}if(e==="editAttendees"){var a,l;const e=((a=this.entry.permissions)==null?void 0:a.edit)===true;const t=((l=this.entry.permissions)==null?void 0:l.edit_attendees)===true;return this.isNewEntry()||!n&&(e||t)}if(e==="editUserPlannerSelector"){var c;return this.isNewEntry()||((c=this.entry.permissions)==null?void 0:c.edit)===true}return true}setFormValues(){const e=this.entry;const i=this.getCurrentSection();const n=!this.canDo("edit");this.dateTimeControl.setValue({from:s.Util.adjustDateForTimezoneOffset(e.from,e.userTimezoneOffsetFrom,e.fullDay),to:s.Util.adjustDateForTimezoneOffset(e.to,e.userTimezoneOffsetTo,e.fullDay),fullDay:e.fullDay,timezoneFrom:e.getTimezoneFrom()||"",timezoneTo:e.getTimezoneTo()||"",timezoneName:this.userSettings.timezoneName});this.dateTimeControl.setInlineEditMode(this.isNewEntry()?"edit":"view");this.dateTimeControl.setViewMode(n);this.setEventNameInputValue(e.getName());if(n){t.Dom.attr(this.DOM.titleInput,"readonly","readonly")}this.colorSelector.setValue(e.getColor()||i.color,false);this.colorSelector.setViewMode(n&&this.entry.getCurrentStatus()===false);this.sectionValue=this.getCurrentSectionId();this.sectionSelector.updateValue();if((this.isSyncSection(i)||e.isSharingEvent())&&e.id){this.sectionSelector.setViewMode(true)}else{this.sectionSelector.setViewMode(n)}this.remindersControl.setValue(e.getReminders(),false);this.remindersControl.setViewMode(n&&this.entry.getCurrentStatus()===false);if(n&&this.entry.getCurrentStatus()===false){this.DOM.remindersOuterWrap.style.display="none"}if(e.isRecursive()){this.DOM.rruleInfoWrap.style="";t.Dom.adjust(this.DOM.rruleInfo,{text:e.getRRuleDescription()})}const o=!this.canDo("editLocation");let r=e.getLocation();t.Dom.style(this.DOM.editLocationInFullForm,"display","none");t.Dom.style(this.DOM.locationWrap,"display","");t.Dom.style(this.DOM.locationOuterWrap,"display","");if(this.shouldShowFakeLocationControl()){t.Dom.style(this.DOM.editLocationInFullForm,"display","");t.Dom.style(this.DOM.locationWrap,"display","none")}else if(o&&!r){t.Dom.style(this.DOM.locationOuterWrap,"display","none")}else{this.locationSelector.setViewMode(o);if(this.isLocationCalendar){this.locationSelector.setValue(this.locationSelector.default);r=this.locationSelector.default}else{this.DOM.locationOuterWrap.style.display="";this.locationSelector.setValue(e.getLocation())}}if(this.locationSelector){this.locationSelector.checkLocationAccessibility({from:this.dateTimeControl.getValue().from,to:this.dateTimeControl.getValue().to,fullDay:this.dateTimeControl.getValue().fullDay,currentEventId:this.entry.parentId})}if(this.userPlannerSelector&&(this.canDo("viewFull")||e.getCurrentStatus()!==false)){this.userPlannerSelector.setValue({attendeesEntityList:e.getAttendeesEntityList(),location:r,attendees:e.getAttendees(),notify:!e.isMeeting()||e.getMeetingNotify(),viewMode:this.getMode()===H.VIEW_MODE,entry:e,hideGuests:e.getHideGuests(),attendeesUndeselectedItems:this.getUndeselectedItems()});this.userPlannerSelector.setDateTime(this.dateTimeControl.getValue());const t=!this.canDo("editAttendees");if(t){this.userPlannerSelector.setViewMode(t)}if(this.shouldShowFakeUserControl()){this.userPlannerSelector.setEditableSharingEventMode()}}else{t.Dom.remove(this.DOM.userPlannerSelectorOuterWrap)}if(!this.canDo("edit")&&this.canDo("editAttendees")){this.userPlannerSelector.setCanEditAttendeesMode()}let a=true;this.DOM.infoContainer=this.DOM.wrap.querySelector(".calendar-field-container-info");for(let e=0;e<=this.DOM.infoContainer.childNodes.length;e++){if(t.Type.isElementNode(this.DOM.infoContainer.childNodes[e])&&this.DOM.infoContainer.childNodes[e].style.display!=="none"){a=false}}if(a){this.DOM.infoContainer.style.display="none"}}shouldShowFakeLocationControl(){if(this.entry.isSharingEvent()){var e,t;return this.canDo("editLocation")&&(((e=this.entry.permissions)==null?void 0:e.edit)||((t=this.entry.permissions)==null?void 0:t.edit_location)||this.canDo("edit"))}return this.canDo("editLocation")&&!this.canDo("edit")}shouldShowFakeUserControl(){if(this.entry.isSharingEvent()){var e,t;return this.canDo("editAttendees")&&(((e=this.entry.permissions)==null?void 0:e.edit)||((t=this.entry.permissions)==null?void 0:t.edit_attendees)||this.canDo("edit"))}return this.canDo("editAttendees")&&!this.canDo("edit")}setEventNameInputValue(e){this.DOM.titleInput.value=e}setFormValuesLocation(){const e=this.entry;const i=this.getCurrentSection();const n=true;this.dateTimeControl.setValue({from:s.Util.adjustDateForTimezoneOffset(e.from,e.userTimezoneOffsetFrom,e.fullDay),to:s.Util.adjustDateForTimezoneOffset(e.to,e.userTimezoneOffsetTo,e.fullDay),fullDay:e.fullDay,timezoneFrom:e.getTimezoneFrom()||"",timezoneTo:e.getTimezoneTo()||"",timezoneName:this.userSettings.timezoneName});this.dateTimeControl.setInlineEditMode(this.isNewEntry()?"edit":"view");this.dateTimeControl.setViewMode(n);let o="";if(this.entry.id===this.entry.parentId){o=t.Loc.getMessage("CALENDAR_UPDATE")}else{o=`${i.name}: ${BX.util.htmlspecialchars(e.getName())}`}this.setEventNameInputValue(o);this.colorSelector.setValue(e.getColor()||i.color,false);this.colorSelector.setViewMode(!n);this.sectionValue=this.getCurrentSectionId();this.sectionSelector.updateValue();this.sectionSelector.setViewMode(n)}save(e={}){if(this.state===this.STATE.REQUEST){return false}const n=this.getCurrentEntry();e=t.Type.isPlainObject(e)?e:{};if(!this.userSettings.sendFromEmail&&this.userPlannerSelector.hasExternalEmailUsers()&&!e.emailConfirmDialogShown){r.EntryManager.showConfirmedEmailDialog({callback:t=>{e.emailConfirmDialogShown=true;this.save(e)}});return false}if(!this.isNewEntry()&&n.isRecursive()&&!e.confirmed&&this.getFormDataChanges(["section","notify"]).length>0){r.EntryManager.showConfirmEditDialog({callback:t=>{e.recursionMode=n.isFirstInstance()&&t.recursionMode==="next"?"all":t.recursionMode;e.confirmed=true;this.lastUsedSaveOptions=e;this.save(e)}});return false}if(!this.isNewEntry()&&n.isMeeting()&&e.sendInvitesAgain===undefined&&this.getFormDataChanges().includes("date&time")&&n.getAttendees().find((e=>e.STATUS==="N"))){r.EntryManager.showReInviteUsersDialog({callback:t=>{e.sendInvitesAgain=t.sendInvitesAgain;this.lastUsedSaveOptions=e;this.save(e)}});return false}if(!this.isNewEntry()&&n.isRecursive()&&!e.confirmed&&this.getFormDataChanges().includes("section")){e.recursionMode=n.isFirstInstance()?"all":"next"}const a=this.dateTimeControl.getValue();const l={id:n.id,section:this.sectionValue,name:this.DOM.titleInput.value,desc:n.getDescription(),reminder:this.remindersControl.getSelectedValues(),date_from:a.fromDate,date_to:a.toDate,skip_time:a.fullDay?"Y":"N",time_from:s.Util.formatTime(s.Util.adjustDateForTimezoneOffset(a.from,-n.userTimezoneOffsetFrom,a.fullDay)),time_to:s.Util.formatTime(s.Util.adjustDateForTimezoneOffset(a.to,-n.userTimezoneOffsetTo,a.fullDay)),location:this.locationSelector.getTextValue(),tz_from:n.getTimezoneFrom(),tz_to:n.getTimezoneTo(),meeting_notify:this.userPlannerSelector.getInformValue()?"Y":"N",meeting_host:n.data.MEETING_HOST||"0",chat_id:n.data.MEETING?n.data.MEETING.CHAT_ID:0,exclude_users:(this.excludedUsers||[]).map((e=>e.ID)).join(","),attendeesEntityList:this.userPlannerSelector.getEntityList(),sendInvitesAgain:e.sendInvitesAgain?"Y":"N",hide_guests:this.userPlannerSelector.hideGuests?"Y":"N",requestUid:BX.Calendar.Util.registerRequestId(),private_event:n.isPrivate()?"Y":"N"};let c=!n.id||this.checkCurrentUsersAccessibility();if(!c&&this.getFormDataChanges().includes("codes")){const e=n.getAttendeesEntityList();const t=[];l.attendeesEntityList.forEach((i=>{if(!e.find((e=>i.entityId===e.entityId&&parseInt(i.id)===parseInt(e.id)))){if(i.entityId==="user"){t.push(i.id)}else{c=true}}}));l.newAttendeesList=t}l.checkCurrentUsersAccessibility=c?"Y":"N";l.doCheckOccupancy=e.doCheckOccupancy===false?"N":"Y";if(n.id&&n.isRecursive()){l.EVENT_RRULE=n.data.RRULE}if(e.recursionMode){l.rec_edit_mode=e.recursionMode;l.current_date_from=s.Util.formatDate(n.from)}if(this.getCurrentSection().color.toLowerCase()!==this.colorSelector.getValue().toLowerCase()){l.color=this.colorSelector.getValue()}if(this.analyticsSubSection){l.analyticsSubSection=this.analyticsSubSection}this.state=this.STATE.REQUEST;this.freezePopup();this.BX.ajax.runAction("calendar.api.calendarentryajax.editEntry",{data:l}).then((s=>{if(this.isLocationCalendar&&this.roomsManager){this.roomsManager.unsetHiddenRoom(o.Location.parseStringValue(l.location).room_id)}if(this.excludedUsers){this.excludedUsers=[]}const c=this.getCurrentSection();if(c&&!c.isShown()){c.show()}this.unfreezePopup();this.state=this.STATE.READY;if(s.data.entryId){if(n.id){r.EntryManager.showEditEntryNotification(s.data.entryId)}else{r.EntryManager.showNewEntryNotification(s.data.entryId)}}this.emit("onSave",new i.BaseEvent({data:{responseData:s.data,options:e}}));this.close();if(t.Type.isArray(s.data.eventList)&&s.data.eventList.length>0&&s.data.eventList[0].REMIND){r.EntryManager.setNewEntryReminders(a.fullDay?"fullDay":"withTime",s.data.eventList[0].REMIND)}}),(e=>{this.unfreezePopup();const i=[];e.errors.forEach((e=>{if(e.code!=="edit_entry_user_busy"&&e.code!=="edit_entry_location_repeat_busy"&&e.code!=="edit_entry_location_busy_recurrence"){i.push(e)}else if(e.code==="edit_entry_location_repeat_busy"){this.showLocationRepeatBusyErrorPopup(e.message)}}));e.errors=i;if(e.data&&t.Type.isPlainObject(e.data.busyUsersList)){this.handleBusyUsersError(e.data.busyUsersList)}if(e.errors&&e.errors.length>0){this.showError(e.errors)}this.state=this.STATE.ERROR}));return true}showLocationRepeatBusyErrorPopup(e){if(!this.DOM.locationRepeatBusyErrorPopup){this.DOM.locationRepeatBusyErrorPopup=r.EntryManager.getLocationRepeatBusyErrorPopup({message:e,onYesCallback:()=>{this.lastUsedSaveOptions.doCheckOccupancy=false;this.save(this.lastUsedSaveOptions);this.lastUsedSaveOptions={};this.DOM.locationRepeatBusyErrorPopup.close()},onCancelCallback:()=>{this.DOM.locationRepeatBusyErrorPopup.close()},onPopupCloseCallback:()=>{delete this.DOM.locationRepeatBusyErrorPopup}});this.DOM.locationRepeatBusyErrorPopup.show()}}handleBusyUsersError(e){const t=[];for(const i in e){if(e.hasOwnProperty(i)){t.push(e[i])}}this.busyUsersDialog=new o.BusyUsersDialog;this.busyUsersDialog.subscribe("onContinueEditing",(()=>{this.excludedUsers=[]}));this.busyUsersDialog.subscribe("onSaveWithout",(()=>{this.excludedUsers.push(...t);this.save()}));this.busyUsersDialog.show({users:t})}handleKeyPress(e){if(this.getMode()===H.EDIT_MODE&&e.keyCode===s.Util.getKeyCode("enter")&&(e.ctrlKey||e.metaKey)&&!e.altKey&&!this.isAdditionalPopupShown()){if(this.busyUsersDialog&&this.busyUsersDialog.isShown()){return}this.checkDataBeforeCloseMode=false;this.locationSelector.selectContol.onChangeCallback();this.save()}else if(this.checkTopSlider()&&e.keyCode===s.Util.getKeyCode("escape")&&e.type==="keyup"&&this.couldBeClosedByEsc()){this.close()}else if(e.keyCode===s.Util.getKeyCode("delete")&&!this.isNewEntry()&&this.canDo("delete")){const e=event.target||event.srcElement;const s=t.Type.isElementNode(e)?e.tagName.toLowerCase():null;if(s&&!["input","textarea"].includes(s)){i.EventEmitter.subscribeOnce("BX.Calendar.Entry:beforeDelete",(()=>{this.checkDataBeforeCloseMode=false;this.close()}));r.EntryManager.deleteEntry(this.entry)}}else if(e.keyCode===s.Util.getKeyCode("enter")&&this.DOM.confirmPopup){this.close(true,true)}}isAdditionalPopupShown(){return this.DOM.locationRepeatBusyErrorPopup}getCurrentEntry(){return this.entry}getCurrentSection(){let e=false;const t=this.getCurrentSectionId();if(t&&this.sectionIndex[t]!==undefined&&this.sections[this.sectionIndex[t]]!==undefined){e=this.sections[this.sectionIndex[t]]}return e}getCurrentSectionId(){let e=0;if(this.sectionValue){e=this.sectionValue}else{const t=this.getCurrentEntry();if(t instanceof r.Entry){e=parseInt(t.sectionId,10)}if(!e&&this.sections[0]){e=parseInt(this.sections[0].id,10)}}return e}handlePlannerSelectorChanges(e){if(e instanceof i.BaseEvent){const t=this.dateTimeControl.getValue();t.from=e.getData().dateFrom;t.to=e.getData().dateTo;this.dateTimeControl.setValue(t);this.userPlannerSelector.setDateTime(this.dateTimeControl.getValue());if(this.locationSelector){this.locationSelector.checkLocationAccessibility({from:e.getData().dateFrom,to:e.getData().dateTo,fullDay:e.getData().fullDay,currentEventId:this.entry.parentId})}this.checkForChangesDebounce()}}editEntryInSlider(e=false){this.checkDataBeforeCloseMode=false;const t=this.dateTimeControl.getValue();const i=s.Util.getCalendarContext();BX.Calendar.EntryManager.openEditSlider({calendarContext:i,entry:this.entry,type:this.type,isLocationCalendar:this.isLocationCalendar,locationAccess:this.locationAccess,roomsManager:this.roomsManager,locationCapacity:o.Location.getCurrentCapacity(),ownerId:this.ownerId,userId:this.userId,formDataValue:{section:this.sectionValue,name:this.DOM.titleInput.value,reminder:this.remindersControl.getSelectedRawValues(),color:this.colorSelector.getValue(),from:s.Util.adjustDateForTimezoneOffset(t.from,-this.entry.userTimezoneOffsetFrom,t.fullDay),to:s.Util.adjustDateForTimezoneOffset(t.to,-this.entry.userTimezoneOffsetTo,t.fullDay),fullDay:t.fullDay,location:this.locationSelector.getTextValue(),meetingNotify:this.userPlannerSelector.getInformValue()?"Y":"N",hideGuests:this.userPlannerSelector.hideGuests?"Y":"N",attendeesEntityList:this.userPlannerSelector.getEntityList()},jumpToControl:e});this.close()}outsideMouseDownClose(e){const t=e.target||e.srcElement;this.outsideMouseDown=!t.closest("div.popup-window")}checkTopSlider(){return!s.Util.getBX().SidePanel.Instance.getTopSlider()}checkOutsideClickClose(e){const t=e.target||e.srcElement;this.outsideMouseUp=!t.closest("div.popup-window");if(this.couldBeClosedByEsc()&&this.outsideMouseDown&&this.outsideMouseUp&&(this.getMode()===H.VIEW_MODE||!this.formDataChanged()||this.isNewEntry())){setTimeout((()=>{this.close(false)}),0)}}couldBeClosedByEsc(){return!n.PopupManager._popups.find((e=>e&&e.getId()!==this.popupId&&e.isShown()))}emitOnChange(){this.emit("onChange",new i.BaseEvent({data:{form:this,entry:this.entry}}))}showError(e){let i="";if(t.Type.isArray(e)){e.forEach((e=>{i+=`${e.message}\n`}))}if(i!==""){alert(i)}}reloadEntryData(){if(this.isShown()&&!this.isNewEntry()&&this.getMode()===H.VIEW_MODE){const e=s.Util.getCalendarContext();if(e){const t=r.EntryManager.getEntryInstance(e.getView().getEntryById(this.entry.getUniqueId()));if(t&&t.getUniqueId()){this.entry=t;if(this.isLocationMode()){this.setFormValuesLocation()}else{this.setFormValues()}}}}}checkCurrentUsersAccessibility(){return this.getFormDataChanges().includes("date&time")}handlePull(e){var i,s,n;if(this.userPlannerSelector&&(i=this.userPlannerSelector)!=null&&(s=i.planner)!=null&&s.isShown()){var o,r,a,l;const i=t.Type.isArray(e==null?void 0:(o=e.fields)==null?void 0:o.ATTENDEES)?e.fields.ATTENDEES:[];const s=(e==null?void 0:(r=e.fields)==null?void 0:r.CAL_TYPE)==="user"?parseInt(e==null?void 0:(a=e.fields)==null?void 0:a.OWNER_ID):parseInt(e==null?void 0:(l=e.fields)==null?void 0:l.CREATED_BY);if(!i.includes(s)){i.push(s)}this.userPlannerSelector.clearAccessibilityData(i);this.userPlannerSelector.refreshPlannerStateDebounce()}const c=this.getCurrentEntry();if(!this.isNewEntry()&&c&&c.parentId===parseInt(e==null?void 0:(n=e.fields)==null?void 0:n.PARENT_ID)){var d;if(e.command==="delete_event"&&c.getType()===(e==null?void 0:(d=e.fields)==null?void 0:d.CAL_TYPE)){this.close()}else{const e=()=>{this.reloadEntryDataDebounce();BX.Event.EventEmitter.unsubscribe("BX.Calendar:onEntryListReload",e)};BX.Event.EventEmitter.subscribe("BX.Calendar:onEntryListReload",e)}}}isSyncSection(e){return e.isGoogle()||e.isIcloud()||e.isOffice365()||e.isCalDav()||e.hasConnection()}getSectionsForEditEvent(e,t){const i=[];const s=t.type;i.push(t);e.forEach((e=>{if(!this.isSyncSection(e)&&e.type===s){i.push(e)}}));this.sections=i;this.updateSectionIndex()}releaseLocation(e={}){const t=this.getCurrentEntry();if(t.id&&t.isRecursive()&&!e.confirmed){r.EntryManager.showConfirmEditDialog({callback:t=>{e.confirmed=true;this.releaseLocation({recursionMode:t.recursionMode,confirmed:true})}});return false}if(!e.recursionMode){e.recursionMode=""}this.state=this.STATE.REQUEST;this.freezePopup();this.BX.ajax.runAction("calendar.api.locationajax.cancelBooking",{data:{parent_event_id:t.parentId,recursion_mode:e.recursionMode,section_id:t.sectionId,current_event_date_from:t.data.DATE_FROM,current_event_date_to:t.data.DATE_TO,owner_id:t.data.CREATED_BY}}).then((e=>{this.unfreezePopup();this.state=this.STATE.READY;r.EntryManager.showReleaseLocationNotification();this.calendarContext.reloadDebounce();this.close()}),(e=>{this.unfreezePopup();this.state=this.STATE.ERROR;this.close()}));return true}showConfirmClosePopup(){this.DOM.confirmPopup=new c.MessageBox({message:this.getConfirmContent(),minHeight:120,minWidth:350,maxWidth:350,buttons:BX.UI.Dialogs.MessageBoxButtons.OK_CANCEL,onOk:()=>{this.DOM.confirmPopup.close();this.close(true,true)},onCancel:()=>{this.DOM.confirmPopup.close()},okCaption:t.Loc.getMessage("EC_SEC_SLIDER_CLOSE"),popupOptions:{events:{onPopupClose:()=>{delete this.DOM.confirmPopup}},closeByEsc:true,padding:0,contentPadding:0,animation:"fading-slide"}});this.DOM.confirmPopup.show()}getConfirmContent(){return t.Tag.render(j||(j=h`
			<div class="calendar-list-slider-messagebox-text">${0}</div>
		`),`${t.Loc.getMessage("EC_LEAVE_EVENT_CONFIRM_QUESTION")}<br>${t.Loc.getMessage("EC_LEAVE_EVENT_CONFIRM_DESC")}`)}getUndeselectedItems(){if(this.canDo("edit")){return[]}return[["user",this.entry.data.MEETING_HOST||0],["user",this.entry.getOwnerId()]]}sendOpenViewCardAnalytics(){l.sendData({tool:"im",category:"events",event:"view_card",c_section:"card_compact",p5:`eventId_${this.entry.data.PARENT_ID}`})}updateSectionIndex(){this.sectionIndex={};if(t.Type.isArray(this.sections)){this.sections.forEach(((e,t)=>{const i=parseInt(e.ID||e.id,10);if(i>0){this.sectionIndex[i]=t}}))}}getFormAnalyticsContext(){if(this.type==="group"){return"calendar_collab"}return"calendar_personal"}}H.VIEW_MODE="view";H.EDIT_MODE="edit";H.USER_URL="/company/personal/user/#USER_ID#/";e.CompactEventForm=H})(this.BX.Calendar=this.BX.Calendar||{},BX,BX.Event,BX.Calendar,BX.Main,BX.Calendar.Controls,BX.Calendar,BX.Calendar,BX.UI.Analytics,BX.UI.Dialogs,BX.Calendar);
//# sourceMappingURL=compacteventform.bundle.map.js